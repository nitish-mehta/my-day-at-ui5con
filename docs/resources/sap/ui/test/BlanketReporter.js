/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/mvc/Controller","sap/ui/core/mvc/XMLView","sap/ui/model/Filter","sap/ui/model/FilterType","sap/ui/model/json/JSONModel"],function(t,e,n,i,r,s){"use strict";var a=/^((?:[a-z0-9]+\.)+_?[A-Z]\w+)(\.[a-z]\w+)?$/,o="\t\t.blanket-source {\t\t\toverflow-x: scroll;\t\t\tbackground-color: #FFFFFF;\t\t\tborder: 1px solid #CBCBCB;\t\t\tcolor: #363636;\t\t\tmargin: 25px 20px;\t\t\twidth: 80%;\t\t}\t\t.blanket-source div {\t\t\twhite-space: pre;\t\t\ttab-size: 4;\t\t\tfont-family: monospace;\t\t}\t\t.blanket-source > div > span:first-child {\t\t\tbackground-color: #EAEAEA;\t\t\tcolor: #949494;\t\t\tdisplay: inline-block;\t\t\tpadding: 0 10px;\t\t\ttext-align: center;\t\t\twidth: 30px;\t\t}\t\t.blanket-source .hits {\t\t\tbackground-color: #EAEAEA;\t\t\tcolor: green;\t\t\tdisplay: inline-block;\t\t\tpadding: 0 10px;\t\t\ttext-align: right;\t\t\twidth: 30px;\t\t}\t\t.blanket-source span.highlight {\t\t\tcolor: black;\t\t\tbackground-color: yellow\t\t}\t\t.blanket-source .hit {\t\t\tbackground-color: lightgreen\t\t}\t\t.blanket-source .miss {\t\t\tbackground-color: #e6c3c7\t\t}\t\t.blanket-source .skipped {\t\t\tfont-style: italic\t\t}\t\t.blanket-source .miss span.highlight {\t\t\tbackground-color: #e6c3c7\t\t}\t\t.coverageSummary {\t\t\tbackground-color: #0D3349;\t\t\tborder-radius: 0 0 5px 5px;\t\t\tcolor: #C6E746;\t\t\tfont-size: 1.5em;\t\t\tfont-family: Calibri, Helvetica, Arial, sans-serif;\t\t\tline-height: 1em;\t\t\tfont-weight: 400;\t\t\tpadding: 0.5em 0 0.5em 1em;\t\t}\t";e.extend("sap.ui.test.BlanketReporterUI",{filterThreshold:function(t){var e,n=null,s=this.byId("Files"),a=this.getView().getModel().getProperty("/threshold");if(t){n=new i({filters:[new i("lines/coverage","LT",a),new i("branches/coverage","LT",a)],and:false})}e=s.getBinding("rows");e.filter(n,r.Application)},onBeforeRendering:function(){this.filterThreshold(this.getView().getModel().getProperty("/filterThreshold"))},onFilterThreshold:function(t){this.filterThreshold(t.getParameter("selected"))},onRowSelection:function(){var t,e,n=this.byId("blanket-source"),i,r=this.getView().getModel(),s,a=this.byId("Files"),o=a.getSelectedIndex()-a.getFirstVisibleRow();if(o>=0){t=a.getRows()[o].getBindingContext();e=t.getObject("name");i=r.getProperty("/linesOfContext");s=r.getObject("/coverageData").files[e];n.setContent('<div class="blanket-source">'+d(s,i,r.getProperty("/showHits"))+"</div>");n.setVisible(true)}else{n.setContent("<div/>")}}});function l(e,n,i,r,s){var a=0,o=-Infinity,l=i.reduce(g,[]).sort(d),c=0;function d(t,e){return t.line-e.line||t.column-e.column}function u(){var t="";if(c>0){t="<div class='ellipsis'><span>...</span>";if(s){t+="<span class='hits'>&nbsp;</span>"}t+="<span class='skipped'>"+c+" lines skipped</span></div>";c=0}return t}function h(e,n){n=t.sap.encodeHTML(n);if(n&&a){o=e;n="<span class='highlight'>"+n+"</span>"}return n}function f(t,e){var n=0,i="";while(l.length&&t===l[0].line){i+=h(t,e.slice(n,l[0].column));n=l[0].column;a+=l.shift().delta}i+=h(t,e.slice(n));return i}function g(t,e){e.start.delta=+1;t.push(e.start);e.end.delta=-1;t.push(e.end);return t}if(r===undefined){r=Infinity}return e.reduce(function(t,e,i){var a=l.length&&l[0].line||Infinity,d=s?n.findIndex(function(t,e){return t!==undefined&&e>=i}):n.indexOf(0,i);function h(){t+="<div";if(n[i]===0){t+=" class='miss'";o=i}else if(s&&n[i]>0){t+=" class='hit'"}t+="><span>"+i+"</span>";if(s){t+="<span class='hits'>"+(n[i]>=0?n[i]+"x":"&nbsp;")+"</span>"}t+=f(i,e)+"</div>"}if(d>=0&&d<a){a=d}i+=1;if(i>=a-r||i<=o+r||a-o===2*(r+1)){t+=u();h()}else{c+=1}return t},"")+u()}function c(t,e,n){var i=parseInt(t.getAttribute(e),10);return i>0?i:n}function d(t,e,n){var i=t.branchTracking?t.branchTracking.reduce(r,[]):[];function r(t,e){if(!e.falsy){t.push(e.alternate)}if(!e.truthy){t.push(e.consequent)}return t}return l(t.source,t,i,n?Infinity:e,n)}function u(t,e){return e?(e-t)/e*100:100}function h(t){t.lines.coverage=u(t.lines.missed,t.lines.total);t.branches.coverage=u(t.branches.missed,t.branches.total)}function f(t,e,n,i){var r={},a={files:[],lines:{total:0,missed:0,coverage:100},branches:{total:0,missed:0,coverage:100},coverageData:t,filterThreshold:!!n,branchTracking:false,showHits:false};function o(e){var n=t.files[e],i={name:e,lines:{total:0,missed:0,coverage:100},branches:{total:0,missed:0,coverage:100}},s;if(e in r){return}r[e]=true;for(s=0;s<n.length;s++){if(n[s]!==undefined){i.lines.total++;if(n[s]===0){i.lines.missed++}}}if(n.branchTracking){a.branchTracking=true;i.branches.total=n.branchTracking.length;for(s=0;s<n.branchTracking.length;s++){if(!n.branchTracking[s].falsy||!n.branchTracking[s].truthy){i.branches.missed++}}}h(i);a.files.push(i);a.lines.total+=i.lines.total;a.lines.missed+=i.lines.missed;a.branches.total+=i.branches.total;a.branches.missed+=i.branches.missed}if(i&&i.every(function(e){return e in t.files})){a.filterThreshold=false}else{i=Object.keys(t.files)}i.sort().forEach(o);a.linesOfContext=e;a.threshold=n;a.visible=Math.min(Math.max(a.files.length,3),10);h(a);return new s(a)}function g(t){return sap.ui.xmlview({viewName:"sap.ui.test.BlanketReporterUI",models:t})}function p(e){var n=a.exec(e);return!n||n[2]===".integration"?undefined:t.sap.getResourceName(n[1])}function b(){var t=document.createElement("div"),e=document.createElement("style");t.setAttribute("id","blanket-view");t.setAttribute("class","sapUiBody");document.body.appendChild(t);e.innerHTML=o;document.head.appendChild(e);return t}return function(e,n,i){var r,s,o,l,d;function u(t){var e=a.exec(t);return e&&!e[2]}if(!document.getElementById("blanket-view")){s=c(e,"data-lines-of-context",3);d=Math.min(c(e,"data-threshold",0),100);l=n();o=f(i,s,d,l&&l.map(p));r=b();if(t.sap.getUriParameters().get("testId")||l&&!l.every(u)){g(o).placeAt(r);return}if(o.getProperty("/lines/coverage")<d){g(o).placeAt(r);throw new Error("Line coverage too low! "+o.getProperty("/lines/coverage")+" < "+d)}if(o.getProperty("/branches/coverage")<d){g(o).placeAt(r);throw new Error("Branch coverage too low! "+o.getProperty("/branches/coverage")+" < "+d)}r.setAttribute("class","coverageSummary");r.innerHTML="Blanket Code Coverage: OK"}}},false);