/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","./_OpaLogger"],function(t,e,i){"use strict";var s="http://localhost:8090";var n=i.getLogger("sap.ui.test._UsageReport");var o=e.extend("sap.ui.test._UsageReport",{constructor:function(e){this.enabled=e&&e.enableUsageReport==="true";this.baseUrl=(e&&e.usageReportUrl||s)+"/api/opa/suites/";if(this.enabled){n.info("Enabled OPA usage report")}var i=sap.ui.test._UsageReport.prototype;Object.keys(i).forEach(function(e){var s=["constructor","getMetadata"].indexOf(e)>-1;if(i.hasOwnProperty(e)&&t.isFunction(i[e])&&!s){var n=i[e];i[e]=function(){if(this.enabled){return n.apply(this,arguments)}}}})},begin:function(t){this._suiteBeginPromise=r(this.baseUrl+"begin",t).done(function(t){this._id=t.id;n.debug("Begin report with ID "+t.id)}.bind(this)).fail(function(t){n.debug("Failed to begin report. Error: "+t)})},moduleUpdate:function(t){this._postSuiteJson("/modules",t).done(function(e){n.debug("Sent report for module "+t.name)}).fail(function(e){n.debug("Failed to send report for module '"+t.name+"'. Error: "+e)})},testDone:function(t){if(this._isOpaEmpty){this._reportTest(t);this._isOpaEmpty=false}else{this._QUnitTimeoutTest=t}},opaEmpty:function(t){this._isOpaEmpty=true;if(this._QUnitTimeoutTest){var e=this._QUnitTimeoutTest.assertions;e[e.length-1].message+="\n"+t.errorMessage;this._reportTest(this._QUnitTimeoutTest);this._QUnitTimeoutTest=null}},done:function(t){this._postSuiteJson("/done",t).done(function(t){n.debug("Completed report with ID "+this._id)}.bind(this)).fail(function(t){n.debug("Failed to complete report with ID "+this._id+". Error: "+t)}.bind(this))},_reportTest:function(t){this._postSuiteJson("/tests",t).done(function(e){n.debug("Sent report for test "+t.name)}).fail(function(e){n.debug("Failed send report for test '"+t.name+"'. Error: "+e)})},_postSuiteJson:function(e,i){var s=this._suiteBeginPromise||t.Deferred().resolve().promise();return s.done(function(){return r.call(this,this.baseUrl+this._id+e,i)}.bind(this))}});function r(e,i){return t.ajax({url:e,type:"POST",data:i,dataType:"json"})}return o});