/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./Opa","./OpaPlugin","./PageObjectFactory","sap/ui/base/Object","./launchers/iFrameLauncher","./launchers/componentLauncher","sap/ui/core/routing/HashChanger","./matchers/Matcher","./matchers/AggregationFilled","./matchers/PropertyStrictEquals","./pipelines/ActionPipeline","./_ParameterValidator","./_OpaLogger","sap/ui/thirdparty/URI","sap/ui/base/EventProvider","sap/ui/qunit/QUnitUtils","./autowaiter/_autoWaiter"],function(e,t,n,r,o,a,i,s,u,c,p,f,h,l,d,g,v,w){"use strict";var m=l.getLogger("sap.ui.test.Opa5"),y=new n,x=new f,F="OpaFrame",_=new h({errorPrefix:"sap.ui.test.Opa5#waitFor"}),E=["visible","viewNamespace","viewName","autoWait"].concat(t._aConfigValuesForWaitFor),b=["check","error","success"].concat(t._aConfigValuesForWaitFor),C=[],O=new g;t._extractAppParams=function(){var e=[/^opa((?!(Frame)).*)$/,/hidepassed/,/noglobals/,/notrycatch/,/coverage/,/module/,/filter/];var n={};var r=(new d).search(true);Object.keys(r).forEach(function(o){var a=false;e.forEach(function(e){if(!a&&o.match(e)){m.debug("Skipping uri parameter: "+o+" as blacklisted with pattern: "+e);a=true}});if(!a){n[o]=t._parseParam(r[o])}});return n};var P=function(e,t){for(var n in t){if(e.hasOwnProperty(n)&&t.hasOwnProperty(n)){if(typeof e[n]=="object"&&typeof t[n]=="object"){P(e[n],t[n])}else{delete e[n]}}}return e};var W=t._extractAppParams();var A=o.extend("sap.ui.test.Opa5",e.extend({},t.prototype,{constructor:function(){t.apply(this,arguments)}}));function I(){var n=this;var r=arguments.length===1&&e.isPlainObject(arguments[0])?arguments[0]:{source:arguments[0],timeout:arguments[1],autoWait:arguments[2]};if(r.source&&typeof r.source!=="string"){r.source=r.source.toString()}var o=new d(r.source?r.source:"");o.search(e.extend(o.search(true),t.config.appParams));var i=M();i.success=function(){L(o.toString())};this.waitFor(i);var s=M();s.check=a.hasLaunched;s.timeout=r.timeout||80;s.errorMessage="unable to load the IFrame with the url: "+r.source;n.waitFor(s);var u=M();u.success=function(){n._loadExtensions(a.getWindow())};this.waitFor(u);var c=M();c.autoWait=r.autoWait||false;c.timeout=r.timeout||80;return this.waitFor(c)}A.prototype.iStartMyUIComponent=function n(r){var o=this;var a=false;r=r||{};var u=M();u.success=function(){var n=new d;n.search(e.extend(n.search(true),t.config.appParams));window.history.replaceState({},"",n.toString())};this.waitFor(u);var c=M();c.success=function(){var t=e.sap.getModulePath("sap.ui.test.OpaCss",".css");e.sap.includeStyleSheet(t);s.getInstance().setHash(r.hash||"");i.start(r.componentConfig).then(function(){a=true})};this.waitFor(c);var p=M();p.errorMessage="Unable to load the component with the name: "+r.name;p.check=function(){return a};if(r.timeout){p.timeout=r.timeout}o.waitFor(p);var f=M();f.success=function(){o._loadExtensions(window)};this.waitFor(f);var h=M();h.autoWait=r.autoWait||false;h.timeout=r.timeout||80;return this.waitFor(h)};A.prototype.iTeardownMyUIComponent=function n(){var r=M();r.success=function(){i.teardown()};var o=M();o.success=function(){var e=new d;e.search(P(e.search(true),t.config.appParams));window.history.replaceState({},"",e.toString())};return e.when(this.waitFor(r),this.waitFor(o))};A.prototype.iTeardownMyApp=function(){var t=this;var n=M();n.success=function(){t._unloadExtensions(A.getWindow())};var r=M();r.success=function(){if(a.hasLaunched()){this.iTeardownMyAppFrame()}else if(i.hasLaunched()){this.iTeardownMyUIComponent()}else{var e="A teardown was called but there was nothing to tear down use iStartMyComponent or iStartMyAppInAFrame";m.error(e,"Opa");throw new Error(e)}}.bind(this);return e.when(this.waitFor(n),this.waitFor(r))};A.iStartMyAppInAFrame=I;A.prototype.iStartMyAppInAFrame=I;function S(){var e=M();e.success=function(){a.teardown()};return this.waitFor(e)}A.iTeardownMyAppFrame=S;A.prototype.iTeardownMyAppFrame=S;A.prototype.hasAppStartedInAFrame=function(){return a.hasLaunched()};A.prototype.hasUIComponentStarted=function(){return i.hasLaunched()};A.prototype.hasAppStarted=function(){return a.hasLaunched()||i.hasLaunched()};A.prototype.waitFor=function(r){var o=r.actions,i=t._createFilteredConfig(E),s;r=e.extend({},i,r);r.actions=o;_.validate({validationInfo:A._validationInfo,inputToValidate:r});var u=r.check,c=null,p=r.success,f,h;s=t._createFilteredOptions(b,r);s.check=function(){var t=!!r.actions||r.autoWait;var o=A._getAutoWaiter();o.extendConfig(r.autoWait);if(t&&o.hasToWait()){return false}var i=A.getPlugin();var s=e.extend({},r,{interactable:t});f=i._getFilteredControls(s,c);if(a.hasLaunched()&&e.isArray(f)){var p=[];f.forEach(function(e){p.push(e)});f=p}if(f===n.FILTER_FOUND_NO_CONTROLS){m.debug("Matchers found no controls so check function will be skipped");return false}if(u){return this._executeCheck(u,f)}return true};s.success=function(){var n=t._getWaitForCounter();if(o&&(f||!h)){x.process({actions:o,control:f})}if(!p){return}var a=[];if(f){a.push(f)}if(n.get()===0){m.timestamp("opa.waitFor.success");m.debug("Execute success handler");p.apply(this,a);return}var i=M();if(e.isPlainObject(r.autoWait)){i.autoWait=e.extend({},r.autoWait)}else{i.autoWait=r.autoWait}i.success=function(){p.apply(this,a)};this.waitFor(i)};return t.prototype.waitFor.call(this,s)};A.getPlugin=function(){return a.getPlugin()||y};A.getJQuery=function(){return a.getJQuery()||e};A.getWindow=function(){return a.getWindow()||window};A.getUtils=function(){return a.getUtils()||v};A.getHashChanger=function(){return a.getHashChanger()||s.getInstance()};A._getAutoWaiter=function(){return a._getAutoWaiter()||w};A.extendConfig=function(e){t.extendConfig(e);t.extendConfig({appParams:W});A._getAutoWaiter().extendConfig(e.autoWait)};A.resetConfig=function(){t.resetConfig();t.extendConfig({viewNamespace:"",arrangements:new A,actions:new A,assertions:new A,visible:true,autoWait:false,_stackDropCount:1});t.extendConfig({appParams:W})};A.getTestLibConfig=function(e){return t.config.testLibs&&t.config.testLibs[e]?t.config.testLibs[e]:{}};A.emptyQueue=t.emptyQueue;A.stopQueue=t.stopQueue;A.getContext=t.getContext;A.matchers={};A.matchers.Matcher=u;A.matchers.AggregationFilled=c;A.matchers.PropertyStrictEquals=p;A.createPageObjects=function(e){return r.create(e,A)};A.prototype._executeCheck=function(e,t){var n=[];t&&n.push(t);m.debug("Executing OPA check function on controls "+t);m.debug("Check function is:\n"+e);var r=e.apply(this,n);m.debug("Result of check function is: "+r||"not defined or null");return r};A.resetConfig();function L(n){var r=e.sap.getModulePath("sap.ui.test.OpaCss",".css");e.sap.includeStyleSheet(r);return a.launch({frameId:F,source:n,opaLogLevel:t.config.logLevel})}function M(){return{viewName:null,controlType:null,id:null,searchOpenDialogs:false,autoWait:false}}e(function(){if(e("#"+F).length){L()}e("body").addClass("sapUiBody");e("html").height("100%")});A._validationInfo=e.extend({_stack:"string",viewName:"string",viewNamespace:"string",visible:"bool",matchers:"any",actions:"any",id:"any",controlType:"any",searchOpenDialogs:"bool",autoWait:"any"},t._validationInfo);A._getEventProvider=function(){return O};A.prototype._loadExtensions=function(n){var r=this;var o=t.config.extensions?t.config.extensions:[];var a=e.when(e.map(o,function(t){var o;var a=e.Deferred();n.sap.ui.require([t],function(e){o=new e;o.name=t;r._executeExtensionOnAfterInit(o,n).done(function(){A._getEventProvider().fireEvent("onExtensionAfterInit",{extension:o,appWindow:n});r._addExtension(o);a.resolve()}).fail(function(e){m.error(new Error("Error during extension init: "+e),"Opa");a.resolve()})});return a.promise()}));return this._schedulePromiseOnFlow(a)};A.prototype._unloadExtensions=function(t){var n=this;var r=e.when(e.map(this._getExtensions(),function(r){var o=e.Deferred();A._getEventProvider().fireEvent("onExtensionBeforeExit",{extension:r});n._executeExtensionOnBeforeExit(r,t).done(function(){o.resolve()}).fail(function(e){m.error(new Error("Error during extension init: "+e),"Opa");o.resolve()});return o.promise()}));this._schedulePromiseOnFlow(r)};A.prototype._addExtension=function(e){C.push(e)};A.prototype._getExtensions=function(){return C};A.prototype._executeExtensionOnAfterInit=function(t,n){var r=e.Deferred();var o=t.onAfterInit;if(o){o.bind(n)().done(function(){r.resolve()}).fail(function(e){r.reject(new Error("Error while waiting for extension: "+t.name+" to init, details: "+e))})}else{r.resolve()}return r.promise()};A.prototype._executeExtensionOnBeforeExit=function(t,n){var r=e.Deferred();var o=t.onBeforeExit;if(o){o.bind(n)().done(function(){r.resolve()}).fail(function(e){r.reject(new Error("Error while waiting for extension: "+t.name+" to exit, details: "+e))})}else{r.resolve()}return r.promise()};return A});