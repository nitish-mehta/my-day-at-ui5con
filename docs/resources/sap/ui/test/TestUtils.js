/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Core","sap/ui/thirdparty/URI","jquery.sap.script","jquery.sap.sjax"],function(e,t,n){"use strict";var r=/\/\$batch($|\?)/,a="application/json;charset=UTF-8;IEEE754Compatible=true",i={},s="\r\nContent-Type: application/http\r\n"+"Content-Transfer-Encoding: binary\r\n\r\nHTTP/1.1 ",o=e.sap.getUriParameters().get("realOData"),u=/^(GET|DELETE|PATCH|POST) (\S+) HTTP\/1\.1$/,c={},l=o==="true"||o==="proxy",f=l||o==="direct",p,d="DataServiceVersion",h="OData-Version";if(f){document.title=document.title+" (real OData)"}function y(e,t,n){var r=QUnit.objectType(e),a=QUnit.objectType(t),i;if(r!==a){throw new Error(n+": actual type "+r+" does not match expected type "+a)}if(r==="array"){if(e.length<t.length){throw new Error(n+": array length: "+e.length+" < "+t.length)}}if(r==="array"||r==="object"){for(i in t){y(e[i],t[i],n==="/"?n+i:n+"/"+i)}}else if(e!==t){throw new Error(n+": actual value "+e+" does not match expected value "+t)}}function T(e,t,n,r){try{y(e,t,"/");QUnit.assert.pushResult({result:r,actual:e,expected:t,message:n})}catch(a){QUnit.assert.pushResult({result:!r,actual:e,expected:t,message:(n||"")+" failed because of "+a.message})}}p={deepContains:function(e,t,n){T(e,t,n,true)},notDeepContains:function(e,t,n){T(e,t,n,false)},useFakeServer:function(t,n,o){function c(t,n,r){var i=r.requestBody,o,c=[""];o=g(i);i.split(o).slice(1,-1).forEach(function(i){var o,f=r.requestHeaders,d,h,y;i=i.slice(i.indexOf("\r\n\r\n")+4);d=g(i);o=u.exec(d);if(!o){y=b(d)}else if(o[1]==="DELETE"){y="204\r\n"+"Content-Length: 0\r\n"+p(E(f))+"\r\n\r\n"}else if(o[1]==="POST"||o[1]==="PATCH"){y="200\r\nContent-Type: "+a+"\r\n"+p(E(f))+"\r\n"+x(i)}else{h=n[t+o[2]];if(h){try{y="200\r\nContent-Type: "+a+"\r\n"+p(E(f,h[1]))+"\r\n"+JSON.stringify(JSON.parse(h[2]))+"\r\n";e.sap.log.info(d,null,"sap.ui.test.TestUtils")}catch(e){y=l(d,500,"Invalid JSON")}}else{y=b(d)}}c.push(s+y)});c.push("--\r\n");O([200,{"Content-Type":"multipart/mixed;boundary="+o.slice(2)},c.join(o)],r)}function l(t,n,r){e.sap.log.error(t,r,"sap.ui.test.TestUtils");return n+"\r\nContent-Type: text/plain\r\n\r\n"+r+"\r\n"}function f(){var e,t,r,a,i={};for(a in o){r=o[a];e=r.headers||{};if(r.source){t=C(n+r.source);e["Content-Type"]=e["Content-Type"]||y(r.source)}else{t=r.message||""}i[a]=[r.code||200,e,t]}return i}function p(e){return e&&e.length?e.join(": ")+"\r\n":""}function y(e){if(/\.xml$/.test(e)){return"application/xml"}if(/\.json$/.test(e)){return a}return"application/x-octet-stream"}function T(e){O([200,{"Content-Type":a},e.requestBody],e)}function g(e){return e.slice(0,e.indexOf("\r\n"))}function v(e,t){var n;t=t.toLowerCase();for(n in e){if(n.toLowerCase()===t){return e[n]}}}function E(e,t){var n=v(t,h),r=v(t,d),a=[];if(!n&&!r){n=v(e,h);r=v(e,d)}if(n){a.push(h);a.push(n)}else if(r){a.push(d);a.push(r)}return a}function x(e){return e.slice(e.indexOf("\n\r\n")+3)}function m(e,t){var n=t.url;if(r.test(n)){c(n.slice(0,n.indexOf("/$batch")+1),e,t)}else{T(t)}}function b(e){return l(e,404,"No mock data found")}function C(t){var n=i[t],r;if(!n){r=e.sap.sjax({url:t,dataType:"text"});if(!r.success){throw new Error(t+": resource not found")}i[t]=n=r.data}return n}function O(t,n){var r=t[1],a=E({},r);if(a.length===0){a=E(n.requestHeaders);if(a.length>0){r=e.extend({},r);r[a[0]]=a[1]}}n.respond(t[0],r,t[2])}function D(){var n,r,a=f(),i;r=sinon.fakeServer.create();t.add(r);r.autoRespond=true;for(i in a){r.respondWith("GET",i,O.bind(null,a[i]))}r.respondWith("DELETE",/.*/,O.bind(null,[204,{},""]));r.respondWith("HEAD",/.*/,O.bind(null,[200,{},""]));r.respondWith("PATCH",/.*/,T);r.respondWith("POST",/.*/,m.bind(null,a));n=r.restore;r.restore=function(){sinon.FakeXMLHttpRequest.filters=[];n.apply(this,arguments)};sinon.xhr.supportsCORS=e.support.cors;sinon.FakeXMLHttpRequest.useFilters=true;sinon.FakeXMLHttpRequest.addFilter(function(e,t){return e!=="DELETE"&&e!=="HEAD"&&e!=="PATCH"&&e!=="POST"&&!(e==="GET"&&t in a)})}n=e.sap.getResourcePath(n).replace(/(^|\/)resources\/(~[-a-zA-Z0-9_.]*~\/)?/,"$1test-resources/")+"/";D()},withNormalizedMessages:function(e){var t=sinon.sandbox.create();try{var n=sap.ui.getCore(),r=n.getLibraryResourceBundle;t.stub(n,"getLibraryResourceBundle").returns({getText:function(e,t){var a=e,i=r.call(n).getText(e),s;for(s=0;s<10;s+=1){if(i.indexOf("{"+s+"}")>=0){a+=" "+(s>=t.length?"{"+s+"}":t[s])}}return a}});e.apply(this)}finally{t.verifyAndRestore()}},isRealOData:function(){return f},getRealOData:function(){return o?"&realOData="+o:""},getBaseUri:function(){var e;if(document.baseURI){return document.baseURI}e=document.getElementsByTagName("base");return e[0]&&e[0].href||location.href},proxy:function(t){var r;if(!l){return t}r=e.sap.getResourcePath("sap/ui").replace("resources/sap/ui","proxy");return new n(r+t,p.getBaseUri()).pathname().toString()},retrieveData:function(e){var t=c[e];delete c[e];return t},setData:function(e,t){c[e]=t},setupODataV4Server:function(e,t,n,r){var a={};if(f){return}if(!r){r="/"}else if(r.slice(-1)!=="/"){r+="/"}Object.keys(t).forEach(function(e){var n=e[0]==="/"?e:r+e;a[n]=t[e]});p.useFakeServer(e,n||"sap/ui/core/qunit/odata/v4/data",a)}};return p},true);