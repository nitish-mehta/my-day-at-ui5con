/*
 * ! UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","../json/JSONModel","../json/JSONPropertyBinding","../json/JSONListBinding","sap/ui/base/ManagedObject","sap/ui/base/ManagedObjectObserver","../Context","../ChangeReason"],function(e,t,r,i,n,o,s,a){"use strict";var g=i.extend("sap.ui.model.base.ManagedObjectModelAggregationBinding"),f=r.extend("sap.ui.model.base.ManagedObjectModelPropertyBinding"),p="@custom",u="--";var d=t.extend("sap.ui.model.base.ManagedObjectModel",{constructor:function(e,r){if(!r&&typeof r!="object"){r={}}r[p]={};this._oObject=e;this._mObservedCount={properties:{},aggregations:{}};this.mListBinding={};t.apply(this,[r]);this._oObserver=new o(this.observerChanges.bind(this))}});d.prototype.getAggregation=t.prototype.getProperty;d.prototype.setData=function(e,r){var i={};i[p]=e;t.prototype.setData.apply(this,[i,r])};d.prototype.getJSON=function(){return JSON.stringify(this.oData[p])};d.prototype.setProperty=function(e,r,i,o){var s=this.resolve(e,i),a,g,f;if(!s){return false}if(s.indexOf("/"+p)===0){return t.prototype.setProperty.apply(this,arguments)}a=s.lastIndexOf("/");g=s.substring(0,a||1);f=s.substr(a+1);var u=this._getObject(g);if(u){if(u instanceof n){var d=u.getMetadata().getProperty(f);if(d){var l=d._sMutator,h=d._sGetter;if(u[h]()!==r){u[l](r);this.checkUpdate(false,o);return true}}}else if(u[f]!==r){u[f]=r;this.checkUpdate(false,o);return true}}return false};d.prototype.addBinding=function(e){t.prototype.addBinding.apply(this,arguments);if(e instanceof g){var r=e.sPath.replace("/","");this.mListBinding[r]=e}e.checkUpdate(false)};d.prototype.removeBinding=function(e){t.prototype.removeBinding.apply(this,arguments);if(e instanceof g){var r=e.sPath.replace("/","");delete this.mListBinding[r]}this._observeBeforeEvaluating(e,false)};d.prototype.firePropertyChange=function(e){if(e.reason===a.Binding){e.resolvedPath=this.resolve(e.path,e.context)}t.prototype.firePropertyChange.call(this,e)};d.prototype.bindAggregation=function(e,r,i){return t.prototype.bindProperty.apply(this,arguments)};d.prototype.bindProperty=function(e,t,r){var i=new f(this,e,t,r);return i};d.prototype.bindList=function(e,t,r,i,n){var o=new g(this,e,t,r,i,n);o.enableExtendedChangeDetection();return o};d.prototype.getManagedObject=function(e,t){if(e instanceof s){t=e;e=t.getPath()}var r=this.getProperty(e,t);if(r instanceof n){return r}return null};d.prototype.getRootObject=function(){return this._oObject};d.prototype._observePropertyChange=function(e,t){if(!e||!t){return}var r=e.getId()+"/@"+t.name;if(!this._oObserver.isObserved(e,{properties:[t.name]})){this._oObserver.observe(e,{properties:[t.name]});this._mObservedCount.properties[r]=1}else{this._mObservedCount.properties[r]++}};d.prototype._unobservePropertyChange=function(e,t){if(!e||!t){return}var r=e.getId()+"/@"+t.name;this._mObservedCount.properties[r]--;if(this._mObservedCount.properties[r]==0){this._oObserver.unobserve(e,{properties:[t.name]});delete this._mObservedCount.properties[r]}};d.prototype._observeAggregationChange=function(e,t){if(!e||!t){return}var r=e.getId()+"/@"+t.name;if(!this._oObserver.isObserved(e,{aggregations:[t.name]})){this._oObserver.observe(e,{aggregations:[t.name]});this._mObservedCount.aggregations[r]=1}else{this._mObservedCount.aggregations[r]++}};d.prototype._unobserveAggregationChange=function(e,t){if(!e||!t){return}var r=e.getId()+"/@"+t.name;this._mObservedCount.aggregations[r]--;if(this._mObservedCount.aggregations[r]==0){this._oObserver.unobserve(e,{aggregations:[t.name]});delete this._mObservedCount.aggregations[r]}};d.prototype._createId=function(t){var r=this._oObject;if(typeof r.createId==="function"){return r.createId(t)}if(!t){return r.getId()+u+e.sap.uid()}if(t.indexOf(r.getId()+u)!=0){return r.getId()+u+t}return t};d.prototype._getSpecialNode=function(t,r,i,o){if(t instanceof n){if(r==="className"){if(t.getMetadata){return t.getMetadata().getName()}else{return typeof t}}else if(r==="id"){return t.getId()}else if(r==="metadataContexts"){return t._oProviderData}}else if(r==="binding"&&i&&o){return i.getBinding(o)}else if(r==="bound"&&i&&o){return i.isBound(o)}else if(r==="bindingInfo"&&i&&o){return i.getBindingInfo(o)}else if(e.isArray(t)){if(r==="length"){return t.length}else if(r.indexOf("id=")===0){var s=r.substring(3),a=null;for(var g=0;g<t.length;g++){if(t[g].getId()===this._createId(s)||t[g].getId()===s){a=t[g];break}}return a}}return null};d.prototype._getObject=function(r,i){var o=this._oObject,a="",g=this;this.aBindings.forEach(function(e){if(!e._bAttached){g._observeBeforeEvaluating(e,true)}});if(typeof r==="string"&&r.indexOf("/")!=0&&!i){return null}if(i instanceof n){o=i;a=r}else if(!i||i instanceof s){a=this.resolve(r,i);if(!a){return o}if(a.indexOf("/"+p)===0){return t.prototype._getObject.apply(this,[r,i])}}else{o=i;a=r}if(!o){return null}var f=a.split("/"),u=0;if(!f[0]){u++}var d=null,l=null,h;while(o!==null&&f[u]){h=f[u];if(h.indexOf("@")===0){o=this._getSpecialNode(o,h.substring(1),d,l)}else if(o instanceof n){var c=o.getMetadata();if(c.isInstanceOf("sap.ui.core.IDScope")&&h.indexOf("#")===0){o=o.byId(h.substring(1))}else{d=o;l=h;var v=c.getProperty(h);if(v){o=o[v._sGetter]()}else{var b=c.getAggregation(h)||c.getAllPrivateAggregations()[h];if(b){o=o[b._sGetter]?o[b._sGetter]():o.getAggregation(h)}else{if(o&&o[h]&&typeof o[h]==="function"){o=o[h]()}else{o=null}}}}}else if(e.isArray(o)||e.isPlainObject(o)){o=o[h]}else{if(o&&o[h]&&typeof o[h]==="function"){o=o[h]()}else{o=null}}u++}return o};d.prototype.destroy=function(){for(var e in this._mAggregationObjects){var r=this._mAggregationObjects[e];if(r.object.invalidate.fn){r.object.invalidate=r.object.invalidate.fn}}t.prototype.destroy.apply(this,arguments)};d.prototype._observeBeforeEvaluating=function(e,t){if(!e.isResolved()){return}var r=e.getPath();var i=e.getContext(),o=this._oObject,a;if(i instanceof n){o=i;a=r}else if(!i||i instanceof s){a=this.resolve(r,i);if(!a){return}if(a.indexOf("/"+p)===0){return}}else{return}var g=a.split("/");if(!g[0]){g.shift()}var f=g[0];if(o.getMetadata().isInstanceOf("sap.ui.core.IDScope")&&f.indexOf("#")===0){o=o.byId(f.substring(1));f=g[1]}if(o instanceof n){var u=o.getMetadata(),d=u.getProperty(f);if(d){if(t===true){this._observePropertyChange(o,d)}else if(t===false){this._unobservePropertyChange(o,d)}}else{var l=u.getAggregation(f)||u.getAllPrivateAggregations()[f];if(l){if(t===true){this._observeAggregationChange(o,l)}else if(t===false){this._unobserveAggregationChange(o,l)}}}e._bAttached=t}};d.prototype.observerChanges=function(e){if(e.type=="aggregation"){if(e.mutation=="insert"){this._oObserver.observe(e.child,{properties:true,aggegations:true})}else{this._oObserver.unobserve(e.child,{properties:true,aggegations:true})}if(this.mListBinding[e.name]){var t=this._oObject.getBinding(e.name);var r=this._oObject.getAggregation(e.name);if(t&&t.getLength()!=r.length){return}}}this.checkUpdate()};return d});