/*!
  * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./ChangeReason","./TreeBinding","sap/ui/model/SorterProcessor","sap/ui/model/FilterProcessor","sap/ui/model/FilterType"],function(t,e,i,s,o,r){"use strict";var n=i.extend("sap.ui.model.ClientTreeBinding",{constructor:function(t,e,s,o,n,h){i.apply(this,arguments);if(!this.oContext){this.oContext=""}this._mLengthsCache={};this.filterInfo={};this.filterInfo.aFilteredContexts=[];this.filterInfo.oParentContext={};if(o){this.oModel.checkFilterOperation(o);if(this.oModel._getObject(this.sPath,this.oContext)){this.filter(o,r.Application)}}}});n.prototype.getRootContexts=function(e,i){if(!e){e=0}if(!i){i=this.oModel.iSizeLimit}var s=this.oModel.resolve(this.sPath,this.oContext),o=this,r,n,h;if(!s){return[]}if(!this.oModel.isList(s)){n=this.oModel.getContext(s);if(this.bDisplayRootNode){r=[n]}else{r=this.getNodeContexts(n,e,i)}}else{r=[];h=this._sanitizePath(s);t.each(this.oModel._getObject(h),function(t,e){o._saveSubContext(e,r,h,t)});this._applySorter(r);this._setLengthCache(h,r.length);r=r.slice(e,e+i)}return r};n.prototype.getNodeContexts=function(t,e,i){if(!e){e=0}if(!i){i=this.oModel.iSizeLimit}var s=this._sanitizePath(t.getPath());var o=[],r=this,n=this.oModel._getObject(s),h=this.mParameters&&this.mParameters.arrayNames,a;if(n){if(Array.isArray(n)){n.forEach(function(t,e){r._saveSubContext(t,o,s,e)})}else{a=h||Object.keys(n);a.forEach(function(t){var e=n[t];if(e){if(Array.isArray(e)){e.forEach(function(e,i){r._saveSubContext(e,o,s,t+"/"+i)})}else if(typeof e=="object"){r._saveSubContext(e,o,s,t)}}})}}this._applySorter(o);this._setLengthCache(s,o.length);return o.slice(e,e+i)};n.prototype.hasChildren=function(t){if(t==undefined){return false}return this.getChildCount(t)>0};n.prototype.getChildCount=function(t){var e=t?t.sPath:this.getPath();if(this.oContext){e=this.oModel.resolve(e,this.oContext)}e=this._sanitizePath(e);if(this._mLengthsCache[e]===undefined){if(t){this.getNodeContexts(t)}else{this.getRootContexts()}}return this._mLengthsCache[e]};n.prototype._sanitizePath=function(e){if(!t.sap.endsWith(e,"/")){e=e+"/"}if(!t.sap.startsWith(e,"/")){e="/"+e}return e};n.prototype._saveSubContext=function(e,i,s,o){if(e&&typeof e=="object"){var r=this.oModel.getContext(s+o);if(this.aAllFilters&&!this.bIsFiltering){if(t.inArray(r,this.filterInfo.aFilteredContexts)!=-1){i.push(r)}}else{i.push(r)}}};n.prototype.filter=function(t,e){if(t&&!Array.isArray(t)){t=[t]}this.oModel.checkFilterOperation(t);if(e==r.Application){this.aApplicationFilters=t||[]}else if(e==r.Control){this.aFilters=t||[]}else{this.aFilters=t||[];this.aApplicationFilters=[]}t=this.aFilters.concat(this.aApplicationFilters);if(t.length==0){this.aAllFilters=null}else{this.aAllFilters=t;this.applyFilter()}this._mLengthsCache={};this._fireChange({reason:"filter"});this._fireFilter({filters:t});return this};n.prototype.applyFilter=function(){this.filterInfo.aFilteredContexts=[];this.filterInfo.oParentContext={};this._applyFilterRecursive()};n.prototype._applyFilterRecursive=function(e){var i=this,s=[];if(t.isEmptyObject(this.aAllFilters)){return}this.bIsFiltering=true;var r;if(e){r=this.getNodeContexts(e,0,Number.MAX_VALUE)}else{r=this.getRootContexts(0,Number.MAX_VALUE)}this.bIsFiltering=false;if(r.length>0){t.each(r,function(t,s){s._parentContext=e;i._applyFilterRecursive(s)});s=o.apply(r,this.aAllFilters,function(t,e){return i.oModel.getProperty(e,t)});if(s.length>0){t.merge(this.filterInfo.aFilteredContexts,s);this.filterInfo.aFilteredContexts.push(e);this.filterInfo.oParentContext=e}if(t.inArray(this.filterInfo.oParentContext,r)!=-1){this.filterInfo.aFilteredContexts.push(e);this.filterInfo.oParentContext=e}}};n.prototype.sort=function(t){t=t||[];this.aSorters=Array.isArray(t)?t:[t];this._fireChange({reason:e.Sort});return this};n.prototype._applySorter=function(t){var e=this;s.apply(t,this.aSorters,function(t,i){return e.oModel.getProperty(i,t)},function(t){return t.getPath()})};n.prototype._setLengthCache=function(t,e){this._mLengthsCache[t]=e};n.prototype.checkUpdate=function(t){this.applyFilter();this._mLengthsCache={};this._fireChange()};return n});