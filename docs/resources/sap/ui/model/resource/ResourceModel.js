/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/BindingMode","sap/ui/model/Model","./ResourcePropertyBinding"],function(e,n,t,i){"use strict";var o=t.extend("sap.ui.model.resource.ResourceModel",{constructor:function(i){t.apply(this,arguments);this.aCustomBundles=[];this.bReenhance=false;this.bAsync=!!(i&&i.async);this.sDefaultBindingMode=i.defaultBindingMode||n.OneWay;this.mSupportedBindingModes={OneWay:true,TwoWay:false,OneTime:!this.bAsync};if(this.bAsync&&this.sDefaultBindingMode==n.OneTime){e.sap.log.warning("Using binding mode OneTime for asynchronous ResourceModel is not supported!")}this.oData=i;if(i&&i.bundle){this._oResourceBundle=i.bundle}else if(i&&(i.bundleUrl||i.bundleName)){s(this)}else{throw new Error("At least bundle, bundleName or bundleUrl must be provided!")}if(i&&Array.isArray(i.enhanceWith)&&i.enhanceWith.length>0){if(this.bAsync){this._pEnhanced=i.enhanceWith.reduce(function(e,n){return e.then(this.enhance.bind(this,n))}.bind(this),Promise.resolve())}else{i.enhanceWith.forEach(this.enhance.bind(this))}}},metadata:{publicMethods:["getResourceBundle"]}});o.loadResourceBundle=function(n,t){var i=sap.ui.getCore().getConfiguration(),o,s,u,a;u=n.bundleLocale;if(!u){u=i.getLanguage()}a=i.getOriginInfo();s=r(n.bundleUrl,n.bundleName);o=e.sap.resources({url:s,locale:u,includeInfo:a,async:t});return o};o.prototype.enhance=function(n){var t=this,i,s=this.bAsync?new Promise(function(e){i=e}):null;function r(){if(e.sap.resources.isBundle(n)){t._oResourceBundle._enhance(n);t.checkUpdate(true);if(s){i(true)}}else{var r=o.loadResourceBundle(n,t.bAsync);if(r instanceof Promise){r.then(function(e){t._oResourceBundle._enhance(e);t.checkUpdate(true);i(true)},function(){i(true)})}else if(r){t._oResourceBundle._enhance(r);t.checkUpdate(true)}}}if(this._oPromise){Promise.resolve(this._oPromise).then(r)}else{r()}if(!this.bReenhance){this.aCustomBundles.push(n)}return s};o.prototype.bindProperty=function(e){var n=new i(this,e);return n};o.prototype.getProperty=function(e){return this._oResourceBundle?this._oResourceBundle.getText(e):null};o.prototype.getResourceBundle=function(){if(!this.bAsync){return this._oResourceBundle}else{var e=this._oPromise;if(e){return new Promise(function(n,t){function i(e){n(e)}e.then(i,i)})}else{return Promise.resolve(this._oResourceBundle)}}};o.prototype._handleLocalizationChange=function(){s(this)};o.prototype._reenhance=function(){this.bReenhance=true;this.aCustomBundles.forEach(function(e){this.enhance(e)}.bind(this));this.bReenhance=false};function s(e){var n=e.oData;if(n&&(n.bundleUrl||n.bundleName)){var t=o.loadResourceBundle(n,n.async);if(t instanceof Promise){var i={url:r(n.bundleUrl,n.bundleName),async:true};e.fireRequestSent(i);e._oPromise=t;e._oPromise.then(function(n){e._oResourceBundle=n;e._reenhance();delete e._oPromise;e.checkUpdate(true);e.fireRequestCompleted(i)})}else{e._oResourceBundle=t;e._reenhance();e.checkUpdate(true)}}}function r(n,t){var i=n;if(t){i=e.sap.getModulePath(t,".properties")}return i}return o});