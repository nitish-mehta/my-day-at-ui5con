/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/TreeBinding","./AnalyticalBinding","sap/ui/model/TreeAutoExpandMode","sap/ui/model/ChangeReason","sap/ui/model/odata/ODataTreeBindingAdapter","sap/ui/model/TreeBindingAdapter","sap/ui/model/TreeBindingUtils"],function(e,t,o,n,a,i,r,s){"use strict";var d=function(){if(!(this instanceof t)||this._bIsAdapted){return}i.apply(this);for(var e in d.prototype){if(d.prototype.hasOwnProperty(e)){this[e]=d.prototype[e]}}this.setAutoExpandMode(this.mParameters.autoExpandMode||n.Bundled)};d.prototype.getGrandTotalContext=function(){if(this._oRootNode){return this._oRootNode.context}};d.prototype.getGrandTotalNode=function(){if(this._oRootNode){return this._oRootNode}};d.prototype.getGrandTotalContextInfo=function(){return this._oRootNode};d.prototype.getLength=function(){if(!this._oRootNode){return 0}if(this._oRootNode&&this._oWatermark&&this._isRunningInAutoExpand(n.Bundled)){if(this._oWatermark.groupID===this._oRootNode.groupID){return this._oRootNode.magnitude+this._oRootNode.numberOfTotals}return this._oWatermark.absoluteNodeIndex+this._oRootNode.numberOfTotals+1}return this._oRootNode.magnitude+this._oRootNode.numberOfTotals};d.prototype.getContextByIndex=function(e){if(this._oRootNode&&e===this.getLength()-1&&this.providesGrandTotal()&&this.hasTotaledMeasures()){return this._oRootNode.context}var t=this.findNode(e);if(!t||!t.context){t={context:this.getContexts(e,1,0)[0]}}return t?t.context:undefined};d.prototype.getNodeByIndex=function(e){if(e===this.getLength()-1&&this.providesGrandTotal()&&this.hasTotaledMeasures()){return this._oRootNode}if(e>=this.getLength()){return undefined}return this.findNode(e)};d.prototype._isNodeSelectable=function(e){if(!e){return false}return e.isLeaf&&!e.isArtificial};d.prototype.getContexts=function(t,o,a,i){if(!o){o=this.oModel.iSizeLimit}if(!a){a=0}this._iPageSize=o;this._iThreshold=Math.max(this._iThreshold,a);this._aRowIndexMap=[];this._buildTree(t,o);var r=[];if(this._oRootNode){r=this._retrieveNodeSection(this._oRootNode,t,o)}this._updateRowIndexMap(r,t);var s=[];var d;for(var u=0;u<r.length;u++){var l=r[u];if(this._isRunningInAutoExpand(n.Bundled)&&this._oWatermark){if(l.groupID===this._oWatermark.groupID||this._oWatermark.groupID===this._oRootNode.groupID&&t+u+1==this.getLength()-1){this._autoExpandPaging()}}if(!l.context){d=d||{};var h=l.parent;d[h.groupID]=h;this._updateNodeSections(h.groupID,{startIndex:l.positionInParent,length:1})}s.push(l.context)}if(d){var p=this;e.each(d,function(e,t){t.magnitude=0;t.numberOfTotals=0;p._loadChildContexts(t,{absoluteNodeIndex:t.absoluteNodeIndex})});s=[];for(var f=0;f<r.length;f++){var l=r[f];s.push(l.context)}}if(i){return r}else{return s}};d.prototype._autoExpandPaging=function(){e.sap.assert(this._oWatermark,"No watermark was set!");e.sap.assert(this._isRunningInAutoExpand(n.Bundled),"Optimised AutoExpand Paging can only be used with TreeAutoExpandMode.Bundled!");var t=this.getNodeContexts(this._oWatermark.context,{startIndex:this._oWatermark.startIndex,length:this._iPageSize,threshold:this._iThreshold,level:this._oWatermark.level,numberOfExpandedLevels:this._oWatermark.autoExpand});return t};d.prototype._afterMatchHook=function(e,t,o,n,a,i){if(e.sumNode&&e!==this._oRootNode){if(t.length===o){return true}var r=n.call(this,e.sumNode,e.sumNode.positionInParent,i);if(r){t.push(e.sumNode)}}};d.prototype._afterMapHook=function(e,t){if(e.sumNode&&e!==this._oRootNode){t.call(this,e.sumNode)}};d.prototype._createSumNode=function(e){var t;if(this.bProvideGrandTotals&&!this.mParameters.sumOnTop&&this.hasTotaledMeasures()&&e.children.length>1){t=this._createNode({parent:e.parent,positionInParent:e.children.length,context:e.context,level:e.level});t.nodeState=this._createNodeState({groupID:t.groupID,sum:true,expanded:false})}return t};d.prototype._buildTree=function(t,o){this._oRootNode=undefined;this._oWatermark=undefined;var a=this.mParameters&&this.getNumberOfExpandedLevels();var i=this.getRootContexts({startIndex:0,length:this._iPageSize,threshold:this._iThreshold,numberOfExpandedLevels:this._autoExpandMode===n.Bundled?a:undefined});var r;if(i==null){e.sap.log.warning("AnalyticalTreeBindingAdapter: No Dimensions given. An artificial rootContext has be created. Please check your Table/Service definition for dimension columns!")}else{r=i[0]}if(!r){return}var s=this._getNodeState("/");if(!s){s=this._updateTreeState({groupID:"/",expanded:true,sum:true});this._updateNodeSections("/",{startIndex:0,length:o})}this._oRootNode=this._createNode({context:r,parent:null,level:0,nodeState:s,isLeaf:false,autoExpand:a,absoluteNodeIndex:-1});this._oRootNode.isArtificial=true;this._loadChildContexts(this._oRootNode,{absoluteNodeIndex:-1})};d.prototype._loadChildContexts=function(t,o){var a=t.nodeState;var i=this.getGroupSize(t.context,t.level);if(i>=0){if(!t.children[i-1]){t.children[i-1]=undefined}if(t.level===this.aAggregationLevel.length){a.leafCount=i}t.sumNode=this._createSumNode(t)}for(var r=0;r<a.sections.length;r++){var s=a.sections[r];if(s.startIndex>t.children.length){continue}var d;if(i===-1){d=s.length}else{d=Math.min(s.length,i-s.startIndex)}var u=false;if(t.autoExpand>=0&&this._isRunningInAutoExpand(n.Bundled)){u=true;d=Math.max(0,i)}var l=this.getNodeContexts(t.context,{startIndex:s.startIndex,length:d,threshold:u?0:this._iThreshold,level:t.level,supressRequest:u});for(var h=0;h<l.length;h++){var p=l[h];var f=h+s.startIndex;var g=t.children[f];var c={context:l[h],parent:t,level:t.level+1,positionInParent:f,autoExpand:Math.max(t.autoExpand-1,-1),absoluteNodeIndex:++o.absoluteNodeIndex};if(g){g.context=c.context;g.parent=c.parent;g.level=c.level;g.positionInParent=c.positionInParent;g.magnitude=0;g.numberOfTotals=0;g.totalNumberOfLeafs=0;g.autoExpand=c.autoExpand;g.absoluteNodeIndex=c.absoluteNodeIndex;var x;if(p){x=this._calculateGroupID(g)}g.groupID=x}else{g=this._createNode(c)}g.nodeState=this._getNodeState(g.groupID);if(!g.nodeState){g.nodeState=this._createNodeState({groupID:g.groupID,expanded:false})}g.nodeState.parentGroupID=t.groupID;g.isLeaf=!this.nodeHasChildren(g);t.children[f]=g;if(g.isLeaf){t.numberOfLeafs+=1}if(g.parent.nodeState.selectAllMode&&!this._mTreeState.deselected[g.groupID]&&g.isLeaf){this.setNodeSelection(g.nodeState,true)}if((g.autoExpand>=0||g.nodeState.expanded)&&this.isGrouped()){if(!this._mTreeState.collapsed[g.groupID]){if(g.autoExpand>=0&&g.parent.nodeState.selectAllMode&&!this._mTreeState.deselected[g.groupID]){if(g.nodeState.selectAllMode===undefined){g.nodeState.selectAllMode=true}}this._updateTreeState({groupID:g.nodeState.groupID,fallbackNodeState:g.nodeState,expanded:true});this._loadChildContexts(g,o)}t.magnitude+=g.magnitude;t.numberOfTotals+=g.numberOfTotals;t.numberOfLeafs+=g.numberOfLeafs}if(g&&g.isLeaf){t.totalNumberOfLeafs=i}else{t.totalNumberOfLeafs+=g.totalNumberOfLeafs}}}i=this._isRunningInAutoExpand(n.Bundled)?t.children.length:i;t.magnitude+=Math.max(i||0,0);if(!i&&!this._isRunningInAutoExpand(n.Bundled)){e.sap.log.warning("AnalyticalTreeBindingAdapter: iMaxGroupSize("+i+") is undefined for node '"+t.groupID+"'!")}if(t.sumNode||t===this._oRootNode&&this.providesGrandTotal()&&this.hasTotaledMeasures()){t.numberOfTotals+=1}if(this._isRunningInAutoExpand(n.Bundled)&&t.autoExpand!=-1){if(!this._oWatermark&&!t.isLeaf&&!this.mFinalLength[t.groupID]){this._oWatermark={groupID:t.groupID,context:t.context,absoluteNodeIndex:t.absoluteNodeIndex,startIndex:t.children.length,level:t.level,autoExpand:t.autoExpand}}}};d.prototype._calculateGroupID=function(t){var o;var n=this.aAggregationLevel.length;if(!this.isGrouped()&&t&&t.positionInParent){o="/"+t.positionInParent+"/"}else{if(t.level>n){o=this._getGroupIdFromContext(t.context,n);e.sap.assert(t.positionInParent!=undefined,"If the node level is greater than the number of grouped columns, the position of the node to its parent must be defined!");o+=t.positionInParent+"/"}else{o=this._getGroupIdFromContext(t.context,t.level)}}return o};d.prototype.collapse=function(t){var o,i;if(typeof t==="object"){o=t}else if(typeof t==="number"){i=this.findNode(t);e.sap.assert(i&&i.nodeState,"AnalyticalTreeBindingAdapter.collapse("+t+"): No node found!");if(!i){return}o=i.nodeState}this._updateTreeState({groupID:o.groupID,expanded:false});o.selectAllMode=false;var r=false;if(this.bCollapseRecursive||this._isRunningInAutoExpand(n.Bundled)){var s=o.groupID;if(this._isRunningInAutoExpand(n.Bundled)&&this._oWatermark&&e.sap.startsWith(this._oWatermark.groupID,s)){if(i&&i.parent){this._oWatermark={groupID:i.parent.groupID,context:i.parent.context,absoluteNodeIndex:i.parent.absoluteNodeIndex,startIndex:i.positionInParent+1,level:i.parent.level,autoExpand:i.parent.autoExpand}}this._autoExpandPaging();r=true}var d=this;e.each(this._mTreeState.expanded,function(t,o){if(e.sap.startsWith(t,s)){d._updateTreeState({groupID:t,expanded:false})}});var u=[];e.each(this._mTreeState.selected,function(t,o){if(e.sap.startsWith(t,s)){o.selectAllMode=false;d.setNodeSelection(o,false);u.push(t)}});if(u.length){var l={rowIndices:[]};var h=0;this._map(this._oRootNode,function(e){if(!e||!e.isArtificial){h++}if(e&&u.indexOf(e.groupID)!==-1){if(e.groupID===this._sLeadSelectionGroupID){l.oldIndex=h;l.leadIndex=-1}l.rowIndices.push(h)}});this._publishSelectionChanges(l)}}if(!r){this._fireChange({reason:a.Collapse})}};d.prototype.collapseToLevel=function(e){this.setNumberOfExpandedLevels(e,true);r.prototype.collapseToLevel.call(this,e)};d.prototype.nodeHasChildren=function(t){e.sap.assert(t,"AnalyticalTreeBindingAdapter.nodeHasChildren: No node given!");if(!t||!t.parent||t.nodeState.sum){return false}else if(t.isArtificial){return true}else{return o.prototype.hasChildren.call(this,t.context,{level:t.level})}};d.prototype.resetData=function(e,t){var n=o.prototype.resetData.call(this,e,t);this._aRowIndexMap=[];this._oRootNode=undefined;this._oWatermark=undefined;this._iPageSize=0;this._iThreshold=0;if(!t||t.reason!==a.Sort){this.clearSelection();this._createTreeState(true)}return n};d.prototype.hasTotaledMeasures=function(){var t=false;e.each(this.getMeasureDetails()||[],function(e,o){if(o.analyticalInfo.total){t=true;return false}});return t};d.prototype.isGrouped=function(){return this.aAggregationLevel.length>0};d.prototype._isRunningInAutoExpand=function(e){if(this.getNumberOfExpandedLevels()>0&&this._autoExpandMode===e){return true}else{return false}};d.prototype.setNumberOfExpandedLevels=function(t,o){t=t||0;if(t<0){e.sap.log.warning("AnalyticalTreeBindingAdapter: numberOfExpanded levels was set to 0. Negative values are prohibited.");t=0}if(!o){this.resetData()}this.mParameters.numberOfExpandedLevels=t};d.prototype.getNumberOfExpandedLevels=function(){return this.mParameters.numberOfExpandedLevels};d.prototype._getSelectableNodesCount=function(e){if(e){return e.totalNumberOfLeafs}else{return 0}};return d},true);