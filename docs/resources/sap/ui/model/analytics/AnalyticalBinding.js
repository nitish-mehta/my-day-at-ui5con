/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/TreeBinding","sap/ui/model/ChangeReason","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/Sorter","sap/ui/model/odata/CountMode","sap/ui/model/TreeAutoExpandMode","./odata4analytics","./BatchResponseCollector","./AnalyticalVersionInfo"],function(e,t,r,i,s,n,a,o,u,l,d,p){"use strict";var h="sap.ui.model.analytics.AnalyticalBinding";function f(t){var r=new l.QueryResultRequest(t.oAnalyticalQueryResult),i,s,n,a,o,u,d,p,f=t.mParameters.select.split(","),c=y(f,t.sPath);r.setAggregationLevel(t.aMaxAggregationLevel);r.setMeasures(t.aMeasureName);Object.keys(t.oDimensionDetailsSet).forEach(function(e){n=t.oDimensionDetailsSet[e];r.includeDimensionKeyTextAttributes(e,true,n.textPropertyName!==undefined,n.aAttributeName)});Object.keys(t.oMeasureDetailsSet).forEach(function(e){u=t.oMeasureDetailsSet[e];r.includeMeasureRawFormattedValueUnit(e,u.rawValuePropertyName!==undefined,u.formattedValuePropertyName!==undefined,u.unitPropertyName!==undefined)});s=r.getURIQueryOptionValue("$select");if(s){i=s.split(",");for(a=0,d=i.length;a<d;a++){p=i[a];o=f.indexOf(p);if(o<0){e.sap.log.warning("Ignored the 'select' binding parameter, because"+" it does not contain the property '"+p+"'",t.sPath,h);c=true}else{f.splice(o,1)}}}for(a=0,d=f.length;a<d;a++){p=f[a];n=t.oAnalyticalQueryResult.findDimensionByPropertyName(p);if(n&&t.oDimensionDetailsSet[n.getName()]===undefined){g(t.sPath,p,n);c=true}u=t.oAnalyticalQueryResult.findMeasureByPropertyName(p);if(u&&t.oMeasureDetailsSet[u.getName()]===undefined){g(t.sPath,p,u);c=true}}return c?[]:f}function g(t,r,i){var s=i instanceof sap.ui.model.analytics.odata4analytics.Dimension?"dimension":"measure";if(i.getName()===r){e.sap.log.warning("Ignored the 'select' binding parameter, because it contains"+" the "+s+" property '"+r+"' which is not contained in the analytical info (see updateAnalyticalInfo)",t,h)}else{e.sap.log.warning("Ignored the 'select' binding parameter, because the property '"+r+"' is associated with the "+s+" property '"+i.getName()+"' which is not contained in the analytical"+" info (see updateAnalyticalInfo)",t,h)}}function y(t,r){var i,s=false,n,a;for(n=0,a=t.length;n<a;n++){t[n]=t[n].trim()}for(n=t.length-1;n>=0;n--){i=t[n];if(t.indexOf(i)!==n){e.sap.log.warning("Ignored the 'select' binding parameter, because it"+" contains the property '"+i+"' multiple times",r,h);t.splice(n,1);s=true}}return s}var c=t.extend("sap.ui.model.analytics.AnalyticalBinding",{constructor:function(r,i,s,n,a,u){t.call(this,r,i,s,a,u);this.aAdditionalSelects=[];this.sEntitySetName=u&&u.entitySet?u.entitySet:undefined;this.bArtificalRootContext=false;this.aApplicationFilter=this._convertDeprecatedFilterObjects(a);this.aControlFilter=undefined;this.aSorter=n?n:[];this.aMaxAggregationLevel=[];this.aAggregationLevel=[];this.oPendingRequests={};this.oPendingRequestHandle=[];this.oGroupedRequests={};this.bUseBatchRequests=u&&u.useBatchRequests===true?true:false;this.bProvideTotalSize=u&&u.provideTotalResultSize===false?false:true;this.bProvideGrandTotals=u&&u.provideGrandTotals===false?false:true;this.bReloadSingleUnitMeasures=u&&u.reloadSingleUnitMeasures===false?false:true;this.bUseAcceleratedAutoExpand=u&&u.useAcceleratedAutoExpand===false?false:true;this.bNoPaging=u&&u.noPaging===true?true:false;this.iTotalSize=-1;this.mServiceKey={};this.mServiceLength={};this.mServiceFinalLength={};this.mKeyIndex={};this.mFinalLength=this.mServiceFinalLength;this.mLength={};this.mMultiUnitKey={};this.aMultiUnitLoadFactor={};this.bNeedsUpdate=false;this.bApplySortersToGroups=true;this.sLastAutoExpandMode=undefined;this.mEntityKey={};this.sCustomParams=this.oModel.createCustomParams({custom:this.mParameters.custom});this.oAnalyticalQueryResult=null;this.aAnalyticalInfo=[];this.mAnalyticalInfoByProperty={};this.aBatchRequestQueue=[];if(u&&u.countMode==o.None){e.sap.log.fatal("requested count mode is ignored; OData requests will include $inlinecout options")}else if(u&&(u.countMode==o.Request||u.countMode==o.Both)){e.sap.log.warning("default count mode is ignored; OData requests will include $inlinecout options")}else if(this.oModel.sDefaultCountMode==o.Request){e.sap.log.warning("default count mode is ignored; OData requests will include $inlinecout options")}this.iModelVersion=p.getVersion(this.oModel);if(this.iModelVersion===null){e.sap.log.error("The AnalyticalBinding does not support Models other than sap.ui.model.odata.ODataModel version 1 or 2.");return}this.aAllDimensionSortedByName=null;this.aInitialAnalyticalInfo=u==undefined?[]:u.analyticalInfo;this.bInitial=true}});function v(t,r){return function(){if(!t.__supportUID){t.__supportUID=e.sap.uid()}return{type:h,analyticalError:r,analyticalBindingId:t.__supportUID}}}c.prototype.setContext=function(e){var t;if(this.oContext!==e){this.oContext=e;if(!this.isRelative()){return}this.oDataState=null;this.bApplySortersToGroups=true;t=this.oModel.resolve(this.sPath,this.oContext);if(t){this.resetData();this._initialize();this._fireChange({reason:r.Context})}else{this.bInitial=true}}};c.prototype.initialize=function(){if(this.oModel.oMetadata&&this.oModel.oMetadata.isLoaded()&&this.isInitial()){var e=this.isRelative();if(!e||e&&this.oContext){this._initialize()}this._fireRefresh({reason:r.Refresh})}return this};c.prototype._initialize=function(){if(this.oModel.oMetadata&&this.oModel.oMetadata.isLoaded()){this.bInitial=false;this.oAnalyticalQueryResult=this.oModel.getAnalyticalExtensions().findQueryResultByName(this._getEntitySet());if(!this.oAnalyticalQueryResult){throw"Error in AnalyticalBinding - The QueryResult '"+this._getEntitySet()+"' could not be retrieved. Please check your service definition."}this.updateAnalyticalInfo(this.aInitialAnalyticalInfo);this.aAllDimensionSortedByName=this.oAnalyticalQueryResult.getAllDimensionNames().concat([]).sort();this._fireRefresh({reason:r.Refresh})}};c.prototype.getRootContexts=function(t){if(this.isInitial()){return[]}var r=t&&t.numberOfExpandedLevels?t.numberOfExpandedLevels+1:1;var i=null;var s=this._getRequestId(c._requestType.groupMembersQuery,{groupId:null});if(this.bArtificalRootContext&&!this._cleanupGroupingForCompletedRequest(s)){return i}i=this._getContextsForParentContext(null);if(i.length==1){return i}if(r<=1){if(r==1){this._considerRequestGrouping([s,this._getRequestId(c._requestType.groupMembersQuery,{groupId:"/"})]);this.getNodeContexts(this.getModel().getContext("/"),{startIndex:t.startIndex,length:t.length,threshold:t.threshold,level:0,numberOfExpandedLevels:0})}}else{var n=this._prepareGroupMembersAutoExpansionRequestIds("/",t.numberOfExpandedLevels);n.push(s);this._considerRequestGrouping(n);this.getNodeContexts(this.getModel().getContext("/"),{startIndex:t.startIndex,length:t.length,threshold:t.threshold,level:0,numberOfExpandedLevels:t.numberOfExpandedLevels})}if(i.length>1){e.sap.log.fatal("assertion failed: grand total represented by a single entry")}return i};c.prototype.getNodeContexts=function(e,t){if(this.isInitial()){return[]}var r,i,s,n,a,o;if(typeof t=="object"){r=t.startIndex;i=t.length;s=t.threshold;n=t.level;a=t.numberOfExpandedLevels;o=t.supressRequest}else{r=arguments[1];i=arguments[2];s=arguments[3];n=arguments[4];a=arguments[5];o=arguments[6]}var u=this._getContextsForParentContext(e,r,i,s,n,a,o);return u};c.prototype.ContextsAvailabilityStatus={ALL:2,SOME:1,NONE:0};c.prototype.hasAvailableNodeContexts=function(e,t){var r=this._getGroupIdFromContext(e,t);if(this._getKeys(r)!=undefined){if(this.mFinalLength[r]==true){return c.prototype.ContextsAvailabilityStatus.ALL}else{return c.prototype.ContextsAvailabilityStatus.SOME}}else{return c.prototype.ContextsAvailabilityStatus.NONE}};c.prototype.getGroupSize=function(e,t){if(e===undefined){return 0}var r=this._getGroupIdFromContext(e,t);return this.mFinalLength[r]?this.mLength[r]:-1};c.prototype.getTotalSize=function(){if(!this.bProvideTotalSize){e.sap.log.fatal("total size of result explicitly turned off, but getter invoked")}return+this.iTotalSize};c.prototype.hasChildren=function(t,r){if(t===undefined){return false}if(t==null){return true}var i=r.level;if(i==0){return true}if(this.aAggregationLevel.length<i){return false}return e.inArray(this.aAggregationLevel[i-1],this.aMaxAggregationLevel)<this.aMaxAggregationLevel.length-1};c.prototype.hasMeasures=function(){var e=false;for(var t in this.oMeasureDetailsSet){if(this.oMeasureDetailsSet.hasOwnProperty(t)){e=true;break}}return e};c.prototype.getDimensionDetails=function(){return this.oDimensionDetailsSet};c.prototype.getMeasureDetails=function(){return this.oMeasureDetailsSet};c.prototype.providesGrandTotal=function(){return this.bProvideGrandTotals};c.prototype.getProperty=function(e){if(this.isInitial()){return{}}return this.oAnalyticalQueryResult.getEntityType().findPropertyByName(e)};c.prototype.getFilterablePropertyNames=function(){if(this.isInitial()){return[]}return this.oAnalyticalQueryResult.getEntityType().getFilterablePropertyNames()};c.prototype.getSortablePropertyNames=function(){if(this.isInitial()){return[]}return this.oAnalyticalQueryResult.getEntityType().getSortablePropertyNames()};c.prototype.getPropertyLabel=function(e){if(this.isInitial()){return""}return this.oAnalyticalQueryResult.getEntityType().getLabelOfProperty(e)};c.prototype.getPropertyHeading=function(e){if(this.isInitial()){return""}return this.oAnalyticalQueryResult.getEntityType().getHeadingOfProperty(e)};c.prototype.getPropertyQuickInfo=function(e){if(this.isInitial()){return""}return this.oAnalyticalQueryResult.getEntityType().getQuickInfoOfProperty(e)};c.prototype.isMeasure=function(t){return e.inArray(t,this.aMeasureName)!==-1};c.prototype.filter=function(e,t){if(!e){e=[]}if(e instanceof i){e=[e]}e=this._convertDeprecatedFilterObjects(e);if(t==n.Application){this.aApplicationFilter=e}else{this.aControlFilter=e}this.iTotalSize=-1;this._abortAllPendingRequests();this.resetData();this.bApplySortersToGroups=true;this._fireRefresh({reason:r.Filter});return this};c.prototype.sort=function(e){if(e instanceof a){e=[e]}this.aSorter=e?e:[];this._abortAllPendingRequests();this.resetData(undefined,{reason:r.Sort});this._fireRefresh({reason:r.Sort});return this};c.prototype.getGroupName=function(e,t){if(e===undefined){return""}var r=this.aAggregationLevel[t-1],i=this.oAnalyticalQueryResult.findDimensionByPropertyName(r),s=this.mAnalyticalInfoByProperty[r]&&this.mAnalyticalInfoByProperty[r].formatter,n=e.getProperty(r),a,o,u;if(i&&this.oDimensionDetailsSet[r].textPropertyName){a=i.getTextProperty()}var l,d,p;if(a){l=i.getTextProperty().name;p=this.mAnalyticalInfoByProperty[l]&&this.mAnalyticalInfoByProperty[l].formatter;d=e.getProperty(l)}if(!a){o=s?s(n):n;u=(i.getLabelText?i.getLabelText()+": ":"")+o}else{o=s?s(n,d):n;u=(i.getLabelText?i.getLabelText()+": ":"")+o;var h=p?p(d,n):d;if(h){u+=" - "+h}}return u};c.prototype.updateAnalyticalInfo=function(t,i){var s,n,a,o=this;function u(e){var t=e.level,r=e.name;a=a||n.getAllHierarchyPropertyNames();a.forEach(function(i){var s=o.oAnalyticalQueryResult.findDimensionByPropertyName(i).getHierarchy(),a=null,u=s.getNodeIDProperty().name,d;if(u===r){a=l(s)}else{d=s.getNodeExternalKeyProperty();if(d&&d.name===r){a=l(s);a.nodeExternalKeyName=r}else{d=n.getTextPropertyOfProperty(u);if(d&&d.name===r){a=l(s);a.nodeTextName=r}}}if(a&&"level"in e){if(typeof t==="number"){if("level"in a&&a.level!==t){throw new Error("Multiple different level filter for hierarchy '"+u+"' defined")}a.level=t;a.grouped=!!e.grouped}else{throw new Error("The level of '"+u+"' has to be an integer value")}}})}function l(e){var t=e.getNodeIDProperty().name,r,i=o.mHierarchyDetailsByName[t];if(!i){r=e.getNodeLevelProperty();i={dimensionName:e.getNodeValueProperty().name,nodeIDName:t,nodeLevelName:r&&r.name};o.mHierarchyDetailsByName[t]=i}return i}if(!this.oModel.oMetadata||!this.oModel.oMetadata.isLoaded()||this.isInitial()){this.aInitialAnalyticalInfo=t;return}if(e.sap.equal(this._aLastChangedAnalyticalInfo,t)){if(i){setTimeout(function(){this._fireChange({reason:r.Change})}.bind(this),0)}return}n=this.oAnalyticalQueryResult.getEntityType();this._aLastChangedAnalyticalInfo=[];for(var d=0;d<t.length;d++){this._aLastChangedAnalyticalInfo[d]=e.extend({},t[d])}var p=this.oDimensionDetailsSet||{},g=this.oMeasureDetailsSet||{};this.mAnalyticalInfoByProperty={};this.aMaxAggregationLevel=[];this.aAggregationLevel=[];this.aMeasureName=[];if(this.iAnalyticalInfoVersionNumber==undefined){this.iAnalyticalInfoVersionNumber=1}else if(this.iAnalyticalInfoVersionNumber>999){this.iAnalyticalInfoVersionNumber=1}else{this.iAnalyticalInfoVersionNumber=this.iAnalyticalInfoVersionNumber+1}this.oMeasureDetailsSet={};this.oDimensionDetailsSet={};this.aAdditionalSelects=[];this.mHierarchyDetailsByName={};for(var y=0;y<t.length;y++){var c=this.oAnalyticalQueryResult.findDimensionByPropertyName(t[y].name);if(c&&(t[y].inResult==true||t[y].visible==true)){t[y].dimensionPropertyName=c.getName();s=this.oDimensionDetailsSet[c.getName()];if(!s){s={};s.name=c.getName();s.aAttributeName=[];s.grouped=false;this.oDimensionDetailsSet[c.getName()]=s;this.aMaxAggregationLevel.push(s.name);if(t[y].grouped==true){this.aAggregationLevel.push(s.name)}}if(t[y].grouped==true){if(e.inArray(c.getName(),this.getSortablePropertyNames())==-1){e.sap.log.fatal("property "+c.getName()+" must be sortable in order to be used as grouped dimension")}s.grouped=true}if(c.getName()==t[y].name){s.keyPropertyName=t[y].name}var v=c.getTextProperty();if(v&&v.name==t[y].name){s.textPropertyName=t[y].name}if(c.findAttributeByName(t[y].name)){s.aAttributeName.push(t[y].name)}s.analyticalInfo=t[y]}var m=this.oAnalyticalQueryResult.findMeasureByPropertyName(t[y].name);if(m&&(t[y].inResult==true||t[y].visible==true)){t[y].measurePropertyName=m.getName();var _=this.oMeasureDetailsSet[m.getName()];if(!_){_={};_.name=m.getName();this.oMeasureDetailsSet[m.getName()]=_;this.aMeasureName.push(_.name)}if(m.getRawValueProperty().name==t[y].name){_.rawValuePropertyName=t[y].name}var I=m.getFormattedValueProperty();if(I&&I.name==t[y].name){_.formattedValuePropertyName=t[y].name}_.analyticalInfo=t[y]}if(!c&&!m){u(t[y])}this.mAnalyticalInfoByProperty[t[y].name]=t[y]}Object.keys(this.mHierarchyDetailsByName).forEach(function(t){var r=o.mHierarchyDetailsByName[t];if(!("level"in r)){delete o.mHierarchyDetailsByName[t];if(e.sap.log.isLoggable(e.sap.log.Level.INFO,h)){e.sap.log.info("No level specified for hierarchy node '"+t+"'; ignoring hierarchy","",h)}}else if(!o.oDimensionDetailsSet[t]){o.oDimensionDetailsSet[t]={aAttributeName:[],grouped:r.grouped,isHierarchyDimension:true,name:t};o.aMaxAggregationLevel.push(t);if(r.grouped){o.aAggregationLevel.push(t)}}});for(var R in this.oMeasureDetailsSet){var M=this.oAnalyticalQueryResult.findMeasureByName(R).getUnitProperty();if(M){this.oMeasureDetailsSet[R].unitPropertyName=M.name}}var q=Object.keys(p).sort().join(";")!==Object.keys(this.oDimensionDetailsSet).sort().join(";");if(q){this.iTotalSize=-1}if(q||Object.keys(g).sort().join(";")!==Object.keys(this.oMeasureDetailsSet).sort().join(";")){this.bApplySortersToGroups=true}this.aAnalyticalInfo=t;this.resetData();this.bNeedsUpdate=false;if(this.mParameters.select){this.aAdditionalSelects=f(this)}if(i){this._fireChange({reason:r.Change})}};c.prototype.getAnalyticalInfoForColumn=function(e){return this.mAnalyticalInfoByProperty[e]};c.prototype.loadGroups=function(e){var t=[];for(var r in e){t.push(r);this._resetData(r);var i=e[r];for(var s=0;s<i.length;s++){var n=i[s];this._getContextsForParentGroupId(r,n.startIndex,n.length,n.threshold)}var a=[];for(var o=-1,u;(u=t[++o])!==undefined;){a.push(this._getRequestId(c._requestType.groupMembersQuery,{groupId:u}))}this._considerRequestGrouping(a)}};c.prototype.getAnalyticalQueryResult=function(){return this.oAnalyticalQueryResult};c._requestType={groupMembersQuery:1,totalSizeQuery:2,groupMembersAutoExpansionQuery:3,levelMembersQuery:4,reloadMeasuresQuery:5};c._artificialRootContextGroupId="artificialRootContext";c._addHierarchyLevelFilters=function(e,t){e.forEach(function(e){t.removeConditions(e.propertyName);t.addCondition(e.propertyName,s.EQ,e.level)})};c.prototype._getContextsForParentContext=function(e,t,r,i,s,n,a){if(e===undefined){return[]}if(e&&e.getPath()=="/"+c._artificialRootContextGroupId){e=this.getModel().getContext("/")}var o=this._getGroupIdFromContext(e,s);return this._getContextsForParentGroupId(o,t,r,i,n,a)};c.prototype._getContextsForParentGroupId=function(t,r,i,s,n,a){if(t===undefined){return[]}if(!r){r=0}if(!i){i=this.oModel.iSizeLimit}if(this.mFinalLength[t]&&this.mLength[t]<r+i){i=this.mLength[t]-r;if(i<0){e.sap.log.fatal("invalid start index greater than total group length passed")}}if(!s){s=0}if(!n){n=0}if(t==null){if(n>0){e.sap.log.fatal("invalid request to determine nodes of root context");return null}}else{if(this._getGroupIdLevel(t)>=this.aAggregationLevel.length&&n>0){e.sap.log.fatal("invalid request to determine nodes of context with group ID "+t);return null}if(this._getGroupIdLevel(t)+n>this.aAggregationLevel.length){n=this.aAggregationLevel.length-this._getGroupIdLevel(t)-1}}var o=[],u,l,d,p;var h=t==null?0:this._getGroupIdLevel(t)+1;if(!this.aMultiUnitLoadFactor[h]){this.aMultiUnitLoadFactor[h]=1}var f=n>0&&t!=null;if(f){var g=this._getGroupIdLevel(t);var y=g+n;var v=true;if(!a){d=this._calculateRequiredGroupExpansion(t,y,r,i+s);v=d.groupId_Missing==null;v=v||d.groupId_Missing.length<t.length||d.groupId_Missing.substring(0,t.length)!=t}if(v){o=this._getLoadedContextsForGroup(t,r,i)}else{p=i+s}u=!v;p=Math.ceil(p*this.aMultiUnitLoadFactor[h])}else{o=this._getLoadedContextsForGroup(t,r,i,a);u=false;if(!a){l=this._calculateRequiredGroupSection(t,r,i,s,o);var m=l.length>0&&i<l.length;u=o.length!=i&&!(this.mFinalLength[t]&&o.length>=this.mLength[t]-r)||m;l.length=Math.ceil(l.length*this.aMultiUnitLoadFactor[h])}}if(!u){this._cleanupGroupingForCompletedRequest(this._getRequestId(c._requestType.groupMembersQuery,{groupId:t}))}var _=false;if(this.oModel.getServiceMetadata()){if(u){var I=this.bProvideTotalSize&&this.iTotalSize==-1&&!this._isRequestPending(this._getRequestId(c._requestType.totalSizeQuery));_=true;var R;if(this.bUseBatchRequests){if(f){R=this._prepareGroupMembersAutoExpansionRequestIds(t,n);for(var M=-1,q;(q=R[++M])!==undefined;){if(this._isRequestPending(q)){_=false;break}}if(_){this.aBatchRequestQueue.push([c._requestType.groupMembersAutoExpansionQuery,t,d,p,n])}}else{_=!this._isRequestPending(this._getRequestId(c._requestType.groupMembersQuery,{groupId:t}));if(_){this.aBatchRequestQueue.push([c._requestType.groupMembersQuery,t,l.startIndex,l.length]);R=[this._getRequestId(c._requestType.groupMembersQuery,{groupId:t})]}}if(_&&I){R.push(this._getRequestId(c._requestType.totalSizeQuery));this._considerRequestGrouping(R);this.aBatchRequestQueue.push([c._requestType.totalSizeQuery])}if(_){if(t==null){this._abortAllPendingRequests()}Promise.resolve().then(c.prototype._processRequestQueue.bind(this))}}else{var b;if(f){R=this._prepareGroupMembersAutoExpansionRequestIds(t,n);for(var x=-1,A;(A=R[++x])!==undefined;){if(this._isRequestPending(A)){_=false;break}}if(_){b=this._prepareGroupMembersAutoExpansionQueryRequest(c._requestType.groupMembersAutoExpansionQuery,t,d,p,n)}}else{_=!this._isRequestPending(this._getRequestId(c._requestType.groupMembersQuery,{groupId:t}));if(_){b=this._prepareGroupMembersQueryRequest(c._requestType.groupMembersQuery,t,l.startIndex,l.length);R=[b.sRequestId]}}if(_){if(t==null){this._abortAllPendingRequests()}this._executeQueryRequest(b);if(I&&!b.bIsFlatListRequest){R.push(this._getRequestId(c._requestType.totalSizeQuery));this._considerRequestGrouping(R);this._executeQueryRequest(this._prepareTotalSizeQueryRequest(c._requestType.totalSizeQuery))}}}}}return o};c.prototype._getHierarchyLevelFiltersAndAddRecursiveHierarchy=function(t,r){var i,s=[],n=this;if(r===null){return s}i=Object.keys(this.mHierarchyDetailsByName);if(i.length>0&&r!=="/"){e.sap.log.error("Hierarchy cannot be requested for members of a group",r,h);return s}i.forEach(function(e){var r=n.mHierarchyDetailsByName[e];t.addRecursiveHierarchy(r.dimensionName,!!r.nodeExternalKeyName,!!r.nodeTextName);s.push({propertyName:r.nodeLevelName,level:r.level})});return s};c.prototype._getNonHierarchyDimensions=function(e){var t=this;return e.filter(function(e){return!t.oDimensionDetailsSet[e].isHierarchyDimension})};c.prototype._processRequestQueue=function(t){if(t===undefined||t===null){t=this.aBatchRequestQueue||[]}if(t.length==0){return}var r=[];var i=false;var s,n,a;for(s=-1;(a=t[++s])!==undefined;){if(a[0]==c._requestType.groupMembersQuery){n=c.prototype._prepareGroupMembersQueryRequest.apply(this,a);i=i||n.bIsFlatListRequest;r.push(n)}}for(s=-1;(a=t[++s])!==undefined;){n=null;switch(a[0]){case c._requestType.groupMembersQuery:continue;case c._requestType.totalSizeQuery:if(!i){n=c.prototype._prepareTotalSizeQueryRequest.apply(this,a);r.push(n)}break;case c._requestType.groupMembersAutoExpansionQuery:n=c.prototype._prepareGroupMembersAutoExpansionQueryRequest.apply(this,a);for(var o=-1,u;(u=n.aGroupMembersAutoExpansionRequestDetails[++o])!==undefined;){r.push(u)}break;case c._requestType.reloadMeasuresQuery:{var l=a[1];for(var d=-1,p;(p=l[++d])!==undefined;){r.push(p)}break}default:e.sap.log.fatal("unhandled request type "+t[s][0]);continue}}if(r.length>1){this._executeBatchRequest(r)}else{this._executeQueryRequest(r[0])}if(t===this.aBatchRequestQueue){this.aBatchRequestQueue=[]}};c.prototype._prepareGroupMembersQueryRequest=function(t,r,i,n){var a=[],o=[],u;var d=new l.QueryResultRequest(this.oAnalyticalQueryResult);d.setResourcePath(this._getResourcePath());d.getSortExpression().clear();var p=0,h=-1;if(r){a=this._getGroupIdComponents(r);p=h=a.length;var f=0;for(var g=0,y=0;g<p;y++){if(this.oDimensionDetailsSet[this.aMaxAggregationLevel[y]].grouped==false){++f}else{++g}}p=h=p+f;if(this.aMaxAggregationLevel.length>0){while(this.oDimensionDetailsSet[this.aMaxAggregationLevel[h]].grouped==false){if(++h==this.aMaxAggregationLevel.length){break}}}}var v=h>=this.aMaxAggregationLevel.length-1;u=this._getHierarchyLevelFiltersAndAddRecursiveHierarchy(d,r);var m=this.aMaxAggregationLevel.slice(0,h+1);var _=this._getNonHierarchyDimensions(m);d.setAggregationLevel(_);for(var I=0;I<_.length;I++){var R=this.oDimensionDetailsSet[_[I]];var M=R.textPropertyName!=undefined;d.includeDimensionKeyTextAttributes(R.name,true,M,R.aAttributeName);if(R.grouped){o.push({sPath:_[I],bDescending:false})}}var q=d.getFilterExpression();q.clear();if(this.aApplicationFilter){q.addUI5FilterConditions(this.aApplicationFilter)}if(this.aControlFilter){q.addUI5FilterConditions(this.aControlFilter)}if(p>=1){for(var b=0,x=a.length;b<x;b++){q.removeConditions(this.aAggregationLevel[b]);q.addCondition(this.aAggregationLevel[b],s.EQ,a[b])}}c._addHierarchyLevelFilters(u,q);var A;var S;var P;var L;var N=[];if(r!=null||this.bProvideGrandTotals||this._canApplySortersToGroups()&&this.aSorter.length>0){d.setMeasures(this.aMeasureName);for(var D in this.oMeasureDetailsSet){L=this.oMeasureDetailsSet[D];if(!v&&this.mAnalyticalInfoByProperty[D].total==false){A=false;S=false;P=false}else{A=L.rawValuePropertyName!=undefined;S=L.formattedValuePropertyName!=undefined;P=L.unitPropertyName!=undefined;if(P){if(e.inArray(L.unitPropertyName,N)==-1){N.push(L.unitPropertyName)}}}d.includeMeasureRawFormattedValueUnit(L.name,A,S,P)}for(var G in _){var Q;if((Q=e.inArray(_[G],N))!=-1){N.splice(Q,1)}}}this._addSorters(d.getSortExpression(),o);if(n==0){e.sap.log.fatal("unhandled case: load 0 entities of sub group")}var F=this._getKeyIndexMapping(r,i);if(!this.bNoPaging){d.setResultPageBoundaries(F.iServiceKeyIndex+1,F.iServiceKeyIndex+n)}d.setRequestOptions(null,!this.mFinalLength[r]);return{iRequestType:t,sRequestId:this._getRequestId(c._requestType.groupMembersQuery,{groupId:r}),oAnalyticalQueryRequest:d,sGroupId:r,aSelectedUnitPropertyName:N,aAggregationLevel:m,bIsFlatListRequest:v&&p==0,bIsLeafGroupsRequest:v,iStartIndex:i,iLength:n,oKeyIndexMapping:F}};c.prototype._prepareTotalSizeQueryRequest=function(e){var t;var r=new l.QueryResultRequest(this.oAnalyticalQueryResult);r.setResourcePath(this._getResourcePath());t=this._getHierarchyLevelFiltersAndAddRecursiveHierarchy(r,"/");r.setAggregationLevel(this._getNonHierarchyDimensions(this.aMaxAggregationLevel));r.setMeasures([]);var i=r.getFilterExpression();i.clear();if(this.aApplicationFilter){i.addUI5FilterConditions(this.aApplicationFilter)}if(this.aControlFilter){i.addUI5FilterConditions(this.aControlFilter)}c._addHierarchyLevelFilters(t,i);r.setRequestOptions(null,null,true);r.setRequestOptions(null,true);return{iRequestType:e,sRequestId:this._getRequestId(c._requestType.totalSizeQuery),oAnalyticalQueryRequest:r}};c.prototype._prepareGroupMembersAutoExpansionQueryRequest=function(t,r,n,a,o){var u=this;var d=function(t,r){var n=[];if(t.groupId_Missing==null){e.sap.log.fatal("missing group Id not present");return n}var a=u._getGroupIdComponents(t.groupId_Missing);var o=a.length;if(o>r){e.sap.log.fatal("the given group ID is too deep for requested level for auto expansion");return n}var l=[];for(var d=0;d<o;d++){var p=u.aAggregationLevel[d];var h=a[d];var f=u._getFilterOperatorMatchingPropertySortOrder(p);l[d]=new i(p,f,h)}var g=null;if(t.startIndex_Missing>0){var y=u._getKey(t.groupId_Missing,t.startIndex_Missing-1);var c=u.oModel.getObject("/"+y);var v=u.aAggregationLevel[o];var m=c[v];g=new i(v,u._getFilterOperatorMatchingPropertySortOrder(v,false),m)}for(var _=0;_<r;_++){var I=[];var R=Math.min(o,_+1);for(var M=0;M<R;M++){var q=[];var b=Math.min(o,M+1);var x=t.startIndex_Missing>0;for(var A=0;A<b;A++){var S=new i("x",s.EQ,"x");S=e.extend(true,S,l[A]);if(b>1&&A<b-1){S.sOperator=s.EQ}if(A==o-1&&_>o-1&&!x){if(S.sOperator==s.GT){S.sOperator=s.GE}else{S.sOperator=s.LE}}q.push(S)}if(q.length>0){I.push(new i(q,true));if(_>o-1&&M==o-1&&x){var P=[];for(var L=0;L<q.length;L++){var N=new i("x",s.EQ,"x");N=e.extend(true,N,q[L]);P.push(N)}P[o-1].sOperator=s.EQ;P.push(g);I.push(new i(P,true));break}}}if(I.length>0){n[_]=new i(I,false)}else{n[_]=null}}return n};var p=function(t,r,i,s,n,a,o,d){var p;var h=new l.QueryResultRequest(u.oAnalyticalQueryResult);h.setResourcePath(u._getResourcePath());h.getSortExpression().clear();var f=0,g=-1;f=g=i-1;var y=0;for(var v=0,m=0;v<f;m++){if(u.oDimensionDetailsSet[u.aMaxAggregationLevel[m]].grouped==false){++y}else{++v}}f=g=f+y;if(u.aMaxAggregationLevel.length>0){while(u.oDimensionDetailsSet[u.aMaxAggregationLevel[g]].grouped==false){if(++g==u.aMaxAggregationLevel.length){break}}}var _=g>=u.aMaxAggregationLevel.length-1;p=u._getHierarchyLevelFiltersAndAddRecursiveHierarchy(h,r);var I=u.aMaxAggregationLevel.slice(0,g+1);h.setAggregationLevel(I);for(var R=0;R<I.length;R++){var M=u.oDimensionDetailsSet[I[R]];var q=M.textPropertyName!=undefined;h.includeDimensionKeyTextAttributes(M.name,true,q,M.aAttributeName);if(M.grouped){h.getSortExpression().addSorter(I[R],l.SortOrder.Ascending)}}var b=h.getFilterExpression();b.clear();if(u.aApplicationFilter){b.addUI5FilterConditions(u.aApplicationFilter)}if(u.aControlFilter){b.addUI5FilterConditions(u.aControlFilter)}if(s){b.addUI5FilterConditions([s])}c._addHierarchyLevelFilters(p,b);var x;var A;var S;var P;var L=[];h.setMeasures(u.aMeasureName);for(var N in u.oMeasureDetailsSet){P=u.oMeasureDetailsSet[N];if(!_&&u.mAnalyticalInfoByProperty[N].total==false){x=false;A=false;S=false}else{x=P.rawValuePropertyName!=undefined;A=P.formattedValuePropertyName!=undefined;S=P.unitPropertyName!=undefined;if(S){if(e.inArray(P.unitPropertyName,L)==-1){L.push(P.unitPropertyName)}}}h.includeMeasureRawFormattedValueUnit(P.name,x,A,S)}for(var D in I){var G;if((G=e.inArray(I[D],L))!=-1){L.splice(G,1)}}var Q=h.getSortExpression();for(var F=0;F<u.aSorter.length;F++){if(u.aSorter[F]){Q.addSorter(u.aSorter[F].sPath,u.aSorter[F].bDescending?l.SortOrder.Descending:l.SortOrder.Ascending)}}if(a==0){e.sap.log.fatal("unhandled case: load 0 entities of sub group")}var C=n;if(!d){C=0}else{var T=0;for(var K in u.mServiceKey){if(K.split("/").length===i+1){T+=u.mServiceKey[K].length}}C=Math.max(C,T)}if(!u.bNoPaging){h.setResultPageBoundaries(C+1,a)}return{iRequestType:t,sRequestId:null,oAnalyticalQueryRequest:h,iLevel:i,aSelectedUnitPropertyName:L,aAggregationLevel:I,bIsFlatListRequest:_,bIsLeafGroupsRequest:_,iStartIndex:n,iLength:a,bAvoidLengthUpdate:o}};var h=[];var f=[];if(!n){e.sap.log.fatal("no first missing group member specified")}var g=this._getGroupIdLevel(r)+o+1;var y=u._getGroupIdComponents(n.groupId_Missing);var v=y.length;var m=d(n,g);var _;for(var I=1;I<=g;I++){var R;if(I>=v+2){R=0;_=undefined}else if(I==v+1){R=n.startIndex_Missing;_=n.groupId_Missing}else if(v>0){if(I==v){_=n.groupId_Missing}else{_=this._getGroupIdAncestors(n.groupId_Missing,-(v-I))[0]}var M=this._getGroupIdAncestors(n.groupId_Missing,-(v-I+1))[0];if(!M){e.sap.log.fatal("failed to determine group id at parent level; group ID = "+r+", level = "+I)}R=this._findKeyIndex(M,this.mEntityKey[_]);if(R==-1){e.sap.log.fatal("failed to determine position of value "+_+" in group "+M)}_=M;R++}var q=a>I?Math.ceil((a-I)/(g-I+1)):a;var b=m[I-1];if(this.bUseAcceleratedAutoExpand){var x=p(c._requestType.levelMembersQuery,r,I,b,R,q,false,b==null?true:false);x.sGroupId_Missing_AtLevel=_;x.sRequestId=this._getRequestId(c._requestType.levelMembersQuery,{groupId:r,level:I});h.push(x);f.push(x.sRequestId)}else if(b&&b.aFilters.length>0){if(!b._bMultiFilter||b.bAnd){e.sap.log.fatal("level filter in wrong shape; cannot break it up")}for(var A=0;A<b.aFilters.length;A++){var S=b.aFilters[A];var P=p(c._requestType.levelMembersQuery,r,I,S,R,q,false,b==null?true:false);P.sGroupId_Missing_AtLevel=_;P.sRequestId=this._getRequestId(c._requestType.levelMembersQuery,{groupId:r,level:I,tupleIndex:A});h.push(P);f.push(P.sRequestId)}}else{var L=p(c._requestType.levelMembersQuery,r,I,null,R,q,false,b==null?true:false);L.sGroupId_Missing_AtLevel=_;L.sRequestId=this._getRequestId(c._requestType.levelMembersQuery,{groupId:r,level:I});h.push(L);f.push(L.sRequestId)}}return{iRequestType:t,aRequestId:f,aGroupMembersAutoExpansionRequestDetails:h,sGroupId:r,iLength:a}};c.prototype._prepareReloadMeasurePropertiesQueryRequest=function(t,r,n){var a=new l.QueryResultRequest(this.oAnalyticalQueryResult);a.setResourcePath(this._getResourcePath());a.getSortExpression().clear();var o=r.aAggregationLevel;a.setAggregationLevel(o);var u=r.bIsLeafGroupsRequest;var d=a.getFilterExpression();d.clear();if(this.aApplicationFilter){d.addUI5FilterConditions(this.aApplicationFilter)}if(this.aControlFilter){d.addUI5FilterConditions(this.aControlFilter)}var p=[];for(var h=0;h<o.length;h++){var f=new i(o[h],s.EQ,n.oEntry[o[h]]);p.push(f)}d.addUI5FilterConditions(p);var g;var y;var v;var m;var _=[];a.setMeasures(n.aReloadMeasurePropertyName);for(var I in this.oMeasureDetailsSet){m=this.oMeasureDetailsSet[I];if(e.inArray(m.name,n.aReloadMeasurePropertyName)==-1){continue}if(!u&&this.mAnalyticalInfoByProperty[I].total==false){g=false;y=false;v=false}else{g=m.rawValuePropertyName!=undefined;y=m.formattedValuePropertyName!=undefined;v=m.unitPropertyName!=undefined;if(v){if(e.inArray(m.unitPropertyName,_)==-1){_.push(m.unitPropertyName)}}}a.includeMeasureRawFormattedValueUnit(m.name,g,y,v)}for(var R in o){var M;if((M=e.inArray(o[R],_))!=-1){_.splice(M,1)}}return{iRequestType:t,sRequestId:this._getRequestId(c._requestType.reloadMeasuresQuery,{multiUnitEntryKey:this.oModel.getKey(n.oEntry)}),oAnalyticalQueryRequest:a,aSelectedUnitPropertyName:_,aAggregationLevel:o,oMultiUnitRepresentative:n}};c.prototype._prepareGroupMembersAutoExpansionRequestIds=function(e,t){var r=this._getGroupIdLevel(e)+1;var i=r+t;var s=[];for(var n=r;n<=i;n++){s.push(this._getRequestId(c._requestType.levelMembersQuery,{groupId:e,level:n}))}return s};c.prototype._getQueryODataRequestOptions=function(t,r,i){var s;i=i||{};try{t.getFilterExpression().checkValidity()}catch(t){e.sap.log.fatal("filter expression is not valid",t.toString());return undefined}var n=t.getURIQueryOptionValue("$select");var a=t.getURIQueryOptionValue("$filter");var o=t.getURIQueryOptionValue("$orderby");var u=t.getURIQueryOptionValue("$skip");var l=t.getURIQueryOptionValue("$top");var d=t.getURIQueryOptionValue("$inlinecount");if(r&&this.aAdditionalSelects.length>0){n=(n?n.split(","):[]).concat(this.aAdditionalSelects).join(",")}if(this.mParameters&&this.mParameters["filter"]){if(a===null){a=this.mParameters["filter"]}else{a+="and ("+this.mParameters["filter"]+")"}}var p=[];if(n!==null){p.push("$select="+n)}if(a!==null){p.push("$filter="+a)}if(o!==null){p.push("$orderby="+o)}if(u!==null){p.push("$skip="+u)}if(l!==null){p.push("$top="+l)}if(d!==null){p.push("$inlinecount="+d)}if(i.encode===true){for(s=0;s<p.length;s++){p[s]=p[s].replace(/\ /g,"%20")}}return p};c.prototype._executeBatchRequest=function(t){var r=this.iAnalyticalInfoVersionNumber,i,s=this;var n=[],a=[];function o(){s.fireDataReceived({__simulateAsyncAnalyticalBinding:true})}var u=new d;function l(e,t){u.success(t)}function h(e,t){u.error(t||e)}this.bNeedsUpdate=true;for(var f=0;f<t.length;f++){var g=t[f];if(g.aAggregationLevel&&g.aAggregationLevel.length>0){this.bNeedsUpdate=false}}for(var y=-1,v;(v=t[++y])!==undefined;){var m=v.oAnalyticalQueryRequest,_=v.sGroupId;if(m.getURIQueryOptionValue("$select")==null){this.fireDataRequested({__simulateAsyncAnalyticalBinding:true});_=null;this.mServiceLength[_]=this.mLength[_]=1;this.mServiceFinalLength[_]=true;this._setServiceKey(this._getKeyIndexMapping(_,0),c._artificialRootContextGroupId);setTimeout(o);this.bArtificalRootContext=true;continue}var I=m.getURIToQueryResultEntries();if(!this.oContext&&I[0]!=="/"){I="/"+I}if(!this._isRequestPending(v.sRequestId)){this._registerNewRequest(v.sRequestId);if(this.iModelVersion===p.V1){n.push(this.oModel.createBatchOperation(I.replace(/\ /g,"%20"),"GET"))}else if(this.iModelVersion===p.V2){var R=this._getQueryODataRequestOptions(m,v.bIsLeafGroupsRequest,{encode:true});if(this.sCustomParams){R.push(this.sCustomParams)}var M=this.oModel.read(I.replace(/\ /g,"%20"),{success:l,error:h,context:this.oContext,urlParameters:R});n.push(M)}a.push(v)}}if(n.length>0){e.sap.log.debug("AnalyticalBinding: executing batch request with "+a.length+" operations");var q;i=this._getIdForNewRequestHandle();this.fireDataRequested();if(this.iModelVersion===p.V1){this.oModel.addBatchReadOperations(n);q=this.oModel.submitBatch(b,x,true,true);this.oModel.fireRequestSent({url:this.oModel.sServiceUrl+"/$batch",type:"POST",async:true,info:"",infoObject:{}})}else{q={abort:function(){for(var e=0;e<n.length;e++){n[e].abort()}}};u.setup({executedRequests:a,binding:this,success:b,error:x})}this._registerNewRequestHandle(i,q)}function b(t,n){s._deregisterHandleOfCompletedRequest(i);if(a.length!=t.__batchResponses.length){e.sap.log.fatal("assertion failed: received "+t.__batchResponses.length+" responses for "+a.length+" read operations in the batch request")}if(r!=s.iAnalyticalInfoVersionNumber){for(var o=0;o<a.length;o++){var u=a[o].sRequestId;if(u!==undefined){s._deregisterCompletedRequest(u);s._cleanupGroupingForCompletedRequest(u)}}s.fireDataReceived({data:[]});return}var l=0;for(var d=0;d<t.__batchResponses.length;d++){if(t.__batchResponses[d].data!=undefined){if(t.__batchResponses[d].data.results.length==0){l++}switch(a[d].iRequestType){case c._requestType.groupMembersQuery:s._processGroupMembersQueryResponse(a[d],t.__batchResponses[d].data);break;case c._requestType.totalSizeQuery:s._processTotalSizeQueryResponse(a[d],t.__batchResponses[d].data);break;case c._requestType.levelMembersQuery:s._processLevelMembersQueryResponse(a[d],t.__batchResponses[d].data);break;case c._requestType.reloadMeasuresQuery:s._processReloadMeasurePropertiesQueryResponse(a[d],t.__batchResponses[d].data);break;default:e.sap.log.fatal("invalid request type "+a[d].iRequestType);continue}}s._deregisterCompletedRequest(a[d].sRequestId);s._cleanupGroupingForCompletedRequest(a[d].sRequestId)}if(s.mParameters&&s.mParameters.numberOfExpandedLevels>0){if(l==t.__batchResponses.length){s.mLength["/"]=0;s.mFinalLength["/"]=true}}var h=true;var f;s.fireDataReceived({data:t});var g={};if(s.iModelVersion===p.V1){f=s.oModel._getBatchErrors(t);if(f.length>0){h=false;g=s.oModel._handleError(f[0])}s.oModel.fireRequestCompleted({url:n.requestUri,type:"POST",async:true,info:"",infoObject:{},success:h,errorobject:h?{}:g});if(h){s.oModel.checkUpdate()}}}function x(e){if(e&&e.statusText!="abort"){s._deregisterHandleOfCompletedRequest(i);for(var t=-1,n;(n=a[++t])!==undefined;){s._deregisterCompletedRequest(n.sRequestId);s._cleanupGroupingForCompletedRequest(n.sRequestId)}}if(r!=s.iAnalyticalInfoVersionNumber){return}var o=e;if(s.iModelVersion===p.V1){o=s.oModel._handleError(e)}s.oModel.fireRequestCompleted({url:"",type:"POST",async:true,info:"",infoObject:{},success:false,errorobject:o});if(s.iModelVersion===p.V1){s.oModel.fireRequestFailed(o)}s.fireDataReceived()}};c.prototype._executeQueryRequest=function(t){if(t.iRequestType==c._requestType.groupMembersAutoExpansionQuery){for(var r=-1,i;(i=t.aGroupMembersAutoExpansionRequestDetails[++r])!==undefined;){this._executeQueryRequest(i)}return}var s=this.iAnalyticalInfoVersionNumber;var n=t.oAnalyticalQueryRequest,a=t.sGroupId;var o=n.getURIToQueryResultEntitySet();var u=this._getQueryODataRequestOptions(n,t.bIsLeafGroupsRequest);if(!u){return}var l=this;if(n.getURIQueryOptionValue("$select")==null){this.fireDataRequested({__simulateAsyncAnalyticalBinding:true});a=null;this.mServiceLength[a]=this.mLength[a]=1;this.mServiceFinalLength[a]=true;this._setServiceKey(this._getKeyIndexMapping(a,0),c._artificialRootContextGroupId);this.bNeedsUpdate=true;setTimeout(function(){if(l._cleanupGroupingForCompletedRequest(t.sRequestId)){l.fireDataReceived({__simulateAsyncAnalyticalBinding:true})}});this.bArtificalRootContext=true;return}this._registerNewRequest(t.sRequestId);this.fireDataRequested();for(var d=0;d<u.length;d++){u[d]=u[d].replace(/\ /g,"%20")}e.sap.log.debug("AnalyticalBinding: executing query request");var h=this._getIdForNewRequestHandle();if(this.iModelVersion===p.V1){this.oModel._loadData(o,u,g,v,false,m,y)}else{if(this.sCustomParams){u.push(this.sCustomParams)}var f=this.oModel.read(o,{success:g,error:v,context:this.oContext,urlParameters:u});l._registerNewRequestHandle(h,f)}function g(r){l._deregisterHandleOfCompletedRequest(h);if(s!=l.iAnalyticalInfoVersionNumber){l._deregisterCompletedRequest(t.sRequestId);return}switch(t.iRequestType){case c._requestType.groupMembersQuery:l._processGroupMembersQueryResponse(t,r);break;case c._requestType.totalSizeQuery:l._processTotalSizeQueryResponse(t,r);break;case c._requestType.levelMembersQuery:l._processLevelMembersQueryResponse(t,r);break;case c._requestType.reloadMeasuresQuery:l._processReloadMeasurePropertiesQueryResponse(t,r);break;default:e.sap.log.fatal("invalid request type "+t.iRequestType);break}l._deregisterCompletedRequest(t.sRequestId);if(l.iModelVersion===p.V2){y(r)}}function y(e){if(s!=l.iAnalyticalInfoVersionNumber){return}if(l._cleanupGroupingForCompletedRequest(t.sRequestId)){l.fireDataReceived({data:e})}}function v(e){if(e&&e.statusText=="abort"){l.fireDataReceived();return}l._deregisterHandleOfCompletedRequest(h);l._deregisterCompletedRequest(t.sRequestId);l._cleanupGroupingForCompletedRequest(t.sRequestId);if(s!=l.iAnalyticalInfoVersionNumber){return}l.fireDataReceived()}function m(e){l._registerNewRequestHandle(h,e)}};c.prototype._abortAllPendingRequests=function(){this._abortAllPendingRequestsByHandle();this._clearAllPendingRequests()};c.prototype._processGroupMembersQueryResponse=function(t,r){var i,s=t.sGroupId,n=this.aSorter.length>0,a=t.aSelectedUnitPropertyName,o=t.aAggregationLevel,u=t.oKeyIndexMapping.iIndex,l=t.oKeyIndexMapping.iServiceKeyIndex,d=t.iLength,p=t.oKeyIndexMapping,h=s==null?0:this._getGroupIdLevel(s)+1,f=a.length>0,g,y,m,_=0,I,R,M=[];var q=r.results.length;if(s===null&&q>1&&this._canApplySortersToGroups()){this._warnNoSortingOfGroups(n?"binding is refreshed":undefined);if(n){setTimeout(this.refresh.bind(this),0);return}}var b=this._getServiceKeys(s,p.iIndex-1);g=undefined;if(b&&b.length>0){for(var x=0,A=b.length;x<A;x++){r.results[x-A]=this.oModel.getObject("/"+b[x])}var S=r.results[-b.length];g="";for(var P=0;P<o.length;P++){g+=S[o[P]]+"|"}}I=b&&b.length==1;for(var L=0;L<q;L++){var N=r.results[L];if(f){y="";for(var D=0;D<o.length;D++){y+=N[o[D]]+"|"}if(g==y){this._warnNoSortingOfGroups();if(m===undefined){if(L==0){m=-b.length;p.iServiceKeyIndex-=b.length-1}else{m=L-1}}var G=-1,Q=r.results[L-1];for(var F=0;F<a.length;F++){if(Q[a[F]]!=N[a[F]]){G=F;break}}if(G==-1){e.sap.log.fatal("assertion failed: no deviating units found for result entries "+(L-1)+" and "+L,null,null,v(this,"NO_DEVIATING_UNITS"))}}if((g!=y||L==q-1)&&m!==undefined){var C=[];for(var T=m;T<L;T++){C.push(r.results[T])}if(g==y){C.push(r.results[L])}var K=[];for(var E=0;E<a.length;E++){var O=a[E];for(var U=1;U<C.length;U++){if(C[U-1][O]!=C[U][O]){K.push(O);break}}}var w=this._createMultiUnitRepresentativeEntry(s,r.results[m],a,K,t.bIsFlatListRequest);if(w.aReloadMeasurePropertyName.length>0){R=this._prepareReloadMeasurePropertiesQueryRequest(c._requestType.reloadMeasuresQuery,t,w);if(R.oAnalyticalQueryRequest&&R.oAnalyticalQueryRequest.getURIQueryOptionValue("$select")!=null){M.push(R)}}var V=this._setAdjacentMultiUnitKeys(p,w,C);var B;if(w.bIsNewEntry){B=C.length-1}else{B=V}if(I){I=false}if(B<0){e.sap.log.fatal("assertion failed: iDiscardedEntriesCount must be non-negative")}_+=B;var H=this.oModel._getKey(w.oEntry);var k=this.oModel.getContext("/"+H);this._getGroupIdFromContext(k,h);this.mEntityKey[i]=H;m=undefined;if(g!=y){I=this._setServiceKey(p,this.oModel._getKey(N))}}else if(g!=y){I=this._setServiceKey(p,this.oModel._getKey(N))}g=y}else{this._setServiceKey(p,this.oModel._getKey(N))}if(!t.bIsLeafGroupsRequest){var z=this._getKey(s,p.iIndex-1);i=this._getGroupIdFromContext(this.oModel.getContext("/"+z),h);this.mEntityKey[i]=z}}var j=[];if(this.bReloadSingleUnitMeasures&&M.length>0){if(this.bUseBatchRequests){this.aBatchRequestQueue.push([c._requestType.reloadMeasuresQuery,M]);Promise.resolve().then(c.prototype._processRequestQueue.bind(this))}else{for(var $=0;$<M.length;$++){var Z=M[$];this._executeQueryRequest(Z)}}for(var W=0;W<M.length;W++){var J=M[W];j.push(J.sRequestId)}this._considerRequestGrouping(j)}if(b&&b.length>0){for(var X=0,Y=b.length;X<Y;X++){delete r.results[X-Y]}}if(f){_+=this._mergeLoadedKeyIndexWithSubsequentIndexes(p,o,a,t.bIsFlatListRequest)}if(!t.bAvoidLengthUpdate){var ee=false;if(r.__count){this.mServiceLength[s]=parseInt(r.__count,10);this.mLength[s]=this.mServiceLength[s]-_;this.mFinalLength[s]=true;if(t.bIsFlatListRequest){this.iTotalSize=r.__count}ee=true}if(this.mServiceLength[s]<l+q){this.mServiceLength[s]=l+q;this.mLength[s]=u+q-_;this.mFinalLength[s]=false}if(q<d||d===undefined){this.mServiceLength[s]=l+q;this.mLength[s]=u+p.iIndex-u;this.mFinalLength[s]=true;ee=true}if(q==0){this.mLength[s]=this.mServiceLength[s]=0;this.mFinalLength[s]=true;ee=true}if(!ee&&this.mLength[s]!==undefined&&_>0){this.mLength[s]-=_}}this.bNeedsUpdate=true;if(_>0){if(r.results.length-_>0){this.aMultiUnitLoadFactor[o.length]=r.results.length/(r.results.length-_)}if(this.aMultiUnitLoadFactor[o.length]<1.5){this.aMultiUnitLoadFactor[o.length]=2}}e.sap.log.info("MultiUnit Situation in Group ("+s+"), discarded: "+_+", load-factor is now: "+this.aMultiUnitLoadFactor[o.length])};c.prototype._processTotalSizeQueryResponse=function(t,r){if(r.__count==undefined){e.sap.log.fatal("missing entity count in query result");return}this.iTotalSize=r.__count};c.prototype._processLevelMembersQueryResponse=function(t,r){var i=this;var s,n;var a=function(a,o){var u={iRequestType:c._requestType.groupMembersQuery,sRequestId:i._getRequestId(c._requestType.groupMembersQuery,{groupId:s}),oAnalyticalQueryRequest:t.oAnalyticalQueryRequest,sGroupId:s,aSelectedUnitPropertyName:t.aSelectedUnitPropertyName,aAggregationLevel:t.aAggregationLevel,bIsFlatListRequest:t.bIsFlatListRequest,bIsLeafGroupsRequest:t.bIsLeafGroupsRequest,iStartIndex:a?t.iStartIndex:0,iLength:t.iLength,bAvoidLengthUpdate:t.bAvoidLengthUpdate};if(a&&t.iStartIndex>0&&(t.sGroupId_Missing_AtLevel!=u.sGroupId||i._getKeys(u.sGroupId)===undefined)){var l=i._getParentGroupId(u.sGroupId);var d=i._findKeyIndex(l,i.mEntityKey[u.sGroupId]);if(d==-1){e.sap.log.fatal("assertion failed: failed to determine position of "+u.sGroupId+" in group "+l)}if(d>0&&i._getKey(l,d-1)!==undefined){var p=i._getKey(l,d-1);var h=i._getGroupIdFromContext(i.oModel.getContext("/"+p),i._getGroupIdLevel(u.sGroupId));i.mFinalLength[h]=true;u.iStartIndex=0}}if(o){u.iLength=n.length}u.oKeyIndexMapping=i._getKeyIndexMapping(u.sGroupId,u.iStartIndex);var f=e.extend(true,{},r);f.results=n;i._processGroupMembersQueryResponse(u,f)};if(r.results.length==0){return}s=this._getGroupIdFromContext(this.oModel.getContext("/"+this.oModel._getKey(r.results[0])),t.iLevel-1);n=[];var o=true;for(var u=0;u<r.results.length;u++){var l=r.results[u];var d=this.oModel.getContext("/"+this.oModel._getKey(r.results[u]));var p=this._getGroupIdFromContext(d,t.iLevel-1);if(s==p){n.push(l);if(u<r.results.length-1){continue}}a(o,r.results.length==t.iLength&&u==r.results.length-1);o=false;if(s!=p){n=[l]}s=p}if(r.results.length>1&&n.length==1){a(o,r.results.length==t.iLength)}};c.prototype._processReloadMeasurePropertiesQueryResponse=function(t,r){var i=t.oMultiUnitRepresentative;var s=this.oModel.getKey(i.oEntry);if(r.results.length!=1){e.sap.log.fatal("assertion failed: more than one entity for reloaded measure properties of entity with key "+s);return}var n=r.results[0];var a=this.oModel.getObject("/"+s);if(!a){e.sap.log.fatal("assertion failed: no entity found with key "+s);return}var o=i.aReloadMeasurePropertyName;for(var u=0;u<o.length;u++){a[o[u]]=n[o[u]]}};c.prototype._getLoadedContextsForGroup=function(e,t,r,i){var s=[],n,a,o=this._getKeys(e),u;if(!o){return s}if(!t){t=0}if(!r){r=this.oModel.iSizeLimit;if(this.mFinalLength[e]){r=this.mLength[e]}}if(i){a=t||0;u=o(a);while(u){n=this.oModel.getContext("/"+u);s.push(n);a++;u=o(a)}return s}for(a=t;a<t+r;a++){u=o(a);if(!u){break}n=this.oModel.getContext("/"+u);s.push(n)}return s};c.prototype._calculateRequiredGroupSection=function(e,t,r,i,s){var n,a,o,u,l,d={},p=this._getKeys(e),h;a=t;n=0;if(!p){u=t;o=t+r}else{for(var f=t-1;f>=Math.max(t-i,0);f--){h=p(f);if(!h){u=f+1;break}}for(var g=t+r;g<t+r+i;g++){h=p(g);if(!h){o=g;break}}}l=t-u;if(u&&t>i&&l<i){if(s.length!==r){a=t-i}else{a=u-i}n=i}a=Math.max(a,0);if(a===t){a+=s.length}if(s.length!==r){n+=r-s.length}l=o-t-r;if(l==0){n+=i}if(o&&l<i&&l>0){if(a>t){a=o;n+=i}}if(this.mFinalLength[e]&&this.mLength[e]<n+a){n=this.mLength[e]-a}d.startIndex=a;d.length=n;return d};c.prototype._calculateRequiredGroupExpansion=function(e,t,r,i){var s={groupId_Missing:null,length_Missing:0};var n=this;var a=function(e,t,r,i){var o=n._getGroupIdLevel(e);if(o==t){var u=n._getLoadedContextsForGroup(e,r,i);var l=r+u.length-1;if(u.length>=i){return s}else if(n.mFinalLength[e]){if(u.length>=n.mLength[e]){return{groupId_Missing:null,length_Missing:i-u.length}}else{return{groupId_Missing:e,startIndex_Missing:l+1,length_Missing:i-u.length}}}else{return{groupId_Missing:e,startIndex_Missing:l+1,length_Missing:i-u.length}}}var d=n._getLoadedContextsForGroup(e,r,i);var p=i,h=r+d.length-1;for(var f=-1,g;(g=d[++f])!==undefined;){p--;var y=a(n._getGroupIdFromContext(g,o+1),t,0,p);if(y.groupId_Missing==null){if(y.length_Missing==0){return y}else{p=y.length_Missing}}else{return y}if(p==0){break}}if(n.mFinalLength[e]||p==0){return{groupId_Missing:null,length_Missing:p}}else{return{groupId_Missing:e,startIndex_Missing:h+1,length_Missing:p}}};var o=this._getGroupIdLevel(e);if(o==t+1){e=this._getParentGroupId(e);--o}if(e==null||o>t){return s}var u=i,l=r;while(e!=null){var d=a(e,t,l,u);if(d.groupId_Missing!=null){return d}else if(d.length_Missing==0){return d}else{var p=false;while(!p){var h=this._getParentGroupId(e);if(h==null){e=h;--o;break}var f=this.mEntityKey[e];if(!f){return s}var g=this._findKeyIndex(h,f);if(g==-1){return s}if(g==this._getKeyCount(h)-1){if(this.mFinalLength[h]){e=h;--o;continue}else{return{groupId_Missing:h,startIndex_Missing:g+1,length_Missing:u}}}else{f=this._getKey(h,g+1);e=this._getGroupIdFromContext(this.oModel.getContext("/"+f),o);p=true}}l=0;u=d.length_Missing}}return{groupId_Missing:null,length_Missing:u}};c.prototype._getResourcePath=function(){return this.isRelative()?this.oModel.resolve(this.sPath,this.getContext()):this.sPath};c.prototype._getEntitySet=function(){var e=this.sEntitySetName;if(!e){e=this.sPath.split("/")[1];if(e.indexOf("(")!=-1){e=e.split("(")[0]+"Results"}}return e};c.prototype._getEffectiveSortOrder=function(e){for(var t=0;t<this.aSorter.length;t++){if(this.aSorter[t]&&this.aSorter[t].sPath==e){return this.aSorter[t].bDescending?l.SortOrder.Descending:l.SortOrder.Ascending}}return null};c.prototype._getFilterOperatorMatchingPropertySortOrder=function(e,t){var r;switch(this._getEffectiveSortOrder(e)){case l.SortOrder.Ascending:if(t){r=s.GE}else{r=s.GT}break;case l.SortOrder.Descending:if(t){r=s.LE}else{r=s.LT}break;default:r=s.GT}return r};c.prototype._convertDeprecatedFilterObjects=function(e){if(!e){return e}var t=sap.ui.require("sap/ui/model/odata/Filter");if(typeof t==="function"){for(var r=0,i=e.length;r<i;r++){if(e[r]instanceof t){e[r]=e[r].convert()}}}return e};c.prototype._getGroupIdFromContext=function(t,r){if(!t){return null}var i="/";var s=null;if(r>this.aAggregationLevel.length){e.sap.log.fatal("assertion failed: aggregation level deeper than number of current aggregation levels")}for(var n=0;n<r;n++){s=t.getProperty(this.aAggregationLevel[n]);if(s!=null){i+=encodeURIComponent(s)+"/"}else{i+="@/"}}return i};c.prototype._getGroupIdLevel=function(t){if(t==null){e.sap.log.fatal("assertion failed: no need to determine level of group ID = null");return-1}return t.split("/").length-2};c.prototype._getGroupIdComponents=function(e){if(e==null){return null}var t=e.split("/");var r=[];for(var i=1;i<t.length-1;i++){if(t[i]=="@"){r[i-1]=null}else{r[i-1]=decodeURIComponent(t[i])}}return r};c.prototype._getGroupIdAncestors=function(t,r){if(!r){return[]}if(t==null){e.sap.log.fatal("group ID null does not have ancestors");return[]}if(t=="/"){if(Math.abs(r)==1){return[null]}else{e.sap.log.fatal("invalid level count "+r+" for ancestors of groupId "+t);return[]}}var i=t.split("/");var s=[],n="";var a=0,o=i.length-3;if(r>0){if(r-1>o){e.sap.log.fatal("invalid level count "+r+" for ancestors of groupId "+t)}else{o=r-1}}else if(-(r+1)>o){e.sap.log.fatal("invalid level count "+r+" for ancestors of groupId "+t)}else{a=o+1+r;for(var u=0;u<a;u++){n+=i[u]+"/"}}for(var l=a;l<=o;l++){n+=i[l]+"/";s.push(n)}return s};c.prototype._getParentGroupId=function(e){return this._getGroupIdAncestors(e,-1)[0]};c.prototype._removeDuplicatesFromStringArray=function(e){var t={};for(var r=0;r<e.length;r++){t[e[r]]=true}var i=[];for(var s in t){i.push(s)}return i};c.prototype._getIdForNewRequestHandle=function(){if(this.oPendingRequestHandle===undefined){this.oPendingRequestHandle=[]}for(var e=0;e<this.oPendingRequestHandle.length;e++){if(this.oPendingRequestHandle[e]===undefined){return e}}this.oPendingRequestHandle[this.oPendingRequestHandle.length]=undefined;return this.oPendingRequestHandle.length-1};c.prototype._registerNewRequestHandle=function(t,r){if(this.oPendingRequestHandle[t]!==undefined){e.sap.log.fatal("request handle ID already in use")}this.oPendingRequestHandle[t]=r};c.prototype._deregisterHandleOfCompletedRequest=function(t){if(e.isEmptyObject(this.oPendingRequestHandle)){e.sap.log.warning("No request handles to be cleared. Previous abort/resetData?");return}if(this.oPendingRequestHandle[t]===undefined){e.sap.log.fatal("no handle found for this request ID")}this.oPendingRequestHandle[t]=undefined};c.prototype._abortAllPendingRequestsByHandle=function(){for(var e=0;e<this.oPendingRequestHandle.length;e++){if(this.oPendingRequestHandle[e]){if(this.oPendingRequestHandle[e]!==undefined){this.oPendingRequestHandle[e].abort()}}}this.oPendingRequestHandle=[]};c.prototype._getRequestId=function(t,r){switch(t){case c._requestType.groupMembersQuery:if(r.groupId===undefined){e.sap.log.fatal("missing group ID")}return c._requestType.groupMembersQuery+(r.groupId==null?"":r.groupId);case c._requestType.levelMembersQuery:if(r.level===undefined){e.sap.log.fatal("missing level")}if(r.groupId===undefined){e.sap.log.fatal("missing groupId")}return""+c._requestType.levelMembersQuery+r.level+(r.tupleIndex?"-"+r.tupleIndex:"");case c._requestType.totalSizeQuery:return c._requestType.totalSizeQuery;case c._requestType.reloadMeasuresQuery:if(!r.multiUnitEntryKey){e.sap.log.fatal("missing multi unit entry key")}return c._requestType.reloadMeasuresQuery+r.multiUnitEntryKey;default:e.sap.log.fatal("invalid request type "+t);return-1}};c.prototype._registerNewRequest=function(t){if(t==undefined||t==""){e.sap.log.fatal("missing request ID");return}if(!this.oPendingRequests[t]){this.oPendingRequests[t]=1}else{++this.oPendingRequests[t]}};c.prototype._considerRequestGrouping=function(e){for(var t=-1,r;(r=e[++t])!==undefined;){if(this.oGroupedRequests[r]===undefined){this.oGroupedRequests[r]={}}var i=this.oGroupedRequests[r];for(var s=0;s<e.length;s++){i[e[s]]=true}}};c.prototype._isRequestPending=function(e){return this.oPendingRequests[e]!=undefined&&this.oPendingRequests[e]>0};c.prototype._deregisterCompletedRequest=function(t){if(e.isEmptyObject(this.oPendingRequests)){e.sap.log.warning("There are no pending requests which could be set to 'completed'.");return}if(!this.oPendingRequests[t]){e.sap.log.fatal("assertion failed: there is no pending request ID "+t)}if(this.oPendingRequests[t]==1){delete this.oPendingRequests[t]}else{--this.oPendingRequests[t]}};c.prototype._cleanupGroupingForCompletedRequest=function(e){if(this._isRequestPending(e)){return false}var t=true;if(this.oGroupedRequests[e]!=undefined){for(var r in this.oGroupedRequests[e]){if(this.oPendingRequests[r]){t=false;break}}}if(t){var i=this.oGroupedRequests[e];delete this.oGroupedRequests[e];for(var s in i){if(s!=e){this._cleanupGroupingForCompletedRequest(s)}}}return t};c.prototype._getKeyIndexMapping=function(t,r){var i=this.mKeyIndex[t];var s=this.mServiceKey[t];var n=r;if(i!==undefined){var a=r;if(a>0){while(--a>0){if(i[a]!==undefined){break}}}var o;if(a==0){o=0}else{if(i[a]>=0){o=i[a]}else if(i[a+1]===undefined){o=i[a]=="ZERO"?0:-i[a];while(s[o+1]!==undefined){++o}}else{o=Math.abs(i[a+1])-1}if(s[o]===undefined){e.sap.log.fatal("assertion failed: no service key at iLastOccupiedServiceKeyIndex = "+o)}}var u=r-a;n=o+u}var l={sGroupId:t,iIndex:r,iServiceKeyIndex:n};return l};c.prototype._moveKeyIndexMapping=function(e,t){return this._getKeyIndexMapping(e.sGroupId,e.iIndex+t)};c.prototype._getKey=function(t,r){var i=this.mKeyIndex[t][r];if(i===undefined){return undefined}if(i>=0){return this.mServiceKey[t][i]}if(this.mMultiUnitKey[t]===undefined){e.sap.log.fatal("assertion failed: missing expected multi currency key for group with ID "+t);return null}var s=this.mMultiUnitKey[t][r];if(s===undefined){e.sap.log.fatal("assertion failed: missing expected multi currency key for group with ID "+t+" at pos "+r);return null}return s};c.prototype._getKeys=function(e){if(this.mKeyIndex[e]===undefined){return undefined}var t=this;return function(r){return t._getKey(e,r)}};c.prototype._getServiceKeys=function(e,t){var r=this.mKeyIndex[e];if(r===undefined){return undefined}var i=this.mServiceKey[e],s=r[t];if(s===undefined){return undefined}if(s>=0){return[i[s]]}var n=[];if(r[t+1]===undefined){s=r[t]=="ZERO"?0:-r[t];while(i[s]!==undefined){n.push(i[s++])}}else{s=r[t]=="ZERO"?0:-r[t];for(var a=s,o=Math.abs(r[t+1]);a<o;a++){n.push(i[a])}}return n};c.prototype._getKeyCount=function(e){if(this.mKeyIndex[e]===undefined){return undefined}return this.mKeyIndex[e].length};c.prototype._findKeyIndex=function(e,t){var r=this.mKeyIndex[e];var i=this.mServiceKey[e];var s=this.mMultiUnitKey[e];for(var n=0;n<this.mLength[e];n++){if(r[n]<0){if(s[n]==t){return n}}else if(i[r[n]]==t){return n}}return-1};c.prototype._setServiceKey=function(e,t){if(!this.mServiceKey[e.sGroupId]){this.mServiceKey[e.sGroupId]=[]}if(!this.mKeyIndex[e.sGroupId]){this.mKeyIndex[e.sGroupId]=[]}var r=this.mServiceKey[e.sGroupId][e.iServiceKeyIndex]===undefined;this.mServiceKey[e.sGroupId][e.iServiceKeyIndex++]=t;this.mKeyIndex[e.sGroupId][e.iIndex++]=e.iServiceKeyIndex-1;return r};c.prototype._setAdjacentMultiUnitKeys=function(e,t,r){if(!this.mServiceKey[e.sGroupId]){this.mServiceKey[e.sGroupId]=[]}if(!this.mKeyIndex[e.sGroupId]){this.mKeyIndex[e.sGroupId]=[]}if(!this.mMultiUnitKey[e.sGroupId]){this.mMultiUnitKey[e.sGroupId]=[]}--e.iIndex;--e.iServiceKeyIndex;this.mMultiUnitKey[e.sGroupId][e.iIndex]=this.oModel._getKey(t.oEntry);this.mKeyIndex[e.sGroupId][e.iIndex++]=e.iServiceKeyIndex>0?-e.iServiceKeyIndex:"ZERO";var i=0;for(var s=0;s<r.length;s++){if(!this.mServiceKey[e.sGroupId][e.iServiceKeyIndex]){++i}this.mServiceKey[e.sGroupId][e.iServiceKeyIndex++]=this.oModel._getKey(r[s])}return i};c.prototype._mergeLoadedKeyIndexWithSubsequentIndexes=function(t,r,i,s){var n=this.mKeyIndex[t.sGroupId],a=this.mServiceKey[t.sGroupId],o=this.mMultiUnitKey[t.sGroupId],u=0,l=t.iServiceKeyIndex,d=t.iIndex;var p,h;if(n===undefined){return u}var f=false;var g=a[l-1],y=a[l];if(y===undefined){return u}if(g===undefined){e.sap.log.fatal("assertion failed: missing expected entry before given key index");return u}var c=this.oModel.getObject("/"+g);var v=this.oModel.getObject("/"+y);var m="",_="";for(var I=0;I<r.length;I++){m+=c[r[I]]+"|";_+=v[r[I]]+"|"}f=m==_;var R=d;if(R>=this.mLength[t.sGroupId]){e.sap.log.fatal("assertion failed: service key exists,but no corresponding key index found");return u}while(n[R]===undefined||Math.abs(n[R])<l){++R}if(f){if(Math.abs(n[R])==l&&n[R]<0){if(R>d){if(n[d-1]<0){o[R]=undefined;n.splice(d,R-d+1);o.splice(d,R-d+1)}else{n[d-1]=-n[d-1];o[d-1]=o[R];o[R]=undefined;n.splice(d,R-d+1);o.splice(d,R-d+1);u=1}}}else if(Math.abs(n[R])>l){var M=R-1;if(n[M]>0){p=this._createMultiUnitRepresentativeEntry(t.sGroupId,c,i,undefined,s);h=this.oModel._getKey(p.oEntry);n[M]=-n[M];o[M]=h;if(M>d){n.splice(d,M-d);o.splice(d,M-d)}if(p.bIsNewEntry){u=1}else{u=0}}else if(n[d-1]<0){if(R>d){o[M]=undefined;n.splice(d,M-d+1);o.splice(d,M-d+1)}}else{n[d-1]=-n[d-1];o[d-1]=o[M];o[M]=undefined;n.splice(d,M-d+1);o.splice(d,M-d+1)}}else if(n[R]==l){if(R>d){if(n[d-1]<0){n.splice(d,R-d+1);o.splice(d,R-d+1);u=1}else{p=this._createMultiUnitRepresentativeEntry(t.sGroupId,c,i,undefined,s);h=this.oModel._getKey(p.oEntry);if(!p.bIsNewEntry){e.sap.log.fatal("assertion failed: multi-unit entry already existed before")}n[d-1]=-n[d-1];o[d-1]=h;n.splice(d,R-d+1);o.splice(d,R-d+1);u=1}}}else{e.sap.log.fatal("assertion failed: uncovered case detected");return u}}else if(n[R]>l){e.sap.log.fatal("unstable query result for group ID "+t.sGroupId+": entries have been removed or added. Complete reload required")}else if(R-d>0){n.splice(d,R-d);o.splice(d,R-d)}return u};c.prototype._createMultiUnitRepresentativeEntry=function(t,r,i,s,n){var a=e.extend(true,{},r);var o=[];for(var u in this.oMeasureDetailsSet){var l=this.oMeasureDetailsSet[u];if(!n&&!this.mAnalyticalInfoByProperty[u].total){if(l.rawValuePropertyName!=undefined){a[l.rawValuePropertyName]=undefined}if(l.formattedValuePropertyName!=undefined){a[l.formattedValuePropertyName]=undefined}}else{if(l.rawValuePropertyName!=undefined){a[l.rawValuePropertyName]=null}if(l.formattedValuePropertyName!=undefined){a[l.formattedValuePropertyName]="*"}}if(s){if(!l.unitPropertyName||e.inArray(l.unitPropertyName,s)==-1){o.push(l.rawValuePropertyName)}}}for(var d=0;d<i.length;d++){if(e.inArray(i[d],s)!=-1){a[i[d]]="*"}}var p="";for(var h=0;h<this.aAllDimensionSortedByName.length;h++){var f=a[this.aAllDimensionSortedByName[h]];var g=f===""?'""':f;g=g===undefined?"":g;p+=encodeURIComponent(g)+","}p+="-multiple-units-not-dereferencable";var y;if(this.mMultiUnitKey[t]&&(y=e.inArray(p,this.mMultiUnitKey[t]))!=-1){return{oEntry:this.oModel.getObject("/"+p),bIsNewEntry:false,iIndex:y,aReloadMeasurePropertyName:o}}a.__metadata.uri=p;delete a.__metadata["self"];delete a.__metadata["self_link_extensions"];a["^~volatile"]=true;this.oModel._importData(a,{},{});var c=this.oModel._getKey(a);this.oModel.getContext("/"+c)["_volatile"]=true;return{oEntry:a,bIsNewEntry:true,aReloadMeasurePropertyName:o}};c.prototype._clearAllPendingRequests=function(){this.oPendingRequests={};this.oGroupedRequests={}};c.prototype.resetData=function(e){var t=e?e.getPath():undefined;this._resetData(t)};c.prototype._resetData=function(e){if(e){delete this.mServiceKey[e];delete this.mServiceLength[e];delete this.mServiceFinalLength[e];delete this.mKeyIndex[e];delete this.mLength[e];delete this.mMultiUnitKey[e];delete this.mEntityKey[e]}else{this.mServiceKey={};this.mServiceLength={};this.mServiceFinalLength={};this.mFinalLength=this.mServiceFinalLength;this.mKeyIndex={};this.mLength={};this.mMultiUnitKey={};this.mEntityKey={}}};c.prototype.refresh=function(e){c.prototype._refresh.apply(this,arguments)};c.prototype._refresh=function(t,i,s){var n=false;if(!t){if(s){var a=this.oModel.resolve(this.sPath,this.oContext);var o=this.oModel.oMetadata._getEntityTypeByPath(a);if(o&&o.entityType in s){n=true}}if(i&&!n){e.each(this.mServiceKey,function(t,r){e.each(r,function(e,t){if(t in i){n=true;return false}});if(n){return false}})}if(!i&&!s){n=true}}if(t||n){this._abortAllPendingRequests();this.resetData();this.bNeedsUpdate=false;this._fireRefresh({reason:r.Refresh})}};c.prototype.checkUpdate=function(t,i){var s=false;if(!t){if(this.bNeedsUpdate||!i){s=true}else{e.each(this.mServiceKey,function(t,r){e.each(r,function(e,t){if(t in i){s=true;return false}});if(s){return false}})}}if(t||s){this.bNeedsUpdate=false;this._fireChange({reason:r.Change})}};c.prototype.getDownloadUrl=function(e){var t,r,i;var s=new l.QueryResultRequest(this.oAnalyticalQueryResult);s.setResourcePath(this._getResourcePath());var n=[];var a=[];for(var o in this.oDimensionDetailsSet){n.push(o)}s.setAggregationLevel(n);for(var u in this.oDimensionDetailsSet){var d=this.oDimensionDetailsSet[u];var p=d.textPropertyName!=undefined;s.includeDimensionKeyTextAttributes(d.name,true,p,d.aAttributeName)}for(var h in this.oMeasureDetailsSet){a.push(h)}s.setMeasures(a);for(var f in this.oMeasureDetailsSet){var g=this.oMeasureDetailsSet[f];var y=g.rawValuePropertyName!=undefined;var c=g.formattedValuePropertyName!=undefined;var v=g.unitPropertyName!=undefined;s.includeMeasureRawFormattedValueUnit(g.name,y,c,v)}var m=s.getSortExpression();m.clear();for(var _=0;_<this.aSorter.length;_++){if(this.aSorter[_]){m.addSorter(this.aSorter[_].sPath,this.aSorter[_].bDescending?l.SortOrder.Descending:l.SortOrder.Ascending)}}var I=s.getFilterExpression();I.clear();if(this.aApplicationFilter){I.addUI5FilterConditions(this.aApplicationFilter)}if(this.aControlFilter){I.addUI5FilterConditions(this.aControlFilter)}var R=s.getURIToQueryResultEntitySet();var M=this._getQueryODataRequestOptions(s,true);if(!M){return undefined}var q=[];for(var b=0,x=this.aAnalyticalInfo.length;b<x;b++){var A=this.aAnalyticalInfo[b];if((A.visible||A.inResult)&&A.name!==""&&A.name!==q[q.length-1]){q.push(A.name);if(this.oMeasureDetailsSet[A.name]!=undefined&&this.oMeasureDetailsSet[A.name].unitPropertyName!=undefined){q.push(this.oMeasureDetailsSet[A.name].unitPropertyName)}}}for(var S=0,P=M.length;S<P;S++){if(/^\$select/i.test(M[S])){if(this.mParameters.select){t=M[S].slice(8).split(",");for(i=0;i<t.length;i++){r=t[i];if(q.indexOf(r)===-1){q.push(r)}}}M[S]="$select="+q.join(",");break}}if(e){M.splice(0,0,"$format="+encodeURIComponent(e))}if(this.sCustomParams){M.push(this.sCustomParams)}if(R){return this.oModel._createRequestUrl(R,null,M).replace(/ /g,"%20")}};c.prototype._addSorters=function(e,t){var r=this._canApplySortersToGroups()?[].concat(this.aSorter).concat(t):[].concat(t).concat(this.aSorter);r.forEach(function(t){e.addSorter(t.sPath,t.bDescending?l.SortOrder.Descending:l.SortOrder.Ascending)})};c.prototype._canApplySortersToGroups=function(){var t=this._autoExpandMode;if(this.bApplySortersToGroups){if(this.aSorter.length>0){if(t!==this.sLastAutoExpandMode&&t!==u.Sequential){e.sap.log.warning("Applying sorters to groups is only possible with auto"+" expand mode 'Sequential'; current mode is: "+t,this.sPath,h)}this.sLastAutoExpandMode=t}return t===u.Sequential}return false};c.prototype._warnNoSortingOfGroups=function(t){var r;if(this.bApplySortersToGroups){r="Detected a multi-unit case, so sorting is only possible on leaves";if(t){r+="; "+t}e.sap.log.warning(r,this.sPath,h)}this.bApplySortersToGroups=false};return c});