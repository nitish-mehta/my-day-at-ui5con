/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/BindingMode","sap/ui/model/Context","sap/ui/model/Model","./ODataUtils","./CountMode","./ODataContextBinding","./ODataListBinding","./ODataMetadata","./ODataPropertyBinding","./ODataTreeBinding","sap/ui/model/odata/ODataMetaModel","sap/ui/thirdparty/URI","sap/ui/thirdparty/datajs"],function(e,t,a,s,i,r,n,o,h,d,u,c,f,l){"use strict";var p=s.extend("sap.ui.model.odata.ODataModel",{constructor:function(e,a,n,o,d,u,c,f){s.apply(this,arguments);var y,_,g,v=null,m,b,M,R,T,C,U=this;if(typeof e==="object"){a=e;e=a.serviceUrl}if(typeof a==="object"){n=a.user;o=a.password;d=a.headers;u=a.tokenHandling;f=a.loadMetadataAsync;c=a.withCredentials;g=a.maxDataServiceVersion;y=a.useBatch;_=a.refreshAfterChange;v=a.annotationURI;m=a.loadAnnotationsJoined;M=a.defaultCountMode;b=a.metadataNamespaces;R=a.serviceUrlParams;T=a.metadataUrlParams;C=a.skipMetadataAnnotationParsing;a=a.json}this.oServiceData={};this.sDefaultBindingMode=t.OneWay;this.mSupportedBindingModes={OneWay:true,OneTime:true,TwoWay:true};this.mUnsupportedFilterOperators={Any:true,All:true};this.bCountSupported=true;this.bJSON=a;this.bCache=true;this.aPendingRequestHandles=[];this.oRequestQueue={};this.aBatchOperations=[];this.oHandler;this.bTokenHandling=u!==false;this.bWithCredentials=c===true;this.bUseBatch=y===true;this.bRefreshAfterChange=_!==false;this.sMaxDataServiceVersion=g;this.bLoadMetadataAsync=!!f;this.bLoadAnnotationsJoined=m===undefined?true:m;this.sAnnotationURI=v;this.sDefaultCountMode=M||r.Both;this.oMetadataLoadEvent=null;this.oMetadataFailedEvent=null;this.bSkipMetadataAnnotationParsing=C;this.oHeaders={};this.setHeaders(d);this.oData={};this.oMetadata=null;this.oAnnotations=null;this.aUrlParams=[];if(e.indexOf("?")==-1){this.sServiceUrl=e}else{var A=e.split("?");this.sServiceUrl=A[0];if(A[1]){this.aUrlParams.push(A[1])}}if(sap.ui.getCore().getConfiguration().getStatistics()){this.aUrlParams.push("sap-statistics=true")}this.sServiceUrl=this.sServiceUrl.replace(/\/$/,"");var q=this._createRequestUrl("$metadata",undefined,T);if(!p.mServiceData[q]){p.mServiceData[q]={}}this.oServiceData=p.mServiceData[q];if(this.bTokenHandling&&this.oServiceData.securityToken){this.oHeaders["x-csrf-token"]=this.oServiceData.securityToken}this.sUser=n;this.sPassword=o;this.oHeaders["Accept-Language"]=sap.ui.getCore().getConfiguration().getLanguageTag();if(!this.oServiceData.oMetadata){this.oServiceData.oMetadata=new h(q,{async:this.bLoadMetadataAsync,user:this.sUser,password:this.sPassword,headers:this.mCustomHeaders,namespaces:b,withCredentials:this.bWithCredentials})}this.oMetadata=this.oServiceData.oMetadata;this.pAnnotationsLoaded=this.oMetadata.loaded();if(this.sAnnotationURI||!this.bSkipMetadataAnnotationParsing){var E=this._getAnnotationParser();if(!this.bSkipMetadataAnnotationParsing){if(!this.bLoadMetadataAsync){this.addAnnotationXML(this.oMetadata.sMetadataBody,!!this.sAnnotationURI)}else{this.pAnnotationsLoaded=this.oMetadata.loaded().then(function(e,t){if(this.bDestroyed){return Promise.reject()}return this.addAnnotationXML(t["metadataString"],e)}.bind(this,!!this.sAnnotationURI))}}if(this.sAnnotationURI){if(this.bLoadMetadataAsync){this.pAnnotationsLoaded=this.pAnnotationsLoaded.then(E.addUrl.bind(E,this.sAnnotationURI))}else{this.pAnnotationsLoaded=Promise.all([this.pAnnotationsLoaded,E.addUrl(this.sAnnotationURI)])}}}if(R){this.aUrlParams=this.aUrlParams.concat(i._createUrlParamsArray(R))}this.onMetadataLoaded=function(e){U._initializeMetadata();U.initialize()};this.onMetadataFailed=function(e){U.fireMetadataFailed(e.getParameters())};if(!this.oMetadata.isLoaded()){this.oMetadata.attachLoaded(this.onMetadataLoaded);this.oMetadata.attachFailed(this.onMetadataFailed)}if(this.oMetadata.isFailed()){this.refreshMetadata()}if(this.oMetadata.isLoaded()){this._initializeMetadata(true)}if(this.bJSON){if(this.sMaxDataServiceVersion==="3.0"){this.oHeaders["Accept"]="application/json;odata=fullmetadata"}else{this.oHeaders["Accept"]="application/json"}this.oHandler=l.jsonHandler}else{this.oHeaders["Accept"]="application/atom+xml,application/atomsvc+xml,application/xml";this.oHandler=l.atomHandler}this.oHeaders["MaxDataServiceVersion"]="2.0";if(this.sMaxDataServiceVersion){this.oHeaders["MaxDataServiceVersion"]=this.sMaxDataServiceVersion}this.oHeaders["DataServiceVersion"]="2.0"},metadata:{publicMethods:["create","remove","update","submitChanges","getServiceMetadata","read","hasPendingChanges","refresh","refreshMetadata","resetChanges","isCountSupported","setCountSupported","setDefaultCountMode","getDefaultCountMode","forceNoCache","setProperty","getSecurityToken","refreshSecurityToken","setHeaders","getHeaders","setUseBatch"]}});p.M_EVENTS={RejectChange:"rejectChange",MetadataLoaded:"metadataLoaded",MetadataFailed:"metadataFailed",AnnotationsLoaded:"annotationsLoaded",AnnotationsFailed:"annotationsFailed"};p.mServiceData={};p.prototype.fireRejectChange=function(e){this.fireEvent("rejectChange",e);return this};p.prototype.attachRejectChange=function(e,t,a){this.attachEvent("rejectChange",e,t,a);return this};p.prototype.detachRejectChange=function(e,t){this.detachEvent("rejectChange",e,t);return this};p.prototype._initializeMetadata=function(t){var a=this;this.bUseBatch=this.bUseBatch||this.oMetadata.getUseBatch();var s=function(t){if(!!t){a.metadataLoadEvent=e.sap.delayedCall(0,a,s)}else{if(a.oMetadata){a.fireMetadataLoaded({metadata:a.oMetadata});e.sap.log.debug("ODataModel fired metadataloaded")}}};if(this.sAnnotationURI&&this.bLoadAnnotationsJoined){if(this.oAnnotations&&(this.oAnnotations.bInitialized||this.oAnnotations.isFailed())){s(!this.bLoadMetadataAsync)}else{this.oAnnotations.attachEventOnce("loaded",function(){s(true)})}}else{s(t)}};p.prototype.fireAnnotationsLoaded=function(e){if(!this.bLoadMetadataAsync){setTimeout(this.fireEvent.bind(this,"annotationsLoaded",e),0)}else{this.fireEvent("annotationsLoaded",e)}return this};p.prototype.attachAnnotationsLoaded=function(e,t,a){this.attachEvent("annotationsLoaded",e,t,a);return this};p.prototype.detachAnnotationsLoaded=function(e,t){this.detachEvent("annotationsLoaded",e,t);return this};p.prototype.fireAnnotationsFailed=function(t){if(!this.bLoadMetadataAsync){setTimeout(this.fireEvent.bind(this,"annotationsFailed",t),0)}else{this.fireEvent("annotationsFailed",t)}e.sap.log.debug("ODataModel fired annotationsfailed");return this};p.prototype.attachAnnotationsFailed=function(e,t,a){this.attachEvent("annotationsFailed",e,t,a);return this};p.prototype.detachAnnotationsFailed=function(e,t){this.detachEvent("annotationsFailed",e,t);return this};p.prototype.fireMetadataLoaded=function(e){this.fireEvent("metadataLoaded",e);return this};p.prototype.attachMetadataLoaded=function(e,t,a){this.attachEvent("metadataLoaded",e,t,a);return this};p.prototype.detachMetadataLoaded=function(e,t){this.detachEvent("metadataLoaded",e,t);return this};p.prototype.fireMetadataFailed=function(e){this.fireEvent("metadataFailed",e);return this};p.prototype.attachMetadataFailed=function(e,t,a){this.attachEvent("metadataFailed",e,t,a);return this};p.prototype.detachMetadataFailed=function(e,t){this.detachEvent("metadataFailed",e,t);return this};p.prototype.refreshMetadata=function(){if(this.oMetadata&&this.oMetadata.refresh){this.oMetadata.refresh()}};p.prototype._createRequestUrl=function(t,a,s,r,n){var o,h,d,u="";if(t&&t.indexOf("?")!=-1){d=t.substr(t.indexOf("?")+1);t=t.substr(0,t.indexOf("?"))}h=this._normalizePath(t,a);if(!r){u=this.sServiceUrl+h}else{u=h.substr(h.indexOf("/")+1)}o=i._createUrlParamsArray(s);if(this.aUrlParams){o=o.concat(this.aUrlParams)}if(d){o.push(d)}if(o.length>0){u+="?"+o.join("&")}if(n===undefined){n=true}if(n===false){var c=e.now();var f=u.replace(/([?&])_=[^&]*/,"$1_="+c);u=f+(f===u?(/\?/.test(u)?"&":"?")+"_="+c:"")}return u};p.prototype._loadData=function(t,a,s,i,r,n,o){var h,d,u=this;function c(t,a){var i=t,r={};if(a.statusCode==204){if(s){s(null)}if(o){o(null)}u.fireRequestCompleted({url:d.requestUri,type:"GET",async:d.async,info:"Accept headers:"+u.oHeaders["Accept"],infoObject:{acceptHeaders:u.oHeaders["Accept"]},success:true});return}if(!i){e.sap.log.fatal("The following problem occurred: No data was retrieved by service: "+a.requestUri);u.fireRequestCompleted({url:d.requestUri,type:"GET",async:d.async,info:"Accept headers:"+u.oHeaders["Accept"],infoObject:{acceptHeaders:u.oHeaders["Accept"]},success:false});return false}if(u.bUseBatch){var n=u._getBatchErrors(t);if(n.length>0){p(n[0]);return false}if(i.__batchResponses&&i.__batchResponses.length>0){i=i.__batchResponses[0].data}else{e.sap.log.fatal("The following problem occurred: No data was retrieved by service: "+a.requestUri)}}_=_.concat(i.results);if(i.__next){var h=new f(i.__next);d.requestUri=h.absoluteTo(a.requestUri).toString();y(d)}else{e.sap.extend(i.results,_);if(i.results&&!Array.isArray(i.results)){i=i.results}u._importData(i,r);if(u.sChangeKey&&r){var c=u.sChangeKey.substr(u.sChangeKey.lastIndexOf("/")+1);if(r[c]){delete u.oRequestQueue[u.sChangeKey];u.sChangeKey=null}}if(s){s(i)}u.checkUpdate(false,false,r);if(o){o(i)}u.fireRequestCompleted({url:d.requestUri,type:"GET",async:d.async,info:"Accept headers:"+u.oHeaders["Accept"],infoObject:{acceptHeaders:u.oHeaders["Accept"]},success:true})}}function p(e){if(u.bTokenHandling&&e.response){var t=u._getHeader("x-csrf-token",e.response.headers);if(!d.bTokenReset&&e.response.statusCode=="403"&&t&&t.toLowerCase()=="required"){u.resetSecurityToken();d.bTokenReset=true;y();return}}var a=u._handleError(e);if(i){i(e,h&&h.bAborted)}u.fireRequestCompleted({url:d.requestUri,type:"GET",async:d.async,info:"Accept headers:"+u.oHeaders["Accept"],infoObject:{acceptHeaders:u.oHeaders["Accept"]},success:false,errorobject:a});if(!h||!h.bAborted){a.url=d.requestUri;u.fireRequestFailed(a)}}function y(){if(u.bUseBatch){u.updateSecurityToken();var e=f.parse(d.requestUri).query;var a=u._createRequestUrl(t,null,e,u.bUseBatch);d=u._createRequest(a,"GET",true);var s=u._createBatchRequest([d],true);h=u._request(s,c,p,l.batchHandler,undefined,u.getServiceMetadata())}else{h=u._request(d,c,p,u.oHandler,undefined,u.getServiceMetadata())}if(n){var i={abort:function(){h.bAborted=true;h.abort()}};n(i)}}var _=[];var g=this._createRequestUrl(t,null,a,null,r||this.bCache);d=this._createRequest(g,"GET",true);this.fireRequestSent({url:d.requestUri,type:"GET",async:d.async,info:"Accept headers:"+this.oHeaders["Accept"],infoObject:{acceptHeaders:this.oHeaders["Accept"]}});y()};p.prototype._importData=function(t,a){var s=this,i,r,n,o;if(t.results){i=[];e.each(t.results,function(e,t){i.push(s._importData(t,a))});return i}else{r=this._getKey(t);o=this.oData[r];if(!o){o=t;this.oData[r]=o}e.each(t,function(e,t){if(t&&(t.__metadata&&t.__metadata.uri||t.results)&&!t.__deferred){n=s._importData(t,a);if(Array.isArray(n)){o[e]={__list:n}}else{o[e]={__ref:n}}}else if(!t||!t.__deferred){o[e]=t}});a[r]=true;return r}};p.prototype._removeReferences=function(t){var a=this,s;if(t.results){s=[];e.each(t.results,function(e,t){s.push(a._removeReferences(t))});return s}else{e.each(t,function(e,a){if(a){if(a["__ref"]||a["__list"]){delete t[e]}}});return t}};p.prototype._restoreReferences=function(t){var a=this,s,i=[];if(t.results){s=[];e.each(t.results,function(e,t){s.push(a._restoreReferences(t))});return s}else{e.each(t,function(s,r){if(r&&r["__ref"]){var n=a._getObject("/"+r["__ref"]);e.sap.assert(n,"ODataModel inconsistent: "+r["__ref"]+" not found!");if(n){delete r["__ref"];t[s]=n;a._restoreReferences(n)}}else if(r&&r["__list"]){e.each(r["__list"],function(t,s){var n=a._getObject("/"+r["__list"][t]);e.sap.assert(n,"ODataModel inconsistent: "+r["__list"][t]+" not found!");if(n){i.push(n);a._restoreReferences(n)}});delete r["__list"];r.results=i;i=[]}});return t}};p.prototype.removeData=function(){this.oData={}};p.prototype.initialize=function(){var t=this.aBindings.slice(0);e.each(t,function(e,t){t.initialize()})};p.prototype.refresh=function(e,t){if(t){this.removeData()}this._refresh(e)};p.prototype._refresh=function(t,a,s){var i=this.aBindings.slice(0);e.each(i,function(e,i){i.refresh(t,a,s)})};p.prototype.checkUpdate=function(t,a,s,i){if(a){if(!this.sUpdateTimer){this.sUpdateTimer=e.sap.delayedCall(0,this,function(){this.checkUpdate(t,false,s)})}return}if(this.sUpdateTimer){e.sap.clearDelayedCall(this.sUpdateTimer);this.sUpdateTimer=null}var r=this.aBindings.slice(0);e.each(r,function(e,a){if(!i||this.isMetaModelPath(a.getPath())){a.checkUpdate(t,s)}}.bind(this))};p.prototype.bindProperty=function(e,t,a){var s=new d(this,e,t,a);return s};p.prototype.bindList=function(e,t,a,s,i){var r=new o(this,e,t,a,s,i);return r};p.prototype.bindTree=function(e,t,a,s){var i=new u(this,e,t,a,s);return i};p.prototype.createBindingContext=function(t,a,s,i,r){var r=!!r,n=this.resolve(t,a);if(typeof a=="function"){i=a;a=null}if(typeof s=="function"){i=s;s=null}if(!n){if(i){i(null)}return null}var o=this._getObject(t,a),h,d,u=this;if(!r){r=this._isReloadNeeded(n,o,s)}if(!r){h=this._getKey(o);d=this.getContext("/"+h);if(i){i(d)}return d}if(i){var c=!e.sap.startsWith(t,"/");if(n){var f=[],l=this.createCustomParams(s);if(l){f.push(l)}this._loadData(n,f,function(e){h=e?u._getKey(e):undefined;if(h&&a&&c){var s=a.getPath();s=s.substr(1);if(u.oData[s]){u.oData[s][t]={__ref:h}}}d=u.getContext("/"+h);i(d)},function(){i(null)})}else{i(null)}}};p.prototype._isReloadNeeded=function(e,t,a){var s,i=[],r,n=[];if(!e){return false}if(!t){return true}if(a&&a["expand"]){s=a["expand"].replace(/\s/g,"");i=s.split(",")}if(i){for(var o=0;o<i.length;o++){var h=i[o].indexOf("/");if(h!==-1){var d=i[o].slice(0,h);var u=i[o].slice(h+1);i[o]=[d,u]}}}for(var o=0;o<i.length;o++){var c=i[o];if(Array.isArray(c)){var f=t[c[0]];var l=c[1];if(!f||f&&f.__deferred){return true}else{if(f){if(f.__list&&f.__list.length>0){for(var p=0;p<f.__list.length;p++){var y="/"+f.__list[p];var _=this.getObject(y);var g=this._isReloadNeeded(y,_,{expand:l});if(g){return true}}}else if(f.__ref){var y="/"+f.__ref;var _=this.getObject(y);var g=this._isReloadNeeded(y,_,{expand:l});if(g){return true}}}}}else{if(t[c]===undefined||t[c]&&t[c].__deferred){return true}}}if(a&&a["select"]){r=a["select"].replace(/\s/g,"");n=r.split(",")}for(var o=0;o<n.length;o++){if(t[n[o]]===undefined){return true}}if(n.length==0){var v=this.oMetadata._getEntityTypeByPath(e);if(!v){return false}else{for(var o=0;o<v.property.length;o++){if(t[v.property[o].name]===undefined){return true}}}}return false};p.prototype.destroyBindingContext=function(e){};p.prototype.createCustomParams=function(t){var a=[],s,i={expand:true,select:true};for(var r in t){if(r in i){a.push("$"+r+"="+e.sap.encodeURL(t[r]))}if(r=="custom"){s=t[r];for(var r in s){if(r.indexOf("$")==0){e.sap.log.warning("Trying to set OData parameter "+r+" as custom query option!")}else{a.push(r+"="+e.sap.encodeURL(s[r]))}}}}return a.join("&")};p.prototype.bindContext=function(e,t,a){var s=new n(this,e,t,a);return s};p.prototype.setCountSupported=function(e){this.bCountSupported=e};p.prototype.isCountSupported=function(){return this.bCountSupported};p.prototype.setDefaultCountMode=function(e){this.sDefaultCountMode=e};p.prototype.getDefaultCountMode=function(){return this.sDefaultCountMode};p.prototype._getKey=function(e,t){var s,i;if(e instanceof a){s=e.getPath().substr(1)}else if(e&&e.__metadata&&e.__metadata.uri){i=e.__metadata.uri;s=i.substr(i.lastIndexOf("/")+1)}if(t){s=decodeURIComponent(s)}return s};p.prototype.getKey=function(e,t){return this._getKey(e,t)};p.prototype.createKey=function(t,a,s){var r=this.oMetadata._getEntityTypeByPath(t),n=t,o=this,h,d,u;e.sap.assert(r,'Could not find entity type of collection "'+t+'" in service metadata!');n+="(";if(r.key.propertyRef.length==1){h=r.key.propertyRef[0].name;e.sap.assert(h in a,'Key property "'+h+'" is missing in object!');u=this.oMetadata._getPropertyMetadata(r,h);d=i.formatValue(a[h],u.type);n+=s?d:encodeURIComponent(d)}else{e.each(r.key.propertyRef,function(t,c){if(t>0){n+=","}h=c.name;e.sap.assert(h in a,'Key property "'+h+'" is missing in object!');u=o.oMetadata._getPropertyMetadata(r,h);d=i.formatValue(a[h],u.type);n+=h;n+="=";n+=s?d:encodeURIComponent(d)})}n+=")";return n};p.prototype.getProperty=function(t,a,s){var i=this._getObject(t,a);if(s==null||s==undefined){return i}if(!e.isPlainObject(i)){return i}i=e.sap.extend(true,{},i);if(s==true){return this._restoreReferences(i)}else{return this._removeReferences(i)}};p.prototype._getObject=function(e,t){var a=this.isLegacySyntax()?this.oData:null,s=this.resolve(e,t),i,r,n,o,h,d;if(this.oMetadata&&s&&s.indexOf("/#")>-1){if(this.isMetaModelPath(s)){i=s.indexOf("/##");d=this.getMetaModel();if(!this.bMetaModelLoaded){return null}r=s.substr(0,i);n=s.substr(i+3);o=d.getMetaContext(r);a=d.getProperty(n,o)}else{a=this.oMetadata._getAnnotation(s)}}else{if(t){h=t.getPath();h=h.substr(1);a=this.oData[h]}if(!e){return a}var u=e.split("/"),c=0;if(!u[0]){a=this.oData;c++}while(a&&u[c]){a=a[u[c]];if(a){if(a.__ref){a=this.oData[a.__ref]}else if(a.__list){a=a.__list}else if(a.__deferred){a=undefined}}c++}}return a};p.prototype.updateSecurityToken=function(){if(this.bTokenHandling){if(!this.oServiceData.securityToken){this.refreshSecurityToken()}if(this.bTokenHandling){this.oHeaders["x-csrf-token"]=this.oServiceData.securityToken}}};p.prototype.resetSecurityToken=function(){delete this.oServiceData.securityToken;delete this.oHeaders["x-csrf-token"]};p.prototype.getSecurityToken=function(){var e=this.oServiceData.securityToken;if(!e){this.refreshSecurityToken();e=this.oServiceData.securityToken}return e};p.prototype.refreshSecurityToken=function(e,t,a){var s=this,i,r;a=a===true;i=this._createRequestUrl("/");var n=this._createRequest(i,"GET",a);n.headers["x-csrf-token"]="Fetch";function o(t,a){if(a){r=s._getHeader("x-csrf-token",a.headers);if(r){s.oServiceData.securityToken=r;s.oHeaders["x-csrf-token"]=r}else{s.resetSecurityToken();s.bTokenHandling=false}}if(e){e(t,a)}}function h(e){s.resetSecurityToken();s.bTokenHandling=false;s._handleError(e);if(t){t(e)}}return this._request(n,o,h,undefined,undefined,this.getServiceMetadata())};p.prototype._submitRequest=function(t,a,s,i,r,n){var o=this,h,d={};function u(i,u){if(a&&r){var f=o._getBatchErrors(i);if(f.length>0){c(f[0]);return false}if(i.__batchResponses&&i.__batchResponses.length>0){h=i.__batchResponses[0].data;if(!h&&i.__batchResponses[0].__changeResponses){h=i.__batchResponses[0].__changeResponses[0].data}}i=h}if(n){if(i&&i.__batchResponses){e.each(i.__batchResponses,function(e,t){if(t&&t.data){o._importData(t.data,d)}})}}o._handleETag(t,u,a);o._updateRequestQueue(t,a);if(o._isRefreshNeeded(t,u)){o._refresh(false,t.keys,t.entityTypes)}if(s){s(i,u)}}function c(e){if(o.bTokenHandling&&e.response){var a=o._getHeader("x-csrf-token",e.response.headers);if(!t.bTokenReset&&e.response.statusCode=="403"&&a&&a.toLowerCase()=="required"){o.resetSecurityToken();t.bTokenReset=true;f();return}}o._handleError(e);if(i){i(e)}}function f(){if(o.bTokenHandling&&t.method!=="GET"){o.updateSecurityToken();if(o.bTokenHandling){t.headers["x-csrf-token"]=o.oServiceData.securityToken}}if(a){return o._request(t,u,c,l.batchHandler,undefined,o.getServiceMetadata())}else{return o._request(t,u,c,o.oHandler,undefined,o.getServiceMetadata())}}return f()};p.prototype._createBatchRequest=function(t,a){var s,i,r={},n={},o={},h={};n.__batchRequests=t;s=this.sServiceUrl+"/$batch";if(this.aUrlParams.length>0){s+="?"+this.aUrlParams.join("&")}e.extend(r,this.mCustomHeaders,this.oHeaders);delete r["Content-Type"];i={headers:r,requestUri:s,method:"POST",data:n,user:this.sUser,password:this.sPassword,async:a};if(a){i.withCredentials=this.bWithCredentials}e.each(t,function(t,a){if(a["__changeRequests"]){e.each(a["__changeRequests"],function(t,a){if(a.keys&&a.method!="POST"){e.each(a.keys,function(e,t){o[e]=t})}else if(a.entityTypes&&a.method=="POST"){e.each(a.entityTypes,function(e,t){h[e]=t})}})}});i.keys=o;i.entityTypes=h;return i};p.prototype._handleETag=function(t,a,s){var i,r,n,o,h,d;if(s){h=t.data.__batchRequests;d=a.data.__batchResponses;if(d&&h){for(var u=0;u<h.length;u++){n=h[u].__changeRequests;if(d[u]){o=d[u].__changeResponses;if(n&&o){for(var c=0;c<n.length;c++){if(n[c].method=="MERGE"||n[c].method=="PUT"){i=n[c].requestUri.replace(this.sServiceUrl+"/","");if(!e.sap.startsWith(i,"/")){i="/"+i}r=this._getObject(i);if(r&&r.__metadata&&o[c].headers&&o[c].headers.ETag){r.__metadata.etag=o[c].headers.ETag}}}}}else{e.sap.log.warning("could not update ETags for batch request: corresponding response for request missing")}}}else{e.sap.log.warning("could not update ETags for batch request: no batch responses/requests available")}}else{i=t.requestUri.replace(this.sServiceUrl+"/","");if(!e.sap.startsWith(i,"/")){i="/"+i}r=this._getObject(i);if(r&&r.__metadata&&a.headers.ETag){r.__metadata.etag=a.headers.ETag}}};p.prototype._handleBatchErrors=function(e,t){this._getBatchErrors(t);this._handleETag()};p.prototype._getBatchErrors=function(t){var a=[],s;e.each(t.__batchResponses,function(t,i){if(i.message){s="The following problem occurred: "+i.message;if(i.response){s+=i.response.statusCode+","+i.response.statusText+","+i.response.body}a.push(i);e.sap.log.fatal(s)}if(i.__changeResponses){e.each(i.__changeResponses,function(t,i){if(i.message){s="The following problem occurred: "+i.message;if(i.response){s+=i.response.statusCode+","+i.response.statusText+","+i.response.body}a.push(i);e.sap.log.fatal(s)}})}});return a};p.prototype._handleError=function(t){var a={},s;var i="The following problem occurred: "+t.message;a.message=t.message;if(t.response){if(this.bTokenHandling){s=this._getHeader("x-csrf-token",t.response.headers);if(t.response.statusCode=="403"&&s&&s.toLowerCase()=="required"){this.resetSecurityToken()}}i+=t.response.statusCode+","+t.response.statusText+","+t.response.body;a.statusCode=t.response.statusCode;a.statusText=t.response.statusText;a.responseText=t.response.body}e.sap.log.fatal(i);return a};p.prototype.getData=function(e,t,a){return this.getProperty(e,t,a)};p.prototype._getETag=function(e,t,a){var s,i,r;if(a){s=a}else{if(t&&t.__metadata){s=t.__metadata.etag}else if(e){i=e.replace(this.sServiceUrl+"/","");r=i.indexOf("?");if(r>-1){i=i.substr(0,r)}if(this.oData.hasOwnProperty(i)){s=this.getProperty("/"+i+"/__metadata/etag")}}}return s};p.prototype._createRequest=function(t,a,s,i,r){var n={},o;e.extend(n,this.mCustomHeaders,this.oHeaders);o=this._getETag(t,i,r);if(o&&a!="GET"){n["If-Match"]=o}if(this.bJSON&&a!="DELETE"&&this.sMaxDataServiceVersion==="2.0"){n["Content-Type"]="application/json"}if(a=="MERGE"&&!this.bUseBatch){n["x-http-method"]="MERGE";a="POST"}var h={headers:n,requestUri:t,method:a,user:this.sUser,password:this.sPassword,async:s};if(i){h.data=i}if(s){h.withCredentials=this.bWithCredentials}return h};p.prototype._isRefreshNeeded=function(t,a){var s=false,i,r=[],n=this;if(!this.bRefreshAfterChange){return s}if(t.data&&Array.isArray(t.data.__batchRequests)){if(a){r=n._getBatchErrors(a.data);e.each(r,function(e,t){if(t.response&&t.response.statusCode=="412"){i=t.response.statusCode;return false}});if(!!i){return false}}e.each(t.data.__batchRequests,function(t,a){if(Array.isArray(a.__changeRequests)){e.each(a.__changeRequests,function(e,t){s=s||n._isRefreshNeeded(t);return!s})}return!s})}else{if(t.method==="GET"){return false}else{if(a&&a.statusCode=="412"){s=false}else{s=true}}}return s};p.prototype.update=function(e,t,s){var i,r,n,o,h,d,u,c,f,l,p,y,_=false;if(s instanceof a||arguments.length>3){d=s;i=arguments[3];r=arguments[4];n=arguments[5]}else{d=s.context||s.oContext;i=s.success||s.fnSuccess;r=s.error||s.fnError;u=s.eTag||s.sETag;n=typeof s.merge=="undefined"?s.bMerge===true:s.merge===true;_=typeof s.async=="undefined"?s.bAsync===true:s.async===true;y=s.urlParameters}h=this._createRequestUrl(e,d,y,this.bUseBatch);if(n){o=this._createRequest(h,"MERGE",_,t,u)}else{o=this._createRequest(h,"PUT",_,t,u)}e=this._normalizePath(e,d);l=this._getObject(e);o.keys={};if(l){p=this._getKey(l);o.keys[p]=true}if(this.bUseBatch){f=this._createBatchRequest([{__changeRequests:[o]}],_);c=this._submitRequest(f,this.bUseBatch,i,r,true)}else{c=this._submitRequest(o,this.bUseBatch,i,r)}return c};p.prototype.create=function(e,t,s){var i,r,n,o,h,d,u,c,f=false,l;if(s&&typeof s=="object"&&!(s instanceof a)){d=s.context;u=s.success;l=s.urlParameters;c=s.error;f=s.async===true}else{d=s;u=arguments[3];c=arguments[4]}n=this._createRequestUrl(e,d,l,this.bUseBatch);i=this._createRequest(n,"POST",f,t);e=this._normalizePath(e,d);h=this.oMetadata._getEntityTypeByPath(e);i.entityTypes={};if(h){i.entityTypes[h.entityType]=true}if(this.bUseBatch){r=this._createBatchRequest([{__changeRequests:[i]}],f);o=this._submitRequest(r,this.bUseBatch,u,c,true)}else{o=this._submitRequest(i,this.bUseBatch,u,c)}return o};p.prototype.remove=function(e,t){var s,i,r,n,o,h,d,u,c,f,l,p,y,_,g=false,v=this;if(t instanceof a||arguments[2]){s=t;n=arguments[2];o=arguments[3]}else if(t){s=t.context||t.oContext;n=t.success||t.fnSuccess;o=t.error||t.fnError;u=t.eTag||t.sETag;f=t.payload||t.oPayload;g=typeof t.async=="undefined"?t.bAsync===true:t.async===true;_=t.urlParameters}l=function(e,t){i=d.substr(d.lastIndexOf("/")+1);if(i.indexOf("?")!=-1){i=i.substr(0,i.indexOf("?"))}delete v.oData[i];delete v.mContexts["/"+i];if(n){n(e,t)}};d=this._createRequestUrl(e,s,_,this.bUseBatch);h=this._createRequest(d,"DELETE",g,f,u);e=this._normalizePath(e,s);r=this._getObject(e);h.keys={};if(r){c=this._getKey(r);h.keys[c]=true}if(this.bUseBatch){p=this._createBatchRequest([{__changeRequests:[h]}],g);y=this._submitRequest(p,this.bUseBatch,l,o,true)}else{y=this._submitRequest(h,this.bUseBatch,l,o)}return y};p.prototype.callFunction=function(t,a){var s,r,n,o,h,d,u,c,l,p,y="GET",_={},g=this;if(a&&typeof a=="object"){y=a.method?a.method:y;d=a.urlParameters;u=a.context;c=a.success;l=a.error;p=a.async===true}else{y=a;d=arguments[2];u=arguments[3];c=arguments[4];l=arguments[5];p=arguments[6]===true}h=this.oMetadata._getFunctionImportMetadata(t,y);e.sap.assert(h,"Function "+t+" not found in the metadata !");if(h){n=this._createRequestUrl(t,u,null,this.bUseBatch);var v=f(n);if(h.parameter!=null){e.each(d,function(a,s){var r=h.parameter.filter(function(e){return e.name==a&&e.mode=="In"});if(r.length>0){var n=r[0];_[a]=i.formatValue(s,n.type)}else{e.sap.log.warning("Parameter "+a+" is not defined for function call "+t+"!")}})}if(y==="GET"){return g.read(t,u,_,true,c,l)}else{e.each(_,function(e,t){v.addQuery(e,t)});s=this._createRequest(v.toString(),y,p);if(this.bUseBatch){r=this._createBatchRequest([{__changeRequests:[s]}],p);o=this._submitRequest(r,this.bUseBatch,c,l,true)}else{o=this._submitRequest(s,this.bUseBatch,c,l)}return o}}};p.prototype.read=function(t,s){var r,n,o,h,d,u,c,f,l,p,y,_,g,v,m,b;if(s&&typeof s=="object"&&!(s instanceof a)){d=s.context;u=s.urlParameters;c=s.async!==false;f=s.success;l=s.error;p=s.filters;y=s.sorters}else{d=s;u=arguments[2];c=arguments[3]!==false;f=arguments[4];l=arguments[5]}c=c!==false;b=i._createUrlParamsArray(u);g=i.createSortParams(y);if(g){b.push(g)}if(p&&!this.oMetadata){e.sap.log.fatal("Tried to use filters in read method before metadata is available.")}else{m=this._normalizePath(t,d);v=this.oMetadata&&this.oMetadata._getEntityTypeByPath(m);_=i.createFilterParams(p,this.oMetadata,v);if(_){b.push(_)}}n=this._createRequestUrl(t,d,b,this.bUseBatch);r=this._createRequest(n,"GET",c);if(this.bUseBatch){h=this._createBatchRequest([r],c);o=this._submitRequest(h,this.bUseBatch,f,l,true)}else{o=this._submitRequest(r,this.bUseBatch,f,l)}return o};p.prototype.createBatchOperation=function(t,a,s,i){var r={},n,o,h,d;e.extend(r,this.mCustomHeaders,this.oHeaders);if(e.sap.startsWith(t,"/")){t=t.substr(1)}if(i){n=i.sETag}if(a!="GET"){n=this._getETag(t,s,n);if(n){r["If-Match"]=n}}if(this.bJSON){if(a!="DELETE"&&a!="GET"&&this.sMaxDataServiceVersion==="2.0"){r["Content-Type"]="application/json"}}else{r["Content-Type"]="application/atom+xml"}var u={requestUri:t,method:a.toUpperCase(),headers:r};if(s){u.data=s}if(a!="GET"&&a!="POST"){if(t&&t.indexOf("/")!=0){t="/"+t}o=this._getObject(t);if(o){h=this._getKey(o);u.keys={};u.keys[h]=true}}else if(a=="POST"){var c=t;if(t.indexOf("?")!=-1){c=t.substr(0,t.indexOf("?"))}d=this.oMetadata._getEntityTypeByPath(c);if(d){u.entityTypes={};u.entityTypes[d.entityType]=true}}return u};p.prototype.addBatchReadOperations=function(t){if(!Array.isArray(t)||t.length<=0){e.sap.log.warning("No array with batch operations provided!");return false}var a=this;e.each(t,function(t,s){if(s.method!="GET"){e.sap.log.warning("Batch operation should be a GET operation!");return false}a.aBatchOperations.push(s)})};p.prototype.addBatchChangeOperations=function(t){if(!Array.isArray(t)||t.length<=0){return false}e.each(t,function(t,a){if(a.method!="POST"&&a.method!="PUT"&&a.method!="MERGE"&&a.method!="DELETE"){e.sap.log.warning("Batch operation should be a POST/PUT/MERGE/DELETE operation!");return false}});this.aBatchOperations.push({__changeRequests:t})};p.prototype.clearBatch=function(){this.aBatchOperations=[]};p.prototype.submitBatch=function(t,a,s,i){var r,n,o=this;function h(e,a){if(t){t(e,a,o._getBatchErrors(e))}}if(!(typeof t=="function")){var d=s;var u=a;s=t;t=u;a=d}s=s!==false;if(this.aBatchOperations.length<=0){e.sap.log.warning("No batch operations in batch. No request will be triggered!");return false}r=this._createBatchRequest(this.aBatchOperations,s);n=this._submitRequest(r,true,h,a,false,i);this.clearBatch();return n};p.prototype.getServiceMetadata=function(){if(this.oMetadata&&this.oMetadata.isLoaded()){return this.oMetadata.getServiceMetadata()}};p.prototype.getServiceAnnotations=function(){if(this.oAnnotations&&this.oAnnotations.getAnnotationsData){return this.oAnnotations.getAnnotationsData()}};p.prototype.submitChanges=function(t,a,s){var i,r,n=this,o,h,d,u,c,f;if(this.sChangeKey){o=this.sChangeKey.replace(this.sServiceUrl,"");c=this._getObject(o);r=c;if(e.isPlainObject(c)){r=e.sap.extend(true,{},c);if(r.__metadata){d=r.__metadata.type;u=r.__metadata.etag;delete r.__metadata;if(d||u){r.__metadata={}}if(d){r.__metadata.type=d}if(!!u){r.__metadata.etag=u}}e.each(r,function(e,t){if(t&&t.__deferred){delete r[e]}});var l=this.oMetadata._getEntityTypeByPath(o);if(l){var p=this.oMetadata._getNavigationPropertyNames(l);e.each(p,function(e,t){delete r[t]})}r=this._removeReferences(r)}if(s&&s.sETag){h=s.sETag}i=this._createRequest(this.sChangeKey,"MERGE",true,r,h);if(this.sUrlParams){i.requestUri+="?"+this.sUrlParams}i.keys={};if(c){f=this._getKey(c);i.keys[f]=true}this.oRequestQueue[this.sChangeKey]=i}if(e.isEmptyObject(this.oRequestQueue)){return undefined}if(this.bUseBatch){var y=[];e.each(this.oRequestQueue,function(t,a){delete a._oRef;var s=e.sap.extend(true,{},a);a._oRef=s;s.requestUri=s.requestUri.replace(n.sServiceUrl+"/","");s.data._bCreate?delete s.data._bCreate:false;y.push(s)});i=this._createBatchRequest([{__changeRequests:y}],true);this._submitRequest(i,this.bUseBatch,t,a,true)}else{e.each(this.oRequestQueue,function(s,i){delete i._oRef;var r=e.sap.extend(true,{},i);i._oRef=r;if(r.data&&r.data._bCreate){delete r.data._bCreate}n._submitRequest(r,this.bUseBatch,t,a,true)})}return undefined};p.prototype._updateRequestQueue=function(t,a){var s,i,r,n=this;if(a){s=t.data.__batchRequests;if(s){for(var o=0;o<s.length;o++){i=s[o].__changeRequests;if(i){for(var h=0;h<i.length;h++){r=i[h];e.each(this.oRequestQueue,function(e,t){if(t._oRef===r&&e!==n.sChangeKey){delete n.oRequestQueue[e];delete n.oData[e];delete n.mContexts["/"+e]}else if(n.sChangeKey&&e===n.sChangeKey){delete n.oRequestQueue[e];n.sChangeKey=null}})}}}}}else{e.each(this.oRequestQueue,function(e,a){if(a._oRef===t&&e!==n.sChangeKey){delete n.oRequestQueue[e];delete n.oData[e];delete n.mContexts["/"+e]}else if(n.sChangeKey&&e===n.sChangeKey){delete n.oRequestQueue[e];n.sChangeKey=null}})}};p.prototype.resetChanges=function(e,t){var a;if(this.sChangeKey){a=this.sChangeKey.replace(this.sServiceUrl,"");this._loadData(a,null,e,t)}};p.prototype.setProperty=function(e,t,a,s){var i,r={},n={},o=this._createRequestUrl(e,a),h=e.substring(0,e.lastIndexOf("/")),d,u,c={},f=false;if(!this.resolve(e,a)){return false}o=o.replace(this.sServiceUrl+"/","");o=o.substring(0,o.indexOf("/"));o=this.sServiceUrl+"/"+o;i=e.substr(e.lastIndexOf("/")+1);n=this._getObject(h,a);if(!n){return false}u=h.split("/");for(var l=u.length-1;l>=0;l--){r=this._getObject(u.join("/"),a);if(r){d=this._getKey(r);if(d){break}}u.splice(l-1,1)}if(!d){d=this._getKey(a)}if(d){c[d]=true}if(n._bCreate){n[i]=t;f=true;this.checkUpdate(false,s,c)}else{if(!this.sChangeKey){this.sChangeKey=o}if(this.sChangeKey==o){n[i]=t;f=true;this.checkUpdate(false,s,c)}else{this.fireRejectChange({rejectedValue:t,oldValue:n[i]})}}return f};p.prototype._isHeaderPrivate=function(e){switch(e.toLowerCase()){case"accept":case"accept-language":case"maxdataserviceversion":case"dataserviceversion":return true;case"x-csrf-token":return this.bTokenHandling;default:return false}};p.prototype.setHeaders=function(t){var a={},s=this;if(t){e.each(t,function(t,i){if(s._isHeaderPrivate(t)){e.sap.log.warning("Not allowed to modify private header: "+t)}else{a[t]=i}});this.mCustomHeaders=a}else{this.mCustomHeaders={}}if(this.oAnnotations){this.oAnnotations.setHeaders(this.mCustomHeaders)}};p.prototype.getHeaders=function(){return e.extend({},this.mCustomHeaders,this.oHeaders)};p.prototype._getHeader=function(e,t){var a;for(a in t){if(a.toLowerCase()===e.toLowerCase()){return t[a]}}return null};p.prototype.hasPendingChanges=function(){return this.sChangeKey!=null};p.prototype.updateBindings=function(e){this.checkUpdate(e)};p.prototype.forceNoCache=function(e){this.bCache=!e};p.prototype.setTokenHandlingEnabled=function(e){this.bTokenHandling=e};p.prototype.setUseBatch=function(e){this.bUseBatch=e};p.prototype.formatValue=function(e,t){return i.formatValue(e,t)};p.prototype.deleteCreatedEntry=function(t){if(t){var a=t.getPath();delete this.mContexts[a];if(e.sap.startsWith(a,"/")){a=a.substr(1)}delete this.oRequestQueue[a];delete this.oData[a]}};p.prototype.createEntry=function(t,a){var s={},i,r,n;if(!e.sap.startsWith(t,"/")){t="/"+t}var o=this.oMetadata._getEntityTypeByPath(t);if(!o){e.sap.assert(o,"No Metadata for collection "+t+" found");return undefined}if(typeof a==="object"&&!Array.isArray(a)){s=a}else{for(var h=0;h<o.property.length;h++){var d=o.property[h];var u=e.inArray(d.name,a)>-1;if(!a||u){s[d.name]=this._createPropertyValue(d.type);if(u){a.splice(a.indexOf(d.name),1)}}}if(a){e.sap.assert(a.length===0,"No metadata for the following properties found: "+a.join(","))}}s._bCreate=true;i=t.substring(1)+"('"+e.sap.uid()+"')";this.oData[i]=s;s.__metadata={type:""+o.entityType};r=this._createRequestUrl(t);n=this._createRequest(r,"POST",true,s);n.entityTypes={};n.entityTypes[o.entityType]=true;this.oRequestQueue[i]=n;return this.getContext("/"+i)};p.prototype._createPropertyValue=function(t){var a=this.oMetadata._splitName(t);var s=a.namespace;var i=a.name;if(s.toUpperCase()!=="EDM"){var r={};var n=this.oMetadata._getObjectMetadata("complexType",i,s);e.sap.assert(n,"Complex type "+t+" not found in the metadata !");for(var o=0;o<n.property.length;o++){var h=n.property[o];r[h.name]=this._createPropertyValue(h.type)}return r}else{return this._getDefaultPropertyValue(i,s)}};p.prototype._getDefaultPropertyValue=function(e,t){return undefined};p.prototype._normalizePath=function(t,a){if(t&&t.indexOf("?")!=-1){t=t.substr(0,t.indexOf("?"))}if(!a&&!e.sap.startsWith(t,"/")){t="/"+t;e.sap.log.warning(this+" path "+t+" should be absolute if no Context is set")}return this.resolve(t,a)};p.prototype.setRefreshAfterChange=function(e){this.bRefreshAfterChange=e};p.prototype.isList=function(e,t){var e=this.resolve(e,t);return e&&e.substr(e.lastIndexOf("/")).indexOf("(")===-1};p.prototype.isMetaModelPath=function(e){return e.indexOf("##")==0||e.indexOf("/##")>-1};p.prototype._request=function(t,a,s,i,r,n){if(this.bDestroyed){return{abort:function(){}}}var o=this;function h(t){return function(){var a=e.inArray(d,o.aPendingRequestHandles);if(a>-1){o.aPendingRequestHandles.splice(a,1)}if(!(d&&d.bSuppressErrorHandlerCall)){t.apply(this,arguments)}}}var d=l.request(t,h(a||l.defaultSuccess),h(s||l.defaultError),i,r,n);if(t.async!==false){this.aPendingRequestHandles.push(d)}return d};p.prototype.destroy=function(){this.bDestroyed=true;if(this.aPendingRequestHandles){for(var t=this.aPendingRequestHandles.length-1;t>=0;t--){var a=this.aPendingRequestHandles[t];if(a&&a.abort){a.bSuppressErrorHandlerCall=true;a.abort()}}delete this.aPendingRequestHandles}if(!!this.oMetadataLoadEvent){e.sap.clearDelayedCall(this.oMetadataLoadEvent)}if(!!this.oMetadataFailedEvent){e.sap.clearDelayedCall(this.oMetadataFailedEvent)}if(this.oMetadata){this.oMetadata.detachLoaded(this.onMetadataLoaded);this.oMetadata.detachFailed(this.onMetadataFailed);if(!this.oMetadata.isLoaded()&&!this.oMetadata.hasListeners("loaded")){this.oMetadata.destroy();delete this.oServiceData.oMetadata}delete this.oMetadata}if(this.oAnnotations){this.oAnnotations.detachFailed(this.onAnnotationsFailed);this.oAnnotations.detachLoaded(this.onAnnotationsLoaded);this.oAnnotations.destroy();delete this.oAnnotations}s.prototype.destroy.apply(this,arguments)};p.prototype._getAnnotationParser=function(e){if(!this.oAnnotations){var t=sap.ui.requireSync("sap/ui/model/odata/ODataAnnotations");this.oAnnotations=new t({annotationData:e,url:null,metadata:this.oMetadata,async:this.bLoadMetadataAsync,headers:this.mCustomHeaders});this.oAnnotations.attachFailed(this.onAnnotationsFailed,this);this.oAnnotations.attachLoaded(this.onAnnotationsLoaded,this)}return this.oAnnotations};p.prototype.onAnnotationsFailed=function(e){this.fireAnnotationsFailed(e.getParameters())};p.prototype.onAnnotationsLoaded=function(e){this.fireAnnotationsLoaded(e.getParameters())};p.prototype.addAnnotationUrl=function(t){var a=[].concat(t),s=[],i=[],r=[],n=this;e.each(a,function(e,t){var a=t.indexOf("$metadata");if(a>=0){if(a==0){t=n.sServiceUrl+"/"+t}s.push(t)}else{i.push(t)}});return this.oMetadata._addUrl(s).then(function(t){return Promise.all(e.map(t,function(e){r=r.concat(e.entitySets);return n.addAnnotationXML(e["metadataString"])}))}).then(function(){return n._getAnnotationParser().addUrl(i)}).then(function(e){return{annotations:e.annotations,entitySets:r}})};p.prototype.addAnnotationXML=function(e,t){return new Promise(function(a,s){this._getAnnotationParser().setXML(null,e,{success:a,error:s,fireEvents:!t})}.bind(this))};p.prototype.getMetaModel=function(){var e=this;if(!this.oMetaModel){this.oMetaModel=new c(this.oMetadata,this.oAnnotations,{addAnnotationUrl:this.addAnnotationUrl.bind(this),annotationsLoadedPromise:this.oMetadata.isLoaded()&&(!this.oAnnotations||this.oAnnotations.isLoaded())?null:this.pAnnotationsLoaded});this.oMetaModel.loaded().then(function(){e.bMetaModelLoaded=true;e.checkUpdate(false,false,null,true)})}return this.oMetaModel};return p});