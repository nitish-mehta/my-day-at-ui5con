/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/odata/ODataUtils","sap/ui/core/library","sap/ui/thirdparty/URI","sap/ui/core/message/MessageParser","sap/ui/core/message/Message"],function(e,r,t,s,a,i){"use strict";var o=t.MessageType;var n={error:o.Error,warning:o.Warning,success:o.Success,info:o.Information};var l=a.extend("sap.ui.model.odata.ODataMessageParser",{metadata:{publicMethods:["parse","setProcessor","getHeaderField","setHeaderField"]},constructor:function(e,r){a.apply(this);this._serviceUrl=d(this._parseUrl(e).url);this._metadata=r;this._processor=null;this._headerField="sap-message";this._lastMessages=[]}});l.prototype.getHeaderField=function(){return this._headerField};l.prototype.setHeaderField=function(e){this._headerField=e;return this};l.prototype.parse=function(r,t,s,a){var i=[];var o={url:t?t.requestUri:r.requestUri,request:t,response:r};if(r.statusCode>=200&&r.statusCode<300){this._parseHeader(i,r,o)}else if(r.statusCode>=400&&r.statusCode<600){this._parseBody(i,r,o)}else{e.sap.log.warning("No rule to parse OData response with status "+r.statusCode+" for messages")}if(this._processor){this._propagateMessages(i,o,s,a)}else{this._outputMesages(i)}};l.prototype._isNavigationProperty=function(e,r){var t=this._metadata._getEntityTypeByPath(e);if(t){var s=this._metadata._getNavigationPropertyNames(t);return s.indexOf(r)>-1}return false};l.prototype._getAffectedTargets=function(r,t,s,a){var i=e.extend({"":true},s,a);var o=this._parseUrl(t).url;if(o.indexOf(this._serviceUrl)===0){o=o.substr(this._serviceUrl.length+1)}var n=this._metadata._getEntitySetByPath(o);if(n){i[n.name]=true}for(var l=0;l<r.length;++l){var p=r[l].getTarget();if(p){var u=p.replace(/^\/+|\/$/g,"");i[u]=true;var d=u.lastIndexOf("/");if(d>0){var f=u.substr(0,d);var g=u.substr(d);var h=this._isNavigationProperty(f,g);if(!h){i[f]=true}}}}return i};l.prototype._propagateMessages=function(e,r,t,s){var a,i;var o=this._getAffectedTargets(e,r.url,t,s);var n=[];var l=[];for(a=0;a<this._lastMessages.length;++a){i=this._lastMessages[a].getTarget().replace(/^\/+|\/$/g,"");var p=i.lastIndexOf(")/");if(p>0){i=i.substr(0,p+1)}if(o[i]&&!this._lastMessages[a].getPersistent()){n.push(this._lastMessages[a])}else{l.push(this._lastMessages[a])}}this.getProcessor().fireMessageChange({oldMessages:n,newMessages:e});this._lastMessages=l.concat(e)};l.prototype._createMessage=function(e,t,s){var a=e["@sap.severity"]?e["@sap.severity"]:e["severity"];a=n[a]?n[a]:a;var o=e.code?e.code:"";var l=typeof e["message"]==="object"&&e["message"]["value"]?e["message"]["value"]:e["message"];var p=e.longtext_url?e.longtext_url:"";var u=false;if(!e.target&&e.propertyref){e.target=e.propertyref}if(typeof e.target==="undefined"){e.target=""}if(e.target.indexOf("/#TRANSIENT#")===0){u=true;e.target=e.target.substr(12)}else if(e.transient){u=true}var d=this._createTarget(e,t);return new i({type:a,code:o,message:l,descriptionUrl:p,target:r._normalizeKey(d),processor:this._processor,technical:s,persistent:u})};l.prototype._getFunctionTarget=function(r,t,s){var a="";var i;if(t.response&&t.response.headers&&t.response.headers["location"]){a=t.response.headers["location"];var o=a.lastIndexOf(this._serviceUrl);if(o>-1){a=a.substr(o+this._serviceUrl.length)}}else{var n=null;if(r.extensions){for(i=0;i<r.extensions.length;++i){if(r.extensions[i].name==="action-for"){n=r.extensions[i].value;break}}}var l;if(n){l=this._metadata._getEntityTypeByName(n)}else if(r.entitySet){l=this._metadata._getEntityTypeByPath(r.entitySet)}else if(r.returnType){l=this._metadata._getEntityTypeByName(r.returnType)}if(l){var p=this._metadata._getEntitySetByType(l);if(p&&l&&l.key&&l.key.propertyRef){var u="";var d;if(l.key.propertyRef.length===1){d=l.key.propertyRef[0].name;if(s.parameters[d]){u=s.parameters[d]}}else{var f=[];for(i=0;i<l.key.propertyRef.length;++i){d=l.key.propertyRef[i].name;if(s.parameters[d]){f.push(d+"="+s.parameters[d])}}u=f.join(",")}a="/"+p.name+"("+u+")"}else if(!p){e.sap.log.error("Could not determine path of EntitySet for function call: "+s.url)}else{e.sap.log.error("Could not determine keys of EntityType for function call: "+s.url)}}}return a};l.prototype._createTarget=function(e,r){var t=e.target;if(t.substr(0,1)!=="/"){var s="";var a=r.request&&r.request.method?r.request.method:"GET";var i=a==="POST"&&r.response&&r.response.statusCode==201&&r.response.headers&&r.response.headers["location"];var o;if(i){o=r.response.headers["location"]}else if(r.request&&r.request.key&&r.request.created&&r.response&&r.response.statusCode>=400){o=r.request.key}else{o=r.url}var n=this._parseUrl(o);var l=n.url;var p=l.lastIndexOf(this._serviceUrl);if(p>-1){s=l.substr(p+this._serviceUrl.length+1)}else{s=l}if(!i){var u=this._metadata._getFunctionImportMetadata(s,a);if(u){s=this._getFunctionTarget(u,r,n);if(t){t=s+"/"+t}else{t=s}return t}}s="/"+s;var d=s.lastIndexOf("/");var f=d>-1?s.substr(d):s;if(f.indexOf("(")>-1){t=t?s+"/"+t:s}else{t=s+t}}return t};l.prototype._parseHeader=function(r,t,s){var a=this.getHeaderField();if(!t.headers){return}for(var i in t.headers){if(i.toLowerCase()===a.toLowerCase()){a=i}}if(!t.headers[a]){return}var o=t.headers[a];var n=null;try{n=JSON.parse(o);r.push(this._createMessage(n,s));if(Array.isArray(n.details)){for(var l=0;l<n.details.length;++l){r.push(this._createMessage(n.details[l],s))}}}catch(r){e.sap.log.error("The message string returned by the back-end could not be parsed");return}};l.prototype._parseBody=function(e,r,t){var s=p(r);if(s&&s.indexOf("xml")>-1){this._parseBodyXML(e,r,t,s)}else{this._parseBodyJSON(e,r,t)}if(e.length>1){for(var a=1;a<e.length;a++){if(e[0].getCode()==e[a].getCode()&&e[0].getMessage()==e[a].getMessage()){e.shift();break}}}};l.prototype._parseBodyXML=function(r,t,s,a){try{var i=(new DOMParser).parseFromString(t.body,a);var n=f(i,["error","errordetail"]);for(var l=0;l<n.length;++l){var p=n[l];var u={};u["severity"]=o.Error;for(var d=0;d<p.childNodes.length;++d){var g=p.childNodes[d];var h=g.nodeName;if(h==="errordetails"||h==="details"||h==="innererror"||h==="#text"){continue}if(h==="message"&&g.hasChildNodes()&&g.firstChild.nodeType!==window.Node.TEXT_NODE){for(var c=0;c<g.childNodes.length;++c){if(g.childNodes[c].nodeName==="value"){u["message"]=g.childNodes[c].text||g.childNodes[c].textContent}}}else{u[g.nodeName]=g.text||g.textContent}}r.push(this._createMessage(u,s,true))}}catch(r){e.sap.log.error("Error message returned by server could not be parsed")}};l.prototype._parseBodyJSON=function(r,t,s){try{var a=JSON.parse(t.body);var i;if(a["error"]){i=a["error"]}else{i=a["odata.error"]}if(!i){e.sap.log.error("Error message returned by server did not contain error-field");return}i["severity"]=o.Error;r.push(this._createMessage(i,s,true));var n=null;if(Array.isArray(i.details)){n=i.details}else if(i.innererror&&Array.isArray(i.innererror.errordetails)){n=i.innererror.errordetails}else{n=[]}for(var l=0;l<n.length;++l){r.push(this._createMessage(n[l],s,true))}}catch(r){e.sap.log.error("Error message returned by server could not be parsed")}};l.prototype._parseUrl=function(e){var r={url:e,parameters:{},hash:""};var t=-1;t=e.indexOf("#");if(t>-1){r.hash=r.url.substr(t+1);r.url=r.url.substr(0,t)}t=e.indexOf("?");if(t>-1){var a=r.url.substr(t+1);r.parameters=s.parseQuery(a);r.url=r.url.substr(0,t)}return r};l.prototype._outputMesages=function(r){for(var t=0;t<r.length;++t){var s=r[t];var a="[OData Message] "+s.getMessage()+" - "+s.getDescription()+" ("+s.getTarget()+")";switch(r[t].getType()){case o.Error:e.sap.log.error(a);break;case o.Warning:e.sap.log.warning(a);break;case o.Success:e.sap.log.debug(a);break;case o.Information:case o.None:default:e.sap.log.info(a);break}}};function p(e){if(e&&e.headers){for(var r in e.headers){if(r.toLowerCase()==="content-type"){return e.headers[r].replace(/([^;]*);.*/,"$1")}}}return false}var u=document.createElement("a");function d(e){u.href=e;return s.parse(u.href).path}function f(e,r){var t=[];var s={};for(var a=0;a<r.length;++a){s[r[a]]=true}var i=e;while(i){if(s[i.tagName]){t.push(i)}if(i.hasChildNodes()){i=i.firstChild}else{while(!i.nextSibling){i=i.parentNode;if(!i||i===e){i=null;break}}if(i){i=i.nextSibling}}}return t}return l});