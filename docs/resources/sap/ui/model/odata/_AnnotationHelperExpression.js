/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./_AnnotationHelperBasics","sap/ui/base/BindingParser","sap/ui/base/ManagedObject","sap/ui/core/format/DateFormat","sap/ui/model/odata/ODataUtils"],function(e,t,a,r,n,i){"use strict";var s="sap.ui.model.odata.AnnotationHelper",o="\\d{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[12]\\d|3[01])",u="[-+]?\\d+(?:\\.\\d+)?",l="9007199254740991",p="-"+l,c=[s],d=s+"/getExpression",m="(?:[01]\\d|2[0-3]):[0-5]\\d(?::[0-5]\\d(\\.\\d{1,12})?)?",f={Bool:/^true$|^false$/i,Float:new RegExp("^"+u+"(?:[eE][-+]?\\d+)?$|^NaN$|^-INF$|^INF$"),Date:new RegExp("^"+o+"$"),DateTimeOffset:new RegExp("^"+o+"T"+m+"(?:Z|[-+](?:0\\d|1[0-3]):[0-5]\\d|[-+]14:00)$","i"),Decimal:new RegExp("^"+u+"$"),Guid:/^[A-F0-9]{8}-(?:[A-F0-9]{4}-){3}[A-F0-9]{12}$/i,Int:/^[-+]?\d{1,19}$/,TimeOfDay:new RegExp("^"+m+"$")},g,y=/^\{@i18n>[^\\\{\}:]+\}$/,E=/^\d+$/,v={And:"&&",Eq:"===",Ge:">=",Gt:">",Le:"<=",Lt:"<",Ne:"!==",Not:"!",Or:"||"},T=/^(\/dataServices\/schema\/\d+)(?:\/|$)/,x={"Edm.Boolean":"boolean","Edm.Byte":"number","Edm.Date":"date","Edm.DateTime":"datetime","Edm.DateTimeOffset":"datetime","Edm.Decimal":"decimal","Edm.Double":"number","Edm.Float":"number","Edm.Guid":"string","Edm.Int16":"number","Edm.Int32":"number","Edm.Int64":"decimal","Edm.SByte":"number","Edm.Single":"number","Edm.String":"string","Edm.Time":"time","Edm.TimeOfDay":"time"},D={Bool:"Edm.Boolean",Float:"Edm.Double",Date:"Edm.Date",DateTimeOffset:"Edm.DateTimeOffset",Decimal:"Edm.Decimal",Guid:"Edm.Guid",Int:"Edm.Int64",String:"Edm.String",TimeOfDay:"Edm.TimeOfDay"},S={boolean:false,date:true,datetime:true,decimal:true,number:false,string:false,time:true};g={adjustOperands:function(e,t){if(e.result!=="constant"&&e.category==="number"&&t.result==="constant"&&t.type==="Edm.Int64"){t.category="number"}if(e.result!=="constant"&&e.category==="decimal"&&t.result==="constant"&&t.type==="Edm.Int32"){t.category="decimal";t.type=e.type}if(e.result==="constant"&&e.category==="date"&&t.result!=="constant"&&t.category==="datetime"){t.category="date"}},apply:function(e,a){var r=t.descend(a,"Name","string"),n=t.descend(a,"Parameters");switch(r.value){case"odata.concat":return g.concat(e,n);case"odata.fillUriTemplate":return g.fillUriTemplate(e,n);case"odata.uriEncode":return g.uriEncode(e,n);default:t.error(r,"unknown function: "+r.value)}},concat:function(e,a){var r=a.asExpression,n=[],i,s=[];t.expectType(a,"array");a.value.forEach(function(t,n){i=g.parameter(e,a,n);r=r||i.result==="expression";s.push(i)});s.forEach(function(e){if(r){g.wrapExpression(e)}if(e.type!=="edm:Null"){n.push(t.resultToString(e,r,a.withType))}});i=r?{result:"expression",value:n.join("+")}:{result:"composite",value:n.join("")};i.type="Edm.String";return i},conditional:function(e,a){var r=g.parameter(e,a,0,"Edm.Boolean"),n=g.parameter(e,a,1),i=g.parameter(e,a,2),s=n.type,o=a.withType;if(n.type==="edm:Null"){s=i.type}else if(i.type!=="edm:Null"&&n.type!==i.type){t.error(a,"Expected same type for second and third parameter, types are '"+n.type+"' and '"+i.type+"'")}return{result:"expression",type:s,value:t.resultToString(g.wrapExpression(r),true,false)+"?"+t.resultToString(g.wrapExpression(n),true,o)+":"+t.resultToString(g.wrapExpression(i),true,o)}},constant:function(e,a,r){var n=a.value;t.expectType(a,"string");if(r==="String"){if(y.test(n)){return{ignoreTypeInPath:true,result:"binding",type:"Edm.String",value:n.slice(1,-1)}}else if(e.getSetting&&e.getSetting("bindTexts")){return{result:"binding",type:"Edm.String",ignoreTypeInPath:true,value:"/##"+g.replaceIndexes(e.getModel(),a.path)}}r="Edm.String"}else if(!f[r].test(n)){t.error(a,"Expected "+r+" value but instead saw '"+n+"'")}else{r=D[r];if(r==="Edm.Int64"&&i.compare(n,p,true)>=0&&i.compare(n,l,true)<=0){r="Edm.Int32"}}return{result:"constant",type:r,value:n}},expression:function(e,a){var r=a.value,n,i;t.expectType(a,"object");if(r.hasOwnProperty("Type")){i=t.property(a,"Type","string");n=t.descend(a,"Value")}else{["And","Apply","Bool","Date","DateTimeOffset","Decimal","Float","Eq","Ge","Gt","Guid","If","Int","Le","Lt","Ne","Not","Null","Or","Path","PropertyPath","String","TimeOfDay"].forEach(function(e){if(r.hasOwnProperty(e)){i=e;n=t.descend(a,e)}})}switch(i){case"Apply":return g.apply(e,n);case"If":return g.conditional(e,n);case"Path":case"PropertyPath":return g.path(e,n);case"Bool":case"Date":case"DateTimeOffset":case"Decimal":case"Float":case"Guid":case"Int":case"String":case"TimeOfDay":return g.constant(e,n,i);case"And":case"Eq":case"Ge":case"Gt":case"Le":case"Lt":case"Ne":case"Or":return g.operator(e,n,i);case"Not":return g.not(e,n);case"Null":return{result:"constant",value:"null",type:"edm:Null"};default:t.error(a,"Unsupported OData expression")}},formatOperand:function(e,a,r,n){var i;if(r.result==="constant"){switch(r.category){case"boolean":case"number":return r.value;case"date":i=g.parseDate(r.value);if(!i){t.error(t.descend(e,a),"Invalid Date "+r.value)}return String(i.getTime());case"datetime":i=g.parseDateTimeOffset(r.value);if(!i){t.error(t.descend(e,a),"Invalid DateTime "+r.value)}return String(i.getTime());case"time":return String(g.parseTimeOfDay(r.value).getTime())}}if(n){g.wrapExpression(r)}return t.resultToString(r,true)},getExpression:function(n,i,o){var u;if(i===undefined){return undefined}e.sap.measure.average(d,"",c);if(!g.simpleParserWarningLogged&&r.bindingParser===a.simpleParser){e.sap.log.warning("Complex binding syntax not active",null,s);g.simpleParserWarningLogged=true}try{u=g.expression(n,{asExpression:false,path:n.getPath(),value:i,withType:o});e.sap.measure.end(d);return t.resultToString(u,false,o)}catch(r){e.sap.measure.end(d);if(r instanceof SyntaxError){return"Unsupported: "+a.complexParser.escape(t.toErrorString(i))}throw r}},fillUriTemplate:function(e,a){var r,n,i=[],s="",o,u=a.value,l,p=g.parameter(e,a,0,"Edm.String");i.push("odata.fillUriTemplate(",t.resultToString(p,true),",{");for(r=1;r<u.length;r+=1){o=t.descend(a,r,"object");n=t.property(o,"Name","string");l=g.expression(e,t.descend(o,"Value"),true);i.push(s,t.toJSON(n),":",t.resultToString(l,true));s=","}i.push("})");return{result:"expression",value:i.join(""),type:"Edm.String"}},not:function(e,a){var r;a.asExpression=true;r=g.expression(e,a);return{result:"expression",value:"!"+t.resultToString(g.wrapExpression(r),true),type:"Edm.Boolean"}},operator:function(e,a,r){var n=r==="And"||r==="Or"?"Edm.Boolean":undefined,i=g.parameter(e,a,0,n),s=g.parameter(e,a,1,n),o,u,l,p;if(i.type!=="edm:Null"&&s.type!=="edm:Null"){i.category=x[i.type];s.category=x[s.type];g.adjustOperands(i,s);g.adjustOperands(s,i);if(i.category!==s.category){t.error(a,"Expected two comparable parameters but instead saw "+i.type+" and "+s.type)}o=i.category==="decimal"?",true":"";u=S[i.category]}l=g.formatOperand(a,0,i,!u);p=g.formatOperand(a,1,s,!u);return{result:"expression",value:u?"odata.compare("+l+","+p+o+")"+v[r]+"0":l+v[r]+p,type:"Edm.Boolean"}},parameter:function(e,a,r,n){var i=t.descend(a,r),s;i.asExpression=true;s=g.expression(e,i);if(n&&n!==s.type){t.error(i,"Expected "+n+" but instead saw "+s.type)}return s},parseDate:function(e){return n.getDateInstance({pattern:"yyyy-MM-dd",strictParsing:true,UTC:true}).parse(e)},parseDateTimeOffset:function(e){var t=f.DateTimeOffset.exec(e);if(t&&t[1]&&t[1].length>4){e=e.replace(t[1],t[1].slice(0,4))}return n.getDateTimeInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss.SSSX",strictParsing:true}).parse(e.toUpperCase())},parseTimeOfDay:function(e){if(e.length>12){e=e.slice(0,12)}return n.getTimeInstance({pattern:"HH:mm:ss.SSS",strictParsing:true,UTC:true}).parse(e)},path:function(a,r){var n=r.value,i={},o,u,l,p=a.getModel(),c={getModel:function(){return p},getPath:function(){return r.path}},d,m={result:"binding",value:n},f;t.expectType(r,"string");f=t.followPath(c,{Path:n});if(f&&f.resolvedPath){d=p.getProperty(f.resolvedPath);m.type=d.type;switch(d.type){case"Edm.DateTime":i.displayFormat=d["sap:display-format"];break;case"Edm.Decimal":if(d.precision){i.precision=d.precision}if(d.scale){i.scale=d.scale}l=d["Org.OData.Validation.V1.Minimum"];if(l&&(l.Decimal||l.String)){i.minimum=l.Decimal||l.String;o=l["Org.OData.Validation.V1.Exclusive"];if(o){i.minimumExclusive=o.Bool||"true"}}l=d["Org.OData.Validation.V1.Maximum"];if(l&&(l.Decimal||l.String)){i.maximum=l.Decimal||l.String;o=l["Org.OData.Validation.V1.Exclusive"];if(o){i.maximumExclusive=o.Bool||"true"}}break;case"Edm.String":i.maxLength=d.maxLength;u=d["com.sap.vocabularies.Common.v1.IsDigitSequence"];if(u){i.isDigitSequence=u.Bool||"true"}break}if(d.nullable==="false"){i.nullable="false"}m.constraints=i}else{e.sap.log.warning("Could not find property '"+n+"' starting from '"+r.path+"'",null,s)}return m},replaceIndexes:function(e,a){var r,n=a.split("/"),i,s;function o(a,r){var s=e.getProperty(i+"/"+a);if(typeof s==="string"){n[r]="[${"+a+"}==="+t.toJSON(s)+"]";return true}return false}r=T.exec(a);if(!r){return a}i=r[1];if(!o("namespace",3)){return a}for(var u=4;u<n.length;u++){i=i+"/"+n[u];if(E.test(n[u])&&!o("name",u)){s=e.getProperty(i+"/RecordType");if(s){if(s==="com.sap.vocabularies.UI.v1.DataFieldForAction"){o("Action/String",u)}else if(s==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"){o("Target/AnnotationPath",u)}else if(s.indexOf("com.sap.vocabularies.UI.v1.DataField")===0){o("Value/Path",u)}}}}return n.join("/")},simpleParserWarningLogged:false,uriEncode:function(e,a){var r=g.parameter(e,a,0);if(r.result==="constant"){if(r.type==="Edm.Date"){r.type="Edm.DateTime";r.value=r.value+"T00:00:00Z"}else if(r.type==="Edm.TimeOfDay"){r.type="Edm.Time";r.value="PT"+r.value.slice(0,2)+"H"+r.value.slice(3,5)+"M"+r.value.slice(6,8)+"S"}}return{result:"expression",value:"odata.uriEncode("+t.resultToString(r,true)+","+t.toJSON(r.type)+")",type:"Edm.String"}},wrapExpression:function(e){if(e.result==="expression"){e.value="("+e.value+")"}return e}};return g},false);