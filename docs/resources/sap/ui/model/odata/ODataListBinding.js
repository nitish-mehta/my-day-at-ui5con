/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/ChangeReason","sap/ui/model/Filter","sap/ui/model/FilterType","sap/ui/model/ListBinding","sap/ui/model/Sorter","./ODataUtils","./CountMode"],function(t,e,s,i,a,n,h,r){"use strict";var o=a.extend("sap.ui.model.odata.ODataListBinding",{constructor:function(t,e,s,i,n,h){a.apply(this,arguments);this.sFilterParams=null;this.sSortParams=null;this.sRangeParams=null;this.sCustomParams=this.oModel.createCustomParams(this.mParameters);this.iStartIndex=0;this.bPendingChange=false;this.aKeys=[];this.bInitial=true;this.sCountMode=h&&h.countMode||this.oModel.sDefaultCountMode;this.bRefresh=false;this.bNeedsUpdate=false;this.bDataAvailable=false;this.bIgnoreSuspend=false;this.oModel.checkFilterOperation(this.aApplicationFilters);if(!this.oModel.getServiceMetadata()){var r=this,o=function(t){r.bInitial=false;r._initSortersFilters();r.oModel.detachMetadataLoaded(o)};this.oModel.attachMetadataLoaded(this,o)}else{this.bInitial=false;this._initSortersFilters()}var l=this.oModel._getObject(this.sPath,this.oContext);this.aExpandRefs=l;if(Array.isArray(l)&&!i&&!n){this.aKeys=l;this.iLength=l.length;this.bLengthFinal=true;this.bDataAvailable=true}else if(l===null&&this.oModel.resolve(this.sPath,this.oContext)){this.aKeys=[];this.iLength=0;this.bLengthFinal=true;this.bDataAvailable=true}else{if(this.oModel.getServiceMetadata()){this.resetData()}}}});o.prototype.getContexts=function(e,s,i){if(this.bInitial){return[]}this.iLastLength=s;this.iLastStartIndex=e;this.iLastThreshold=i;if(!e){e=0}if(!s){s=this.oModel.iSizeLimit;if(this.bLengthFinal&&this.iLength<s){s=this.iLength}}if(!i){i=0}var a=true,n=this._getContexts(e,s),h={},r;r=this.calculateSection(e,s,i,n);a=n.length!=s&&!(this.bLengthFinal&&n.length>=this.iLength-e);if(this.oModel.getServiceMetadata()){if(!this.bPendingRequest&&r.length>0&&(a||s<r.length)){this.loadData(r.startIndex,r.length);n.dataRequested=true}}if(this.bRefresh){if(this.bLengthFinal&&this.iLength==0){this.loadData(r.startIndex,r.length,true);n.dataRequested=true}this.bRefresh=false}else{for(var o=0;o<n.length;o++){h[n[o].getPath()]=n[o].getObject()}if(this.bUseExtendedChangeDetection){if(this.aLastContexts&&e<this.iLastEndIndex){var l=this;var f=t.sap.arrayDiff(this.aLastContexts,n,function(e,s){return t.sap.equal(e&&l.oLastContextData&&l.oLastContextData[e.getPath()],s&&h&&h[s.getPath()])},true);n.diff=f}}this.iLastEndIndex=e+s;this.aLastContexts=n.slice(0);this.oLastContextData=t.sap.extend(true,{},h)}return n};o.prototype.getCurrentContexts=function(){return this.aLastContexts||[]};o.prototype._getContexts=function(t,e){var s=[],i,a;if(!t){t=0}if(!e){e=this.oModel.iSizeLimit;if(this.bLengthFinal&&this.iLength<e){e=this.iLength}}for(var n=t;n<t+e;n++){a=this.aKeys[n];if(!a){break}i=this.oModel.getContext("/"+a);s.push(i)}return s};o.prototype.calculateSection=function(t,e,s,i){var a,n,h,r,o,l={},f;n=t;a=0;for(var u=t;u>=Math.max(t-s,0);u--){f=this.aKeys[u];if(!f){r=u+1;break}}for(var d=t+e;d<t+e+s;d++){f=this.aKeys[d];if(!f){h=d;break}}o=t-r;if(r&&t>s&&o<s){if(i.length!=e){n=t-s}else{n=r-s}a=s}n=Math.max(n,0);if(n==t){n+=i.length}if(i.length!=e){a+=e-i.length}o=h-t-e;if(o==0){a+=s}if(h&&o<s&&o>0){if(n>t){n=h;a+=s}}if(this.bLengthFinal&&this.iLength<a+n){a=this.iLength-n}l.startIndex=n;l.length=a;return l};o.prototype.setContext=function(t){if(this.oContext!=t){this.oContext=t;if(this.isRelative()){this._initSortersFilters();if(!this.bInitial){var s=this.oModel._getObject(this.sPath,this.oContext);this.aExpandRefs=s;if(Array.isArray(s)&&!this.aSorters.length>0&&!this.aFilters.length>0){this.aKeys=s;this.iLength=s.length;this.bLengthFinal=true;this._fireChange({reason:e.Context})}else if(!this.oModel.resolve(this.sPath,this.oContext)||s===null){this.aKeys=[];this.iLength=0;this.bLengthFinal=true;this._fireChange({reason:e.Context})}else{this.refresh()}}}}};o.prototype.getDownloadUrl=function(t){var e=[],s;if(t){e.push("$format="+encodeURIComponent(t))}if(this.sSortParams){e.push(this.sSortParams)}if(this.sFilterParams){e.push(this.sFilterParams)}if(this.sCustomParams){e.push(this.sCustomParams)}s=this.oModel.resolve(this.sPath,this.oContext);if(s){return this.oModel._createRequestUrl(s,null,e)}};o.prototype.loadData=function(s,i,a){var n=this,h=false;if(s||i){this.sRangeParams="$skip="+s+"&$top="+i;this.iStartIndex=s}else{s=this.iStartIndex}var o=[];if(this.sRangeParams){o.push(this.sRangeParams)}if(this.sSortParams){o.push(this.sSortParams)}if(this.sFilterParams){o.push(this.sFilterParams)}if(this.sCustomParams){o.push(this.sCustomParams)}if(!this.bLengthFinal&&(this.sCountMode==r.Inline||this.sCountMode==r.Both)){o.push("$inlinecount=allpages");h=true}function l(e){t.each(e.results,function(t,e){n.aKeys[s+t]=n.oModel._getKey(e)});if(h&&e.__count){n.iLength=parseInt(e.__count,10);n.bLengthFinal=true}if(n.iLength<s+e.results.length){n.iLength=s+e.results.length;n.bLengthFinal=false}if(e.results.length<i||i===undefined){n.iLength=s+e.results.length;n.bLengthFinal=true}if(s==0&&e.results.length==0){n.iLength=0;n.bLengthFinal=true}n.oRequestHandle=null;n.bPendingRequest=false;n.bNeedsUpdate=true;n.bIgnoreSuspend=true}function f(t){n.fireDataReceived({data:t})}function u(t,s){n.oRequestHandle=null;n.bPendingRequest=false;if(!s){n.aKeys=[];n.iLength=0;n.bLengthFinal=true;n.bDataAvailable=true;n._fireChange({reason:e.Change})}n.fireDataReceived()}function d(t){n.oRequestHandle=t}var g=this.sPath,p=this.oContext;if(this.isRelative()){g=this.oModel.resolve(g,p)}if(g){if(a){var c=this.oModel._createRequestUrl(g,null,o);this.fireDataRequested();this.oModel.fireRequestSent({url:c,method:"GET",async:true});setTimeout(function(){n.bNeedsUpdate=true;n.checkUpdate();n.oModel.fireRequestCompleted({url:c,method:"GET",async:true,success:true});n.fireDataReceived({data:{}})},0)}else{this.bPendingRequest=true;this.fireDataRequested();this.oModel._loadData(g,o,l,u,false,d,f)}}};o.prototype.getLength=function(){if(this.bLengthFinal||this.iLength==0){return this.iLength}else{var t=this.iLastThreshold||this.iLastLength||10;return this.iLength+t}};o.prototype.isLengthFinal=function(){return this.bLengthFinal};o.prototype._getLength=function(){var e=this;var s=[];if(this.sFilterParams){s.push(this.sFilterParams)}if(this.mParameters&&this.mParameters.custom){var i={custom:{}};t.each(this.mParameters.custom,function(t,e){i.custom[t]=e});s.push(this.oModel.createCustomParams(i))}function a(t){e.iLength=parseInt(t,10);e.bLengthFinal=true}function n(e){var s="Request for $count failed: "+e.message;if(e.response){s+=", "+e.response.statusCode+", "+e.response.statusText+", "+e.response.body}t.sap.log.warning(s)}var h=this.oModel.resolve(this.sPath,this.oContext);if(h){var r=this.oModel._createRequestUrl(h+"/$count",null,s);var o=this.oModel._createRequest(r,"GET",false);o.headers["Accept"]="text/plain, */*;q=0.5";this.oModel._request(o,a,n,undefined,undefined,this.oModel.getServiceMetadata())}};o.prototype.refresh=function(s,i,a){var n=false;if(!s){if(a){var h=this.oModel.resolve(this.sPath,this.oContext);var r=this.oModel.oMetadata._getEntityTypeByPath(h);if(r&&r.entityType in a){n=true}}if(i&&!n){t.each(this.aKeys,function(t,e){if(e in i){n=true;return false}})}if(!i&&!a){n=true}}if(s||n){this.abortPendingRequest();this.resetData();this._fireRefresh({reason:e.Refresh})}};o.prototype._fireRefresh=function(t){if(this.oModel.resolve(this.sPath,this.oContext)){this.bRefresh=true;this.fireEvent("refresh",t)}};o.prototype.initialize=function(){if(this.oModel.oMetadata.isLoaded()){if(this.bDataAvailable){this._fireChange({reason:e.Change})}else{this._fireRefresh({reason:e.Refresh})}}};o.prototype.checkUpdate=function(s,i){var a=this.sChangeReason?this.sChangeReason:e.Change,n=false,h,r,o=this,l,f;if(this.bSuspended&&!this.bIgnoreSuspend){return}if(!s&&!this.bNeedsUpdate){l=this.oModel._getObject(this.sPath,this.oContext);f=Array.isArray(l)&&!t.sap.equal(l,this.aExpandRefs);this.aExpandRefs=l;if(f){if(this.aSorters.length>0||this.aFilters.length>0){this.refresh();return}else{this.aKeys=l;this.iLength=l.length;this.bLengthFinal=true;n=true}}else if(i){t.each(this.aKeys,function(t,e){if(e in i){n=true;return false}})}else{n=true}if(n&&this.aLastContexts){n=false;var u=this._getContexts(this.iLastStartIndex,this.iLastLength,this.iLastThreshold);if(this.aLastContexts.length!=u.length){n=true}else{t.each(this.aLastContexts,function(e,s){h=o.oLastContextData[s.getPath()];r=u[e].getObject();if(!t.sap.equal(h,r,true)){n=true;return false}})}}}if(s||n||this.bNeedsUpdate){this.bNeedsUpdate=false;this._fireChange({reason:a})}this.sChangeReason=undefined;this.bIgnoreSuspend=false};o.prototype.resetData=function(){this.aKeys=[];this.iLength=0;this.bLengthFinal=false;this.sChangeReason=undefined;this.bDataAvailable=false;if(this.oModel.isCountSupported()&&(this.sCountMode==r.Request||this.sCountMode==r.Both)){this._getLength()}};o.prototype.abortPendingRequest=function(){if(this.oRequestHandle){this.oRequestHandle.abort();this.oRequestHandle=null;this.bPendingRequest=false}};o.prototype.sort=function(t,s){var i=false;if(!t){t=[]}if(t instanceof n){t=[t]}this.aSorters=t;this.createSortParams(t);if(!this.bInitial){this.aKeys=[];this.abortPendingRequest();this.sChangeReason=e.Sort;this._fireRefresh({reason:this.sChangeReason});this._fireSort({sorter:t});i=true}if(s){return i}else{return this}};o.prototype.createSortParams=function(t){this.sSortParams=h.createSortParams(t)};o.prototype.filter=function(t,a,n){var h=false;if(!t){t=[]}if(t instanceof s){t=[t]}this.oModel.checkFilterOperation(t);if(a==i.Application){this.aApplicationFilters=t}else{this.aFilters=t}if(!t||!Array.isArray(t)||t.length==0){this.aFilters=[]}if(!this.aApplicationFilters||!Array.isArray(this.aApplicationFilters)||this.aApplicationFilters.length===0){this.aApplicationFilters=[]}this.createFilterParams(this.aFilters,this.aApplicationFilters);if(!this.bInitial){this.resetData();this.abortPendingRequest();this.sChangeReason=e.Filter;this._fireRefresh({reason:this.sChangeReason});if(a==i.Application){this._fireFilter({filters:this.aApplicationFilters})}else{this._fireFilter({filters:this.aFilters})}h=true}if(n){return h}else{return this}};o.prototype.createFilterParams=function(t,e){var s,i=h._createFilterParams(t,this.oModel.oMetadata,this.oEntityType),a=h._createFilterParams(e,this.oModel.oMetadata,this.oEntityType);if(i){s=i}if(a){if(i){s="("+s+")"+"%20and%20"+"("+a+")"}else{s=a}}if(s){this.sFilterParams="$filter="+s}else{this.sFilterParams=undefined}};o.prototype._initSortersFilters=function(){var t=this.oModel.resolve(this.sPath,this.oContext);if(!t){return}this.oEntityType=this._getEntityType();this.createSortParams(this.aSorters);this.createFilterParams(this.aFilters.concat(this.aApplicationFilters))};o.prototype._getEntityType=function(){var e=this.oModel.resolve(this.sPath,this.oContext);if(e){var s=this.oModel.oMetadata._getEntityTypeByPath(e);t.sap.assert(s,"EntityType for path "+e+" could not be found!");return s}return undefined};o.prototype.resume=function(){this.bIgnoreSuspend=false;a.prototype.resume.apply(this,arguments)};return o});