/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/BindingMode","sap/ui/base/BindingParser","sap/ui/model/Context","sap/ui/base/ManagedObject","sap/ui/model/ClientContextBinding","sap/ui/model/FilterProcessor","sap/ui/model/json/JSONModel","sap/ui/model/json/JSONListBinding","sap/ui/model/json/JSONPropertyBinding","sap/ui/model/json/JSONTreeBinding","sap/ui/model/MetaModel","./_ODataMetaModelUtils"],function(t,e,n,i,o,r,a,s,l,p,d,u,y){"use strict";var c="sap.ui.model.odata.ODataMetaModel",h=[c],f=c+"/load",g=/^((\/dataServices\/schema\/\d+)\/(?:complexType|entityType)\/\d+)\/property\/\d+$/;var m=l.extend("sap.ui.model.odata.ODataMetaListBinding"),O=o.extend("sap.ui.model.odata._resolver",{metadata:{properties:{any:"any"}}});m.prototype.applyFilter=function(){var t=this;this.aIndices=a.apply(this.aIndices,this.aFilters.concat(this.aApplicationFilters),function(e,n){return n==="@sapui.name"?e:t.oModel.getProperty(n,t.oList[e])});this.iLength=this.aIndices.length};var v=u.extend("sap.ui.model.odata.ODataMetaModel",{constructor:function(n,i,o){var r=this;function a(){var e;if(r.bDestroyed){throw new Error("Meta model already destroyed")}t.sap.measure.average(f,"",h);e=JSON.parse(JSON.stringify(n.getServiceMetadata()));r.oModel=new s(e);r.oModel.setDefaultBindingMode(r.sDefaultBindingMode);y.merge(i?i.getAnnotationsData():{},e,r);t.sap.measure.end(f)}o=o||{};u.apply(this);this.oModel=null;this.mContext2Promise={};this.sDefaultBindingMode=e.OneTime;this.oLoadedPromise=o.annotationsLoadedPromise?o.annotationsLoadedPromise.then(a):new Promise(function(t,e){a();t()});this.oMetadata=n;this.oODataModelInterface=o;this.mQueryCache={};this.mQName2PendingRequest={};this.oResolver=undefined;this.mSupportedBindingModes={OneTime:true}}});v.prototype._getObject=function(e,o){var r=o,a,s,l,p,d,u,y,h=e||"",f;if(!o||o instanceof i){h=this.resolve(e||"",o);if(!h){t.sap.log.error("Invalid relative path w/o context",e,c);return null}}if(h.charAt(0)==="/"){r=this.oModel._getObject("/");h=h.slice(1)}y="/";d=r;while(h){u=undefined;a=undefined;if(h.charAt(0)==="["){try{f=n.parseExpression(h,1);p=f.at;if(h.length===p+1||h.charAt(p+1)==="/"){a=f.result;u=h.slice(0,p+1);h=h.slice(p+2)}}catch(t){if(!(t instanceof SyntaxError)){throw t}}}if(u===undefined){p=h.indexOf("/");if(p<0){u=h;h=""}else{u=h.slice(0,p);h=h.slice(p+1)}}if(!d){if(t.sap.log.isLoggable(t.sap.log.Level.WARNING,c)){t.sap.log.warning("Invalid part: "+u,"path: "+e+", context: "+(o instanceof i?o.getPath():o),c)}break}if(a){if(r===o){t.sap.log.error("A query is not allowed when an object context has been given",e,c);return null}if(!Array.isArray(d)){t.sap.log.error("Invalid query: '"+y+"' does not point to an array",e,c);return null}s=y+u;u=this.mQueryCache[s];if(u===undefined){this.oResolver=this.oResolver||new O({models:this.oModel});for(l=0;l<d.length;l++){this.oResolver.bindObject(y+l);this.oResolver.bindProperty("any",a);try{if(this.oResolver.getAny()){this.mQueryCache[s]=u=l;break}}finally{this.oResolver.unbindProperty("any");this.oResolver.unbindObject()}}}}d=d[u];y=y+u+"/"}return d};v.prototype._mergeMetadata=function(t){var e=this.getODataEntityContainer(),n=y.getChildAnnotations(t.annotations,e.namespace+"."+e.name,true),i=e.entitySet.length,o=this.oModel.getObject("/dataServices/schema"),r=this;t.entitySets.forEach(function(n){var i,a,s=n.entityType,l=s.slice(0,s.lastIndexOf("."));if(!r.getODataEntitySet(n.name)){e.entitySet.push(JSON.parse(JSON.stringify(n)));if(!r.getODataEntityType(s)){i=r.oMetadata._getEntityTypeByName(s);a=y.getSchema(o,l);a.entityType.push(JSON.parse(JSON.stringify(i)));y.visitParents(a,t.annotations,"entityType",y.visitEntityType,a.entityType.length-1)}}});y.visitChildren(e.entitySet,n,"EntitySet",o,null,i)};v.prototype._sendBundledRequest=function(){var t=this.mQName2PendingRequest,e=Object.keys(t),n=this;if(!e.length){return}this.mQName2PendingRequest={};e=e.sort();e.forEach(function(t,n){e[n]=encodeURIComponent(t)});this.oODataModelInterface.addAnnotationUrl("$metadata?sap-value-list="+e.join(",")).then(function(e){var i;n._mergeMetadata(e);for(i in t){try{t[i].resolve(e)}catch(e){t[i].reject(e)}}},function(e){var n;for(n in t){t[n].reject(e)}})};v.prototype.bindContext=function(t,e,n){return new r(this,t,e,n)};v.prototype.bindList=function(t,e,n,i,o){return new m(this,t,e,n,i,o)};v.prototype.bindProperty=function(t,e,n){return new p(this,t,e,n)};v.prototype.bindTree=function(t,e,n,i){return new d(this,t,e,n,i)};v.prototype.destroy=function(){u.prototype.destroy.apply(this,arguments);return this.oModel&&this.oModel.destroy.apply(this.oModel,arguments)};v.prototype.getAdapterFactoryModulePath=function(){return"sap/ui/model/odata/v2/meta/ODataAdapterFactory"};v.prototype.getMetaContext=function(t){var e,n,i,o,r,a,s,l,p;function d(t){var e=t.indexOf("(");return e>=0?t.slice(0,e):t}if(!t){return null}l=t.split("/");if(l[0]!==""){throw new Error("Not an absolute path: "+t)}l.shift();s=d(l[0]);n=this.getODataEntitySet(s);if(n){p=n.entityType}else{o=this.getODataFunctionImport(s);if(o){if(l.length===1){r=this.getODataFunctionImport(s,true)}p=o.returnType;if(p.lastIndexOf("Collection(",0)===0){p=p.slice(11,-1)}}else{throw new Error("Entity set or function import not found: "+s)}}l.shift();while(l.length){i=this.getODataEntityType(p);if(i){a=d(l[0]);e=this.getODataAssociationEnd(i,a)}else{i=this.getODataComplexType(p)}if(e){p=e.type;if(e.multiplicity==="1"&&a!==l[0]){throw new Error("Multiplicity is 1: "+l[0])}l.shift()}else{r=this.getODataProperty(i,l,true);if(l.length){throw new Error("Property not found: "+l.join("/"))}break}}r=r||this.getODataEntityType(p,true);return this.createBindingContext(r)};v.prototype.getODataAssociationEnd=function(t,e){var n=t?y.findObject(t.navigationProperty,e):null,i=n?y.getObject(this.oModel,"association",n.relationship):null,o=i?y.findObject(i.end,n.toRole,"role"):null;return o};v.prototype.getODataAssociationSetEnd=function(t,e){var n,i=null,o=this.getODataEntityContainer(),r=t?y.findObject(t.navigationProperty,e):null;if(o&&r){n=y.findObject(o.associationSet,r.relationship,"association");i=n?y.findObject(n.end,r.toRole,"role"):null}return i};v.prototype.getODataComplexType=function(t,e){return y.getObject(this.oModel,"complexType",t,e)};v.prototype.getODataEntityContainer=function(t){var e=t?undefined:null,n=this.oModel.getObject("/dataServices/schema");if(n){n.forEach(function(n,i){var o=y.findIndex(n.entityContainer,"true","isDefaultEntityContainer");if(o>=0){e=t?"/dataServices/schema/"+i+"/entityContainer/"+o:n.entityContainer[o];return false}});if(!e&&n.length===1&&n[0].entityContainer&&n[0].entityContainer.length===1){e=t?"/dataServices/schema/0/entityContainer/0":n[0].entityContainer[0]}}return e};v.prototype.getODataEntitySet=function(t,e){return y.getFromContainer(this.getODataEntityContainer(),"entitySet",t,e)};v.prototype.getODataEntityType=function(t,e){return y.getObject(this.oModel,"entityType",t,e)};v.prototype.getODataFunctionImport=function(t,e){var n=t&&t.indexOf("/")>=0?t.split("/"):undefined,i=n?y.getObject(this.oModel,"entityContainer",n[0]):this.getODataEntityContainer();return y.getFromContainer(i,"functionImport",n?n[1]:t,e)};v.prototype.getODataProperty=function(t,e,n){var i,o=Array.isArray(e)?e:[e],r=null,a;while(t&&o.length){i=y.findIndex(t.property,o[0]);if(i<0){break}o.shift();r=t.property[i];a=t.$path+"/property/"+i;if(o.length){t=this.getODataComplexType(r.type)}}return n?a:r};v.prototype.getODataValueLists=function(e){var n=false,i,o=e.getPath(),r=this.mContext2Promise[o],a=this;if(r){return r}i=g.exec(o);if(!i){throw new Error("Unsupported property context with path "+o)}r=new Promise(function(r,s){var l=e.getObject(),p,d=y.getValueLists(l);if(!(""in d)&&l["sap:value-list"]&&a.oODataModelInterface.addAnnotationUrl){n=true;p=a.oModel.getObject(i[2]).namespace+"."+a.oModel.getObject(i[1]).name;a.mQName2PendingRequest[p+"/"+l.name]={resolve:function(e){t.extend(l,(e.annotations.propertyAnnotations[p]||{})[l.name]);d=y.getValueLists(l);if(t.isEmptyObject(d)){s(new Error("No value lists returned for "+o))}else{delete a.mContext2Promise[o];r(d)}},reject:s};setTimeout(a._sendBundledRequest.bind(a),0)}else{r(d)}});if(n){this.mContext2Promise[o]=r}return r};v.prototype.getProperty=function(){return this._getObject.apply(this,arguments)};v.prototype.isList=function(){return this.oModel.isList.apply(this.oModel,arguments)};v.prototype.loaded=function(){return this.oLoadedPromise};v.prototype.refresh=function(){throw new Error("Unsupported operation: ODataMetaModel#refresh")};v.prototype.setLegacySyntax=function(t){if(t){throw new Error("Legacy syntax not supported by ODataMetaModel")}};v.prototype.setProperty=function(){throw new Error("Unsupported operation: ODataMetaModel#setProperty")};return v});