/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/Context","sap/ui/model/ContextBinding","sap/ui/model/ChangeReason"],function(e,t,i,n){"use strict";var o=i.extend("sap.ui.model.odata.v2.ODataContextBinding",{constructor:function(t,n,o,s,r){i.call(this,t,n,o,s,r);this.bRefreshGroupId=undefined;this.bPendingRequest=false;this.mParameters=e.extend(true,{},this.mParameters);this.bCreatePreliminaryContext=this.mParameters.createPreliminaryContext||t.bPreliminaryContext;this.bUsePreliminaryContext=this.mParameters.usePreliminaryContext||t.bPreliminaryContext;this.mParameters.createPreliminaryContext=this.bCreatePreliminaryContext;this.mParameters.usePreliminaryContext=this.bUsePreliminaryContext;this.bPendingRequest=false}});o.prototype.initialize=function(){var e=this,t,i=this.isRelative()&&this.oContext&&this.oContext.bCreated,o=this.oContext&&this.oContext.isPreliminary(),s;if(!this.oModel.oMetadata.isLoaded()||!this.bInitial){return}this.bInitial=false;if(o&&!this.bUsePreliminaryContext){return}t=this.oModel.resolve(this.sPath,this.oContext);if(!t||i){this.oElementContext=null;this._fireChange({reason:n.Context});return}s=this.oModel._isReloadNeeded(t,this.mParameters);if(s){this.fireDataRequested();this.bPendingRequest=true}var r=this.oModel.createBindingContext(this.sPath,this.oContext,this.mParameters,function(t){var i;if(e.bCreatePreliminaryContext&&t&&e.oElementContext&&e.oElementContext.isPreliminary()){e.oElementContext.setPreliminary(false);e.oModel._updateContext(e.oElementContext,t.getPath());e._fireChange({reason:n.Context},false,true)}else if(!t||t!==e.oElementContext){e.oElementContext=t;e._fireChange({reason:n.Context})}if(s){if(e.oElementContext){i=e.oElementContext.getObject(e.mParameters)}e.oModel.callAfterUpdate(function(){e.fireDataReceived({data:i})});e.bPendingRequest=false}},s);if(r&&this.bCreatePreliminaryContext){if(this.oElementContext!==r){r.setPreliminary(true);this.oElementContext=r;this.oModel.oMetadata.loaded().then(function(){this._fireChange({reason:n.Context})}.bind(this))}}};o.prototype.checkUpdate=function(t){var i,o=this.oContext&&this.oContext.isPreliminary();if(this.bInitial||this.bPendingRequest){return}if(o&&!this.bUsePreliminaryContext){return}if(!this._mParameters&&this.mParameters.createPreliminaryContext){this._mParameters=e.extend({},this.mParameters);delete this._mParameters.usePreliminaryContext;delete this._mParameters.createPreliminaryContext}i=this.oModel.createBindingContext(this.sPath,this.oContext,this._mParameters);if(i&&i!==this.oElementContext){this.oElementContext=i;this._fireChange({reason:n.Context})}};o.prototype.refresh=function(e,t){if(typeof e==="string"){t=e;e=false}this.sRefreshGroup=t;this._refresh(e);this.sRefreshGroup=undefined};o.prototype._refresh=function(t,i){var o=this,s,r,a,h=false,l=this.mParameters,C=this.isRelative()&&this.oContext&&this.oContext.bCreated,m=this.oModel.resolve(this.sPath,this.oContext),x;if(this.bInitial||C){return}if(i){a=this.oModel._getObject(this.sPath,this.oContext);if(a){r=this.oModel._getKey(a);if(r in i){h=true}}}else{h=true}if(t||h){if(m){this.fireDataRequested();this.bPendingRequest=true}if(this.sRefreshGroup){l=e.extend({},this.mParameters);l.groupId=this.sRefreshGroup}var f=this.oModel.createBindingContext(this.sPath,this.oContext,l,function(e){if(o.bCreatePreliminaryContext&&e&&o.oElementContext&&o.oElementContext.isPreliminary()){o.oElementContext.setPreliminary(false);o.oModel._updateContext(o.oElementContext,e.getPath());o._fireChange({reason:n.Context},false,true)}else if(o.oElementContext!==e||t){o.oElementContext=e;o._fireChange({reason:n.Context},t)}if(o.oElementContext){s=o.oElementContext.getObject(o.mParameters)}if(m){o.oModel.callAfterUpdate(function(){o.fireDataReceived({data:s})});o.bPendingRequest=false}},true);if(f&&this.bCreatePreliminaryContext){if(this.oElementContext!==f||t){f.setPreliminary(true);this.oElementContext=f;x=this.oElementContext.sPath;this.oModel._updateContext(this.oElementContext,m);this._fireChange({reason:n.Context},t);this.oModel._updateContext(this.oElementContext,x)}}}};o.prototype.setContext=function(e){var i=this,o,s,o,r=e&&e.bCreated,a=e&&e.isPreliminary(),h=e&&e.isRefreshForced(),l=e&&e.isUpdated(),C,m;if(this.bInitial||!this.isRelative()){return}if(a&&!this.bUsePreliminaryContext){return}if(l&&this.bUsePreliminaryContext){this._fireChange({reason:n.Context});return}if(t.hasChanged(this.oContext,e)){this.oContext=e;s=this.oModel.resolve(this.sPath,this.oContext);if(!s||r){if(this.oElementContext!==null){this.oElementContext=null;this._fireChange({reason:n.Context})}return}o=this.oModel._getObject(this.sPath,this.oContext);m=h||this.oModel._isReloadNeeded(s,this.mParameters);if(s&&m){this.fireDataRequested();this.bPendingRequest=true}var e=this.oModel.createBindingContext(this.sPath,this.oContext,this.mParameters,function(e){if(i.bCreatePreliminaryContext&&e&&i.oElementContext&&i.oElementContext.isPreliminary()){i.oElementContext.setPreliminary(false);i.oModel._updateContext(i.oElementContext,e.getPath());i._fireChange({reason:n.Context},false,true)}else if(i.oElementContext!==e||h){i.oElementContext=e;i._fireChange({reason:n.Context},h)}if(s&&m){if(i.oElementContext){o=i.oElementContext.getObject(i.mParameters)}i.oModel.callAfterUpdate(function(){i.fireDataReceived({data:o})});i.bPendingRequest=false}},m);if(e&&this.bCreatePreliminaryContext){e.setPreliminary(true);this.oElementContext=e;C=this.oElementContext.sPath;this.oModel._updateContext(this.oElementContext,s);this._fireChange({reason:n.Context},h);this.oModel._updateContext(this.oElementContext,C)}}};o.prototype._fireChange=function(e,t,n){if(this.oElementContext){this.oElementContext.setForceRefresh(t);this.oElementContext.setUpdated(n)}i.prototype._fireChange.call(this,e);if(this.oElementContext){this.oElementContext.setForceRefresh(false);this.oElementContext.setUpdated(false)}};return o});