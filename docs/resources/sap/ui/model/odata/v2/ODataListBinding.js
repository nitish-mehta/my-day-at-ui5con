/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/Context","sap/ui/model/FilterType","sap/ui/model/ListBinding","sap/ui/model/odata/ODataUtils","sap/ui/model/odata/CountMode","sap/ui/model/odata/Filter","sap/ui/model/odata/OperationMode","sap/ui/model/ChangeReason","sap/ui/model/Filter","sap/ui/model/FilterProcessor","sap/ui/model/Sorter","sap/ui/model/SorterProcessor"],function(t,e,s,i,a,n,r,h,o,l,u,d,f){"use strict";var p=i.extend("sap.ui.model.odata.v2.ODataListBinding",{constructor:function(t,e,s,a,r,h){i.apply(this,arguments);this.sFilterParams=null;this.sSortParams=null;this.sRangeParams=null;this.sCustomParams=this.oModel.createCustomParams(this.mParameters);this.iStartIndex=0;this.iLength=0;this.bPendingChange=false;this.aAllKeys=null;this.aKeys=[];this.sCountMode=h&&h.countMode||this.oModel.sDefaultCountMode;this.sOperationMode=h&&h.operationMode||this.oModel.sDefaultOperationMode;this.bCreatePreliminaryContext=h&&h.createPreliminaryContext||t.bPreliminaryContext;this.bUsePreliminaryContext=h&&h.usePreliminaryContext||t.bPreliminaryContext;this.bRefresh=false;this.bNeedsUpdate=false;this.bDataAvailable=false;this.bIgnoreSuspend=false;this.bPendingRefresh=false;this.sGroupId=undefined;this.sRefreshGroupId=undefined;this.bLengthRequested=false;this.bUseExtendedChangeDetection=true;this.bFaultTolerant=h&&h.faultTolerant;this.bLengthFinal=false;this.iLastEndIndex=0;this.aLastContexts=null;this.aLastContextData=null;this.bInitial=true;this.mRequestHandles={};this.oCountHandle=null;this.bSkipDataEvents=false;this.bUseExpandedList=false;this.oModel.checkFilterOperation(this.aApplicationFilters);if(h&&(h.batchGroupId||h.groupId)){this.sGroupId=h.groupId||h.batchGroupId}this.iThreshold=h&&h.threshold||0;this.bThresholdRejected=false;if(this.sCountMode==n.None){this.bThresholdRejected=true}var o=this.checkExpandedList();if(!o){this.resetData()}},metadata:{publicMethods:["getLength"]}});p.prototype.getContexts=function(e,s,i){if(this.bInitial){return[]}if(!this.bLengthFinal&&this.sOperationMode==h.Auto&&(this.sCountMode==n.Request||this.sCountMode==n.Both)){if(!this.bLengthRequested){this._getLength();this.bLengthRequested=true}return[]}if(!this.bLengthFinal&&!this.bPendingRequest&&!this.bLengthRequested){this._getLength();this.bLengthRequested=true}this.iLastLength=s;this.iLastStartIndex=e;this.iLastThreshold=i;if(!e){e=0}if(!s){s=this.oModel.iSizeLimit;if(this.bLengthFinal&&this.iLength<s){s=this.iLength}}if(!i){i=0}if(this.sOperationMode==h.Auto){if(this.iThreshold>=0){i=Math.max(this.iThreshold,i)}}var a=true,r=this._getContexts(e,s),o=[],l;if(this.useClientMode()){if(!this.aAllKeys&&!this.bPendingRequest&&this.oModel.getServiceMetadata()){this.loadData();r.dataRequested=true}}else{l=this.calculateSection(e,s,i,r);a=r.length!==s&&!(this.bLengthFinal&&r.length>=this.iLength-e);if(this.oModel.getServiceMetadata()){if(!this.bPendingRequest&&l.length>0&&(a||s<l.length)){this.loadData(l.startIndex,l.length);r.dataRequested=true}}}if(this.bRefresh){this.bRefresh=false}else{for(var u=0;u<r.length;u++){o.push(this.getContextData(r[u]))}if(this.bUseExtendedChangeDetection){if(this.aLastContexts&&e<this.iLastEndIndex){r.diff=t.sap.arraySymbolDiff(this.aLastContextData,o)}}this.iLastEndIndex=e+s;this.aLastContexts=r.slice(0);this.aLastContextData=o.slice(0)}return r};p.prototype.getCurrentContexts=function(){return this.aLastContexts||[]};p.prototype.getEntryKey=function(t){return t.getPath()};p.prototype.getEntryData=function(t){return JSON.stringify(t.getObject(this.mParameters))};p.prototype._getContexts=function(t,e){var s=[],i,a;if(!t){t=0}if(!e){e=this.oModel.iSizeLimit;if(this.bLengthFinal&&this.iLength<e){e=this.iLength}}for(var n=t;n<t+e;n++){a=this.aKeys[n];if(!a){break}i=this.oModel.getContext("/"+a);s.push(i)}return s};p.prototype.calculateSection=function(t,e,s,i){var a,n,r,h,o,l={},u;n=t;a=0;for(var d=t;d>=Math.max(t-s,0);d--){u=this.aKeys[d];if(!u){h=d+1;break}}for(var f=t+e;f<t+e+s;f++){u=this.aKeys[f];if(!u){r=f;break}}o=t-h;if(h&&t>s&&o<s){if(i.length!==e){n=t-s}else{n=h-s}a=s}n=Math.max(n,0);if(n===t){n+=i.length}if(i.length!==e){a+=e-i.length}o=r-t-e;if(o===0){a+=s}if(r&&o<s&&o>0){if(n>t){n=r;a+=s}}if(this.bLengthFinal&&this.iLength<a+n){a=this.iLength-n}l.startIndex=n;l.length=a;return l};p.prototype.setContext=function(s){var i,a=s&&s.bCreated,n=s&&s.isRefreshForced(),r=s&&s.isUpdated(),h=s&&s.isPreliminary();if(this.bInitial||!this.isRelative()){return}if(h&&!this.bUsePreliminaryContext){return}if(r&&this.bUsePreliminaryContext){this._fireChange({reason:o.Context});return}if(e.hasChanged(this.oContext,s)){this.oContext=s;i=this.oModel.resolve(this.sPath,this.oContext);if(!this._checkPathType()){t.sap.log.error("List Binding is not bound against a list for "+i)}if(!i||a){if(this.aAllKeys||this.aKeys.length>0||this.iLength>0){this.aAllKeys=null;this.aKeys=[];this.iLength=0;this.bLengthFinal=true;this._fireChange({reason:o.Context})}return}this._initSortersFilters();if(this.checkExpandedList()&&!n){this._fireChange({reason:o.Context})}else{this._refresh()}}};p.prototype.checkExpandedList=function(t){var e=!!this.oModel.resolve(this.sPath,this.oContext),s=this.oModel._getObject(this.sPath,this.oContext);if(!e||s===undefined||this.sOperationMode===h.Server&&(this.aApplicationFilters.length>0||this.aFilters.length>0||this.aSorters.length>0)){this.bUseExpandedList=false;this.aExpandRefs=undefined;return false}else{this.bUseExpandedList=true;if(Array.isArray(s)){if(!t&&(this.oModel._isReloadNeeded("/"+s[0],this.mParameters)||this.oModel._isReloadNeeded("/"+s[s.length-1],this.mParameters))){this.bUseExpandedList=false;this.aExpandRefs=undefined;return false}this.aExpandRefs=s;this.aAllKeys=s;this.iLength=s.length;this.bLengthFinal=true;this.bDataAvailable=true;this.applyFilter();this.applySort()}else{this.aExpandRefs=undefined;this.aAllKeys=null;this.aKeys=[];this.iLength=0;this.bLengthFinal=true;this.bDataAvailable=true}return true}};p.prototype.updateExpandedList=function(t){if(this.aExpandRefs){for(var e=0;e<t.length;e++){this.aExpandRefs[e]=t[e]}this.aExpandRefs.length=t.length}};p.prototype.useClientMode=function(){return this.sOperationMode===h.Client||this.sOperationMode===h.Auto&&!this.bThresholdRejected||this.sOperationMode!==h.Server&&this.bUseExpandedList};p.prototype.loadData=function(e,s){var i=this,a=false,r=t.sap.uid(),l;if(e||s){this.sRangeParams="$skip="+e+"&$top="+s;this.iStartIndex=e}else{e=this.iStartIndex}var u=[];if(this.sRangeParams&&!this.useClientMode()){u.push(this.sRangeParams)}if(this.sSortParams){u.push(this.sSortParams)}if(this.sFilterParams&&!this.useClientMode()){u.push(this.sFilterParams)}if(this.sCustomParams){u.push(this.sCustomParams)}if(this.sCountMode==n.InlineRepeat||!this.bLengthFinal&&(this.sCountMode===n.Inline||this.sCountMode===n.Both)){u.push("$inlinecount=allpages");a=true}function d(n){if(a&&n.__count){i.iLength=parseInt(n.__count,10);i.bLengthFinal=true;if(i.sOperationMode==h.Auto){if(i.iLength<=i.mParameters.threshold){i.bThresholdRejected=false}else{i.bThresholdRejected=true;delete i.mRequestHandles[r];i.bPendingRequest=false;i.bNeedsUpdate=true;return}}}if(i.useClientMode()){i.aKeys=[];t.each(n.results,function(t,e){i.aKeys[t]=i.oModel._getKey(e)});i.updateExpandedList(i.aKeys);i.aAllKeys=i.aKeys.slice();i.iLength=i.aKeys.length;i.bLengthFinal=true;i.applyFilter();i.applySort()}else{if(n.results.length>0){t.each(n.results,function(t,s){i.aKeys[e+t]=i.oModel._getKey(s)});if(i.iLength<e+n.results.length){i.iLength=e+n.results.length;i.bLengthFinal=false}if(!n.__next&&(n.results.length<s||s===undefined)){i.iLength=e+n.results.length;i.bLengthFinal=true}}else{if(i.bFaultTolerant&&n.__next){i.iLength=e;i.bLengthFinal=true}if(e===0){i.iLength=0;i.aKeys=[];i.bLengthFinal=true}if(e===i.iLength){i.bLengthFinal=true}}}delete i.mRequestHandles[r];i.bPendingRequest=false;i.bNeedsUpdate=true;i.bIgnoreSuspend=true;i.oModel.callAfterUpdate(function(){i.fireDataReceived({data:n})})}function f(t){var e=t.statusCode==0;delete i.mRequestHandles[r];i.bPendingRequest=false;if(i.bFaultTolerant){i.iLength=i.aKeys.length;i.bLengthFinal=true;i.bDataAvailable=true}else if(!e){i.aKeys=[];i.aAllKeys=[];i.iLength=0;i.bLengthFinal=true;i.bDataAvailable=true;i._fireChange({reason:o.Change})}if(!i.bSkipDataEvents){i.fireDataReceived()}}var p=this.sPath,g=this.oContext;if(this.isRelative()){p=this.oModel.resolve(p,g)}if(p){this.bPendingRequest=true;if(!this.bSkipDataEvents){this.fireDataRequested()}this.bSkipDataEvents=false;l=this.sRefreshGroup?this.sRefreshGroup:this.sGroupId;this.mRequestHandles[r]=this.oModel.read(p,{groupId:l,urlParameters:u,success:d,error:f})}};p.prototype.isLengthFinal=function(){return this.bLengthFinal};p.prototype.getLength=function(){if(this.bLengthFinal||this.iLength==0){return this.iLength}else{var t=this.iLastThreshold||this.iLastLength||10;return this.iLength+t}};p.prototype._getLength=function(){var e=this;var s;if(this.sCountMode!==n.Request&&this.sCountMode!==n.Both){return}var i=[];if(this.sFilterParams&&this.sOperationMode!=h.Auto){i.push(this.sFilterParams)}if(this.mParameters&&this.mParameters.custom){var a={custom:{}};t.each(this.mParameters.custom,function(t,e){a.custom[t]=e});i.push(this.oModel.createCustomParams(a))}function r(t){e.iLength=parseInt(t,10);e.bLengthFinal=true;e.bLengthRequested=true;e.oCountHandle=null;if(e.sOperationMode==h.Auto){if(e.iLength<=e.mParameters.threshold){e.bThresholdRejected=false}else{e.bThresholdRejected=true}e._fireChange({reason:o.Change})}}function l(s){delete e.mRequestHandles[u];var i="Request for $count failed: "+s.message;if(s.response){i+=", "+s.response.statusCode+", "+s.response.statusText+", "+s.response.body}t.sap.log.warning(i)}var u=this.oModel.resolve(this.sPath,this.oContext);if(u){u=u+"/$count";s=this.sRefreshGroup?this.sRefreshGroup:this.sGroupId;this.oCountHandle=this.oModel.read(u,{withCredentials:this.oModel.bWithCredentials,groupId:s,urlParameters:i,success:r,error:l})}};p.prototype.refresh=function(t,e){if(typeof t==="string"){e=t;t=false}this.sRefreshGroup=e;this._refresh(t);this.sRefreshGroup=undefined};p.prototype._refresh=function(e,s,i){var a=false,n=this.isRelative()&&this.oContext&&this.oContext.bCreated;if(n){return}this.bPendingRefresh=false;if(!e){if(i){var r=this.oModel.resolve(this.sPath,this.oContext);if(r){var h=this.oModel.oMetadata._getEntityTypeByPath(r);if(h&&h.entityType in i){a=true}}}if(s&&!a){t.each(this.aKeys,function(t,e){if(e in s){a=true;return false}})}if(!s&&!i){a=true}}if(e||a){if(this.bSuspended&&!this.bIgnoreSuspend&&!e){this.bPendingRefresh=true;return}this.abortPendingRequest(true);this.resetData();this._fireRefresh({reason:o.Refresh})}};p.prototype._fireRefresh=function(t){if(this.oModel.resolve(this.sPath,this.oContext)){this.bRefresh=true;this.fireEvent("refresh",t)}};p.prototype._checkPathType=function(){var t=this.oModel.resolve(this.sPath,this.oContext);if(t){if(!this._mPathType||!this._mPathType[t]){this._mPathType={};var e=t.lastIndexOf("/");var s,i;if(e>1){i=this.oModel.oMetadata._getEntityTypeByPath(t.substring(0,e));if(i){s=this.oModel.oMetadata._getEntityAssociationEnd(i,t.substring(e+1));if(s&&s.multiplicity==="*"){this._mPathType[t]=true}}}else if(e===0){var a,n=t.substring(1);a=this.oModel.oMetadata._findEntitySetByName(n);if(a){this._mPathType[t]=true}}}return!!this._mPathType[t]}return true};p.prototype.initialize=function(){var e=this.isRelative()&&this.oContext&&this.oContext.bCreated;if(this.oModel.oMetadata&&this.oModel.oMetadata.isLoaded()&&this.bInitial&&!e){if(!this._checkPathType()){t.sap.log.error("List Binding is not bound against a list for "+this.oModel.resolve(this.sPath,this.oContext))}this.bInitial=false;this._initSortersFilters();if(!this.bSuspended){if(this.bDataAvailable){this._fireChange({reason:o.Change})}else{this._fireRefresh({reason:o.Refresh})}}}return this};p.prototype.checkUpdate=function(e,s){var i=this.sChangeReason?this.sChangeReason:o.Change,a=false,n,r=this,h;if(this.bSuspended&&!this.bIgnoreSuspend&&!e||this.bPendingRequest){return false}this.bIgnoreSuspend=false;if(this.bPendingRequest){return}if(!e&&!this.bNeedsUpdate){h=this.aExpandRefs;var l=this.aKeys.slice();var u=this.checkExpandedList(true);if(!u&&this.useClientMode()){this.applyFilter();this.applySort()}if(!t.sap.equal(h,this.aExpandRefs)){a=true}else if(s){if(this.aKeys.length!==l.length){a=true}else{for(var d in s){if(this.aKeys.indexOf(d)>-1||l.indexOf(d)>-1){a=true;break}}}}else{a=true}if(a&&this.aLastContexts){a=false;var f=this._getContexts(this.iLastStartIndex,this.iLastLength,this.iLastThreshold);if(this.aLastContexts.length!==f.length){a=true}else{t.each(this.aLastContextData,function(t,e){n=r.getContextData(f[t]);if(e!==n){a=true;return false}})}}}if(e||a||this.bNeedsUpdate){this.bNeedsUpdate=false;this._fireChange({reason:i})}this.sChangeReason=undefined};p.prototype.resetData=function(){this.aKeys=[];this.aAllKeys=null;this.iLength=0;this.bLengthFinal=false;this.sChangeReason=undefined;this.bDataAvailable=false;this.bLengthRequested=false;this.bThresholdRejected=false;if(this.sCountMode==n.None){this.bThresholdRejected=true}};p.prototype.abortPendingRequest=function(e){if(!t.isEmptyObject(this.mRequestHandles)){this.bSkipDataEvents=true;t.each(this.mRequestHandles,function(t,e){e.abort()});if(e&&this.oCountHandle){this.oCountHandle.abort()}this.mRequestHandles={};this.bPendingRequest=false}};p.prototype.getDownloadUrl=function(t){var e=[],s;if(t){e.push("$format="+encodeURIComponent(t))}if(this.sSortParams){e.push(this.sSortParams)}if(this.sFilterParams){e.push(this.sFilterParams)}if(this.sCustomParams){e.push(this.sCustomParams)}s=this.oModel.resolve(this.sPath,this.oContext);if(s){return this.oModel._createRequestUrl(s,null,e)}};p.prototype.sort=function(t,e){var s=false;this.bIgnoreSuspend=true;if(!t){t=[]}if(t instanceof d){t=[t]}this.aSorters=t;if(!this.useClientMode()){this.createSortParams(t)}if(!this.bInitial){this.addComparators(t,true);if(this.useClientMode()){if(this.aAllKeys){if(t.length==0){this.applyFilter()}else{this.applySort()}this._fireChange({reason:o.Sort})}else{this.sChangeReason=o.Sort}}else{this.aKeys=[];this.abortPendingRequest(false);this.sChangeReason=o.Sort;this._fireRefresh({reason:this.sChangeReason})}this._fireSort({sorter:t});s=true}if(e){return s}else{return this}};p.prototype.addComparators=function(e,s){var i,n,r=this.oEntityType,h;if(!r){t.sap.log.warning("Cannot determine sort/filter comparators, as entitytype of the collection is unkown!");return}e.forEach(function(e){if(e.aFilters){this.addComparators(e.aFilters)}else if(!e.fnCompare){i=this.oModel.oMetadata._getPropertyMetadata(r,e.sPath);n=i&&i.type;t.sap.assert(i,"PropertyType for property "+e.sPath+" of EntityType "+r.name+" not found!");h=a.getComparator(n);if(s){e.fnCompare=g(h)}else{e.fnCompare=h;c(n,e)}}}.bind(this))};function g(t){return function(e,s){if(e===s){return 0}if(e===null){return-1}if(s===null){return 1}return t(e,s)}}function c(t,e){switch(t){case"Edm.Decimal":case"Edm.Int64":if(typeof e.oValue1=="number"){e.oValue1=e.oValue1.toString()}if(typeof e.oValue2=="number"){e.oValue2=e.oValue2.toString()}break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.SByte":if(typeof e.oValue1=="string"){e.oValue1=parseInt(e.oValue1,10)}if(typeof e.oValue2=="string"){e.oValue2=parseInt(e.oValue2,10)}break;case"Edm.Float":case"Edm.Single":case"Edm.Double":if(typeof e.oValue1=="string"){e.oValue1=parseFloat(e.oValue1)}if(typeof e.oValue2=="string"){e.oValue2=parseFloat(e.oValue2)}break;default:}}p.prototype.applySort=function(){var t=this,e;this.aKeys=f.apply(this.aKeys,this.aSorters,function(s,i){e=t.oModel.getContext("/"+s);return t.oModel.getProperty(i,e)})};p.prototype.createSortParams=function(t){this.sSortParams=a.createSortParams(t)};p.prototype.filter=function(t,e,i){var a=false;this.bIgnoreSuspend=true;if(!t){t=[]}if(t instanceof l){t=[t]}this.oModel.checkFilterOperation(t);if(e===s.Application){this.aApplicationFilters=t}else{this.aFilters=t}t=this.aFilters.concat(this.aApplicationFilters);if(!t||!Array.isArray(t)||t.length===0){this.aFilters=[];this.aApplicationFilters=[]}if(!this.useClientMode()){this.createFilterParams(t)}if(!this.bInitial){this.addComparators(this.aFilters);this.addComparators(this.aApplicationFilters);if(this.useClientMode()){if(this.aAllKeys){this.applyFilter();this.applySort();this._fireChange({reason:o.Filter})}else{this.sChangeReason=o.Filter}}else{this.resetData();this.abortPendingRequest(true);this.sChangeReason=o.Filter;this._fireRefresh({reason:this.sChangeReason})}if(e===s.Application){this._fireFilter({filters:this.aApplicationFilters})}else{this._fireFilter({filters:this.aFilters})}a=true}if(i){return a}else{return this}};p.prototype.applyFilter=function(){var e=this,s,i=this.aFilters.concat(this.aApplicationFilters),a=[];t.each(i,function(t,e){if(e instanceof r){a.push(e.convert())}else{a.push(e)}});this.aKeys=u.apply(this.aAllKeys,a,function(t,i){s=e.oModel.getContext("/"+t);return e.oModel.getProperty(i,s)});this.iLength=this.aKeys.length};p.prototype.createFilterParams=function(t){this.sFilterParams=a.createFilterParams(t,this.oModel.oMetadata,this.oEntityType)};p.prototype._initSortersFilters=function(){var t=this.oModel.resolve(this.sPath,this.oContext);if(!t){return}this.oEntityType=this._getEntityType();this.addComparators(this.aSorters,true);this.addComparators(this.aFilters);this.addComparators(this.aApplicationFilters);if(!this.useClientMode()){this.createSortParams(this.aSorters);this.createFilterParams(this.aFilters.concat(this.aApplicationFilters))}};p.prototype._getEntityType=function(){var e=this.oModel.resolve(this.sPath,this.oContext);if(e){var s=this.oModel.oMetadata._getEntityTypeByPath(e);t.sap.assert(s,"EntityType for path "+e+" could not be found!");return s}return undefined};p.prototype.resume=function(){this.bIgnoreSuspend=false;this.bSuspended=false;if(this.bPendingRefresh){this._refresh()}else{this.checkUpdate()}};p.prototype.suspend=function(){if(this.bInitial){this.bPendingRefresh=true}i.prototype.suspend.apply(this,arguments)};return p});