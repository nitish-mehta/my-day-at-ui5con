/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/Device"],function(e,t){"use strict";var a={EnumMember:true,Path:true,PropertyPath:true,NavigationPropertyPath:true,AnnotationPath:true};var r={Binary:true,Bool:true,Date:true,DateTimeOffset:true,Decimal:true,Duration:true,Float:true,Guid:true,Int:true,String:true,TimeOfDay:true,LabelElementReference:true,EnumMember:true,Path:true,PropertyPath:true,NavigationPropertyPath:true,AnnotationPath:true};var n={And:true,Or:true,Eq:true,Ne:true,Gt:true,Ge:true,Lt:true,Le:true,If:true,Collection:true};var o={merge:function(e,t){var a,r;var n=["annotationsAtArrays","propertyAnnotations","EntityContainer","annotationReferences"];for(a in t){if(n.indexOf(a)!==-1){continue}o._mergeAnnotation(a,t,e)}for(var i=1;i<n.length;++i){var s=n[i];e[s]=e[s]||{};for(a in t[s]){for(r in t[s][a]){e[s][a]=e[s][a]||{};o._mergeAnnotation(r,t[s][a],e[s][a])}}}if(t.annotationsAtArrays){e.annotationsAtArrays=(e.annotationsAtArrays||[]).concat(t.annotationsAtArrays)}},_mergeAnnotation:function(e,t,a){if(Array.isArray(t[e])){a[e]=t[e].slice(0)}else{a[e]=a[e]||{};for(var r in t[e]){a[e][r]=t[e][r]}}},parse:function(t,a,r){var n={},i,s,l,p,u,f,d,c,m,h,y,v,g,A,N,P,x,_,D,b,T,V,E,X=[];o._parserData={};o._oXPath=o.getXPath();o._parserData.metadataInstance=t;o._parserData.serviceMetadata=t.getServiceMetadata();o._parserData.xmlDocument=o._oXPath.setNameSpace(a);o._parserData.schema={};o._parserData.aliases={};o._parserData.url=r?r:"metadata document";o._parserData.annotationsAtArrays=X;i=o._oXPath.selectNodes("//d:Schema",o._parserData.xmlDocument);for(V=0;V<i.length;V+=1){s=o._oXPath.nextNode(i,V);o._parserData.schema.Alias=s.getAttribute("Alias");o._parserData.schema.Namespace=s.getAttribute("Namespace")}var C={};var S=o._parseReferences(C);if(S){n.annotationReferences=C;n.aliasDefinitions=o._parserData.aliases}l=o._oXPath.selectNodes("//d:Term",o._parserData.xmlDocument);if(l.length>0){p={};for(E=0;E<l.length;E+=1){u=o._oXPath.nextNode(l,E);f=o.replaceWithAlias(u.getAttribute("Type"));p["@"+o._parserData.schema.Alias+"."+u.getAttribute("Name")]=f}n.termDefinitions=p}o._parserData.metadataProperties=o.getAllPropertiesMetadata(o._parserData.serviceMetadata);if(o._parserData.metadataProperties.extensions){n.propertyExtensions=o._parserData.metadataProperties.extensions}d=o._oXPath.selectNodes("//d:Annotations ",o._parserData.xmlDocument);for(E=0;E<d.length;E+=1){c=o._oXPath.nextNode(d,E);if(c.hasChildNodes()===false){continue}m=c.getAttribute("Target");h=m.split(".")[0];if(h&&o._parserData.aliases[h]){m=m.replace(new RegExp(h,""),o._parserData.aliases[h])}y=m;v=null;var O=null;if(m.indexOf("/")>0){y=m.split("/")[0];var R=o._parserData.serviceMetadata.dataServices&&o._parserData.serviceMetadata.dataServices.schema&&o._parserData.serviceMetadata.dataServices.schema.length;if(R){for(var F=o._parserData.serviceMetadata.dataServices.schema.length-1;F>=0;F--){var M=o._parserData.serviceMetadata.dataServices.schema[F];if(M.entityContainer){var W=y.split(".");for(var w=M.entityContainer.length-1;w>=0;w--){if(M.entityContainer[w].name===W[W.length-1]){O=m.replace(y+"/","");break}}}}}if(!O){v=m.replace(y+"/","")}}if(v){if(!n.propertyAnnotations){n.propertyAnnotations={}}if(!n.propertyAnnotations[y]){n.propertyAnnotations[y]={}}if(!n.propertyAnnotations[y][v]){n.propertyAnnotations[y][v]={}}g=o._oXPath.selectNodes("./d:Annotation",c);for(var k=0;k<g.length;k+=1){A=o._oXPath.nextNode(g,k);N=o.replaceWithAlias(A.getAttribute("Term"));var I=c.getAttribute("Qualifier")||A.getAttribute("Qualifier");if(I){N+="#"+I}if(A.hasChildNodes()===false){var L={};o.enrichFromPropertyValueAttributes(L,A);if(e.isEmptyObject(L)){L.Bool="true"}n.propertyAnnotations[y][v][N]=L}else{n.propertyAnnotations[y][v][N]=o.getPropertyValue(A)}}}else{var Q;if(O){if(!n["EntityContainer"]){n["EntityContainer"]={}}if(!n["EntityContainer"][y]){n["EntityContainer"][y]={}}Q=n["EntityContainer"][y]}else{if(!n[y]){n[y]={}}Q=n[y]}P=y.replace(o._parserData.aliases[h],h);g=o._oXPath.selectNodes("./d:Annotation",c);for(var j=0;j<g.length;j+=1){A=o._oXPath.nextNode(g,j);var B=Q;if(O){if(!Q[O]){Q[O]={}}B=Q[O]}o._parseAnnotation(y,c,A,B)}x=o._oXPath.selectNodes("//d:Annotations[contains(@Target, '"+P+"')]//d:PropertyValue[contains(@Path, '/')]//@Path",o._parserData.xmlDocument);for(V=0;V<x.length;V+=1){_=o._oXPath.nextNode(x,V);D=_.value;if(n.propertyAnnotations){if(n.propertyAnnotations[y]){if(n.propertyAnnotations[y][D]){continue}}}b=D.split("/");if(o.findNavProperty(y,b[0])){if(!n.expand){n.expand={}}if(!n.expand[y]){n.expand[y]={}}n.expand[y][b[0]]=b[0]}}T=o._oXPath.selectNodes("//d:Annotations[contains(@Target, '"+P+"')]//d:Path[contains(., '/')]",o._parserData.xmlDocument);for(V=0;V<T.length;V+=1){_=o._oXPath.nextNode(T,V);D=o._oXPath.getNodeText(_);if(n.propertyAnnotations&&n.propertyAnnotations[y]&&n.propertyAnnotations[y][D]){continue}if(!n.expand){n.expand={}}if(!n.expand[y]){n.expand[y]={}}b=D.split("/");if(o.findNavProperty(y,b[0])){if(!n.expand){n.expand={}}if(!n.expand[y]){n.expand[y]={}}n.expand[y][b[0]]=b[0]}}}}if(X.length){n.annotationsAtArrays=X.map(function(e){return o.backupAnnotationAtArray(e,n)})}delete o._parserData;return n},backupAnnotationAtArray:function(e,t){var a=e,r,n,i=[];function s(){return Array.prototype.filter.call(e.parentNode.childNodes,function(e){return e.nodeType===1}).indexOf(e)}while(a.nodeName!=="Annotations"){a=a.parentNode}r=a.getAttribute("Qualifier");while(e!==a){switch(e.nodeName){case"Annotation":n=e.getAttribute("Qualifier")||r;i.unshift(e.getAttribute("Term")+(n?"#"+n:""));break;case"Collection":break;case"PropertyValue":i.unshift(e.getAttribute("Property"));break;case"Record":if(e.parentNode.nodeName==="Collection"){i.unshift(s())}break;default:if(e.parentNode.nodeName==="Apply"){i.unshift("Value");i.unshift(s());i.unshift("Parameters")}else{i.unshift(e.nodeName)}break}e=e.parentNode}i.unshift(a.getAttribute("Target"));i=i.map(function(e){return typeof e==="string"?o.replaceWithAlias(e):e});o.syncAnnotationsAtArrays(t,i,true);return i},restoreAnnotationsAtArrays:function(e){if(e.annotationsAtArrays){e.annotationsAtArrays.forEach(function(t){o.syncAnnotationsAtArrays(e,t)})}},syncAnnotationsAtArrays:function(t,a,r){var n,o=a.length-2,i=a[o+1],s=t,l=a[o],p=l+"@"+i;for(n=0;n<o;n+=1){s=s&&s[a[n]]}if(s&&Array.isArray(s[l])){if(!(p in s)){s[p]=s[l][i]}if(!(i in s[l])){s[l][i]=s[p]}}else if(r){e.sap.log.warning("Wrong path to annotation at array",a,"sap.ui.model.odata.AnnotationParser")}},_parseAnnotation:function(e,t,a,r){var n=a.getAttribute("Qualifier")||t.getAttribute("Qualifier");var i=o.replaceWithAlias(a.getAttribute("Term"));if(n){i+="#"+n}var s=o.getPropertyValue(a,e);s=o.setEdmTypes(s,o._parserData.metadataProperties.types,e,o._parserData.schema);r[i]=s;if(Array.isArray(r)){o._parserData.annotationsAtArrays.push(a)}},_parseReferences:function(e){var t=false;var a,r;var n=o._oXPath;var i="//edmx:Reference/edmx:Include[@Namespace and @Alias]";var s=n.selectNodes(i,o._parserData.xmlDocument);for(r=0;r<s.length;++r){t=true;a=n.nextNode(s,r);o._parserData.aliases[a.getAttribute("Alias")]=a.getAttribute("Namespace")}var l="//edmx:Reference[@Uri]/edmx:IncludeAnnotations[@TermNamespace]";var p=n.selectNodes(l,o._parserData.xmlDocument);for(r=0;r<p.length;++r){t=true;a=n.nextNode(p,r);var u=a.getAttribute("TermNamespace");var f=a.getAttribute("TargetNamespace");var d=a.parentNode.getAttribute("Uri");if(f){if(!e[f]){e[f]={}}e[f][u]=d}else{e[u]=d}}return t},getAllPropertiesMetadata:function(e){var t={},a={},r={},n=false,o,i,s,l={},p={},u={},f=false,d,c,m,h,y,v={types:a};if(!e.dataServices.schema){return v}for(var g=e.dataServices.schema.length-1;g>=0;g-=1){t=e.dataServices.schema[g];if(t.entityType){o=t.namespace;i=t.entityType;s=t.complexType;for(var A=0;A<i.length;A+=1){l=i[A];u={};p={};if(l.property){for(var N=0;N<l.property.length;N+=1){d=l.property[N];if(d.type.substring(0,o.length)===o){if(s){for(var P=0;P<s.length;P+=1){if(s[P].name===d.type.substring(o.length+1)){if(s[P].property){for(var x=0;x<s[P].property.length;x+=1){c=s[P].property[x];p[s[P].name+"/"+c.name]=c.type}}}}}}else{m=d.name;h=d.type;if(d.extensions){for(var _=0;_<d.extensions.length;_+=1){y=d.extensions[_];if(y.name==="display-format"&&y.value==="Date"){h="Edm.Date"}else{f=true;if(!u[m]){u[m]={}}if(y.namespace&&!u[m][y.namespace]){u[m][y.namespace]={}}u[m][y.namespace][y.name]=y.value}}}p[m]=h}}}if(!a[o+"."+l.name]){a[o+"."+l.name]={}}a[o+"."+l.name]=p;if(f){if(!r[o+"."+l.name]){n=true}r[o+"."+l.name]={};r[o+"."+l.name]=u}}}}if(n){v={types:a,extensions:r}}return v},setEdmTypes:function(e,t,a,r){function n(n){var i,s="";if(e[n]){i=e[n];if(i.Value&&i.Value.Path){s=o.getEdmType(i.Value.Path,t,a,r);if(s){e[n].EdmType=s}}else if(i.Path){s=o.getEdmType(i.Path,t,a,r);if(s){e[n].EdmType=s}}else if(i.Facets){e[n].Facets=o.setEdmTypes(i.Facets,t,a,r)}else if(i.Data){e[n].Data=o.setEdmTypes(i.Data,t,a,r)}else if(n==="Data"){e.Data=o.setEdmTypes(i,t,a,r)}else if(i.Value&&i.Value.Apply){e[n].Value.Apply.Parameters=o.setEdmTypes(i.Value.Apply.Parameters,t,a,r)}else if(i.Value&&i.Type&&i.Type==="Path"){s=o.getEdmType(i.Value,t,a,r);if(s){e[n].EdmType=s}}}}if(Array.isArray(e)){for(var i=0;i<e.length;i+=1){n(i)}}else{for(var s in e){n(s)}}return e},getEdmType:function(e,t,a,r){var n=e.indexOf("/");if(n>-1){var i=e.substr(0,n);var s=o.findNavProperty(a,i);if(s){var l=o._parserData.metadataInstance._getEntityTypeByNavPropertyObject(s);if(l){a=l.entityType;e=e.substr(n+1)}}}if(e.charAt(0)==="@"&&e.indexOf(r.Alias)===1){e=e.slice(r.Alias.length+2)}if(e.indexOf("/")>=0){if(t[e.slice(0,e.indexOf("/"))]){a=e.slice(0,e.indexOf("/"));e=e.slice(e.indexOf("/")+1)}}return t[a]&&t[a][e]},enrichFromPropertyValueAttributes:function(e,t){var a={Property:true,Qualifier:true,Term:true,xmlns:true};for(var r=0;r<t.attributes.length;r+=1){var n=t.attributes[r].name;if(!a[n]&&n.indexOf("xmlns:")!==0){var i=t.attributes[r].value;if(n==="EnumMember"&&i.indexOf(" ")>-1){var s=i.split(" ");e[n]=s.map(o.replaceWithAlias).join(" ")}else{e[n]=o.replaceWithAlias(i)}}}return e},_getRecordValues:function(e){var t=[];var a=o._oXPath;for(var r=0;r<e.length;++r){var n=a.nextNode(e,r);var i=o.getPropertyValues(n);var s=n.getAttribute("Type");if(s){i["RecordType"]=o.replaceWithAlias(s)}t.push(i)}return t},_getTextValues:function(e){var t=[];var a=o._oXPath;for(var r=0;r<e.length;r+=1){var n=a.nextNode(e,r);var i={};var s=a.getNodeText(n);i[n.nodeName]=o._parserData.aliases?o.replaceWithAlias(s):s;t.push(i)}return t},_getTextValue:function(e){var t=o._oXPath;var r="";if(e.nodeName in a){r=o.replaceWithAlias(t.getNodeText(e))}else{r=t.getNodeText(e)}if(e.nodeName!=="String"){r=r.trim()}return r},getPropertyValue:function(t,a){var i;var s=o._oXPath;var l=t.nodeName==="Collection"?[]:{};if(t.hasChildNodes()){var p=s.selectNodes("./d:Record",t);var u=o._getRecordValues(p);var f=s.selectNodes("./d:Collection/d:Record | ./d:Collection/d:If/d:Record",t);var d=o._getRecordValues(f);var c=u.concat(d);if(c.length>0){if(f.length===0&&p.length>0){l=c[0]}else{l=c}}else{var m=s.selectNodes("./d:Collection/d:AnnotationPath | ./d:Collection/d:NavigationPropertyPath | ./d:Collection/d:PropertyPath",t);if(m.length>0){l=o._getTextValues(m)}else{var h=s.selectNodes('./d:*[not(local-name() = "Annotation")]',t);if(h.length>0){for(i=0;i<h.length;i++){var y=s.nextNode(h,i);var v;var g=y.nodeName;var A=y.parentNode.nodeName;if(g==="Apply"){v=o.getApplyFunctions(y)}else{v=o.getPropertyValue(y)}if(n[A]){if(!Array.isArray(l)){l=[]}var N={};N[g]=v;l.push(N)}else if(g==="Collection"){l=v}else{if(l[g]){e.sap.log.warning("Annotation contained multiple "+g+" values. Only the last "+"one will be stored: "+s.getPath(y))}l[g]=v}}o.enrichFromPropertyValueAttributes(l,t)}else if(t.nodeName in r){l=o._getTextValue(t)}else{o.enrichFromPropertyValueAttributes(l,t)}}}var P=s.selectNodes("./d:Annotation",t);if(P.length>0){for(i=0;i<P.length;i++){var x=s.nextNode(P,i);o._parseAnnotation(a,t,x,l)}}}else if(t.nodeName in r){l=o._getTextValue(t)}else if(t.nodeName.toLowerCase()==="null"){l=null}else{o.enrichFromPropertyValueAttributes(l,t)}return l},getPropertyValues:function(t){var a={},r;var n=o._oXPath;var i=n.selectNodes("./d:Annotation",t);var s=n.selectNodes("./d:PropertyValue",t);function l(e,t,a){var r,n=e;while(n.nodeName!=="Annotation"){n=n.parentNode}r=n.parentNode;return t+" '"+a+"' is defined twice; "+"Source = "+o._parserData.url+", Annotation Target = "+r.getAttribute("Target")+", Term = "+n.getAttribute("Term")}if(i.length===0&&s.length===0){a=o.getPropertyValue(t)}else{for(r=0;r<i.length;r++){var p=n.nextNode(i,r);var u=o.replaceWithAlias(p.getAttribute("Term"));e.sap.assert(!a[u],function(){return l(t,"Annotation",u)});a[u]=o.getPropertyValue(p)}for(r=0;r<s.length;r++){var f=n.nextNode(s,r);var d=f.getAttribute("Property");e.sap.assert(!a[d],function(){return l(t,"Property",d)});a[d]=o.getPropertyValue(f);var c=n.selectNodes("./d:Apply",f);for(var m=0;m<c.length;m+=1){var h=n.nextNode(c,m);a[d]={};a[d]["Apply"]=o.getApplyFunctions(h)}}}return a},getApplyFunctions:function(e){var t=o._oXPath;var a={Name:e.getAttribute("Function"),Parameters:[]};var r=t.selectNodes("./d:*",e);for(var i=0;i<r.length;i+=1){var s=t.nextNode(r,i);var l={Type:s.nodeName};if(s.nodeName==="Apply"){l.Value=o.getApplyFunctions(s)}else if(s.nodeName==="LabeledElement"){l.Value=o.getPropertyValue(s);l.Name=l.Value.Name;delete l.Value.Name}else if(n[s.nodeName]){l.Value=o.getPropertyValue(s)}else{l.Value=t.getNodeText(s)}a.Parameters.push(l)}return a},findNavProperty:function(e,t){var a=o._parserData.serviceMetadata;for(var r=a.dataServices.schema.length-1;r>=0;r-=1){var n=a.dataServices.schema[r];if(n.entityType){var i=n.namespace+".";var s=n.entityType;for(var l=s.length-1;l>=0;l-=1){if(i+s[l].name===e&&s[l].navigationProperty){for(var p=0;p<s[l].navigationProperty.length;p+=1){if(s[l].navigationProperty[p].name===t){return s[l].navigationProperty[p]}}}}}}return null},replaceWithAlias:function(e,t){if(t===undefined){t=1}for(var a in o._parserData.aliases){if(e.indexOf(a+".")>=0&&e.indexOf("."+a+".")<0){e=e.replace(a+".",o._parserData.aliases[a]+".");t--;if(t===0){return e}}}return e},getXPath:function(){var a={};var r=o._parserData;if(t.browser.msie){a={setNameSpace:function(e){e.setProperty("SelectionNamespaces",'xmlns:edmx="http://docs.oasis-open.org/odata/ns/edmx" xmlns:d="http://docs.oasis-open.org/odata/ns/edm"');e.setProperty("SelectionLanguage","XPath");return e},selectNodes:function(e,t){return t.selectNodes(e)},nextNode:function(e){return e.nextNode()},getNodeText:function(e){return e.text}}}else{a={setNameSpace:function(e){return e},nsResolver:function(e){var t={edmx:"http://docs.oasis-open.org/odata/ns/edmx",d:"http://docs.oasis-open.org/odata/ns/edm"};return t[e]||null},selectNodes:function(e,t){var a=r.xmlDocument.evaluate(e,t,this.nsResolver,7,null);a.length=a.snapshotLength;return a},nextNode:function(e,t){return e.snapshotItem(t)},getNodeText:function(e){return e.textContent}}}a.getPath=function(t){var r="";var n="getAttribute"in t?t.getAttribute("id"):"";var o=t.tagName?t.tagName:"";if(n){r='id("'+n+'")'}else if(t instanceof Document){r="/"}else if(o.toLowerCase()==="body"){r=o}else if(t.parentNode){var i=1;for(var s=0;s<t.parentNode.childNodes.length;++s){if(t.parentNode.childNodes[s]===t){r=a.getPath(t.parentNode)+"/"+o+"["+i+"]";break}else if(t.parentNode.childNodes[s].nodeType===1&&t.parentNode.childNodes[s].tagName===o){++i}}}else{e.sap.log.error("Wrong Input node - cannot find XPath to it: "+o)}return r};return a}};return o});