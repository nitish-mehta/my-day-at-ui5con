/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./_AnnotationHelperBasics"],function(e,a){"use strict";var t={Bool:"false"},i={Bool:"true"},n={fiscalyear:"IsFiscalYear",fiscalyearperiod:"IsFiscalYearPeriod",year:"IsCalendarYear",yearmonth:"IsCalendarYearMonth",yearmonthday:"IsCalendarDate",yearquarter:"IsCalendarYearQuarter",yearweek:"IsCalendarYearWeek"},r={interval:"SingleInterval","multi-value":"MultiValue","single-value":"SingleValue"},o="sap.ui.model.odata.ODataMetaModel",s={bday:"Contact",city:"Contact/adr",country:"Contact/adr",email:"Contact/email",familyname:"Contact/n",givenname:"Contact/n",honorific:"Contact/n",middlename:"Contact/n",name:"Contact",nickname:"Contact",note:"Contact",org:"Contact","org-role":"Contact","org-unit":"Contact",photo:"Contact",pobox:"Contact/adr",region:"Contact/adr",street:"Contact/adr",suffix:"Contact/n",tel:"Contact/tel",title:"Contact",zip:"Contact/adr",class:"Event",dtend:"Event",dtstart:"Event",duration:"Event",fbtype:"Event",location:"Event",status:"Event",transp:"Event",wholeday:"Event",body:"Message",from:"Message",received:"Message",sender:"Message",subject:"Message",completed:"Task",due:"Task","percent-complete":"Task",priority:"Task"},l=/(\w+)(?:;type=([\w,]+))?/,c={email:{typeMapping:{home:"home",pref:"preferred",work:"work"},v4EnumType:"com.sap.vocabularies.Communication.v1.ContactInformationType",v4PropertyAnnotation:"com.sap.vocabularies.Communication.v1.IsEmailAddress"},tel:{typeMapping:{cell:"cell",fax:"fax",home:"home",pref:"preferred",video:"video",voice:"voice",work:"work"},v4EnumType:"com.sap.vocabularies.Communication.v1.PhoneType",v4PropertyAnnotation:"com.sap.vocabularies.Communication.v1.IsPhoneNumber"}},p={creatable:{"Org.OData.Capabilities.V1.InsertRestrictions":{Insertable:t}},pageable:{"Org.OData.Capabilities.V1.SkipSupported":t,"Org.OData.Capabilities.V1.TopSupported":t},"requires-filter":{"Org.OData.Capabilities.V1.FilterRestrictions":{RequiresFilter:i}},topable:{"Org.OData.Capabilities.V1.TopSupported":t}},u={city:"locality",email:"address",familyname:"surname",givenname:"given",honorific:"prefix",middlename:"additional",name:"fn","org-role":"role","org-unit":"orgunit","percent-complete":"percentcomplete",tel:"uri",zip:"code"},f={"sap:filterable":["Org.OData.Capabilities.V1.FilterRestrictions","NonFilterableProperties"],"sap:required-in-filter":["Org.OData.Capabilities.V1.FilterRestrictions","RequiredProperties"],"sap:sortable":["Org.OData.Capabilities.V1.SortRestrictions","NonSortableProperties"]},m=/^com\.sap\.vocabularies\.Common\.v1\.ValueList(#.*)?$/,d=e.sap.log.Level.WARNING,v;v={addEntitySetAnnotation:function(a,t,i,n,r){if(i==="EntitySet"&&t.value===n){if(r){e.extend(true,a,p[t.name])}else{e.extend(a,p[t.name])}}},addFilterRestriction:function(a,t){var i,n=r[a["sap:filter-restriction"]];if(!n){if(e.sap.log.isLoggable(d,o)){e.sap.log.warning("Unsupported sap:filter-restriction: "+a["sap:filter-restriction"],t.entityType+"."+a.name,o)}return}i=t["com.sap.vocabularies.Common.v1.FilterExpressionRestrictions"]||[];i.push({Property:{PropertyPath:a.name},AllowedExpressions:{EnumMember:"com.sap.vocabularies.Common.v1.FilterExpressionType/"+n}});t["com.sap.vocabularies.Common.v1.FilterExpressionRestrictions"]=i},addNavigationFilterRestriction:function(e,a){var i=a["Org.OData.Capabilities.V1.NavigationRestrictions"]||{};i.RestrictedProperties=i.RestrictedProperties||[];i.RestrictedProperties.push({FilterRestrictions:{Filterable:t},NavigationProperty:{NavigationPropertyPath:e.name}});a["Org.OData.Capabilities.V1.NavigationRestrictions"]=i},addPropertyToAnnotation:function(e,a,t){var i=f[e],n=i[0],r=i[1],o=a[n]||{},s=o[r]||[];s.push({PropertyPath:t.name});o[r]=s;a[n]=o},addSapSemantics:function(a){if(a.property){a.property.forEach(function(t){var r,p,f,m,b,g=t["sap:semantics"],y,h,C,P,O;if(!g){return}if(g==="url"){t["Org.OData.Core.V1.IsURL"]=i;return}if(g in n){y="com.sap.vocabularies.Common.v1."+n[g];t[y]=i;return}f=l.exec(g);if(!f){if(e.sap.log.isLoggable(d,o)){e.sap.log.warning("Unsupported sap:semantics: "+g,a.name+"."+t.name,o)}return}if(f[2]){g=f[1];O=v.getV4TypesForV2Semantics(g,f[2],t,a)}P=c[g];p=g==="tel"||g==="email";h=s[g];if(h){r=h.split("/");y="com.sap.vocabularies.Communication.v1."+r[0];a[y]=a[y]||{};C=a[y];m=r[1];if(m){C[m]=C[m]||(p?[]:{});if(p){b={};C[m].push(b);C=b}else{C=C[m]}}C[u[g]||g]={Path:t.name};if(O){C.type={EnumMember:O}}}if(P){t[P.v4PropertyAnnotation]=t[P.v4PropertyAnnotation]||i}})}},addUnitAnnotations:function(t,i){function n(t){(t||[]).forEach(function(t){(t.property||[]).forEach(function(n){var r,s,l,c,p=n["sap:unit"],u;if(p){c={Path:p};l=a.followPath({getModel:function(){return i},getPath:function(){return t.$path}},c);if(l&&l.resolvedPath){u=i.getProperty(l.resolvedPath);s=u["sap:semantics"];if(s==="unit-of-measure"){r="Org.OData.Measures.V1.Unit"}else if(s==="currency-code"){r="Org.OData.Measures.V1.ISOCurrency"}else if(e.sap.log.isLoggable(d,o)){e.sap.log.warning("Unsupported sap:semantics='"+s+"' at sap:unit='"+p+"'; "+"expected 'currency-code' or 'unit-of-measure'",t.namespace+"."+t.name+"/"+n.name,o)}if(r&&!(r in n)){n[r]=c}}else if(e.sap.log.isLoggable(d,o)){e.sap.log.warning("Path '"+p+"' for sap:unit cannot be resolved",t.namespace+"."+t.name+"/"+n.name,o)}}})})}t.forEach(function(e){n(e.complexType);n(e.entityType)})},addV4Annotation:function(e,a,t){switch(a.name){case"aggregation-role":if(a.value==="dimension"){e["com.sap.vocabularies.Analytics.v1.Dimension"]=i}else if(a.value==="measure"){e["com.sap.vocabularies.Analytics.v1.Measure"]=i}break;case"display-format":if(a.value==="NonNegative"){e["com.sap.vocabularies.Common.v1.IsDigitSequence"]=i}else if(a.value==="UpperCase"){e["com.sap.vocabularies.Common.v1.IsUpperCase"]=i}break;case"pageable":case"topable":v.addEntitySetAnnotation(e,a,t,"false",false);break;case"creatable":v.addEntitySetAnnotation(e,a,t,"false",true);break;case"deletable":case"deletable-path":v.handleXableAndXablePath(e,a,t,"Org.OData.Capabilities.V1.DeleteRestrictions","Deletable");break;case"updatable":case"updatable-path":v.handleXableAndXablePath(e,a,t,"Org.OData.Capabilities.V1.UpdateRestrictions","Updatable");break;case"requires-filter":v.addEntitySetAnnotation(e,a,t,"true",true);break;case"field-control":e["com.sap.vocabularies.Common.v1.FieldControl"]={Path:a.value};break;case"heading":e["com.sap.vocabularies.Common.v1.Heading"]={String:a.value};break;case"label":e["com.sap.vocabularies.Common.v1.Label"]={String:a.value};break;case"precision":e["Org.OData.Measures.V1.Scale"]={Path:a.value};break;case"quickinfo":e["com.sap.vocabularies.Common.v1.QuickInfo"]={String:a.value};break;case"text":e["com.sap.vocabularies.Common.v1.Text"]={Path:a.value};break;case"visible":if(a.value==="false"){e["com.sap.vocabularies.Common.v1.FieldControl"]={EnumMember:"com.sap.vocabularies.Common.v1.FieldControlType/Hidden"};e["com.sap.vocabularies.UI.v1.Hidden"]=i}break;default:}},calculateEntitySetAnnotations:function(e,a){if(a.property){a.property.forEach(function(a){if(a["sap:filterable"]==="false"){v.addPropertyToAnnotation("sap:filterable",e,a)}if(a["sap:required-in-filter"]==="true"){v.addPropertyToAnnotation("sap:required-in-filter",e,a)}if(a["sap:sortable"]==="false"){v.addPropertyToAnnotation("sap:sortable",e,a)}if(a["sap:filter-restriction"]){v.addFilterRestriction(a,e)}})}if(a.navigationProperty){a.navigationProperty.forEach(function(a){if(a["sap:filterable"]==="false"){v.addNavigationFilterRestriction(a,e);v.addPropertyToAnnotation("sap:filterable",e,a)}v.handleCreatableNavigationProperty(e,a)})}},findIndex:function(e,a,t){var i,n;t=t||"name";if(e){for(i=0,n=e.length;i<n;i++){if(e[i][t]===a){return i}}}return-1},findObject:function(e,a,t){var i=v.findIndex(e,a,t);return i<0?null:e[i]},getChildAnnotations:function(e,a,t){var i=t?e.EntityContainer:e.propertyAnnotations;return i&&i[a]||{}},getFromContainer:function(e,a,t,i){var n,r=i?undefined:null;if(e){n=v.findIndex(e[a],t);if(n>=0){r=i?e.$path+"/"+a+"/"+n:e[a][n]}}return r},getObject:function(e,a,t,i){var n,r=i?undefined:null,o,s,l,c;t=t||"";s=t.lastIndexOf(".");l=t.slice(0,s);c=t.slice(s+1);o=v.getSchema(e,l);if(o){n=o[a];if(n){n.forEach(function(e){if(e.name===c){r=i?e.$path:e;return false}})}}return r},getSchema:function(e,a){var t=null,i=Array.isArray(e)?e:e.getObject("/dataServices/schema");if(i){i.forEach(function(e){if(e.namespace===a){t=e;return false}})}return t},getV4TypesForV2Semantics:function(a,t,i,n){var r=[],s=c[a];if(s){t.split(",").forEach(function(a){var t=s.typeMapping[a];if(t){r.push(s.v4EnumType+"/"+t)}else if(e.sap.log.isLoggable(d,o)){e.sap.log.warning("Unsupported type for sap:semantics: "+a,n.name+"."+i.name,o)}})}return r.join(" ")},getValueLists:function(e){var a,t,i,n={};for(t in e){a=m.exec(t);if(a){i=(a[1]||"").slice(1);n[i]=e[t]}}return n},handleCreatableNavigationProperty:function(a,t){var i=t["sap:creatable"],n=t["sap:creatable-path"],r,s={NavigationPropertyPath:t.name},l;if(i&&n){e.sap.log.warning("Inconsistent service","Use either 'sap:creatable' or 'sap:creatable-path' at navigation property "+"'"+a.entityType+"/"+t.name+"'",o);i="false";n=undefined}if(i==="false"||n){r=a["Org.OData.Capabilities.V1.InsertRestrictions"]=a["Org.OData.Capabilities.V1.InsertRestrictions"]||{};l=r["NonInsertableNavigationProperties"]=r["NonInsertableNavigationProperties"]||[];if(n){s={If:[{Not:{Path:n}},s]}}l.push(s)}},handleXableAndXablePath:function(a,i,n,r,s){var l=s.toLowerCase(),c;if(n!=="EntitySet"){return}if(a["sap:"+l]&&a["sap:"+l+"-path"]){e.sap.log.warning("Inconsistent service","Use either 'sap:"+l+"' or 'sap:"+l+"-path'"+" at entity set '"+a.name+"'",o);c=t}else if(l!==i.name){c={Path:i.value}}else if(i.value==="false"){c=t}if(c){a[r]=a[r]||{};a[r][s]=c}},liftSAPData:function(e,a){if(!e.extensions){return}e.extensions.forEach(function(t){if(t.namespace==="http://www.sap.com/Protocols/SAPData"){e["sap:"+t.name]=t.value;v.addV4Annotation(e,t,a)}});switch(a){case"Property":if(e["sap:updatable"]==="false"){if(e["sap:creatable"]==="false"){e["Org.OData.Core.V1.Computed"]=i}else{e["Org.OData.Core.V1.Immutable"]=i}}break;case"EntitySet":if(e["sap:searchable"]!=="true"){e["Org.OData.Capabilities.V1.SearchRestrictions"]={Searchable:t}}break;default:}},merge:function(a,t,i){var n=t.dataServices.schema;if(!n){return}n.forEach(function(t,i){var r;delete t.annotations;v.liftSAPData(t);t.$path="/dataServices/schema/"+i;r=t["sap:schema-version"];if(r){t["Org.Odata.Core.V1.SchemaVersion"]={String:r}}e.extend(t,a[t.namespace]);v.visitParents(t,a,"association",function(e,a){v.visitChildren(e.end,a)});v.visitParents(t,a,"complexType",function(e,a){v.visitChildren(e.property,a,"Property");v.addSapSemantics(e)});v.visitParents(t,a,"entityType",v.visitEntityType);v.visitParents(t,a,"entityContainer",function(e,i){v.visitChildren(e.associationSet,i);v.visitChildren(e.entitySet,i,"EntitySet",n);v.visitChildren(e.functionImport,i,"",null,v.visitParameters.bind(this,a,t,e))})});v.addUnitAnnotations(n,i)},visitChildren:function(a,t,i,n,r,o){if(!a){return}if(o){a=a.slice(o)}a.forEach(function(e){v.liftSAPData(e,i)});a.forEach(function(a){var o;if(i==="EntitySet"){o=v.getObject(n,"entityType",a.entityType);v.calculateEntitySetAnnotations(a,o)}if(r){r(a)}e.extend(a,t[a.name||a.role])})},visitEntityType:function(e,a){v.visitChildren(e.property,a,"Property");v.visitChildren(e.navigationProperty,a);v.addSapSemantics(e)},visitParameters:function(a,t,i,n){var r;if(!n.parameter){return}r=v.getChildAnnotations(a,t.namespace+"."+i.name,true);n.parameter.forEach(function(a){v.liftSAPData(a);e.extend(a,r[n.name+"/"+a.name])})},visitParents:function(a,t,i,n,r){var o=a[i];function s(r,o){var s=a.namespace+"."+r.name,l=v.getChildAnnotations(t,s,i==="entityContainer");v.liftSAPData(r);r.namespace=a.namespace;r.$path=a.$path+"/"+i+"/"+o;n(r,l);e.extend(r,t[s])}if(!o){return}if(r!==undefined){s(o[r],r)}else{o.forEach(s)}}};return v},false);