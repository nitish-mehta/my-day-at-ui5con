/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./Filter","sap/ui/model/Sorter","sap/ui/core/format/DateFormat"],function(e,t,r,a){"use strict";var n=/^([-+]?)0*(\d+)(\.\d+|)$/,i=/\.$/,s=/0+$/;var o=function(){};o.createSortParams=function(t){var a;if(!t||t.length==0){return}a="$orderby=";for(var n=0;n<t.length;n++){var i=t[n];if(i instanceof r){a+=i.sPath;a+=i.bDescending?"%20desc":"%20asc";a+=","}else{e.sap.log.error("Trying to use "+i+" as a Sorter, but it is a "+typeof i)}}a=a.slice(0,-1);return a};o.createFilterParams=function(e,t,r){if(!e||e.length==0){return}return"$filter="+this._createFilterParams(e,t,r)};o._createFilterParams=function(r,a,n){var i;if(!r||r.length==0){return}var s={},o=0,f,i="",u=0,l=this;e.each(r,function(e,t){if(t.sPath){f=s[t.sPath];if(!f){f=s[t.sPath]=[];o++}}else{f=s["__multiFilter"];if(!f){f=s["__multiFilter"]=[];o++}}f.push(t)});e.each(s,function(r,s){if(s.length>1){i+="("}e.each(s,function(r,o){if(o instanceof t){if(o.aValues.length>1){i+="("}e.each(o.aValues,function(e,t){if(e>0){if(o.bAND){i+="%20and%20"}else{i+="%20or%20"}}i=l._createFilterSegment(o.sPath,a,n,t.operator,t.value1,t.value2,i,o.bCaseSensitive)});if(o.aValues.length>1){i+=")"}}else if(o._bMultiFilter){i+=l._resolveMultiFilter(o,a,n)}else{i=l._createFilterSegment(o.sPath,a,n,o.sOperator,o.oValue1,o.oValue2,i,o.bCaseSensitive)}if(r<s.length-1){i+="%20or%20"}});if(s.length>1){i+=")"}if(u<o-1){i+="%20and%20"}u++});return i};o._createUrlParamsArray=function(t){var r,a=e.type(t),n;if(a==="array"){return t}r=[];if(a==="object"){n=this._encodeURLParameters(t);if(n){r.push(n)}}else if(a==="string"){if(t){r.push(t)}}return r};o._encodeURLParameters=function(t){if(!t){return""}var r=[];e.each(t,function(t,a){if(e.type(a)==="string"){a=encodeURIComponent(a)}t=e.sap.startsWith(t,"$")?t:encodeURIComponent(t);r.push(t+"="+a)});return r.join("&")};o.setOrigin=function(t,r){var a,n,i;if(!t||!r||t.indexOf(";mo")>0){return t}if(typeof r=="string"){a=r}else{a=r.alias;if(!a){n=r.system;i=r.client;if(!n||!i){e.sap.log.warning("ODataUtils.setOrigin: No Client or System ID given for Origin");return t}a="sid("+n+"."+i+")"}}var s=t.split("?");var o=s[0];var f=s[1]?"?"+s[1]:"";var u="";if(o[o.length-1]==="/"){o=o.substring(0,o.length-1);u="/"}var l=/(\/[^\/]+)$/g;var c=/(;o=[^\/;]+)/g;var m=o.match(l)[0];var d=m.match(c);var g=d?d[0]:null;if(g){if(r.force){var p=m.replace(g,";o="+a);o=o.replace(m,p);return o+u+f}return t}o=o+";o="+a+u;return o+f};o.setAnnotationOrigin=function(t,r){var a;var n=t.indexOf("/Annotations(");if(n===-1){n=t.indexOf("/Annotations%28")}if(n>=0){if(t.indexOf("/$value",n)===-1){e.sap.log.warning("ODataUtils.setAnnotationOrigin: Annotation url is missing $value segment.");a=t}else{var i=t.substring(0,n);var s=t.substring(n,t.length);var f=o.setOrigin(i,r);a=f+s}}else{a=t.replace(r.preOriginBaseUri,r.postOriginBaseUri)}return a};o._resolveMultiFilter=function(t,r,a){var n=this,i=t.aFilters,s="";if(i){s+="(";e.each(i,function(e,o){if(o._bMultiFilter){s+=n._resolveMultiFilter(o,r,a)}else if(o.sPath){s+=n._createFilterSegment(o.sPath,r,a,o.sOperator,o.oValue1,o.oValue2,"",o.bCaseSensitive)}if(e<i.length-1){if(t.bAnd){s+="%20and%20"}else{s+="%20or%20"}}});s+=")"}return s};o._createFilterSegment=function(t,r,a,n,i,s,o,f){var u,l;if(f===undefined){f=true}if(a){u=r._getPropertyMetadata(a,t);l=u&&u.type;e.sap.assert(u,"PropertyType for property "+t+" of EntityType "+a.name+" not found!")}if(l){i=this.formatValue(i,l,f);s=s!=null?this.formatValue(s,l,f):null}else{e.sap.assert(null,"Type for filter property could not be found in metadata!")}if(i){i=e.sap.encodeURL(String(i))}if(s){s=e.sap.encodeURL(String(s))}switch(n){case"EQ":case"NE":case"GT":case"GE":case"LT":case"LE":t=f?t:"toupper("+t+")";o+=t+"%20"+n.toLowerCase()+"%20"+i;break;case"BT":o+="("+t+"%20ge%20"+i+"%20and%20"+t+"%20le%20"+s+")";break;case"Contains":o+="substringof("+i+","+t+")";break;case"StartsWith":o+="startswith("+t+","+i+")";break;case"EndsWith":o+="endswith("+t+","+i+")";break;default:o+="true"}return o};o.formatValue=function(e,t,r){if(r===undefined){r=true}if(!this.oDateTimeFormat){this.oDateTimeFormat=a.getDateInstance({pattern:"'datetime'''yyyy-MM-dd'T'HH:mm:ss''"});this.oDateTimeFormatMs=a.getDateInstance({pattern:"'datetime'''yyyy-MM-dd'T'HH:mm:ss.SSS''"});this.oDateTimeOffsetFormat=a.getDateInstance({pattern:"'datetimeoffset'''yyyy-MM-dd'T'HH:mm:ss'Z'''"});this.oTimeFormat=a.getTimeInstance({pattern:"'time''PT'HH'H'mm'M'ss'S'''"})}if(e===null||e===undefined){return"null"}var n;switch(t){case"Edm.String":e=r?e:e.toUpperCase();n="'"+String(e).replace(/'/g,"''")+"'";break;case"Edm.Time":if(typeof e==="object"){n=this.oTimeFormat.format(new Date(e.ms),true)}else{n="time'"+e+"'"}break;case"Edm.DateTime":var i=new Date(e);if(i.getMilliseconds()>0){n=this.oDateTimeFormatMs.format(i,true)}else{n=this.oDateTimeFormat.format(i,true)}break;case"Edm.DateTimeOffset":var i=new Date(e);n=this.oDateTimeOffsetFormat.format(i,true);break;case"Edm.Guid":n="guid'"+e+"'";break;case"Edm.Decimal":n=e+"m";break;case"Edm.Int64":n=e+"l";break;case"Edm.Double":n=e+"d";break;case"Edm.Float":case"Edm.Single":n=e+"f";break;case"Edm.Binary":n="binary'"+e+"'";break;default:n=String(e);break}return n};function f(e,t){if(e===t){return 0}if(e===null||t===null||e===undefined||t===undefined){return NaN}return e>t?1:-1}function u(e){var t;if(typeof e!=="string"){return undefined}t=n.exec(e);if(!t){return undefined}return{sign:t[1]==="-"?-1:1,integerLength:t[2].length,abs:t[2]+t[3].replace(s,"").replace(i,"")}}function l(e,t){var r,a,n;if(e===t){return 0}r=u(e);a=u(t);if(!r||!a){return NaN}if(r.sign!==a.sign){return r.sign>a.sign?1:-1}n=f(r.integerLength,a.integerLength)||f(r.abs,a.abs);return r.sign*n}var c=/^PT(\d\d)H(\d\d)M(\d\d)S$/;function m(e){if(typeof e==="string"&&c.test(e)){e=parseInt(RegExp.$1,10)*36e5+parseInt(RegExp.$2,10)*6e4+parseInt(RegExp.$3,10)*1e3}if(e instanceof Date){return e.getTime()}if(e&&e.__edmType==="Edm.Time"){return e.ms}return e}o.compare=function(e,t,r){return r?l(e,t):f(m(e),m(t))};o.getComparator=function(e){switch(e){case"Edm.Date":case"Edm.DateTime":case"Edm.DateTimeOffset":case"Edm.Time":return o.compare;case"Edm.Decimal":case"Edm.Int64":return l;default:return f}};var d=/([(=,])('.*?')([,)])/g,g=/[MLDF](?=[,)](?:[^']*'[^']*')*[^']*$)/g,p=/([(=,])(X')/g,h=function(e,t,r,a){return t+encodeURIComponent(decodeURIComponent(r))+a},v=function(e){return e.toLowerCase()},b=function(e,t){return t+"binary'"};o._normalizeKey=function(e){return e.replace(d,h).replace(g,v).replace(p,b)};return o},true);