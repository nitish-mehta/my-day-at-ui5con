/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/EventProvider","sap/ui/thirdparty/datajs","sap/ui/core/cache/CacheManager","./_ODataMetaModelUtils"],function(t,e,a,i,n){"use strict";var s=e.extend("sap.ui.model.odata.ODataMetadata",{constructor:function(a,n){e.apply(this,arguments);this.bLoaded=false;this.bFailed=false;this.mEntityTypes={};this.mRequestHandles={};this.sUrl=a;this.bAsync=n.async;this.sUser=n.user;this.bWithCredentials=n.withCredentials;this.sPassword=n.password;this.mHeaders=n.headers;this.sCacheKey=n.cacheKey;this.oLoadEvent=null;this.oFailedEvent=null;this.oMetadata=null;this.mNamespaces=n.namespaces||{sap:"http://www.sap.com/Protocols/SAPData",m:"http://schemas.microsoft.com/ado/2007/08/dataservices/metadata","":"http://schemas.microsoft.com/ado/2007/06/edmx"};var s=this;this.fnResolve;this.pLoaded=new Promise(function(t,e){s.fnResolve=t});function r(t){i.set(s.sCacheKey,JSON.stringify({metadata:s.oMetadata,params:t}))}function o(){t.sap.log.error("[ODataMetadata] initial loading of metadata failed")}if(this.sCacheKey){i.get(this.sCacheKey).then(function(t){if(t){var e=JSON.parse(t);this.oMetadata=e.metadata;this._handleLoaded(this.oMetadata,e.params,false)}else{this._loadMetadata().then(r).catch(o)}}.bind(this)).catch(o)}else{this._loadMetadata().catch(o)}},metadata:{publicMethods:["getServiceMetadata","attachFailed","detachFailed","attachLoaded","detachLoaded","refresh"]}});s.prototype._setNamespaces=function(t){this.mNamespaces=t};s.prototype._handleLoaded=function(e,a,i){var n=[];this.oMetadata=this.oMetadata?this.merge(this.oMetadata,e,n):e;this.oRequestHandle=null;a.entitySets=n;this.fnResolve(a);if(this.bAsync&&!i){this.fireLoaded(this)}else if(!this.bAsync&&!i){this.bLoaded=true;this.bFailed=false;this.oLoadEvent=t.sap.delayedCall(0,this,this.fireLoaded,[a])}};s.prototype._loadMetadata=function(e,i){var n=this;e=e||this.sUrl;var s=this._createRequest(e);return new Promise(function(e,r){var o;function d(t,a){if(!t||!t.dataServices){var r={message:"Invalid metadata document",request:s,response:a};h(r);return}n.sMetadataBody=a.body;n.oRequestHandle=null;var o={metadataString:n.sMetadataBody};var d=a.headers["Last-Modified"];if(d){o.lastModified=d}n._handleLoaded(t,o,i);e(o)}function h(e){var a={message:e.message,request:e.request,response:e.response};if(e.response){a.statusCode=e.response.statusCode;a.statusText=e.response.statusText;a.responseText=e.response.body}if(o&&o.bSuppressErrorHandlerCall){return}if(n.bAsync){delete n.mRequestHandles[o.id]}r(a);if(n.bAsync&&!i){n.fireFailed(a)}else if(!n.bAsync&&!i){n.bFailed=true;n.oFailedEvent=t.sap.delayedCall(0,n,n.fireFailed,[a])}}o=a.request(s,d,h,a.metadataHandler);if(n.bAsync){o.id=t.sap.uid();n.mRequestHandles[o.id]=o}})};s.prototype.refresh=function(){return this._loadMetadata()};s.prototype.getServiceMetadata=function(){return this.oMetadata};s.prototype.isLoaded=function(){return this.bLoaded};s.prototype.loaded=function(){return this.pLoaded};s.prototype.isFailed=function(){return this.bFailed};s.prototype.fireLoaded=function(e){this.bLoaded=true;this.bFailed=false;this.fireEvent("loaded",e);t.sap.log.debug(this+" - loaded was fired");return this};s.prototype.attachLoaded=function(t,e,a){this.attachEvent("loaded",t,e,a);return this};s.prototype.detachLoaded=function(t,e){this.detachEvent("loaded",t,e);return this};s.prototype.fireFailed=function(t){this.bFailed=true;this.fireEvent("failed",t);return this};s.prototype.attachFailed=function(t,e,a){this.attachEvent("failed",t,e,a);return this};s.prototype.detachFailed=function(t,e){this.detachEvent("failed",t,e);return this};s.prototype._getEntityAssociationEnd=function(e,a){if(!this.oMetadata||t.isEmptyObject(this.oMetadata)){t.sap.assert(undefined,"No metadata loaded!");return null}if(!this._mGetEntityAssociationEndCache||!this._mGetEntityAssociationEndCache[e.name+"|"+a]){this._mGetEntityAssociationEndCache={};var i=e?n.findObject(e.navigationProperty,a):null,s=i?n.getObject(this.oMetadata.dataServices.schema,"association",i.relationship):null,r=s?n.findObject(s.end,i.toRole,"role"):null;this._mGetEntityAssociationEndCache[e.name+"|"+a]=r}return this._mGetEntityAssociationEndCache[e.name+"|"+a]};function r(t){var e={};for(var a=0;a<t.length;a++){var i=t[a];if(i.entityContainer){for(var n=0;n<i.entityContainer.length;n++){var s=i.entityContainer[n];if(s.entitySet){for(var r=0;r<s.entitySet.length;r++){if(s.entitySet[r].name!=null){e[s.entitySet[r].name]=s.entitySet[r]}}}}}}return e}s.prototype._findEntitySetByName=function(t){if(!this.mEntitySets){this.mEntitySets=r(this.oMetadata.dataServices.schema)}return this.mEntitySets[t]};s.prototype._getEntityTypeByPath=function(e){if(!e){t.sap.assert(undefined,"sPath not defined!");return null}if(!this.oMetadata||t.isEmptyObject(this.oMetadata)){t.sap.assert(undefined,"No metadata loaded!");return null}if(this.mEntityTypes[e]){return this.mEntityTypes[e]}var a=e.replace(/^\/|\/$/g,""),i=a.split("/"),n=i.length,s,r,o,d,h=this;if(i[0].indexOf("(")!=-1){i[0]=i[0].substring(0,i[0].indexOf("("))}if(n>1){s=h._getEntityTypeByPath(i[0]);for(var p=1;p<i.length;p++){if(s){if(i[p].indexOf("(")!=-1){i[p]=i[p].substring(0,i[p].indexOf("("))}d=h._getEntityTypeByNavProperty(s,i[p]);if(d){s=d}o=s}}}else{r=this._splitName(this._getEntityTypeName(i[0]));o=this._getObjectMetadata("entityType",r.name,r.namespace);if(o){o.entityType=this._getEntityTypeName(i[0])}}if(!o){var y=i[i.length-1];var f=this._getFunctionImportMetadata(y,"GET");if(!f){f=this._getFunctionImportMetadata(y,"POST")}if(f&&f.entitySet){o=this._getEntityTypeByPath(f.entitySet);if(o){o.entityType=this._getEntityTypeName(f.entitySet)}}}if(o){this.mEntityTypes[e]=o}return o};s.prototype._getEntityTypeByName=function(e){var a,i=this,n,s,r;if(!e){t.sap.assert(undefined,"sName not defined!");return null}r=this._splitName(e);s=r.namespace;n=r.name;if(!this.oMetadata||t.isEmptyObject(this.oMetadata)){t.sap.assert(undefined,"No metadata loaded!");return null}if(this.mEntityTypes[e]){a=this.mEntityTypes[e]}else{t.each(this.oMetadata.dataServices.schema,function(r,o){if(o.entityType&&(!s||o.namespace===s)){t.each(o.entityType,function(t,s){if(s.name===n){a=s;i.mEntityTypes[e]=a;a.namespace=o.namespace;return false}})}})}return a};s.prototype._getAnnotation=function(e){var a,i,n,s,r,o,d;i=e.split("/#");s=i[1].split("/");if(!i[0]){r=this._getEntityTypeByName(s[0]);t.sap.assert(r,s[0]+" is not a valid EntityType");if(!r){return}o=i[1].substr(i[1].indexOf("/")+1);d=this._getPropertyMetadata(r,o);t.sap.assert(d,o+" is not a valid property path");if(!d){return}n=o.substr(o.indexOf(d.name));n=n.substr(n.indexOf("/")+1)}else{r=this._getEntityTypeByPath(i[0]);t.sap.assert(r,i[0]+" is not a valid path");if(!r){return}e=i[0].replace(/^\/|\/$/g,"");o=e;while(!d&&o.indexOf("/")>0){o=o.substr(o.indexOf("/")+1);d=this._getPropertyMetadata(r,o)}t.sap.assert(d,o+" is not a valid property path");if(!d){return}n=s.join("/")}a=this._getAnnotationObject(r,d,n);return a};s.prototype._getAnnotationObject=function(t,e,a){var i,n,s,r,o;if(!e){return}r=e;n=a.split("/");if(n[0].indexOf(".")>-1){return this._getV4AnnotationObject(t,e,n)}else{if(n.length>1){r=r[n[0]];if(!r&&e.extensions){for(var d=0;d<e.extensions.length;d++){var h=e.extensions[d];if(h.name==n[0]){r=h;break}}}a=n.splice(0,1);s=this._getAnnotationObject(t,r,n.join("/"))}else{if(n[0].indexOf("@")>-1){o=n[0].substr(1);i=o.split(":");s=r[i[0]];if(!s&&r.extensions){for(var d=0;d<r.extensions.length;d++){var h=r.extensions[d];if(h.name===i[1]&&h.namespace===this.mNamespaces[i[0]]){s=h.value;break}}}}else{i=n[0].split(":");s=r[i[0]];s=r[n[0]];if(!s&&r.extensions){for(var d=0;d<r.extensions.length;d++){var h=r.extensions[d];if(h.name===i[1]&&h.namespace===this.mNamespaces[i[0]]){s=h;break}}}}}}return s};s.prototype._getV4AnnotationObject=function(e,a,i){var n,s=[];if(i.length>1){t.sap.assert(i.length==1,"'"+i.join("/")+"' is not a valid annotation path");return}var r=e.namespace?e.namespace+".":"";r+=e.name+"/"+a.name;t.each(this.oMetadata.dataServices.schema,function(e,a){if(a.annotations){t.each(a.annotations,function(t,e){if(e.target===r&&!e.qualifier){s.push(e.annotation);return false}})}});if(s){t.each(s,function(e,a){t.each(a,function(t,e){if(e.term===i[0]){n=e}})})}return n};s.prototype._splitName=function(t){var e={};if(t){var a=t.lastIndexOf(".");e.name=t.substr(a+1);e.namespace=t.substr(0,a)}return e};s.prototype._getEntityTypeName=function(t){var e,a;if(t){a=this._findEntitySetByName(t);if(a){e=a.entityType}}return e};s.prototype._getObjectMetadata=function(e,a,i){var n;if(a&&i){t.each(this.oMetadata.dataServices.schema,function(s,r){if(r[e]&&r.namespace===i){t.each(r[e],function(t,e){if(e.name===a){n=e;n.namespace=r.namespace;return false}});return!n}})}return n};s.prototype.getUseBatch=function(){var e=false;t.each(this.oMetadata.dataServices.schema,function(a,i){if(i.entityContainer){t.each(i.entityContainer,function(a,i){if(i.extensions){t.each(i.extensions,function(t,a){if(a.name==="use-batch"&&a.namespace==="http://www.sap.com/Protocols/SAPData"){e=typeof a.value==="string"?a.value.toLowerCase()==="true":!!a.value;return false}})}})}});return e};s.prototype._getFunctionImportMetadata=function(e,a){var i=null;if(e.indexOf("/")>-1){e=e.substr(e.indexOf("/")+1)}t.each(this.oMetadata.dataServices.schema,function(n,s){if(s["entityContainer"]){t.each(s["entityContainer"],function(n,s){if(s["functionImport"]){t.each(s["functionImport"],function(t,n){if(n.name===e&&n.httpMethod===a){i=n;return false}})}return!i})}return!i});return i};s.prototype._getEntityTypeByNavProperty=function(t,e){if(!t.navigationProperty){return undefined}for(var a=0;a<t.navigationProperty.length;++a){var i=t.navigationProperty[a];if(i.name===e){return this._getEntityTypeByNavPropertyObject(i)}}return undefined};s.prototype._getEntityTypeByNavPropertyObject=function(t){var e;var a=this._splitName(t.relationship);var i=this._getObjectMetadata("association",a.name,a.namespace);if(i){var n=i.end[0];if(n.role!==t.toRole){n=i.end[1]}var s=this._splitName(n.type);e=this._getObjectMetadata("entityType",s.name,s.namespace);if(e){e.entityType=n.type}}return e};s.prototype._getNavigationPropertyNames=function(e){var a=[];if(e.navigationProperty){t.each(e.navigationProperty,function(t,e){a.push(e.name)})}return a};s.prototype._getPropertyMetadata=function(e,a){var i,n=this;if(!e){return}a=a.replace(/^\/|\/$/g,"");var s=a.split("/");t.each(e.property,function(t,e){if(e.name===s[0]){i=e;return false}});if(s.length>1){if(!i){while(e&&s.length>1){e=this._getEntityTypeByNavProperty(e,s[0]);s.shift()}if(e){i=n._getPropertyMetadata(e,s[0])}}else if(!t.sap.startsWith(i.type.toLowerCase(),"edm.")){var r=this._splitName(i.type);i=this._getPropertyMetadata(this._getObjectMetadata("complexType",r.name,r.namespace),s[1])}}return i};s.prototype.destroy=function(){delete this.oMetadata;var a=this;t.each(this.mRequestHandles,function(t,e){e.bSuppressErrorHandlerCall=true;e.abort();delete a.mRequestHandles[t]});if(!!this.oLoadEvent){t.sap.clearDelayedCall(this.oLoadEvent)}if(!!this.oFailedEvent){t.sap.clearDelayedCall(this.oFailedEvent)}e.prototype.destroy.apply(this,arguments)};s.prototype._createRequest=function(e){var a={},i={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()};t.extend(a,this.mHeaders,i);var n={headers:a,requestUri:e,method:"GET",user:this.sUser,password:this.sPassword,async:this.bAsync};if(this.bAsync){n.withCredentials=this.bWithCredentials}return n};s.prototype._getEntitySetByPath=function(t){if(!this._entitySetMap){this._entitySetMap={};this.oMetadata.dataServices.schema.forEach(function(t){if(t.entityContainer){t.entityContainer.forEach(function(t){if(t.entitySet){t.entitySet.forEach(function(t){this._entitySetMap[t.entityType]=t},this)}},this)}},this)}var e=this._getEntityTypeByPath(t);if(e){return this._entitySetMap[e.entityType]}return};s.prototype._addUrl=function(t){var e=[].concat(t);return Promise.all(e.map(function(t){return this._loadMetadata(t,true)},this))};s.prototype.merge=function(e,a,i){var n=this;if(this.mEntitySets){delete this.mEntitySets}t.each(e.dataServices.schema,function(e,s){t.each(a.dataServices.schema,function(e,a){if(a.namespace===s.namespace){if(a.entityType){if(!n.mEntityTypeNames){n.mEntityTypeNames={};s.entityType.map(function(t){n.mEntityTypeNames[t.name]=true})}s.entityType=!s.entityType?[]:s.entityType;for(var r=0;r<a.entityType.length;r++){if(!(a.entityType[r].name in n.mEntityTypeNames)){s.entityType.push(a.entityType[r]);n.mEntityTypeNames[a.entityType[r].name]=true}}}if(s.entityContainer&&a.entityContainer){t.each(s.entityContainer,function(e,s){t.each(a.entityContainer,function(t,e){if(e.entitySet){if(e.name===s.name){if(!n.mEntitySetNames){n.mEntitySetNames={};s.entitySet.map(function(t){n.mEntitySetNames[t.name]=true})}s.entitySet=!s.entitySet?[]:s.entitySet;for(var a=0;a<e.entitySet.length;a++){if(!(e.entitySet[a].name in n.mEntitySetNames)){s.entitySet.push(e.entitySet[a]);n.mEntitySetNames[e.entitySet[a].name]=true}}e.entitySet.forEach(function(t){i.push(t)})}}})})}if(a.annotations){s.annotations=!s.annotations?[]:s.annotations;s.annotations=s.annotations.concat(a.annotations)}}})});return e};s.prototype._getEntitySetByType=function(t){var e=t.namespace+"."+t.name;var a=this.oMetadata.dataServices.schema;for(var i=0;i<a.length;++i){var n=a[i].entityContainer;if(n){for(var s=0;s<n.length;++s){var r=n[s].entitySet;if(r){for(var o=0;o<r.length;++o){if(r[o].entityType===e){return r[o]}}}}}}return null};return s});