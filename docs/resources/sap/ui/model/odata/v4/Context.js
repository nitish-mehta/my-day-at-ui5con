/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/SyncPromise","sap/ui/model/Context","./lib/_Helper"],function(t,e,n){"use strict";function i(e,n,i){var o,r=[e.fetchValue(n)],s=e.getPath(n);if(i){r.push(e.oModel.getMetaModel().fetchUI5Type(s))}return t.all(r).then(function(t){var e=t[1],n=t[0];if(n&&typeof n==="object"){o=new Error("Accessed value is not primitive: "+s);o.isNotPrimitive=true;throw o}return i?e.formatValue(n,"string"):n})}var o=e.extend("sap.ui.model.odata.v4.Context",{constructor:function(n,i,o,r,s){e.call(this,n,o);this.oBinding=i;this.oCreatePromise=s&&Promise.resolve(s).then(function(){});this.oSyncCreatePromise=s&&t.resolve(s);this.iIndex=r}}),r="sap.ui.model.odata.v4.Context";o.prototype._delete=function(t){var e=this;if(this.isTransient()){return this.oBinding._delete(t,"n/a",this)}return this.fetchCanonicalPath().then(function(n){return e.oBinding._delete(t,n.slice(1),e)})};o.prototype.checkUpdate=function(){this.oModel.getDependentBindings(this).forEach(function(t){t.checkUpdate()})};o.prototype.created=function(){return this.oCreatePromise};o.prototype["delete"]=function(t){var e,n=this;this.oBinding.checkSuspended();this.oModel.checkGroupId(t);e=this.oModel.lockGroup(t,true);return this._delete(e).catch(function(t){e.unlock(true);n.oModel.reportError("Failed to delete "+n,r,t);throw t})};o.prototype.destroy=function(){this.oModel.getDependentBindings(this).forEach(function(t){t.setContext(undefined)});this.oBinding=undefined;this.oModel=undefined;e.prototype.destroy.apply(this)};o.prototype.fetchCanonicalPath=function(){return this.oModel.getMetaModel().fetchCanonicalPath(this)};o.prototype.fetchValue=function(e,i){if(this.iIndex===-2){return t.resolve()}return this.oBinding.fetchValue(e&&e[0]==="/"?e:n.buildPath(this.sPath,e),i)};o.prototype.getBinding=function(){return this.oBinding};o.prototype.getCanonicalPath=n.createGetMethod("fetchCanonicalPath",true);o.prototype.getGroupId=function(){return this.oBinding.getGroupId()};o.prototype.getIndex=function(){if(this.oBinding.aContexts&&this.oBinding.aContexts[-1]){return this.iIndex+1}return this.iIndex};o.prototype.getObject=function(t){var e;this.oBinding.checkSuspended();e=this.fetchValue(t);if(e.isFulfilled()){return n.publicClone(e.getResult())}};o.prototype.getProperty=function(t,e){var n,o;this.oBinding.checkSuspended();o=i(this,t,e);if(o.isRejected()){o.caught();n=o.getResult();if(n.isNotPrimitive){throw n}else{jQuery.sap.log.warning(n.message,t,r)}}return o.isFulfilled()?o.getResult():undefined};o.prototype.getQueryOptionsForPath=function(t){return this.oBinding.getQueryOptionsForPath(t)};o.prototype.getUpdateGroupId=function(){return this.oBinding.getUpdateGroupId()};o.prototype.hasPendingChanges=function(){return this.oModel.getDependentBindings(this).some(function(t){return t.hasPendingChanges()})};o.prototype.isTransient=function(){return this.oSyncCreatePromise&&this.oSyncCreatePromise.isPending()};o.prototype.refresh=function(t,e){if(!this.oBinding.refreshSingle){throw new Error("Refresh is only supported for contexts of a list binding")}this.oModel.checkGroupId(t);this.oBinding.refreshSingle(this,this.oModel.lockGroup(t,true),e)};o.prototype.requestCanonicalPath=n.createRequestMethod("fetchCanonicalPath");o.prototype.requestObject=function(t){this.oBinding.checkSuspended();return Promise.resolve(this.fetchValue(t)).then(n.publicClone)};o.prototype.requestProperty=function(t,e){this.oBinding.checkSuspended();return Promise.resolve(i(this,t,e))};o.prototype.setIndex=function(t){this.iIndex=t};o.prototype.toString=function(){var t="";if(this.iIndex!==undefined){t="["+this.iIndex+(this.isTransient()?"|transient":"")+"]"}return this.sPath+t};o.prototype.withCache=function(e,i){if(this.iIndex===-2){return t.resolve()}return this.oBinding.withCache(e,i[0]==="/"?i:n.buildPath(this.sPath,i))};return{create:function(t,e,n,i,r){if(n[0]!=="/"){throw new Error("Not an absolute path: "+n)}if(n.slice(-1)==="/"){throw new Error("Unsupported trailing slash: "+n)}return new o(t,e,n,i,r)}}},false);