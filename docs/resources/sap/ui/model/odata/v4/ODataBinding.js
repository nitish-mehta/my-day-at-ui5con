/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/SyncPromise","./lib/_Helper"],function(e,t){"use strict";var n="sap.ui.model.odata.v4.ODataBinding";function i(){}i.prototype.checkSuspended=function(){var e=this.getRootBinding();if(e&&e.isSuspended()){throw new Error("Must not call method when the binding's root binding is suspended: "+this)}};i.prototype.fetchCache=function(i){var o,r={},s,h,a=this;if(!this.bRelative){i=undefined}if(this.oCachePromise.isFulfilled()){s=this.oCachePromise.getResult();if(s){s.setActive(false)}}h=[this.fetchQueryOptionsForOwnCache(i),this.oModel.oRequestor.ready()];this.mCacheQueryOptions=undefined;o=e.all(h).then(function(n){var s,h=n[0];if(h&&!(i&&i.getIndex&&i.getIndex()===-2)){s=e.resolve(i&&(i.fetchCanonicalPath?i.fetchCanonicalPath():i.getPath()));return s.then(function(e){var n,s;if(!o||a.oFetchCacheCallToken===r){a.mCacheQueryOptions=jQuery.extend(true,{},a.oModel.mUriParameters,h);if(e){a.mCacheByContext=a.mCacheByContext||{};n=a.mCacheByContext[e];if(n){n.setActive(true)}else{n=a.doCreateCache(t.buildPath(e,a.sPath).slice(1),a.mCacheQueryOptions,i);a.mCacheByContext[e]=n;n.$canonicalPath=e}}else{n=a.doCreateCache(a.sPath.slice(1),a.mCacheQueryOptions,i)}return n}else{s=new Error("Cache discarded as a new cache has been created");s.canceled=true;throw s}})}});o["catch"](function(e){a.oModel.reportError("Failed to create cache for binding "+a,n,e)});this.oCachePromise=o;this.oFetchCacheCallToken=r};i.prototype.fetchQueryOptionsForOwnCache=function(t){var n,i,o=this;if(this.oOperation){return e.resolve(undefined)}if(this.bRelative&&!t){return e.resolve(undefined)}i=this.doFetchQueryOptions(t);if(this.oModel.bAutoExpandSelect&&this.aChildCanUseCachePromises){i=e.all([i,Promise.resolve().then(function(){return e.all(o.aChildCanUseCachePromises)})]).then(function(e){o.aChildCanUseCachePromises=[];o.updateAggregatedQueryOptions(e[0]);return o.mAggregatedQueryOptions})}if(!this.bRelative||!t.fetchValue){return i}if(this.oModel.bAutoExpandSelect){n=o.mParameters&&Object.keys(o.mParameters).some(function(e){return e[0]!=="$"||e[1]==="$"});if(n){return i}return t.getBinding().fetchIfChildCanUseCache(t,o.sPath,i).then(function(e){return e?undefined:i})}if(this.mParameters&&Object.keys(this.mParameters).length){return i}return i.then(function(e){return Object.keys(e).length===0?undefined:e})};i.prototype.getGroupId=function(){return this.sGroupId||this.bRelative&&this.oContext&&this.oContext.getGroupId&&this.oContext.getGroupId()||this.oModel.getGroupId()};i.prototype.getRelativePath=function(e){var t,n;if(e[0]==="/"){n=this.oModel.resolve(this.sPath,this.oContext);if(e.indexOf(n)===0){t=n}else if(this.oReturnValueContext&&e.indexOf(this.oReturnValueContext.getPath())===0){t=this.oReturnValueContext.getPath()}else{return undefined}e=e.slice(t.length);if(e[0]==="/"){e=e.slice(1)}}return e};i.prototype.getRootBinding=function(){if(this.bRelative&&this.oContext&&this.oContext.getBinding){return this.oContext.getBinding().getRootBinding()}return this.bRelative&&!this.oContext?undefined:this};i.prototype.getUpdateGroupId=function(){return this.sUpdateGroupId||this.bRelative&&this.oContext&&this.oContext.getUpdateGroupId&&this.oContext.getUpdateGroupId()||this.oModel.getUpdateGroupId()};i.prototype.hasPendingChanges=function(){return this.hasPendingChangesForPath("")||this.hasPendingChangesInDependents()};i.prototype.hasPendingChangesForPath=function(e){var t=this,i=this.withCache(function(e,t){return e.hasPendingChangesForPath(t)},e).catch(function(e){t.oModel.reportError("Error in hasPendingChangesForPath",n,e);return false});return i.isFulfilled()?i.getResult():false};i.prototype.hasPendingChangesInDependents=function(){return this.oModel.getDependentBindings(this).some(function(e){var t,n;if(e.oCachePromise.isFulfilled()){t=e.oCachePromise.getResult();if(t&&t.hasPendingChangesForPath("")){return true}}if(e.mCacheByContext){n=Object.keys(e.mCacheByContext).some(function(t){return e.mCacheByContext[t].hasPendingChangesForPath("")});if(n){return true}}return e.hasPendingChangesInDependents()})};i.prototype.isInitial=function(){throw new Error("Unsupported operation: isInitial")};i.prototype.isRefreshable=function(){return(!this.bRelative||this.oContext&&!this.oContext.getBinding)&&!this.isSuspended()};i.prototype.refresh=function(e){if(!this.isRefreshable()){throw new Error("Refresh on this binding is not supported")}if(this.hasPendingChanges()){throw new Error("Cannot refresh due to pending changes")}this.oModel.checkGroupId(e);this.refreshInternal(e,true)};i.prototype.resetChanges=function(){this.checkSuspended();this.resetChangesForPath("");this.resetChangesInDependents();this.resetInvalidDataState()};i.prototype.resetChangesForPath=function(e){var t=this.withCache(function(e,t){e.resetChangesForPath(t)},e),i=this;t.catch(function(e){i.oModel.reportError("Error in resetChangesForPath",n,e)});if(t.isRejected()){throw t.getResult()}};i.prototype.resetChangesInDependents=function(){this.oModel.getDependentBindings(this).forEach(function(e){var t;if(e.oCachePromise.isFulfilled()){t=e.oCachePromise.getResult();if(t){t.resetChangesForPath("")}e.resetInvalidDataState()}if(e.mCacheByContext){Object.keys(e.mCacheByContext).forEach(function(t){e.mCacheByContext[t].resetChangesForPath("")})}e.resetChangesInDependents()})};i.prototype.resetInvalidDataState=function(){};i.prototype.toString=function(){return this.getMetadata().getName()+": "+(this.bRelative?this.oContext+"|":"")+this.sPath};i.prototype.withCache=function(e,n){var i,o=this;n=n||"";return this.oCachePromise.then(function(r){if(r){i=o.getRelativePath(n);if(i!==undefined){return e(r,i,o)}}else if(o.oOperation){return undefined}if(o.oContext&&o.oContext.withCache){return o.oContext.withCache(e,n[0]==="/"?n:t.buildPath(o.sPath,n))}return undefined})};return function(e){jQuery.extend(e,i.prototype)}},false);