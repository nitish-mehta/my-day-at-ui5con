/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/format/DateFormat","sap/ui/model/odata/ODataUtils","./_Helper","./_Parser"],function(e,t,r,a){"use strict";var n=/^\/Date\((-?\d+)\)\/$/,i=e.getDateInstance({pattern:"yyyy-MM-dd",UTC:true}),o=/^\/Date\((-?\d+)(?:([-+])(\d\d)(\d\d))?\)\/$/,s={},c=e.getDateTimeInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss.SSSZ"}),u=/\+/g,f=/^([^(]+)(\(.+\))$/,p=/\//g,d=/^PT(?:(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)(\.\d+)?S)?)$/i,l=e.getTimeInstance({pattern:"HH:mm:ss",UTC:true});function m(){}m.prototype.mFinalHeaders={"Content-Type":"application/json;charset=UTF-8"};m.prototype.mPredefinedPartHeaders={Accept:"application/json"};m.prototype.mPredefinedRequestHeaders={Accept:"application/json",MaxDataServiceVersion:"2.0",DataServiceVersion:"2.0","X-CSRF-Token":"Fetch"};m.prototype.convertBinary=function(e){return e.replace(u,"-").replace(p,"_")};m.prototype.convertDate=function(e){var t,r=n.exec(e);if(!r){throw new Error("Not a valid Edm.DateTime value '"+e+"'")}t=new Date(parseInt(r[1],10));if(Number(r[1]%(24*60*60*1e3))!==0){throw new Error("Cannot convert Edm.DateTime value '"+e+"' to Edm.Date because it contains a time of day")}return i.format(t)};m.prototype.convertDateTimeOffset=function(t,r){var a=o.exec(t),n,i,c,u,f="yyyy-MM-dd'T'HH:mm:ss",p=r.$Precision,d;if(!a){throw new Error("Not a valid Edm.DateTimeOffset value '"+t+"'")}d=parseInt(a[1],10);i=parseInt(a[3],10);c=parseInt(a[4],10);if(!a[2]||i===0&&c===0){n="Z"}else{u=a[2]==="-"?-1:1;d+=u*(i*60*60*1e3+c*60*1e3);n=a[2]+a[3]+":"+a[4]}if(p>0){f+="."+jQuery.sap.padRight("","S",p)}if(!s[f]){s[f]=e.getDateTimeInstance({pattern:f,UTC:true})}return s[f].format(new Date(d))+n};m.prototype.convertDoubleSingle=function(e){switch(e){case"NaN":case"INF":case"-INF":return e;default:return parseFloat(e)}};m.prototype.convertFilter=function(e,t){var n=a.parseFilter(e),i=this;function o(e,t){var a,n=c(t);if(n.$Type!=="Edm.String"){a=r.parseLiteral(e.value,n.$Type,n.path);e.value=i.formatPropertyAsLiteral(a,n)}}function s(t,r){throw new Error("Cannot convert filter to V2, "+r+" at "+t.at+": "+e)}function c(e){var r;if(e.type){return{$Type:e.type}}if(e.id==="PATH"){r=i.oModelInterface.fnFetchMetadata(t+"/"+e.value).getResult();if(!r){throw new Error("Invalid filter path: "+e.value)}return{path:e.value,$Type:r.$Type,$v2Type:r.$v2Type}}return c(e.parameters[0])}function u(e){if(e){if(e.id==="VALUE"&&e.ambiguous){s(e,"ambiguous type for the literal")}u(e.left);u(e.right);if(e.parameters){if(e.value==="contains"){e.value="substringof";e.parameters.push(e.parameters.shift())}e.parameters.forEach(u)}if(e.left&&e.right){if(e.left.id==="VALUE"){if(e.right.id==="VALUE"){s(e,"saw literals on both sides of '"+e.id+"'")}o(e.left,e.right)}else if(e.right.id==="VALUE"){o(e.right,e.left)}}}}u(n);return a.buildFilterString(n)};m.prototype.convertKeyPredicate=function(e,t){var n=this.fetchTypeForPath(r.getMetaPath(t)).getResult(),i=a.parseKeyPredicate(decodeURIComponent(e)),o=this;function s(e,a){var i=n[e];if(i.$Type!=="Edm.String"){a=o.formatPropertyAsLiteral(r.parseLiteral(a,i.$Type,t),i)}return encodeURIComponent(a)}if(""in i){return"("+s(n.$Key[0],i[""])+")"}return"("+n.$Key.map(function(e){return encodeURIComponent(e)+"="+s(e,i[e])}).join(",")+")"};m.prototype.convertResourcePath=function(e){var t=e.indexOf("?"),r="",a,n=-1,i=this;if(t>0){r=e.slice(t);e=e.slice(0,t)}a=e.split("/");return a.map(function(t,r){var a=f.exec(t);n+=t.length+1;if(a){t=a[1]+i.convertKeyPredicate(a[2],"/"+e.slice(0,n))}return t}).join("/")+r};m.prototype.convertTimeOfDay=function(e){var t,r=d.exec(e),a;if(!r){throw new Error("Not a valid Edm.Time value '"+e+"'")}a=Date.UTC(1970,0,1,r[1]||0,r[2]||0,r[3]||0);t=new Date(a);return l.format(t)+(r[4]||"")};m.prototype.convertNonPrimitive=function(e){var t,r,a,n,i=this;if(Array.isArray(e.results)){e.results.forEach(function(e){i.convertNonPrimitive(e)});return e.results}if(!e.__metadata||!e.__metadata.type){throw new Error("Cannot convert structured value without type information in "+"__metadata.type: "+JSON.stringify(e))}a=e.__metadata.type;r=i.getTypeForName(a);delete e.__metadata;for(t in e){n=e[t];if(n===null){continue}if(typeof n==="object"){if(n.__deferred){delete e[t]}else{e[t]=this.convertNonPrimitive(n)}continue}e[t]=this.convertPrimitive(n,r[t],a,t)}return e};m.prototype.convertPrimitive=function(e,t,r,a){switch(t&&t.$Type){case"Edm.Binary":return this.convertBinary(e);case"Edm.Date":return this.convertDate(e);case"Edm.DateTimeOffset":return this.convertDateTimeOffset(e,t);case"Edm.Boolean":case"Edm.Byte":case"Edm.Decimal":case"Edm.Guid":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":case"Edm.SByte":case"Edm.String":return e;case"Edm.Double":case"Edm.Single":return this.convertDoubleSingle(e);case"Edm.TimeOfDay":return this.convertTimeOfDay(e);default:throw new Error("Type '"+(t&&t.$Type)+"' of property '"+a+"' in type '"+r+"' is unknown; cannot convert value: "+e)}};m.prototype.doCheckVersionHeader=function(e,t,r){var a=e("DataServiceVersion"),n=!a&&e("OData-Version");if(n){throw new Error("Expected 'DataServiceVersion' header with value '1.0' or '2.0' but "+"received 'OData-Version' header with value '"+n+"' in response for "+this.sServiceUrl+t)}if(a==="1.0"||a==="2.0"||!a){return}throw new Error("Expected 'DataServiceVersion' header with value '1.0' or '2.0' but "+"received value '"+a+"' in response for "+this.sServiceUrl+t)};m.prototype.doConvertResponse=function(e,t){var r,a,n,i,o,s=this;e=e.d;a=Array.isArray(e.results);if(!a&&!e.__metadata){n=Object.keys(e);r=e[n[0]];if(n.length===1){if(r===null){return{value:null}}else if(typeof r!=="object"){return{value:this.convertPrimitive(r,this.oModelInterface.fnFetchMetadata(t).getResult(),t,n[0])}}else if(r.__metadata){e=r}}}if(a&&!e.results.length){i=[]}else if(a&&!e.results[0].__metadata){o=this.oModelInterface.fnFetchMetadata(t).getResult();i=e.results.map(function(e){return s.convertPrimitive(e,o,t,"")})}else{i=this.convertNonPrimitive(e)}if(a){i={value:i};if(e.__count){i["@odata.count"]=e.__count}if(e.__next){i["@odata.nextLink"]=e.__next}}return i};m.prototype.doConvertSystemQueryOptions=function(e,t,a,n,i){var o,s={},c=this;function u(e,t){if(!Array.isArray(e)){e=e.split(",")}e.forEach(function(e){var a=e.indexOf("/");if(a>=0&&e.indexOf(".")<0){e=e.slice(0,a)}s[r.buildPath(t,e)]=true})}function f(e,t,a){if(!t||typeof t!=="object"){throw new Error("$expand must be a valid object")}Object.keys(t).forEach(function(n){var i=r.buildPath(a,n),o=t[n];e.push(i);if(typeof o==="object"){Object.keys(o).forEach(function(t){switch(t){case"$expand":f(e,o.$expand,i);break;case"$select":u(o.$select,i);break;default:throw new Error("Unsupported query option in $expand: "+t)}})}if(!o.$select){s[i+"/*"]=true}});return e}Object.keys(t).forEach(function(r){var o=r[0]==="$",s=t[r];if(n&&o){return}switch(r){case"$count":r="$inlinecount";s=s?"allpages":"none";break;case"$expand":s=f([],s,"");s=(i?s.sort():s).join(",");break;case"$orderby":break;case"$select":u(s);return;case"$filter":s=c.convertFilter(s,e);break;default:if(o){throw new Error("Unsupported system query option: "+r)}}a(r,s)});o=Object.keys(s);if(o.length>0){if(!t.$select){o.push("*")}a("$select",(i?o.sort():o).join(","))}};m.prototype.formatPropertyAsLiteral=function(e,r){function a(e,t){var a=e.parse(t);if(!a){throw new Error("Not a valid "+r.$Type+" value: "+t)}return a}if(e===null){return"null"}switch(r.$Type){case"Edm.Boolean":case"Edm.Byte":case"Edm.Decimal":case"Edm.Double":case"Edm.Guid":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":case"Edm.SByte":case"Edm.Single":case"Edm.String":break;case"Edm.Date":e=a(i,e);break;case"Edm.DateTimeOffset":e=a(c,e);break;case"Edm.TimeOfDay":e={__edmType:"Edm.Time",ms:a(l,e).getTime()};break;default:throw new Error("Type '"+r.$Type+"' in the key predicate is not supported")}return t.formatValue(e,r.$v2Type||r.$Type)};m.prototype.getPathAndAddQueryOptions=function(e,t,r,a,n){var i,o,s=this;e=e.slice(1,-5);if(t.$IsBound){e=e.slice(e.lastIndexOf(".")+1);if(typeof n==="function"){n=n()}o=this.getTypeForName(t.$Parameter[0].$Type);o.$Key.forEach(function(e){a[e]=s.formatPropertyAsLiteral(n[e],o[e])})}if(t.$Parameter){t.$Parameter.forEach(function(e){i=e.$Name;if(i in r){if(e.$IsCollection){throw new Error("Unsupported collection-valued parameter: "+i)}a[i]=s.formatPropertyAsLiteral(r[i],e);delete r[i]}})}for(i in r){delete r[i]}if(t.$v2HttpMethod){r["X-HTTP-Method"]=t.$v2HttpMethod}return e};m.prototype.getTypeForName=function(e){var t;this.mTypesByName=this.mTypesByName||{};t=this.mTypesByName[e];if(!t){t=this.mTypesByName[e]=this.oModelInterface.fnFetchMetadata("/"+e).getResult()}return t};m.prototype.isActionBodyOptional=function(){return true};m.prototype.isChangeSetOptional=function(){return false};m.prototype.ready=function(){return this.oModelInterface.fnFetchEntityContainer().then(function(){})};return function(e){jQuery.extend(e,m.prototype)}},false);