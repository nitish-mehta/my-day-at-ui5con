/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/SyncPromise","./_Cache","./_Helper","./_Parser"],function(e,t,r,i,n){"use strict";var o=/,|%2C|%2c/,s=new RegExp("^"+n.sODataIdentifier+"(?:"+n.sWhitespace+"+(?:asc|desc))?$"),a=new RegExp(n.sWhitespace+"+");function u(t,n,o,s,a){var l={},c,p,h;r.call(this,t,n,s,a);if(s.$filter){throw new Error("Unsupported system query option: $filter")}if(i.hasMinOrMax(o.aggregate)){if(s.$orderby){throw new Error("Unsupported system query option: $orderby")}if(o.groupLevels.length){throw new Error("Unsupported group levels together with min/max")}this.oMeasureRangePromise=new Promise(function(e,t){h=e});c=i.buildApply(o,l);this.oFirstLevel=r.create(t,n,e.extend({},s,{$apply:c}),a);this.oFirstLevel.getResourcePath=u.getResourcePath.bind(this.oFirstLevel,o,this.oFirstLevel.getResourcePath);this.oFirstLevel.handleResponse=u.handleResponse.bind(this.oFirstLevel,l,h,this.oFirstLevel.handleResponse)}else{if(s.$count){throw new Error("Unsupported system query option: $count")}p=u.filterAggregationForFirstLevel(o);this.oFirstLevel=r.create(t,n,e.extend({},s,{$apply:i.buildApply(p),$count:true,$orderby:u.filterOrderby(s.$orderby,p)}),a);this.oFirstLevel.calculateKeyPredicates=u.calculateKeyPredicate.bind(null,p,this.oFirstLevel.sMetaPath,this.oFirstLevel.aElements.$byPredicate)}}u.prototype=Object.create(r.prototype);u.prototype.fetchValue=function(r,i,n,o){if(!this.oMeasureRangePromise&&i==="$count"){e.sap.log.error("Failed to drill-down into $count, invalid segment: $count",this.oFirstLevel.toString(),"sap.ui.model.odata.v4.lib._Cache");return t.resolve()}return this.oFirstLevel.fetchValue(r,i,n,o)};u.prototype.getMeasureRangePromise=function(){return this.oMeasureRangePromise};u.prototype.read=function(e,t,r,i,n){var o=this.oFirstLevel.read(e,t,r,i,n);if(!this.oMeasureRangePromise){return o.then(function(e){e.value.forEach(function(e){e["@$ui5.node.isExpanded"]=false;e["@$ui5.node.isTotal"]=true;e["@$ui5.node.level"]=1});return e})}return o};u.calculateKeyPredicate=function(e,t,r,n,o){var s=e.groupLevels[0],a=i.formatLiteral(n[s],o[t][s].$Type),u="("+encodeURIComponent(s)+"="+encodeURIComponent(a)+")";function l(e){return JSON.stringify(i.publicClone(e))}if(u in r){throw new Error("Multi-unit situation detected: "+l(n)+" vs. "+l(r[u]))}i.setPrivateAnnotation(n,"predicate",u)};u.create=function(e,t,r,i,n){return new u(e,t,r,i,n)};u.filterAggregationForFirstLevel=function(e){function t(e,t){e[t]=this[t];return e}function r(e,r){return Object.keys(e).filter(r).reduce(t.bind(e),{})}function i(t){return e.aggregate[t].subtotals}function n(t){return e.groupLevels.indexOf(t)>=0}return{aggregate:r(e.aggregate,i),group:r(e.group,n),groupLevels:e.groupLevels}};u.filterOrderby=function(e,t){if(e){return e.split(o).filter(function(e){var r;if(s.test(e)){r=e.split(a)[0];return r in t.aggregate||r in t.group||t.groupLevels.indexOf(r)>=0}return true}).join(",")}};u.getResourcePath=function(e,t,r,n){var o,s;if(r!==0){throw new Error("First request needs to start at index 0")}s=t.call(this,r,n+1);o=i.clone(e);Object.keys(o.aggregate).forEach(function(e){var t=o.aggregate[e];delete t.min;delete t.max});this.mQueryOptions.$apply=i.buildApply(o);this.sQueryString=this.oRequestor.buildQueryString(this.sMetaPath,this.mQueryOptions,false,this.bSortExpandSelect);this.getResourcePath=t;return s};u.handleResponse=function(e,t,r,i,n,o,s){var a,u={},l;function c(e){u[e]=u[e]||{};return u[e]}if("@odata.count"in o){o["@odata.count"]-=1}l=o.value.splice(0,1)[0];for(a in e){c(e[a].measure)[e[a].method]=l[a]}t(u);this.handleResponse=r;this.handleResponse(i,n,o,s)};return u},false);