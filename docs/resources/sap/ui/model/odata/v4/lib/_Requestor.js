/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/SyncPromise","./_Batch","./_GroupLock","./_Helper","./_V2Requestor"],function(e,t,r,n,o,i){"use strict";var s={Accept:"multipart/mixed"},a;function u(e,t){var r=e.mBatchQueue[t];if(r[0].length===0&&r.length===1){delete e.mBatchQueue[t]}}function c(e){var t;e=e.toLowerCase();for(t in this.headers){if(t.toLowerCase()===e){return this.headers[t]}}}function h(e,t,r,n){this.mBatchQueue={};this.mHeaders=t||{};this.oModelInterface=n;this.sQueryParams=o.buildQuery(r);this.mRunningChangeRequests={};this.oSecurityTokenPromise=null;this.sServiceUrl=e}h.prototype.mFinalHeaders={"Content-Type":"application/json;charset=UTF-8;IEEE754Compatible=true"};h.prototype.mPredefinedPartHeaders={Accept:"application/json;odata.metadata=minimal;IEEE754Compatible=true"};h.prototype.mPredefinedRequestHeaders={Accept:"application/json;odata.metadata=minimal;IEEE754Compatible=true","OData-MaxVersion":"4.0","OData-Version":"4.0","X-CSRF-Token":"Fetch"};h.prototype.batchRequestSent=function(e,t){if(t){if(e in this.mRunningChangeRequests){this.mRunningChangeRequests[e]+=1}else{this.mRunningChangeRequests[e]=1}}};h.prototype.batchResponseReceived=function(e,t){if(t){this.mRunningChangeRequests[e]-=1;if(this.mRunningChangeRequests[e]===0){delete this.mRunningChangeRequests[e]}}};h.prototype.buildQueryString=function(e,t,r,n){return o.buildQuery(this.convertQueryOptions(e,t,r,n))};h.prototype.cancelChanges=function(e){if(this.mRunningChangeRequests[e]){throw new Error("Cannot cancel the changes for group '"+e+"', the batch request is running")}this.cancelChangesByFilter(function(){return true},e)};h.prototype.cancelChangesByFilter=function(e,t){var r=false,n=this;function o(t){var o=n.mBatchQueue[t],i,s,a,c;s=o[0];for(c=s.length-1;c>=0;c--){i=s[c];if(i.$cancel&&e(i)){i.$cancel();a=new Error("Request canceled: "+i.method+" "+i.url+"; group: "+t);a.canceled=true;i.$reject(a);s.splice(c,1);r=true}}u(n,t)}if(t){if(this.mBatchQueue[t]){o(t)}}else{for(t in this.mBatchQueue){o(t)}}return r};h.prototype.convertExpand=function(e,t){var r,n=[],o=this;if(!e||typeof e!=="object"){throw new Error("$expand must be a valid object")}r=Object.keys(e);if(t){r=r.sort()}r.forEach(function(r){var i=e[r];if(i&&typeof i==="object"){n.push(o.convertExpandOptions(r,i,t))}else{n.push(r)}});return n.join(",")};h.prototype.convertExpandOptions=function(e,t,r){var n=[];this.doConvertSystemQueryOptions(undefined,t,function(e,t){n.push(e+"="+t)},undefined,r);return n.length?e+"("+n.join(";")+")":e};h.prototype.convertQueryOptions=function(e,t,r,n){var o={};if(!t){return undefined}this.doConvertSystemQueryOptions(e,t,function(e,t){o[e]=t},r,n);return o};h.prototype.convertResourcePath=function(e){return e};h.prototype.doCheckVersionHeader=function(e,t,r){var n=e("OData-Version"),o=!n&&e("DataServiceVersion");if(o){throw new Error("Expected 'OData-Version' header with value '4.0' but received"+" 'DataServiceVersion' header with value '"+o+"' in response for "+this.sServiceUrl+t)}if(n==="4.0"||!n&&r){return}throw new Error("Expected 'OData-Version' header with value '4.0' but received value '"+n+"' in response for "+this.sServiceUrl+t)};h.prototype.doConvertSystemQueryOptions=function(e,t,r,n,o){var i=this;Object.keys(t).forEach(function(e){var s=t[e];if(n&&e[0]==="$"){return}switch(e){case"$expand":s=i.convertExpand(s,o);break;case"$select":if(Array.isArray(s)){s=o?s.sort().join(","):s.join(",")}break;default:}r(e,s)})};h.prototype.doConvertResponse=function(e,t){return e};h.prototype.fetchTypeForPath=function(e,t){return this.oModelInterface.fnFetchMetadata(e+(t?"/$Type":"/"))};h.prototype.formatPropertyAsLiteral=function(e,t){return o.formatLiteral(e,t.$Type)};h.prototype.getGroupSubmitMode=function(e){return this.oModelInterface.fnGetGroupProperty(e,"submit")};h.prototype.getPathAndAddQueryOptions=function(e,t,r){var n=[],o,i={},s,a=this;e=e.slice(1,-5);if(t.$Parameter){t.$Parameter.forEach(function(e){i[e.$Name]=e})}if(t.$kind==="Function"){for(o in r){s=i[o];if(s){if(s.$IsCollection){throw new Error("Unsupported collection-valued parameter: "+o)}n.push(encodeURIComponent(o)+"="+encodeURIComponent(a.formatPropertyAsLiteral(r[o],s)))}}e+="("+n.join(",")+")"}else{for(o in r){if(!(o in i)){delete r[o]}}}return e};h.prototype.getServiceUrl=function(){return this.sServiceUrl};h.prototype.hasPendingChanges=function(){var e,t;for(e in this.mBatchQueue){t=this.mBatchQueue[e][0].some(function(e){return e.$cancel});if(t){return true}}return Object.keys(this.mRunningChangeRequests).length>0};h.prototype.isActionBodyOptional=function(){return false};h.prototype.isChangeSetOptional=function(){return true};h.prototype.ready=function(){return t.resolve()};h.prototype.refreshSecurityToken=function(t){var r=this;if(!this.oSecurityTokenPromise){if(t!==this.mHeaders["X-CSRF-Token"]){return Promise.resolve()}this.oSecurityTokenPromise=new Promise(function(t,n){e.ajax(r.sServiceUrl+r.sQueryParams,{method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}).then(function(e,n,o){r.mHeaders["X-CSRF-Token"]=o.getResponseHeader("X-CSRF-Token");r.oSecurityTokenPromise=null;t()},function(e,t,i){r.oSecurityTokenPromise=null;n(o.createError(e))})})}return this.oSecurityTokenPromise};h.prototype.removePatch=function(e){var t=this.cancelChangesByFilter(function(t){return t.$promise===e});if(!t){throw new Error("Cannot reset the changes, the batch request is running")}};h.prototype.removePost=function(e,t){var r=this.cancelChangesByFilter(function(e){return e.body===t},e);if(!r){throw new Error("Cannot reset the changes, the batch request is running")}};h.prototype.request=function(t,r,n,o,i,s,u,c){var h=n&&n.getGroupId()||"$direct",f,p,d=this;if(h==="$cached"){throw new Error("Unexpected request: "+t+" "+r)}if(n){n.unlock()}r=this.convertResourcePath(r);if(this.getGroupSubmitMode(h)!=="Direct"){f=new Promise(function(n,a){var f=d.mBatchQueue[h];if(!f){f=d.mBatchQueue[h]=[[]];if(d.oModelInterface.fnOnCreateGroup){d.oModelInterface.fnOnCreateGroup(h)}}p={method:t,url:r,headers:e.extend({},d.mPredefinedPartHeaders,d.mHeaders,o,d.mFinalHeaders),body:i,$cancel:u,$metaPath:c,$reject:a,$resolve:n,$submit:s};if(t==="GET"){f.push(p)}else{f[0].push(p)}});p.$promise=f;return f}if(s){s()}return this.sendRequest(t,r,e.extend({},o,this.mFinalHeaders),JSON.stringify(a.cleanPayload(i))).then(function(e){return d.doConvertResponse(e.body,c)})};h.prototype.relocate=function(e,t,r){var o=this.mBatchQueue[e],i=this,s=o&&o[0].some(function(s,a){if(s.body===t){i.request(s.method,s.url,new n(r),s.headers,t,s.$submit,s.$cancel).then(s.$resolve,s.$reject);o[0].splice(a,1);u(i,e);return true}});if(!s){throw new Error("Request not found in group '"+e+"'")}};h.prototype.sendBatch=function(t){var n=r.serializeBatchRequest(t);return this.sendRequest("POST","$batch"+this.sQueryParams,e.extend(n.headers,s),n.body).then(function(e){return r.deserializeBatchResponse(e.contentType,e.body)})};h.prototype.sendRequest=function(t,r,n,i){var s=this.sServiceUrl+r,a=this;return new Promise(function(u,c){function h(f){var p=a.mHeaders["X-CSRF-Token"];return e.ajax(s,{data:i,headers:e.extend({},a.mPredefinedRequestHeaders,a.mHeaders,n),method:t}).then(function(e,t,n){try{a.doCheckVersionHeader(n.getResponseHeader,r,!e)}catch(e){c(e);return}a.mHeaders["X-CSRF-Token"]=n.getResponseHeader("X-CSRF-Token")||a.mHeaders["X-CSRF-Token"];u({body:e,contentType:n.getResponseHeader("Content-Type")})},function(e,t,r){var n=e.getResponseHeader("X-CSRF-Token");if(!f&&e.status===403&&n&&n.toLowerCase()==="required"){a.refreshSecurityToken(p).then(function(){h(true)},c)}else{c(o.createError(e))}})}if(a.oSecurityTokenPromise&&t!=="GET"){return a.oSecurityTokenPromise.then(h)}return h()})};h.prototype.submitBatch=function(t){var r=[],n,i,s=this.mBatchQueue[t],u=this;function h(t,r){var n,o,i;if(t&&t.method==="PATCH"&&r.method==="PATCH"&&t.url===r.url&&e.sap.equal(t.headers,r.headers)){o=t.body;n=r.body;for(i in o){if(o[i]===null&&n[i]&&typeof n[i]==="object"){return undefined}}return e.extend(true,o,n)}return undefined}function f(e,t){var r;e.forEach(function(e,n){var i,s,a=t[n];if(Array.isArray(a)){f(e,a)}else if(!a){i=new Error("HTTP request was not processed because the previous request failed");i.cause=r;e.$reject(i)}else if(a.status>=400){a.getResponseHeader=c;r=o.createError(a);d(r,e)}else if(a.responseText){s=JSON.parse(a.responseText);try{u.doCheckVersionHeader(c.bind(a),e.url,true);e.$resolve(u.doConvertResponse(s,e.$metaPath))}catch(t){e.$reject(t)}}else{e.$resolve()}})}function p(e){if(Array.isArray(e)){e.forEach(p)}else if(e.$submit){e.$submit()}}function d(e,t){if(Array.isArray(t)){t.forEach(d.bind(null,e))}else{t.$reject(e)}}if(!s){return Promise.resolve()}delete this.mBatchQueue[t];p(s);s[0].forEach(function(e){var t=h(i,e);if(t){i.body=t;e.$resolve(i.$promise)}else{r.push(e);i=e}});if(r.length===0){s.splice(0,1)}else if(r.length===1&&this.isChangeSetOptional()){s[0]=r[0]}else{s[0]=r}n=r.length>0;this.batchRequestSent(t,n);return this.sendBatch(a.cleanBatch(s)).then(function(e){u.batchResponseReceived(t,n);f(s,e)}).catch(function(e){var r=new Error("HTTP request was not processed because $batch failed");function o(e){e.forEach(function(e){if(Array.isArray(e)){o(e)}else{e.$reject(r)}})}u.batchResponseReceived(t,n);r.cause=e;o(s);throw e})};a={cleanBatch:function(e){e.forEach(function(e){if(Array.isArray(e)){a.cleanBatch(e)}else{e.body=a.cleanPayload(e.body)}});return e},cleanPayload:function(t){var r=t;if(r){Object.keys(r).forEach(function(n){if(n.indexOf("@$ui5.")===0){if(r===t){r=e.extend({},t)}delete r[n]}})}return r},create:function(e,t,r,n,o){var s=new h(e,r,n,t);if(o==="2.0"){i(s)}return s}};return a},false);