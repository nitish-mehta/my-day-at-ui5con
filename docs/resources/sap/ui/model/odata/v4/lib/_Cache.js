/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/SyncPromise","./_GroupLock","./_Helper","./_Requestor"],function(e,t,n,i,r){"use strict";var s=/^([^(]*)(\(.*\))$/;function o(e,t,n,i){if(n.$count!==undefined){h(e,t,n,n.$count+i)}}function a(e){return e.$count!==undefined?e.$count:Infinity}function u(e,t){return t===""||e===t||e.indexOf(t+"/")===0}function h(e,t,n,r){if(typeof r==="string"){r=parseInt(r,10)}i.updateCache(e,t,n,{$count:r})}function c(e,t,n,r){this.bActive=true;this.mChangeListeners={};this.sMetaPath=i.getMetaPath("/"+t);this.mPatchRequests={};this.mPostRequests={};this.oRequestor=e;this.bSortExpandSelect=r;this.sResourcePath=t;this.bSentReadRequest=false;this.oTypePromise=undefined;this.setQueryOptions(n)}c.prototype._delete=function(e,t,r,s){var a=r.split("/"),u=a.pop(),h=a.join("/"),l=this;return this.fetchValue(n.$cached,h).then(function(n){var r=u?n[u]:n,a,f=i.getPrivateAnnotation(r,"transient");if(f===true){throw new Error("No 'delete' allowed while waiting for server response")}if(f){e.unlock();l.oRequestor.removePost(f,r);return Promise.resolve()}if(r["$ui5.deleting"]){throw new Error("Must not delete twice: "+t)}r["$ui5.deleting"]=true;a={"If-Match":r["@odata.etag"]};t+=l.oRequestor.buildQueryString(l.sMetaPath,l.mQueryOptions,true);return l.oRequestor.request("DELETE",t,e,a)["catch"](function(e){if(e.status!==404){delete r["$ui5.deleting"];throw e}}).then(function(){var e;if(Array.isArray(n)){if(n[u]!==r){u=n.indexOf(r)}if(u==="-1"){delete n[-1]}else{e=i.getPrivateAnnotation(r,"predicate");if(e){delete n.$byPredicate[e]}n.splice(u,1)}o(l.mChangeListeners,h,n,-1);l.iLimit-=1;s(Number(u),n)}else{if(u){i.updateCache(l.mChangeListeners,h,n,c.makeUpdateData([u],null))}else{r["$ui5.deleted"]=true}s()}})})};c.prototype.addByPath=function(e,t,n){if(n){if(!e[t]){e[t]=[n]}else if(e[t].indexOf(n)<0){e[t].push(n)}}};c.prototype.calculateKeyPredicates=function(e,t,n){function r(e,t){var n,r,o;e.$byPredicate={};for(n=0;n<e.length;n++){r=e[n];s(r,t);o=i.getPrivateAnnotation(r,"predicate");if(o){e.$byPredicate[o]=r}}}function s(e,n){var o=t[n];if(typeof e!=="object"){return}if(o&&o.$Key){i.setPrivateAnnotation(e,"predicate",i.getKeyPredicate(e,n,t))}Object.keys(e).forEach(function(t){var i=e[t],o=n+"/"+t;if(Array.isArray(i)){r(i,o)}else if(i&&typeof i==="object"){s(i,o)}})}s(e,n||this.sMetaPath)};c.prototype.checkActive=function(){var e;if(!this.bActive){e=new Error("Response discarded: cache is inactive");e.canceled=true;throw e}};c.prototype.create=function(s,a,u,h,c,l){var f,d=this;function p(){d.removeByPath(d.mPostRequests,u,h);delete f[-1];c()}function m(){i.setPrivateAnnotation(h,"transient",true)}function y(e,t){var r=t.getGroupId();i.setPrivateAnnotation(h,"transient",r);d.addByPath(d.mPostRequests,u,h);return d.oRequestor.request("POST",e,t,null,h,m,p).then(function(e){i.deletePrivateAnnotation(h,"transient");o(d.mChangeListeners,u,f,1);d.removeByPath(d.mPostRequests,u,h);i.updateCacheAfterPost(d.mChangeListeners,i.buildPath(u,"-1"),h,e,i.getSelectForPath(d.mQueryOptions,u));d.fetchTypes().then(function(e){i.setPrivateAnnotation(h,"predicate",i.getKeyPredicate(h,i.getMetaPath(i.buildPath(d.sMetaPath,u)),e))})},function(t){if(t.canceled){throw t}if(l){l(t)}return y(e,new n(d.oRequestor.getGroupSubmitMode(r)==="API"?r:"$parked."+r))})}h=e.extend(true,{},h);h=r.cleanPayload(h);f=this.fetchValue(n.$cached,u).getResult();if(!Array.isArray(f)){throw new Error("Create is only supported for collections; '"+u+"' does not reference a collection")}f[-1]=h;return t.resolve(a).then(function(e){e+=d.oRequestor.buildQueryString(d.sMetaPath,d.mQueryOptions,true);return y(e,s)})};c.prototype.deregisterChange=function(e,t){this.removeByPath(this.mChangeListeners,e,t)};c.prototype.drillDown=function(t,n){var r=this;function o(t){e.sap.log.error("Failed to drill-down into "+n+", invalid segment: "+t,r.toString(),"sap.ui.model.odata.v4.lib._Cache");return undefined}function a(e,t,s){var a="",u,h,c;if(n[0]!=="("){a+="/"}a+=n.split("/").slice(0,s).join("/");u=r.oRequestor.fetchTypeForPath(r.sMetaPath+i.getMetaPath(a),true).getResult();if(u==="Edm.Stream"){h=e[t+"@odata.mediaReadLink"];c=r.oRequestor.getServiceUrl();if(h){return i.makeAbsolute(h,c)}return c+r.sResourcePath+a}return o(t)}if(!n){return t}return n.split("/").reduce(function(e,t,n){var i,r;if(t==="$count"){return Array.isArray(e)?e.$count:o(t)}if(e===undefined||e===null){return undefined}if(typeof e!=="object"||t==="@$ui5._"){return o(t)}r=e;i=s.exec(t);if(i){if(i[1]){e=e[i[1]]}if(e){e=e.$byPredicate[i[2]]}}else{e=e[t]}return e===undefined&&t[0]!=="#"?a(r,t,n+1):e},t)};c.prototype.fetchTypes=function(){var e,n,i=this;function r(e,t){if(t&&t.$expand){Object.keys(t.$expand).forEach(function(n){var i=e;n.split("/").forEach(function(e){i+="/"+e;s(i)});r(i,t.$expand[n])})}}function s(t){e.push(i.oRequestor.fetchTypeForPath(t).then(function(e){n[t]=e;if(e&&e.$Key){e.$Key.forEach(function(e){var n,i;if(typeof e!=="string"){i=e[Object.keys(e)[0]];n=i.lastIndexOf("/");if(n>=0){s(t+"/"+i.slice(0,n))}}})}}))}if(!this.oTypePromise){e=[];n={};s(this.sMetaPath);if(this.bFetchOperationReturnType){s(this.sMetaPath+"/$Type")}r(this.sMetaPath,this.mQueryOptions);this.oTypePromise=t.all(e).then(function(){return n})}return this.oTypePromise};c.prototype.hasPendingChangesForPath=function(e){return Object.keys(this.mPatchRequests).some(function(t){return u(t,e)})||Object.keys(this.mPostRequests).some(function(t){return u(t,e)})};c.prototype.registerChange=function(e,t){this.addByPath(this.mChangeListeners,e,t)};c.prototype.removeByPath=function(e,t,n){var i=e[t],r;if(i){r=i.indexOf(n);if(r>=0){if(i.length===1){delete e[t]}else{i.splice(r,1)}}}};c.prototype.resetChangesForPath=function(e){var t=this;Object.keys(this.mPatchRequests).forEach(function(n){var i,r;if(u(n,e)){r=t.mPatchRequests[n];for(i=r.length-1;i>=0;i--){t.oRequestor.removePatch(r[i])}delete t.mPatchRequests[n]}});Object.keys(this.mPostRequests).forEach(function(n){var r,s,o;if(u(n,e)){r=t.mPostRequests[n];for(s=r.length-1;s>=0;s--){o=i.getPrivateAnnotation(r[s],"transient");t.oRequestor.removePost(o,r[s])}delete t.mPostRequests[n]}})};c.prototype.setActive=function(e){this.bActive=e;if(!e){this.mChangeListeners={}}};c.prototype.setQueryOptions=function(e){if(this.bSentReadRequest){throw new Error("Cannot set query options: Cache has already sent a read request")}this.mQueryOptions=e;this.sQueryString=this.oRequestor.buildQueryString(this.sMetaPath,e,false,this.bSortExpandSelect)};c.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath+this.sQueryString};c.prototype.update=function(t,n,r,s,o,a,u){var h=n.split("/"),l,f=this;return this.fetchValue(t.getUnlockedCopy(),a).then(function(d){var p=i.buildPath(a,n),m=t.getGroupId(),y,P,g,v,E,R=c.makeUpdateData(h,r);function b(){f.removeByPath(f.mPatchRequests,p,P);i.updateCache(f.mChangeListeners,a,d,c.makeUpdateData(h,y))}function q(e){P=f.oRequestor.request("PATCH",o,e,{"If-Match":d["@odata.etag"]},R,undefined,b);f.addByPath(f.mPatchRequests,p,P);return P.then(function(e){f.removeByPath(f.mPatchRequests,p,P);i.updateCache(f.mChangeListeners,a,d,e);return e},function(t){f.removeByPath(f.mPatchRequests,p,P);if(!t.canceled){s(t);if(f.oRequestor.getGroupSubmitMode(m)==="API"){return q(e.getUnlockedCopy())}}throw t})}if(!d){throw new Error("Cannot update '"+n+"': '"+a+"' does not exist")}v=i.getPrivateAnnotation(d,"transient");if(v){if(v===true){throw new Error("No 'update' allowed while waiting for server response")}if(v.indexOf("$parked.")===0){g=v;v=v.slice(8)}if(v!==m){throw new Error("The entity will be created via group '"+v+"'. Cannot patch via group '"+m+"'")}}y=i.drillDown(d,h);i.updateCache(f.mChangeListeners,a,d,R);if(u){l=u.split("/");E=i.drillDown(d,l);if(E===undefined){e.sap.log.debug("Missing value for unit of measure "+i.buildPath(a,u)+" when updating "+p,f.toString(),"sap.ui.model.odata.v4.lib._Cache")}else{e.extend(true,R,c.makeUpdateData(l,E))}}if(v){if(g){i.setPrivateAnnotation(d,"transient",v);f.oRequestor.relocate(g,d,v)}t.unlock();return Promise.resolve({})}o+=f.oRequestor.buildQueryString(f.sMetaPath,f.mQueryOptions,true);return q(t)})};function l(e,t,n,i){c.apply(this,arguments);this.sContext=undefined;this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$tail=undefined;this.iLimit=Infinity;this.oSyncPromiseAll=undefined}l.prototype=Object.create(c.prototype);l.prototype.fetchValue=function(e,n,i,r){var s,o=this;e.unlock();if(!this.oSyncPromiseAll){s=this.aElements.$tail?this.aElements.concat(this.aElements.$tail):this.aElements;this.oSyncPromiseAll=t.all(s)}return this.oSyncPromiseAll.then(function(){o.checkActive();o.registerChange(n,r);return o.drillDown(o.aElements,n)})};l.prototype.fill=function(e,t,n){var i,r=Math.max(this.aElements.length,1024);if(n>r){if(this.aElements.$tail&&e){throw new Error("Cannot fill from "+t+" to "+n+", $tail already in use, # of elements is "+this.aElements.length)}this.aElements.$tail=e;n=this.aElements.length}for(i=t;i<n;i++){this.aElements[i]=e}this.oSyncPromiseAll=undefined};l.prototype.getReadRange=function(e,t,n){var i=this.aElements;function r(e,t){var n;for(n=e;n<t;n+=1){if(i[n]===undefined){return true}}return false}if(r(e+t,e+t+n/2)){t+=n}if(r(Math.max(e-n/2,0),e)){t+=n;e-=n;if(e<0){t+=e;if(isNaN(t)){t=Infinity}e=0}}return{length:t,start:e}};l.prototype.getResourcePath=function(e,t){var n=this.sQueryString?"&":"?",i=t-e,r=this.sResourcePath+this.sQueryString;if(e>0||i<Infinity){r+=n+"$skip="+e}if(i<Infinity){r+="&$top="+i}return r};l.prototype.handleResponse=function(e,t,n,r){var s,o,u,l,f,d=n.value.length;this.sContext=n["@odata.context"];o=n["@odata.count"];if(o){this.iLimit=parseInt(o,10);h(this.mChangeListeners,"",this.aElements,this.iLimit)}for(l=0;l<d;l++){u=n.value[l];this.aElements[e+l]=u;c.computeCount(u);this.calculateKeyPredicates(u,r);f=i.getPrivateAnnotation(u,"predicate");if(f){this.aElements.$byPredicate[f]=u}}if(d<t-e){s=Math.min(a(this.aElements),e+d);this.aElements.length=s;if(!o&&s>0&&!this.aElements[s-1]){s=undefined}h(this.mChangeListeners,"",this.aElements,s);this.iLimit=s}};l.prototype.read=function(e,n,i,r,s){var o,a,u,h,c=-1,l=this.aElements[-1]?-1:0,f,d=Math.max(e,0),p=this;if(e<l){throw new Error("Illegal index "+e+", must be >= "+l)}if(n<0){throw new Error("Illegal length "+n+", must be >= 0")}if(this.aElements.$tail){return this.aElements.$tail.then(function(){return p.read(e,n,i,r,s)})}f=this.getReadRange(e,n,i);h=Math.min(f.start+f.length,this.iLimit);a=Math.min(h,Math.max(f.start,this.aElements.length)+1);for(o=f.start;o<a;o++){if(this.aElements[o]!==undefined){if(c>=0){this.requestElements(c,o,r.getUnlockedCopy(),s);s=undefined;c=-1}}else if(c<0){c=o}}if(c>=0){this.requestElements(c,h,r.getUnlockedCopy(),s)}r.unlock();u=this.aElements.slice(d,h);if(this.aElements.$tail){u.push(this.aElements.$tail)}return t.all(u).then(function(){var t;p.checkActive();t={"@odata.context":p.sContext,value:p.aElements.slice(d,h)};t.value.$count=p.aElements.$count;if(e===-1){t.value.unshift(p.aElements[-1])}return t})};l.prototype.requestElements=function(e,n,i,r){var s,o=this;s=t.all([this.oRequestor.request("GET",this.getResourcePath(e,n),i,undefined,undefined,r),this.fetchTypes()]).then(function(t){if(o.aElements.$tail===s){o.aElements.$tail=undefined}o.handleResponse(e,n,t[0],t[1])})["catch"](function(t){o.fill(undefined,e,n);throw t});this.bSentReadRequest=true;this.fill(s,e,n)};l.prototype.refreshSingle=function(n,r,s){var o=i.getPrivateAnnotation(this.aElements[r],"predicate"),a,u=this.sResourcePath+o,h=e.extend({},this.mQueryOptions),l=this;delete h["$count"];delete h["$filter"];delete h["$orderby"];u+=this.oRequestor.buildQueryString(this.sMetaPath,h,false,this.bSortExpandSelect);a=t.all([this.oRequestor.request("GET",u,n,undefined,undefined,s),this.fetchTypes()]).then(function(e){var t=e[0];l.aElements[r]=l.aElements.$byPredicate[o]=t;l.calculateKeyPredicates(t,e[1]);c.computeCount(t)});this.bSentReadRequest=true;return a};l.prototype.refreshSingleWithRemove=function(t,n,r,s){var a=this;return this.fetchTypes().then(function(u){var h,l=[],f=a.aElements[n],d=i.getKeyProperties(f,"/"+a.sResourcePath,u),p=i.getPrivateAnnotation(f,"predicate"),m=e.extend({},a.mQueryOptions),y=m["$filter"],P=a.sResourcePath;for(h in d){l.push(h+" eq "+d[h])}m["$filter"]=(y?"("+y+") and ":"")+l.join(" and ");P+=a.oRequestor.buildQueryString(a.sMetaPath,m,false,a.bSortExpandSelect);a.bSentReadRequest=true;return a.oRequestor.request("GET",P,t,undefined,undefined,r).then(function(e){if(a.aElements[n]!==f){n=a.aElements.indexOf(f)}if(e.value.length>1){throw new Error("Unexpected server response, more than one entity returned.")}else if(e.value.length===0){if(n===-1){delete a.aElements[-1]}else{a.aElements.splice(n,1)}delete a.aElements.$byPredicate[p];o(a.mChangeListeners,"",a.aElements,-1);a.iLimit-=1;s(n)}else{e=e.value[0];a.aElements[n]=a.aElements.$byPredicate[p]=e;a.calculateKeyPredicates(e,u);c.computeCount(e)}})})};function f(e,t,n){c.call(this,e,t,n);this.oPromise=null}f.prototype=Object.create(c.prototype);f.prototype._delete=function(){throw new Error("Unsupported")};f.prototype.create=function(){throw new Error("Unsupported")};f.prototype.fetchValue=function(e,n,i,r){var s=this;s.registerChange("",r);if(!this.oPromise){this.oPromise=t.resolve(this.oRequestor.request("GET",this.sResourcePath+this.sQueryString,e,undefined,undefined,i,undefined,this.sMetaPath));this.bSentReadRequest=true}else{e.unlock()}return this.oPromise.then(function(e){s.checkActive();return e.value})};f.prototype.update=function(){throw new Error("Unsupported")};function d(e,t,n,i,r,s,o){c.apply(this,arguments);this.bFetchOperationReturnType=o;this.sMetaPath=s||this.sMetaPath;this.bPost=r;this.bPosting=false;this.oPromise=null}d.prototype=Object.create(c.prototype);d.prototype.fetchValue=function(e,n,i,r){var s=this.sResourcePath+this.sQueryString,o=this;this.registerChange(n,r);if(!this.oPromise){if(this.bPost){throw new Error("Cannot fetch a value before the POST request")}this.oPromise=t.all([this.oRequestor.request("GET",s,e,undefined,undefined,i,undefined,this.sMetaPath),this.fetchTypes()]).then(function(e){o.calculateKeyPredicates(e[0],e[1],o.bFetchOperationReturnType?o.sMetaPath+"/$Type":undefined);c.computeCount(e[0]);return e[0]});this.bSentReadRequest=true}else{e.unlock()}return this.oPromise.then(function(e){o.checkActive();if(e["$ui5.deleted"]){throw new Error("Cannot read a deleted entity")}return o.drillDown(e,n)})};d.prototype.post=function(e,n,i){var r="POST",s,o=this;if(!this.bPost){throw new Error("POST request not allowed")}if(this.bPosting){throw new Error("Parallel POST requests not allowed")}if(n){r=n["X-HTTP-Method"]||r;delete n["X-HTTP-Method"];if(this.oRequestor.isActionBodyOptional()&&!Object.keys(n).length){n=undefined}}s=[this.oRequestor.request(r,this.sResourcePath+this.sQueryString,e,{"If-Match":i},n)];if(this.bFetchOperationReturnType){s.push(this.fetchTypes())}this.oPromise=t.all(s).then(function(e){o.bPosting=false;if(o.bFetchOperationReturnType){o.calculateKeyPredicates(e[0],e[1],o.sMetaPath+"/$Type")}return e[0]},function(e){o.bPosting=false;throw e});this.bPosting=true;return this.oPromise};c.create=function(e,t,n,i){return new l(e,t,n,i)};c.createProperty=function(e,t,n){return new f(e,t,n)};c.createSingle=function(e,t,n,i,r,s,o){return new d(e,t,n,i,r,s,o)};c.computeCount=function(e){if(e&&typeof e==="object"){Object.keys(e).forEach(function(t){var n,i=e[t];if(Array.isArray(i)){i.$count=undefined;n=e[t+"@odata.count"];if(n){h({},"",i,n)}else if(!e[t+"@odata.nextLink"]){h({},"",i,i.length)}i.forEach(c.computeCount)}else{c.computeCount(i)}})}};c.makeUpdateData=function(e,t){return e.reduceRight(function(e,t){var n={};n[t]=e;return n},t)};return c},false);