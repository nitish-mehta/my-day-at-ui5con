/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/SyncPromise","sap/ui/model/Binding","sap/ui/model/ChangeReason","sap/ui/model/ContextBinding","./Context","./lib/_Cache","./lib/_Helper","./ODataParentBinding"],function(e,t,o,n,i,r,a,s,h){"use strict";var u="sap.ui.model.odata.v4.ODataContextBinding",d={AggregatedDataStateChange:true,change:true,dataReceived:true,dataRequested:true,DataStateChange:true};var l=i.extend("sap.ui.model.odata.v4.ODataContextBinding",{constructor:function(o,n,a,s){var h=n.indexOf("(...)");i.call(this,o,n);if(n.slice(-1)==="/"){throw new Error("Invalid path: "+n)}this.mAggregatedQueryOptions={};this.bAggregatedQueryOptionsInitial=true;this.oCachePromise=t.resolve();this.mCacheByContext=undefined;this.sGroupId=undefined;this.bInheritExpandSelect=false;this.oOperation=undefined;this.aChildCanUseCachePromises=[];this.oReturnValueContext=null;this.sUpdateGroupId=undefined;if(h>=0){this.oOperation={bAction:undefined,mParameters:{},sResourcePath:undefined};if(h!==this.sPath.length-5){throw new Error("The path must not continue after a deferred operation: "+this.sPath)}}this.applyParameters(e.extend(true,{},s));this.oElementContext=this.bRelative?null:r.create(this.oModel,this,n);this.setContext(a);o.bindingCreated(this)},metadata:{publicMethods:[]}});h(l.prototype);l.prototype._delete=function(e,t){var o=this;if(this.sPath===""&&this.oContext["delete"]){return this.oContext._delete(e)}if(this.hasPendingChanges()){throw new Error("Cannot delete due to pending changes")}return this.deleteFromCache(e,t,"",function(){o.oElementContext.destroy();o.oElementContext=null;if(o.oReturnValueContext){o.oReturnValueContext.destroy();o.oReturnValueContext=null}o._fireChange({reason:n.Remove})})};l.prototype._execute=function(e){var t=this.oModel.getMetaModel(),o,i,a=this.oModel.resolve(this.sPath,this.oContext),h=this;function d(){h._fireChange({reason:n.Change});h.oModel.getDependentBindings(h).forEach(function(t){t.refreshInternal(e.getGroupId(),true)})}e.setGroupId(this.getGroupId());i=t.fetchObject(t.getMetaPath(a)+"/@$ui5.overload").then(function(t){var n,i,r;if(!t){throw new Error("Unknown operation: "+a)}if(t.length!==1){throw new Error("Unsupported overloads for "+a)}if(h.bRelative&&h.oContext.getBinding){i=h.sPath.lastIndexOf("/");r=i>=0?h.sPath.slice(0,i):"";n=h.oContext.getObject.bind(h.oContext,r)}o=t[0];return h.createCacheAndRequest(e,a,o,n)}).then(function(e){d();if(h.hasReturnValueContext(o)){if(h.oReturnValueContext){h.oReturnValueContext.destroy()}h.oReturnValueContext=r.create(h.oModel,h,a.slice(0,a.indexOf("("))+s.getPrivateAnnotation(e,"predicate"));return h.oReturnValueContext}},function(e){d();throw e})["catch"](function(t){e.unlock(true);if(h.oReturnValueContext){h.oReturnValueContext.destroy();h.oReturnValueContext=null}h.oModel.reportError("Failed to execute "+a,u,t);throw t});return Promise.resolve(i)};l.prototype.applyParameters=function(e,t){var o=this.oModel.buildBindingParameters(e,["$$groupId","$$inheritExpandSelect","$$ownRequest","$$updateGroupId"]);if(o.$$inheritExpandSelect){if(!this.oOperation){throw new Error("Unsupported binding parameter $$inheritExpandSelect: "+"binding is not an operation binding")}if(o.$expand||o.$select){throw new Error("Must not set parameter $$inheritExpandSelect on binding which has "+"$expand or $select")}}this.sGroupId=o.$$groupId;this.sUpdateGroupId=o.$$updateGroupId;this.bInheritExpandSelect=o.$$inheritExpandSelect;this.mQueryOptions=this.oModel.buildQueryOptions(e,true);this.mParameters=e;if(!this.oOperation){this.fetchCache(this.oContext);if(t){this.refreshInternal(undefined,true)}else{this.checkUpdate()}}else if(this.oOperation.bAction===false){this.execute()}};l.prototype.attachEvent=function(e){if(!(e in d)){throw new Error("Unsupported event '"+e+"': v4.ODataContextBinding#attachEvent")}return i.prototype.attachEvent.apply(this,arguments)};l.prototype.createCacheAndRequest=function(o,n,i,r){var s=i.$kind==="Action",h,u=r,d,l=this.hasReturnValueContext(i),p=this.oModel,c=p.getMetaModel().getMetaPath(n)+"/@$ui5.overload/0/$ReturnType",f=e.extend({},this.oOperation.mParameters),C,x=p.oRequestor,g=e.extend({},p.mUriParameters,this.mQueryOptions);if(!s&&i.$kind!=="Function"){throw new Error("Not an operation: "+n)}if(this.bInheritExpandSelect){if(l){C=this.oContext.getBinding().mCacheQueryOptions;if("$select"in C){g.$select=C.$select}if("$expand"in C){g.$expand=C.$expand}}else{throw new Error("Must not set parameter $$inheritExpandSelect on binding which has "+"no return value context")}}this.oOperation.bAction=s;if(s&&r){u=r();d=u&&u["@odata.etag"]}n=x.getPathAndAddQueryOptions(n,i,f,g,u);this.mCacheQueryOptions=g;h=a.createSingle(x,n,g,p.bAutoExpandSelect,s,c,l);this.oCachePromise=t.resolve(h);return s?h.post(o,f,d):h.fetchValue(o)};l.prototype.destroy=function(){if(this.oElementContext){this.oElementContext.destroy()}if(this.oReturnValueContext){this.oReturnValueContext.destroy()}this.oModel.bindingDestroyed(this);this.oCachePromise=undefined;this.oContext=undefined;i.prototype.destroy.apply(this)};l.prototype.doCreateCache=function(e,t){return a.createSingle(this.oModel.oRequestor,e,t,this.oModel.bAutoExpandSelect)};l.prototype.doFetchQueryOptions=function(){return t.resolve(this.mQueryOptions)};l.prototype.execute=function(e){var t=this.oModel.resolve(this.sPath,this.oContext);this.checkSuspended();this.oModel.checkGroupId(e);if(!this.oOperation){throw new Error("The binding must be deferred: "+this.sPath)}if(this.bRelative){if(!t){throw new Error("Unresolved binding: "+this.sPath)}if(this.oContext.isTransient&&this.oContext.isTransient()){throw new Error("Execute for transient context not allowed: "+t)}if(this.oContext.getPath().indexOf("(...)")>=0){throw new Error("Nested deferred operation bindings not supported: "+t)}}return this._execute(this.oModel.lockGroup(e,true))};l.prototype.fetchValue=function(e,t){var o,n,i=this.getRootBinding(),r=this;if(i&&i.isSuspended()){o=new Error("Suspended binding provides no value");o.canceled="noDebugLog";throw o}return this.oCachePromise.then(function(o){var i=false,a;if(o){a=r.getRelativePath(e);if(a!==undefined){n=r.oModel.lockGroup(r.getGroupId(),r.oRefreshGroupLock);r.oRefreshGroupLock=undefined;return o.fetchValue(n,a,function(){i=true;r.fireDataRequested()},t).then(function(e){if(i){r.fireDataReceived({data:{}})}return e},function(e){n.unlock(true);if(i){r.oModel.reportError("Failed to read path "+r.sPath,u,e);r.fireDataReceived(e.canceled?{data:{}}:{error:e})}throw e})}}if(!r.oOperation&&r.oContext&&r.oContext.fetchValue){return r.oContext.fetchValue(e,t)}})};l.prototype.hasReturnValueContext=function(e){var t=this.oModel.getMetaModel(),o=t.getMetaPath(this.oModel.resolve(this.sPath,this.oContext)).split("/");return e.$IsBound&&e.$ReturnType&&!e.$ReturnType.$isCollection&&e.$EntitySetPath&&e.$EntitySetPath.indexOf("/")<0&&this.bRelative&&this.oContext&&this.oContext.getBinding&&o.length===3&&t.getObject("/"+o[1]).$kind==="EntitySet"};l.prototype.refreshInternal=function(e,t){var o=this;if(this.oOperation&&this.oOperation.bAction!==false){return}this.createRefreshGroupLock(e,this.isRefreshable());this.oCachePromise.then(function(i){if(!o.oElementContext){o.oElementContext=r.create(o.oModel,o,o.oModel.resolve(o.sPath,o.oContext));if(!i){o._fireChange({reason:n.Refresh})}}if(!o.oOperation){if(i){o.mCacheByContext=undefined;o.fetchCache(o.oContext)}o.oModel.getDependentBindings(o).forEach(function(o){o.refreshInternal(e,t)})}else{o._execute(o.oRefreshGroupLock);o.oRefreshGroupLock=undefined}})};l.prototype.resumeInternal=function(e){if(!this.oOperation){this.mAggregatedQueryOptions={};this.bAggregatedQueryOptionsInitial=true;this.mCacheByContext=undefined;this.fetchCache(this.oContext);this.oModel.getDependentBindings(this).forEach(function(t){t.resumeInternal(e)});this._fireChange({reason:n.Change})}else if(this.oOperation.bAction===false){this.execute()}};l.prototype.setContext=function(e){if(this.oContext!==e){if(this.bRelative&&(this.oContext||e)){if(this.oElementContext){this.oElementContext.destroy();this.oElementContext=null}if(this.oReturnValueContext){this.oReturnValueContext.destroy();this.oReturnValueContext=null}this.fetchCache(e);if(e){this.oElementContext=r.create(this.oModel,this,this.oModel.resolve(this.sPath,e))}o.prototype.setContext.call(this,e)}else{this.oContext=e}}};l.prototype.setParameter=function(e,t){if(!this.oOperation){throw new Error("The binding must be deferred: "+this.sPath)}if(!e){throw new Error("Missing parameter name")}if(t===undefined){throw new Error("Missing value for parameter: "+e)}this.oOperation.mParameters[e]=t;this.oOperation.bAction=undefined;return this};return l});