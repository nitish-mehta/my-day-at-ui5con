/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/SyncPromise","sap/ui/core/message/Message","sap/ui/model/BindingMode","sap/ui/model/Context","sap/ui/model/Model","sap/ui/model/odata/OperationMode","sap/ui/thirdparty/URI","./lib/_GroupLock","./lib/_MetadataRequestor","./lib/_Requestor","./lib/_Parser","./ODataContextBinding","./ODataListBinding","./ODataMetaModel","./ODataPropertyBinding","./SubmitMode"],function(e,t,r,o,n,i,s,a,p,u,d,c,h,f,l,g,y){"use strict";var w="sap.ui.model.odata.v4.ODataModel",m=/^\w+$/,b=/^(\$auto|\$direct|\w+)$/,v={messageChange:true},M={annotationURI:true,autoExpandSelect:true,earlyRequests:true,groupId:true,groupProperties:true,odataVersion:true,operationMode:true,serviceUrl:true,supportReferences:true,synchronizationMode:true,updateGroupId:true},$=["$apply","$count","$expand","$filter","$orderby","$search","$select"],E=["$count","$expand","$filter","$levels","$orderby","$search","$select"];var G=i.extend("sap.ui.model.odata.v4.ODataModel",{constructor:function(t){var r,n,p={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()},c,h,f,g,w=this;i.apply(this);if(!t||t.synchronizationMode!=="None"){throw new Error("Synchronization mode must be 'None'")}c=t.odataVersion||"4.0";this.sODataVersion=c;if(c!=="4.0"&&c!=="2.0"){throw new Error("Unsupported value for parameter odataVersion: "+c)}for(h in t){if(!(h in M)){throw new Error("Unsupported parameter: "+h)}}f=t.serviceUrl;if(!f){throw new Error("Missing service root URL")}g=new a(f);if(g.path()[g.path().length-1]!=="/"){throw new Error("Service root URL must end with '/'")}if(t.operationMode&&t.operationMode!==s.Server){throw new Error("Unsupported operation mode: "+t.operationMode)}this.sOperationMode=t.operationMode;this.mUriParameters=this.buildQueryOptions(g.query(true),false,true);this.sServiceUrl=g.query("").toString();this.sGroupId=t.groupId;if(this.sGroupId===undefined){this.sGroupId="$auto"}if(this.sGroupId!=="$auto"&&this.sGroupId!=="$direct"){throw new Error("Group ID must be '$auto' or '$direct'")}this.checkGroupId(t.updateGroupId,false,"Invalid update group ID: ");this.sUpdateGroupId=t.updateGroupId||this.getGroupId();this.aLockedGroupLocks=[];this.mGroupProperties={};for(r in t.groupProperties){w.checkGroupId(r,true);n=t.groupProperties[r];if(typeof n!=="object"||Object.keys(n).length!==1||!(n.submit in y)){throw new Error("Group '"+r+"' has invalid properties: '"+n+"'")}}this.mGroupProperties=e.extend({$auto:{submit:y.Auto},$direct:{submit:y.Direct}},t.groupProperties);if(t.autoExpandSelect!==undefined&&typeof t.autoExpandSelect!=="boolean"){throw new Error("Value for autoExpandSelect must be true or false")}this.bAutoExpandSelect=t.autoExpandSelect===true;this.oMetaModel=new l(u.create(p,c,this.mUriParameters),this.sServiceUrl+"$metadata",t.annotationURI,this,t.supportReferences);this.oRequestor=d.create(this.sServiceUrl,{fnFetchEntityContainer:this.oMetaModel.fetchEntityContainer.bind(this.oMetaModel),fnFetchMetadata:this.oMetaModel.fetchObject.bind(this.oMetaModel),fnGetGroupProperty:this.getGroupProperty.bind(this),fnOnCreateGroup:function(e){if(w.isAutoGroup(e)){sap.ui.getCore().addPrerenderingTask(w._submitBatch.bind(w,e))}}},p,this.mUriParameters,c);if(t.earlyRequests){this.oMetaModel.fetchEntityContainer(true);this.initializeSecurityToken()}this.aAllBindings=[];this.sDefaultBindingMode=o.TwoWay;this.mSupportedBindingModes={OneTime:true,OneWay:true,TwoWay:true}}});G.prototype._submitBatch=function(r){var o,n,i=this;n=t.all(this.aLockedGroupLocks.map(function(e){return e.waitFor(r)}));o=n.isPending();if(o){e.sap.log.info("submitBatch('"+r+"') is waiting for locks",null,w)}return Promise.resolve(n.then(function(){if(o){e.sap.log.info("submitBatch('"+r+"') continues",null,w)}i.aLockedGroupLocks=i.aLockedGroupLocks.filter(function(e){return e.isLocked()});return i.oRequestor.submitBatch(r).catch(function(e){i.reportError("$batch failed",w,e.message);throw e})}))};G.prototype.attachEvent=function(e){if(!(e in v)){throw new Error("Unsupported event '"+e+"': v4.ODataModel#attachEvent")}return i.prototype.attachEvent.apply(this,arguments)};G.prototype.bindContext=function(e,t,r){return new h(this,e,t,r)};G.prototype.bindingCreated=function(e){this.aAllBindings.push(e)};G.prototype.bindingDestroyed=function(e){var t=this.aAllBindings.indexOf(e);if(t<0){throw new Error("Unknown "+e)}this.aAllBindings.splice(t,1)};G.prototype.bindList=function(e,t,r,o,n){return new f(this,e,t,r,o,n)};G.prototype.bindProperty=function(e,t,r){return new g(this,e,t,r)};G.prototype.bindTree=function(){throw new Error("Unsupported operation: v4.ODataModel#bindTree")};G.prototype.buildBindingParameters=function(e,t){var r={},o=this;if(e){Object.keys(e).forEach(function(n){var i=e[n];if(n.indexOf("$$")!==0){return}if(!t||t.indexOf(n)<0){throw new Error("Unsupported binding parameter: "+n)}switch(n){case"$$aggregation":break;case"$$groupId":case"$$updateGroupId":o.checkGroupId(i,false,"Unsupported value for binding parameter '"+n+"': ");break;case"$$inheritExpandSelect":if(i!==true&&i!==false){throw new Error("Unsupported value for binding parameter "+"'$$inheritExpandSelect': "+i)}break;case"$$operationMode":if(i!==s.Server){throw new Error("Unsupported operation mode: "+i)}break;case"$$ownRequest":if(i!==true){throw new Error("Unsupported value for binding parameter "+"'$$ownRequest': "+i)}break;default:throw new Error("Unknown binding-specific parameter: "+n)}r[n]=i})}return r};G.prototype.buildQueryOptions=function(t,r,o){var n,i=e.extend(true,{},t);function s(e,t,o){var n,i,a,p=e[t];if(!r||o.indexOf(t)<0){throw new Error("System query option "+t+" is not supported")}if((t==="$expand"||t==="$select")&&typeof p==="string"){p=c.parseSystemQueryOption(t+"="+p)[t];e[t]=p}if(t==="$expand"){for(a in p){i=p[a];if(i===null||typeof i!=="object"){i=p[a]={}}for(n in i){s(i,n,E)}}}else if(t==="$count"){if(typeof p==="boolean"){if(!p){delete e.$count}}else{switch(typeof p==="string"&&p.toLowerCase()){case"false":delete e.$count;break;case"true":e.$count=true;break;default:throw new Error("Invalid value for $count: "+p)}}}}if(t){for(n in t){if(n.indexOf("$$")===0){delete i[n]}else if(n[0]==="@"){throw new Error("Parameter "+n+" is not supported")}else if(n[0]==="$"){s(i,n,$)}else if(!o&&n.indexOf("sap-")===0){throw new Error("Custom query option "+n+" is not supported")}}}return i};G.prototype.checkDeferredGroupId=function(e){this.checkGroupId(e,true,"Invalid deferred group ID: ");if(this.isAutoGroup(e)||this.isDirectGroup(e)){throw new Error("Group ID is not deferred: "+e)}};G.prototype.checkGroupId=function(e,t,r){if(!t&&e===undefined||typeof e==="string"&&(t?m:b).test(e)){return}throw new Error((r||"Invalid group ID: ")+e)};G.prototype.createBindingContext=function(e,t){var r,o,i,s,a;function p(e){var t=e.indexOf("."),r=e.indexOf("/");return t>0&&(r<0||t<r)}if(arguments.length>2){throw new Error("Only the parameters sPath and oContext are supported")}if(t&&t.getBinding){throw new Error("Unsupported type: oContext must be of type sap.ui.model.Context, "+"but was sap.ui.model.odata.v4.Context")}s=this.resolve(e,t);if(s===undefined){throw new Error("Cannot create binding context from relative path '"+e+"' without context")}a=s.indexOf("#");if(a>=0){r=s.slice(0,a);i=s.slice(a+1);if(i[0]==="#"){i=i.slice(1)}else if(r.length>1&&i[0]!=="@"&&p(i)){return new n(this,s)}if(i[0]==="/"){i="."+i}o=this.oMetaModel.getMetaContext(r);return this.oMetaModel.createBindingContext(i,o)}return new n(this,s)};G.prototype.destroy=function(){this.oMetaModel.destroy();return i.prototype.destroy.apply(this,arguments)};G.prototype.destroyBindingContext=function(){throw new Error("Unsupported operation: v4.ODataModel#destroyBindingContext")};G.prototype.getContext=function(){throw new Error("Unsupported operation: v4.ODataModel#getContext")};G.prototype.getDependentBindings=function(e){return this.aAllBindings.filter(function(t){var r=t.getContext();return t.isRelative()&&(r===e||r&&r.getBinding&&r.getBinding()===e)})};G.prototype.getGroupId=function(){return this.sGroupId};G.prototype.getGroupProperty=function(e,t){switch(t){case"submit":return this.mGroupProperties[e]?this.mGroupProperties[e].submit:y.API;default:throw new Error("Unsupported group property: '"+t+"'")}};G.prototype.getMetaModel=function(){return this.oMetaModel};G.prototype.getObject=function(){throw new Error("Unsupported operation: v4.ODataModel#getObject")};G.prototype.getODataVersion=function(){return this.sODataVersion};G.prototype.getOriginalProperty=function(){throw new Error("Unsupported operation: v4.ODataModel#getOriginalProperty")};G.prototype.getProperty=function(){throw new Error("Unsupported operation: v4.ODataModel#getProperty")};G.prototype.getUpdateGroupId=function(){return this.sUpdateGroupId};G.prototype.hasPendingChanges=function(){return this.oRequestor.hasPendingChanges()};G.prototype.initializeSecurityToken=function(){this.oRequestor.refreshSecurityToken()};G.prototype.isList=function(){throw new Error("Unsupported operation: v4.ODataModel#isList")};G.prototype.isAutoGroup=function(e){return this.mGroupProperties[e]&&this.mGroupProperties[e].submit===y.Auto};G.prototype.isDirectGroup=function(e){return this.mGroupProperties[e]&&this.mGroupProperties[e].submit===y.Direct};G.prototype.lockGroup=function(e,t){var r;if(t instanceof p){t.setGroupId(e);return t}r=new p(e,t);if(r.isLocked()){this.aLockedGroupLocks.push(r)}return r};G.prototype.refresh=function(e){this.checkGroupId(e);this.aBindings.slice().forEach(function(t){if(t.isRefreshable()){t.refresh(e)}})};G.prototype.reportError=function(t,o,n){var i;if(n.canceled==="noDebugLog"){return}i=n.stack||n.message;if(i.indexOf(n.message)<0){i=n.message+"\n"+n.stack}if(n.canceled){e.sap.log.debug(t,i,o);return}e.sap.log.error(t,i,o);if(n.$reported){return}n.$reported=true;sap.ui.getCore().getMessageManager().addMessages(new r({message:n.message,processor:this,technical:true,type:"Error"}))};G.prototype.requestCanonicalPath=function(t){e.sap.assert(t.getModel()===this,"oEntityContext must belong to this model");return t.requestCanonicalPath()};G.prototype.resetChanges=function(e){e=e||this.sUpdateGroupId;this.checkDeferredGroupId(e);this.oRequestor.cancelChanges(e);this.aAllBindings.forEach(function(t){if(e===t.getUpdateGroupId()){t.resetInvalidDataState()}})};G.prototype.resolve=function(e,t){var r;if(e&&e[0]==="/"){r=e}else if(t){if(e){if(t.getPath().slice(-1)==="/"){r=t.getPath()+e}else{r=t.getPath()+"/"+e}}else{r=t.getPath()}}if(r&&r!=="/"&&r[r.length-1]==="/"&&r.indexOf("#")<0){r=r.slice(0,r.length-1)}return r};G.prototype.setLegacySyntax=function(){throw new Error("Unsupported operation: v4.ODataModel#setLegacySyntax")};G.prototype.submitBatch=function(e){var t=this;this.checkDeferredGroupId(e);return new Promise(function(r){sap.ui.getCore().addPrerenderingTask(function(){r(t._submitBatch(e))})})};G.prototype.toString=function(){return w+": "+this.sServiceUrl};return G});