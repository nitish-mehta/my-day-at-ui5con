/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/SyncPromise","sap/ui/model/ChangeReason","./ODataBinding","./lib/_Helper"],function(e,t,n,r,i){"use strict";function o(){}r(o.prototype);var a="sap.ui.model.odata.v4.ODataParentBinding";o.prototype.addToSelect=function(e,t){e.$select=e.$select||[];t.forEach(function(t){if(e.$select.indexOf(t)<0){e.$select.push(t)}})};o.prototype.changeParameters=function(t){var r=e.extend(true,{},this.mParameters),i,o,a=this;function s(e){if(a.oModel.bAutoExpandSelect&&e in t){throw new Error("Cannot change $expand or $select parameter in "+"auto-$expand/$select mode: "+e+"="+JSON.stringify(t[e]))}}function u(e){if(e==="$filter"||e==="$search"){i=n.Filter}else if(e==="$orderby"&&i!==n.Filter){i=n.Sort}else if(!i){i=n.Change}}this.checkSuspended();if(!t){throw new Error("Missing map of binding parameters")}s("$expand");s("$select");if(this.hasPendingChanges()){throw new Error("Cannot change parameters due to pending changes")}for(o in t){if(o.indexOf("$$")===0){throw new Error("Unsupported parameter: "+o)}if(t[o]===undefined&&r[o]!==undefined){u(o);delete r[o]}else if(r[o]!==t[o]){u(o);if(typeof t[o]==="object"){r[o]=e.extend(true,{},t[o])}else{r[o]=t[o]}}}if(i){this.applyParameters(r,i)}};o.prototype.checkUpdate=function(){var e=this;function t(){e.oModel.getDependentBindings(e).forEach(function(e){e.checkUpdate()})}if(arguments.length>0){throw new Error("Unsupported operation: "+a+"#checkUpdate must not be"+" called with parameters")}this.oCachePromise.then(function(n){if(n&&e.bRelative&&e.oContext.fetchCanonicalPath){e.oContext.fetchCanonicalPath().then(function(r){if(n.$canonicalPath!==r){e.refreshInternal()}else{t()}})["catch"](function(t){e.oModel.reportError("Failed to update "+e,a,t)})}else{t()}})};o.prototype.createInCache=function(e,t,n,r,o){var a=this;return this.oCachePromise.then(function(s){if(s){return s.create(e,t,n,r,o,function(e){a.oModel.reportError("POST on '"+t+"' failed; will be repeated automatically","sap.ui.model.odata.v4.ODataParentBinding",e)}).then(function(e){if(s.$canonicalPath){delete a.mCacheByContext[s.$canonicalPath]}return e})}return a.oContext.getBinding().createInCache(e,t,i.buildPath(a.oContext.iIndex,a.sPath,n),r,o)})};o.prototype.createRefreshGroupLock=function(e,t){var n=this;if(!this.oRefreshGroupLock){this.oRefreshGroupLock=this.oModel.lockGroup(e,t);if(t){sap.ui.getCore().addPrerenderingTask(function(){if(n.oRefreshGroupLock){n.oRefreshGroupLock.unlock(true);n.oRefreshGroupLock=undefined}})}}};o.prototype.wrapChildQueryOptions=function(t,n,r){var o="",a,s=n.split("/"),u,d=t,h={},p=h;if(n===""){return r}for(a=0;a<s.length;a+=1){d=i.buildPath(d,s[a]);o=i.buildPath(o,s[a]);u=this.oModel.getMetaModel().getObject(d);if(u.$kind==="NavigationProperty"){p.$expand={};p=p.$expand[o]=a===s.length-1?r:{};this.selectKeyProperties(p,d);o=""}else if(u.$kind!=="Property"){return undefined}}if(u.$kind==="Property"){if(Object.keys(r).length>0){e.sap.log.error("Failed to enhance query options for "+"auto-$expand/$select as the child binding has query options, "+"but its path '"+n+"' points to a structural "+"property",JSON.stringify(r),"sap.ui.model.odata.v4.ODataParentBinding");return undefined}this.addToSelect(p,[o])}if("$apply"in r){e.sap.log.debug("Cannot wrap $apply into $expand: "+n,JSON.stringify(r),"sap.ui.model.odata.v4.ODataParentBinding");return undefined}return h};o.prototype.deleteFromCache=function(e,t,n,r){var o=this.oCachePromise.getResult(),a;if(!this.oCachePromise.isFulfilled()){throw new Error("DELETE request not allowed")}if(o){e.setGroupId(this.getUpdateGroupId());a=e.getGroupId();if(!this.oModel.isAutoGroup(a)&&!this.oModel.isDirectGroup(a)){throw new Error("Illegal update group ID: "+a)}return o._delete(e,t,n,r)}return this.oContext.getBinding().deleteFromCache(e,t,i.buildPath(this.oContext.iIndex,this.sPath,n),r)};o.prototype.fetchIfChildCanUseCache=function(n,r,o){var s,u,d,h,p,c,f=this.oModel.getMetaModel(),l,g=this;function y(){if(c){return f.fetchObject(p.slice(0,p.lastIndexOf("/")+1))}return f.fetchObject(p).then(function(e){if(e&&e.$kind==="NavigationProperty"){return f.fetchObject(p+"/").then(function(){return e})}return e})}if(this.oOperation||r==="$count"||r.slice(-7)==="/$count"||r[0]==="@"||this.getRootBinding().isSuspended()){return t.resolve(true)}u=this.oCachePromise.isRejected()||this.oCachePromise.isFulfilled()&&!this.oCachePromise.getResult()||this.oCachePromise.isFulfilled()&&this.oCachePromise.getResult().bSentReadRequest;s=f.getMetaPath(n.getPath());h=f.getMetaPath("/"+r).slice(1);c=h[0]==="#";p=i.buildPath(s,h);l=[this.doFetchQueryOptions(this.oContext),y(),o];d=t.all(l).then(function(t){var n=t[2],r,i=t[0],o=t[1];if(g.bAggregatedQueryOptionsInitial){g.selectKeyProperties(i,s);g.mAggregatedQueryOptions=e.extend(true,{},i);g.bAggregatedQueryOptionsInitial=false}if(c){r={$select:[h.slice(1)]};return g.aggregateQueryOptions(r,u)}if(h===""||o&&(o.$kind==="Property"||o.$kind==="NavigationProperty")){r=g.wrapChildQueryOptions(s,h,n);if(r){return g.aggregateQueryOptions(r,u)}return false}if(h==="value"){return g.aggregateQueryOptions(n,u)}e.sap.log.error("Failed to enhance query options for "+"auto-$expand/$select as the path '"+p+"' does not point to a property",JSON.stringify(o),"sap.ui.model.odata.v4.ODataParentBinding");return false});this.aChildCanUseCachePromises.push(d);this.oCachePromise=t.all([this.oCachePromise,d]).then(function(t){var n=t[0];if(n&&!n.bSentReadRequest){n.setQueryOptions(e.extend(true,{},g.oModel.mUriParameters,g.mAggregatedQueryOptions))}return n})["catch"](function(e){g.oModel.reportError("Failed to update cache for binding "+g,a,e)});return d};o.prototype.getQueryOptionsForPath=function(t,n){var r;if(Object.keys(this.mParameters).length){r=this.mQueryOptions;this.oModel.getMetaModel().getMetaPath("/"+t).slice(1).split("/").some(function(e){r=r.$expand&&r.$expand[e];if(!r||r===true){r={};return true}});return e.extend(true,{},r)}n=n||this.oContext;if(!this.bRelative||!n.getQueryOptionsForPath){return{}}return n.getQueryOptionsForPath(i.buildPath(this.sPath,t))};o.prototype.initialize=function(){if((!this.bRelative||this.oContext)&&!this.getRootBinding().isSuspended()){this._fireChange({reason:n.Change})}};o.prototype.aggregateQueryOptions=function(t,n){var r=e.extend(true,{},this.mAggregatedQueryOptions);function i(e,t,r){var o,a;function s(r){if(e.$expand[r]){return i(e.$expand[r],t.$expand[r],true)}if(n){return false}e.$expand[r]=o[r];return true}function u(t){if(e.$select.indexOf(t)<0){if(n){return false}e.$select.push(t)}return true}o=t.$expand;if(o){e.$expand=e.$expand||{};if(!Object.keys(o).every(s)){return false}}a=t.$select;if(a){e.$select=e.$select||[];if(!a.every(u)){return false}}if(t.$count){e.$count=true}return Object.keys(t).concat(Object.keys(e)).every(function(n){if(n==="$count"||n==="$expand"||n==="$select"||!r&&!(n in t)){return true}return t[n]===e[n]})}if(i(r,t)){this.mAggregatedQueryOptions=r;return true}return false};o.prototype.resume=function(){var e=this;if(this.oOperation){throw new Error("Cannot resume an operation binding: "+this)}if(this.bRelative&&(!this.oContext||this.oContext.fetchValue)){throw new Error("Cannot resume a relative binding: "+this)}if(!this.bSuspended){throw new Error("Cannot resume a not suspended binding: "+this)}this.bSuspended=false;sap.ui.getCore().addPrerenderingTask(function(){e.resumeInternal(true)})};o.prototype.selectKeyProperties=function(e,t){var n=this.oModel.getMetaModel().getObject(t+"/");if(n&&n.$Key){this.addToSelect(e,n.$Key.map(function(e){if(typeof e==="object"){return e[Object.keys(e)[0]]}return e}))}};o.prototype.suspend=function(){if(this.oOperation){throw new Error("Cannot suspend an operation binding: "+this)}if(this.bRelative&&(!this.oContext||this.oContext.fetchValue)){throw new Error("Cannot suspend a relative binding: "+this)}if(this.bSuspended){throw new Error("Cannot suspend a suspended binding: "+this)}if(this.hasPendingChanges()){throw new Error("Cannot suspend a binding with pending changes: "+this)}this.bSuspended=true};o.prototype.updateAggregatedQueryOptions=function(e){var t=Object.keys(e).concat(Object.keys(this.mAggregatedQueryOptions)),n=this;t.forEach(function(t){if(t==="$select"||t==="$expand"){return}if(e[t]===undefined){delete n.mAggregatedQueryOptions[t]}else{n.mAggregatedQueryOptions[t]=e[t]}})};return function(t){e.extend(t,o.prototype)}},false);