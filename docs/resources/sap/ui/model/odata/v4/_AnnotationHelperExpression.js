/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","../_AnnotationHelperBasics","sap/ui/base/BindingParser","sap/ui/base/ManagedObject"],function(e,t,r,a){"use strict";var n="sap.ui.model.odata.v4.AnnotationHelper",s=[n],i=n+"/getExpression",o,u=/^\{@i18n>[^\\\{\}:]+\}$/,l={And:"&&",Eq:"===",Ge:">=",Gt:">",Le:"<=",Lt:"<",Ne:"!==",Not:"!",Or:"||"},p=false,c={"Edm.Boolean":"boolean","Edm.Byte":"number","Edm.Date":"Date","Edm.DateTimeOffset":"DateTimeOffset","Edm.Decimal":"Decimal","Edm.Double":"number","Edm.Guid":"string","Edm.Int16":"number","Edm.Int32":"number","Edm.Int64":"Decimal","Edm.SByte":"number","Edm.Single":"number","Edm.String":"string","Edm.TimeOfDay":"TimeOfDay"},d={Bool:"Edm.Boolean",Float:"Edm.Double",Date:"Edm.Date",DateTimeOffset:"Edm.DateTimeOffset",Decimal:"Edm.Decimal",Guid:"Edm.Guid",Int:"Edm.Int64",Int32:"Edm.Int32",String:"Edm.String",TimeOfDay:"Edm.TimeOfDay"},m={boolean:false,Date:false,DateTimeOffset:true,Decimal:true,number:false,string:false,TimeOfDay:false};function f(e,r){t.error(e,r,n)}o={adjustOperands:function(e,t){if(e.result!=="constant"&&e.category==="number"&&t.result==="constant"&&t.type==="Edm.Int64"){t.category="number"}if(e.result!=="constant"&&e.category==="Decimal"&&t.result==="constant"&&t.type==="Edm.Int32"){t.category="Decimal";t.type=e.type}},apply:function(e,r){var a=t.descend(e,"$Function","string");switch(a.value){case"odata.concat":return o.concat(r);case"odata.fillUriTemplate":return o.fillUriTemplate(r);case"odata.uriEncode":return o.uriEncode(r);default:f(a,"unknown function: "+a.value)}},concat:function(e){var r=e.asExpression,a=[],n,s=[];t.expectType(e,"array");e.value.forEach(function(t,a){n=o.parameter(e,a);r=r||n.result==="expression";s.push(n)});s.forEach(function(e){if(r){o.wrapExpression(e)}if(e.type!=="edm:Null"){a.push(t.resultToString(e,r))}});n=r?{result:"expression",value:a.join("+")}:{result:"composite",value:a.join("")};n.type="Edm.String";return n},conditional:function(e){var r=o.parameter(e,0,"Edm.Boolean"),a=o.parameter(e,1),n=o.parameter(e,2),s=a.type;if(a.type==="edm:Null"){s=n.type}else if(n.type!=="edm:Null"&&a.type!==n.type){f(e,"Expected same type for second and third parameter, types are '"+a.type+"' and '"+n.type+"'")}return{result:"expression",type:s,value:t.resultToString(o.wrapExpression(r),true)+"?"+t.resultToString(o.wrapExpression(a),true)+":"+t.resultToString(o.wrapExpression(n),true)}},constant:function(e,t){var r=e.value;if(t==="String"){if(u.test(r)){return{ignoreTypeInPath:true,result:"binding",type:"Edm.String",value:r.slice(1,-1)}}}return{result:"constant",type:d[t],value:r}},expression:function(e){var r=e.value,a=e,n;if(r===null){n="Null"}else if(typeof r==="boolean"){n="Bool"}else if(typeof r==="number"){n=isFinite(r)&&Math.floor(r)===r?"Int32":"Float"}else if(typeof r==="string"){n="String"}else{t.expectType(e,"object");["$And","$Apply","$Date","$DateTimeOffset","$Decimal","$Float","$Eq","$Ge","$Gt","$Guid","$If","$Int","$Le","$Lt","$Ne","$Not","$Null","$Or","$Path","$PropertyPath","$TimeOfDay"].forEach(function(s){if(r.hasOwnProperty(s)){n=s.slice(1);a=t.descend(e,s)}})}switch(n){case"Apply":return o.apply(e,a);case"If":return o.conditional(a);case"Path":case"PropertyPath":return o.path(a);case"Date":case"DateTimeOffset":case"Decimal":case"Guid":case"Int":case"String":case"TimeOfDay":t.expectType(a,"string");case"Bool":case"Float":case"Int32":return o.constant(a,n);case"And":case"Eq":case"Ge":case"Gt":case"Le":case"Lt":case"Ne":case"Or":return o.operator(a,n);case"Not":return o.not(a);case"Null":return{result:"constant",type:"edm:Null",value:null};default:f(e,"Unsupported OData expression")}},formatOperand:function(e,r,a,n){if(a.result==="constant"){switch(a.category){case"boolean":case"number":return String(a.value)}}if(n){o.wrapExpression(a)}return t.resultToString(a,true)},getExpression:function(u){var l;if(u.value===undefined){return undefined}e.sap.measure.average(i,"",s);if(!p&&a.bindingParser===r.simpleParser){e.sap.log.warning("Complex binding syntax not active",null,n);p=true}try{l=o.expression(u);e.sap.measure.end(i);return t.resultToString(l,false)}catch(a){e.sap.measure.end(i);if(a instanceof SyntaxError){return"Unsupported: "+r.complexParser.escape(t.toErrorString(u.value))}throw a}},fillUriTemplate:function(e){var r,a,n=[],s="",i,u=e.value,l,p=o.parameter(e,0,"Edm.String");n.push("odata.fillUriTemplate(",t.resultToString(p,true),",{");for(r=1;r<u.length;r+=1){i=t.descend(e,r,"object");a=t.property(i,"$Name","string");l=o.expression(t.descend(i,"$LabeledElement",true));n.push(s,t.toJSON(a),":",t.resultToString(l,true));s=","}n.push("})");return{result:"expression",type:"Edm.String",value:n.join("")}},not:function(e){var r;e.asExpression=true;r=o.expression(e);return{result:"expression",type:"Edm.Boolean",value:"!"+t.resultToString(o.wrapExpression(r),true)}},operator:function(e,t){var r=t==="And"||t==="Or"?"Edm.Boolean":undefined,a,n=o.parameter(e,0,r),s=o.parameter(e,1,r),i="",u,p;if(n.type!=="edm:Null"&&s.type!=="edm:Null"){n.category=c[n.type];s.category=c[s.type];o.adjustOperands(n,s);o.adjustOperands(s,n);if(n.category!==s.category){f(e,"Expected two comparable parameters but instead saw "+n.type+" and "+s.type)}switch(n.category){case"Decimal":i=",'Decimal'";break;case"DateTimeOffset":i=",'DateTime'";break}a=m[n.category]}u=o.formatOperand(e,0,n,!a);p=o.formatOperand(e,1,s,!a);return{result:"expression",type:"Edm.Boolean",value:a?"odata.compare("+u+","+p+i+")"+l[t]+"0":u+l[t]+p}},parameter:function(e,r,a){var n=t.descend(e,r,true),s=o.expression(n);if(a&&a!==s.type){f(n,"Expected "+a+" but instead saw "+s.type)}return s},path:function(e){t.expectType(e,"string");return{result:"binding",type:e.model.getProperty(e.path+"/$Type"),value:e.value}},uriEncode:function(e){var r=o.parameter(e,0);return{result:"expression",type:"Edm.String",value:r.type==="Edm.String"?"odata.uriEncode("+t.resultToString(r,true)+","+t.toJSON(r.type)+")":"String("+t.resultToString(r,true)+")"}},wrapExpression:function(e){if(e.result==="expression"){e.value="("+e.value+")"}return e}};return o},false);