/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/SyncPromise","sap/ui/model/ChangeReason","sap/ui/model/PropertyBinding","./lib/_Cache","./ODataBinding"],function(e,t,o,r,i,n){"use strict";var a="sap.ui.model.odata.v4.ODataPropertyBinding",s=t.resolve({}),h={AggregatedDataStateChange:true,change:true,dataReceived:true,dataRequested:true,DataStateChange:true};var d=r.extend("sap.ui.model.odata.v4.ODataPropertyBinding",{constructor:function(e,o,i,n){var a;r.call(this,e,o);if(o.slice(-1)==="/"){throw new Error("Invalid path: "+o)}a=this.oModel.buildBindingParameters(n,["$$groupId"]);this.oCheckUpdateCallToken=undefined;this.sGroupId=a.$$groupId;this.mQueryOptions=this.oModel.buildQueryOptions(n,false);this.oCachePromise=t.resolve();this.fetchCache(i);this.oContext=i;this.bHasDeclaredType=undefined;this.bInitial=true;this.sPathWithFetchTypeError=undefined;this.vValue=undefined;e.bindingCreated(this)},metadata:{publicMethods:[]}});n(d.prototype);d.prototype.attachEvent=function(e){if(!(e in h)){throw new Error("Unsupported event '"+e+"': v4.ODataPropertyBinding#attachEvent")}return r.prototype.attachEvent.apply(this,arguments)};d.prototype.checkUpdate=function(r,i,n,s){var h=false,d=this.oModel.resolve(this.sPath,this.oContext),u={forceUpdate:d&&(r||this.oCheckUpdateCallToken&&this.oCheckUpdateCallToken.forceUpdate)},p={data:{}},l=this.oType,c=this;this.oCheckUpdateCallToken=u;if(this.bHasDeclaredType===undefined){this.bHasDeclaredType=!!l}if(arguments.length<4){s=Promise.resolve(this.oCachePromise.then(function(e){if(e){return e.fetchValue(c.oModel.lockGroup(n||c.getGroupId()),undefined,function(){h=true;c.fireDataRequested()},c)}if(!c.oContext){return undefined}if(c.oContext.getIndex()===-2){u.forceUpdate=false}return c.oContext.fetchValue(c.sPath,c)}).then(function(t){if(!t||typeof t!=="object"||c.sInternalType==="any"&&c.sPath[c.sPath.lastIndexOf("/")+1]==="#"){return t}e.sap.log.error("Accessed value is not primitive",d,a)},function(e){c.oModel.reportError("Failed to read path "+d,a,e);if(e.canceled){u.forceUpdate=false;return c.vValue}p={error:e}}));if(d&&!this.bHasDeclaredType&&this.sInternalType!=="any"){l=this.oModel.getMetaModel().fetchUI5Type(d)}}return t.all([s,l]).then(function(e){var t=e[1],r=e[0];if(u===c.oCheckUpdateCallToken){c.oCheckUpdateCallToken=undefined;c.setType(t,c.sInternalType);if(u.forceUpdate||c.vValue!==r){c.bInitial=false;c.vValue=r;c._fireChange({reason:i||o.Change})}}if(h){c.fireDataReceived(p)}})};d.prototype.deregisterChange=function(){var e=this;this.withCache(function(t,o){t.deregisterChange(o,e)}).catch(function(t){e.oModel.reportError("Error in deregisterChange",a,t)})};d.prototype.destroy=function(){this.deregisterChange();this.oModel.bindingDestroyed(this);this.oCachePromise=undefined;this.oContext=undefined;r.prototype.destroy.apply(this,arguments)};d.prototype.doCreateCache=function(e,t){return i.createProperty(this.oModel.oRequestor,e,t)};d.prototype.doFetchQueryOptions=function(){return s};d.prototype.getUnitOrCurrencyPath=function(){var e=this.oModel.getMetaModel(),t=this.oModel.resolve(this.sPath,this.oContext),o=e.getObject("@",e.getMetaContext(t)),r=o&&(o["@Org.OData.Measures.V1.Unit"]||o["@Org.OData.Measures.V1.ISOCurrency"]);return r&&r.$Path};d.prototype.getValue=function(){return this.vValue};d.prototype.getValueListType=function(){var e=this.getModel().resolve(this.sPath,this.oContext);if(!e){throw new Error(this+" is not resolved yet")}return this.getModel().getMetaModel().getValueListType(e)};d.prototype.onChange=function(e){this.checkUpdate(undefined,undefined,undefined,e)};d.prototype.refreshInternal=function(e,t){this.fetchCache(this.oContext);if(t){this.checkUpdate(true,o.Refresh,e)}};d.prototype.requestValueListInfo=function(){var e=this.getModel().resolve(this.sPath,this.oContext);if(!e){throw new Error(this+" is not resolved yet")}return this.getModel().getMetaModel().requestValueListInfo(e)};d.prototype.requestValueListType=function(){var e=this.getModel().resolve(this.sPath,this.oContext);if(!e){throw new Error(this+" is not resolved yet")}return this.getModel().getMetaModel().requestValueListType(e)};d.prototype.resetInvalidDataState=function(){if(this.getDataState().isControlDirty()){this._fireChange({reason:o.Change})}};d.prototype.resume=function(){throw new Error("Unsupported operation: resume")};d.prototype.resumeInternal=function(e){this.fetchCache(this.oContext);if(e){this.checkUpdate()}};d.prototype.setContext=function(e){if(this.oContext!==e){if(this.bRelative){this.deregisterChange()}this.oContext=e;if(this.bRelative){this.fetchCache(this.oContext);this.checkUpdate(false,o.Context)}}};d.prototype.setType=function(e){var t=this.oType;if(e&&e.getName()==="sap.ui.model.odata.type.DateTimeOffset"){e.setV4()}r.prototype.setType.apply(this,arguments);if(!this.bInitial&&t!==e){this._fireChange({reason:o.Change})}};d.prototype.setValue=function(e,t){var o,r=this;function i(e){r.oModel.reportError("Failed to update path "+r.oModel.resolve(r.sPath,r.oContext),a,e);return e}this.checkSuspended();this.oModel.checkGroupId(t);if(typeof e==="function"||e&&typeof e==="object"){throw i(new Error("Not a primitive value"))}if(this.vValue===undefined){throw i(new Error("Must not change a property before it has been read"))}if(this.vValue!==e){o=r.oModel.lockGroup(t,true);this.oCachePromise.then(function(t){if(t){i(new Error("Cannot set value on this binding"))}else{return r.oModel.getMetaModel().fetchUpdateData(r.sPath,r.oContext).then(function(t){return r.withCache(function(n,a,s){o.setGroupId(s.getUpdateGroupId());return n.update(o,t.propertyPath,e,i,t.editUrl,a,r.getUnitOrCurrencyPath())},t.entityPath)})}}).catch(function(e){o.unlock(true);i(e)})}};d.prototype.suspend=function(){throw new Error("Unsupported operation: suspend")};return d});