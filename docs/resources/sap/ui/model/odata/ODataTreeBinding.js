/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/TreeBinding","./CountMode"],function(e,t,o){"use strict";var s=t.extend("sap.ui.model.odata.ODataTreeBinding",{constructor:function(o,s,i,r,n){t.apply(this,arguments);this.bPendingRequest=false;this.oFinalLengths={};this.oLengths={};this.oKeys={};this.bNeedsUpdate=false;this.bHasTreeAnnotations=this._hasTreeAnnotations();this.oRootContext=null;this.iNumberOfExpandedLevels=n&&n.numberOfExpandedLevels;this.sCountMode=n&&n.countMode||this.oModel.sDefaultCountMode;if(!this.bHasTreeAnnotations){if(!n||!n.navigation){e.sap.log.error("A navigation paths parameter object has to be defined");this.oNavigationPaths={}}else{this.oNavigationPaths=n.navigation}}else{e.sap.log.warning("Tree hierarchy annotations are deprecated and may not work correctly with the sap.ui.model.odata.ODataModel."+" Please use the sap.ui.model.odata.v2.ODataModel (since version 1.28) instead which fully supports hierarchy annotations.")}}});s.prototype.getRootContexts=function(e,t,o){var s=null,i={numberOfExpandedLevels:this.iNumberOfExpandedLevels},r=[],n=true,a=this;if(this.bHasTreeAnnotations){i.level=0;if(!this.bDisplayRootNode){i.level=1}}else{s=this.oModel.resolve(this.getPath(),this.getContext());i.navPath=this._getNavPath(this.getPath());if(i.numberOfExpandedLevels>0){var h=s;for(var l=0;l<i.numberOfExpandedLevels;l++){var f=this._getNavPath(h);i.navPath+="/"+f;h+="/"+f}}var d=this.oModel.isList(this.sPath,this.getContext());if(d){this.bDisplayRootNode=true}else{n=false;this.oModel.createBindingContext(s,null,{expand:i.navPath},function(e){r=[e];if(a.oRootContext!==e){a.oRootContext=e;a._processODataObject(e.getObject(),s,i.navPath);a.bNeedsUpdate=true}},this.bRefresh);this.bRefresh=false}}if(n){if(!this.bDisplayRootNode){r=this._getContextsForNodeId(s,0,1,0,i)}else{r=this._getContextsForNodeId(s,e,t,o,i)}}if(!this.bDisplayRootNode&&r.length>0){this.oRootContext=r[0];r=this.getNodeContexts(r[0],e,t,o)}return r};s.prototype.getNodeContexts=function(e,t,o,s){var i,r={};if(this.bHasTreeAnnotations){var n=e.getProperty(this.oTreeProperties["hierarchy-drill-state-for"]);if(n=="leaf"){return[]}i=e.getProperty(this.oTreeProperties["hierarchy-node-for"]);r.level=parseInt(e.getProperty(this.oTreeProperties["hierarchy-level-for"]),10)+1}else{var a=this._getNavPath(e.getPath());if(!a){return[]}i=this.oModel.resolve(a,e);r.navPath=this.oNavigationPaths[a]}return this._getContextsForNodeId(i,t,o,s,r)};s.prototype.hasChildren=function(e){if(!e){return false}if(this.bHasTreeAnnotations){var t=e.getProperty(this.oTreeProperties["hierarchy-drill-state-for"]);return t==="expanded"||t==="collapsed"}else{var o=this._getNavPath(e.getPath());var s=e.getPath()+"/"+o;return o&&this.oLengths[s]>0}};s.prototype.getChildCount=function(e){if(this.bHasTreeAnnotations){var t;if(!e){if(this.oRootContext){t=this.oRootContext.getProperty(this.oTreeProperties["hierarchy-node-for"])}else{t="000000"}}else{t=e.getProperty(this.oTreeProperties["hierarchy-node-for"])}return this.oLengths[t]}else{if(!e){return this.oLengths[this.getPath()]}return this.oLengths[e.getPath()+"/"+this._getNavPath(e.getPath())]}};s.prototype._getContextsForNodeId=function(e,t,o,s,i){var r=[],n,a;if(!t){t=0}if(!o){o=this.oModel.iSizeLimit}if(!s){s=0}if(this.bHasTreeAnnotations){if(e==null){e="000000"}if(i.level==0){i.level++}}if(this.oFinalLengths[e]&&this.oLengths[e]<o){o=this.oLengths[e]}if(this.oKeys[e]){for(var h=t;h<t+o;h++){a=this.oKeys[e][h];if(!a){break}r.push(this.oModel.getContext("/"+a))}}n=r.length!=o&&!(this.oFinalLengths[e]&&r.length>=this.oLengths[e]);if(this.oModel.getServiceMetadata()){if(!this.bPendingRequest&&n){var l=[];if(this.bHasTreeAnnotations){if(i.numberOfExpandedLevels>0){var f=i.level+i.numberOfExpandedLevels;l.push("$filter="+this.oTreeProperties["hierarchy-level-for"]+" le '0"+f+"'")}else{l.push("$filter="+this.oTreeProperties["hierarchy-level-for"]+" eq '0"+i.level+"' and "+this.oTreeProperties["hierarchy-parent-node-for"]+" eq '"+e+"'")}}else{if(i.navPath){l.push("$expand="+i.navPath)}}this._loadSubNodes(e,t,o,s,l,i)}}return r};s.prototype._getCountForNodeId=function(t,o,s,i,r){var n=this;var a=[];function h(e){n.oFinalLengths[t]=true;n.oLengths[t]=parseInt(e,10)}function l(t){var o="Request for $count failed: "+t.message;if(t.response){o+=", "+t.response.statusCode+", "+t.response.statusText+", "+t.response.body}e.sap.log.warning(o)}var f;if(this.bHasTreeAnnotations){f=this.oModel.resolve(this.getPath(),this.getContext());a.push("$filter="+this.oTreeProperties["hierarchy-parent-node-for"]+" eq '"+t+"'")}else{f=t}if(f){var d=this.oModel._createRequestUrl(f+"/$count",null,a);var u=this.oModel._createRequest(d,"GET",false);u.headers["Accept"]="text/plain, */*;q=0.5";this.oModel._request(u,h,l,undefined,undefined,this.oModel.getServiceMetadata())}};s.prototype._loadSubNodes=function(e,t,s,i,r,n){var a=this,h=false;if(t||s){r.push("$skip="+t+"&$top="+s)}if(!a.bHasTreeAnnotations&&!this.oFinalLengths[e]&&(this.sCountMode==o.Inline||this.sCountMode==o.Both)){r.push("$inlinecount=allpages");h=true}function l(o){if(o.results){if(!a.bHasTreeAnnotations){if(h&&o.__count){a.oLengths[e]=parseInt(o.__count,10);a.oFinalLengths[e]=true}else{if(a.oModel.isCountSupported()){a._getCountForNodeId(e)}}a.oKeys[e]=[];for(var s=0;s<o.results.length;s++){var i=o.results[s];var r=a.oModel._getKey(i);a._processODataObject(i,"/"+r,n.navPath);a.oKeys[e][s+t]=r}}else{var l={};for(var s=0;s<o.results.length;s++){var i=o.results[s];e=i[a.oTreeProperties["hierarchy-parent-node-for"]];if(s==0){l[e]=t}else if(l[e]==undefined){l[e]=0}if(!(e in a.oKeys)){a.oKeys[e]=[];a._getCountForNodeId(e)}a.oKeys[e][l[e]]=a.oModel._getKey(i);l[e]++}}}else{a.oKeys[null]=a.oModel._getKey(o);if(!a.bHasTreeAnnotations){a._processODataObject(o,e,n.navPath)}}a.oRequestHandle=null;a.bPendingRequest=false;a.bNeedsUpdate=true}function f(){a.fireDataReceived()}function d(e){a.oRequestHandle=null;a.bPendingRequest=false;a.fireDataReceived()}function u(e){a.oRequestHandle=e}if(e){if(!this.oFinalLengths[e]){this.bPendingRequest=true;this.fireDataRequested();var p;if(this.bHasTreeAnnotations){p=this.oModel.resolve(this.getPath(),this.getContext())}else{p=e}this.oModel._loadData(p,r,l,d,false,u,f)}}};s.prototype.resetData=function(e){if(e){var t=e.getPath();delete this.oKeys[t];delete this.oLengths[t];delete this.oFinalLengths[t]}else{this.oKeys={};this.oLengths={};this.oFinalLengths={};this.oRootContext=null}};s.prototype.refresh=function(t,o,s){var i=false;if(!t){if(s){var r=this.oModel.resolve(this.sPath,this.oContext);var n=this.oModel.oMetadata._getEntityTypeByPath(r);if(n&&n.entityType in s){i=true}}if(o&&!i){e.each(this.oKeys,function(t,s){e.each(s,function(e,t){if(t in o){i=true;return false}});if(i){return false}})}if(!o&&!s){i=true}}if(t||i){this.resetData();this.bNeedsUpdate=false;this.bRefresh=true;this._fireChange()}};s.prototype.filter=function(t){e.sap.log.warning("Filtering is currently not possible in the ODataTreeBinding");return this};s.prototype.checkUpdate=function(t,o){var s=false;if(!t){if(this.bNeedsUpdate||!o){s=true}else{e.each(this.oKeys,function(t,i){e.each(i,function(e,t){if(t in o){s=true;return false}});if(s){return false}})}}if(t||s){this.bNeedsUpdate=false;this._fireChange()}};s.prototype._getNavPath=function(e){var t=this.oModel.resolve(e,this.getContext());if(!t){return}var o=t.split("/"),s=o[o.length-1],i;var r=s.split("(")[0];if(r&&this.oNavigationPaths[r]){i=this.oNavigationPaths[r]}return i};s.prototype._processODataObject=function(e,t,o){var s=[],i=this;if(o&&o.indexOf("/")>-1){s=o.split("/");o=s[0];s.splice(0,1)}var r=this.oModel._getObject(t);if(Array.isArray(r)){this.oKeys[t]=r;this.oLengths[t]=r.length;this.oFinalLengths[t]=true}if(o&&e[o]){if(Array.isArray(r)){r.forEach(function(e){var t=i.getModel().getData("/"+e);i._processODataObject(t,"/"+e+"/"+o,s.join("/"))})}else if(typeof r==="object"){i._processODataObject(e,t+"/"+o,s.join("/"))}}};s.prototype._hasTreeAnnotations=function(){var t=this.oModel,o=t.oMetadata,s=t.resolve(this.getPath(),this.getContext()),i=o._getEntityTypeByPath(s),r=o.mNamespaces["sap"],n=this;this.oTreeProperties={"hierarchy-level-for":false,"hierarchy-parent-node-for":false,"hierarchy-node-for":false,"hierarchy-drill-state-for":false};if(!i){e.sap.log.fatal("EntityType for path "+s+" could not be found.");return false}e.each(i.property,function(t,o){if(!o.extensions){return true}e.each(o.extensions,function(e,t){var s=t.name;if(t.namespace===r&&s in n.oTreeProperties&&!n.oTreeProperties[s]){n.oTreeProperties[s]=o.name}})});var a=false;e.each(this.oTreeProperties,function(e,t){if(!t){a=true;return false}});return!a};return s});