/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/Filter","sap/ui/model/TreeBinding","sap/ui/model/odata/v2/ODataTreeBinding","sap/ui/model/ChangeReason","sap/ui/model/TreeBindingUtils"],function(e,t,i,n,r,o){"use strict";var a=function(){if(!(this instanceof i)||this._bIsAdapted){return}for(var e in a.prototype){if(a.prototype.hasOwnProperty(e)){this[e]=a.prototype[e]}}this.mParameters=this.mParameters||{};this._iPageSize=0;this._aNodes=this._aNodes||[];this._aNodeCache=[];this._aCollapsed=this._aCollapsed||[];this._aExpanded=this._aExpanded||[];this._aRemoved=[];this._aAdded=[];this._aNodeChanges=[];this._aAllChangedNodes=[];this._mSubtreeHandles={};this._iLowestServerLevel=null;this._aExpandedAfterSelectAll=this._aExpandedAfterSelectAll||[];this._mSelected=this._mSelected||{};this._mDeselected=this._mDeselected||{};this._bSelectAll=false;this._iLengthDelta=0;if(this.mParameters.collapseRecursive===undefined){this.bCollapseRecursive=true}else{this.bCollapseRecursive=!!this.mParameters.collapseRecursive}this._bIsAdapted=true;this._bReadOnly=true;this._aPendingRequests=[];this._aPendingChildrenRequests=[]};a.prototype.setNumberOfExpandedLevels=function(e){this.resetData();n.prototype.setNumberOfExpandedLevels.apply(this,arguments)};a.prototype.getContexts=function(e,t,i,n){if(this.isInitial()){return[]}e=e||0;t=t||this.oModel.iSizeLimit;i=i||0;this._iPageSize=t;this._iThreshold=i;if(this._aNodes.length==0&&!this.isLengthFinal()){this._loadData(e,t,i)}var r=[];var o=this._retrieveNodeSection(e,t);this._aNodeCache=[];var a;var s=0;var d=0;var l={};for(var h=0;h<o.length;h++){var p=o[h];this._aNodeCache[e+h]=p&&p.context?p:undefined;r.push(p.context);if(!p.context){if(p.serverIndex!=undefined){if(a==undefined){a=p.serverIndex}d=p.serverIndex}else if(p.positionInParent!=undefined){var f=p.parent;l[f.key]=l[f.key]||[];l[f.key].push(p)}}}s=1+Math.max(d-(a||0),0);if(a!=undefined&&s){this._loadData(a,s,i)}for(var u in l){var c=this._calculateRequestParameters(l[u]);this._loadChildren(l[u][0].parent,c.skip,c.top)}if(n){return o}else{return r}};a.prototype._calculateRequestParameters=function(e){var t=e[0].parent;var i=e[0].positionInParent;var n=Math.min(i+Math.max(this._iThreshold,e.length),t.children.length);for(var r=i;r<n;r++){var o=t.children[r];if(o){break}}return{skip:i,top:r-i}};a.prototype._retrieveNodeSection=function(e,t){return this._bReadOnly?this._indexRetrieveNodeSection(e,t):this._mapRetrieveNodeSection(e,t)};a.prototype._mapRetrieveNodeSection=function(e,t){var i=-1;var n=[];this._map(function(r,o,a,s,d){i++;if(i>=e){if(!r){if(a=="serverIndex"){r={serverIndex:s}}else if(a=="positionInParent"){r={positionInParent:s,parent:d}}}n.push(r)}if(n.length>=t){o.broken=true}});return n};a.prototype._indexRetrieveNodeSection=function(e,t){var i,n=[],r,o;for(i=e;i<e+t;i++){r=this.getNodeInfoByRowIndex(i);if(r.index!==undefined&&r.index<this._aNodes.length){o=this._aNodes[r.index];if(!o){o={serverIndex:r.index}}}else if(r.parent){o=r.parent.children[r.childIndex];if(!o){o={parent:r.parent,positionInParent:r.childIndex}}}if(o){n.push(o);o=null}}return n};a.prototype.getNodes=function(e,t,i){var n=this.getContexts(e,t,i,true);return n};a.prototype._map=function(e){var t={broken:false};var i=function(e){if(e.addedSubtrees.length>0&&!e.nodeState.collapsed){for(var i=0;i<e.addedSubtrees.length;i++){var r=e.addedSubtrees[i];n(e,r);if(t.broken){return}}}};var n=function(e,t){var i=t._getSubtree();if(t){if(Array.isArray(i)){if(t._oSubtreeRoot){o(i,t._oSubtreeRoot.serverIndex,t._oSubtreeRoot,t._oSubtreeRoot.originalLevel||0,e.level+1)}else{o(i,null,null,0,e.level+1)}}else{t._oSubtreeRoot.level=e.level+1;r(t._oSubtreeRoot,false,t._oNewParentNode,-1,t._oSubtreeRoot)}}};var r=function(n,o,a,s,d){if(!o){if(!n.nodeState.removed||d==n){e(n,t,"positionInParent",s,a);if(t.broken){return}}}i(n);if(t.broken){return}if(n&&n.children&&n.nodeState.expanded){for(var l=0;l<n.children.length;l++){var h=n.children[l];if(h&&!h.nodeState.removed&&!h.nodeState.reinserted){h.level=n.level+1}if(h&&!h.nodeState.removed){r(h,false,n,l,d)}else if(!h){e(h,t,"positionInParent",l,n)}if(t.broken){return}}}};var o=function(n,o,a,s,d){for(var l=0;l<n.length;l++){var h=n[l];if(h&&h.nodeState&&h.nodeState.removed&&h!=a){if(!h.initiallyCollapsed){l+=h.magnitude}continue}if(h&&s>=0&&d>=0){h.level=h.originalLevel||0;var p=h.level-s||0;h.level=d+p||0}if(o===null){e(h,t,"newNode")}else{e(h,t,"serverIndex",o+l)}if(t.broken){return}if(h&&h.nodeState){if(!h.initiallyCollapsed&&h.nodeState.collapsed){l+=h.magnitude}else{if(h.initiallyCollapsed&&h.nodeState.expanded){r(h,true);if(t.broken){return}}else if(!h.initiallyCollapsed&&h.nodeState.expanded){i(h)}}}if(t.broken){return}}};o(this._aNodes,0,null)};a.prototype._loadData=function(e,t,i){var n=this;this.fireDataRequested();this._requestServerIndexNodes(e,t,i).then(function(e){n._addServerIndexNodes(e.oData,e.iSkip);n._fireChange({reason:r.Change});n.fireDataReceived({data:e.oData})},function(e){var t=e.statusCode===0;if(!t){n._aNodes=[];n._bLengthFinal=true;n._fireChange({reason:r.Change})}n.fireDataReceived()})};a.prototype._restoreServerIndexNodes=function(e,t,i){var n=this;return this._requestServerIndexNodes(e,t,0,i).then(function(e){n._addServerIndexNodes(e.oData,e.iSkip);return e})};a.prototype._addServerIndexNodes=function(t,i){var n,r,o,a,s=function(e,t){if(!e.isDeepOne&&!e.initiallyCollapsed&&e.serverIndex<o&&e.serverIndex+e.magnitude>=o){return true}};if(!this._bLengthFinal){var d=t.__count?parseInt(t.__count,10):0;this._aNodes[d-1]=undefined;this._bLengthFinal=true}if(t.results&&t.results.length>0){for(a=0;a<t.results.length;a++){n=t.results[a];r=this.oModel.getKey(n);o=i+a;var l=n[this.oTreeProperties["hierarchy-node-descendant-count-for"]];if(l<0){l=0;e.sap.log.error("The entry data with key '"+r+"' under binding path '"+this.getPath()+"' has a negative 'hierarchy-node-descendant-count-for' which isn't allowed.")}var h=this._aNodes[o]=this._aNodes[o]||{key:r,context:this.oModel.getContext("/"+r),magnitude:l,level:n[this.oTreeProperties["hierarchy-level-for"]],originalLevel:n[this.oTreeProperties["hierarchy-level-for"]],initiallyCollapsed:n[this.oTreeProperties["hierarchy-drill-state-for"]]==="collapsed",nodeState:{isLeaf:n[this.oTreeProperties["hierarchy-drill-state-for"]]==="leaf",expanded:n[this.oTreeProperties["hierarchy-drill-state-for"]]==="expanded",collapsed:n[this.oTreeProperties["hierarchy-drill-state-for"]]==="collapsed",selected:this._mSelected[r]?this._mSelected[r].nodeState.selected:false},children:[],addedSubtrees:[],serverIndex:o,parent:null,isDeepOne:false};if(this._iLowestServerLevel===null){this._iLowestServerLevel=h.level}else{this._iLowestServerLevel=Math.min(this._iLowestServerLevel,h.level)}if(this._bSelectAll){if(!this._aExpandedAfterSelectAll.some(s)){this.setNodeSelection(h,true)}}}}};a.prototype._requestServerIndexNodes=function(e,i,n,r){return new Promise(function(a,s){var d={iSkip:e,iTop:i+(n||0),iThreshold:n};this._aPendingRequests.sort(function(e,t){return e.iSkip-t.iSkip});for(var l=0;l<this._aPendingRequests.length;l++){if(o._determineRequestDelta(d,this._aPendingRequests[l])===false){return}}e=d.iSkip;i=d.iTop;function h(t){var n=this._aPendingRequests.indexOf(d);this._aPendingRequests.splice(n,1);a({oData:t,iSkip:e,iTop:i})}function p(e){var t=this._aPendingRequests.indexOf(d);this._aPendingRequests.splice(t,1);s(e)}var f=["$skip="+e,"$top="+i];if(!this._bLengthFinal||r){f.push("$inlinecount=allpages")}if(this.sCustomParams){f.push(this.sCustomParams)}var u=new t(this.oTreeProperties["hierarchy-level-for"],"LE",this.getNumberOfExpandedLevels());var c=[u];if(this.aApplicationFilters){c=c.concat(this.aApplicationFilters)}d.oRequestHandle=this.oModel.read(this.getPath(),{context:this.oContext,urlParameters:f,filters:[new t({filters:c,and:true})],sorters:this.aSorters||[],success:h.bind(this),error:p.bind(this),groupId:this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId});this._aPendingRequests.push(d)}.bind(this))};a.prototype._propagateMagnitudeChange=function(e,t){while(e!=null&&(e.initiallyCollapsed||e.isDeepOne)){e.magnitude+=t;e=e.parent}};a.prototype._getInitialMagnitude=function(e){var t=0,i;if(e.isDeepOne){return 0}if(e.children){for(var n=0;n<e.children.length;n++){i=e.children[n];t+=i.magnitude+1}}return e.magnitude-t};a.prototype._loadChildren=function(e,t,i){var n=this;this.fireDataRequested();this._requestChildren(e,t,i).then(function(t){n._addChildNodes(t.oData,e,t.iSkip);n._fireChange({reason:r.Change});n.fireDataReceived({data:t.oData})},function(t){var i=t.statusCode===0;if(!i){if(e.childCount===undefined){e.children=[];e.childCount=0;n._fireChange({reason:r.Change})}}n.fireDataReceived()})};a.prototype._restoreChildren=function(e,t,i){var n=this,r=this.oModel.getKey(e.context);return this._requestChildren(e,t,i,true).then(function(e){var t;n._map(function(e,i){if(e&&e.key===r){t=e;i.broken=true}});if(t){n._addChildNodes(e.oData,t,e.iSkip);n.expand(t,true)}return e})};a.prototype._addChildNodes=function(e,t,i){if(t.childCount==undefined&&e&&e.__count){var n=e.__count?parseInt(e.__count,10):0;t.childCount=n;t.children[n-1]=undefined;if(t.nodeState.expanded){this._propagateMagnitudeChange(t,n)}else{t.magnitude=n}this._cleanTreeStateMaps()}if(e.results&&e.results.length>0){for(var r=0;r<e.results.length;r++){var o=e.results[r];var a=this.oModel.getKey(o);var s=t.children[i+r]=t.children[i+r]||{key:a,context:this.oModel.getContext("/"+a),magnitude:0,level:t.level+1,originalLevel:t.level+1,initiallyCollapsed:o[this.oTreeProperties["hierarchy-drill-state-for"]]==="collapsed",nodeState:{isLeaf:o[this.oTreeProperties["hierarchy-drill-state-for"]]==="leaf",expanded:o[this.oTreeProperties["hierarchy-drill-state-for"]]==="expanded",collapsed:o[this.oTreeProperties["hierarchy-drill-state-for"]]==="collapsed",selected:this._mSelected[a]?this._mSelected[a].nodeState.selected:false},positionInParent:i+r,children:[],addedSubtrees:[],parent:t,originalParent:t,isDeepOne:true,containingServerIndex:t.containingServerIndex||t.serverIndex};if(this._bSelectAll&&this._aExpandedAfterSelectAll.indexOf(t)===-1){this.setNodeSelection(s,true)}}}};a.prototype._requestChildren=function(e,i,n,r){return new Promise(function(a,s){var d={sParent:e.key,iSkip:i,iTop:n};this._aPendingChildrenRequests.sort(function(e,t){return e.iSkip-t.iSkip});for(var l=0;l<this._aPendingChildrenRequests.length;l++){var h=this._aPendingChildrenRequests[l];if(h.sParent===d.sParent){if(o._determineRequestDelta(d,h)===false){return}}}i=d.iSkip;n=d.iTop;function p(e){var t=this._aPendingChildrenRequests.indexOf(d);this._aPendingChildrenRequests.splice(t,1);a({oData:e,iSkip:i,iTop:n})}function f(e){var t=this._aPendingChildrenRequests.indexOf(d);this._aPendingChildrenRequests.splice(t,1);s(e)}var u=["$skip="+i,"$top="+n];if(e.childCount==undefined||r){u.push("$inlinecount=allpages")}if(this.sCustomParams){u.push(this.sCustomParams)}var c=new t(this.oTreeProperties["hierarchy-parent-node-for"],"EQ",e.context.getProperty(this.oTreeProperties["hierarchy-node-for"]));var _=[c];if(this.aApplicationFilters){_=_.concat(this.aApplicationFilters)}d.oRequestHandle=this.oModel.read(this.getPath(),{context:this.oContext,urlParameters:u,filters:[new t({filters:_,and:true})],sorters:this.aSorters||[],success:p.bind(this),error:f.bind(this),groupId:this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId});this._aPendingChildrenRequests.push(d)}.bind(this))};a.prototype.findNode=function(e){return this._bReadOnly?this._indexFindNode(e):this._mapFindNode(e)};a.prototype._mapFindNode=function(e){if(this.isInitial()){return}var t=this._aNodeCache[e];if(t){return t}var i=-1;this._map(function(n,r,o,a,s){i++;if(i===e){t=n;r.broken=true}});return t};a.prototype._indexFindNode=function(e){if(this.isInitial()){return}var t=this._aNodeCache[e];if(t){return t}var i=this.getNodeInfoByRowIndex(e),t;if(i.parent){t=i.parent.children[i.childIndex]}else{t=this._aNodes[i.index]}this._aNodeCache[e]=t;return t};a.prototype.toggleIndex=function(t){var i=this.findNode(t);e.sap.assert(i!=undefined,"toggleIndex("+t+"): Node not found!");if(i){if(i.nodeState.expanded){this.collapse(i)}else{this.expand(i)}}};a.prototype.expand=function(t,i){var n=t;if(typeof t!=="object"){n=this.findNode(t);e.sap.assert(n!=undefined,"expand("+t+"): Node not found!")}if(n.nodeState.expanded){return}n.nodeState.expanded=true;n.nodeState.collapsed=false;var o=this._aCollapsed.indexOf(n);if(o!=-1){this._aCollapsed.splice(o,1)}this._aExpanded.push(n);this._sortNodes(this._aExpanded);if(n.serverIndex!==undefined){this._aNodeChanges[n.serverIndex]=true}if(this._bSelectAll){this._aExpandedAfterSelectAll.push(n)}if(n.initiallyCollapsed&&n.childCount==undefined){this._loadChildren(n,0,this._iPageSize)}else{this._propagateMagnitudeChange(n.parent,n.magnitude)}this._cleanTreeStateMaps();this._aNodeCache=[];if(!i){this._fireChange({reason:r.Expand})}};a.prototype.expandToLevel=function(e){if(e>this.getNumberOfExpandedLevels()){this.setNumberOfExpandedLevels(e)}};a.prototype.collapse=function(t,i){var n=t;if(typeof t!=="object"){n=this.findNode(t);e.sap.assert(n!=undefined,"expand("+t+"): Node not found!")}if(n.nodeState.collapsed){return}n.nodeState.expanded=false;n.nodeState.collapsed=true;var o=this._aExpanded.indexOf(n);if(o!=-1){this._aExpanded.splice(o,1)}if(this._bSelectAll){o=this._aExpandedAfterSelectAll.indexOf(n);if(o!==-1){this._aExpandedAfterSelectAll.splice(o,1)}}this._aCollapsed.push(n);this._sortNodes(this._aCollapsed);if(n.isDeepOne){this._propagateMagnitudeChange(n.parent,n.magnitude*-1)}if(n.serverIndex!==undefined){this._aNodeChanges[n.serverIndex]=true}this._cleanUpSelection();this._cleanTreeStateMaps();this._aNodeCache=[];if(!i){this._fireChange({reason:r.Collapse})}};a.prototype.collapseToLevel=function(e){if(e<this.getNumberOfExpandedLevels()){if(this.bCollapseRecursive){for(var t in this._mSelected){var i=this._mSelected[t];if(i.level>e){this.setNodeSelection(i,false)}}}this.setNumberOfExpandedLevels(e)}};a.prototype._getInvisibleSelectedNodes=function(){var e=[];var t=true;var i=function(e,i){if(e.nodeState.collapsed||e.nodeState.removed&&!e.nodeState.reinserted){t=false;i.broken=true}};for(var n in this._mSelected){var r=this._mSelected[n];t=true;this._up(r,i,false);if(!t){e.push(r)}}return e};a.prototype._cleanUpSelection=function(e){var t=this._getInvisibleSelectedNodes();t.forEach(function(t){if(t.key==this._sLeadSelectionKey){this._sLeadSelectionKey=null}if(this.bCollapseRecursive||e){this.setNodeSelection(t,false)}}.bind(this))};a.prototype._isInSubtree=function(e,t){var i=false;var n=function(t,n){if(t==e){n.broken=true;i=true}};this._up(t,n,false);return i};a.prototype._up=function(e,t,i){var n={broken:false};var r=this._getParent(e,i);if(r){this._structuralUp(r,t,n,i)}else{this._flatUp(e,t,n,true)}};a.prototype._structuralUp=function(e,t,i,n){var r=e;do{t(r,i);if(i.broken){return}e=r;r=this._getParent(r)}while(r);this._flatUp(e,t,i)};a.prototype._flatUp=function(e,t,i,n){var r=e.serverIndex,o=n?r-1:r,a,s;for(;o>=0;o--){if(this._aNodeChanges[o]){a=this._aNodes[o];if(a.initiallyCollapsed){continue}if(a.serverIndex+a.magnitude>=r){t(a,i);if(i.broken){return}s=this._getParent(a);if(s){this._structuralUp(s,t,i);return}}else{continue}}}};a.prototype._getParent=function(e,t){return t?e.originalParent:e.parent};a.prototype._cleanTreeStateMaps=function(){this._iLengthDelta=this._bReadOnly?this._indexCleanTreeStateMaps():this._mapCleanTreeStateMaps()};a.prototype._indexCleanTreeStateMaps=function(){return this._calcIndexDelta(this._aNodes.length)};a.prototype._mapCleanTreeStateMaps=function(){var e=this._aCollapsed.concat(this._aRemoved).concat(this._aExpanded).concat(this._aAdded),t=true,i,n=0,r=function(e,i){if(e.nodeState.collapsed||e.nodeState.removed&&!e.nodeState.reinserted){t=false;i.broken=true}},o={};var a=[[0,1],[-1,0]];e.forEach(function(e){if(o[e.key]){return}else{o[e.key]=true}if(e.nodeState.added){if(!e.nodeState.removed||e.nodeState.reinserted){t=true;this._up(e,r,false);if(t){n++}}}else{if(e.nodeState.collapsed||e.nodeState.expanded||e.nodeState.removed){t=true;this._up(e,r,false);if(t){if(e.nodeState.removed&&!e.nodeState.reinserted){if(e.isDeepOne||e.initiallyCollapsed){n-=1}else{n-=e.magnitude+1}}else{if(e.nodeState.collapsed&&e.serverIndex!==undefined&&!e.initiallyCollapsed){n-=e.magnitude}if(e.nodeState.expanded&&(e.isDeepOne||e.initiallyCollapsed)){n+=e.children.length}}}if(e.nodeState.reinserted){i=t;t=true;this._up(e,r,true);var s=a[t|0][i|0];if(!!s){if(e.isDeepOne){n+=s*1}else{if(e.initiallyCollapsed){n+=s}else{n+=s*(1+e.magnitude)}}}}}}}.bind(this));return n};a.prototype.isLengthFinal=function(){return this._bLengthFinal};a.prototype.getLength=function(){return this._aNodes.length+this._iLengthDelta};a.prototype.getContextByIndex=function(e){if(this.isInitial()){return}var t=this.findNode(e);return t&&t.context};a.prototype.getNodeByIndex=function(e){if(this.isInitial()){return}var t=this.findNode(e);return t};a.prototype.isExpanded=function(e){var t=this.findNode(e);return t&&t.nodeState.expanded};a.prototype.hasChildren=function(e){if(!e){return false}var t=this._findNodeByContext(e);var i=t&&t.node;return!(i&&i.nodeState.isLeaf)};a.prototype.nodeHasChildren=function(e){return!(e&&e.nodeState.isLeaf)};a.prototype.setNodeSelection=function(t,i){e.sap.assert(t,"Node must be defined!");t.nodeState.selected=i;if(i){delete this._mDeselected[t.key];this._mSelected[t.key]=t}else{delete this._mSelected[t.key];this._mDeselected[t.key]=t;if(t.key===this._sLeadSelectionKey){this._sLeadSelectionKey=null}}};a.prototype.isIndexSelected=function(e){var t=this.findNode(e);return t&&t.nodeState?t.nodeState.selected:false};a.prototype.isIndexSelectable=function(e){var t=this.findNode(e);return!!t};a.prototype._clearSelection=function(){return this._bReadOnly?this._indexClearSelection():this._mapClearSelection()};a.prototype._indexClearSelection=function(){var e=-1,t=[],i,n,r;this._bSelectAll=false;this._aExpandedAfterSelectAll=[];for(i in this._mSelected){n=this._mSelected[i];this.setNodeSelection(n,false);r=this.getRowIndexByNode(n);t.push(r);if(this._sLeadSelectionKey==i){e=r}}return{rowIndices:t,oldIndex:e,leadIndex:-1}};a.prototype._mapClearSelection=function(){var e=-1;var t=-1;var i=0;var n=[];this._bSelectAll=false;this._aExpandedAfterSelectAll=[];for(var r in this._mSelected){if(r){i++}}this._map(function(r,o,a,s,d){e++;if(r&&r.nodeState.selected){this.setNodeSelection(r,false);n.push(e);if(this._sLeadSelectionKey==r.key){t=e}if(n.length==i){o.broken=true}}}.bind(this));return{rowIndices:n,oldIndex:t,leadIndex:-1}};a.prototype.setSelectedIndex=function(t){var i=this.findNode(t);if(i){var n=this._clearSelection();var r=n.rowIndices.indexOf(t);if(r>=0){n.rowIndices.splice(r,1)}else{n.rowIndices.push(t)}n.leadKey=i.key;n.leadIndex=t;this.setNodeSelection(i,true);this._publishSelectionChanges(n)}else{e.sap.log.warning("ODataTreeBindingFlat: The selection of index '"+t+"' was ignored. Please make sure to only select rows, for which data has been fetched to the client.")}};a.prototype.getSelectedIndex=function(){return this._bReadOnly?this._indexGetSelectedIndex():this._mapGetSelectedIndex()};a.prototype._indexGetSelectedIndex=function(){if(!this._sLeadSelectionKey||e.isEmptyObject(this._mSelected)){return-1}var t=this._mSelected[this._sLeadSelectionKey];if(t){return this.getRowIndexByNode(t)}else{return-1}};a.prototype._mapGetSelectedIndex=function(){if(!this._sLeadSelectionKey||e.isEmptyObject(this._mSelected)){return-1}var t=-1;this._map(function(e,i){t++;if(e){if(e.key===this._sLeadSelectionKey){i.broken=true}}}.bind(this));return t};a.prototype.getSelectedIndices=function(){return this._bReadOnly?this._indexGetSelectedIndices():this._mapGetSelectedIndices()};a.prototype._indexGetSelectedIndices=function(){var e=this._getSelectedNodesInfo();return e.map(function(e){return e.rowIndex})};a.prototype._mapGetSelectedIndices=function(){var t=[];if(e.isEmptyObject(this._mSelected)){return t}var i=-1;this._map(function(e){i++;if(e){if(e.nodeState&&e.nodeState.selected){t.push(i)}}});return t};a.prototype.getSelectedNodesCount=function(){var t;if(this._bSelectAll){if(this._bReadOnly){var i=[],n=0,r;this._aExpandedAfterSelectAll.sort(function(t,i){var n=this._getRelatedServerIndex(t);var r=this._getRelatedServerIndex(i);e.sap.assert(n!=undefined,"getSelectedNodesCount: (containing) Server-Index not found for node 'a'");e.sap.assert(r!=undefined,"getSelectedNodesCount: (containing) Server-Index not found node 'b'");if(n==r&&t.isDeepOne&&i.isDeepOne){return t.originalLevel-i.originalLevel}return n-r}.bind(this));var o=-1,a,s,d;for(d=0;d<this._aExpandedAfterSelectAll.length;d++){a=this._aExpandedAfterSelectAll[d];s=this._getRelatedServerIndex(a);if(s<=o&&!a.initiallyCollapsed){continue}if(a.initiallyCollapsed){o=s}else{o=s+a.magnitude}i.push(a);n+=a.magnitude}var l=function(e,t){if(i.indexOf(e)!==-1){n--;t.broken=true}};for(r in this._mSelected){this._up(this._mSelected[r],l,true)}var h;var p=function(e,t){if(e.nodeState.collapsed||e.nodeState.removed&&!e.nodeState.reinserted||i.indexOf(e)!==-1){h=false;t.broken=true}};for(r in this._mDeselected){h=true;this._up(this._mDeselected[r],p,true);if(h){n++}}t=this.getLength()-n}else{t=0;this._map(function(e,i,n,r,o){var a;if(e){if(e.nodeState.selected){t++}}else if(e===undefined&&n==="serverIndex"){var s=true;for(var d=r-1;d>=0;d--){if(this._aNodeChanges[d]){a=this._aNodes[d];if(a.serverIndex+a.magnitude>=r&&this._aExpandedAfterSelectAll.indexOf(a)!==-1){s=false;break}}}if(s){t++}}}.bind(this))}}else{var f=this._getInvisibleSelectedNodes();t=Math.max(Object.keys(this._mSelected).length-f.length,0)}return t};a.prototype.getSelectedContexts=function(){return this._bReadOnly?this._indexGetSelectedContexts():this._mapGetSelectedContexts()};a.prototype._indexGetSelectedContexts=function(){var e=this._getSelectedNodesInfo();return e.map(function(e){return e.node.context})};a.prototype._mapGetSelectedContexts=function(){var t=[];if(e.isEmptyObject(this._mSelected)){return t}var i=function(e){if(e){if(e.nodeState.selected&&!e.isArtificial){t.push(e.context)}}};this._map(i);return t};a.prototype.setSelectionInterval=function(e,t){var i=this._clearSelection();var n=this._setSelectionInterval(e,t,true);var r={};var o=[];var a;for(var s=0;s<i.rowIndices.length;s++){a=i.rowIndices[s];r[a]=true}for(s=0;s<n.rowIndices.length;s++){a=n.rowIndices[s];if(r[a]){delete r[a]}else{r[a]=true}}for(a in r){if(r[a]){o.push(parseInt(a,10))}}this._publishSelectionChanges({rowIndices:o,oldIndex:i.oldIndex,leadIndex:n.leadIndex,leadKey:n.leadKey})};a.prototype._setSelectionInterval=function(e,t,i){return this._bReadOnly?this._indexSetSelectionInterval(e,t,i):this._mapSetSelectionInterval(e,t,i)};a.prototype._indexSetSelectionInterval=function(e,t,i){var n=Math.min(e,t),r=Math.max(e,t),o=[],a=[],s,d,l,h;i=!!i;for(l=n;l<=r;l++){d=this.findNode(l);if(d){if(d.nodeState.selected!==i){a.push(l)}if(d.key===this._sLeadSelectionKey){s=l}this.setNodeSelection(d,i);o.push(d)}}h={rowIndices:a,oldIndex:s,leadIndex:s&&!i?-1:undefined};if(o.length>0&&i){h.leadKey=o[o.length-1].key;h.leadIndex=r}return h};a.prototype._mapSetSelectionInterval=function(e,t,i){var n=Math.min(e,t);var r=Math.max(e,t);var o=[];var a=[];var s=Math.abs(r-n)+1;var d;var l=-1;var h=function(e,t,h,p,f){l++;if(e){if(l>=n&&l<=r){if(e.nodeState.selected!==!!i){a.push(l)}if(e.key===this._sLeadSelectionKey){d=l}this.setNodeSelection(e,!!i);o.push(e);if(o.length===s){t.broken=true}}}}.bind(this);this._map(h);var p={rowIndices:a,oldIndex:d,leadIndex:d&&!i?-1:undefined};if(o.length>0&&i){var f=o[o.length-1];p.leadKey=f.key;p.leadIndex=r}return p};a.prototype.addSelectionInterval=function(e,t){var i=this._setSelectionInterval(e,t,true);this._publishSelectionChanges(i)};a.prototype.removeSelectionInterval=function(e,t){var i=this._setSelectionInterval(e,t,false);this._publishSelectionChanges(i)};a.prototype.selectAll=function(){this._bReadOnly?this._indexSelectAll():this._mapSelectAll()};a.prototype._indexSelectAll=function(){this._bSelectAll=true;this._aExpandedAfterSelectAll=[];var e={rowIndices:[],oldIndex:-1,selectAll:true};var t=this.getLength(),i,n;for(i=0;i<t;i++){n=this.findNode(i);if(n&&!n.isArtificial){if(n.key===this._sLeadSelectionKey){e.oldIndex=i}if(!n.nodeState.selected){e.rowIndices.push(i)}this.setNodeSelection(n,true);e.leadKey=n.key;e.leadIndex=i}}this._publishSelectionChanges(e)};a.prototype._mapSelectAll=function(){this._bSelectAll=true;this._aExpandedAfterSelectAll=[];var e={rowIndices:[],oldIndex:-1,selectAll:true};var t=-1;this._map(function(i){if(!i||!i.isArtificial){t++}if(i){if(i.key===this._sLeadSelectionKey){e.oldIndex=t}if(i){if(!i.isArtificial&&!i.nodeState.selected){e.rowIndices.push(t)}this.setNodeSelection(i,true);e.leadKey=i.key;e.leadIndex=t}}}.bind(this));this._publishSelectionChanges(e)};a.prototype.clearSelection=function(e){var t=this._clearSelection();if(!e){this._publishSelectionChanges(t)}};a.prototype._publishSelectionChanges=function(e){e.oldIndex=e.oldIndex||this.getSelectedIndex();e.rowIndices.sort(function(e,t){return e-t});if(e.leadIndex>=0&&e.leadKey){this._sLeadSelectionKey=e.leadKey}else if(e.leadIndex===-1){this._sLeadSelectionKey=undefined}else{e.leadIndex=e.oldIndex}if(e.rowIndices.length>0||e.leadIndex!=undefined&&e.leadIndex!==-1){this.fireSelectionChanged(e)}};a.prototype.setCollapseRecursive=function(e){this.bCollapseRecursive=!!e};a.prototype.resetData=function(){n.prototype.resetData.apply(this,arguments);this._aNodes=[];this._aNodeCache=[];this._aCollapsed=[];this._aExpanded=[];this._aExpandedAfterSelectAll=[];this._mSelected={};this._mDeselected={};this._aAdded=[];this._aRemoved=[];this._aNodeChanges=[];this._aAllChangedNodes=[];this._bLengthFinal=false;this._iLowestServerLevel=null;this._bSelectAll=false;this._iLengthDelta=0};a.prototype._findNodeByContext=function(e){for(var t in this._aNodeCache){if(this._aNodeCache[t]&&this._aNodeCache[t].context==e){return{node:this._aNodeCache[t],index:parseInt(t,10)}}}var i=-1;var n;this._map(function(t,r,o,a,s){i++;if(t){if(t.context===e){n=t;r.broken=true}}});return{node:n,index:i}};a.prototype._getCorrectChangeGroup=function(e){if(!e){e=this.oModel.resolve(this.getPath(),this.getContext())}return this.oModel._resolveGroup(e).groupId};a.prototype.createEntry=function(t){var i=this.oModel.resolve(this.getPath(),this.getContext());var n;if(i){t=t||{};t.groupId=this._getCorrectChangeGroup(i);t.refreshAfterChange=false;n=this.oModel.createEntry(i,t)}else{e.sap.log.warning("ODataTreeBindingFlat: createEntry failed, as the binding path could not be resolved.")}return n};a.prototype.submitChanges=function(t){t=t||{};var i=this.oModel.resolve(this.getPath(),this.getContext()),n=this._optimizeChanges();if(!i){e.sap.log.warning("ODataTreeBindingFlat: submitChanges failed, because the binding-path could not be resolved.");return}t.groupId=this._getCorrectChangeGroup(i);var r=t.success||e.noop;var o=t.error||e.noop;var a=false;t.success=function(t){r(t);var i=false;if(t.__batchResponses&&t.__batchResponses[0]&&t.__batchResponses[0].__changeResponses&&t.__batchResponses[0].__changeResponses.length>0){var o=t.__batchResponses[0].__changeResponses;for(var s=0;s<o.length;s++){var d=o[s];var l=parseInt(d.statusCode,10);if(l<200||l>299){i=true;break}}if(i){}else if(this._bRestoreTreeStateAfterChange&&!a&&(!this.aApplicationFilters||this.aApplicationFilters.length===0)){this._restoreTreeState(n).catch(function(t){e.sap.log.error("ODataTreeBindingFlat - "+t.message,t.stack);this._refresh(true)}.bind(this))}else{this._refresh(true)}}else{e.sap.log.warning("ODataTreeBindingFlat.submitChanges - success: Batch-request response does not contain change response.")}}.bind(this);t.error=function(e){o(e)};this._generateSubmitData(n,function(t){e.sap.log.error("ODataTreeBindingFlat - Tree state restoration request failed. "+t.message,t.stack);a=true});this.oModel.submitChanges(t)};a.prototype._generateSubmitData=function(t,i){var n=t.removed,r=t.creationCancelled,o=t.added,a=t.moved,s=this;function d(t){e.sap.assert(t.context,"Node does not have a context.");var i=t.parent.context.getProperty(s.oTreeProperties["hierarchy-node-for"]);s.oModel.setProperty(s.oTreeProperties["hierarchy-parent-node-for"],i,t.context)}var l={groupId:this._getCorrectChangeGroup(),error:i};o.forEach(d);a.forEach(function(e){d(e);if(this._bRestoreTreeStateAfterChange&&(!this.aApplicationFilters||this.aApplicationFilters.length===0)){this._generatePreorderPositionRequest(e,l);this._generateSiblingsPositionRequest(e,l)}}.bind(this));n.forEach(function(t){this._generateDeleteRequest(t);e.sap.log.debug("ODataTreeBindingFlat: DELETE "+t.key)}.bind(this));r.forEach(function(e){this._generateDeleteRequest(e)}.bind(this))};a.prototype._generatePreorderPositionRequest=function(i,n){var r,o,a,s,d,l,h=[],p=this.aSorters||[],f;if(n){r=n.groupId||this.sGroupId;d=n.success;l=n.error}if(this.aApplicationFilters){h=h.concat(this.aApplicationFilters)}for(f=this._aTreeKeyProperties.length-1;f>=0;f--){o=this._aTreeKeyProperties[f];if(!a){a=o}else{a+=","+o}h.push(new t(o,"EQ",i.context.getProperty(o)))}h.push(new t(this.oTreeProperties["hierarchy-level-for"],"LE",this.getNumberOfExpandedLevels()));s=e.extend({},this.mParameters);s.select=a+","+this.oTreeProperties["hierarchy-node-descendant-count-for"]+","+this.oTreeProperties["hierarchy-drill-state-for"]+","+this.oTreeProperties["hierarchy-preorder-rank-for"];this.oModel.read(this.getPath(),{context:this.oContext,urlParameters:this.oModel.createCustomParams(s),filters:[new t({filters:h,and:true})],sorters:p,groupId:r,success:d,error:l})};a.prototype._generateSiblingsPositionRequest=function(t,i){var n,r,o,a;if(i){n=i.groupId||this.sGroupId;o=i.success;a=i.error}r=e.extend({},this.mParameters);r.select=this.oTreeProperties["hierarchy-sibling-rank-for"];this.oModel.read(t.context.getPath(),{urlParameters:this.oModel.createCustomParams(r),groupId:n,success:o,error:a})};a.prototype._nodeIsOnTopLevel=function(t){if(t&&t.serverIndex>=0){var i=t.parent==null;if(i){if(t.originalLevel==this._iLowestServerLevel){return true}else{return false}}}else{e.sap.log.warning("ODataTreeBindingFlat.nodeIsOnTopLevel: Node is not defined or not a server-indexed node.")}};a.prototype._generateDeleteRequest=function(e){var t=e.context;if(e.nodeState.added){this.oModel.deleteCreatedEntry(t)}else{var i=this.oModel.remove(t.getPath(),{groupId:this._getCorrectChangeGroup(),refreshAfterChange:false});return i}};a.prototype._filterChangeForServerSections=function(e){var t={};t.removed=e.removed.filter(function(e){return!e.isDeepOne});t.added=e.added.filter(function(e){return!e.isDeepOne});e.moved.forEach(function(e){if(!e.newIsDeepOne){t.added.push(e)}if(!e.isDeepOne){t.removed.push(e)}});return t};a.prototype._filterChangesForDeepSections=function(e){var t={};e.removed.forEach(function(e){var i;if(e.isDeepOne){i=e.parent;if(!t[i.key]){t[i.key]={added:[],removed:[]}}t[i.key].removed.push(e)}});e.added.forEach(function(e){var i;if(e.isDeepOne){i=e.parent;if(!t[i.key]){t[i.key]={added:[],removed:[]}}t[i.key].added.push(e)}});e.moved.forEach(function(e){var i;if(e.newIsDeepOne){i=e.parent;if(!t[i.key]){t[i.key]={added:[],removed:[]}}t[i.key].added.push(e)}if(e.isDeepOne){i=e.originalParent;if(!t[i.key]){t[i.key]={added:[],removed:[]}}t[i.key].removed.push(e)}});return t};a.prototype._optimizeOptimizedChanges=function(e){var t,i=this;t=e.added.slice();t.sort(function(e,t){var n=e.newIsDeepOne!==undefined?e.newIsDeepOne:e.isDeepOne,r=t.newIsDeepOne!==undefined?t.newIsDeepOne:t.isDeepOne;if(n&&r){return 0}if(n){return 1}if(r){return-1}return e.context.getProperty(i.oTreeProperties["hierarchy-preorder-rank-for"])-t.context.getProperty(i.oTreeProperties["hierarchy-preorder-rank-for"])});var n=-1;t=t.filter(function(e,t){if(e.newIsDeepOne!==undefined?e.newIsDeepOne:e.isDeepOne){return true}if(t<=n){return false}var r=e.context.getProperty(i.oTreeProperties["hierarchy-node-descendant-count-for"]);if(r){n=t+r}return true});return{added:t,removed:e.removed,moved:e.moved}};a.prototype._updateNodeInfoAfterSave=function(e){var t=e.context.getProperty(this.oTreeProperties["hierarchy-preorder-rank-for"])===undefined;if(e.isDeepOne===undefined){e.isDeepOne=t}else{e.newIsDeepOne=t}var i=e.context.getProperty(this.oTreeProperties["hierarchy-drill-state-for"])==="collapsed";if(e.initiallyCollapsed===undefined){e.initiallyCollapsed=i}else{e.newInitiallyCollapsed=i}};a.prototype._requestExtraInfoForAddedNodes=function(e){var t=[],i=this;e.forEach(function(e){var n=new Promise(function(t,n){i._generatePreorderPositionRequest(e,{success:t,error:n})});t.push(n)});t=t.map(function(e){return e.then(function(e){return{responseData:e}},function(e){return{error:e}})});return Promise.all(t).then(function(e){var t=0;e.forEach(function(e){if(e.error){if(e.error.statusCode===0){t++}else{throw new Error("Tree state restoration request failed. Complete or partial tree state might get lost. Error: "+(e.error.message.value||e.error.message))}}});return t===0})};a.prototype._restoreTreeState=function(e){var t=this;e=e||{creationCancelled:[],added:[],removed:[],moved:[]};this.fireDataRequested();return this._requestExtraInfoForAddedNodes(e.added).then(function(i){if(i){return t._executeRestoreTreeState(e).then(function(e){if(e){t._fireRefresh({reason:r.Refresh});t.fireDataReceived({data:e});return e}})}})};a.prototype._executeRestoreTreeState=function(e){var t,i,n,r,o,a,s,d,l,h,p,f,u,c=this;e.added.forEach(this._updateNodeInfoAfterSave.bind(this));e.moved.forEach(this._updateNodeInfoAfterSave.bind(this));s=[];n=this._collectServerSections(this._aNodes);e=this._optimizeOptimizedChanges(e);f=this._filterChangeForServerSections(e);this._adaptSections(n,f);for(d=0;d<n.length;d++){i=n[d];s.push(this._restoreServerIndexNodes(i.iSkip,i.iTop,d===0))}var _=this._collectDeepNodes();u=this._filterChangesForDeepSections(e);for(l=0;l<_.length;l++){r=_[l];if(u){f=u[r.oParentNode.key];if(f){this._adaptSections(r.aChildSections,f,{indexName:"positionInParent",ignoreMagnitude:true})}}for(h=0;h<r.aChildSections.length;h++){o=r.aChildSections[h];s.push(this._restoreChildren(r.oParentNode,o.iSkip,o.iTop))}}a={};for(p=0;p<this._aCollapsed.length;p++){a[this._aCollapsed[p].key]=true}t=this._aCollapsed.length;this.resetData();function v(){if(t>0){c._map(function(e,i){if(e&&a[e.key]){c.collapse(e,true);t--;if(t===0){i.broken=true}}})}}s=s.map(function(e){return e.then(function(e){return{responseData:e}},function(e){return{error:e}})});return Promise.all(s).then(function(e){var t=0;e.forEach(function(e){if(e.error){if(e.error.statusCode===0){t++}else{throw new Error("Tree state restoration request failed. Complete or partial tree state might get lost. Error: "+(e.error.message.value||e.error.message))}}});if(t<e.length){v();return e}})};a.prototype._collectServerSections=function(e){var t=[];var i;for(var n=0;n<e.length;n++){if(e[n]!==undefined){if(!i){i={iSkip:n,iTop:1};t.push(i)}else{i.iTop++}}else{i=null}}return t};a.prototype._adaptSections=function(t,i,n){var r=i.removed||[],o=i.added||[],a=n&&n.indexName||"serverIndex",s,d,l,h,p,f=0,u,c,_,v,g,S,x,y=0,m,I,C=[];for(var b=o.length-1;b>=0;b--){s=o[b];if(s.newIsDeepOne!==undefined?s.newIsDeepOne:s.isDeepOne){I=this.oTreeProperties["hierarchy-sibling-rank-for"]}else{I=this.oTreeProperties["hierarchy-preorder-rank-for"];if(s.newInitiallyCollapsed!==undefined?!s.newInitiallyCollapsed:!s.initiallyCollapsed){u=s.context.getProperty(this.oTreeProperties["hierarchy-node-descendant-count-for"])}}c=s.context.getProperty(I);if(c===undefined){e.sap.log.warning("ODataTreeBindingFlat","Missing "+I+" value for node "+s.key);break}C.push({position:c,magnitude:u||0,assignedToSection:false})}for(var N=0;N<t.length;N++){d=t[N];x=y;_=v;v=0;m=0;for(var P=r.length-1;P>=0;P--){s=r[P];c=s[a];if(c>=d.iSkip&&c<=d.iSkip+d.iTop){if(a==="serverIndex"){f++}u=n&&n.ignoreMagnitude?0:this._getInitialMagnitude(s);p=1+u;h=d.iSkip+d.iTop-c-p;if(h>0){m-=p}else{m-=d.iSkip+d.iTop-c;if(h<0){v=c+p}}x-=p}}if(d.iSkip<=_){g=d.iSkip-_;m+=g;if(d.iTop+m<0){v=_}}d.iSkip+=y;d.iTop+=m;if(d.iTop>0){y=0;m=0;for(var k=0;k<C.length;k++){l=C[k];c=l.position;S=n&&n.ignoreMagnitude?1:l.magnitude+1;if(c>=d.iSkip&&c<=d.iSkip+d.iTop){m+=S;C[k].assignedToSection=true}else if(c<d.iSkip){y+=S}}d.iSkip+=y;d.iTop+=m;d.iTop+=f}if(d.iTop<=0){t.splice(N,1);N--}y=x}for(var R=0;R<C.length;R++){l=C[R];S=n&&n.ignoreMagnitude?1:l.magnitude+1;if(!l.assignedToSection){t.push({iSkip:l.position,iTop:S})}}t.sort(function(e,t){return e.iSkip-t.iSkip});for(var D=0;D<t.length;D++){if(D+1<t.length){d=t[D];var T=t[D+1];if(d.iSkip+d.iTop===T.iSkip){d.iTop+=T.iTop;t.splice(D+1,1);D--}}}};a.prototype._optimizeChanges=function(){var t=[],i=[],n=[],r=[];var o=false;var a=function(e,t){if(e.nodeState.removed&&!e.nodeState.reinserted){o=true;t.broken=true}};var s=[];var d=function(e){if((e.isDeepOne||e.serverIndex>=0)&&s.indexOf(e)==-1){s.push(e)}if(e.nodeState.added){i.push(e)}};this._aAllChangedNodes.forEach(function(e){o=false;this._up(e,a,false);if(o){d(e)}else{if(e.nodeState.removed&&!e.nodeState.reinserted){d(e)}else if(e.nodeState.added){n.push(e)}else{r.push(e)}}}.bind(this));s.sort(function(t,i){var n=this._getRelatedServerIndex(t);var r=this._getRelatedServerIndex(i);e.sap.assert(n!=undefined,"_generateSubmitData: (containing) Server-Index not found for node 'a'");e.sap.assert(r!=undefined,"_generateSubmitData: (containing) Server-Index not found node 'b'");if(n==r&&t.isDeepOne&&i.isDeepOne){if(t.parent===i.parent){return t.positionInParent-i.positionInParent}else{return t.originalLevel-i.originalLevel}}return n-r}.bind(this));var l=function(e){var t=false;this._up(e,function(e,i){if(e.nodeState.removed&&!e.nodeState.reinserted){t=true;i.broken=true}},true);return t}.bind(this);for(var h=0;h<s.length;h++){var p=s[h];if(!l(p)){t.push(p)}}return{removed:t,creationCancelled:i,added:n,moved:r}};a.prototype._collectDeepNodes=function(){var e=[],t=this;this._map(function(i){if(i&&i.nodeState.expanded&&(i.initiallyCollapsed||i.isDeepOne)){e.push({oParentNode:i,aChildSections:t._collectServerSections(i.children)})}});return e};a.prototype._trackChangedNode=function(e){if(this._aAllChangedNodes.indexOf(e)==-1){this._aAllChangedNodes.push(e)}};a.prototype.addContexts=function(t,i){var n=this._findNodeByContext(t),o=n.node,a=this.getModel(),s,d;e.sap.assert(t&&i,"ODataTreeBinding.addContexts() was called with incomplete arguments!");if(o){this._bReadOnly=false;if(o.nodeState&&o.nodeState.isLeaf){o.nodeState.isLeaf=false;o.nodeState.collapsed=true}if(!e.isArray(i)){if(i instanceof sap.ui.model.Context){i=[i]}else{e.sap.log.warning("ODataTreeBinding.addContexts(): The child node argument is not of type sap.ui.model.Context.")}}var l=function(e){return function(){return[e]}};i=i.slice();i.reverse();for(var h=0;h<i.length;h++){var d=i[h];if(!d||!(d instanceof sap.ui.model.Context)){e.sap.log.warning("ODataTreeBindingFlat.addContexts(): no valid child context given!");return}var s=this._mSubtreeHandles[d.getPath()];this._ensureHierarchyNodeIDForContext(d);if(s&&s._isRemovedSubtree){e.sap.log.info("ODataTreeBindingFlat.addContexts(): Existing context added '"+d.getPath()+"'");s._oNewParentNode=o;s._oSubtreeRoot.nodeState.reinserted=true;s._oSubtreeRoot.originalParent=s._oSubtreeRoot.originalParent||s._oSubtreeRoot.parent;s._oSubtreeRoot.parent=o;s._oSubtreeRoot.containingSubtreeHandle=s;d=s.getContext();this._trackChangedNode(s._oSubtreeRoot);this._mSubtreeHandles[d.getPath()]}else{e.sap.log.info("ODataTreeBindingFlat.addContexts(): Newly created context added.");this._ensureHierarchyNodeIDForContext(d);var p={context:d,key:a.getKey(d),parent:o,nodeState:{isLeaf:true,collapsed:false,expanded:false,selected:false,added:true},addedSubtrees:[],children:[],magnitude:0};this._trackChangedNode(p);this._aAdded.push(p);s={_getSubtree:l(p),_oSubtreeRoot:null,_oNewParentNode:o}}s._iContainingServerIndex=o.serverIndex||o.containingServerIndex;o.addedSubtrees.unshift(s);if(o.serverIndex!==undefined){this._aNodeChanges[o.serverIndex]=true}}this._aNodeCache=[];this._cleanTreeStateMaps();this._fireChange({reason:r.Add})}else{e.sap.log.warning("The given parent context could not be found in the tree. No new sub-nodes were added!")}};a.prototype._ensureHierarchyNodeIDForContext=function(t){if(t){var i=t.getProperty(this.oTreeProperties["hierarchy-node-for"]);if(t.bCreated&&!i){this.oModel.setProperty(this.oTreeProperties["hierarchy-node-for"],e.sap.uid(),t)}}};a.prototype.removeContext=function(t){var i=this;var n=this._findNodeByContext(t);var o=n.node;var a=n.index;if(o){this._bReadOnly=false;o.nodeState.removed=true;this._aRemoved.push(o);this._trackChangedNode(o);if(o.serverIndex!==undefined){this._aNodeChanges[o.serverIndex]=true}if(o.containingSubtreeHandle&&o.parent!=null){var s=o.parent.addedSubtrees.indexOf(o.containingSubtreeHandle);if(s!=-1){o.parent.addedSubtrees.splice(s,1);o.nodeState.reinserted=false;o.parent=null}}this._aNodeCache=[];this.setNodeSelection(o,false);this._cleanUpSelection(true);this._cleanTreeStateMaps();this._fireChange({reason:r.Remove});this._mSubtreeHandles[t.getPath()]={_removedFromVisualIndex:a,_isRemovedSubtree:true,_oSubtreeRoot:o,_getSubtree:function(){if(o.serverIndex!=undefined&&!o.initiallyCollapsed){return i._aNodes.slice(o.serverIndex,o.serverIndex+o.magnitude+1)}else{return o}},getContext:function(){return t},_restore:function(){o.nodeState.removed=false;var e=i._aRemoved.indexOf(o);if(e!=-1){i._aRemoved.splice(e,1)}this._aNodeCache=[];i._cleanTreeStateMaps();i._fireChange({reason:r.Add})}};return t}else{e.sap.log.warning("ODataTreeBinding.removeContexts(): The given context is not part of the tree. Was it removed already?")}};a.prototype._getRelatedServerIndex=function(e){if(e.serverIndex===undefined){return e.containingServerIndex}else{return e.serverIndex}};a.prototype.getNodeInfoByRowIndex=function(e){var t=0,i=0,n,r,o=-1;while(t<this._aCollapsed.length||i<this._aExpanded.length){if(this._aCollapsed[t]&&this._aExpanded[i]){if(this._getRelatedServerIndex(this._aCollapsed[t])>this._getRelatedServerIndex(this._aExpanded[i])){n=this._aExpanded[i];i++;r=false}else{n=this._aCollapsed[t];t++;r=true}}else if(this._aCollapsed[t]){n=this._aCollapsed[t];t++;r=true}else{n=this._aExpanded[i];i++;r=false}if(e<=this._getRelatedServerIndex(n)){break}if(r){if(!n.isDeepOne&&!n.initiallyCollapsed&&n.serverIndex>o){e+=n.magnitude;o=n.serverIndex+n.magnitude}}else{if(n.serverIndex>o){if(!n.isDeepOne&&n.initiallyCollapsed){e-=n.magnitude}if(e<=n.serverIndex){return this._calcDirectIndex(n,e+n.magnitude-n.serverIndex-1)}}}}return{index:e}};a.prototype._calcDirectIndex=function(e,t){var i,n,r;for(i=0;i<e.children.length;i++){r=e.children[i];if(t===0){return{parent:e,childIndex:i}}n=r?r.magnitude:0;t--;if(!r||r.nodeState.collapsed){continue}if(t<n){return this._calcDirectIndex(r,t)}else{t-=n}}};a.prototype.getRowIndexByNode=function(e){var t=0;var i;var n;if(e.isDeepOne){while(e.parent){t+=e.positionInParent+1;for(n=0;n<e.positionInParent;n++){i=e.parent.children[n];if(i&&i.nodeState.expanded){t+=i.magnitude}}e=e.parent}}return this._calcIndexDelta(e.serverIndex)+e.serverIndex+t};a.prototype._getSelectedNodesInfo=function(){var t=[];if(e.isEmptyObject(this._mSelected)){return t}var i=true;var n=function(e,t){if(e.nodeState.collapsed||e.nodeState.removed&&!e.nodeState.reinserted){i=false;t.broken=true}};for(var r in this._mSelected){var o=this._mSelected[r];i=true;this._up(o,n,false);if(i){t.push({node:o,rowIndex:this.getRowIndexByNode(o)})}}t.sort(function(e,t){return e.rowIndex-t.rowIndex});return t};a.prototype._calcIndexDelta=function(e){var t={};this._aCollapsed.forEach(function(i){if(i.serverIndex>=0&&i.serverIndex<e&&!i.isDeepOne&&!i.initiallyCollapsed){t[i.serverIndex]=i.magnitude}});var i=0;var n=0;for(var r=0;r<this._aCollapsed.length;r++){var o=this._aCollapsed[r];if(this._getRelatedServerIndex(o)>=e){break}if(!o.isDeepOne){if(o.serverIndex>=i&&!o.initiallyCollapsed){n-=o.magnitude;i=o.serverIndex+o.magnitude}else{}}else{}}var a=0;var s=function(e){var i=false;var n=e.serverIndex||e.containingServerIndex;for(var r in t){if(n>r&&n<r+t[r]){i=true;break}}return i};for(r=0;r<this._aExpanded.length;r++){var d=this._aExpanded[r];if(this._getRelatedServerIndex(d)>=e){break}if(d.isDeepOne){var l=d.parent;var h=false;while(l){if(l.nodeState.collapsed){h=true;break}l=l.parent}var p=s(d);if(!h&&!p){a+=d.children.length}}else if(d.initiallyCollapsed){var p=s(d);if(!p){a+=d.children.length}}}return a+n};a.prototype._sortNodes=function(e){var t=function(e,t){var i=this._getRelatedServerIndex(e);var n=this._getRelatedServerIndex(t);return i-n}.bind(this);e.sort(t)};a.prototype.attachSelectionChanged=function(e,t,i){this.attachEvent("selectionChanged",e,t,i);return this};a.prototype.detachSelectionChanged=function(e,t){this.detachEvent("selectionChanged",e,t);return this};a.prototype.fireSelectionChanged=function(e){this.fireEvent("selectionChanged",e);return this};a.prototype.getRootContexts=function(){};a.prototype.getNodeContexts=function(){};return a},true);