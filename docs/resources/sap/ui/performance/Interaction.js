/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./Measurement","./ResourceTimings","./XHRInterceptor","sap/base/util/now","sap/base/Log","sap/ui/thirdparty/URI"],function(e,t,n,i,r,s){"use strict";var o=window.location.host,a="INTERACTION",u=[],d=p();function g(e){var t=new s(e).host();return t&&t!==o}function p(e){return{event:"startup",trigger:"undetermined",component:"undetermined",appVersion:"undetermined",start:e||window.performance.timing.fetchStart,end:0,navigation:0,roundtrip:0,processing:0,duration:0,requests:[],measurements:[],sapStatistics:[],requestTime:0,networkTime:0,bytesSent:0,bytesReceived:0,requestCompression:undefined,busyDuration:0}}function f(e){if(e.start>d.start&&e.end<d.end){return e}}function c(e){var t,n,i;t=e.startTime>0&&e.startTime<=e.requestStart&&e.requestStart<=e.responseEnd;if(e.encodedBodySize!==undefined&&e.transferSize!==undefined){n=e.encodedBodySize===0;i=e.transferSize<e.encodedBodySize}return t&&!n&&!i}function h(e){this.end=e.responseEnd>this.end?e.responseEnd:this.end;d.requestTime+=e.responseEnd-e.startTime;if(this.roundtripHigherLimit<=e.startTime){d.navigation+=this.navigationHigherLimit-this.navigationLowerLimit;d.roundtrip+=this.roundtripHigherLimit-this.roundtripLowerLimit;this.navigationLowerLimit=e.startTime;this.roundtripLowerLimit=e.startTime}if(e.responseEnd>this.roundtripHigherLimit){this.roundtripHigherLimit=e.responseEnd}if(e.requestStart>this.navigationHigherLimit){this.navigationHigherLimit=e.requestStart}}function m(e){var t={start:e[0].startTime,end:e[0].responseEnd,navigationLowerLimit:e[0].startTime,navigationHigherLimit:e[0].requestStart,roundtripLowerLimit:e[0].startTime,roundtripHigherLimit:e[0].responseEnd};e.forEach(h,t);d.navigation+=t.navigationHigherLimit-t.navigationLowerLimit;d.roundtrip+=t.roundtripHigherLimit-t.roundtripLowerLimit;if(d.networkTime){var n=d.requestTime-d.networkTime;d.networkTime=n/e.length}else{d.networkTime=0}if(d.processing===0){var i=d.start-window.performance.timing.fetchStart;d.duration=t.end-i;d.processing=t.start-i}}function l(n){if(d){d.end=n;d.duration=d.processing;d.requests=t.getRequestTimings();d.completeRoundtrips=0;d.measurements=e.filterMeasurements(f,true);var i=d.requests.filter(c);if(i.length>0){m(i)}d.completeRoundtrips=i.length;var s=d.processing-d.navigation-d.roundtrip;d.processing=s>-1?s:0;u.push(d);r.info("Interaction step finished: trigger: "+d.trigger+"; duration: "+d.duration+"; requests: "+d.requests.length,"Interaction.js");d=null}}function v(e){var t,n;if(e){var i,r;i=sap.ui.require("sap/ui/core/Component");while(i&&e&&e.getParent){r=i.getOwnerComponentFor(e);if(r||e instanceof i){r=r||e;var s=r.getManifestEntry("sap.app");t=s&&s.id||r.getMetadata().getName();n=s&&s.applicationVersion&&s.applicationVersion.version}e=e.getParent()}}return{id:t?t:"undetermined",version:n?n:""}}var L=false,y,T,I=0;function S(){n.register(a,"send",function(){if(this.pendingInteraction){this.pendingInteraction.bytesSent+=arguments[0]?arguments[0].length*2:0}});n.register(a,"setRequestHeader",function(e,t){if(!this.requestHeaderLength){this.requestHeaderLength=0}this.requestHeaderLength+=(e.length+t.length+3)*2});n.register(a,"open",function(){if(!g(arguments[1])){this.addEventListener("readystatechange",q)}this.pendingInteraction=d})}function q(){if(this.readyState===4&&this.pendingInteraction&&!this.pendingInteraction.completed){var e=this.getResponseHeader("content-length"),n=this.getResponseHeader("content-encoding")==="gzip",i=this.getResponseHeader("sap-perf-fesrec");this.pendingInteraction.bytesReceived+=e?parseInt(e,10):0;this.pendingInteraction.bytesReceived+=this.getAllResponseHeaders().length*2;this.pendingInteraction.bytesSent+=this.requestHeaderLength||0;this.pendingInteraction.requestCompression=n&&this.pendingInteraction.requestCompression!==false;this.pendingInteraction.networkTime+=i?Math.round(parseFloat(i,10)/1e3):0;var r=this.getResponseHeader("sap-statistics");if(r){var s=t.getRequestTimings();this.pendingInteraction.sapStatistics.push({url:this.responseURL,statistics:r,timing:s?s[s.length-1]:undefined})}delete this.requestHeaderLength;delete this.pendingInteraction}}var w={getAll:function(e){if(e){w.end(true)}return u},filter:function(e){var t=[];if(e){for(var n=0,i=u.length;n<i;n++){if(e(u[n])){t.push(u[n])}}}return t},getPending:function(){return d},clear:function(){u=[]},start:function(e,n){var s=i();if(d){l(s)}t.clearRequestTimings();var o=v(n);d=p(s);d.event=e;d.component=o.id;d.appVersion=o.version;d.start=s;if(n&&n.getId){d.trigger=n.getId()}r.info("Interaction step started: trigger: "+d.trigger+"; type: "+d.event,"Interaction.js")},end:function(e){if(d){if(!e){d.processing=i()-d.start}else{l(i())}}},getActive:function(){return L},setActive:function(e){if(e&&!L){S()}L=e},notifyStepStart:function(e,t){if(L){if(y||t){var n;if(t){n="startup"}else if(y.originalEvent){n=y.originalEvent.type}else{n=y.type}w.start(n,e);var i=w.getAll();var r=i[i.length-1];var s=w.getPending();d=s?s:d;if(w.onInteractionFinished&&r){w.onInteractionFinished(r)}y=null}}},notifyStepEnd:function(){if(L){if(T){clearTimeout(T)}T=setTimeout(w.end,1)}},notifyEventStart:function(e){y=L?e:null},notifyScrollEvent:function(e){if(L){if(!I){w.notifyEventStart(e)}else{clearTimeout(I)}I=setTimeout(function(){w.notifyStepStart();I=0},250)}},notifyEventEnd:function(){if(y){if(y.type.match(/^(mousedown|touchstart|keydown)$/)){w.end(true)}}},onInteractionFinished:null,setStepComponent:function(e){if(L&&d&&e&&!d.stepComponent){d.stepComponent=e}},addBusyDuration:function(e){if(L&&d){if(!d.busyDuration){d.busyDuration=0}d.busyDuration+=e}}};return w});