/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/URI","sap/ui/Device","sap/ui/performance/E2ETrace/Passport","./Interaction","./XHRInterceptor","sap/base/Version"],function(e,t,n,r,i,s){"use strict";var o=false,u=n.getRootId(),a=n.createGUID().substr(-8,8)+u,c=window.location.host,f=t.os.name+"_"+t.os.version,p=t.browser.name+"_"+t.browser.version,d="",g="",R,S,P=0,v,A;function l(t){var n=new e(t).host();return n&&n!==c}function h(){i.register("PASSPORT_HEADER","open",function(){if(!l(arguments[1])){var e=r.getPending();if(e){if(g!=e.appVersion){g=e.appVersion;d=g?m(g):""}}this.setRequestHeader("SAP-PASSPORT",n.header(R,u,n.getTransactionId(),e?e.component+d:undefined,e?e.trigger+"_"+e.event+"_"+P:undefined))}});i.register("FESR","open",function(){if(!l(arguments[1])){if(!S){S=n.getTransactionId()}if(v){this.setRequestHeader("SAP-Perf-FESRec",v);this.setRequestHeader("SAP-Perf-FESRec-opt",A);v=null;A=null;S=n.getTransactionId();P++}}})}function E(e){return[T(u,32),T(S,32),T(e.navigation,16),T(e.roundtrip,16),T(e.duration,16),T(e.completeRoundtrips,8),T(a,40),T(e.networkTime,16),T(e.requestTime,16),T(f,20),"SAP_UI5"].join(",")}function I(e){var t=e.stepComponent||e.component;return[T(t,20,true),T(e.trigger+"_"+e.event,20,true),"",T(p,20),T(e.bytesSent,16),T(e.bytesReceived,16),"","",T(e.processing,16),e.requestCompression?"X":"","","","","",T(e.busyDuration,16),"","","","",T(t,70,true)].join(",")}function T(e,t,n){if(!e){e=e===0?"0":""}else if(typeof e==="number"){var r=e;e=Math.round(e).toString();if(e.length>t||r<0){e="-1"}}else{e=n?e.substr(-t,t):e.substr(0,t)}return e}function m(e){var t=new s(e);return"@"+t.getMajor()+"."+t.getMinor()+"."+t.getPatch()}function b(e){v=E(e);A=I(e)}var _={};_.setActive=function(e){if(e){o=true;n.setActive(true);r.setActive(true);R=n.traceFlags();h();r.onInteractionFinished=function(e){if(e.requests.length>0){b(e)}}}else if(!e&&o){o=false;r.setActive(false);i.unregister("FESR","open");if(i.isRegistered("PASSPORT_HEADER","open")){i.register("PASSPORT_HEADER","open",function(){this.setRequestHeader("SAP-PASSPORT",n.header(R,u,n.getTransactionId()))})}r.onInteractionFinished=null}};_.getActive=function(){return o};return _});