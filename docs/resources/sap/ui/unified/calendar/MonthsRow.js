/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Control","sap/ui/core/LocaleData","sap/ui/core/delegate/ItemNavigation","sap/ui/unified/calendar/CalendarUtils","sap/ui/unified/calendar/CalendarDate","sap/ui/unified/library","sap/ui/core/format/DateFormat","sap/ui/core/library","sap/ui/core/Locale","./MonthsRowRenderer"],function(e,t,a,i,s,r,o,n,l,h,g){"use strict";var c=l.CalendarType;var f=t.extend("sap.ui.unified.calendar.MonthsRow",{metadata:{library:"sap.ui.unified",properties:{date:{type:"object",group:"Data"},startDate:{type:"object",group:"Data"},months:{type:"int",group:"Appearance",defaultValue:12},intervalSelection:{type:"boolean",group:"Behavior",defaultValue:false},singleSelection:{type:"boolean",group:"Behavior",defaultValue:true},showHeader:{type:"boolean",group:"Appearance",defaultValue:false}},aggregations:{selectedDates:{type:"sap.ui.unified.DateRange",multiple:true,singularName:"selectedDate"},specialDates:{type:"sap.ui.unified.DateTypeRange",multiple:true,singularName:"specialDate"}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},legend:{type:"sap.ui.unified.CalendarLegend",multiple:false}},events:{select:{},focus:{parameters:{date:{type:"object"},notVisible:{type:"boolean"}}}}}});f.prototype.init=function(){this._oFormatYyyymm=n.getInstance({pattern:"yyyyMMdd",calendarType:c.Gregorian});this._oFormatLong=n.getInstance({pattern:"MMMM y"});this._mouseMoveProxy=e.proxy(this._handleMouseMove,this);this._rb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified")};f.prototype.exit=function(){if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();delete this._oItemNavigation}if(this._sInvalidateMonths){e.sap.clearDelayedCall(this._sInvalidateMonths)}};f.prototype.onAfterRendering=function(){u.call(this);L.call(this)};f.prototype.onsapfocusleave=function(t){if(!t.relatedControlId||!e.sap.containsOrEquals(this.getDomRef(),sap.ui.getCore().byId(t.relatedControlId).getFocusDomRef())){if(this._bMouseMove){N.call(this,true);C.call(this,this._getDate());this._bMoveChange=false;this._bMousedownChange=false;M.call(this)}if(this._bMousedownChange){this._bMousedownChange=false;M.call(this)}}};f.prototype.invalidate=function(a){if(!this._bDateRangeChanged&&(!a||!(a instanceof sap.ui.unified.DateRange))){t.prototype.invalidate.apply(this,arguments)}else if(this.getDomRef()&&!this._sInvalidateMonths){if(this._bInvalidateSync){w.call(this)}else{this._sInvalidateMonths=e.sap.delayedCall(0,this,w)}}};f.prototype.removeAllSelectedDates=function(){this._bDateRangeChanged=true;var e=this.removeAllAggregation("selectedDates");return e};f.prototype.destroySelectedDates=function(){this._bDateRangeChanged=true;var e=this.destroyAggregation("selectedDates");return e};f.prototype.removeAllSpecialDates=function(){this._bDateRangeChanged=true;var e=this.removeAllAggregation("specialDates");return e};f.prototype.destroySpecialDates=function(){this._bDateRangeChanged=true;var e=this.destroyAggregation("specialDates");return e};f.prototype.setDate=function(e){D.call(this,r.fromLocalJSDate(e),false);return this};f.prototype._setDate=function(e){var t=e.toLocalJSDate();this.setProperty("date",t,true);this._oDate=e};f.prototype._getDate=function(){if(!this._oDate){this._oDate=new r}return this._oDate};f.prototype.setStartDate=function(e){s._checkJSDateObject(e);var t,a,i;a=e.getFullYear();s._checkYearInValidRange(a);t=r.fromLocalJSDate(e);this.setProperty("startDate",e,true);this._oStartDate=t;this._oStartDate.setDate(1);if(this.getDomRef()){i=this._getDate().toLocalJSDate();this._bNoRangeCheck=true;this.displayDate(e);this._bNoRangeCheck=false;if(i&&this.checkDateFocusable(i)){this.setDate(i)}}return this};f.prototype._getStartDate=function(){if(!this._oStartDate){this._oStartDate=new r;this._oStartDate.setDate(1)}return this._oStartDate};f.prototype.displayDate=function(e){D.call(this,r.fromLocalJSDate(e),true);return this};f.prototype._getLocale=function(){var e=this.getParent();if(e&&e.getLocale){return e.getLocale()}else if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString()}return this._sLocale};f.prototype._getLocaleData=function(){var e=this.getParent();if(e&&e._getLocaleData){return e._getLocaleData()}else if(!this._oLocaleData){var t=this._getLocale();var i=new h(t);this._oLocaleData=a.getInstance(i)}return this._oLocaleData};f.prototype._getFormatLong=function(){var e=this._getLocale();if(this._oFormatLong.oLocale.toString()!=e){var t=new h(e);this._oFormatLong=n.getInstance({style:"long"},t)}return this._oFormatLong};f.prototype.getIntervalSelection=function(){var e=this.getParent();if(e&&e.getIntervalSelection){return e.getIntervalSelection()}else{return this.getProperty("intervalSelection")}};f.prototype.getSingleSelection=function(){var e=this.getParent();if(e&&e.getSingleSelection){return e.getSingleSelection()}else{return this.getProperty("singleSelection")}};f.prototype.getSelectedDates=function(){var e=this.getParent();if(e&&e.getSelectedDates){return e.getSelectedDates()}else{return this.getAggregation("selectedDates",[])}};f.prototype.getSpecialDates=function(){var e=this.getParent();if(e&&e.getSpecialDates){return e.getSpecialDates()}else{return this.getAggregation("specialDates",[])}};f.prototype._getShowHeader=function(){var e=this.getParent();if(e&&e._getShowItemHeader){return e._getShowItemHeader()}else{return this.getProperty("showHeader")}};f.prototype.getAriaLabelledBy=function(){var e=this.getParent();if(e&&e.getAriaLabelledBy){return e.getAriaLabelledBy()}else{return this.getAssociation("ariaLabelledBy",[])}};f.prototype.getLegend=function(){var e=this.getParent();if(e&&e.getLegend){return e.getLegend()}else{return this.getAssociation("ariaLabelledBy",[])}};f.prototype._checkDateSelected=function(e){var t,a,i,o,n=0,l=0,h=0,g,c,f;s._checkCalendarDate(e);c=this.getSelectedDates();f=new r(e);f.setDate(1);o=f.toUTCJSDate().getTime();for(g=0;g<c.length;g++){t=c[g];a=t.getStartDate();n=0;if(a){a=r.fromLocalJSDate(a);a.setDate(1);n=a.toUTCJSDate().getTime()}i=t.getEndDate();l=0;if(i){i=r.fromLocalJSDate(i);i.setDate(1);l=i.toUTCJSDate().getTime()}if(o==n&&!i){h=1;break}else if(o==n&&i){h=2;if(i&&o==l){h=5}break}else if(i&&o==l){h=3;break}else if(i&&o>n&&o<l){h=4;break}if(this.getSingleSelection()){break}}return h};f.prototype._getDateType=function(e){s._checkCalendarDate(e);var t,a,i,o,n=0,l,h=0,g,c=this.getSpecialDates(),f=new r(e);f.setDate(1);g=f.toUTCJSDate().getTime();for(i=0;i<c.length;i++){a=c[i];o=a.getStartDate();n=0;if(o){o=r.fromLocalJSDate(o);o.setDate(1);n=o.toUTCJSDate().getTime()}l=a.getEndDate();h=0;if(l){l=r.fromLocalJSDate(l);l.setDate(s._daysInMonth(l));h=l.toUTCJSDate().getTime()}if(g==n&&!l||g>=n&&g<=h){t={type:a.getType(),tooltip:a.getTooltip_AsString()};break}}return t};f.prototype._checkMonthEnabled=function(e){s._checkCalendarDate(e);var t=this.getParent();if(t&&t._oMinDate&&t._oMaxDate){if(s._isOutside(e,t._oMinDate,t._oMaxDate)){return false}}return true};f.prototype._handleMouseMove=function(t){if(!this.$().is(":visible")){N.call(this,true)}var a=e(t.target);if(a.hasClass("sapUiCalItemText")){a=a.parent()}if(a.hasClass("sapUiCalItem")){var i=this._getDate();var s=r.fromLocalJSDate(this._oFormatYyyymm.parse(a.attr("data-sap-month")));s.setDate(1);if(!s.isSame(i)){this._setDate(s);C.call(this,s,true);this._bMoveChange=true}}};f.prototype.onmouseup=function(t){if(this._bMouseMove){N.call(this,true);var a=this._getDate();var i=this._oItemNavigation.getItemDomRefs();for(var s=0;s<i.length;s++){var o=e(i[s]);if(o.attr("data-sap-month")==this._oFormatYyyymm.format(a.toUTCJSDate(),true)){o.focus();break}}if(this._bMoveChange){var n=e(t.target);if(n.hasClass("sapUiCalItemText")){n=n.parent()}if(n.hasClass("sapUiCalItem")){a=r.fromLocalJSDate(this._oFormatYyyymm.parse(n.attr("data-sap-month")));a.setDate(1)}C.call(this,a);this._bMoveChange=false;this._bMousedownChange=false;M.call(this)}}if(this._bMousedownChange){this._bMousedownChange=false;M.call(this)}};f.prototype.onsapselect=function(e){var t=C.call(this,this._getDate());if(t){M.call(this)}e.stopPropagation();e.preventDefault()};f.prototype.onsapselectmodifiers=function(e){this.onsapselect(e)};f.prototype.onsappageupmodifiers=function(e){var t=new r(this._getDate());var a=t.getYear();if(e.metaKey||e.ctrlKey){t.setYear(a-10)}else{var i=this.getMonths();if(i<=12){t.setYear(a-1)}else{t.setMonth(t.getMonth()-i)}}this.fireFocus({date:t.toLocalJSDate(),notVisible:true});e.preventDefault()};f.prototype.onsappagedownmodifiers=function(e){var t=new r(this._getDate());var a=t.getYear();if(e.metaKey||e.ctrlKey){t.setYear(a+10)}else{var i=this.getMonths();if(i<=12){t.setYear(a+1)}else{t.setMonth(t.getMonth()+i)}}this.fireFocus({date:t.toLocalJSDate(),notVisible:true});e.preventDefault()};f.prototype.onThemeChanged=function(){if(this._bNoThemeChange){return}this._bNamesLengthChecked=undefined;this._bLongWeekDays=undefined;var t=this._getLocaleData();var a=t.getMonthsStandAlone("wide");var i=this.$("months").children();var s=this._getStartDate().getMonth();for(var r=0;r<i.length;r++){var o=e(e(i[r]).children(".sapUiCalItemText"));o.text(a[(r+s)%12])}L.call(this)};f.prototype.checkDateFocusable=function(e){s._checkJSDateObject(e);if(this._bNoRangeCheck){return false}var t=this._getStartDate();var a=new r(t);a.setDate(1);a.setMonth(a.getMonth()+this.getMonths());var i=r.fromLocalJSDate(e);return i.isSameOrAfter(t)&&i.isBefore(a)};f.prototype.applyFocusInfo=function(e){this._oItemNavigation.focusItem(this._oItemNavigation.getFocusedIndex());return this};function u(){var t=this._getDate();var a=this._oFormatYyyymm.format(t.toUTCJSDate(),true);var s=0;var r=this.$("months").get(0);var o=this.$("months").children(".sapUiCalItem");for(var n=0;n<o.length;n++){var l=e(o[n]);if(l.attr("data-sap-month")===a){s=n;break}}if(!this._oItemNavigation){this._oItemNavigation=new i;this._oItemNavigation.attachEvent(i.Events.AfterFocus,p,this);this._oItemNavigation.attachEvent(i.Events.FocusAgain,d,this);this._oItemNavigation.attachEvent(i.Events.BorderReached,m,this);this.addDelegate(this._oItemNavigation);this._oItemNavigation.setDisabledModifiers({sapnext:["alt"],sapprevious:["alt"],saphome:["alt"],sapend:["alt"]});this._oItemNavigation.setCycling(false);this._oItemNavigation.setColumns(1,true)}this._oItemNavigation.setRootDomRef(r);this._oItemNavigation.setItemDomRefs(o);this._oItemNavigation.setFocusedIndex(s);this._oItemNavigation.setPageSize(o.length)}function p(t){var a=t.getParameter("index");var i=t.getParameter("event");if(!i){return}var s=this._getDate();var o=new r(s);var n=this._oItemNavigation.getItemDomRefs();var l=e(n[a]);o=r.fromLocalJSDate(this._oFormatYyyymm.parse(l.attr("data-sap-month")));o.setDate(1);this._setDate(o);this.fireFocus({date:o.toLocalJSDate(),notVisible:false});if(i.type=="mousedown"){v.call(this,i,o,a)}}function d(e){var t=e.getParameter("index");var a=e.getParameter("event");if(!a){return}if(a.type=="mousedown"){var i=this._getDate();v.call(this,a,i,t)}}function m(e){var t=e.getParameter("event");var a=this.getMonths();var i=this._getDate();var s=new r(i);if(t.type){switch(t.type){case"sapnext":case"sapnextmodifiers":s.setMonth(s.getMonth()+1);break;case"sapprevious":case"sappreviousmodifiers":s.setMonth(s.getMonth()-1);break;case"sappagedown":s.setMonth(s.getMonth()+a);break;case"sappageup":s.setMonth(s.getMonth()-a);break;default:break}this.fireFocus({date:s.toLocalJSDate(),notVisible:true})}}function v(e,t,a){if(e.button){return}var i=C.call(this,t);if(i){this._bMousedownChange=true}if(this._bMouseMove){N.call(this,true);this._bMoveChange=false}else if(i&&this.getIntervalSelection()&&this.$().is(":visible")){U.call(this,true)}e.preventDefault();e.setMark("cancelAutoClose")}function D(e,t){s._checkCalendarDate(e);var a=e.getYear();s._checkYearInValidRange(a);var i=true;if(!this.getDate()||!e.isSame(r.fromLocalJSDate(this.getDate()))){var o=new r(e);o.setDate(1);i=this.checkDateFocusable(e.toLocalJSDate());if(!this._bNoRangeCheck&&!i){throw new Error("Date must be in visible date range; "+this)}this.setProperty("date",e.toLocalJSDate(),true);this._oDate=o}if(this.getDomRef()){if(i){_.call(this,this._oDate,t)}else{S.call(this,t)}}}function _(t,a){var i=this._oFormatYyyymm.format(t.toUTCJSDate(),true);var s=this._oItemNavigation.getItemDomRefs();var r;for(var o=0;o<s.length;o++){r=e(s[o]);if(r.attr("data-sap-month")==i){if(document.activeElement!=s[o]){if(a){this._oItemNavigation.setFocusedIndex(o)}else{this._oItemNavigation.focusItem(o)}}break}}}function S(e){var t=this._getStartDate();var a=this.$("months");if(a.length>0){var i=sap.ui.getCore().createRenderManager();this.getRenderer().renderMonths(i,this,t);i.flush(a[0]);i.destroy()}y.call(this);u.call(this);if(!e){this._oItemNavigation.focusItem(this._oItemNavigation.getFocusedIndex())}}function y(){var e=this._getStartDate();if(this._getShowHeader()){var t=this.$("Head");if(t.length>0){var a=this._getLocaleData();var i=sap.ui.getCore().createRenderManager();this.getRenderer().renderHeaderLine(i,this,a,e);i.flush(t[0]);i.destroy()}}}function C(t,a){if(!this._checkMonthEnabled(t)){return false}var i=this.getSelectedDates();var s;var o=this._oItemNavigation.getItemDomRefs();var n;var l;var h=0;var g=this.getParent();var c=this;var f;if(g&&g.getSelectedDates){c=g}if(this.getSingleSelection()){if(i.length>0){s=i[0];f=s.getStartDate();if(f){f=r.fromLocalJSDate(f);f.setDate(1)}}else{s=new sap.ui.unified.DateRange;c.addAggregation("selectedDates",s,true)}if(this.getIntervalSelection()&&(!s.getEndDate()||a)&&f){var u;if(t.isBefore(f)){u=f;f=t;if(!a){s.setProperty("startDate",f.toLocalJSDate(),true);s.setProperty("endDate",u.toLocalJSDate(),true)}}else if(t.isSameOrAfter(f)){u=t;if(!a){s.setProperty("endDate",u.toLocalJSDate(),true)}}I.call(this,f,u)}else{I.call(this,t);s.setProperty("startDate",t.toLocalJSDate(),true);s.setProperty("endDate",undefined,true)}}else{if(this.getIntervalSelection()){throw new Error("Calender don't support multiple interval selection")}else{var p=this._checkDateSelected(t);if(p>0){for(h=0;h<i.length;h++){f=i[h].getStartDate();if(f){f=r.fromLocalJSDate(f);f.setDate(1);if(t.isSame(f)){c.removeAggregation("selectedDates",h,true);break}}}}else{s=new sap.ui.unified.DateRange({startDate:t.toLocalJSDate()});c.addAggregation("selectedDates",s,true)}l=this._oFormatYyyymm.format(t.toUTCJSDate(),true);for(h=0;h<o.length;h++){n=e(o[h]);if(n.attr("data-sap-month")==l){if(p>0){n.removeClass("sapUiCalItemSel");n.attr("aria-selected","false")}else{n.addClass("sapUiCalItemSel");n.attr("aria-selected","true")}}}}}return true}function I(t,a){var i=this._oItemNavigation.getItemDomRefs();var o;var n=0;var l=false;var h=false;if(!a){var g=this._oFormatYyyymm.format(t.toUTCJSDate(),true);for(n=0;n<i.length;n++){o=e(i[n]);l=false;h=false;if(o.attr("data-sap-month")==g){o.addClass("sapUiCalItemSel");o.attr("aria-selected","true");l=true}else if(o.hasClass("sapUiCalItemSel")){o.removeClass("sapUiCalItemSel");o.attr("aria-selected","false")}if(o.hasClass("sapUiCalItemSelStart")){o.removeClass("sapUiCalItemSelStart")}else if(o.hasClass("sapUiCalItemSelBetween")){o.removeClass("sapUiCalItemSelBetween")}else if(o.hasClass("sapUiCalItemSelEnd")){o.removeClass("sapUiCalItemSelEnd")}b.call(this,o,l,h)}}else{var c;for(n=0;n<i.length;n++){o=e(i[n]);l=false;h=false;c=r.fromLocalJSDate(this._oFormatYyyymm.parse(o.attr("data-sap-month")));c.setDate(1);if(c.isSame(t)){o.addClass("sapUiCalItemSelStart");l=true;o.addClass("sapUiCalItemSel");o.attr("aria-selected","true");if(a&&c.isSame(a)){o.addClass("sapUiCalItemSelEnd");h=true}o.removeClass("sapUiCalItemSelBetween")}else if(a&&s._isBetween(c,t,a)){o.addClass("sapUiCalItemSel");o.attr("aria-selected","true");o.addClass("sapUiCalItemSelBetween");o.removeClass("sapUiCalItemSelStart");o.removeClass("sapUiCalItemSelEnd")}else if(a&&c.isSame(a)){o.addClass("sapUiCalItemSelEnd");h=true;o.addClass("sapUiCalItemSel");o.attr("aria-selected","true");o.removeClass("sapUiCalItemSelStart");o.removeClass("sapUiCalItemSelBetween")}else{if(o.hasClass("sapUiCalItemSel")){o.removeClass("sapUiCalItemSel");o.attr("aria-selected","false")}if(o.hasClass("sapUiCalItemSelStart")){o.removeClass("sapUiCalItemSelStart")}else if(o.hasClass("sapUiCalItemSelBetween")){o.removeClass("sapUiCalItemSelBetween")}else if(o.hasClass("sapUiCalItemSelEnd")){o.removeClass("sapUiCalItemSelEnd")}}b.call(this,o,l,h)}}}function b(e,t,a){if(!this.getIntervalSelection()){return}var i="";var s=[];var r=this.getId();var o=false;i=e.attr("aria-describedby");if(i){s=i.split(" ")}var n=-1;var l=-1;for(var h=0;h<s.length;h++){var g=s[h];if(g==r+"-Start"){n=h}if(g==r+"-End"){l=h}}if(n>=0&&!t){s.splice(n,1);o=true;if(l>n){l--}}if(l>=0&&!a){s.splice(l,1);o=true}if(n<0&&t){s.push(r+"-Start");o=true}if(l<0&&a){s.push(r+"-End");o=true}if(o){i=s.join(" ");e.attr("aria-describedby",i)}}function M(){if(this._bMouseMove){N.call(this,true)}this.fireSelect()}function L(){if(!this._bNamesLengthChecked){var t=0;var a=this.$("months").children();var i=false;var s=this.getMonths();var r=Math.ceil(12/s);var o=0;var n=this._getLocaleData();var l=n.getMonthsStandAlone("wide");var h;for(var g=0;g<r;g++){if(s<12){for(t=0;t<a.length;t++){h=e(e(a[t]).children(".sapUiCalItemText"));h.text(l[(t+o)%12])}o=o+s;if(o>11){o=11}}for(t=0;t<a.length;t++){var c=a[t];if(Math.abs(c.clientWidth-c.scrollWidth)>1){i=true;break}}if(i){break}}if(s<12){o=this._getStartDate().getMonth();for(t=0;t<a.length;t++){h=e(e(a[t]).children(".sapUiCalItemText"));h.text(l[(t+o)%12])}}if(i){this._bLongMonth=false;var f=n.getMonthsStandAlone("abbreviated");o=this._getStartDate().getMonth();for(t=0;t<a.length;t++){h=e(e(a[t]).children(".sapUiCalItemText"));h.text(f[(t+o)%12])}}else{this._bLongMonth=true}this._bNamesLengthChecked=true}}function w(){this._sInvalidateMonths=undefined;S.call(this,this._bNoFocus);this._bDateRangeChanged=undefined;this._bNoFocus=undefined}function U(){e(window.document).bind("mousemove",this._mouseMoveProxy);this._bMouseMove=true}function N(){e(window.document).unbind("mousemove",this._mouseMoveProxy);this._bMouseMove=undefined}return f});