/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Control","sap/ui/Device","sap/ui/core/delegate/ItemNavigation","sap/ui/unified/calendar/CalendarUtils","sap/ui/unified/calendar/CalendarDate","sap/ui/core/date/UniversalDate","sap/ui/unified/library","sap/ui/core/format/DateFormat","sap/ui/core/library","./YearPickerRenderer","jquery.sap.keycodes"],function(e,t,a,i,r,s,o,n,h,l,p){"use strict";var u=l.CalendarType;var d=t.extend("sap.ui.unified.calendar.YearPicker",{metadata:{library:"sap.ui.unified",properties:{year:{type:"int",group:"Data",defaultValue:2e3},years:{type:"int",group:"Appearance",defaultValue:20},columns:{type:"int",group:"Appearance",defaultValue:4},date:{type:"object",group:"Data"},primaryCalendarType:{type:"sap.ui.core.CalendarType",group:"Appearance"}},events:{select:{},pageChange:{}}}});d.prototype.init=function(){var e=sap.ui.getCore().getConfiguration().getCalendarType();this.setProperty("primaryCalendarType",e);this._oYearFormat=h.getDateInstance({format:"y",calendarType:e});this._oFormatYyyymmdd=h.getInstance({pattern:"yyyyMMdd",calendarType:u.Gregorian});this._oMinDate=r._minDate(this.getPrimaryCalendarType());this._oMaxDate=r._maxDate(this.getPrimaryCalendarType())};d.prototype.onAfterRendering=function(){g.call(this)};d.prototype.setYear=function(e){this.setProperty("year",e,true);e=this.getProperty("year");var t=s.fromLocalJSDate(new Date,this.getPrimaryCalendarType());t.setDate(1);t.setMonth(0);t.setYear(e);this.setDate(t.toLocalJSDate());return this};d.prototype.setDate=function(e){var t,a,i,o;e&&r._checkJSDateObject(e);a=e.getFullYear();r._checkYearInValidRange(a);t=s.fromLocalJSDate(e,this.getPrimaryCalendarType());t.setMonth(0);t.setDate(1);this.setProperty("date",e,true);this.setProperty("year",t.getYear(),true);this._oDate=t;if(this.getDomRef()){i=this.getYears();o=new s(this._oDate,this.getPrimaryCalendarType());o.setYear(o.getYear()-Math.floor(i/2));D.call(this,o,Math.floor(i/2))}return this};d.prototype._getDate=function(){if(!this._oDate){var e=this.getYear();this._oDate=new s(e,0,1,this.getPrimaryCalendarType())}return this._oDate};d.prototype.setPrimaryCalendarType=function(e){this.setProperty("primaryCalendarType",e);this._oYearFormat=h.getDateInstance({format:"y",calendarType:e});if(this._oDate){this._oDate=new s(this._oDate,e);this._oDate.setMonth(0);this._oDate.setDate(1)}this._oMinDate=new s(this._oMinDate,e);this._oMaxDate=new s(this._oMaxDate,e);return this};d.prototype.nextPage=function(){_.call(this,true,this._oItemNavigation.getFocusedIndex());return this};d.prototype.previousPage=function(){_.call(this,false,this._oItemNavigation.getFocusedIndex());return this};d.prototype.onsapspace=function(e){e.preventDefault()};d.prototype.onsapselect=function(e){var t=this._oItemNavigation.getFocusedIndex();var a=v.call(this,t);if(a){this.fireSelect()}};d.prototype.onmousedown=function(e){this._oMousedownPosition={clientX:e.clientX,clientY:e.clientY}};d.prototype.onmouseup=function(e){if(this._bMousedownChange){this._bMousedownChange=false;this.fireSelect()}else if(a.support.touch&&this._isValueInThreshold(this._oMousedownPosition.clientX,e.clientX,10)&&this._isValueInThreshold(this._oMousedownPosition.clientY,e.clientY,10)){var t=this._oItemNavigation.getFocusedIndex();v.call(this,t);this.fireSelect()}};d.prototype.getFirstRenderedDate=function(){var t;if(this.getDomRef()){var a=this._oItemNavigation.getItemDomRefs();t=this._oFormatYyyymmdd.parse(e(a[0]).attr("data-sap-year-start"),true)}return t};d.prototype._isValueInThreshold=function(e,t,a){var i=e-a,r=e+a;return t>=i&&t<=r};d.prototype._checkFirstDate=function(e){var t=this.getYears();var a=new s(this._oMaxDate,this.getPrimaryCalendarType());a.setYear(a.getYear()-t+1);if(e.isAfter(a)&&e.getYear()!=a.getYear()){e=new s(a,this.getPrimaryCalendarType());e.setMonth(0);e.setDate(1)}else if(e.isBefore(this._oMinDate)&&e.getYear()!=this._oMinDate.getYear()){e=new s(this._oMinDate,this.getPrimaryCalendarType());e.setMonth(0);e.setDate(1)}return e};d.prototype._checkDateEnabled=function(e){var t=true;if(e.isAfter(this._oMaxDate)&&e.getYear()!=this._oMaxDate.getYear()||e.isBefore(this._oMinDate)&&e.getYear()!=this._oMinDate.getYear()){t=false}return t};function g(){var e=this.getYears();var t=this._getDate().getYear();var a=this._oMinDate.getYear();var r=this._oMaxDate.getYear();var s=this.getDomRef();var o=this.$().find(".sapUiCalItem");var n=Math.floor(e/2);if(t>r-Math.floor(e/2)){n=n+t-r+Math.floor(e/2)}else if(t<=a+Math.floor(e/2)){n=t-a}if(!this._oItemNavigation){this._oItemNavigation=new i;this._oItemNavigation.attachEvent(i.Events.AfterFocus,f,this);this._oItemNavigation.attachEvent(i.Events.FocusAgain,c,this);this._oItemNavigation.attachEvent(i.Events.BorderReached,y,this);this.addDelegate(this._oItemNavigation);this._oItemNavigation.setHomeEndColumnMode(true,true);this._oItemNavigation.setDisabledModifiers({sapnext:["alt"],sapprevious:["alt"],saphome:["alt"],sapend:["alt"]})}this._oItemNavigation.setRootDomRef(s);this._oItemNavigation.setItemDomRefs(o);this._oItemNavigation.setCycling(false);this._oItemNavigation.setColumns(this.getColumns(),true);this._oItemNavigation.setFocusedIndex(n);this._oItemNavigation.setPageSize(o.length)}function f(e){var t=e.getParameter("index");var a=e.getParameter("event");if(!a){return}if(a.type=="mousedown"){m.call(this,a,t)}}function c(e){var t=e.getParameter("index");var a=e.getParameter("event");if(!a){return}if(a.type=="mousedown"){m.call(this,a,t)}}function m(e,t){if(e.button||a.support.touch){return}var i=v.call(this,t);if(i){this._bMousedownChange=true}e.preventDefault();e.setMark("cancelAutoClose")}function y(t){var a=t.getParameter("event");if(a.type){var i=this.getYears();var r=this.getColumns();if(r==0){r=i}switch(a.type){case"sapnext":case"sapnextmodifiers":if(a.keyCode==e.sap.KeyCodes.ARROW_DOWN&&r<i){_.call(this,true,this._oItemNavigation.getFocusedIndex()-i+r,true)}else{_.call(this,true,0,true)}break;case"sapprevious":case"sappreviousmodifiers":if(a.keyCode==e.sap.KeyCodes.ARROW_UP&&r<i){_.call(this,false,i-r+this._oItemNavigation.getFocusedIndex(),true)}else{_.call(this,false,i-1,true)}break;case"sappagedown":_.call(this,true,this._oItemNavigation.getFocusedIndex(),true);break;case"sappageup":_.call(this,false,this._oItemNavigation.getFocusedIndex(),true);break;default:break}}}function v(t){var a=this._oItemNavigation.getItemDomRefs();var i=e(a[t]);if(i.hasClass("sapUiCalItemDsbl")){return false}var r=i.attr("data-sap-year-start");var o=s.fromLocalJSDate(this._oFormatYyyymmdd.parse(r));var n=this.getId()+"-y"+r;for(var h=0;h<a.length;h++){i=e(a[h]);if(i.attr("id")==n){i.addClass("sapUiCalItemSel");i.attr("aria-selected","true")}else{i.removeClass("sapUiCalItemSel");i.attr("aria-selected","false")}}this.setProperty("date",o.toLocalJSDate(),true);this.setProperty("year",o.getYear(),true);return true}function _(t,a,i){var r=this._oItemNavigation.getItemDomRefs();var o=s.fromLocalJSDate(this._oFormatYyyymmdd.parse(e(r[0]).attr("data-sap-year-start")),this.getPrimaryCalendarType());var n=this.getYears();if(t){var h=new s(this._oMaxDate,this.getPrimaryCalendarType());h.setYear(h.getYear()-n+1);if(o.isBefore(h)){o.setYear(o.getYear()+n);if(o.isAfter(h)){a=a+(o.getYear()-h.getYear());if(a>n-1){a=n-1}o=this._oMaxDate;o.setMonth(0);o.setDate(1)}}else{return}}else{if(o.isAfter(this._oMinDate)){o.setYear(o.getYear()-n);if(o.isBefore(this._oMinDate)){a=a-(this._oMinDate.getYear()-o.getYear());if(a<0){a=0}o=new s(this._oMinDate,this.getPrimaryCalendarType())}}else{return}}D.call(this,o,a);if(i){this.firePageChange()}}function D(t,a){var i=this._oFormatYyyymmdd.format(this._getDate().toUTCJSDate(),true);var r=false;var n=this._checkFirstDate(t);var h;if(!n.isSame(t)){h=new s(t,this.getPrimaryCalendarType());h.setYear(h.getYear()+a);t=n;r=true}var l=this._oItemNavigation.getItemDomRefs();var p=new s(t,this.getPrimaryCalendarType());for(var u=0;u<l.length;u++){var d=this._oFormatYyyymmdd.format(p.toUTCJSDate(),true);var g=e(l[u]);g.attr("id",this.getId()+"-y"+d);g.text(this._oYearFormat.format(o.getInstance(p.toUTCJSDate(),p.getCalendarType()),true));g.attr("data-sap-year-start",d);if(g.hasClass("sapUiCalItemSel")&&d!=i){g.removeClass("sapUiCalItemSel");g.attr("aria-selected","false")}else if(!g.hasClass("sapUiCalItemSel")&&d==i){g.addClass("sapUiCalItemSel");g.attr("aria-selected","true")}var f=true;if(r){f=this._checkDateEnabled(p);if(p.isSame(h)){a=u}}if(f){g.removeClass("sapUiCalItemDsbl");g.removeAttr("aria-disabled")}else{g.addClass("sapUiCalItemDsbl");g.attr("aria-disabled",true)}p.setYear(p.getYear()+1)}this._oItemNavigation.focusItem(a)}return d});