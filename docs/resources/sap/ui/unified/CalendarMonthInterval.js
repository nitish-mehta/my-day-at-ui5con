/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/Device","sap/ui/core/Control","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/core/Renderer","sap/ui/core/format/DateFormat","./calendar/CalendarUtils","./calendar/Header","./calendar/MonthsRow","./calendar/YearPicker","./calendar/CalendarDate","./Calendar","./CalendarRenderer","./CalendarMonthIntervalRenderer"],function(t,e,a,i,s,o,r,n,h,g,c,l,u,p,d){"use strict";var f=a.extend("sap.ui.unified.CalendarMonthInterval",{metadata:{library:"sap.ui.unified",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},startDate:{type:"object",group:"Data"},intervalSelection:{type:"boolean",group:"Behavior",defaultValue:false},singleSelection:{type:"boolean",group:"Behavior",defaultValue:true},months:{type:"int",group:"Appearance",defaultValue:12},pickerPopup:{type:"boolean",group:"Appearance",defaultValue:false},minDate:{type:"object",group:"Misc",defaultValue:null},maxDate:{type:"object",group:"Misc",defaultValue:null}},aggregations:{selectedDates:{type:"sap.ui.unified.DateRange",multiple:true,singularName:"selectedDate"},specialDates:{type:"sap.ui.unified.DateTypeRange",multiple:true,singularName:"specialDate"},header:{type:"sap.ui.unified.calendar.Header",multiple:false,visibility:"hidden"},monthsRow:{type:"sap.ui.unified.calendar.MonthsRow",multiple:false,visibility:"hidden"},yearPicker:{type:"sap.ui.unified.calendar.YearPicker",multiple:false,visibility:"hidden"},calendarPicker:{type:"sap.ui.unified.Calendar",multiple:false,visibility:"hidden"}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},legend:{type:"sap.ui.unified.CalendarLegend",multiple:false}},events:{select:{},cancel:{},startDateChange:{}}}});f.prototype.init=function(){this._iMode=0;this.data("sap-ui-fastnavgroup","true",true);this._oYearFormat=r.getDateInstance({format:"y"});this._oMinDate=n._minDate();this._oMaxDate=n._maxDate();this._initializeHeader();this._initializeMonthsRow();this._initilizeYearPicker();this._iDaysMonthsHead=15};f.prototype.exit=function(){if(this._sInvalidateContent){t.sap.clearDelayedCall(this._sInvalidateContent)}};f.prototype.onBeforeRendering=function(){var t=this.getAggregation("monthsRow");var e=this._getFocusedDate();P.call(this);t.displayDate(e.toLocalJSDate())};f.prototype._initializeHeader=function(){var t=new h(this.getId()+"--Head",{visibleButton0:false,visibleButton1:false,visibleButton2:true});t.attachEvent("pressPrevious",this._handlePrevious,this);t.attachEvent("pressNext",this._handleNext,this);t.attachEvent("pressButton2",A,this);this.setAggregation("header",t)};f.prototype._initializeMonthsRow=function(){var t=new g(this.getId()+"--MonthsRow");t.attachEvent("focus",C,this);t.attachEvent("select",R,this);t._bNoThemeChange=true;this.setAggregation("monthsRow",t)};f.prototype._initilizeYearPicker=function(){this.setAggregation("yearPicker",this._createYearPicker())};f.prototype._createYearPicker=function(){var t=new c(this.getId()+"--YP",{columns:0,years:6});t.attachEvent("select",L,this);t.attachEvent("pageChange",E,this);t._oMinDate.setYear(this._oMinDate.getYear());t._oMaxDate.setYear(this._oMaxDate.getYear());return t};f.prototype._getCalendarPicker=function(){var e=this.getAggregation("calendarPicker");if(!e){e=new O(this.getId()+"--Cal");e.setPopupMode(true);e.attachEvent("select",F,this);e.attachEvent("cancel",function(e){this._oPopup.close();t.sap.focus(this.getAggregation("header").getDomRef("B2"))},this);this.setAggregation("calendarPicker",e)}return e};f.prototype.setStartDate=function(e){n._checkJSDateObject(e);if(t.sap.equal(this.getStartDate(),e)){return this}var a=e.getFullYear();n._checkYearInValidRange(a);this.setProperty("startDate",e,true);this._oStartDate=l.fromLocalJSDate(e);this._oStartDate.setDate(1);var i=this.getAggregation("monthsRow");i.setStartDate(e);P.call(this);var s=this._getFocusedDate().toLocalJSDate();if(!i.checkDateFocusable(s)){this._setFocusedDate(this._oStartDate);i.displayDate(e)}return this};f.prototype.invalidate=function(e){if(!this._bDateRangeChanged&&(!e||!(e instanceof sap.ui.unified.DateRange))){a.prototype.invalidate.apply(this,arguments)}else if(this.getDomRef()&&this._iMode==0&&!this._sInvalidateContent){this._sInvalidateContent=t.sap.delayedCall(0,this,Y)}};f.prototype.removeAllSelectedDates=function(){this._bDateRangeChanged=true;var t=this.removeAllAggregation("selectedDates");return t};f.prototype.destroySelectedDates=function(){this._bDateRangeChanged=true;var t=this.destroyAggregation("selectedDates");return t};f.prototype.removeAllSpecialDates=function(){this._bDateRangeChanged=true;var t=this.removeAllAggregation("specialDates");return t};f.prototype.destroySpecialDates=function(){this._bDateRangeChanged=true;var t=this.destroyAggregation("specialDates");return t};f.prototype.setLocale=function(t){if(this._sLocale!=t){this._sLocale=t;this._oLocaleData=undefined;this.invalidate()}return this};f.prototype.getLocale=function(){if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString()}return this._sLocale};f.prototype._getFocusedDate=function(){if(!this._oFocusedDate){m.call(this)}return this._oFocusedDate};f.prototype._setFocusedDate=function(t){n._checkCalendarDate(t);this._oFocusedDate=new l(t)};f.prototype.focusDate=function(t){var e=false;var a=this.getAggregation("monthsRow");if(t&&!a.checkDateFocusable(t)){N.call(this,l.fromLocalJSDate(t));e=true}b.call(this,t,false);if(e){this.fireStartDateChange()}return this};f.prototype.displayDate=function(t){b.call(this,t,true);return this};f.prototype.setMonths=function(t){this.setProperty("months",t,true);t=this._getMonths();var e=this.getAggregation("monthsRow");e.setMonths(t);if(!e.checkDateFocusable(this._getFocusedDate().toLocalJSDate())){var a=_.call(this);this._setFocusedDate(this._oStartDate);e.setDate(a.toLocalJSDate())}if(!this.getPickerPopup()){var i=this.getAggregation("yearPicker");var s=Math.floor(t/2);if(s>20){s=20}i.setYears(s)}P.call(this);if(this.getDomRef()){if(this._getShowItemHeader()){this.$().addClass("sapUiCalIntHead")}else{this.$().removeClass("sapUiCalIntHead")}}return this};f.prototype._getMonths=function(){var t=this.getMonths();if(e.system.phone&&t>6){return 6}else{return t}};f.prototype._getLocaleData=function(){if(!this._oLocaleData){var t=this.getLocale();var e=new i(t);this._oLocaleData=s.getInstance(e)}return this._oLocaleData};f.prototype.setPickerPopup=function(t){var e;this.setProperty("pickerPopup",t,true);if(t){if(this.getAggregation("yearPicker")){this.getAggregation("yearPicker").destroy()}}else{if(!this.getAggregation("yearPicker")){this.setAggregation("yearPicker",this._createYearPicker())}e=this.getAggregation("yearPicker");e.setColumns(0);e.setYears(6)}return this};f.prototype.setMinDate=function(e){if(t.sap.equal(e,this.getMinDate())){return this}if(!e){this._oMinDate=n._minDate()}else{n._checkJSDateObject(e);this._oMinDate=l.fromLocalJSDate(e);this._oMinDate.setDate(1);var a=this._oMinDate.getYear();n._checkYearInValidRange(a);if(this._oMaxDate.isBefore(this._oMinDate)){t.sap.log.warning("minDate > maxDate -> maxDate set to end of the month",this);this._oMaxDate=l.fromLocalJSDate(e);this._oMaxDate.setDate(n._daysInMonth(this._oMaxDate));this.setProperty("maxDate",this._oMaxDate.toLocalJSDate(),true)}if(this._oFocusedDate){if(this._oFocusedDate.isBefore(this._oMinDate)){t.sap.log.warning("focused date < minDate -> minDate focused",this);this.focusDate(e)}}if(this._oStartDate&&this._oStartDate.isBefore(this._oMinDate)){t.sap.log.warning("start date < minDate -> minDate set as start date",this);D.call(this,new l(this._oMinDate),true,true)}}this.setProperty("minDate",e,false);if(this.getPickerPopup()){var i=this._getCalendarPicker();i.setMinDate(e)}else{var s=this.getAggregation("yearPicker");s._oMinDate.setYear(this._oMinDate.getYear())}return this};f.prototype.setMaxDate=function(e){if(t.sap.equal(e,this.getMaxDate())){return this}if(!e){this._oMaxDate=n._maxDate()}else{n._checkJSDateObject(e);this._oMaxDate=l.fromLocalJSDate(e);this._oMaxDate.setDate(n._daysInMonth(this._oMaxDate));var a=this._oMaxDate.getYear();n._checkYearInValidRange(a);if(this._oMinDate.isAfter(this._oMaxDate)){t.sap.log.warning("maxDate < minDate -> minDate set to begin of the month",this);this._oMinDate=l.fromLocalJSDate(e);this._oMinDate.setDate(1);this.setProperty("minDate",this._oMinDate.toLocalJSDate(),true)}if(this._oFocusedDate){if(this._oFocusedDate.isAfter(this._oMaxDate)){t.sap.log.warning("focused date > maxDate -> maxDate focused",this);this.focusDate(e)}}if(this._oStartDate){var i=new l(this._oStartDate);i.setDate(1);i.setMonth(i.getMonth()+this._getMonths());i.setDate(0);if(i.isAfter(this._oMaxDate)){var s=new l(this._oMaxDate);s.setDate(1);s.setMonth(s.getMonth()-this._getMonths()+1);if(s.isSameOrAfter(this._oMinDate)){t.sap.log.warning("end date > maxDate -> maxDate set as end date",this);D.call(this,s,true,true)}}}}this.setProperty("maxDate",e,false);if(this.getPickerPopup()){var o=this._getCalendarPicker();o.setMaxDate(e)}else{var r=this.getAggregation("yearPicker");r._oMaxDate.setYear(this._oMaxDate.getYear())}return this};f.prototype.onclick=function(t){if(t.isMarked("delayedMouseEvent")){return}if(t.target.id==this.getId()+"-cancel"){this.onsapescape(t)}};f.prototype.onmousedown=function(t){t.preventDefault();t.setMark("cancelAutoClose")};f.prototype.onsapescape=function(t){if(this.getPickerPopup()){w.call(this);this.fireCancel()}else{switch(this._iMode){case 0:this.fireCancel();break;case 1:y.call(this);break}}};f.prototype.onsaptabnext=function(e){var a=this.getAggregation("header"),i,s;if(t.sap.containsOrEquals(this.getDomRef("content"),e.target)){t.sap.focus(a.getDomRef("B2"));if(!this._bPoupupMode){s=this.getAggregation("monthsRow");t(s._oItemNavigation.getItemDomRefs()[s._oItemNavigation.getFocusedIndex()]).attr("tabindex","-1");if(!this.getPickerPopup()){i=this.getAggregation("yearPicker");if(i.getDomRef()){t(i._oItemNavigation.getItemDomRefs()[i._oItemNavigation.getFocusedIndex()]).attr("tabindex","-1")}}}e.preventDefault()}};f.prototype.onsaptabprevious=function(e){var a=this.getAggregation("header"),i,s;if(t.sap.containsOrEquals(this.getDomRef("content"),e.target)){if(this._bPoupupMode){t.sap.focus(a.getDomRef("B2"));e.preventDefault()}}else if(e.target.id==a.getId()+"-B2"){switch(this._iMode){case 0:i=this.getAggregation("monthsRow");i._oItemNavigation.focusItem(i._oItemNavigation.getFocusedIndex());break;case 1:if(!this.getPickerPopup()){s=this.getAggregation("yearPicker");s._oItemNavigation.focusItem(s._oItemNavigation.getFocusedIndex())}break}e.preventDefault()}};f.prototype.onfocusin=function(e){if(e.target.id==this.getId()+"-end"){var a=this.getAggregation("header"),i,s;t.sap.focus(a.getDomRef("B2"));if(!this._bPoupupMode){i=this.getAggregation("monthsRow");t(i._oItemNavigation.getItemDomRefs()[i._oItemNavigation.getFocusedIndex()]).attr("tabindex","-1");if(!this.getPickerPopup()){s=this.getAggregation("yearPicker");if(s.getDomRef()){t(s._oItemNavigation.getItemDomRefs()[s._oItemNavigation.getFocusedIndex()]).attr("tabindex","-1")}}}}this.$("end").attr("tabindex","-1")};f.prototype.onsapfocusleave=function(e){var a,i;if(!e.relatedControlId||!t.sap.containsOrEquals(this.getDomRef(),sap.ui.getCore().byId(e.relatedControlId).getFocusDomRef())){this.$("end").attr("tabindex","0");if(!this._bPoupupMode){switch(this._iMode){case 0:a=this.getAggregation("monthsRow");t(a._oItemNavigation.getItemDomRefs()[a._oItemNavigation.getFocusedIndex()]).attr("tabindex","0");break;case 1:if(!this.getPickerPopup()){i=this.getAggregation("yearPicker");t(i._oItemNavigation.getItemDomRefs()[i._oItemNavigation.getFocusedIndex()]).attr("tabindex","0")}break}}}};f.prototype._handlePrevious=function(t){var e,a,i,s;switch(this._iMode){case 0:e=this._getFocusedDate();a=this._getMonths();i=new l(_.call(this));i.setMonth(i.getMonth()-a);e.setMonth(e.getMonth()-a);this._setFocusedDate(e);D.call(this,i,true);break;case 1:if(!this.getPickerPopup()){s=this.getAggregation("yearPicker");s.previousPage();k.call(this)}break}};f.prototype._handleNext=function(t){var e,a,i,s;switch(this._iMode){case 0:e=this._getFocusedDate();a=this._getMonths();i=new l(_.call(this));i.setMonth(i.getMonth()+a);e.setMonth(e.getMonth()+a);this._setFocusedDate(e);D.call(this,i,true);break;case 1:if(!this.getPickerPopup()){s=this.getAggregation("yearPicker");s.nextPage();k.call(this)}break}};f.prototype._showOverlay=function(){this.$("contentOver").css("display","")};f.prototype._hideOverlay=function(){this.$("contentOver").css("display","none")};f.prototype._getShowItemHeader=function(){var t=this.getMonths();if(t>this._iDaysMonthsHead){return true}else{return false}};function D(t,e,a){var i=new l(this._oMaxDate);i.setDate(1);i.setMonth(i.getMonth()-this._getMonths()+1);if(i.isBefore(this._oMinDate)){i=new l(this._oMinDate);i.setMonth(i.getMonth()+this._getMonths()-1)}if(t.isBefore(this._oMinDate)){t=new l(this._oMinDate)}else if(t.isAfter(i)){t=i}t.setDate(1);var s=t.toLocalJSDate();this.setProperty("startDate",s,true);this._oStartDate=t;var o=this.getAggregation("monthsRow");o.setStartDate(s);P.call(this);if(e){var r=this._getFocusedDate().toLocalJSDate();if(!o.checkDateFocusable(r)){this._setFocusedDate(t);o.setDate(s)}else{o.setDate(r)}}if(!a){this.fireStartDateChange()}}function _(){if(!this._oStartDate){this._oStartDate=this._getFocusedDate();this._oStartDate.setDate(1)}return this._oStartDate}function v(t){var e=this._getFocusedDate();var a=this.getAggregation("monthsRow");if(!t){a.setDate(e.toLocalJSDate())}else{a.displayDate(e.toLocalJSDate())}P.call(this)}function m(){var t=this.getSelectedDates();if(t&&t[0]&&t[0].getStartDate()){this._oFocusedDate=l.fromLocalJSDate(t[0].getStartDate())}else{this._oFocusedDate=new l}this._oFocusedDate.setDate(1);if(this._oFocusedDate.isBefore(this._oMinDate)){this._oFocusedDate=new l(this._oMinDate)}else if(this._oFocusedDate.isAfter(this._oMaxDate)){this._oFocusedDate=new l(this._oMaxDate)}}function M(){var e=this._getFocusedDate();var a=this.getAggregation("yearPicker");if(a.getDomRef()){a.$().css("display","")}else{var i=sap.ui.getCore().createRenderManager();var s=this.$("content");i.renderControl(a);i.flush(s[0],false,true);i.destroy()}this._showOverlay();a.setDate(e.toLocalJSDate());if(this._iMode==0){var o=this.getAggregation("monthsRow");t(o._oItemNavigation.getItemDomRefs()[o._oItemNavigation.getFocusedIndex()]).attr("tabindex","-1")}k.call(this);this._iMode=1}function y(e){this._iMode=0;var a=this.getAggregation("yearPicker");a.$().css("display","none");this._hideOverlay();if(!e){v.call(this);var i=this.getAggregation("monthsRow");t(i._oItemNavigation.getItemDomRefs()[i._oItemNavigation.getFocusedIndex()]).attr("tabindex","0")}}function P(){I.call(this);x.call(this)}function x(){var t=new l(_.call(this));var e=this._getMonths();var a=t.getYear();var i=this._oMaxDate.getYear();var s=this._oMinDate.getYear();var o=t.getMonth();var r=this._oMaxDate.getMonth();var n=this._oMinDate.getMonth();var h=this.getAggregation("header");if(a<s||a==s&&o<=n){h.setEnabledPrevious(false)}else{h.setEnabledPrevious(true)}t.setMonth(t.getMonth()+e-1);a=t.getYear();o=t.getMonth();if(a>i||a==i&&o>=r){h.setEnabledNext(false)}else{h.setEnabledNext(true)}}function k(){var t=this.getAggregation("yearPicker");var e=t.getYears();var a=l.fromLocalJSDate(t.getFirstRenderedDate());a.setYear(a.getYear()+Math.floor(e/2));var i=this.getAggregation("header");var s=new l(this._oMaxDate);s.setYear(s.getYear()-Math.ceil(e/2));s.setMonth(11,31);var o=new l(this._oMinDate);o.setYear(o.getYear()+Math.floor(e/2)+1);o.setMonth(0,1);i.setEnabledNext(!a.isAfter(s));i.setEnabledPrevious(!a.isBefore(o))}function I(){var t;var e=_.call(this);var a=this._oYearFormat.format(e.toUTCJSDate(),true);var i=new l(e);i.setMonth(i.getMonth()+this._getMonths()-1);var s=this._oYearFormat.format(i.toUTCJSDate(),true);if(a!=s){var o=this._getLocaleData();var r=o.getIntervalPattern();t=r.replace(/\{0\}/,a).replace(/\{1\}/,s)}else{t=a}var n=this.getAggregation("header");n.setTextButton2(t)}function S(t,e){var a;var i=false;if(t.isBefore(this._oMinDate)){a=this._oMinDate;i=true}else if(t.isAfter(this._oMaxDate)){a=this._oMaxDate;i=true}else{a=t}this._setFocusedDate(a);if(i||e){N.call(this,a);v.call(this,false);this.fireStartDateChange()}}function b(t,e){if(!t){return}var a=l.fromLocalJSDate(t);if(this._oFocusedDate&&this._oFocusedDate.isSame(a)){return}var i=a.getYear();n._checkYearInValidRange(i);if(n._isOutside(a,this._oMinDate,this._oMaxDate)){throw new Error("Date must not be in valid range (minDate and maxDate); "+this)}this._setFocusedDate(a);if(this.getDomRef()&&this._iMode==0){v.call(this,e)}}function A(t){if(this.getPickerPopup()){this._showCalendarPicker()}else{if(this._iMode!=1){M.call(this)}else{y.call(this)}}}f.prototype._showCalendarPicker=function(){var t=this._getFocusedDate(true).toLocalJSDate();var e=this._getCalendarPicker();var a=new sap.ui.unified.DateRange({startDate:t});e.displayDate(t,false);e.removeAllSelectedDates();e.addSelectedDate(a);e.setMinDate(this.getMinDate());e.setMaxDate(this.getMaxDate());B.call(this,e);this._showOverlay()};function w(e){if(this._oPopup&&this._oPopup.isOpen()){this._oPopup.close()}this._hideOverlay();if(!e){v.call(this);var a=this.getAggregation("monthsRow");t(a._oItemNavigation.getItemDomRefs()[a._oItemNavigation.getFocusedIndex()]).attr("tabindex","0")}}function R(t){this.fireSelect()}function C(t){var e=l.fromLocalJSDate(t.getParameter("date"));var a=t.getParameter("notVisible");S.call(this,e,a)}function F(t){var e=new l(this._getFocusedDate());var a=this._getCalendarPicker();var i=a.getSelectedDates()[0].getStartDate();var s=l.fromLocalJSDate(i);s.setMonth(e.getMonth());s.setDate(e.getDate());S.call(this,s,true);w.call(this)}function L(t){var e=new l(this._getFocusedDate());var a=this.getAggregation("yearPicker");var i=l.fromLocalJSDate(a.getDate());i.setMonth(e.getMonth());i.setDate(e.getDate());e=i;S.call(this,e,true);y.call(this)}function Y(){this._sInvalidateContent=undefined;var t=this.getAggregation("monthsRow");t._bDateRangeChanged=true;t._bInvalidateSync=true;t.invalidate();t._bInvalidateSync=undefined;this._bDateRangeChanged=undefined}function N(t){var e=this.getAggregation("monthsRow");var a=_.call(this);var i=e._oItemNavigation.getFocusedIndex();a=new l(t);a.setMonth(a.getMonth()-i);D.call(this,a,false,true)}function B(e){if(!this._oPopup){t.sap.require("sap.ui.core.Popup");this._oPopup=new sap.ui.core.Popup;this._oPopup.setAutoClose(true);this._oPopup.setAutoCloseAreas([this.getDomRef()]);this._oPopup.setDurations(0,0);this._oPopup._oCalendar=this;this._oPopup.attachClosed(J,this);this._oPopup.onsapescape=function(t){this._oCalendar.onsapescape(t)}}this._oPopup.setContent(e);var a=this.getAggregation("header");var i=sap.ui.core.Popup.Dock;this._oPopup.open(0,i.CenterTop,i.CenterTop,a,null,"flipfit",true)}function J(t){w.call(this)}function E(t){k.call(this)}var O=u.extend("CustomYearPicker",{renderer:o.extend(p)});O.prototype._initializeHeader=function(){var t=new h(this.getId()+"--Head",{visibleButton1:false});t.attachEvent("pressPrevious",this._handlePrevious,this);t.attachEvent("pressNext",this._handleNext,this);t.attachEvent("pressButton2",this._handleButton2,this);this.setAggregation("header",t)};O.prototype.onAfterRendering=function(){u.prototype.onAfterRendering.apply(this,arguments);var t=this.getAggregation("header");t.$("B2").css("background-color","inherit").css("color","inherit").css("cursor","inherit").css("pointer-events","none");this._showYearPicker()};O.prototype.onThemeChanged=function(){u.prototype.onThemeChanged.apply(this,arguments);var t=this.getAggregation("header");t.$("B2").css("background-color","inherit").css("color","inherit").css("cursor","inherit").css("pointer-events","none")};O.prototype._selectYear=function(){var t=this.getAggregation("yearPicker");var e=this.getSelectedDates()[0];if(!e){e=new sap.ui.unified.DateRange}e.setStartDate(t.getDate());this.addSelectedDate(e);this.fireSelect()};O.prototype.onsapescape=function(t){this.fireCancel()};O.prototype._shouldFocusB2OnTabPrevious=function(t){return false};return f});