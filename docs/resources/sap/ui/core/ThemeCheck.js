/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/Device","sap/ui/base/Object","sap/ui/thirdparty/URI","jquery.sap.script"],function(e,t,a,r){"use strict";var s=150;var n=a.extend("sap.ui.core.ThemeCheck",{constructor:function(e){this._oCore=e;this._iCount=0;this._CUSTOMCSSCHECK=/\.sapUiThemeDesignerCustomCss/i;this._CUSTOMID="sap-ui-core-customcss";this._customCSSAdded=false;this._themeCheckedForCustom=null;this._sFallbackTheme=null;this._mThemeFallback={};this._oThemeMetaDataCheckElement=null},getInterface:function(){return this},fireThemeChangedEvent:function(e){l(this);m.apply(this,[true]);if(!e&&!this._sThemeCheckId){this._oCore.fireThemeChanged({theme:this._oCore.getConfiguration().getTheme()})}}});n.themeLoaded=false;function h(e){try{return e.cssRules}catch(e){return null}}function i(e){var t=h(e);return!!t&&t.length>0}n.checkStyle=function(t,a){var r=document.getElementById(t);try{var s=false,n=false,h=false,l=false;s=!r;n=!!(r&&(r.getAttribute("data-sap-ui-ready")==="true"||r.getAttribute("data-sap-ui-ready")==="false"));h=!!(r&&r.sheet&&r.sheet.href===r.href&&i(r.sheet));l=!!(r&&r.innerHTML&&r.innerHTML.length>0);var o=s||h||l||n;if(a){e.sap.log.debug("ThemeCheck: "+t+": "+o+" (noLinkElement: "+s+", sheet: "+h+", innerHtml: "+l+", linkElementFinishedLoading: "+n+")")}return o}catch(r){if(a){e.sap.log.error("ThemeCheck: "+t+": Error during check styles '"+t+"'",r)}}return false};function l(t){n.themeLoaded=false;if(t._sThemeCheckId){e.sap.clearDelayedCall(t._sThemeCheckId);t._sThemeCheckId=null;t._iCount=0;t._sFallbackTheme=null;t._mThemeFallback={};if(t._oThemeMetaDataCheckElement&&t._oThemeMetaDataCheckElement.parentNode){t._oThemeMetaDataCheckElement.parentNode.removeChild(t._oThemeMetaDataCheckElement);t._oThemeMetaDataCheckElement=null}}}function o(t){var a=t._oCore.getLoadedLibraries();var r=t._oCore.getConfiguration().getTheme();var s=t._oCore._getThemePath("sap.ui.core",r)+"custom.css";var h=r.indexOf("sap_")===0||r==="base";var l=true;var o=[];if(!!t._customCSSAdded&&t._themeCheckedForCustom===r){a[t._CUSTOMID]={}}function m(c){var m="sap-ui-theme-"+c;var d=n.checkStyle(m,true);if(d){var C=document.querySelectorAll("link[data-sap-ui-foucmarker='"+m+"']");if(C.length>0){for(var f=0,g=C.length;f<g;f++){C[f].parentNode.removeChild(C[f])}e.sap.log.debug("ThemeCheck: Old stylesheets removed for library: "+c)}}l=l&&d;if(l){if(t._themeCheckedForCustom!=r){if(!h&&u(t,c)){var p=s;var _=t._oCore._getLibraryCssQueryParams(a["sap.ui.core"]);if(_){p+=_}e.sap.includeStyleSheet(p,t._CUSTOMID);t._customCSSAdded=true;e.sap.log.warning("ThemeCheck: delivered custom CSS needs to be loaded, Theme not yet applied");t._themeCheckedForCustom=r;l=false;return false}else{var T=e("LINK[id='"+t._CUSTOMID+"']");if(T.length>0){T.remove();e.sap.log.debug("ThemeCheck: Custom CSS removed")}t._customCSSAdded=false}}}if(!h&&d&&!t._mThemeFallback[c]){var k=document.getElementById(m);if(k&&k.getAttribute("data-sap-ui-ready")==="false"&&!(k.sheet&&i(k.sheet))){o.push(c)}}}e.each(a,m);if(o.length>0){if(!t._sFallbackTheme){if(!t._oThemeMetaDataCheckElement){t._oThemeMetaDataCheckElement=document.createElement("style");e.each(a,function(e){var a="sapThemeMetaData-UI5-"+e.replace(/\./g,"-");t._oThemeMetaDataCheckElement.classList.add(a)});document.head.appendChild(t._oThemeMetaDataCheckElement)}t._sFallbackTheme=c(t._oThemeMetaDataCheckElement)}if(t._sFallbackTheme){o.forEach(function(a){var s="sap-ui-theme-"+a;var n=document.getElementById(s);e.sap.log.warning("ThemeCheck: Custom theme '"+r+"' could not be loaded for library '"+a+"'. "+"Falling back to its base theme '"+t._sFallbackTheme+"'.");t._oCore._updateThemeUrl(n,t._sFallbackTheme);t._mThemeFallback[a]=true});l=false}}if(!l){e.sap.log.warning("ThemeCheck: Theme not yet applied.")}else{t._themeCheckedForCustom=r}return l}function c(e){function t(){var t=window.getComputedStyle(e).getPropertyValue("background-image");var a=/\(["']?data:text\/plain;utf-8,(.*?)['"]?\)/i.exec(t);if(!a||a.length<2){return null}var r=a[1];if(r.charAt(0)!=="{"&&r.charAt(r.length-1)!=="}"){try{r=decodeURI(r)}catch(e){}}r=r.replace(/\\"/g,'"');r=r.replace(/%20/g," ");try{return JSON.parse(r)}catch(e){return null}}var a=t();if(a&&a.Extends&&a.Extends[0]){return a.Extends[0]}else{return null}}function u(a,r){var s=e.sap.domById("sap-ui-theme-"+r);if(!s){return false}var n=window.getComputedStyle(s,":after");var i=n?n.getPropertyValue("content"):null;if(!i&&t.browser.safari){var l=document.documentElement;l.classList.add("sapUiThemeDesignerCustomCss");i=window.getComputedStyle(l,":after").getPropertyValue("content");l.classList.remove("sapUiThemeDesignerCustomCss")}if(i&&i!=="none"){try{if(i[0]==="'"||i[0]==='"'){i=i.substring(1,i.length-1)}return i==="true"}catch(t){e.sap.log.error("Custom check: Error parsing JSON string for custom.css indication.",t)}}var o=s.sheet?h(s.sheet):null;if(!o||o.length===0){e.sap.log.warning("Custom check: Failed retrieving a CSS rule from stylesheet "+r);return false}for(var c=0;c<2&&c<o.length;c++){if(a._CUSTOMCSSCHECK.test(o[c].selectorText)){return true}}return false}function m(t){this._iCount++;var a=this._iCount>s;if(!o(this)&&!a){var r;if(this._iCount<=100){r=2}else if(this._iCount<=110){r=500}else{r=1e3}this._sThemeCheckId=e.sap.delayedCall(r,this,m)}else if(!t){l(this);n.themeLoaded=true;this._oCore.fireThemeChanged({theme:this._oCore.getConfiguration().getTheme()});if(a){e.sap.log.warning("ThemeCheck: max. check cycles reached.")}}else{n.themeLoaded=true}}return n});