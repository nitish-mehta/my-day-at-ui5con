/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/EventProvider","jquery.sap.keycodes"],function(e,t){"use strict";var s=t.extend("sap.ui.core.delegate.ItemNavigation",{constructor:function(e,s,i){t.apply(this);this.oDomRef=null;if(e){this.setRootDomRef(e)}this.aItemDomRefs=[];if(s){this.setItemDomRefs(s)}this.iTabIndex=-1;this.iActiveTabIndex=!!i?-1:0;this.iFocusedIndex=-1;this.iSelectedIndex=-1;this.bCycling=true;this.bTableMode=false;this.iPageSize=-1;this._bMouseDownHappened=false;this.oDisabledModifiers={sapend:["alt","shift"],saphome:["alt","shift"]}}});s.Events={BeforeFocus:"BeforeFocus",AfterFocus:"AfterFocus",BorderReached:"BorderReached",FocusAgain:"FocusAgain",FocusLeave:"FocusLeave"};s.prototype.setDisabledModifiers=function(e){this.oDisabledModifiers=e;return this};s.prototype.getDisabledModifiers=function(e){return this.oDisabledModifiers};s.prototype.hasDisabledModifier=function(e){var t=this.oDisabledModifiers[e.type.replace("modifiers","")];if(Array.isArray(t)){for(var s=0;s<t.length;s++){if(e[t[s]+"Key"]){return true}}}return false};s.prototype.setRootDomRef=function(t){this.oDomRef=t;if(!e(this.oDomRef).data("sap.INItem")){if(this.iFocusedIndex>=0){e(this.oDomRef).attr("tabIndex",this.iTabIndex)}else{e(this.oDomRef).attr("tabIndex",this.iActiveTabIndex)}}e(this.oDomRef).data("sap.INRoot",this);return this};s.prototype.getRootDomRef=function(){return this.oDomRef};s.prototype.getItemDomRefs=function(){return this.aItemDomRefs};s.prototype.setItemDomRefs=function(t){e.sap.assert(typeof t==="object"&&typeof t.length==="number","aItemDomRefs must be an array of DOM elements");this.aItemDomRefs=t;if(this.iFocusedIndex>t.length-1){this.iFocusedIndex=t.length-1}for(var s=0;s<this.aItemDomRefs.length;s++){if(this.aItemDomRefs[s]){var i=e(this.aItemDomRefs[s]);if(s==this.iFocusedIndex&&!i.data("sap.INRoot")){i.attr("tabIndex",this.iActiveTabIndex)}else if(i.attr("tabindex")=="0"){i.attr("tabIndex",-1)}i.data("sap.INItem",true);i.data("sap.InNavArea",true);if(i.data("sap.INRoot")&&s!=this.iFocusedIndex){i.data("sap.INRoot").setNestedItemsTabindex()}}}return this};s.prototype.setItemsTabindex=function(){for(var t=0;t<this.aItemDomRefs.length;t++){if(this.aItemDomRefs[t]){var s=e(this.aItemDomRefs[t]);if(s.is(":sapFocusable")){if(t==this.iFocusedIndex&&!s.data("sap.INRoot")){s.attr("tabIndex",this.iActiveTabIndex)}else{s.attr("tabIndex",-1)}}}}return this};s.prototype.setNestedItemsTabindex=function(){if(e(this.oDomRef).data("sap.INItem")){for(var t=0;t<this.aItemDomRefs.length;t++){if(this.aItemDomRefs[t]&&e(this.aItemDomRefs[t]).attr("tabindex")=="0"){e(this.aItemDomRefs[t]).attr("tabIndex",-1)}}}return this};s.prototype.destroy=function(){if(this.oDomRef){e(this.oDomRef).removeData("sap.INRoot");this.oDomRef=null}if(this.aItemDomRefs){for(var t=0;t<this.aItemDomRefs.length;t++){if(this.aItemDomRefs[t]){e(this.aItemDomRefs[t]).removeData("sap.INItem");e(this.aItemDomRefs[t]).removeData("sap.InNavArea")}}this.aItemDomRefs=null}this._bItemTabIndex=undefined;this.iFocusedIndex=-1};s.prototype.setCycling=function(e){this.bCycling=e;return this};s.prototype.setTableMode=function(e,t){this.bTableMode=e;if(this.oConfiguration===undefined){this.oConfiguration=sap.ui.getCore().getConfiguration()}this.bTableList=e?t:false;return this};s.prototype.setPageSize=function(e){this.iPageSize=e;return this};s.prototype.setSelectedIndex=function(e){this.iSelectedIndex=e;return this};s.prototype.setColumns=function(e,t){this.iColumns=e;this.bNoColumnChange=t;return this};s.prototype.setHomeEndColumnMode=function(e,t){this._bStayInRow=e;this._bCtrlEnabled=t;return this};s.prototype.focusItem=function(t,i){e.sap.log.info("FocusItem: "+t+" iFocusedIndex: "+this.iFocusedIndex,"focusItem","ItemNavigation");if(t==this.iFocusedIndex&&this.aItemDomRefs[this.iFocusedIndex]==document.activeElement){this.fireEvent(s.Events.FocusAgain,{index:t,event:i});return}if(!this.aItemDomRefs[t]||!e(this.aItemDomRefs[t]).is(":sapFocusable")){if(this.bTableMode){var o=t%this.iColumns;var a=t;if(i&&i.keyCode==e.sap.KeyCodes.ARROW_RIGHT){if(o<this.iColumns-1){t+=this.oConfiguration.getRTL()?-1:1}}else if(i&&i.keyCode==e.sap.KeyCodes.ARROW_LEFT){if(o>1){t-=this.oConfiguration.getRTL()?-1:1}}else{if(o>1){t-=1}}if(t!=a){this.focusItem(t,i)}}return}this.fireEvent(s.Events.BeforeFocus,{index:t,event:i});this.setFocusedIndex(t);this.bISetFocus=true;if(i&&e(this.aItemDomRefs[this.iFocusedIndex]).data("sap.INRoot")){var n=e(this.aItemDomRefs[this.iFocusedIndex]).data("sap.INRoot");n._sFocusEvent=i.type}e.sap.log.info("Set Focus on ID: "+this.aItemDomRefs[this.iFocusedIndex].id,"focusItem","ItemNavigation");e.sap.focus(this.aItemDomRefs[this.iFocusedIndex]);this.fireEvent(s.Events.AfterFocus,{index:t,event:i})};s.prototype.setFocusedIndex=function(t){var s;if(this.aItemDomRefs.length<0){this.iFocusedIndex=-1;return this}if(t<0){t=0}if(t>this.aItemDomRefs.length-1){t=this.aItemDomRefs.length-1}e(this.oDomRef).attr("tabIndex",this.iTabIndex);if(this.iFocusedIndex!==-1&&this.aItemDomRefs.length>this.iFocusedIndex){e(this.aItemDomRefs[this.iFocusedIndex]).attr("tabIndex",-1);s=e(this.aItemDomRefs[this.iFocusedIndex]);if(s.data("sap.INRoot")&&t!=this.iFocusedIndex){e(s.data("sap.INRoot").aItemDomRefs[s.data("sap.INRoot").iFocusedIndex]).attr("tabIndex",-1)}}this.iFocusedIndex=t;var i=this.aItemDomRefs[this.iFocusedIndex];s=e(this.aItemDomRefs[this.iFocusedIndex]);if(!s.data("sap.INRoot")){e(i).attr("tabIndex",this.iActiveTabIndex)}return this};s.prototype.getFocusedDomRef=function(){return this.aItemDomRefs[this.iFocusedIndex]};s.prototype.getFocusedIndex=function(){return this.iFocusedIndex};s.prototype.onfocusin=function(t){var i=t.target;var o=0;if(i==this.oDomRef){if(!this._bItemTabIndex){this.setItemsTabindex();this._bItemTabIndex=true}if(this._bMouseDownHappened){return}var a;if(e(this.oDomRef).data("sap.INItem")&&this._sFocusEvent&&!e(this.oDomRef).data("sap.InNavArea")){switch(this._sFocusEvent){case"sapnext":a=0;break;case"sapprevious":a=this.aItemDomRefs.length-1;break;default:if(this.iSelectedIndex!=-1){a=this.iSelectedIndex}else if(this.iFocusedIndex!=-1){a=this.iFocusedIndex}else{a=0}break}this._sFocusEvent=undefined}else{if(this.iSelectedIndex!=-1){a=this.iSelectedIndex}else if(this.iFocusedIndex!=-1){a=this.iFocusedIndex}else{a=0}}this.focusItem(a,t);if(this.iFocusedIndex==-1){for(o=a+1;o<this.aItemDomRefs.length;o++){this.focusItem(o,t);if(this.iFocusedIndex==o){break}}if(this.iFocusedIndex==-1&&a>0){for(o=a-1;o>=0;o--){this.focusItem(o,t);if(this.iFocusedIndex==o){break}}}}t.preventDefault();t.stopPropagation()}else if(!this.bISetFocus){if(this.aItemDomRefs&&t.target!=this.aItemDomRefs[this.iFocusedIndex]){for(o=0;o<this.aItemDomRefs.length;o++){if(t.target==this.aItemDomRefs[o]){this.focusItem(o,t);break}}}else{this.fireEvent(s.Events.AfterFocus,{index:this.iFocusedIndex,event:t})}}this.bISetFocus=false};s.prototype.onsapfocusleave=function(t){if(!t.relatedControlId||!e.sap.containsOrEquals(this.oDomRef,sap.ui.getCore().byId(t.relatedControlId).getFocusDomRef())){var i;if(this.iSelectedIndex!=-1){i=this.iSelectedIndex}else if(this.iFocusedIndex!=-1){i=this.iFocusedIndex}else{i=0}this.setFocusedIndex(i);var o;if(e(this.oDomRef).data("sap.INItem")){var a;o=e(this.oDomRef);while(!a){o=o.parent();if(o.data("sap.INRoot")){a=o.get(0)}}if(!t.relatedControlId||e.sap.containsOrEquals(a,sap.ui.getCore().byId(t.relatedControlId).getFocusDomRef())){e(this.aItemDomRefs[this.iFocusedIndex]).attr("tabIndex",-1)}}o=e(this.oDomRef);if(o.data("sap.InNavArea")===false){o.data("sap.InNavArea",true)}this.fireEvent(s.Events.FocusLeave,{index:i,event:t})}};s.prototype.onmousedown=function(t){var s=t.target;var i=function(t,s){var i=false;var o=e(t);while(!o.is(":sapFocusable")&&o.get(0)!=s){o=o.parent()}if(o.get(0)!=s){i=true}return i};if(e.sap.containsOrEquals(this.oDomRef,s)){for(var o=0;o<this.aItemDomRefs.length;o++){var a=this.aItemDomRefs[o];if(e.sap.containsOrEquals(a,s)){if(!this.bTableMode){this.focusItem(o,t)}else{if(a===s||!i(s,a)){this.focusItem(o,t)}}return}}if(s==this.oDomRef){this._bMouseDownHappened=true;var n=this;window.setTimeout(function(){n._bMouseDownHappened=false},20)}}};s.prototype.onsapnext=function(t){if(!e.sap.containsOrEquals(this.oDomRef,t.target)){return}if(e(this.oDomRef).data("sap.InNavArea")){return}if(this.bTableMode&&this.aItemDomRefs.indexOf(t.target)===-1){return}var i=this.iFocusedIndex,o=true,a=false;if(i>-1){if(this.bTableMode){var n=this.aItemDomRefs.length/this.iColumns,h=Math.floor(i/this.iColumns),f=i%this.iColumns;if(t.keyCode==e.sap.KeyCodes.ARROW_DOWN){if(h<n-1){i+=this.iColumns}}else{if(f<this.iColumns-1){i+=1}}}else{do{if(this.iColumns>1&&t.keyCode==e.sap.KeyCodes.ARROW_DOWN){if(i+this.iColumns>=this.aItemDomRefs.length){if(!this.bNoColumnChange){if(i%this.iColumns<this.iColumns-1){i=i%this.iColumns+1}else if(this.bCycling){i=0}}else{i=this.iFocusedIndex;a=true}}else{i=i+this.iColumns}}else{if(i==this.aItemDomRefs.length-1){if(e(this.oDomRef).data("sap.INItem")){return}else if(this.bCycling){i=0}else{i=this.iFocusedIndex;a=true}}else{i++}}if(i===this.iFocusedIndex){if(o){o=false}else{throw new Error("ItemNavigation has no visible/existing items and is hence unable to select the next one")}}}while(!this.aItemDomRefs[i]||!e(this.aItemDomRefs[i]).is(":sapFocusable"))}this.focusItem(i,t);if(a){this.fireEvent(s.Events.BorderReached,{index:i,event:t})}t.preventDefault();t.stopPropagation()}};s.prototype.onsapnextmodifiers=function(e){if(this.hasDisabledModifier(e)){return}this.onsapnext(e)};s.prototype.onsapprevious=function(t){if(!e.sap.containsOrEquals(this.oDomRef,t.target)){return}if(e(this.oDomRef).data("sap.InNavArea")){return}if(this.bTableMode&&this.aItemDomRefs.indexOf(t.target)===-1){return}var i=this.iFocusedIndex,o=true,a=false;var n=0;if(i>-1){if(this.bTableMode){var h=Math.floor(i/this.iColumns);n=i%this.iColumns;if(t.keyCode==e.sap.KeyCodes.ARROW_UP){if(h>0){i-=this.iColumns}}else{if(n>0){i-=1}}}else{do{if(this.iColumns>1&&t.keyCode==e.sap.KeyCodes.ARROW_UP){if(i-this.iColumns<0){if(!this.bNoColumnChange){n=0;if(i%this.iColumns>0){n=i%this.iColumns-1}else if(this.bCycling){n=Math.min(this.iColumns-1,this.aItemDomRefs.length-1)}if(i===0&&n===0){i=0}else{var f=Math.ceil(this.aItemDomRefs.length/this.iColumns);i=n+(f-1)*this.iColumns;if(i>=this.aItemDomRefs.length){i=i-this.iColumns}}}else{i=this.iFocusedIndex;a=true}}else{i=i-this.iColumns}}else{if(i==0){if(e(this.oDomRef).data("sap.INItem")){return}else if(this.bCycling){i=this.aItemDomRefs.length-1}else{i=this.iFocusedIndex;a=true}}else{i--}}if(i==this.iFocusedIndex){if(o){o=false}else{throw new Error("ItemNavigation has no visible/existing items and is hence unable to select the previous one")}}}while(!this.aItemDomRefs[i]||!e(this.aItemDomRefs[i]).is(":sapFocusable"))}this.focusItem(i,t);if(a){this.fireEvent(s.Events.BorderReached,{index:i,event:t})}t.preventDefault();t.stopPropagation()}};s.prototype.onsappreviousmodifiers=function(e){if(this.hasDisabledModifier(e)){return}this.onsapprevious(e)};s.prototype.onsappageup=function(t){if(!e.sap.containsOrEquals(this.oDomRef,t.target)){return}if(this.bTableMode&&this.aItemDomRefs.indexOf(t.target)===-1){return}var i=0;var o=false;if(this.iPageSize>0){i=this.iFocusedIndex;if(i>-1){i=i-this.iPageSize;while(i>0&&!e(this.aItemDomRefs[i]).is(":sapFocusable")){i--}if(i<0){if(!this.bNoColumnChange){i=0}else{i=this.iFocusedIndex;o=true}}this.focusItem(i,t)}}else if(this.bTableMode){i=this.iFocusedIndex%this.iColumns;this.focusItem(i,t)}if(o){this.fireEvent(s.Events.BorderReached,{index:i,event:t})}t.preventDefault();t.stopPropagation()};s.prototype.onsappagedown=function(t){if(!e.sap.containsOrEquals(this.oDomRef,t.target)){return}if(this.bTableMode&&this.aItemDomRefs.indexOf(t.target)===-1){return}var i=0;var o=false;if(this.iPageSize>0){i=this.iFocusedIndex;if(i>-1){i=i+this.iPageSize;while(i<this.aItemDomRefs.length-1&&!e(this.aItemDomRefs[i]).is(":sapFocusable")){i++}if(i>this.aItemDomRefs.length-1){if(!this.bNoColumnChange){i=this.aItemDomRefs.length-1}else{i=this.iFocusedIndex;o=true}}this.focusItem(i,t)}}else if(this.bTableMode){var a=this.aItemDomRefs.length/this.iColumns,n=this.iFocusedIndex%this.iColumns;i=(a-1)*this.iColumns+n;this.focusItem(i,t)}if(o){this.fireEvent(s.Events.BorderReached,{index:i,event:t})}t.preventDefault();t.stopPropagation()};s.prototype.onsaphome=function(t){if(!e.sap.containsOrEquals(this.oDomRef,t.target)){return}if(this.bTableMode&&this.aItemDomRefs.indexOf(t.target)===-1){return}var s=0;var i=0;if(this.bTableMode){if(!this.bTableList&&!(t.metaKey||t.ctrlKey)){i=Math.floor(this.iFocusedIndex/this.iColumns);s=i*this.iColumns}}else{if(!!(t.metaKey||t.ctrlKey)&&!this._bCtrlEnabled){return}if(this._bStayInRow&&!(this._bCtrlEnabled&&(t.metaKey||t.ctrlKey))&&this.iColumns>0){i=Math.floor(this.iFocusedIndex/this.iColumns);s=i*this.iColumns}else{while(!this.aItemDomRefs[s]||!e(this.aItemDomRefs[s]).is(":sapFocusable")){s++;if(s==this.aItemDomRefs.length){return}}}}this.focusItem(s,t);t.preventDefault();t.stopPropagation()};s.prototype.onsaphomemodifiers=function(e){if(this.hasDisabledModifier(e)){return}this.onsaphome(e)};s.prototype.onsapend=function(t){if(!e.sap.containsOrEquals(this.oDomRef,t.target)){return}if(this.bTableMode&&this.aItemDomRefs.indexOf(t.target)===-1){return}var s=this.aItemDomRefs.length-1;var i=0;if(this.bTableMode){if(!this.bTableList&&!(t.metaKey||t.ctrlKey)){i=Math.floor(this.iFocusedIndex/this.iColumns);s=i*this.iColumns+this.iColumns-1}}else{if(!!(t.metaKey||t.ctrlKey)&&!this._bCtrlEnabled){return}if(this._bStayInRow&&!(this._bCtrlEnabled&&(t.metaKey||t.ctrlKey))&&this.iColumns>0){i=Math.floor(this.iFocusedIndex/this.iColumns);s=(i+1)*this.iColumns-1;if(s>=this.aItemDomRefs.length){s=this.aItemDomRefs.length-1}}else{while(!this.aItemDomRefs[s]||!e(this.aItemDomRefs[s]).is(":sapFocusable")){s--;if(s<0){return}}}}this.focusItem(s,t);t.preventDefault();t.stopPropagation()};s.prototype.onsapendmodifiers=function(e){if(this.hasDisabledModifier(e)){return}this.onsapend(e)};s.prototype.setTabIndex0=function(){this.iTabIndex=0;this.iActiveTabIndex=0};s.prototype.onkeyup=function(t){if(t.keyCode==e.sap.KeyCodes.F2){var s=e(this.oDomRef);if(s.data("sap.InNavArea")){s.data("sap.InNavArea",false)}else if(s.data("sap.InNavArea")===false){s.data("sap.InNavArea",true)}t.preventDefault();t.stopPropagation()}};return s});