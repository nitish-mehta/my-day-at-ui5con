/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/DataType","sap/ui/base/ManagedObject","./Control","./CustomData","./HTML","./mvc/View","./mvc/EventHandlerResolver"],function(t,e,a,r,i,n,o,s){"use strict";var u={};u.attributes={"data-sap-ui-type":true,"data-sap-ui-id":true,"data-sap-ui-aggregation":true,"data-sap-ui-default-aggregation":true,"data-sap-ui-binding":function(t,e){var r=a.bindingParser(t);e.objectBindings=e.objectBindings||{};e.objectBindings[r.model||undefined]=r},"data-tooltip":function(t,e){e["tooltip"]=t},tooltip:function(e,a,r){a["tooltip"]=e;t.sap.log.warning('[Deprecated] Control "'+a.id+'": The attribute "tooltip" is not prefixed with "data-*". Future version of declarative support will only suppport attributes with "data-*" prefix.')},class:true,style:true,id:true};u.compile=function(e,a,r){var i=this;t(e).find("[data-sap-ui-type]").filter(function(){return t(this).parents("[data-sap-ui-type]").length===0}).each(function(){i._compile(this,a,r)})};u._compile=function(e,a,i){var n=t(e);var o=n.attr("data-sap-ui-type");var s=[];var u=o==="sap.ui.core.UIArea";if(u){var l=this;n.children().each(function(){var t=l._createControl(this,a);if(t){s.push(t)}})}else{var p=this._createControl(e,a);if(p){s.push(p)}}n.empty();var g=[];t.each(e.attributes,function(t,e){var a=e.name;if(!u||u&&/^data-/g.test(a.toLowerCase())){g.push(a)}});if(g.length>0){n.removeAttr(g.join(" "))}s.forEach(function(t){if(t instanceof r){if(a&&!i){a.addContent(t)}else{t.placeAt(e);if(a){a.connectControl(t)}}}})};u._createControl=function(e,a){var r=t(e);var i=null;var n=r.attr("data-sap-ui-type");if(n){t.sap.require(n);var s=t.sap.getObject(n);t.sap.assert(typeof s!=="undefined","Class not found: "+n);var u={};u.id=this._getId(r,a);this._addSettingsForAttributes(u,s,e,a);this._addSettingsForAggregations(u,s,e,a);var i;if(o.prototype.isPrototypeOf(s.prototype)&&typeof s._sType==="string"){i=sap.ui.view(u,undefined,s._sType)}else{i=new s(u)}if(e.className){i.addStyleClass(e.className)}r.removeAttr("data-sap-ui-type")}else{i=this._createHtmlControl(e,a)}return i};u._createHtmlControl=function(t,e){var a=new n;a.setDOMContent(t);this.compile(t,e,true);return a};u._addSettingsForAttributes=function(e,r,n,o){var l=this;var p=u.attributes;var g=a.bindingParser;var f=[];var d=/^data-custom-data:(.+)/i;t.each(n.attributes,function(a,n){var u=n.name;var c=n.value;if(!d.test(u)){if(typeof p[u]==="undefined"){u=l.convertAttributeToSettingName(u,e.id);var v=l._getProperty(r,u);if(v){var h=g(c,o&&o.getController(),true);if(h&&typeof h==="object"){e[u]=h}else{e[u]=l.convertValueToType(l.getPropertyDataType(v),h||c)}}else if(l._getAssociation(r,u)){var y=l._getAssociation(r,u);if(y.multiple){c=c.replace(/\s*,\s*|\s+/g,",");e[u]=c.split(",").map(function(t){return o?o.createId(t):t})}else{e[u]=o?o.createId(c):c}}else if(l._getAggregation(r,u)){var m=l._getAggregation(r,u);if(m.multiple){var h=g(c,o&&o.getController());if(h){e[u]=h}else{throw new Error("Aggregation "+u+" with cardinality 0..n only allows binding paths as attribute value")}}else if(m.altTypes){var h=g(c,o&&o.getController(),true);if(h&&typeof h==="object"){e[u]=h}else{e[u]=l.convertValueToType(m.altTypes[0],h||c)}}else{throw new Error("Aggregation "+u+" not supported")}}else if(l._getEvent(r,u)){var b=o&&(o._oContainingView||o).getController();var w=s.resolveEventHandler(c,b);if(w){e[u]=w}else{throw new Error('Control "'+e.id+'": The function "'+c+'" for the event "'+u+'" is not defined')}}else{t.sap.assert(u==="id","DeclarativeSupport encountered unknown setting '"+u+"' for class '"+r.getMetadata().getName()+"' (value:'"+c+"')")}}else if(typeof p[u]==="function"){p[u](c,e,r)}}else{u=t.sap.camelCase(d.exec(u)[1]);var h=g(c,o&&o.getController());f.push(new i({key:u,value:h||c}))}});if(f.length>0){e.customData=f}return e};u._addSettingsForAggregations=function(e,a,r,i){var n=t(r);var o=this._getDefaultAggregation(a,r);var s=this;var u=a.getMetadata().getAllAggregations();n.children().each(function(){var a=t(this);var r=a.attr("data-sap-ui-aggregation");var n=a.attr("data-sap-ui-type");var l=false;if(!r){l=true;r=o}if(r&&u[r]){var p=u[r].multiple;var g=function(a){var n=s._createControl(a,i);if(n){if(p){if(!e[r]){e[r]=[]}if(typeof e[r].path==="string"){t.sap.assert(!e[r].template,"list bindings support only a single template object");e[r].template=n}else{e[r].push(n)}}else{e[r]=n}}};if(l||n&&!l){g(this)}else{a.children().each(function(){g(this)})}}a.removeAttr("data-sap-ui-aggregation");a.removeAttr("data-sap-ui-type")});return e};u._getId=function(e,a){var r=t(e);var i=r.attr("id");if(i){if(a){i=a.createId(i);r.attr("data-sap-ui-id",i)}r.attr("id","")}return i};u._getProperty=function(t,e){return t.getMetadata().getProperty(e)};u.convertValueToType=function(t,r){if(t instanceof e){r=t.parseValue(r)}return typeof r==="string"?a.bindingParser.escape(r):r};u.getPropertyDataType=function(t){var a=e.getType(t.type);if(!a){throw new Error("Property "+t.name+" has no known type")}return a};u.convertAttributeToSettingName=function(e,a,r){if(e.indexOf("data-")===0){e=e.substr(5)}else if(r){t.sap.log.warning('[Deprecated] Control "'+a+'": The attribute "'+e+'" is not prefixed with "data-*". Future version of declarative support will only suppport attributes with "data-*" prefix.')}else{throw new Error('Control "'+a+'": The attribute "'+e+'" is not prefixed with "data-*".')}return t.sap.camelCase(e)};u._getAssociation=function(t,e){return t.getMetadata().getAssociation(e)};u._getAggregation=function(t,e){return t.getMetadata().getAggregation(e)};u._getEvent=function(t,e){return t.getMetadata().getEvent(e)};u._getDefaultAggregation=function(e,a){var r=t(a);var i=r.attr("data-sap-ui-default-aggregation")||e.getMetadata().getDefaultAggregationName();r.removeAttr("data-sap-ui-default-aggregation");return i};return u},true);