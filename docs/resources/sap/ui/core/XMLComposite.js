/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Control","sap/ui/core/XMLCompositeMetadata","sap/ui/model/base/ManagedObjectModel","sap/ui/core/util/XMLPreprocessor","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/base/ManagedObject","sap/ui/base/DataType","sap/ui/model/base/XMLNodeAttributesModel","sap/ui/core/util/reflection/XmlTreeModifier","sap/ui/model/resource/ResourceModel"],function(t,e,r,i,a,o,n,s,g,p,u,l){"use strict";var d={};function h(e,r){if(!d[e]){t.sap.require(e);d[e]=t.sap.getObject(e)}return d[e]}function f(t,e,r,i){var a=s.bindingParser(e,i,true);if(a&&typeof a==="object"){return a}var o=e=a||e;var n=g.getType(t);if(n){if(n instanceof g){o=n.parseValue(e)}}else{throw new Error("Property "+r+" has unknown type "+t)}return typeof o==="string"?s.bindingParser.escape(o):o}function c(t,e,r,i,a){var n=new o(r),s=i.getMetadata(),g=s.getAllAggregations(),l=s.getAllProperties(),d=s._mAllSpecialSettings;n.getVisitor=function(){return a};n._getObject=function(t,e){var i;t=this.resolve(t,e);t=t.substring(1);var o=t.split("/");if(t&&t.startsWith&&t.startsWith("metadataContexts")){return this._navInMetadataContexts(t)}if(l.hasOwnProperty(t)){var n=l[t];if(!r.hasAttribute(t)){return n.defaultValue}i=a.getResult(r.getAttribute(t))||r.getAttribute(t);if(i){var s=f(n.type,i,t);if(typeof s==="object"&&s.path){return i}return s}return null}else if(g.hasOwnProperty(o[0])){var h=g[o[0]];var c,m=u.getAggregation(r,o[0]);if(!m){return null}if(h.multiple){var y=[];for(var v=0;v<m.length;v++){c=new p(m[v],a,"");y.push(c.getContext("/"))}i=y}else{c=new p(m,a,"");i=c.getContext("/")}o.shift();return this._getNode(o,i)}else if(d.hasOwnProperty(t)){var A=d[t];if(!r.hasAttribute(t)){return A.defaultValue||null}i=a.getResult(r.getAttribute(t));if(A.type){var s=f(A.type,i,t);if(typeof s==="object"&&s.path){return i}return s}if(i){return i}return r.getAttribute(t)}};n._navInMetadataContexts=function(e){var r=e.replace("metadataContexts","");var i=r.split("/"),a=t["metadataContexts"].getObject();i.shift();return this._getNode(i,a)};n._getNode=function(t,e){var r=null,i;while(t.length>0&&e){if(e.getObject){r=e.getObject(t.join("/"))}if(!r){i=t.shift();e=e[i]}else{return r}}return e};n.getContextName=function(){return e};t[e]=n.getContext("/");if(t["metadataContexts"]){t["metadataContexts"].oModel.setProperty("/"+e,t[e])}}function m(t,e,r,i,a){r.model=r.model||a;var o=r.name||r.model||undefined;if(i[o]){return}try{t[o]=e.getContext(r.model+">"+r.path);i[o]=t[o]}catch(e){t["_$error"].oModel.setProperty("/"+o,e)}}function y(e,r,i,a,n){if(!i&&!a){return}var g=i?s.bindingParser(i):{parts:[]};var p=a?s.bindingParser(a):{parts:[]};if(!p.parts){p={parts:[p]}}if(!g.parts){g={parts:[g]}}t.merge(g.parts,p.parts);for(var u=0;u<g.parts.length;u++){m(e,r,g.parts[u],g,n);r=r["with"](e,false)}var l=new o(g);e["metadataContexts"]=l.getContext("/")}function v(t){var e={};e.models=t.oModels||{};e.bindingContexts=t.oBindingContexts||{};return e}function A(t,e,r){var i=e._aggregationFragments,a=e.getLibraryName(),o;if(i){Object.keys(i).forEach(function(n){var s=e.getAggregation(n);if(!s){return true}var g=t.getElementsByTagNameNS(a,n)[0];if(!g){g=document.createElementNS(a,n);t.appendChild(g);o=false}else{o=true}if(o&&!s.multiple){return true}var p=i[n].cloneNode(true);r.visitChildNodes(p);for(var u=p.childElementCount;u>0;u--){g.appendChild(p.children[0])}})}}var M=e.extend("sap.ui.core.XMLComposite",{metadata:{properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%",invalidate:true},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null,invalidate:true},displayBlock:{type:"boolean",group:"Appearance",defaultValue:true,invalidate:true}},aggregations:{_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}}},constructor:function(t,r){this._bIsCreating=true;e.apply(this,arguments);delete this._bIsCreating},renderer:function(t,e){t.write("<div");t.writeControlData(e);if(!e.getDisplayBlock()&&(e.getWidth()!=="100%"||e.getHeight()!=="100%")){t.addStyle("display","inline-block")}t.writeClasses();if(e.getHeight()){t.addStyle("height",e.getHeight())}if(e.getWidth()){t.addStyle("width",e.getWidth())}t.writeStyles();t.write(">");var r=e.getAggregation(e.getMetadata().getCompositeAggregationName());if(r){t.renderControl(r)}t.write("</div>")}},r);M.prototype.byId=function(t){return sap.ui.getCore().byId(n.createId(this.getId(),t))};M.prototype._getManagedObjectModel=function(){if(!this._oManagedObjectModel){this._oManagedObjectModel=new i(this)}return this._oManagedObjectModel};M.prototype.getSuppressInvalidateAggregation=function(t,e){var r=this.getMetadata(),i=r.getAggregation(t)||r.getAllPrivateAggregations()[t];if(!i){return true}e=r._suppressInvalidate(i,e);r._requestFragmentRetemplatingCheck(this,i);return e};M.prototype.setProperty=function(t,r,i){var a=this.getMetadata(),o=a.getProperty(t);if(!o){return this}i=this.getMetadata()._suppressInvalidate(o,i);if(e.prototype.getProperty.apply(this,[t])!==r){a._requestFragmentRetemplatingCheck(this,o)}return e.prototype.setProperty.apply(this,[t,r,i])};M.prototype.bindAggregation=function(t,r){var i=this.getMetadata(),a=i.getAggregation(t)||i.getAllPrivateAggregations()[t],o=e.prototype.getBinding.apply(this,[t]);if(!o||o&&o.getPath()!==r.path){i._requestFragmentRetemplatingCheck(this,a)}return e.prototype.bindAggregation.apply(this,[t,r])};M.prototype.unbindAggregation=function(t){var r=this.getMetadata(),i=r.getAggregation(t)||r.getAllPrivateAggregations()[t];if(this.isBound(t)){r._requestFragmentRetemplatingCheck(this,i,true)}return e.prototype.unbindAggregation.apply(this,[t])};M.prototype.setAggregation=function(t,r,i){return e.prototype.setAggregation.apply(this,[t,r,this.getSuppressInvalidateAggregation(t,i)])};M.prototype.addAggregation=function(t,r,i){return e.prototype.addAggregation.apply(this,[t,r,this.getSuppressInvalidateAggregation(t,i)])};M.prototype.insertAggregation=function(t,r,i,a){return e.prototype.insertAggregation.apply(this,[t,r,i,this.getSuppressInvalidateAggregation(t,a)])};M.prototype.removeAggregation=function(t,r,i){return e.prototype.removeAggregation.apply(this,[t,r,this.getSuppressInvalidateAggregation(t,i)])};M.prototype.removeAllAggregation=function(t,r){return e.prototype.removeAllAggregation.apply(this,[t,this.getSuppressInvalidateAggregation(t,r)])};M.prototype.destroyAggregation=function(t,r){return e.prototype.destroyAggregation.apply(this,[t,this.getSuppressInvalidateAggregation(t,r)])};M.prototype.updateAggregation=function(t,r){var i=this.getMetadata().getAggregation(t);if(i&&i.type==="TemplateMetadataContext"){this.invalidate();return}e.prototype.updateAggregation.apply(this,arguments)};M.prototype.setVisible=function(t){this.setProperty("visible",t);if(this.getParent()){this.getParent().invalidate()}return this};M.prototype._destroyCompositeAggregation=function(){var t=this.getMetadata().getCompositeAggregationName(),e=this.getAggregation(t);if(e){e.destroy()}return this};M.prototype.updateBindings=function(){if(this._bIsInitializing){return}var t=e.prototype.updateBindings.apply(this,arguments);for(var r in this.mBindingInfos){var i=this.getMetadata().getAggregation(r);if(i&&i.multiple&&!i._doesNotRequireFactory&&this.isBound(r)&&!this.getBinding(r)){this[i._sDestructor]()}}return t};M.prototype._setCompositeAggregation=function(e){var r=this.getMetadata().getCompositeAggregationName();this._destroyCompositeAggregation();if(!this._oManagedObjectModel){this._getManagedObjectModel()}if(t.isArray(e)){this.setAggregation(r,null);return}if(e){e.setModel(this._oManagedObjectModel,"$"+this.alias);e.bindObject("$"+this.alias+">/");var i=this._getResourceModel();if(i){e.setModel(i,"$"+this.alias+".i18n")}}this.setAggregation(r,e);this.invalidate()};M.mResourceModels={};M.getLibraryResourceModel=function(t){var e=M.mResourceModels[t];if(!e){e=new l({bundleName:t+".messagebundle",async:true});M.mResourceModels[t]=e}return e};M.prototype._getResourceModel=function(){if(this.resourceModel){return this.resourceModel}if(this.messageBundle){this.resourceModel=new l({bundleName:this.messageBundle,async:true});return this.resourceModel}else{this.sLibraryName=this.sLibraryName||this.getMetadata().getLibraryName();return M.getLibraryResourceModel(this.sLibraryName)}};M.prototype.getResourceBundle=function(){var t=this._getResourceModel();return t?t.getResourceBundle():null};M.prototype.destroy=function(){e.prototype.destroy.apply(this,arguments);if(this.resourceModel){this.resourceModel.destroy()}};M.prototype._initCompositeSupport=function(t){var e=this.getMetadata(),r=e.getCompositeAggregationName(),i=false;if(t&&r){var a=t[r];if(a instanceof s){this._destroyCompositeAggregation();this._setCompositeAggregation(a);i=true}else{if(a&&a.localName==="FragmentDefinition"){this._destroyCompositeAggregation();this._setCompositeAggregation(sap.ui.xmlfragment({sId:this.getId(),fragmentContent:t[r],oController:this}));i=true}}delete t[r]}if(!i){this._destroyCompositeAggregation();this._setCompositeAggregation(sap.ui.xmlfragment({sId:this.getId(),fragmentContent:this.getMetadata()._fragment,oController:this}))}};M.prototype.requestFragmentRetemplating=function(t){if(t){this.fragmentRetemplating();return}var e=this.getMetadata().getMandatoryAggregations(),r=true;for(var i in e){r=typeof this.getBindingInfo(i)==="object";if(!r){break}}if(r){this.fragmentRetemplating()}};M.prototype.fragmentRetemplating=function(){var t=this.getMetadata(),e=t.getFragment();if(!e){throw new Error("Fragment "+e.tagName+" not found")}var r=this._getManagedObjectModel();var i=this;r.getContextName=function(){return i.alias};this.setModel(r,this.alias);this.bindObject(this.alias+">/");r._mSettings=v(this._getPropertiesToPropagate());delete r._mSettings.models["$"+this.alias];delete r._mSettings.bindingContexts["$"+this.alias];this.setModel(null,this.alias);a.process(e.querySelector("*"),{},r._mSettings);var o={};o[t.getCompositeAggregationName()]=e;this._initCompositeSupport(o)};M.initialTemplating=function(t,e,r){var i=h(r),a=new o({}),n={_$error:a.getContext("/")},s=i.getMetadata(),g=s.getFragment(),p=s._mSpecialSettings.metadataContexts?s._mSpecialSettings.metadataContexts.defaultValue:"";if(!g){throw new Error("Fragment "+r+" not found")}y(n,e,t.getAttribute("metadataContexts"),p,i.prototype.defaultMetaModel);c(n,i.prototype.alias,t,i,e);var u=e["with"](n,true);A(t,s,u);u.visitChildNodes(g);var l=g.ownerDocument.createElementNS("http://schemas.sap.com/sapui5/extension/sap.ui.core.xmlcomposite/1",s.getCompositeAggregationName());l.appendChild(g);t.appendChild(l)};return M});