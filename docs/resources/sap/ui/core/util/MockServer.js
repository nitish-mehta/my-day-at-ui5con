/*
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/Device","sap/ui/base/ManagedObject","sap/ui/thirdparty/sinon","jquery.sap.sjax"],function(e,t,r,a){"use strict";if(t.browser.msie){e.sap.require("sap.ui.thirdparty.sinon-ie");if(!window.FormData){window.FormData=function(){}}}var s=r.extend("sap.ui.core.util.MockServer",{constructor:function(e,t,a){r.apply(this,arguments);s._aServers.push(this)},metadata:{properties:{rootUri:"string",recordRequests:{type:"boolean",defaultValue:true},requests:{type:"object[]",defaultValue:[]}}},_oServer:null,_aFilter:null,_oMockdata:null,_oMetadata:null,_sMetadataUrl:null,_sMockdataBaseUrl:null,_mEntitySets:null,_oErrorMessages:{INVALID_SYSTEM_QUERY_OPTION_VALUE:"Invalid system query options value",IS_NOT_A_VALID_SYSTEM_QUERY_OPTION:"## is not a valid system query option",URI_VIOLATING_CONSTRUCTION_RULES:"The URI is violating the construction rules defined in the Data Services specification",UNSUPPORTED_FORMAT_VALUE:"Unsupported format value. Only json format is supported",MALFORMED_SYNTAX:"The Data Services Request could not be understood due to malformed syntax",RESOURCE_NOT_FOUND:"Resource not found",INVALID_SORTORDER_DETECTED:"Invalid sortorder ## detected",PROPERTY_NOT_FOUND:"Property ## not found",INVALID_FILTER_QUERY_STATEMENT:"Invalid filter query statement",INVALID_FILTER_OPERATOR:"Invalid $filter operator ##",RESOURCE_NOT_FOUND_FOR_SEGMENT:"Resource not found for the segment ##",MALFORMED_URI_LITERAL_SYNTAX_IN_KEY:"Malformed URI literal syntax in key ##",INVALID_KEY_NAME:"Invalid key name in key predicate. Expected name is ##",INVALID_KEY_PREDICATE_QUANTITY:"Invalid key predicate. The quantity of provided keys does not match the expected value",INVALID_KEY_TYPE:"Invalid key predicate. The key literal for key property ## does not match its type."}});s.prototype._getPseudoRandomNumber=function(e){if(!this._iRandomSeed){this._iRandomSeed={}}if(!this._iRandomSeed.hasOwnProperty(e)){this._iRandomSeed[e]=0}this._iRandomSeed[e]=(this._iRandomSeed[e]+11)*25214903917%0xffffffffffff;return this._iRandomSeed[e]/0xffffffffffff};s.prototype.start=function(){this._oServer=s._getInstance();this._aFilters=[];var e=this.getRequests();var t=this;e.forEach(function(e){var r;if(t.getRecordRequests()===false&&e.response){r=function(){e.response.apply(this,arguments);t._oServer.requests=[]}}else{r=e.response}t._addRequestHandler(e.method,e.path,r)})};s.prototype.stop=function(){if(this.isStarted()){this._removeAllRequestHandlers();this._removeAllFilters();this._oServer=null}};s.prototype.attachBefore=function(e,t,r){r=r?r:"";this.attachEvent(e+r+":before",t)};s.prototype.attachAfter=function(e,t,r){r=r?r:"";this.attachEvent(e+r+":after",t)};s.prototype.detachBefore=function(e,t,r){r=r?r:"";this.detachEvent(e+r+":before",t)};s.prototype.detachAfter=function(e,t,r){r=r?r:"";this.detachEvent(e+r+":after",t)};s.prototype.isStarted=function(){return!!this._oServer};s.prototype.getEntitySetData=function(t){var r=this;var a;if(this._oMockdata&&this._oMockdata.hasOwnProperty(t)){a=e.extend(true,[],r._oMockdata[t])}else{e.sap.log.error("Unrecognized EntitySet name: "+t)}return a};s.prototype.setEntitySetData=function(t,r){if(this._oMockdata&&this._oMockdata.hasOwnProperty(t)){this._oMockdata[t]=r}else{e.sap.log.error("Unrecognized EntitySet name: "+t)}};s.prototype._applyQueryOnCollection=function(e,t,r,a){var s=t.split("=");var n=s[1];if(n===""){return}if(n.lastIndexOf(",")===n.length-1){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.URI_VIOLATING_CONSTRUCTION_RULES)}switch(s[0]){case"$top":if(!new RegExp(/^\d+$/).test(n)){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_SYSTEM_QUERY_OPTION_VALUE)}e.results=e.results.slice(0,n);break;case"$skip":if(!new RegExp(/^\d+$/).test(n)){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_SYSTEM_QUERY_OPTION_VALUE)}e.results=e.results.slice(n,e.results.length);break;case"$orderby":e.results=this._getOdataQueryOrderby(e.results,n,r);break;case"$filter":e.results=this._recursiveOdataQueryFilter(e.results,n);break;case"search-focus":break;case"search":var o="";for(var i=0;i<a.length;i++){if(a[i].indexOf("search-focus")!=-1){o=a[i].split("=")[1];break}}e.results=this._recursiveOdataQuerySearch(e.results,n,o,r);break;case"$select":e.results=this._getOdataQuerySelect(e.results,n,r);break;case"$inlinecount":var u=this._getOdataInlineCount(e.results,n);if(u){e.__count=u}break;case"$expand":e.results=this._getOdataQueryExpand(e.results,n,r);break;case"$format":e.results=this._getOdataQueryFormat(e.results,n);break;default:this._logAndThrowMockServerCustomError(400,this._oErrorMessages.IS_NOT_A_VALID_SYSTEM_QUERY_OPTION,s[0])}};s.prototype._applyQueryOnEntry=function(e,t,r){var a=t.split("=");var s=a[1];if(s===""){return}if(s.lastIndexOf(",")===s.length-1){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.URI_VIOLATING_CONSTRUCTION_RULES)}switch(a[0]){case"$filter":return this._recursiveOdataQueryFilter([e],s)[0];case"$select":return this._getOdataQuerySelect([e],s,r)[0];case"$expand":return this._getOdataQueryExpand([e],s,r)[0];case"$format":return this._getOdataQueryFormat([e],s);default:this._logAndThrowMockServerCustomError(400,this._oErrorMessages.IS_NOT_A_VALID_SYSTEM_QUERY_OPTION,a[0])}};s.prototype._getOdataQueryOrderby=function(t,r,a){var s=r.split(",");var n=this;e.each(s,function(e,t){s[e]=n._trim(t)});var o=function e(t,r){for(var o=0;o<s.length;o++){var i=s[o].split(" ");var u=1;if(i.length>1){switch(i[1]){case"asc":u=1;break;case"desc":u=-1;break;default:n._logAndThrowMockServerCustomError(400,n._oErrorMessages.INVALID_SORTORDER_DETECTED,i[1])}}var f,p;var l=i[0].indexOf("/");if(l!==-1){f=i[0].substring(l+1);p=i[0].substring(0,l);if(!t[p].hasOwnProperty(f)){var c=false;var d=[];if(p){var h=n._mEntitySets[a].navprops[p].to.entitySet;d=n._mEntityTypes[n._mEntitySets[h].type].properties;for(var o=0;o<d.length;o++){if(d[o].name===f){c=true;break}}}if(!c){n._logAndThrowMockServerCustomError(400,n._oErrorMessages.PROPERTY_NOT_FOUND,f)}}if(t[p][f]<r[p][f]){return-1*u}if(t[p][f]>r[p][f]){return 1*u}}else{f=i[0];if(!t.hasOwnProperty(f)){n._logAndThrowMockServerCustomError(400,n._oErrorMessages.PROPERTY_NOT_FOUND,f)}if(t[f]<r[f]){return-1*u}if(t[f]>r[f]){return 1*u}}}return 0};return t.sort(o)};s.prototype._arrayUnique=function(e){var t=e.concat();for(var r=0;r<t.length;++r){for(var a=r+1;a<t.length;++a){if(t[r]===t[a]){t.splice(a--,1)}}}return t};s.prototype._getBracketIndices=function(e){var t=[];var r=false;var a,s=0;for(var n=0;n<e.length;n++){if(e[n]==="("){if(/[substringof|endswith|startswith]$/.test(e.substring(0,n))){r=true}else{t.push(e[n]);if(a===undefined){a=n}}}else if(e[n]===")"){if(!r){t.pop();s=n;if(t.length===0){return{start:a,end:s}}}else{r=false}}}return{start:a,end:s}};s.prototype._recursiveOdataQueryFilter=function(e,t){var r=this._getBracketIndices(t);if(r.start===0&&r.end===t.length-1){t=this._trim(t.substring(r.start+1,r.end));return this._recursiveOdataQueryFilter(e,t)}var a=/([^substringof|endswith|startswith]|^)\((.*)\)/,s,n;var o;if(a.test(t)){var i=t.substring(r.start,r.end+1);var u=new RegExp("(.*) +(or|and) +("+this._trim(this._escapeStringForRegExp(i))+".*)");if(r.start===0){u=new RegExp("("+this._trim(this._escapeStringForRegExp(i))+") +(or|and) +(.*)")}var f=u.exec(t);if(f===null){t=t.replace(/[\(\)]/g,"");return this._getOdataQueryFilter(e,this._trim(t))}var p=f[1];o=f[2];var l=f[3];var c=this._recursiveOdataQueryFilter(e,p);if(o==="or"){s=this._recursiveOdataQueryFilter(e,l);return this._arrayUnique(c.concat(s))}if(o==="and"){return this._recursiveOdataQueryFilter(c,l)}}else{n=t.split(/ +and | or +/);if(n.length===1){if(t.match(/ +and | or +/)){throw new Error("400")}return this._getOdataQueryFilter(e,this._trim(t))}var d=this._recursiveOdataQueryFilter(e,n[0]);var h;for(var v=1;v<n.length;v++){h=new RegExp(this._trim(this._escapeStringForRegExp(n[v-1]))+" +(and|or) +"+this._trim(this._escapeStringForRegExp(n[v])));o=h.exec(t)[1];if(o==="or"){s=this._recursiveOdataQueryFilter(e,n[v]);d=this._arrayUnique(d.concat(s))}if(o==="and"){d=this._recursiveOdataQueryFilter(d,n[v])}}return d}};s.prototype._getOdataQueryFilter=function(t,r){if(t.length===0){return t}var a=new RegExp("(.*) (eq|ne|gt|lt|le|ge) (.*)");var s=new RegExp("(endswith|startswith|substringof)\\((.*)");var n=null;var o=a.exec(r);if(o){n=o[2]}else{o=s.exec(r);if(o){n=o[1]}else{this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_FILTER_QUERY_STATEMENT)}}var i=this;var u=function(s,n,o,u){var f,p,l;if(!s){f=a.exec(r);p=i._trim(f[n+1]);l=i._trim(f[o+1])}else{var c=new RegExp("(substringof|startswith|endswith)\\(([^\\)]*),(.*)\\)");f=c.exec(r);p=i._trim(f[n+2]);l=i._trim(f[o+2])}var d=p[p.length-1];if(d==="M"||d==="m"||d==="L"||d==="f"){p=p.substring(0,p.length-1)}if(p.indexOf("datetime")===0){p=i._getJsonDate(p)}else if(p.indexOf("guid")===0){p=p.substring(5,p.length-1)}else if(p==="true"){p=true}else if(p==="false"){p=false}else if(i._isValidNumber(p)){p=parseFloat(p)}else if(p.charAt(0)==="'"&&p.charAt(p.length-1)==="'"){p=p.substr(1,p.length-2)}var h=l.indexOf("/");if(h!==-1){var v=l.substring(h+1);var _=l.substring(0,h);if(t[0][_]){if(!t[0][_].hasOwnProperty(v)){var g=i._oErrorMessages.PROPERTY_NOT_FOUND.replace("##","'"+v+"'");e.sap.log.error("MockServer: navigation property '"+_+"' was not expanded, so "+g);return t}}else{i._logAndThrowMockServerCustomError(400,i._oErrorMessages.PROPERTY_NOT_FOUND,l)}return u(l,p,_,v)}else{if(!t[0].hasOwnProperty(l)){i._logAndThrowMockServerCustomError(400,i._oErrorMessages.PROPERTY_NOT_FOUND,l)}return u(l,p)}};switch(n){case"substringof":return u(true,0,1,function(e,r,a,s){return t.filter(function(t){if(a&&s){return typeof t[a][s]==="string"&&t[a][s].indexOf(r)!==-1}return typeof t[e]==="string"&&t[e].indexOf(r)!==-1})});case"startswith":return u(true,1,0,function(e,r,a,s){return t.filter(function(t){if(a&&s){return typeof t[a][s]==="string"&&t[a][s].indexOf(r)===0}return typeof t[e]==="string"&&t[e].indexOf(r)===0})});case"endswith":return u(true,1,0,function(e,r,a,s){return t.filter(function(t){if(a&&s){return typeof t[a][s]==="string"&&t[a][s].indexOf(r)===t[a][s].length-r.length}return typeof t[e]==="string"&&t[e].indexOf(r)===t[e].length-r.length})});case"eq":return u(false,2,0,function(e,r,a,s){return t.filter(function(t){if(a&&s){return t[a][s]===r}return t[e]===r})});case"ne":return u(false,2,0,function(e,r,a,s){return t.filter(function(t){if(a&&s){return t[a][s]!==r}return t[e]!==r})});case"gt":return u(false,2,0,function(e,r,a,s){return t.filter(function(t){if(a&&s){return t[a][s]>r}return t[e]>r})});case"lt":return u(false,2,0,function(e,r,a,s){return t.filter(function(t){if(a&&s){return t[a][s]<r}return t[e]<r})});case"ge":return u(false,2,0,function(e,r,a,s){return t.filter(function(t){if(a&&s){return t[a][s]>=r}return t[e]>=r})});case"le":return u(false,2,0,function(e,r,a,s){return t.filter(function(t){if(a&&s){return t[a][s]<=r}return t[e]<=r})});default:this._logAndThrowMockServerCustomError(400,i._oErrorMessages.INVALID_FILTER_OPERATOR,n)}};s.prototype._recursiveOdataQuerySearch=function(e,t,r,a){var s="";if(r==""||r==undefined){for(var n=0;n<this._mEntitySets[a].keys.length;n++){if(n!=0){s=s+" or "}s=s+"startswith("+this._mEntitySets[a].keys[n]+",'"+t+"')"}}else{s="substringof('"+t+"',"+r+")"}return this._recursiveOdataQueryFilter(e,s)};s.prototype._getOdataQuerySelect=function(t,r,a){var s=this;var n,o;var i=r.split(",");var u=[];var f;var p=t[0]?t[0][i[0].split("/")[0]]:null;if(!(p!=null&&p.results&&p.results.length>0)){var l=function(t,r,i,u){var f={};e.each(t,function(e,t){var r=t.indexOf("/");if(r!==-1){n=t.substring(r+1);o=t.substring(0,r);if(f[o]){f[o].push(n)}else{f[o]=[n]}}});e.each(Object.keys(f),function(e,t){if(!i[t]){i[t]={}}i[t]=l(f[t],r[t],i[t],t)});if(r.results){var p=[];e.each(r.results,function(r,a){var s={};e.each(t,function(e,t){s[t]=a[t]});p.push(s)});if(i){i.results=p}}else{if(r["__metadata"]){i["__metadata"]=r["__metadata"]}e.each(t,function(e,t){var n=t.indexOf("/");if(n===-1){if(r&&!r.hasOwnProperty(t)){var o=false;var f=[];if(u){var p=s._mEntitySets[a].navprops[u].to.entitySet;f=s._mEntityTypes[s._mEntitySets[p].type].properties;for(var e=0;e<f.length;e++){if(f[e].name===t){o=true;break}}}if(!o){s._logAndThrowMockServerCustomError(404,s._oErrorMessages.RESOURCE_NOT_FOUND_FOR_SEGMENT,t)}}i[t]=r[t]}})}return i};if(e.inArray("*",i)!==-1){return t}e.each(i,function(e,t){i[e]=s._trim(t)});e.each(t,function(e,t){f={};u.push(l(i,t,f))})}else{var c=function(e,t,r){var a={};r=r||"";if(typeof e!=="object"){return e}if(typeof e.slice==="function"){return e.map(function(e,a){return c(e,t,r)})}if(e.__metadata!==undefined&&r.length===0){a.__metadata=e.__metadata}t.filter(function(e){return(e+"/").indexOf(r)===0}).forEach(function(t,s,n){var o=t.substr(r.length).split("/")[0];if(e[o]!==undefined){a[o]=c(e[o],n,r+o+"/")}});if(e.results!==undefined){a.results=c(e.results,t,r)}return a};u=c(t,i)}return u};s.prototype._getOdataInlineCount=function(e,t){var r=t.split(",");if(r.length!==1||r[0]!=="none"&&r[0]!=="allpages"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_SYSTEM_QUERY_OPTION_VALUE)}if(r[0]==="none"){return}return e.length};s.prototype._getOdataQueryFormat=function(e,t){if(t!=="json"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.UNSUPPORTED_FORMAT_VALUE)}return e};s.prototype._getOdataQueryExpand=function(t,r,a){var s=this;var n=r.split(",");e.each(n,function(e,t){n[e]=s._trim(t)});var o=s._mEntitySets[a].navprops;e.each(t,function(t,r){e.each(n,function(t,n){var i=n.split("/");var u=i[0];if(!r[u]){s._logAndThrowMockServerCustomError(404,s._oErrorMessages.RESOURCE_NOT_FOUND_FOR_SEGMENT,u)}var f=r[u].results||r[u];if(!f||!!f.__deferred){f=e.extend(true,[],s._resolveNavigation(a,r,u,r))}else if(!e.isArray(f)){f=[f]}if(!!f&&i.length>1){var p=i.splice(1,i.length).join("/");f=s._getOdataQueryExpand(f,p,o[u].to.entitySet)}if(o[u].to.multiplicity==="*"){r[u]={results:f}}else{r[u]=f[0]?f[0]:{}}})});return t};s.prototype._refreshData=function(){var t=this._loadMetadata(this._sMetadataString);if(!t){return}this._mEntitySets=this._findEntitySets(this._oMetadata);this._mEntityTypes=this._findEntityTypes(this._oMetadata);if(!this._sMockdataBaseUrl){this._generateMockdata(this._mEntitySets,this._oMetadata)}else{if(!e.sap.endsWith(this._sMockdataBaseUrl,"/")&&!e.sap.endsWith(this._sMockdataBaseUrl,".json")){this._sMockdataBaseUrl+="/"}this._loadMockdata(this._mEntitySets,this._sMockdataBaseUrl)}};s.prototype._getRootUri=function(){var e=this.getRootUri();e=e&&/([^?#]*)([?#].*)?/.exec(e)[1];return e};s.prototype._loadMetadata=function(t){var t;t=t.trim();if(t.substring(0,1)!=="<"){t=e.sap.sjax({url:t,dataType:"text"}).data;if(!t){e.sap.log.error('MockServer: The metadata for url "'+t+'" could not be found!')}}this._sMetadata=t;try{this._oMetadata=e.parseXML(t)}catch(t){e.sap.log.error("MockServer: Invalid metadata XML! Reason: "+t)}return this._oMetadata};s.prototype._findEntitySets=function(t){var r={};var a=e(t).find("Principal");var s=e(t).find("Dependent");e(t).find("EntitySet").each(function(t,a){var s=e(a);var n=/((.*)\.)?(.*)/.exec(s.attr("EntityType"));r[s.attr("Name")]={name:s.attr("Name"),schema:n[2],type:n[3],keys:[],keysType:{},navprops:{}}});var n=function(t,r,n,o){var i=e(n).find("End[Role='"+t+"']").attr("EntitySet");var u=e(r).find("End[Role='"+t+"']").attr("Multiplicity");var f=[];var p=e(r).find("ReferentialConstraint > [Role='"+t+"']");if(p&&p.length>0){e(p[0]).children("PropertyRef").each(function(t,r){f.push(e(r).attr("Name"))})}else{var l=o?a:s;e(l).each(function(r,a){if(t===e(a).attr("Role")){e(a).children("PropertyRef").each(function(t,r){f.push(e(r).attr("Name"))});return false}})}return{role:t,entitySet:i,propRef:f,multiplicity:u}};e.each(r,function(r,a){var s=e(t).find("EntityType[Name='"+a.type+"']");var o=e(s).find("PropertyRef");e.each(o,function(t,r){var n=e(r).attr("Name");a.keys.push(n);a.keysType[n]=e(s).find("Property[Name='"+n+"']").attr("Type")});var i=e(t).find("EntityType[Name='"+a.type+"'] NavigationProperty");e.each(i,function(r,s){var o=e(s);var i=o.attr("Relationship").split(".");var u=e(t).find("AssociationSet[Association = '"+i.join(".")+"']");var f=i.pop();var p=e(t).find("Association[Name = '"+f+"']");a.navprops[o.attr("Name")]={name:o.attr("Name"),from:n(o.attr("FromRole"),p,u,true),to:n(o.attr("ToRole"),p,u,false)}})});return r};s.prototype._findEntityTypes=function(t){var r={};e(t).find("EntityType").each(function(t,a){var s=e(a);r[s.attr("Name")]={name:s.attr("Name"),properties:[],keys:[]};s.find("Property").each(function(t,a){var n=e(a);var o=n.attr("Type");r[s.attr("Name")].properties.push({schema:o.substring(0,o.lastIndexOf(".")),type:o.substring(o.lastIndexOf(".")+1),name:n.attr("Name"),precision:n.attr("Precision"),scale:n.attr("Scale")})});s.find("PropertyRef").each(function(t,a){var n=e(a);var o=n.attr("Name");r[s.attr("Name")].keys.push(o)})});return r};s.prototype._findComplexTypes=function(t){var r={};e(t).find("ComplexType").each(function(t,a){var s=e(a);r[s.attr("Name")]={name:s.attr("Name"),properties:[]};s.find("Property").each(function(t,a){var n=e(a);var o=n.attr("Type");r[s.attr("Name")].properties.push({schema:o.substring(0,o.lastIndexOf(".")),type:o.substring(o.lastIndexOf(".")+1),name:n.attr("Name"),precision:n.attr("Precision"),scale:n.attr("Scale")})})});return r};s.prototype._createKeysString=function(t,r){var a=this;var s="";if(r){e.each(t.keys,function(e,n){if(s){s+=","}var o=r[n];if(t.keysType[n]==="Edm.String"){o=encodeURIComponent("'"+o+"'")}else if(t.keysType[n]==="Edm.DateTime"){o=a._getDateTime(o);o=encodeURIComponent(o)}else if(t.keysType[n]==="Edm.Guid"){o="guid'"+o+"'"}if(t.keys.length===1){s+=o;return s}s+=n+"="+o})}return s};s.prototype._loadMockdata=function(t,r){var a=this,s={};this._oMockdata={};var n=function(t,r){var a=e.sap.sjax({url:t,dataType:"json"});if(a.success){if(a.data.d){if(a.data.d.results){s[r.name]=a.data.d.results}else{e.sap.log.error('The mock data format for entity set "'+r.name+'" invalid')}}else{if(e.isArray(a.data)){s[r.name]=a.data}else{e.sap.log.error('The mock data for entity set "'+r.name+'" could not be loaded due to wrong format!');return false}}return true}else{if(a.status==="parsererror"){e.sap.log.error('The mock data for entity set "'+r.name+'" could not be loaded due to a parsing error!')}return false}};if(e.sap.endsWith(r,".json")){var o=e.sap.sjax({url:r,dataType:"json"});if(o.success){s=o.data}else{e.sap.log.warning('The mock data for all the entity types could not be found at "'+r+'"!')}}else{var i={};if(a._aEntitySetsNames&&a._aEntitySetsNames.length>0){var u;for(var f=0;f<a._aEntitySetsNames.length;f++){u=a._aEntitySetsNames[f];if(t[u]){i[u]=t[u]}}}else{i=t}e.each(i,function(t,o){if(!s[o.type]||!s[o.name]){var i=r+o.name+".json";if(!n(i,o)){e.sap.log.warning('The mock data for entity set "'+o.name+'" could not be found at "'+r+'"!');var u=r+o.type+".json";if(!n(u,o)){e.sap.log.warning('The mock data for entity type "'+o.type+'" could not be found at "'+r+'"!');if(a._bGenerateMissingMockData){var f={};f[o.name]=o;s[o.type]=a._generateODataMockdataForEntitySet(f,a._oMetadata)[o.name]}}}}})}e.each(t,function(t,r){a._oMockdata[t]=[];if(s[r.name]){e.each(s[r.name],function(r,s){a._oMockdata[t].push(e.extend(true,{},s))})}else if(s[r.type]){e.each(s[r.type],function(r,s){a._oMockdata[t].push(e.extend(true,{},s))})}});e.each(t,function(e,t){if(a._oMockdata[e].length>0){a._enhanceWithMetadata(t,a._oMockdata[e])}});return this._oMockdata};s.prototype._enhanceWithMetadata=function(t,r){if(r){var a=this,s=this._getRootUri(),n=t&&t.name;e.each(r,function(r,o){o.__metadata=o.__metadata||{};o.__metadata.id=s+n+"("+a._createKeysString(t,o)+")";o.__metadata.type=t.schema+"."+t.type;o.__metadata.uri=s+n+"("+a._createKeysString(t,o)+")";e.each(t.navprops,function(r,i){if(o[r]&&!e.isEmptyObject(o[r])&&!o[r]["__deferred"]){a._oMockdata[i.to.entitySet]=a._oMockdata[i.to.entitySet].concat(o[r])}o[r]={__deferred:{uri:s+n+"("+a._createKeysString(t,o)+")/"+r}}})})}};s.prototype._isRequestedKeysValid=function(e,t){if(t.length===1){var r=t[0].split("=");if(this._trim(r[0])!==e.keys[0]){t=[e.keys[0]+"="+t[0]]}}for(var a=0;a<t.length;a++){var s=this._trim(t[a].substring(0,t[a].indexOf("=")));var n=this._trim(t[a].substring(t[a].indexOf("=")+1));var o=n.charAt(0);var i=n.charAt(n.length-1);if(e.keysType[s]==="Edm.String"){if(o!=="'"||i!=="'"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,s)}}else if(e.keysType[s]==="Edm.DateTime"){if(o==="'"||i!=="'"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,s)}}else if(e.keysType[s]==="Edm.Guid"){if(o==="'"||i!=="'"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,s)}}else if(e.keysType[s]==="Edm.Binary"){if(!new RegExp("(binary|X)'[A-Fa-f0-9][A-Fa-f0-9]*'").test(n)){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,s)}}else{if(o==="'"&&i!=="'"||i==="'"&&o!=="'"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,s)}}var u=e.keys.join(",");if(e.keys.indexOf(s)===-1){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_KEY_NAME,u)}}};s.prototype._parseKeys=function(e,t){var r={};var a=e.split(",");var s,n,o;for(var i=0;i<a.length;i++){o=a[i].split("=");if(o.length===1&&t.keys.length===1){s=t.keys[0];n=o[0]}else{if(o.length===2){s=o[0];n=o[1]}}r[s]=n;switch(t.keysType[s]){case"Edm.String":r[s]=r[s].replace(/^\'|\'$/g,"");break;case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":case"Edm.Decimal":case"Edm.Byte":case"Edm.Double":case"Edm.Single":case"Edm.SByte":r[s]=parseFloat(r[s]);break;case"Edm.Guid":r[s]=r[s].replace(/^guid\'|\'$/g,"");break;case"Edm.Boolean":case"Edm.Binary":case"Edm.DateTimeOffset":default:r[s]=r[s]}}return r};s.prototype._generatePropertyValue=function(e,t,r,a){var s=a;if(!s){s=Math.floor(this._getPseudoRandomNumber("String")*1e4)+101}switch(t){case"String":return e+" "+s;case"DateTime":var n=new Date;n.setFullYear(2e3+Math.floor(this._getPseudoRandomNumber("DateTime")*20));n.setDate(Math.floor(this._getPseudoRandomNumber("DateTime")*30));n.setMonth(Math.floor(this._getPseudoRandomNumber("DateTime")*12));n.setMilliseconds(0);return"/Date("+n.getTime()+")/";case"Int16":case"Int32":case"Int64":return Math.floor(this._getPseudoRandomNumber("Int")*1e4);case"Decimal":return Math.floor(this._getPseudoRandomNumber("Decimal")*1e6)/100;case"Boolean":return this._getPseudoRandomNumber("Boolean")<.5;case"Byte":return Math.floor(this._getPseudoRandomNumber("Byte")*10);case"Double":return this._getPseudoRandomNumber("Double")*10;case"Single":return this._getPseudoRandomNumber("Single")*1e9;case"SByte":return Math.floor(this._getPseudoRandomNumber("SByte")*10);case"Time":return"PT"+Math.floor(this._getPseudoRandomNumber("Time")*23)+"H"+Math.floor(this._getPseudoRandomNumber("Time")*59)+"M"+Math.floor(this._getPseudoRandomNumber("Time")*59)+"S";case"Guid":return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=this._getPseudoRandomNumber("Guid")*16|0,r=e==="x"?t:t&3|8;return r.toString(16)}.bind(this));case"Binary":var o=Math.floor(-2147483648+this._getPseudoRandomNumber("Binary")*4294967295),i="";for(var u=0,f=o;u<32;u++,i+=String(f>>>31),f<<=1);return i;case"DateTimeOffset":var n=new Date;n.setFullYear(2e3+Math.floor(this._getPseudoRandomNumber("DateTimeOffset")*20));n.setDate(Math.floor(this._getPseudoRandomNumber("DateTimeOffset")*30));n.setMonth(Math.floor(this._getPseudoRandomNumber("DateTimeOffset")*12));n.setMilliseconds(0);return"/Date("+n.getTime()+"+0000)/";default:return this._generateDataFromEntity(r[t],s,r)}};s.prototype._isFalseyValue=function(e,t,r){switch(r){case"Edm.String":return e==="";case"Edm.Boolean":return e===false;case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":case"Edm.Decimal":case"Edm.Byte":case"Edm.Double":case"Edm.Single":case"Edm.SByte":return e===0||isNaN(e);default:return false}};s.prototype._completeKey=function(e,t,r){if(r){for(var a=0;a<e.keys.length;a++){var s=e.keys[a];if(t[s]!==undefined&&t[s]!==null){if(!r[s]){switch(e.keysType[s]){case"Edm.DateTime":r[s]=this._getJsonDate(t[s]);break;case"Edm.Guid":r[s]=t[s].replace(/^guid\'|\'$/g,"");break;default:r[s]=t[s]}}}else{if(!r[s]){r[s]=this._generatePropertyValue(s,e.keysType[s].substring(e.keysType[s].lastIndexOf(".")+1))}}}}};s.prototype._generateDataFromEntity=function(e,t,r){var a={};if(!e){return a}for(var s=0;s<e.properties.length;s++){var n=e.properties[s];a[n.name]=this._generatePropertyValue(n.name,n.type,r,t)}return a};s.prototype._generateDataFromEntitySet=function(e,t,r){var a=t[e.type];var s=[];for(var n=0;n<100;n++){s.push(this._generateDataFromEntity(a,n+1,r))}return s};s.prototype._generateMockdata=function(t,r){var a=this;var s={};var n=this._getRootUri();e.each(t,function(e,t){var n={};n[t.name]=t;s[e]=a._generateODataMockdataForEntitySet(n,r)[e]});e.each(t,function(t,r){for(var o in r.navprops){var i=r.navprops[o];var u=i.from.propRef.length;for(var f=0;f<u;f++){for(var p=0;p<s[t].length;p++){var l=s[t][p];s[i.to.entitySet][p][i.to.propRef[f]]=l[i.from.propRef[f]]}}}e.each(s[t],function(s,o){o.__metadata={uri:n+t+"("+a._createKeysString(r,o)+")",type:r.schema+"."+r.type};e.each(r.navprops,function(e,s){o[e]={__deferred:{uri:n+t+"("+a._createKeysString(r,o)+")/"+e}}})})});this._oMockdata=s};s.prototype._generateODataMockdataForEntitySet=function(t,r){var a=this,s={};var n=this._findEntityTypes(r);var o=this._findComplexTypes(r);e.each(t,function(e,t){s[e]=a._generateDataFromEntitySet(t,n,o)});return s};s.prototype._resolveNavigation=function(t,r,a){var s=this._mEntitySets[t];var n=s.navprops[a];if(!n){this._logAndThrowMockServerCustomError(404,this._oErrorMessages.RESOURCE_NOT_FOUND)}var o=[];var i=n.from.propRef.length;if(i===0){if(n.to.multiplicity==="*"){return this._oMockdata[n.to.entitySet]}else{o.push(this._oMockdata[n.to.entitySet][0]);return o}}e.each(this._oMockdata[n.to.entitySet],function(e,t){var a=true;for(var s=0;s<i;s++){if(r[n.from.propRef[s]]!==t[n.to.propRef[s]]){a=false;break}}if(a){o.push(t)}});return o};s.prototype.simulate=function(t,r){var a=this;this._sMetadataString=t;if(!r||typeof r==="string"){this._sMockdataBaseUrl=r}else{this._sMockdataBaseUrl=r.sMockdataBaseUrl;this._bGenerateMissingMockData=r.bGenerateMissingMockData;this._aEntitySetsNames=r.aEntitySetsNames}var n=this._loadMetadata(this._sMetadataString);if(!n){return}if(this._sMetadata){var o=sap.ui.requireSync("sap/ui/core/util/MockServerAnnotationsHandler");var i=o.parse(this._oMetadata,this._sMetadata);var u=sap.ui.requireSync("sap/ui/core/util/DraftEnabledMockServer");u.handleDraft(i,this)}this._refreshData();var f=function(e,t){if(e.requestHeaders["x-csrf-token"]==="Fetch"){t["X-CSRF-Token"]="42424242424242424242424242424242"}};var p=function(t,r){r=decodeURIComponent(r);var s;var n=a._mEntitySets[t];var o=n.keys;var i=r.split(",");if(i.length!==o.length){a._logAndThrowMockServerCustomError(400,a._oErrorMessages.INVALID_KEY_PREDICATE_QUANTITY)}a._isRequestedKeysValid(n,i);if(i.length===1&&!i[0].split("=")[1]){i=[o[0]+"="+i[0]]}e.each(a._oMockdata[t],function(t,r){for(var u=0;u<i.length;u++){var f=i[u].split("=");var p=a._trim(f[0]);if(e.inArray(p,o)===-1){return true}var l=a._trim(f[1]);var c=r[p];switch(n.keysType[p]){case"Edm.String":l=l.replace(/^\'|\'$/g,"");break;case"Edm.Time":case"Edm.DateTime":c=a._getDateTime(c);break;case"Edm.Int16":case"Edm.Int32":case"Edm.Decimal":case"Edm.Byte":case"Edm.Double":case"Edm.Single":case"Edm.SByte":if(!a._isValidNumber(l)){return false}l=parseFloat(l);break;case"Edm.Guid":l=l.replace(/^guid\'|\'$/g,"");break;case"Edm.Boolean":if(["true","false"].indexOf(l)===-1){a._logAndThrowMockServerCustomError(400,a._oErrorMessages.INVALID_KEY_TYPE,p)}l=l==="true";break;case"Edm.Binary":case"Edm.DateTimeOffset":default:l=l}if(c!==l){return true}}s={index:t,entry:r};return false});return s};var l=function(e,t,r){var a=e.name;var s;if(r){s=e.navprops[r]}if(s){a=s.to.entitySet}return a};var c=function(e){var t=[];var r=function(e){var t=e.indexOf("'");var r=e.indexOf('"');if(t===-1&&r===-1){return null}else{if(t>-1&&r===-1){return"appost"}if(r>-1&&t===-1){return"doublequotes"}if(t>-1&&r>-1&&t<r){return"appost"}if(t>-1&&r>-1&&r<t){return"doublequotes"}}};var a=function(e,t,r,a){var s=e[r];var n=r+1;while(n<e.length&&e[n].indexOf(a)===-1){s=s+"&"+e[n];n++}s=s+"&"+e[n];t.push(s);r=n;return r};for(var s=0;s<e.length;s++){if(!r(e[s])){t.push(e[s])}if(r(e[s])==="appost"){var n=e[s].indexOf("'");if(e[s].indexOf("'",n+1)===-1){s=a(e,t,s,"'")}else{t.push(e[s])}}if(r(e[s])==="doublequotes"){var o=e[s].indexOf('"');if(e[s].indexOf('"',o+1)===-1){s=a(e,t,s,'"')}else{t.push(e[s])}}}return t};var d=function(e,t,r,s){r=r?decodeURIComponent(r):r;var n=JSON.parse(e.requestBody);if(n){var o={};if(r){o=a._parseKeys(r,a._mEntitySets[t])}a._completeKey(a._mEntitySets[t],o,n);a._enhanceWithMetadata(a._mEntitySets[t],[n]);return n}return null};var h=[];h.push({method:"GET",path:new RegExp("\\$metadata([?#].*)?"),response:function(t){e.sap.require("jquery.sap.xml");e.sap.log.debug("MockServer: incoming request for url: "+t.url);var r={"Content-Type":"application/xml;charset=utf-8"};f(t,r);t.respond(200,r,a._sMetadata);e.sap.log.debug("MockServer: response sent with: 200, "+a._sMetadata);return true}});h.push({method:"HEAD",path:new RegExp("$"),response:function(t){e.sap.log.debug("MockServer: incoming request for url: "+t.url);var r={"Content-Type":"application/json;charset=utf-8"};f(t,r);t.respond(200,r);e.sap.log.debug("MockServer: response sent with: 200");return true}});h.push({method:"GET",path:new RegExp("$"),response:function(t){e.sap.log.debug("MockServer: incoming request for url: "+t.url);var r={"Content-Type":"application/json;charset=utf-8"};f(t,r);var s=[];e.each(a._mEntitySets,function(e,t){s.push(e)});var n={EntitySets:s};t.respond(200,r,JSON.stringify({d:n}));e.sap.log.debug("MockServer: response sent with: 200, "+JSON.stringify({d:n}));return true}});h.push({method:"POST",path:new RegExp("\\$batch([?#].*)?"),response:function(t){e.sap.log.debug("MockServer: incoming request for url: "+t.url);var r=function(e){switch(e.statusCode){case 200:return"200 OK";case 201:return"201 Created";case 204:return"204 No Content";case 400:return"400 Bad Request";case 401:return"401 Unauthorized";case 403:return"403 Forbidden";case 404:return"404 Not Found";case 405:return"405 Method Not Allowed";case 409:return"409 Conflict";case 412:return"412 Precondition Failed";case 415:return"415 Unsupported Media Type";case 500:return"500 Internal Server Error";case 501:return"501 Not Implemented";case 503:return"503 Service Unavailable";default:return e.statusCode+" "+e.status}};var s=function(e,t){var a;if(e.success){a=JSON.stringify(e.data)||""}else{a=e.errorResponse}t=t||"application/json";if(e.responseHeaders){return"HTTP/1.1 "+r(e)+"\r\n"+e.responseHeaders+"dataserviceversion: 2.0\r\n\r\n"+a+"\r\n"}else{return"HTTP/1.1 "+r(e)+"\r\nContent-Type: "+t+"\r\nContent-Length: "+a.length+"\r\ndataserviceversion: 2.0\r\n\r\n"+a+"\r\n"}};var n=function(t,r,a,n){var o;var i=function(e,t,r){o={success:true,data:e,status:t,statusCode:r&&r.status,responseHeaders:r&&r.getAllResponseHeaders()}};var u=function(e,t,r){o={success:false,data:undefined,status:t,error:r,statusCode:e.status,errorResponse:e.responseText,responseHeaders:e&&e.getAllResponseHeaders()}};e.ajax({type:a,async:false,url:t,data:r,dataType:"json",success:i,error:u});if(o.statusCode===400||o.statusCode===404){var f=s(o);throw new Error(f)}n.push(s(o))};var o=function(t,r){var a;var n;var o=function(e,t,r){a={success:true,data:e,status:t,statusCode:r&&r.status,responseHeaders:r&&r.getAllResponseHeaders()}};var i=function(e,t,r){a={success:false,data:undefined,status:t,error:r,statusCode:e.status,errorResponse:e.responseText,responseHeaders:e&&e.getAllResponseHeaders()}};e.ajax({async:false,url:t,dataType:"json",success:o,error:i});var n;if(t.indexOf("$count")!==-1){n=s(a,"text/plain")}else{n=s(a)}r.push("\r\nContent-Type: application/http\r\n"+"Content-Length: "+n.length+"\r\n"+"content-transfer-encoding: binary\r\n\r\n"+n)};var i=t.requestBody;var u=new RegExp("--batch_[a-z0-9-]*");var p=u.exec(i)[0];if(!!p){var l=[];var c=i.split(p);var d=t.url.split("$")[0];var h=new RegExp("PUT (.*) HTTP");var v=new RegExp("MERGE (.*) HTTP");var _=new RegExp("POST (.*) HTTP");var g=new RegExp("DELETE (.*) HTTP");var y=new RegExp("GET (.*) HTTP");for(var E=1;E<c.length-1;E++){var m=c[E];if(y.test(m)&&m.indexOf("multipart/mixed")===-1){if(h.test(m)||_.test(m)||g.test(m)){t.respond(400,null,"The Data Services Request could not be understood due to malformed syntax");e.sap.log.debug("MockServer: response sent with: 400");return true}o(d+y.exec(m)[1],l)}else{var T=e.extend(true,{},a._oMockdata);var S=[];var M=m.substring(m.indexOf("boundary=")+9,m.indexOf("\r\n\r\n"));var O=m.split("--"+M);try{for(var R=1;R<O.length-1;R++){var k=O[R];var b;if(y.test(k)){a._oMockdata=T;t.respond(400,null,"The Data Services Request could not be understood due to malformed syntax");e.sap.log.debug("MockServer: response sent with: 400");return}else if(h.test(k)){b=k.substring(k.indexOf("{"),k.lastIndexOf("}")+1);n(d+h.exec(k)[1],b,"PUT",S)}else if(v.test(k)){b=k.substring(k.indexOf("{"),k.lastIndexOf("}")+1);n(d+v.exec(k)[1],b,"MERGE",S)}else if(_.test(k)){b=k.substring(k.indexOf("{"),k.lastIndexOf("}")+1);n(d+_.exec(k)[1],b,"POST",S)}else if(g.test(k)){n(d+g.exec(k)[1],b,"DELETE",S)}}var x="\r\nContent-Type: multipart/mixed; boundary=ejjeeffe1\r\n\r\n--ejjeeffe1";for(var N=0;N<S.length;N++){x+="\r\nContent-Type: application/http\r\n"+"Content-Length: "+S[N].length+"\r\n"+"content-transfer-encoding: binary\r\n\r\n"+S[N]+"--ejjeeffe1"}x+="--\r\n";l.push(x)}catch(e){a._oMockdata=T;var D="\r\nContent-Type: application/http\r\n"+"Content-Length: "+e.message.length+"\r\n"+"content-transfer-encoding: binary\r\n\r\n"+e.message;l.push(D)}}}var P="--ejjeeffe0";for(var w=0;w<l.length;w++){P+=l[w]+"--ejjeeffe0"}P+="--";var I={"Content-Type":"multipart/mixed; boundary=ejjeeffe0"};f(t,I);t.respond(202,I,P);e.sap.log.debug("MockServer: response sent with: 202, "+P)}else{t.respond(202)}return true}});e.each(this._mEntitySets,function(t,r){h.push({method:"GET",path:new RegExp("("+t+")/\\$count/?(.*)?"),response:function(t,r,n){e.sap.log.debug("MockServer: incoming request for url: "+t.url);a.fireEvent(s.HTTPMETHOD.GET+r+":before",{oXhr:t,sUrlParams:n});a.fireEvent(s.HTTPMETHOD.GET+":before",{oXhr:t,sUrlParams:n});var o={"Content-Type":"text/plain;charset=utf-8"};f(t,o);try{var i=a._oMockdata[r];if(i){var u={results:e.extend(true,[],i)};if(n){var p=decodeURIComponent(n).replace("?","&").split("&");p=c(p);if(p.length>1){p=a._orderQueryOptions(p)}e.each(p,function(e,t){a._applyQueryOnCollection(u,t,r,p)})}a.fireEvent(s.HTTPMETHOD.GET+r+":after",{oXhr:t,oFilteredData:u});a.fireEvent(s.HTTPMETHOD.GET+":after",{oXhr:t,oFilteredData:u});t.respond(200,o,""+u.results.length);e.sap.log.debug("MockServer: response sent with: 200, "+u.results.length)}else{a._logAndThrowMockServerCustomError(404,a._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(r){if(r.error){t.respond(r.error.code,o,JSON.stringify(r))}else{e.sap.log.error("MockServer: request failed due to invalid system query options value!");t.respond(parseInt(r.message||r.number,10))}}return true}});h.push({method:"GET",path:new RegExp("("+t+")/?(\\?(.*))?"),response:function(t,r,n){e.sap.log.debug("MockServer: incoming request for url: "+t.url);a.fireEvent(s.HTTPMETHOD.GET+r+":before",{oXhr:t,sUrlParams:n});a.fireEvent(s.HTTPMETHOD.GET+":before",{oXhr:t,sUrlParams:n});var o={"Content-Type":"application/json;charset=utf-8"};f(t,o);try{var i=a._oMockdata[r];if(i){var u={results:e.extend(true,[],i)};if(n){var p=decodeURIComponent(n).replace("?","&").split("&");p=c(p);if(p.length>1){p=a._orderQueryOptions(p)}e.each(p,function(e,t){a._applyQueryOnCollection(u,t,r,p)})}a.fireEvent(s.HTTPMETHOD.GET+r+":after",{oXhr:t,oFilteredData:u});a.fireEvent(s.HTTPMETHOD.GET+":after",{oXhr:t,oFilteredData:u});t.respond(200,o,JSON.stringify({d:u}));e.sap.log.debug("MockServer: response sent with: 200, "+JSON.stringify({d:u}))}else{a._logAndThrowMockServerCustomError(404,a._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(r){if(r.error){t.respond(r.error.code,o,JSON.stringify(r))}else{e.sap.log.debug("MockServer: response sent with: "+parseInt(r.message||r.number,10));t.respond(parseInt(r.message||r.number,10))}}return true}});h.push({method:"GET",path:new RegExp("("+t+")\\(([^/\\?#]+)\\)/?(\\?(.*))?"),response:function(t,r,n,o){e.sap.log.debug("MockServer: incoming request for url: "+t.url);a.fireEvent(s.HTTPMETHOD.GET+r+":before",{oXhr:t,sKeys:n,sUrlParams:o});a.fireEvent(s.HTTPMETHOD.GET+":before",{oXhr:t,sKeys:n,sUrlParams:o});var i={"Content-Type":"application/json;charset=utf-8"};try{var u=e.extend(true,{},p(r,n));if(!e.isEmptyObject(u)){if(o){var f=decodeURIComponent(o).replace("?","&").split("&");f=c(f);if(f.length>1){f=a._orderQueryOptions(f)}e.each(f,function(e,t){u.entry=a._applyQueryOnEntry(u.entry,t,r)})}a.fireEvent(s.HTTPMETHOD.GET+r+":after",{oXhr:t,oEntry:u.entry});a.fireEvent(s.HTTPMETHOD.GET+":after",{oXhr:t,oEntry:u.entry});t.respond(200,i,JSON.stringify({d:u.entry}));e.sap.log.debug("MockServer: response sent with: 200, "+JSON.stringify({d:u.entry}))}else{a._logAndThrowMockServerCustomError(404,a._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(r){if(r.error){t.respond(r.error.code,i,JSON.stringify(r))}else{e.sap.log.debug("MockServer: response sent with: "+parseInt(r.message||r.number,10));t.respond(parseInt(r.message||r.number,10))}}return true}});e.each(r.navprops,function(r,n){h.push({method:"GET",path:new RegExp("("+t+")\\(([^/\\?#]+)\\)/("+r+")/\\$count/?(.*)?"),response:function(t,r,n,o,i){e.sap.log.debug("MockServer: incoming request for url: "+t.url);a.fireEvent(s.HTTPMETHOD.GET+r+":before",{oXhr:t,sKeys:n,sNavProp:o,sUrlParams:i});a.fireEvent(s.HTTPMETHOD.GET+":before",{oXhr:t,sKeys:n,sNavProp:o,sUrlParams:i});var u={"Content-Type":"text/plain;charset=utf-8"};f(t,u);try{var l=p(r,n);if(l){var d,h={};d=a._resolveNavigation(r,l.entry,o);var v=a._mEntitySets[r].navprops[o].to.multiplicity;if(v==="*"){h={results:e.extend(true,[],d)}}else{h=e.extend(true,{},d[0])}if(d&&d.length!==0){if(i){var _=decodeURIComponent(i).replace("?","&").split("&");_=c(_);if(_.length>1){_=a._orderQueryOptions(_)}if(v==="*"){e.each(_,function(e,t){a._applyQueryOnCollection(h,t,a._mEntitySets[r].navprops[o].to.entitySet,_)})}else{e.each(_,function(e,t){h=a._applyQueryOnEntry(h,t,a._mEntitySets[r].navprops[o].to.entitySet)})}}}a.fireEvent(s.HTTPMETHOD.GET+r+":after",{oXhr:t,oFilteredData:h});a.fireEvent(s.HTTPMETHOD.GET+":after",{oXhr:t,oFilteredData:h});h.results=h.results||[];t.respond(200,u,""+h.results.length);e.sap.log.debug("MockServer: response sent with: 200, "+h.results.length)}else{a._logAndThrowMockServerCustomError(404,a._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(r){if(r.error){t.respond(r.error.code,u,JSON.stringify(r))}else{e.sap.log.debug("MockServer: response sent with: "+parseInt(r.message||r.number,10));t.respond(parseInt(r.message||r.number,10))}}return true}});h.push({method:"GET",path:new RegExp("("+t+")\\(([^/\\?#]+)\\)/("+r+")/?(\\?(.*))?"),response:function(t,r,n,o,i){e.sap.log.debug("MockServer: incoming request for url: "+t.url);a.fireEvent(s.HTTPMETHOD.GET+r+":before",{oXhr:t,sKeys:n,sNavProp:o,sUrlParams:i});a.fireEvent(s.HTTPMETHOD.GET+":before",{oXhr:t,sKeys:n,sNavProp:o,sUrlParams:i});var u={"Content-Type":"application/json;charset=utf-8"};f(t,u);try{var l=p(r,n);if(l){var d,h={};d=a._resolveNavigation(r,l.entry,o,l.entry);var v=a._mEntitySets[r].navprops[o].to.multiplicity;if(v==="*"){h={results:e.extend(true,[],d)}}else{h=e.extend(true,{},d[0])}if(d&&d.length!==0){if(i){var _=decodeURIComponent(i).replace("?","&").split("&");_=c(_);if(_.length>1){_=a._orderQueryOptions(_)}if(v==="*"){e.each(_,function(e,t){a._applyQueryOnCollection(h,t,a._mEntitySets[r].navprops[o].to.entitySet,_)})}else{e.each(_,function(e,t){h=a._applyQueryOnEntry(h,t,a._mEntitySets[r].navprops[o].to.entitySet)})}}}a.fireEvent(s.HTTPMETHOD.GET+r+":after",{oXhr:t,oFilteredData:h});a.fireEvent(s.HTTPMETHOD.GET+":after",{oXhr:t,oFilteredData:h});t.respond(200,u,JSON.stringify({d:h}));e.sap.log.debug("MockServer: response sent with: 200, "+JSON.stringify({d:h}))}else{a._logAndThrowMockServerCustomError(404,a._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(r){if(r.error){t.respond(r.error.code,u,JSON.stringify(r))}else{t.respond(parseInt(r.message||r.number,10));e.sap.log.debug("MockServer: response sent with: "+parseInt(r.message||r.number,10))}}return true}})});h.push({method:"POST",path:new RegExp("("+t+")(\\(([^/\\?#]+)\\)/?(.*)?)?"),response:function(t,n,o,i,u){var f=false;if(t.requestHeaders["x-http-method"]==="MERGE"){f=true}e.sap.log.debug("MockServer: incoming create request for url: "+t.url);a.fireEvent(s.HTTPMETHOD.POST+n+":before",{oXhr:t,sKeys:i,sNavName:u});a.fireEvent(s.HTTPMETHOD.POST+":before",{oXhr:t,sKeys:i,sNavName:u});var c=null;var h=null;var v=405;try{if(i&&!i.split("=")[1]){i=a._mEntitySets[n].keys[0]+"="+i}var _=l(r,decodeURIComponent(i),u);if(_){var g=d(t,_,i,u);if(g){h={"Content-Type":"application/json;charset=utf-8"};a.fireEvent(s.HTTPMETHOD.POST+n+":after",{oXhr:t,oEntity:g});a.fireEvent(s.HTTPMETHOD.POST+":after",{oXhr:t,oEntity:g});if(f){var y=p(n,i);if(y){e.extend(a._oMockdata[n][y.index],g)}v=204}else{var E=a._getRootUri()+_+"("+a._createKeysString(a._mEntitySets[_],g)+")";c=JSON.stringify({d:g,uri:E});a._oMockdata[_]=a._oMockdata[_].concat([g]);v=201}}}t.respond(v,h,c);e.sap.log.debug("MockServer: response sent with: "+v+", "+c)}catch(r){if(r.error){var m={"Content-Type":"text/plain;charset=utf-8"};t.respond(r.error.code,m,JSON.stringify(r))}else{t.respond(parseInt(r.message||r.number,10));e.sap.log.debug("MockServer: response sent with: "+parseInt(r.message||r.number,10))}}return true}});h.push({method:"PUT",path:new RegExp("("+t+")\\(([^/\\?#]+)\\)/?(.*)?"),response:function(t,n,o,i){e.sap.log.debug("MockServer: incoming update request for url: "+t.url);a.fireEvent(s.HTTPMETHOD.PUT+n+":before",{oXhr:t,sKeys:o,sNavName:i});a.fireEvent(s.HTTPMETHOD.PUT+":before",{oXhr:t,sKeys:o,sNavName:i});var u=405;var f=null;var c=null;try{var h=l(r,decodeURIComponent(o),i);if(h){var v=d(t,h,o,i);if(v){c={"Content-Type":"application/json;charset=utf-8"};a.fireEvent(s.HTTPMETHOD.PUT+n+":after",{oXhr:t,oEntity:v});a.fireEvent(s.HTTPMETHOD.PUT+":after",{oXhr:t,oEntity:v});var _=p(n,o);if(_){a._oMockdata[n][_.index]=v}u=204}}t.respond(u,c,f);e.sap.log.debug("MockServer: response sent with: "+u+", "+f)}catch(r){if(r.error){var g={"Content-Type":"text/plain;charset=utf-8"};t.respond(r.error.code,g,JSON.stringify(r))}else{t.respond(parseInt(r.message||r.number,10));e.sap.log.debug("MockServer: response sent with: "+parseInt(r.message||r.number,10))}}return true}});h.push({method:"MERGE",path:new RegExp("("+t+")\\(([^/\\?#]+)\\)/?(.*)?"),response:function(t,n,o,i){e.sap.log.debug("MockServer: incoming merge update request for url: "+t.url);a.fireEvent(s.HTTPMETHOD.MERGE+n+":before",{oXhr:t,sKeys:o,sNavName:i});a.fireEvent(s.HTTPMETHOD.MERGE+":before",{oXhr:t,sKeys:o,sNavName:i});var u=405;var f=null;var c=null;try{var h=l(r,decodeURIComponent(o),i);if(h){var v=d(t,h,o,i);if(v){c={"Content-Type":"application/json;charset=utf-8"};a.fireEvent(s.HTTPMETHOD.MERGE+n+":after",{oXhr:t,oEntity:v});a.fireEvent(s.HTTPMETHOD.MERGE+":after",{oXhr:t,oEntity:v});var _=p(n,o);if(_){e.extend(a._oMockdata[n][_.index],v)}u=204}}t.respond(u,c,f);e.sap.log.debug("MockServer: response sent with: "+u+", "+f)}catch(r){if(r.error){var g={"Content-Type":"text/plain;charset=utf-8"};t.respond(r.error.code,g,JSON.stringify(r))}else{t.respond(parseInt(r.message||r.number,10));e.sap.log.debug("MockServer: response sent with: "+parseInt(r.message||r.number,10))}}return true}});h.push({method:"PATCH",path:new RegExp("("+t+")\\(([^/\\?#]+)\\)/?(.*)?"),response:function(t,n,o,i){e.sap.log.debug("MockServer: incoming patch update request for url: "+t.url);a.fireEvent(s.HTTPMETHOD.PATCH+n+":before",{oXhr:t,sKeys:o,sNavName:i});a.fireEvent(s.HTTPMETHOD.PATCH+":before",{oXhr:t,sKeys:o,sNavName:i});var u=405;var f=null;var c=null;try{var h=l(r,decodeURIComponent(o),i);if(h){var v=d(t,h,o,i);if(v){c={"Content-Type":"application/json;charset=utf-8"};a.fireEvent(s.HTTPMETHOD.PATCH+n+":after",{oXhr:t,oEntity:v});a.fireEvent(s.HTTPMETHOD.PATCH+":after",{oXhr:t,oEntity:v});var _=p(n,o);if(_){e.extend(a._oMockdata[n][_.index],v)}u=204}}t.respond(u,c,f);e.sap.log.debug("MockServer: response sent with: "+u+", "+f)}catch(r){if(r.error){var g={"Content-Type":"text/plain;charset=utf-8"};t.respond(r.error.code,g,JSON.stringify(r))}else{t.respond(parseInt(r.message||r.number,10));e.sap.log.debug("MockServer: response sent with: "+parseInt(r.message||r.number,10))}}return true}});h.push({method:"DELETE",path:new RegExp("("+t+")\\(([^/\\?#]+)\\)/?(.*)?"),response:function(t,r,n,o){e.sap.log.debug("MockServer: incoming delete request for url: "+t.url);a.fireEvent(s.HTTPMETHOD.DELETE+r+":before",{oXhr:t});a.fireEvent(s.HTTPMETHOD.DELETE+":before",{oXhr:t});var i=204;try{var u=p(r,n);if(u){a._oMockdata[r].splice(u.index,1)}else{i=400}a.fireEvent(s.HTTPMETHOD.DELETE+r+":after",{oXhr:t});a.fireEvent(s.HTTPMETHOD.DELETE+":after",{oXhr:t});t.respond(i,null,null);e.sap.log.debug("MockServer: response sent with: "+i)}catch(r){if(r.error){var f={"Content-Type":"text/plain;charset=utf-8"};t.respond(r.error.code,f,JSON.stringify(r))}else{t.respond(parseInt(r.message||r.number,10));e.sap.log.debug("MockServer: response sent with: "+parseInt(r.message||r.number,10))}}return true}})});this.setRequests(h)};s.prototype._orderQueryOptions=function(t){var r,a,s,n,o,i,u,f,p,l,c=[];var d=this;e.each(t,function(c,h){switch(h.split("=")[0]){case"$top":n=e.inArray(h,t);break;case"$skip":s=e.inArray(h,t);break;case"$orderby":o=e.inArray(h,t);break;case"$expand":u=e.inArray(h,t);break;case"$filter":r=e.inArray(h,t);break;case"$select":i=e.inArray(h,t);break;case"$inlinecount":a=e.inArray(h,t);break;case"$format":f=e.inArray(h,t);break;case"search-focus":l=e.inArray(h,t);break;case"search":p=e.inArray(h,t);break;default:if(h.split("=")[0].indexOf("$")===0){d._logAndThrowMockServerCustomError(400,d._oErrorMessages.IS_NOT_A_VALID_SYSTEM_QUERY_OPTION,h.split("=")[0])}}});if(u>=0){c.push(t[u])}if(r>=0){c.push(t[r])}if(l>=0){c.push(t[l])}if(p>=0){c.push(t[p])}if(a>=0){c.push(t[a])}if(o>=0){c.push(t[o])}if(s>=0){c.push(t[s])}if(n>=0){c.push(t[n])}if(i>=0){c.push(t[i])}if(f>=0){c.push(t[f])}return c};s.prototype._removeAllRequestHandlers=function(){var e=this.getRequests();var t=e.length;for(var r=0;r<t;r++){s._removeResponse(e[r].response)}};s.prototype._removeAllFilters=function(){for(var e=0;e<this._aFilters.length;e++){s._removeFilter(this._aFilters[e])}this._aFilters=null};s.prototype._addRequestHandler=function(t,r,a){t=t?t.toUpperCase():t;if(typeof t!=="string"){throw new Error("Error in request configuration: value of 'method' has to be a string")}if(!(typeof r==="string"||r instanceof RegExp)){throw new Error("Error in request configuration: value of 'path' has to be a string or a regular expression")}if(typeof a!=="function"){throw new Error("Error in request configuration: value of 'response' has to be a function")}var s=this._getRootUri();s=s&&new RegExp(this._escapeStringForRegExp(s));if(r&&!(r instanceof RegExp)){r=new RegExp(this._createRegExpPattern(r))}var n=this._createRegExp(s?s.source+r.source:r.source);this._addFilter(this._createFilter(t,n));this._oServer.respondWith(t,n,a);e.sap.log.debug("MockServer: adding "+t+" request handler for pattern "+n)};s.prototype._createRegExp=function(e){return new RegExp("^"+e+"$")};s.prototype._createRegExpPattern=function(e){return e.replace(/:([\w\d]+)/g,"([^/]+)")};s.prototype._escapeStringForRegExp=function(e){return e.replace(/[\\\/\[\]\{\}\(\)\-\*\+\?\.\^\$\|]/g,"\\$&")};s.prototype._trim=function(e){return e&&e.replace(/^\s+|\s+$/g,"")};s.prototype._isValidNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)};s.prototype._getDateTime=function(e){if(!e){return}return"datetime'"+new Date(Number(e.replace("/Date(","").replace(")/",""))).toJSON().substring(0,19)+"'"};s.prototype._getJsonDate=function(t){if(!t){return}var r=function(t){var r=e.map(t.slice(0,-5).split(/\D/),function(e){return parseInt(e,10)||0});r[1]-=1;r=new Date(Date.UTC.apply(Date,r));var a=t.slice(-5);var s=parseInt(a,10)/100;if(a.slice(0,1)==="+"){s*=-1}r.setHours(r.getHours()+s);return r.getTime()};if(t.indexOf("datetimeoffset")>-1){return"/Date("+r(t.substring("datetimeoffset'".length,t.length-1))+")/"}else{return"/Date("+r(t.substring("datetime'".length,t.length-1))+")/"}};s.prototype._addFilter=function(e){this._aFilters.push(e);s._addFilter(e)};s.prototype._createFilter=function(e,t){return function(r,a,s,n,o){return e===r&&t.test(a)}};s.prototype._logAndThrowMockServerCustomError=function(t,r,a){if(r.indexOf("##")>-1&&a){r=r.replace("##","'"+a+"'")}e.sap.log.error("MockServer: "+r);throw{error:{code:t,message:{lang:"en",value:r}}}};s.prototype.destroy=function(t){r.prototype.destroy.apply(this,arguments);this.stop();var a=s._aServers;var n=e.inArray(this,a);a.splice(n,1)};s._aFilters=[];s._oServer=null;s._aServers=[];s._getInstance=function(){if(!this._oServer){this._oServer=window.sinon.fakeServer.create();this._oServer.autoRespond=true}return this._oServer};s.config=function(e){var t=this._getInstance();t.autoRespond=e.autoRespond===false?false:true;t.autoRespondAfter=e.autoRespondAfter||0;t.fakeHTTPMethods=e.fakeHTTPMethods||false};s.respond=function(){this._getInstance().respond()};s.startAll=function(){for(var e=0;e<this._aServers.length;e++){this._aServers[e].start()}};s.stopAll=function(){for(var e=0;e<this._aServers.length;e++){this._aServers[e].stop()}this._getInstance().restore();this._oServer=null};s.destroyAll=function(){this.stopAll();for(var e=0;e<this._aServers.length;e++){this._aServers[e].destroy()}};s.HTTPMETHOD={GET:"GET",POST:"POST",DELETE:"DELETE",PUT:"PUT",MERGE:"MERGE",PATCH:"PATCH"};s._addFilter=function(e){this._aFilters.push(e)};s._removeFilter=function(t){var r=e.inArray(t,this._aFilters);if(r!==-1){this._aFilters.splice(r,1)}return r!==-1};s._removeResponse=function(e){var t=this._oServer.responses;var r=t.length;for(var a=0;a<r;a++){if(t[a].response===e){t.splice(a,1);return true}}return false};window.sinon.FakeXMLHttpRequest.useFilters=true;window.sinon.xhr.supportsCORS=e.support.cors;window.sinon.FakeXMLHttpRequest.addFilter(function(e,t,r,a,n){var o=s._aFilters;for(var i=0;i<o.length;i++){var u=o[i];if(u(e,t,r,a,n)){return false}}return true});var n=function(e){if(/.*\.json$/i.test(e)){return"JSON"}if(/.*\.xml$/i.test(e)){return"XML"}if(/.*metadata$/i.test(e)){return"XML"}return null};window.sinon.FakeXMLHttpRequest.prototype.respondFile=function(t,r,a){var s=e.sap.sjax({url:a,dataType:"text"});if(!s.success){throw new Error("Could not load file from: "+a)}var o=s.data;var i=n(a);if(this["respond"+i]){this["respond"+i](t,r,o)}else{this.respond(t,r,o)}};window.sinon.FakeXMLHttpRequest.prototype.respondJSON=function(e,t,r){t=t||{};t["Content-Type"]=t["Content-Type"]||"application/json";this.respond(e,t,typeof r==="string"?r:JSON.stringify(r))};window.sinon.FakeXMLHttpRequest.prototype.respondXML=function(e,t,r){t=t||{};t["Content-Type"]=t["Content-Type"]||"application/xml";this.respond(e,t,r)};return s});