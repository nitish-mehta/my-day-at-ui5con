/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/EventBus","sap/base/util/equal","sap/base/util/includes","sap/base/util/isPlainObject","sap/base/util/isWindow","sap/base/Log"],function(e,t,i,n,r,s){"use strict";var o;var a="______UI5______";var c=e.extend("sap.ui.core.postmessage.Bus",{constructor:function(){if(o){return o}o=this;e.apply(this,arguments);this._aAcceptedOrigins=[window.location.origin];this._aDeclinedOrigins=[];this._oPendingProcess=null;this._aEventQueue=[];this._receiver=this._receiver.bind(this);window.addEventListener("message",this._receiver)}});c.event={CONNECT:"______CONNECT______",READY:"______READY______",ACCEPTED:"______ACCEPTED______",DECLINED:"______DECLINED______"};c.prototype.destroy=function(){window.removeEventListener("message",this._receiver);this._aEventQueue=[];e.prototype.destroy.apply(this,arguments);o=undefined;this.bIsDestroyed=true};c.getInstance=function(){if(!o){o=new c}return o};c.prototype.publish=function(e){var t=e.target;var n=e.origin;var s=e.channelId;var o=e.eventId;var d=e.data;if(o===c.event.READY){if(!t){if(window.opener&&window.opener!==window){t=window.opener}else if(window.parent!==window){t=window.parent}else{return}}if(!n){n="*"}}if(!r(t)||t===window){throw TypeError("Target must be a window object and has to differ from current window")}if(typeof n!=="string"){throw TypeError("Origin must be a string")}if(typeof s!=="string"){throw TypeError("ChannelId must be a string")}if(typeof o!=="string"){throw TypeError("EventId must be a string")}if(!i([c.event.READY,c.event.ACCEPTED,c.event.DECLINED],o)&&n!=="*"&&!i(this._aAcceptedOrigins,n)){this._aAcceptedOrigins.push(n)}var p={origin:n,channelId:s,eventId:o,data:d};p[a]=true;t.postMessage(p,n)};c.prototype._callListener=function(e,t,i,n,r){e.call(t,r)};c.prototype._getText=function(e,t){return sap.ui.getCore().getLibraryResourceBundle().getText(e,t)};c.prototype._receiver=function(e){var t=e.data;if(!n(t)||!t.hasOwnProperty(a)){return}if(this._oPendingProcess){this._aEventQueue.push(e)}else{this._oPendingProcess=this._processEvent(e)}};c.prototype._processEvent=function(e){return new Promise(function(t){var n=e.data;var r=e.origin;if(i(this._aDeclinedOrigins,r)){t();return}switch(n.eventId){case c.event.CONNECT:{if(typeof n.data!=="string"){this.publish({target:e.source,origin:e.origin,channelId:n.channelId,eventId:c.event.DECLINED});t()}else if(i(this._aAcceptedOrigins,r)){this.publish({target:e.source,origin:e.origin,channelId:n.channelId,eventId:c.event.ACCEPTED});t()}else{sap.ui.require(["sap/ui/core/postmessage/confirmationDialog"],function(i){i(this._getText("PostMessage.Message",[n.data,r])).then(function(){this.addAcceptedOrigin(r);this.publish({target:e.source,origin:e.origin,channelId:n.channelId,eventId:c.event.ACCEPTED})}.bind(this),function(){this.addDeclinedOrigin(r);this.publish({target:e.source,origin:e.origin,channelId:n.channelId,eventId:c.event.DECLINED})}.bind(this)).then(t)}.bind(this))}break}case c.event.ACCEPTED:case c.event.DECLINED:case c.event.READY:{e.data.data=undefined;this._emitMessage(e);t();break}default:{if(i(this._aAcceptedOrigins,r)){this._emitMessage(e)}t()}}}.bind(this)).catch(function(e){var t;var i;if(typeof e==="string"){t=e}else if(e instanceof Error){t=e.message;i=e.stack}else{t="Some unexpected error happened during post message processing"}s.error(t,i,"sap.ui.core.postmessage.Bus")}).then(function(){this._oPendingProcess=this._aEventQueue.length>0?this._processEvent(this._aEventQueue.shift()):null}.bind(this))};c.prototype._emitMessage=function(t){var i=t.data.channelId;var n=t.data.eventId;e.prototype.publish.call(this,i,n,{originalEvent:t,channelId:i,eventId:n,source:t.source,origin:t.origin,data:t.data.data})};c.prototype.getAcceptedOrigins=function(){return this._aAcceptedOrigins.slice()};c.prototype.setAcceptedOrigins=function(e){if(!Array.isArray(e)){throw new TypeError("Expected an array, but got "+typeof e)}this._aAcceptedOrigins=e.slice()};c.prototype.addAcceptedOrigin=function(e){if(typeof e!=="string"){throw new TypeError("Expected a string, but got "+typeof e)}if(!i(this._aAcceptedOrigins,e)){this._aAcceptedOrigins.push(e)}};c.prototype.resetAcceptedOrigins=function(){this.setAcceptedOrigins([])};c.prototype.getDeclinedOrigins=function(){return this._aDeclinedOrigins.slice()};c.prototype.setDeclinedOrigins=function(e){if(!Array.isArray(e)){throw new TypeError("Expected an array, but got "+typeof e)}this._aDeclinedOrigins=e.slice()};c.prototype.addDeclinedOrigin=function(e){if(typeof e!=="string"){throw new TypeError("Expected a string, but got "+typeof e)}if(!i(this._aDeclinedOrigins,e)){this._aDeclinedOrigins.push(e)}};c.prototype.resetDeclinedOrigins=function(){this.setDeclinedOrigins([])};return c});