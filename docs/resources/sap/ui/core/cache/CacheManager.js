/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./LRUPersistentCache","./CacheManagerNOP","sap/ui/Device"],function(e,n,t,a){"use strict";var s={_instance:null,_getInstance:function(){var n,t=g("_getInstance"),a=this;n=new Promise(function(n,c){var o;e.sap.log.debug("Cache Manager: Initialization...");if(!s._instance){o=a._findImplementation();e.sap.measure.start(i,"CM",r);o.init().then(u,c);e.sap.measure.end(i,"CM")}else{u(s._instance)}function u(a){s._instance=a;t.endAsync();e.sap.log.debug("Cache Manager initialized with implementation ["+s._instance.name+"], resolving _getInstance promise");n(a)}});t.endSync();return n},_findImplementation:function(){if(o()&&this._isSupportedEnvironment()){return n}else{e.sap.log.warning("UI5 Cache Manager is switched off");return t}},set:function(n,t){var a,s=g("set",n);e.sap.log.debug("Cache Manager: Setting value of type["+typeof t+"] with key ["+n+"]");a=this._callInstanceMethod("set",arguments).then(function t(){e.sap.log.debug("Cache Manager: Setting key ["+n+"] completed successfully");s.endAsync()},function(t){e.sap.log.error("Cache Manager: Setting key ["+n+"] failed. Error:"+t);s.endAsync();throw t});s.endSync();return a},get:function(n){var t,a=g("get",n);e.sap.log.debug("Cache Manager: Getting key ["+n+"]");t=this._callInstanceMethod("get",arguments).then(function t(s){e.sap.log.debug("Cache Manager: Getting key ["+n+"] done");a.endAsync();return s},function(t){e.sap.log.debug("Cache Manager: Getting key ["+n+"] failed. Error: "+t);a.endAsync();throw t});a.endSync();return t},has:function(n){var t,a=g("has",n);e.sap.log.debug("Cache Manager: has key ["+n+"] called");t=this._callInstanceMethod("has",arguments).then(function t(s){a.endAsync();e.sap.log.debug("Cache Manager: has key ["+n+"] returned "+s);return s});a.endSync();return t},del:function(n){var t,a=g("del",n);e.sap.log.debug("Cache Manager: del called.");t=this._callInstanceMethod("del",arguments).then(function n(){e.sap.log.debug("Cache Manager: del completed successfully.");a.endAsync()},function(n){e.sap.log.debug("Cache Manager: del failed. Error: "+n);a.endAsync();throw n});a.endSync();return t},reset:function(){var n,t=g("reset");e.sap.log.debug("Cache Manager: Reset called.");n=this._callInstanceMethod("reset",arguments).then(function n(){e.sap.log.debug("Cache Manager: Reset completed successfully.");t.endAsync()},function(n){e.sap.log.debug("Cache Manager: Reset failed. Error: "+n);t.endAsync();throw n});t.endSync();return n},_switchOff:function(){var e=this;return Promise.resolve().then(function(){u(e);sap.ui.getCore().getConfiguration().setUI5CacheOn(false)})},_switchOn:function(){var e=this;return Promise.resolve().then(function(){var n=sap.ui.getCore().getConfiguration();if(!n.isUI5CacheOn()){u(e);sap.ui.getCore().getConfiguration().setUI5CacheOn(true)}return Promise.resolve()})},_callInstanceMethod:function(n,t){var a,s="[sync ] _callInstanceMethod";e.sap.measure.start(s,"CM",r);if(this._instance){e.sap.log.debug("Cache Manager: calling instance...");return this._instance[n].apply(this._instance,t)}e.sap.log.debug("Cache Manager: getting instance...");a=this._getInstance().then(function e(a){return a[n].apply(a,t)});e.sap.measure.end(s);return a},_isSupportedEnvironment:function(){var e=[];if(this._bSupportedEnvironment==undefined){e.push({system:a.system.SYSTEMTYPE.DESKTOP,browserName:a.browser.BROWSER.CHROME,browserVersion:49});e.push({system:a.system.SYSTEMTYPE.DESKTOP,browserName:a.browser.BROWSER.INTERNET_EXPLORER,browserVersion:11});this._bSupportedEnvironment=e.some(function(e){var n=a.system[e.system],t=e.browserName===a.browser.name,s=a.browser.version>=e.browserVersion;return n&&t&&s&&window.indexedDB})}return this._bSupportedEnvironment}};var r="CacheManager",i="[sync ] _initImplementation",c=0;function o(){return sap.ui.getCore().getConfiguration().isUI5CacheOn()}function u(e){if(e._instance){e._instance._destroy();e._instance=null}}function g(n,t){c++;var a="[async]  "+n+"["+t+"]- #"+c,s="[sync ]  "+n+"["+t+"]- #"+c;e.sap.measure.start(a,"CM",[r,n]);e.sap.measure.start(s,"CM",[r,n]);return{sMeasureAsync:a,sMeasureSync:s,endAsync:function(){e.sap.measure.end(this.sMeasureAsync)},endSync:function(){e.sap.measure.end(this.sMeasureSync)}}}return s},false);