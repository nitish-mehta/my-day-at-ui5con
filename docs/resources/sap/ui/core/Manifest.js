/*
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/thirdparty/URI","jquery.sap.resources"],function(e,t,n){"use strict";var i=/\{\{([^\}\}]+)\}\}/g;function o(t){var n=e.sap.Version(t);return n.getSuffix()?e.sap.Version(n.getMajor()+"."+n.getMinor()+"."+n.getPatch()):n}function a(e,t){for(var n in e){if(!e.hasOwnProperty(n)){continue}var i=e[n];switch(typeof i){case"object":if(i){a(i,t)}break;case"string":t(e,n,i);break;default:}}}function s(e,t){if(e&&t&&typeof t==="string"&&t[0]==="/"){var n=t.substring(1).split("/"),i;for(var o=0,a=n.length;o<a;o++){i=n[o];e=e.hasOwnProperty(i)?e[i]:undefined;if(e===null||typeof e!=="object"){if(o+1<a&&e!==undefined){e=undefined}break}}return e}return e&&e[t]}function r(e){if(e&&typeof e==="object"&&!Object.isFrozen(e)){Object.freeze(e);for(var t in e){if(e.hasOwnProperty(t)){r(e[t])}}}}var u=t.extend("sap.ui.core.Manifest",{constructor:function(i,o){t.apply(this,arguments);this._uid=e.sap.uid();this._iInstanceCount=0;this._bIncludesLoaded=false;this._oRawManifest=i;this._bProcess=!(o&&o.process===false);this._sComponentName=o&&o.componentName;var a=this.getComponentName(),s=o&&o.baseUrl||a&&e.sap.getModulePath(a,"/");if(s){this._oBaseUri=new n(s).absoluteTo(new n(document.baseURI).search(""))}if(o&&typeof o.url==="string"){this._oManifestBaseUri=new n(o.url).absoluteTo(new n(document.baseURI).search("")).search("")}else{this._oManifestBaseUri=this.oBaseUri}r(this._oRawManifest);this._oManifest=this._bProcess?null:this._oRawManifest},_processEntries:function(t){var o=this;var s=t["sap.app"]&&t["sap.app"]["i18n"]||"i18n/i18n.properties";var r;a(t,function(t,a,u){t[a]=u.replace(i,function(t,i){if(!r){r=e.sap.resources({url:o.resolveUri(new n(s)).toString()})}return r.getText(i)})});return t},getJson:function(){if(!this._oManifest){this._oManifest=this._processEntries(e.extend(true,{},this._oRawManifest))}return this._oManifest},getRawJson:function(){return this._oRawManifest},getEntry:function(t){if(!t||t.indexOf(".")<=0){e.sap.log.warning("Manifest entries with keys without namespace prefix can not be read via getEntry. Key: "+t+", Component: "+this.getComponentName());return null}var n=this.getJson();var i=s(n,t);if(t&&t[0]!=="/"&&!e.isPlainObject(i)){e.sap.log.warning("Manifest entry with key '"+t+"' must be an object. Component: "+this.getComponentName());return null}return i},checkUI5Version:function(){var t=this.getEntry("/sap.ui5/dependencies/minUI5Version");if(t&&e.sap.log.isLoggable(e.sap.log.LogLevel.WARNING)&&sap.ui.getCore().getConfiguration().getDebug()){sap.ui.getVersionInfo({async:true}).then(function(n){var i=o(t);var a=o(n&&n.version);if(i.compareTo(a)>0){e.sap.log.warning('Component "'+this.getComponentName()+'" requires at least version "'+i.toString()+'" but running on "'+a.toString()+'"!')}}.bind(this),function(t){e.sap.log.warning('The validation of the version for Component "'+this.getComponentName()+'" failed! Reasion: '+t)}.bind(this))}},loadIncludes:function(){if(this._bIncludesLoaded){return}var t=this.getEntry("/sap.ui5/resources");if(!t){return}var i=this.getComponentName();var o=t["js"];if(o){for(var a=0;a<o.length;a++){var s=o[a];var r=s.uri;if(r){var u=r.match(/\.js$/i);if(u){var f=i.replace(/\./g,"/")+(r.slice(0,1)==="/"?"":"/")+r.slice(0,u.index);e.sap.log.info('Component "'+i+'" is loading JS: "'+f+'"');sap.ui.requireSync(f)}}}}var c=t["css"];if(c){for(var p=0;p<c.length;p++){var l=c[p];if(l.uri){var g=this.resolveUri(new n(l.uri)).toString();e.sap.log.info('Component "'+i+'" is loading CSS: "'+g+'"');e.sap.includeStyleSheet(g,{id:l.id,"data-sap-ui-manifest-uid":this._uid})}}}this._bIncludesLoaded=true},removeIncludes:function(){if(!this._bIncludesLoaded){return}var t=this.getEntry("/sap.ui5/resources");if(!t){return}var n=this.getComponentName();var i=t["css"];if(i){var o=document.querySelectorAll("link[data-sap-ui-manifest-uid='"+this._uid+"']");for(var a=0;a<o.length;a++){var s=o[a];e.sap.log.info('Component "'+n+'" is removing CSS: "'+s.href+'"');s.parentNode.removeChild(s)}}this._bIncludesLoaded=false},loadDependencies:function(){var t=this.getEntry("/sap.ui5/dependencies"),n=this.getComponentName();if(t){var i=t["libs"];if(i){for(var o in i){if(!i[o].lazy){e.sap.log.info('Component "'+n+'" is loading library: "'+o+'"');sap.ui.getCore().loadLibrary(o)}}}var a=t["components"];if(a){for(var s in a){if(!a[s].lazy){e.sap.log.info('Component "'+n+'" is loading component: "'+s+'.Component"');sap.ui.requireSync("sap/ui/core/Component").load({name:s})}}}}},defineResourceRoots:function(){var t=this.getEntry("/sap.ui5/resourceRoots");if(t){for(var i in t){var o=t[i];var a=new n(o);if(a.is("absolute")||a.path()&&a.path()[0]==="/"){e.sap.log.error('Resource root for "'+i+'" is absolute and therefore won\'t be registered! "'+o+'"',this.getComponentName());continue}o=this.resolveUri(a).toString();e.sap.registerModulePath(i,o)}}},getComponentName:function(){var e=this.getRawJson();return this._sComponentName||s(e,"/sap.ui5/componentName")||s(e,"/sap.app/id")},resolveUri:function(e,t){return u._resolveUriRelativeTo(e,t==="manifest"?this._oManifestBaseUri:this._oBaseUri)},init:function(e){if(this._iInstanceCount===0){this.checkUI5Version();this.defineResourceRoots();this.loadDependencies();this.loadIncludes();this.activateCustomizing()}if(e){this.activateCustomizing(e)}this._iInstanceCount++},exit:function(e){var t=Math.max(this._iInstanceCount-1,0);if(e){this.deactivateCustomizing(e)}if(t===0){this.deactivateCustomizing();this.removeIncludes()}this._iInstanceCount=t},activateCustomizing:function(t){var n=this.getEntry("sap.ui5",true),i=n&&n["extends"]&&n["extends"].extensions;if(!e.isEmptyObject(i)){var o=sap.ui.requireSync("sap/ui/core/CustomizingConfiguration");if(!t){o.activateForComponent(this.getComponentName())}else{o.activateForComponentInstance(t)}}},deactivateCustomizing:function(e){var t=sap.ui.require("sap/ui/core/CustomizingConfiguration");if(t){if(!e){t.deactivateForComponent(this.getComponentName())}else{t.deactivateForComponentInstance(e)}}}});u._resolveUriRelativeTo=function(e,t){if(e.is("absolute")||e.path()&&e.path()[0]==="/"){return e}var i=new n(document.baseURI).search("");t=t.absoluteTo(i);return e.absoluteTo(t).relativeTo(i)};u.load=function(t){var i=t&&t.manifestUrl,o=t&&t.componentName,a=t&&t.async,s=t&&t.failOnError;var r=new n(i);["sap-language","sap-client"].forEach(function(e){if(!r.hasQuery(e)){var t=sap.ui.getCore().getConfiguration().getSAPParam(e);if(t){r.addQuery(e,t)}}});i=r.toString();e.sap.log.info("Loading manifest via URL: "+i);var f=e.sap.loadResource({url:i,dataType:"json",async:typeof a!=="undefined"?a:false,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()},failOnError:typeof s!=="undefined"?s:true});if(a){return f.then(function(e){return new u(e,{componentName:o,process:false})})}return new u(f,{componentName:o,process:false,url:i})};return u});