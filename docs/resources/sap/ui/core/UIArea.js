/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","./Element","./RenderManager","jquery.sap.act","jquery.sap.ui","jquery.sap.keycodes","jquery.sap.trace"],function(e,t,o,r){"use strict";var n;var i=e.sap.log.getLogger("sap.ui.Rendering",window["sap-ui-config"]&&window["sap-ui-config"]["xx-debugRendering"]||/sap-ui-xx-debug(R|-r)endering=(true|x|X)/.test(document.location.search)?e.sap.log.Level.DEBUG:Math.min(e.sap.log.Level.INFO,e.sap.log.getLevel())),a=function(e){return e},s=e.noop,d=e.noop;if(i.isLoggable()){a=function(e){var t;try{throw new Error}catch(e){t=e.stack||e.stacktrace||(e.sourceURL?e.sourceURL+":"+e.line:null);t=t?t.split(/\n\s*/g).slice(2):undefined}return{obj:e,location:t}};s=function(e,t){var o=sap.ui.getCore(),r={},n,a;for(n in t){a=o.byId(n);r[n]={type:a?a.getMetadata().getName():t[n].obj===e?"UIArea":"(no such control)",location:t[n].location,reason:t[n].reason}}i.debug("  UIArea '"+e.getId()+"', pending updates: "+JSON.stringify(r,null,"\t"))};d=function(e,t){var o;for(o in t){if(e[o]!=null){if(e[o].obj!==t[o].obj){t[o].reason="replaced during rendering"}else{t[o].reason="invalidated again during rendering"}}else{t[o].reason="invalidated during rendering"}}}}var l=t.extend("sap.ui.core.UIArea",{constructor:function(o,r){if(arguments.length===0){return}t.apply(this);this.oCore=o;this.bLocked=false;this.bInitial=true;this.aContentToRemove=[];this.bNeedsRerendering=false;if(r!=null){this.setRootNode(r);this.bNeedsRerendering=this.bNeedsRerendering&&!e.sap.domById(r.id+"-Init")}this.mInvalidatedControls={};if(!this.bNeedsRerendering){this.bRenderSelf=false}else{this.oCore.addInvalidatedUIArea(this)}},metadata:{publicMethods:["setRootNode","getRootNode","setRootControl","getRootControl","lock","unlock","isLocked"],aggregations:{content:{name:"content",type:"sap.ui.core.Control",multiple:true,singularName:"content"},dependents:{name:"dependents",type:"sap.ui.core.Control",multiple:true}}}});l.prototype.isInvalidateSuppressed=function(){return this.iSuppressInvalidate>0};l.prototype.getId=function(){return this.oRootNode?this.oRootNode.id:null};l.prototype.getUIArea=function(){return this};l.prototype.setRootNode=function(t){if(this.oRootNode===t){return}e.sap.assert(!t||t.nodeType===1&&!e(t).attr("data-sap-ui-area"),"UIArea root node must be a DOMElement");if(this.oRootNode){this._ondetach()}this.oRootNode=t;if(this.getContent().length>0){this.invalidate()}if(this.oRootNode){this._onattach()}};l.prototype.getRootNode=function(){return this.oRootNode};l.prototype.setRootControl=function(e){this.removeAllContent();this.addContent(e)};l.prototype.getRootControl=function(e){var t=this.getContent();if(t.length>0){if(e>=0&&e<t.length){return t[e]}return t[0]}return null};l.prototype._addRemovedContent=function(e){if(this.oRootNode&&e){this.aContentToRemove.push(e)}};l.prototype.addContent=function(e,t){this.addAggregation("content",e,t);if(t!==true){this.invalidate()}return this};l.prototype.removeContent=function(e,t){var o=this.removeAggregation("content",e,t);if(!t){var r;if(o&&o.getDomRef){r=o.getDomRef()}this._addRemovedContent(r)}return o};l.prototype.removeAllContent=function(){var e=this.removeAllAggregation("content");for(var t=0;t<e.length;t++){var o;var r=e[t];if(r&&r.getDomRef){o=r.getDomRef()}this._addRemovedContent(o)}return e};l.prototype.destroyContent=function(){var e=this.getContent();for(var t=0;t<e.length;t++){var o;var r=e[t];if(r&&r.getDomRef){o=r.getDomRef()}this._addRemovedContent(o)}this.destroyAggregation("content");return this};l.prototype.lock=function(){this.bLocked=true};l.prototype.unlock=function(){if(this.bLocked&&this.bNeedsRerendering){this.oCore.addInvalidatedUIArea(this)}this.bLocked=false};l.prototype.isLocked=function(){return this.bLocked};l.prototype.getBindingContext=function(){return null};l.prototype.getEventingParent=function(){return this.oCore._getEventProvider()};l.prototype.isActive=function(){return e.sap.domById(this.getId())!=null};l.prototype.invalidate=function(){this.addInvalidatedControl(this)};l.prototype.addInvalidatedControl=function(e){if(this.bRenderSelf){return}if(!this.bNeedsRerendering){this.oCore.addInvalidatedUIArea(this)}var t=e.getId();if(e===this){this.bRenderSelf=true;this.bNeedsRerendering=true;this.mInvalidatedControls={};this.mInvalidatedControls[t]=a(this);return}if(this.mInvalidatedControls[t]){return}if(!this.bRenderSelf){this.mInvalidatedControls[t]=a(e);this.bNeedsRerendering=true}};l.prototype.rerender=function(t){var o=this;function n(){o.bRenderSelf=false;o.aContentToRemove=[];o.mInvalidatedControls={};o.bNeedsRerendering=false}function a(){try{return document.activeElement}catch(e){}}if(t){this.bNeedsRerendering=true}if(this.bLocked||!this.bNeedsRerendering){return false}var l=this.bRenderSelf,u=this.aContentToRemove,p=this.mInvalidatedControls,f=false;n();e.sap.measure.pause("renderPendingUIUpdates");e.sap.measure.start(this.getId()+"---rerender","Rerendering of "+this.getMetadata().getName());s(this,p);if(l){if(this.oRootNode){i.debug("Full Rendering of UIArea '"+this.getId()+"'");r.preserveContent(this.oRootNode,false,this.bInitial);this.bInitial=false;var g=function(t,n){var i=t.length;var a;for(var s=0;s<i;s++){a=n?t[s].getDomRef():t[s];if(a&&!r.isPreservedContent(a)&&o.oRootNode===a.parentNode){e(a).remove()}}return i};var h=a();var c=this.oCore.oFocusHandler.getControlFocusInfo();g(u);var v=this.getContent();var y=g(v,true);var C=a();for(var R=0;R<y;R++){if(v[R]&&v[R].getParent()===this){this.oCore.oRenderManager.render(v[R],this.oRootNode,true)}}f=true;if(h&&h!=C&&C===a()){try{this.oCore.oFocusHandler.restoreFocus(c)}catch(t){e.sap.log.warning("Problems while restoring the focus after full UIArea rendering: "+t,null,this)}}}else{i.debug("Full Rendering of UIArea '"+this.getId()+"' postponed, no root node")}}else{var m=function(e){for(;;){if(e.getMetadata&&e.getMetadata().isInstanceOf("sap.ui.core.PopupInterface")){break}e=e.getParent();if(!e||e===o){return false}if(p.hasOwnProperty(e.getId())){return true}}};for(var I in p){var b=this.oCore.byId(I);if(b&&!m(b)){b.rerender();f=true}}}d(p,this.mInvalidatedControls);e.sap.measure.end(this.getId()+"---rerender");e.sap.measure.resume("renderPendingUIUpdates");return f};l.prototype._onControlRendered=function(e){var t=e.getId();if(this.mInvalidatedControls[t]){delete this.mInvalidatedControls[t]}};l.rerenderControl=function(t){var o=null;if(t){o=t.getDomRef();if(!o||r.isPreservedContent(o)){o=e.sap.domById(r.RenderPrefixes.Invisible+t.getId())}}var n=o&&o.parentNode;if(n){var a=t.getUIArea();var s=a?a.oCore.oRenderManager:sap.ui.getCore().createRenderManager();i.debug("Rerender Control '"+t.getId()+"'"+(a?"":" (using a temp. RenderManager)"));r.preserveContent(o,true,false);s.render(t,n)}else{var a=t.getUIArea();a&&a._onControlRendered(t);i.warning("Couldn't rerender '"+t.getId()+"', as its DOM location couldn't be determined")}};var u=/^(mousedown|mouseup|click|keydown|keyup|keypress|touchstart|touchend|tap)$/;var p=[],f=[];var g={mousemove:1,mouseover:1,mouseout:1,scroll:1,dragover:1,dragenter:1,dragleave:1};l.addEventPreprocessor=function(e){p.push(e)};l.getEventPreprocessors=function(){return p};l.addEventPostprocessor=function(e){f.push(e)};l.getEventPostprocessors=function(){return f};l.prototype._handleEvent=function(t){var r=null,n;r=e(t.target).control(0);e.sap.act.refresh();if(r===null){return}if(t.isMarked("delayedMouseEvent")){return}var i=t.getMark("handledByUIArea"),a=this.getId();if(i&&i!==a){t.setMark("firstUIArea",false);return}t.setMarked("firstUIArea");t.srcControl=r;if(t.type==="contextmenu"&&t.shiftKey&&t.altKey&&!!(t.metaKey||t.ctrlKey)){e.sap.log.info("Suppressed forwarding the contextmenu event as control event because CTRL+SHIFT+ALT is pressed!");return}p.forEach(function(e){e(t)});this.oCore._handleControlEvent(t,a);if(this.bLocked||this.oCore.isLocked()){return}if(e.sap.interaction.getActive()){n=t.type.match(u);if(n){e.sap.interaction.notifyEventStart(t)}}var s=[];if(t.getPseudoTypes){s=t.getPseudoTypes()}s.push(t.type);var d=false;while(r instanceof o&&r.isActive()&&!t.isPropagationStopped()){for(var l=0,h=s.length;l<h;l++){var c=s[l];t.type=c;t.currentTarget=r.getDomRef();r._handleEvent(t);if(t.isImmediatePropagationStopped()){break}}if(!d){d=this._handleGroupChange(t,r)}if(t.isPropagationStopped()){break}if(r.bStopEventBubbling){break}var v=r.getDomRef();if(!v){break}v=v.parentNode;r=null;if(t.isMarked("fromMouseout")&&e.sap.containsOrEquals(v,t.relatedTarget)){break}while(v&&v!==this.getRootNode()){if(v.id){r=e(v).control(0);if(r){break}}v=v.parentNode}}f.forEach(function(e){e(t)});if(n){e.sap.interaction.notifyEventEnd(t)}t.currentTarget=this.getRootNode();t.setMark("handledByUIArea",a);if(t.isPropagationStopped()){e.sap.log.debug("'"+t.type+"' propagation has been stopped")}var y=t.type;if(!g[y]){var C=e(t.target).control(0);if(C){e.sap.log.debug("Event fired: '"+y+"' on "+C,"","sap.ui.core.UIArea")}else{e.sap.log.debug("Event fired: '"+y+"'","","sap.ui.core.UIArea")}}};l.prototype._onattach=function(){var t=this.getRootNode();if(t==null){return}e(t).attr("data-sap-ui-area",t.id).bind(e.sap.ControlEvents.join(" "),this._handleEvent.bind(this))};l.prototype._ondetach=function(){var t=this.getRootNode();if(t==null){return}e(t).removeAttr("data-sap-ui-area").unbind()};l.prototype.clone=function(){throw new Error("UIArea can't be cloned")};l.prototype._handleGroupChange=function(t,o){var r=l._oFieldGroupValidationKey;if(t.type==="focusin"){if(l._iFieldGroupDelayTimer){e.sap.clearDelayedCall(l._iFieldGroupDelayTimer);l._iFieldGroupDelayTimer=null}l._iFieldGroupDelayTimer=e.sap.delayedCall(0,this,this.setFieldGroupControl,[o]);return true}else if(this.getFieldGroupControl()&&t.type==="keyup"&&t.keyCode===r.keyCode&&t.shiftKey===r.shiftKey&&t.altKey===r.altKey&&t.ctrlKey===r.ctrlKey){if(l._iFieldGroupTriggerDelay){e.sap.clearDelayedCall(l._iFieldGroupTriggerDelay)}var n=this.getFieldGroupControl(),i=n?n._getFieldGroupIds():[];if(i.length>0){n.triggerValidateFieldGroup(i)}return true}return false};l.prototype.setFieldGroupControl=function(e){function t(e,o){var r=e.getParent();if(r){if(o(r)){return r}else{return t(r,o)}}return null}var o=this.getFieldGroupControl();if(e!=o){var r=null;n=n||sap.ui.require("sap/ui/core/Control");if(n){if(e instanceof n){r=e}else{r=t(e,function(e){return e instanceof n})}}var i=o?o._getFieldGroupIds():[],a=r?r._getFieldGroupIds():[],s=[];for(var d=0;d<i.length;d++){var u=i[d];if(a.indexOf(u)===-1){s.push(u)}}if(s.length>0){o.triggerValidateFieldGroup(s)}l._oFieldGroupControl=r}return this};l.prototype.getFieldGroupControl=function(){if(l._oFieldGroupControl&&!l._oFieldGroupControl.bIsDestroyed){return l._oFieldGroupControl}return null};l._oFieldGroupControl=null;l._iFieldGroupDelayTimer=null;l._oFieldGroupValidationKey={keyCode:e.sap.KeyCodes.ENTER,shiftKey:false,altKey:false,ctrlKey:false};l._oRenderLog=i;return l});