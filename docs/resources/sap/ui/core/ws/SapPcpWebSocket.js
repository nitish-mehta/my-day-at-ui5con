/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./WebSocket"],function(e,t){"use strict";var r=t.extend("sap.ui.core.ws.SapPcpWebSocket",{constructor:function(e,r){t.apply(this,arguments)}});r.SUPPORTED_PROTOCOLS={v10:"v10.pcp.sap.com"};r._deserializeRegexp=/((?:[^:\\]|(?:\\.))+):((?:[^:\\\n]|(?:\\.))*)/;r._SEPARATOR="\n\n";r._MESSAGE="MESSAGE";r.prototype._onopen=function(){var t=false;if(this.getProtocol()===""){t=true}else{for(var i in r.SUPPORTED_PROTOCOLS){if(r.SUPPORTED_PROTOCOLS.hasOwnProperty(i)){if(r.SUPPORTED_PROTOCOLS[i]===this.getProtocol()){t=true;break}}}}if(t){this.fireOpen()}else{e.sap.log.error("Unsupported protocol '"+this.getProtocol()+"' selected by the server. "+"Connection will be closed.");this.close("Unsupported protocol selected by the server")}};r.prototype._onmessage=function(t){var i=-1,n={};if(typeof t.data==="string"){i=t.data.indexOf(r._SEPARATOR)}if(i!==-1){n.pcpFields=this._extractPcpFields(t.data.substring(0,i));n.data=t.data.substr(i+r._SEPARATOR.length)}else{e.sap.log.warning("Invalid PCP message received: "+t.data);n.pcpFields={};n.data=t.data}this.fireMessage(n)};r.prototype._extractPcpFields=function(e){var t=e.split("\n"),i=[],n={};for(var o=0;o<t.length;o++){i=t[o].match(r._deserializeRegexp);if(i&&i.length===3){n[this._unescape(i[1])]=this._unescape(i[2])}}return n};r.prototype._unescape=function(e){var t=e.split("\b"),r="";for(var i=0;i<t.length;i++){t[i]=t[i].replace(/\\\\/g,"\b").replace(/\\:/g,":").replace(/\\n/g,"\n").replace(/\u0008/g,"\\")}r=t.join("\b");return r};r.prototype._serializePcpFields=function(e,t,r){var i="",n="",o="";if(t==="string"){o="text"}else if(t==="blob"||t==="arraybuffer"){o="binary"}if(e&&typeof e==="object"){for(n in e){if(e.hasOwnProperty(n)&&n.indexOf("pcp-")!==0){i+=this._escape(n)+":"+this._escape(String(e[n]))+"\n"}}}return"pcp-action:"+r+"\npcp-body-type:"+o+"\n"+i+"\n"};r.prototype._escape=function(e){return e.replace(/\\/g,"\\\\").replace(/:/g,"\\:").replace(/\n/g,"\\n")};r.prototype.send=function(e,i){var n=typeof e,o="";o=this._serializePcpFields(i,n,r._MESSAGE);t.prototype.send.call(this,o+e);return this};return r});