/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","sap/ui/core/Control","sap/ui/core/mvc/Controller","sap/base/util/extend","sap/ui/core/library","./ViewRenderer"],function(e,r,t,o,n,s,i){"use strict";var a=s.mvc.ViewType;var p=t.extend("sap.ui.core.mvc.View",{metadata:{interfaces:["sap.ui.core.IDScope"],library:"sap.ui.core",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},viewName:{type:"string",group:"Misc",defaultValue:null},displayBlock:{type:"boolean",group:"Appearance",defaultValue:false}},aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"}},events:{afterInit:{},beforeExit:{},afterRendering:{},beforeRendering:{}},specialSettings:{controller:"sap.ui.core.mvc.Controller",controllerName:"string",preprocessors:"Object",resourceBundleName:"string",resourceBundleUrl:"sap.ui.core.URI",resourceBundleLocale:"string",resourceBundleAlias:"string",type:"string",definition:"any",viewContent:{type:"any",deprecated:true},viewData:"any",async:{type:"boolean",defaultValue:false}}}});p._mPreprocessors={};function c(e){e._settings={};for(var r in e){if(r.indexOf("_")!==0){e._settings[r]=e[r]}}}function u(e,r){var t;if(typeof e.preprocessor==="string"){var o=e.preprocessor.replace(/\./g,"/");if(r){return new Promise(function(e,r){sap.ui.require([o],function(r){e(r)})})}else{return sap.ui.requireSync(o)}}else if(typeof e.preprocessor==="function"&&!e.preprocessor.process){t={process:e.preprocessor}}else{t=e.preprocessor}if(r){return Promise.resolve(t)}else{return t}}function f(r,t){var o=this.mPreprocessors[t]||[],n=[],s,i,a,c=[];if(p._mPreprocessors[r]&&p._mPreprocessors[r][t]){n=p._mPreprocessors[r][t].map(function(r){return e.extend({},r)})}for(s=0,i=n.length;s<i;s++){if(n[s]._onDemand){a=n[s]}else{c.push(n[s])}}for(s=0,i=o.length;s<i;s++){var u=!o[s].preprocessor;if(u&&a){c.unshift(e.extend(o[s],a))}else if(!u){c.push(o[s])}}return c}function l(r,t){var o=r.getMetadata().getClass();function n(e){e.preprocessor=u(e,t.async)}r.mPreprocessors=e.extend({},t.preprocessors);for(var s in o.PreprocessorType){var i=o.PreprocessorType[s];if(r.mPreprocessors[i]&&!Array.isArray(r.mPreprocessors[i])){r.mPreprocessors[i]=[r.mPreprocessors[i]]}else if(!r.mPreprocessors[i]){r.mPreprocessors[i]=[]}r.mPreprocessors[i].forEach(c);r.mPreprocessors[i]=f.call(r,o._sType,i);r.mPreprocessors[i].forEach(n)}}function d(e){e.oAsyncState={};e.oAsyncState.promise=null}var g=function(e,t){if(!sap.ui.getCore().getConfiguration().getControllerCodeDeactivated()){var n=t.controller,s=n&&typeof n.getMetadata==="function"&&n.getMetadata().getName(),i=t.async;if(!n&&e.getControllerName){var a=e.getControllerName();if(a){var p=sap.ui.require("sap/ui/core/CustomizingConfiguration");var c=p&&p.getControllerReplacement(a,r._sOwnerId);if(c){a=typeof c==="string"?c:c.controllerName}n=sap.ui.controller(a,true,i)}}else if(n){var u=r._sOwnerId;if(!n._isExtended()){if(i){n=o.extendByCustomizing(n,s,i).then(function(e){return o.extendByProvider(e,s,u,i)})}else{n=o.extendByCustomizing(n,s,i);n=o.extendByProvider(n,s,u,i)}}else if(i){n=Promise.resolve(n)}}if(n){var f=function(r){e.oController=r;r.oView=e};if(i){if(!e.oAsyncState){throw new Error("The view "+e.sViewName+" runs in sync mode and therefore cannot use async controller extensions!")}return n.then(f)}else{f(n)}}}else{sap.ui.controller("sap.ui.core.mvc.EmptyControllerImpl",{"_sap.ui.core.mvc.EmptyControllerImpl":true});e.oController=sap.ui.controller("sap.ui.core.mvc.EmptyControllerImpl")}};p.prototype._initCompositeSupport=function(r){e.sap.assert(!r.preprocessors||this.getMetadata().getName().indexOf("XMLView"),"Preprocessors only available for XMLView");this.oViewData=r.viewData;this.sViewName=r.viewName;var t=this;l(this,r);if(r.async){d(this)}var o=sap.ui.require("sap/ui/core/CustomizingConfiguration");if(o&&o.hasCustomProperties(this.sViewName,this)){this._fnSettingsPreprocessor=function(r){var n=this.getId();if(o&&n){if(t.isPrefixedId(n)){n=n.substring((t.getId()+"--").length)}var s=o.getCustomProperties(t.sViewName,n,t);if(s){r=e.extend(r,s)}}}}var n=function(r,o){e.sap.assert(typeof r==="function","fn must be a function");var n=sap.ui.require("sap/ui/core/Component");var s=n&&n.getOwnerComponentFor(t);if(s){if(o){t.fnScopedRunWithOwner=t.fnScopedRunWithOwner||function(e){return s.runAsOwner(e)}}return s.runAsOwner(r)}return r()};var s=function(e){if(e.oController&&e.oController.connectToView){return e.oController.connectToView(e)}};var i=function(){if(t.onControllerConnected){return t.onControllerConnected(t.oController)}};if(this.initViewSettings){if(r.async){this.oAsyncState.promise=this.initViewSettings(r).then(function(){return n(g.bind(null,t,r),true)}).then(function(){return n(i,true)}).then(function(){return s(t)}).then(function(){return t.runPreprocessor("controls",t,false)}).then(function(){return n(t.fireAfterInit.bind(t),true)}).then(function(){return t})}else{this.initViewSettings(r);g(this,r);i();s(this);this.runPreprocessor("controls",this,true);this.fireAfterInit()}}};p.prototype.getController=function(){return this.oController};p.prototype.byId=function(e){return sap.ui.getCore().byId(this.createId(e))};p.prototype.createId=function(e){if(!this.isPrefixedId(e)){e=this.getId()+"--"+e}return e};p.prototype.getLocalId=function(e){var r=this.getId()+"--";return e&&e.indexOf(r)===0?e.slice(r.length):null};p.prototype.isPrefixedId=function(e){return!!(e&&e.indexOf(this.getId()+"--")===0)};p.prototype.getViewData=function(){return this.oViewData};function m(){this.oAsyncState=null}p.prototype.exit=function(){this.fireBeforeExit();delete this.oController;delete this.oPreprocessorInfo;if(this.oAsyncState){var e=m.bind(this);this.oAsyncState.promise.then(e,e)}};p.prototype.onAfterRendering=function(){this.fireAfterRendering()};p.prototype.onBeforeRendering=function(){this.fireBeforeRendering()};p.prototype.clone=function(e,r){var o={},n,s;for(n in this.mProperties&&!(this.isBound&&this.isBound(n))){if(this.mProperties.hasOwnProperty(n)){o[n]=this.mProperties[n]}}s=t.prototype.clone.call(this,e,r,{cloneChildren:false,cloneBindings:true});var i,a,p;for(i in s.mEventRegistry){a=s.mEventRegistry[i];for(p=a.length-1;p>=0;p--){if(a[p].oListener===this.getController()){a[p]={oListener:s.getController(),fFunction:a[p].fFunction,oData:a[p].oData}}}}s.applySettings(o);return s};p.prototype.getPreprocessors=function(){return this.mPreprocessors};p.prototype.getPreprocessorInfo=function(e){if(!this.oPreprocessorInfo){this.oPreprocessorInfo={name:this.sViewName,componentId:this._sOwnerId,id:this.getId(),caller:this+" ("+this.sViewName+")",sync:!!e}}if(p._supportInfo){this.oPreprocessorInfo._supportInfo=p._supportInfo}return this.oPreprocessorInfo};p.prototype.runPreprocessor=function(r,t,o){var n=this.getPreprocessorInfo(o),s=this.mPreprocessors&&this.mPreprocessors[r]||[],i,a,p;if(!o){a=function(e,r){return function(t){return r.preprocessor.then(function(o){return o.process(t,e,r._settings)})}};p=Promise.resolve(t)}for(var c=0,u=s.length;c<u;c++){if(o&&s[c]._syncSupport===true){i=s[c].preprocessor.process;t=i(t,n,s[c]._settings)}else if(!o){p=p.then(a(n,s[c]))}else{e.sap.log.debug('Async "'+r+'"-preprocessor was skipped in sync view execution for '+this.getMetadata().getClass()._sType+"View",this.getId())}}return o?t:p};function h(e,r){if(!p._mPreprocessors[r]){p._mPreprocessors[r]={}}if(!p._mPreprocessors[r][e]){p._mPreprocessors[r][e]=[]}}function y(r,t,o){p._mPreprocessors[t][o].forEach(function(t){if(t._onDemand){e.sap.log.error('Registration for "'+o+'" failed, only one on-demand-preprocessor allowed',r.getMetadata().getName());return false}});return true}p.registerPreprocessor=function(r,t,o,n,s,i){if(typeof s!=="boolean"){i=s;s=false}if(t){h(r,o);if(s&&!y(this,o,r)){return}p._mPreprocessors[o][r].push({preprocessor:t,_onDemand:s,_syncSupport:n,_settings:i});e.sap.log.debug("Registered "+(s?"on-demand-":"")+'preprocessor for "'+r+'"'+(n?" with syncSupport":""),this.getMetadata().getName())}else{e.sap.log.error('Registration for "'+r+'" failed, no preprocessor specified',this.getMetadata().getName())}};p.prototype.hasPreprocessor=function(e){return!!this.mPreprocessors[e].length};p.create=function(e){var t=n(true,{},e);t.async=true;t.viewContent=t.definition;var o=sap.ui.require("sap/ui/core/Component");var s;if(o&&r._sOwnerId){s=o.get(r._sOwnerId)}function i(){return v(t.id,t,t.type).loaded()}return new Promise(function(e,r){var o=w(t);sap.ui.require([o],function(r){e(r)},function(e){r(e)})}).then(function(e){if(s){return s.runAsOwner(i)}else{return i()}})};sap.ui.view=function(r,t,o){if(t&&t.async){e.sap.log.info("Do not use deprecated factory function 'sap.ui.view'. Use 'sap.ui.mvc.View.create' instead")}else{e.sap.log.warning("Do not use synchronous view creation! Use the new asynchronous factory 'sap.ui.mvc.View.create' instead")}return v(r,t,o)};function v(t,o,n){var s=null,i={};if(typeof t==="object"||typeof t==="string"&&o===undefined){o=t;t=undefined}if(o){if(typeof o==="string"){i.viewName=o}else{i=o}}e.sap.assert(!i.async||typeof i.async==="boolean","sap.ui.view factory: Special setting async has to be of the type 'boolean'!");if(t){i.id=t}if(n){i.type=n}var a=sap.ui.require("sap/ui/core/CustomizingConfiguration");if(a){var p=a.getViewReplacement(i.viewName,r._sOwnerId);if(p){e.sap.log.info("Customizing: View replacement for view '"+i.viewName+"' found and applied: "+p.viewName+" (type: "+p.type+")");e.extend(i,p)}else{e.sap.log.debug("Customizing: no View replacement found for view '"+i.viewName+"'.")}}var c=w(i);s=P(c,i);return s}function w(e){var r;if(!e.type){throw new Error("No view type specified.")}else if(e.type===a.JS){r="sap/ui/core/mvc/JSView"}else if(e.type===a.JSON){r="sap/ui/core/mvc/JSONView"}else if(e.type===a.XML){r="sap/ui/core/mvc/XMLView"}else if(e.type===a.HTML){r="sap/ui/core/mvc/HTMLView"}else if(e.type===a.Template){r="sap/ui/core/mvc/TemplateView"}else{throw new Error("Unknown view type "+e.type+" specified.")}return r}function P(r,t){var o=sap.ui.require(r);if(!o){o=sap.ui.requireSync(r);if(t.async){e.sap.log.warning("sap.ui.view was called without requiring the according view class.")}}return new o(t)}p.prototype.loaded=function(){if(this.oAsyncState&&this.oAsyncState.promise){return this.oAsyncState.promise}else{return Promise.resolve(this)}};return p});