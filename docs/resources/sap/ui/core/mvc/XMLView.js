/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./View","./XMLViewRenderer","sap/base/util/extend","sap/ui/base/ManagedObject","sap/ui/core/XMLTemplateProcessor","sap/ui/core/library","sap/ui/core/Control","sap/ui/core/RenderManager","sap/ui/core/cache/CacheManager","sap/ui/model/resource/ResourceModel","jquery.sap.xml","jquery.sap.script"],function(e,t,n,r,i,o,s,a,u,c,l){"use strict";var p=u.RenderPrefixes,d=s.mvc.ViewType,f="XMLViewCacheError",h={};var m=t.extend("sap.ui.core.mvc.XMLView",{metadata:{library:"sap.ui.core",specialSettings:{containingView:{type:"sap.ui.core.mvc.XMLView",visibility:"hidden"},xmlNode:{type:"Element",visibility:"hidden"},cache:"Object",processingMode:{type:"string",defaultValue:"",visibility:"hidden"}},designtime:"sap/ui/core/designtime/mvc/XMLView.designtime"}});sap.ui.xmlview=function(e,t){return sap.ui.view(e,t,d.XML)};m.create=function(e){var n=r(true,{},e);n.viewContent=n.definition;n.async=true;n.type=d.XML;n.processingMode=n.processingMode||"sequential";return t.create(n)};m._sType=d.XML;m.asyncSupport=true;m._bUseCache=sap.ui.getCore().getConfiguration().getViewCache()&&c._isSupportedEnvironment();function g(e){if(e.parseError.errorCode!==0){var t=e.parseError;throw new Error("The following problem occurred: XML parse Error for "+t.url+" code: "+t.errorCode+" reason: "+t.reason+" src: "+t.srcText+" line: "+t.line+" linepos: "+t.linepos+" filepos: "+t.filepos)}}function v(e,t){if(!t){throw new Error("mSettings must be given")}else if(t.viewName&&t.viewContent){throw new Error("View name and view content are given. There is no point in doing this, so please decide.")}else if((t.viewName||t.viewContent)&&t.xmlNode){throw new Error("View name/content AND an XML node are given. There is no point in doing this, so please decide.")}else if(!(t.viewName||t.viewContent)&&!t.xmlNode){throw new Error("Neither view name/content nor an XML node is given. One of them is required.")}else if(t.cache&&!(t.cache.keys&&t.cache.keys.length)){throw new Error("No cache keys provided. At least one is required.")}}function w(t,n){t.mProperties["viewContent"]=n.viewContent;var r=e.sap.parseXML(n.viewContent);g(r);return r.documentElement}function y(e,t){if((e._resourceBundleName||e._resourceBundleUrl)&&(!t.models||!t.models[e._resourceBundleAlias])){var n=new l({bundleName:e._resourceBundleName,bundleUrl:e._resourceBundleUrl,bundleLocale:e._resourceBundleLocale});e.setModel(n,e._resourceBundleAlias)}}function C(e){e.oAfterRenderingNotifier=new R;e.oAfterRenderingNotifier.addDelegate({onAfterRendering:function(){e.onAfterRenderingBeforeChildren()}})}function M(e){var t=sap.ui.require("sap/ui/core/Component"),n;while(e&&t){var r=t.getOwnerComponentFor(e);if(r){e=n=r}else{if(e instanceof t){n=e}e=e.getParent&&e.getParent()}}return n}function b(t,n){var r=M(t),i=r?JSON.stringify(r.getManifest()):null,o=[];o=o.concat(_(t,r),L(),N(t),n.keys);return P(t,o).then(function(t){return{key:t+"("+e.sap.hashCode(i||"")+")",componentManifest:i,additionalData:n.additionalData}})}function x(e){return e}function P(e,t){return Promise.all(t).then(function(e){e=e.filter(function(e){return e!==h});if(e.every(x)){return e.join("_")}else{var t=new Error("Provided cache keys may not be empty or undefined.");t.name=f;return Promise.reject(t)}})}function _(e,t){var n=t&&t.getMetadata().getName();return[n||window.location.host+window.location.pathname,e.getId(),sap.ui.getCore().getConfiguration().getLanguageTag()]}function N(e){var t=e.getPreprocessors(),n=e.getPreprocessorInfo(false),r=[];function i(e){r.push(e.preprocessor.then(function(e){if(e.getCacheKey){return e.getCacheKey(n)}else{return h}}))}for(var o in t){t[o].forEach(i)}return r}function L(){return sap.ui.getVersionInfo({async:true}).then(function(e){var t="";if(!e.libraries){t=sap.ui.buildinfo.buildtime}else{e.libraries.forEach(function(e){t+=e.buildTimestamp})}return t}).catch(function(t){e.sap.log.warning("sap.ui.getVersionInfo could not be retrieved","sap.ui.core.mvc.XMLView");e.sap.log.debug(t);return""})}function V(t,n){var r=t.key;delete t.key;t.xml=e.sap.serializeXML(n);return c.set(r,t)}function E(t){return c.get(t.key).then(function(n){if(n&&n.componentManifest==t.componentManifest){n.xml=e.sap.parseXML(n.xml,"application/xml").documentElement;if(n.additionalData){e.extend(true,t.additionalData,n.additionalData)}return n}})}m.prototype.initViewSettings=function(n){var r=this,i;function s(i){r._xContent=i;if(t._supportInfo){t._supportInfo({context:r._xContent,env:{caller:"view",viewinfo:e.extend(true,{},r),settings:e.extend(true,{},n||{}),type:"xmlview"}})}if(!r.isSubView()){var s={};o.parseViewAttributes(i,r,s);if(!n.async){e.sap.extend(n,s)}else{r.applySettings(s)}}else{delete n.controller}y(r,n);C(r)}function a(e,t){if(r.hasPreprocessor("viewxml")){return o.enrichTemplateIdsPromise(e,r,t).then(function(){return r.runPreprocessor("viewxml",e,!t)})}return e}function u(e){return r.runPreprocessor("xml",e).then(function(e){return a(e,true)})}function c(t){return e.sap.loadResource(t,{async:true}).then(function(e){return e.documentElement})}function l(e,t){return c(e).then(u).then(function(e){if(t){V(t,e)}return e})}function p(t,n){return b(r,n).then(function(e){return E(e).then(function(n){if(!n){return l(t,e)}else{return n.xml}})}).catch(function(n){if(n.name===f){e.sap.log.debug(n.message,n.name,"sap.ui.core.mvc.XMLView");e.sap.log.debug("Processing the View without caching.","sap.ui.core.mvc.XMLView");return l(t)}else{return Promise.reject(n)}})}this._oContainingView=n.containingView||this;this._sProcessingMode=n.processingMode;if(this.oAsyncState){this.oAsyncState.suppressPreserve=true}v(this,n);if(n.viewName){var d=e.sap.getResourceName(n.viewName,".view.xml");if(n.async){if(n.cache&&m._bUseCache){return p(d,n.cache).then(s)}else{return c(d).then(u).then(s)}}else{i=e.sap.loadResource(d).documentElement}}else if(n.viewContent){if(n.viewContent.nodeType===window.Node.DOCUMENT_NODE){i=n.viewContent.documentElement}else{i=w(this,n)}}else if(n.xmlNode){i=n.xmlNode}if(n.async){return u(i).then(s)}else{i=this.runPreprocessor("xml",i,true);i=a(i,false);if(i&&typeof i.then==="function"){if(i.isRejected()){throw i.getResult()}i=i.getResult()}s(i)}};m.prototype.exit=function(){if(this.oAfterRenderingNotifier){this.oAfterRenderingNotifier.destroy()}t.prototype.exit.apply(this,arguments)};m.prototype.onControllerConnected=function(e){var t=this;function n(e){return i.runWithPreprocessors(e,{settings:t._fnSettingsPreprocessor})}if(!this.oAsyncState){this._aParsedContent=n(o.parseTemplate.bind(null,this._xContent,this))}else{return o.parseTemplatePromise(this._xContent,this,true,{fnRunWithPreprocessor:n}).then(function(e){t._aParsedContent=e;delete t.oAsyncState.suppressPreserve})}};m.prototype.getControllerName=function(){return this._controllerName};m.prototype.isSubView=function(){return this._oContainingView!=this};m.prototype.onAfterRenderingBeforeChildren=function(){if(this._$oldContent.length!==0){var t=this.getAggregation("content");if(t){for(var n=0;n<t.length;n++){var r=t[n].getDomRef()||e.sap.domById(p.Invisible+t[n].getId());if(r){e.sap.byId(p.Dummy+t[n].getId(),this._$oldContent).replaceWith(r)}}}e.sap.byId(p.Dummy+this.getId()).replaceWith(this._$oldContent)}this._$oldContent=undefined};m.prototype._onChildRerenderedEmpty=function(t,n){e(n).replaceWith('<div id="'+p.Dummy+t.getId()+'" class="sapUiHidden"/>');return true};m.prototype.destroy=function(e){var n=u.findPreservedContent(this.getId());if(n){n.remove()}if(e=="KeepDom"&&this.getDomRef()){this.getDomRef().removeAttribute("data-sap-ui-preserve")}t.prototype.destroy.call(this,e)};m.registerPreprocessor=function(n,r,i,o,s){n=n.toUpperCase();if(m.PreprocessorType[n]){t.registerPreprocessor(m.PreprocessorType[n],r,this.getMetadata().getClass()._sType,i,o,s)}else{e.sap.log.error('Preprocessor could not be registered due to unknown sType "'+n+'"',this.getMetadata().getName())}};m.PreprocessorType={XML:"xml",VIEWXML:"viewxml",CONTROLS:"controls"};var R=a.extend("sap.ui.core.mvc.XMLAfterRenderingNotifier",{metadata:{library:"sap.ui.core"},renderer:function(e,t){e.write("")}});m.registerPreprocessor("xml","sap.ui.core.util.XMLPreprocessor",true,true);return m});