/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","./Core","sap/ui/thirdparty/URI"],function(e,t,r,o){"use strict";var a=sap.ui.getCore().getConfiguration();var n=a.getLanguage();var i=a.getAppCacheBusterMode()==="sync";var s=a.getAppCacheBusterMode()==="batch";var p={index:{},active:false};var u,c,l,f,g;var d=document.baseURI.replace(/\?.*|#.*/g,"");var h=o(e.sap.getModulePath("","/../"));var v=h.toString();if(h.is("relative")){h=h.absoluteTo(d)}var y=h.normalize().toString();var L=o("resources").absoluteTo(y).toString();var b=new RegExp("^"+e.sap.escapeRegExp(L));var m=function(e){if(e.length>0&&e.slice(-1)!=="/"){e+="/"}return e};var x=function(t,r){var o=p.index;var a;var u;var c;if(Array.isArray(t)&&!s){t.forEach(function(e){x(e,r)})}else if(Array.isArray(t)&&s){var l=m(t[0]);var f=[];e.sap.log.debug('sap.ui.core.AppCacheBuster.register("'+l+'"); // BATCH MODE!');var g=C.normalizeURL(l);e.sap.log.debug('  --\x3e normalized to: "'+g+'"');t.forEach(function(e){u=m(e);var t=C.normalizeURL(u);if(!o[c]){f.push(t)}});if(f.length>0){var u=g+"sap-ui-cachebuster-info.json?sap-ui-language="+n;a={url:u,type:"POST",async:!i&&!!r,dataType:"json",contentType:"text/plain",data:f.join("\n"),success:function(t){C.onIndexLoaded(u,t);e.extend(o,t)},error:function(){e.sap.log.error('Failed to batch load AppCacheBuster index file from: "'+u+'".')}}}}else{t=m(t);e.sap.log.debug('sap.ui.core.AppCacheBuster.register("'+t+'");');c=C.normalizeURL(t);e.sap.log.debug('  --\x3e normalized to: "'+c+'"');if(!o[c]){var u=c+"sap-ui-cachebuster-info.json?sap-ui-language="+n;a={url:u,async:!i&&!!r,dataType:"json",success:function(e){C.onIndexLoaded(u,e);o[c]=e},error:function(){e.sap.log.error('Failed to load AppCacheBuster index file from: "'+u+'".')}}}}if(a){var d=C.onIndexLoad(a.url);if(d!=null){e.sap.log.info('AppCacheBuster index file injected for: "'+u+'".');a.success(d)}else{if(a.async){var h=r.startTask("load "+u);var v=a.success,y=a.error;e.extend(a,{success:function(e){v.apply(this,arguments);r.finishTask(h)},error:function(){y.apply(this,arguments);r.finishTask(h,false)}})}e.sap.log.info('Loading AppCacheBuster index file from: "'+u+'".');e.ajax(a)}}};var C={boot:function(e){var t=a.getAppCacheBuster();if(t&&t.length>0){t=t.slice();var r=true;var n=String(t[0]).toLowerCase();if(t.length===1){if(n==="true"||n==="x"){var i=o(v);t=i.is("relative")?[i.toString()]:[]}else if(n==="false"){r=false}}if(r){C.init();x(t,e)}}},init:function(){p.active=true;u=t.prototype.validateProperty;c=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src");l=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href");var r=C.convertURL;var o=C.normalizeURL;var a=function(e){if(this.active===true&&e&&typeof e==="string"){e=o(e);return!e.match(b)}return false}.bind(p);f=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,t){if(t&&a(t)){arguments[1]=r(t)}f.apply(this,arguments)};g=XMLHttpRequest.prototype.open;t.prototype.validateProperty=function(e,t){var o=this.getMetadata(),n=o.getProperty(e),i;if(n&&n.type==="sap.ui.core.URI"){i=Array.prototype.slice.apply(arguments);try{if(a(i[1])){i[1]=r(i[1])}}catch(e){}}return u.apply(this,i||arguments)};var n=function(e){var t={get:e.get,set:function(t){if(a(t)){t=r(t)}e.set.call(this,t)},enumerable:e.enumerable,configurable:e.configurable};t.set._sapUiCoreACB=true;return t};var i=false;try{Object.defineProperty(HTMLScriptElement.prototype,"src",n(c))}catch(t){e.sap.log.error("Your browser doesn't support redefining the src property of the script tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+t);i=true}try{Object.defineProperty(HTMLLinkElement.prototype,"href",n(l))}catch(t){e.sap.log.error("Your browser doesn't support redefining the href property of the link tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+t);i=true}if(i){this.exit()}},exit:function(){t.prototype.validateProperty=u;if(XMLHttpRequest.prototype.open===g){XMLHttpRequest.prototype.open=f}var e;if((e=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src"))&&e.set&&e.set._sapUiCoreACB===true){Object.defineProperty(HTMLScriptElement.prototype,"src",c)}if((e=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href"))&&e.set&&e.set._sapUiCoreACB===true){Object.defineProperty(HTMLLinkElement.prototype,"href",l)}p.index={};p.active=false;p={index:{},active:false}},register:function(e){x(e)},convertURL:function(t){e.sap.log.debug('sap.ui.core.AppCacheBuster.convertURL("'+t+'");');var r=p.index;if(r&&t){var o=C.normalizeURL(t);e.sap.log.debug('  --\x3e normalized to: "'+o+'"');if(o&&C.handleURL(o)){e.each(r,function(r,a){var n;if(r&&o.length>=r.length&&o.slice(0,r.length)===r){n=o.slice(r.length);if(a[n]){t=r+"~"+a[n]+"~/"+n;e.sap.log.debug('  ==> rewritten to "'+t+'";');return false}}})}}return t},normalizeURL:function(e){var t=o(e||"./");if(t.is("relative")){t=t.absoluteTo(d)}return t.normalizeProtocol().normalizeHostname().normalizePort().normalizePath().toString()},handleURL:function(e){return true},onIndexLoad:function(e){return null},onIndexLoaded:function(e,t){}};var A=a.getAppCacheBusterHooks();if(A){["handleURL","onIndexLoad","onIndexLoaded"].forEach(function(e){if(typeof A[e]==="function"){C[e]=A[e]}})}return C},true);