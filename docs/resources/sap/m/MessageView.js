/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Control","sap/ui/core/CustomData","sap/ui/core/IconPool","sap/ui/core/HTML","sap/ui/core/Icon","./Button","./Toolbar","./ToolbarSpacer","./List","./StandardListItem","./library","./Text","./SegmentedButton","./Page","./NavContainer","./Link","./MessageItem","./GroupHeaderListItem","sap/ui/core/library","sap/ui/base/ManagedObject","./MessageViewRenderer","jquery.sap.keycodes"],function(e,t,i,s,a,n,o,r,l,g,p,u,c,d,h,_,f,y,m,v,I,L){"use strict";var T=v.ValueState;var P=v.MessageType;var M=u.ListType;var C=t.extend("sap.m.MessageView",{metadata:{library:"sap.m",properties:{asyncDescriptionHandler:{type:"any",group:"Behavior",defaultValue:null},asyncURLHandler:{type:"any",group:"Behavior",defaultValue:null},groupItems:{type:"boolean",group:"Behavior",defaultValue:false},showDetailsPageHeader:{type:"boolean",group:"Behavior",defaultValue:true}},defaultAggregation:"items",aggregations:{items:{type:"sap.m.MessageItem",multiple:true,singularName:"item"},headerButton:{type:"sap.m.Button",multiple:false},_navContainer:{type:"sap.m.NavContainer",multiple:false,visibility:"hidden"}},events:{afterOpen:{parameters:{openBy:{type:"sap.ui.core.Control"}}},itemSelect:{parameters:{item:{type:"sap.m.MessageItem"},messageTypeFilter:{type:"sap.ui.core.MessageType"}}},listSelect:{parameters:{messageTypeFilter:{type:"sap.ui.core.MessageType"}}},longtextLoaded:{},urlValidated:{}}}});var B="sapMMsgView";var S={back:s.getIconURI("nav-back"),close:s.getIconURI("decline"),information:s.getIconURI("message-information"),warning:s.getIconURI("message-warning"),error:s.getIconURI("message-error"),success:s.getIconURI("message-success")};var w=["all","error","warning","success","information"];var D=["asyncDescriptionHandler","asyncURLHandler"];var k={asyncDescriptionHandler:function(t){var i=t.item.getLongtextUrl();if(i){e.ajax({type:"GET",url:i,success:function(e){t.item.setDescription(e);t.promise.resolve()},error:function(){var s="A request has failed for long text data. URL: "+i;e.sap.log.error(s);t.promise.reject(s)}})}}};C.setDefaultHandlers=function(e){D.forEach(function(t){if(e.hasOwnProperty(t)){k[t]=e[t]}})};C.prototype.init=function(){var e=this;this._bHasHeaderButton=false;this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._createNavigationPages();this._createLists();D.forEach(function(t){if(k.hasOwnProperty(t)){e.setProperty(t,k[t])}})};C.prototype.onBeforeRendering=function(){var e,t=this.getItems();this._clearLists();this._detailsPage.setShowHeader(this.getShowDetailsPageHeader());if(this.getGroupItems()){e=this._groupItems(t);this._fillGroupedLists(e)}else{this._fillLists(t)}var i=this.getHeaderButton();if(i){this._bHasHeaderButton=true;this._oListHeader.insertContent(i,2)}this._clearSegmentedButton();this._fillSegmentedButton();this._fnFilterList(this._getCurrentMessageTypeFilter()||"all");if(t.length===1&&this._oLists.all.getItems()[0].getType()===M.Navigation){this._fnHandleForwardNavigation(this._oLists.all.getItems()[0],"show");this._navContainer._pageStack[this._navContainer._pageStack.length-1].transition="slide"}if(!this.getBindingInfo("items")&&!t.length){this._makeAutomaticBinding()}};C.prototype._fillGroupedLists=function(e){var t=Object.keys(e),i=t.indexOf(""),s,a;if(i!==-1){s=e[""];a=Object.keys(s);a.forEach(function(a){var n=s[a];this._fillLists(n);delete e[""];t.splice(i,1)},this)}t.forEach(function(t){this._fillListsWithGroups(t,e[t])},this)};C.prototype._fillListsWithGroups=function(e,t){var i=Object.keys(t),s=new m({title:e}),a;this._oLists["all"].addAggregation("items",s,true);i.forEach(function(e){this._oLists[e.toLowerCase()].addAggregation("items",s.clone(),true);a=t[e];this._fillLists(a)},this)};C.prototype.exit=function(){if(this._oLists){this._destroyLists()}if(this._oMessageItemTemplate){this._oMessageItemTemplate.destroy()}this._oResourceBundle=null;this._oListHeader=null;this._oDetailsHeader=null;this._oSegmentedButton=null;this._oBackButton=null;this._navContainer=null;this._listPage=null;this._detailsPage=null;this._sCurrentList=null};C.prototype._makeAutomaticBinding=function(){var e=this;this.setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"message");this._oMessageItemTemplate=new y({type:"{message>type}",title:"{message>message}",description:"{message>description}",longtextUrl:"{message>longtextUrl}"});this.bindAggregation("items",{path:"message>/",template:e._oMessageItemTemplate})};C.prototype._groupItems=function(e){var t={},i,s;e.forEach(function(e){i=e.getGroupName();s=e.getType();t[i]=t[i]||{};var a=t[i];if(a[s]){a[s].push(e)}else{a[s]=[e]}});return t};C.prototype._onkeypress=function(t){if(t.shiftKey&&t.keyCode==e.sap.KeyCodes.ENTER){this.navigateBack()}};C.prototype._getListHeader=function(){return this._oListHeader||this._createListHeader()};C.prototype._getDetailsHeader=function(){return this._oDetailsHeader||this._createDetailsHeader()};C.prototype._createListHeader=function(){var e=this._oResourceBundle.getText("MESSAGEPOPOVER_CLOSE");var t=this.getId()+"-CloseBtnDescr";var i=new a(t,{content:'<span id="'+t+'" style="display: none;">'+e+"</span>"});var s=this._oResourceBundle.getText("MESSAGEPOPOVER_ARIA_HEADING");var n=this.getId()+"-HeadingDescr";var o=new a(n,{content:'<span id="'+n+'" style="display: none;" role="heading">'+s+"</span>"});this._oSegmentedButton=new d(this.getId()+"-segmented",{}).addStyleClass("sapMSegmentedButtonNoAutoWidth");this._oListHeader=new r({content:[this._oSegmentedButton,new l,i,o]});return this._oListHeader};C.prototype._createDetailsHeader=function(){var e=this._oResourceBundle.getText("MESSAGEPOPOVER_CLOSE");var t=this.getId()+"-CloseBtnDetDescr";var i=new a(t,{content:'<span id="'+t+'" style="display: none;">'+e+"</span>"});var s=this._oResourceBundle.getText("MESSAGEPOPOVER_ARIA_BACK_BUTTON_TOOLTIP");var n=this._oResourceBundle.getText("MESSAGEPOPOVER_ARIA_BACK_BUTTON");var g=this.getId()+"-BackBtnDetDescr";var p=new a(g,{content:'<span id="'+g+'" style="display: none;">'+n+"</span>"});this._oBackButton=new o({icon:S["back"],press:this.navigateBack.bind(this),ariaLabelledBy:p,tooltip:s}).addStyleClass(B+"BackBtn");this._oDetailsHeader=new r({content:[this._oBackButton,new l,i,p]});return this._oDetailsHeader};C.prototype._createNavigationPages=function(){this._listPage=new h(this.getId()+"listPage",{customHeader:this._getListHeader()});this._detailsPage=new h(this.getId()+"-detailsPage",{customHeader:this._getDetailsHeader()});this._detailsPage.addEventDelegate({onclick:function(e){var t=e.target;if(t.nodeName.toUpperCase()==="A"&&(t.className.indexOf("sapMMsgPopoverItemDisabledLink")!==-1||t.className.indexOf("sapMMsgPopoverItemPendingLink")!==-1)){e.preventDefault()}}});this._navContainer=new _(this.getId()+"-navContainer",{initialPage:this.getId()+"listPage",pages:[this._listPage,this._detailsPage]});this.setAggregation("_navContainer",this._navContainer);return this};C.prototype._createLists=function(){this._oLists={};w.forEach(function(e){this._oLists[e]=new g({itemPress:this._fnHandleItemPress.bind(this),visible:false});this._listPage.addAggregation("content",this._oLists[e],true)},this);return this};C.prototype._clearLists=function(){w.forEach(function(e){if(this._oLists[e]){this._oLists[e].destroyAggregation("items",true)}},this);return this};C.prototype._destroyLists=function(){w.forEach(function(e){this._oLists[e]=null},this);this._oLists=null};C.prototype._fillLists=function(e){e.forEach(function(e){var t=this._mapItemToListItem(e),i=this._mapItemToListItem(e);this._oLists["all"].addAggregation("items",t,true);this._oLists[e.getType().toLowerCase()].addAggregation("items",i,true)},this)};C.prototype._mapItemToListItem=function(e){if(!e){return null}var t=e.getType(),i=this._getItemType(e),s=new p({title:I.escapeSettingsValue(e.getTitle()),description:I.escapeSettingsValue(e.getSubtitle()),counter:e.getCounter(),icon:this._mapIcon(t),infoState:this._mapInfoState(t),info:"\r",type:i}).addStyleClass(B+"Item").addStyleClass(B+"Item"+t);if(i!==M.Navigation){s.addEventDelegate({onAfterRendering:function(){var e=this.getDomRef().querySelector(".sapMSLITitleDiv > div");if(e.offsetWidth<e.scrollWidth){this.setType(M.Navigation)}}},s)}s._oMessageItem=e;return s};C.prototype._mapInfoState=function(t){if(!t){return null}switch(t){case P.Warning:return T.Warning;case P.Error:return T.Error;case P.Success:return T.Success;case P.Information:case P.None:return T.None;default:e.sap.log.warning("The provided MessageType is not mapped to a specific ValueState",t);return null}};C.prototype._mapIcon=function(e){if(!e){return null}return S[e.toLowerCase()]};C.prototype._getItemType=function(e){return e.getDescription()||e.getMarkupDescription()||e.getLongtextUrl()?M.Navigation:M.Inactive};C.prototype._clearSegmentedButton=function(){if(this._oSegmentedButton){this._oSegmentedButton.destroyAggregation("buttons",true)}return this};C.prototype._fillSegmentedButton=function(){var e=this;var t=function(t){return function(){e._fnFilterList(t)}};w.forEach(function(e){var i=this._oLists[e],s=e=="all"?"MESSAGEPOPOVER_ALL":"MESSAGEVIEW_BUTTON_TOOLTIP_"+e.toUpperCase(),a=i.getItems().filter(function(e){return e instanceof p}).length,n;if(a>0){n=new o(this.getId()+"-"+e,{text:e=="all"?this._oResourceBundle.getText(s):a,tooltip:this._oResourceBundle.getText(s),icon:S[e],press:t(e)}).addStyleClass(B+"Btn"+e.charAt(0).toUpperCase()+e.slice(1));this._oSegmentedButton.addButton(n,true)}},this);var i=this._oSegmentedButton.getButtons().length>2;this._oSegmentedButton.setVisible(i);var s=i||this._bHasHeaderButton;this._listPage.setShowHeader(s);return this};C.prototype._setIcon=function(e,t){this._previousIconTypeClass=B+"DescIcon"+e.getType();this._oMessageIcon=new n({src:t.getIcon()}).addStyleClass(B+"DescIcon").addStyleClass(this._previousIconTypeClass);this._detailsPage.addContent(this._oMessageIcon)};C.prototype._setTitle=function(e){this._oMessageTitleText=new c(this.getId()+"MessageTitleText",{text:I.escapeSettingsValue(e.getTitle())}).addStyleClass("sapMMsgViewTitleText");this._detailsPage.addAggregation("content",this._oMessageTitleText)};C.prototype._setDescription=function(e){var t=e.getLink();this._oLastSelectedItem=e;if(e.getMarkupDescription()){this._oMessageDescriptionText=new a(this.getId()+"MarkupDescription",{content:"<div class='sapMMsgViewDescriptionText'>"+e.getDescription()+"</div>"})}else{this._oMessageDescriptionText=new c(this.getId()+"MessageDescriptionText",{text:I.escapeSettingsValue(e.getDescription())}).addStyleClass("sapMMsgViewDescriptionText")}this._detailsPage.addContent(this._oMessageDescriptionText);if(t){var i=this._createLinkCopy(t);this._detailsPage.addContent(i);i.addStyleClass("sapMMsgViewDescriptionLink")}};C.prototype._createLinkCopy=function(e){var t,s=e.clone("","",{cloneChildren:false,cloneBindings:false}),a=e.getCustomData()||[];t=Object.keys(e.getMetadata().getProperties());t.forEach(function(t){s.setProperty(t,e.getProperty(t))});s.destroyCustomData();a.forEach(function(e){var t=new i({key:e.getKey(),value:e.getValue()});s.addCustomData(t)});return s};C.prototype._iNextValidationTaskId=0;C.prototype._validateURL=function(t){if(e.sap.validateUrl(t)){return t}e.sap.log.warning("You have entered invalid URL");return""};C.prototype._queueValidation=function(e){var t=this.getAsyncURLHandler();var i=++this._iNextValidationTaskId;var s={};var a=new window.Promise(function(a,n){s.resolve=a;s.reject=n;var o={url:e,id:i,promise:s};t(o)});a.id=i;return a};C.prototype._getTagPolicy=function(){var t=this,i;var s=html.makeTagPolicy(this._validateURL());return function a(n,o){var r,l=false;if(n.toUpperCase()==="A"){for(i=0;i<o.length;){if(o[i]==="href"){l=true;r=o[i+1];o.splice(0,2);continue}i+=2}}o=s(n,o);if(l&&typeof t.getAsyncURLHandler()==="function"){o=o||[];var g="sapMMsgViewItemDisabledLink sapMMsgViewItemPendingLink";var p=o.indexOf("class");if(p>-1){o[p+1]+=g}else{o.unshift(g);o.unshift("class")}var u=o.indexOf("id");if(u>-1){o.splice(u+1,1);o.splice(u,1)}var c=t._queueValidation(r);o.push("href");o.push(r);o.push("target");o.push("_blank");o.push("id");o.push("sap-ui-"+t.getId()+"-link-under-validation-"+c.id);c.then(function(i){var s=e.sap.byId("sap-ui-"+t.getId()+"-link-under-validation-"+i.id);if(i.allowed){e.sap.log.info("Allow link "+r)}else{e.sap.log.info("Disallow link "+r)}s.removeClass("sapMMsgViewItemPendingLink");s.toggleClass("sapMMsgViewItemDisabledLink",!i.allowed);t.fireUrlValidated()}).catch(function(){e.sap.log.warning("Async URL validation could not be performed.")})}return o}};C.prototype._sanitizeDescription=function(t){e.sap.require("jquery.sap.encoder");e.sap.require("sap.ui.thirdparty.caja-html-sanitizer");var i=t.getDescription();if(t.getMarkupDescription()){var s=this._getTagPolicy();i=html.sanitizeWithPolicy(i,s)}t.setDescription(i);this._setDescription(t)};C.prototype._fnHandleForwardNavigation=function(t,i){var s=t._oMessageItem,a=this._detailsPage.getContent()||[],n=this.getAsyncDescriptionHandler();this._previousIconTypeClass=this._previousIconTypeClass||"";this.fireItemSelect({item:s,messageTypeFilter:this._getCurrentMessageTypeFilter()});this._clearDetailsPage.call(this,a);if(typeof n==="function"&&!!s.getLongtextUrl()){s.setMarkupDescription(true);var o={};var r=new window.Promise(function(e,t){o.resolve=e;o.reject=t});var l=function(){this._detailsPage.setBusy(false);this._navigateToDetails.call(this,s,t,i,true)}.bind(this);r.then(l).catch(function(){e.sap.log.warning("Async description loading could not be performed.");l()});this._navContainer.to(this._detailsPage);this._detailsPage.setBusy(true);n({promise:o,item:s})}else{this._navigateToDetails.call(this,s,t,i,false)}this._listPage.$().attr("aria-hidden","true")};C.prototype._fnHandleItemPress=function(e){this._fnHandleForwardNavigation(e.getParameter("listItem"),"slide")};C.prototype._navigateToDetails=function(e,t,i,s){this._setTitle(e);this._sanitizeDescription(e);this._setIcon(e,t);this._detailsPage.rerender();this.fireLongtextLoaded();if(!s){this._navContainer.to(this._detailsPage,i)}};C.prototype._clearDetailsPage=function(e){e.forEach(function(e){e.destroy()},this)};C.prototype.navigateBack=function(){this._listPage.$().removeAttr("aria-hidden");this._navContainer.back()};C.prototype._fnFilterList=function(e){w.forEach(function(t){if(t!=e&&this._oLists[t].getVisible()){this._oLists[t].setVisible(false)}},this);this._sCurrentList=e;this._oLists[e].setVisible(true);this._listPage.rerender();this.fireListSelect({messageTypeFilter:this._getCurrentMessageTypeFilter()})};C.prototype._getCurrentMessageTypeFilter=function(){return this._sCurrentList=="all"?"":this._sCurrentList};C.prototype._isListPage=function(){return this._navContainer.getCurrentPage()==this._listPage};return C});