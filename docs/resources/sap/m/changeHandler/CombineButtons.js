/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","jquery.sap.global"],function(e,t){"use strict";var n={};n.applyChange=function(t,n,o){if(o.modifier.targets!=="jsControlTree"){throw new Error("Combine buttons change can't be applied on XML tree")}var r=t.getDefinition(),i=o.modifier,a=e.getViewForControl(n),g=i.bySelector(r.content.combineButtonSelectors[0],o.appComponent),c=o.appComponent,u=i.getParent(g),p,s,m,d=sap.ui.getCore().getConfiguration().getRTL(),l,f,C=[],I={menuButtonId:"",parentAggregation:"",insertIndex:0};m=r.content.combineButtonSelectors.map(function(e){return i.bySelector(e,c)});s=m[0].sParentAggregationName;I.parentAggregation=s;p=i.findIndexInParentAggregation(g);I.insertIndex=p;l=i.createControl("sap.m.Menu",o.appComponent,a,r.content.menuIdSelector);m.forEach(function(e,t){var n,g,c=r.content.buttonsIdForSave[t],p=i.getProperty(e,"text");g=i.createControl("sap.m.MenuItem",o.appComponent,a,c);i.setProperty(g,"text",e.mProperties.text);i.setProperty(g,"icon",e.mProperties.icon);g.attachPress(function(t){return e.firePress(t)});if(p){d?C.unshift(p):C.push(p)}c.id=c.id+"-originalButtonId";n=i.createControl("sap.ui.core.CustomData",o.appComponent,a,c);i.setProperty(n,"key","originalButtonId");i.setProperty(n,"value",i.getId(e));i.removeAggregation(u,s,e);i.insertAggregation(g,"dependents",e);i.insertAggregation(g,"customData",n);i.insertAggregation(l,"items",g,t)});f=i.createControl("sap.m.MenuButton",o.appComponent,a,r.content.menuButtonIdSelector);I.menuButtonId=i.getId(f);i.setProperty(f,"text",C.join("/"));i.insertAggregation(f,"menu",l,0);i.insertAggregation(u,s,f,p);t.setRevertData(I);return true};n.revertChange=function(e,t,n){var o=n.modifier,r=e.getRevertData(),i=e.getDefinition(),a=r.parentAggregation,g=r.insertIndex,c=o.bySelector(r.menuButtonId,n.appComponent),u=o.getParent(c),p=i.content.combineButtonSelectors;for(var s=0;s<p.length;s++){var m=o.bySelector(p[s],n.appComponent);o.insertAggregation(u,a,m,g+s)}o.removeAggregation(u,a,c);c.destroy();e.resetRevertData();return true};n.completeChangeContent=function(e,n,o){var r=o.modifier,i=o.appComponent,a=e.getDefinition(),g=n.combineFieldIds;if(g&&g.length>=2){e.addDependentControl(g,"combinedButtons",o);a.content.combineButtonSelectors=g.map(function(e){return r.getSelector(e,i)});a.content.menuButtonIdSelector=r.getSelector(i.createId(t.sap.uid()),i);a.content.menuIdSelector=r.getSelector(i.createId(t.sap.uid()),i);a.content.buttonsIdForSave=g.map(function(){return r.getSelector(i.createId(t.sap.uid()),i)})}else{throw new Error("Combine buttons action cannot be completed: oSpecificChangeInfo.combineFieldIds attribute required")}};return n},true);