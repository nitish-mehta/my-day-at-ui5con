/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/base/EventProvider","sap/ui/base/ManagedObjectObserver","sap/ui/Device"],function(e,t,a,n,i){"use strict";var o=new a,r,s;var d=t.extend("HeaderAdapter",{constructor:function(t,a){if(!t||!a){e.sap.log.error("Cannot initialize: Invalid arguments.");return}this._oHeader=t;this._oStyledPage=null;this._oTitleInfo=null;this._oSubTitleInfo=null;this._oBackButtonInfo=null;this._oAdaptOptions=a}});d.prototype.adapt=function(){var e=this._oAdaptOptions.bStylePage,t=this._oAdaptOptions.bCollapseHeader;if(e){this._toggleStyle("sapF2Adapted",true,true)}this._adaptTitle();this._adaptBackButton();if(t){this._collapseHeader()}return this.getAdaptedContent()};d.prototype.getAdaptedContent=function(){return{oTitleInfo:this._oTitleInfo,oSubTitleInfo:this._oSubTitleInfo,oBackButtonInfo:this._oBackButtonInfo,oStyledPage:this._oStyledPage}};d.prototype._adaptTitle=function(){if(!d._isAdaptableHeader(this._oHeader)||this._oAdaptOptions.bMoveTitle!==true){return false}this._oTitleInfo=this._detectTitle();this._oSubTitleInfo=this._detectSubTitle();var e=!!this._oTitleInfo||!!this._oSubTitleInfo;if(this._oTitleInfo){this._oTitleInfo.oControl.toggleStyleClass("sapF2AdaptedTitle",true)}return e};d.prototype._adaptBackButton=function(){if(!d._isAdaptableHeader(this._oHeader)||this._oAdaptOptions.bHideBackButton!==true){return false}var e,t=false;this._oBackButtonInfo=this._detectBackButton();if(this._oBackButtonInfo){e=this._oBackButtonInfo.oControl.getVisible();this._oBackButtonInfo.oControl.toggleStyleClass("sapF2AdaptedNavigation",e);t=true}return t};d.prototype._toggleStyle=function(e,t,a){var n=this._oHeader.getParent();if(!n){return}this._oStyledPage=n;if(t===true){n.addStyleClass(e,a)}else if(t===false){n.removeStyleClass(e,a)}else if(t===undefined){n.hasStyleClass(e)?n.removeStyleClass(e,a):n.addStyleClass(e,a)}};d._isAdaptableHeader=function(e){if(!e||!f(e,"sap/m/Bar")){return false}var t=e.getParent();return t&&(f(t,"sap/m/Page")||f(t,"sap/m/MessagePage")||f(t,"sap/uxap/ObjectPageHeader"))};d.prototype._detectTitle=function(){var e;if(d._isAdaptableHeader(this._oHeader)){var t=this._oHeader.getContentMiddle();if(t.length===1&&u(t[0])){var a=t[0];e={id:a.getId(),text:a.getText(),oControl:a,sChangeEventId:"_change",sPropertyName:"text"}}}return e};d.prototype._detectSubTitle=function(e){if(f(e,"sap/uxap/ObjectPageHeader")){var t=e.getHeaderTitle();if(t){return{id:t.getId(),text:t.getObjectTitle(),oControl:t,sChangeEventId:"_titleChange",sPropertyName:"objectTitle"}}}};d.prototype._detectBackButton=function(){var e,t;if(d._isAdaptableHeader(this._oHeader)){e=this._oHeader.getContentLeft();if(e.length>0&&f(e[0],"sap/m/Button")&&(e[0].getType()==="Back"||e[0].getType()==="Up"||e[0].getIcon()==="sap-icon://nav-back")){t=e[0];return{id:t.getId(),oControl:t,sChangeEventId:"_change",sPropertyName:"visible"}}}};d.prototype._collapseHeader=function(){var e=this._oTitleInfo,t=this._oBackButtonInfo,a,n,i,o,r,s,g;if(d._isAdaptableHeader(this._oHeader)){a=this._oHeader.getContentLeft();n=this._oHeader.getContentMiddle();i=this._oHeader.getContentRight();o=a.length===1&&(c(a[0])||t);r=n.length===1&&(c(n[0])||e);s=i.length===1&&c(i[0]);g=(a.length===0||o)&&(n.length===0||r)&&(i.length===0||s);this._toggleStyle("sapF2CollapsedHeader",g,true)}};var g=t.extend("sap.m.Fiori20Adapter",{});g.attachViewChange=function(e,t){o.attachEvent("adaptedViewChange",e,t)};g.detachViewChange=function(e,t){o.detachEvent("adaptedViewChange",e,t)};g.traverse=function(e,t){r={aViewTitles:{},aViewSubTitles:{},aViewBackButtons:{},aChangeListeners:{}};s=null;this._doBFS([{oNode:e,oAdaptOptions:t}]);if(this._getCurrentlyAdaptedTopViewId()){this._fireViewChange(this._getCurrentlyAdaptedTopViewId(),t)}};g._doBFS=function(t){var a=t.shift();if(!a){return}var n=a.oNode,i=a.oAdaptOptions,o=i.iSearchDepth;i=this._applyRules(i,n);if(!this._isAdaptationRequired(n,i)||o<=0){return}var r=this._isTopNavigableView(n);if(r){this._setAsCurrentlyAdaptedTopViewId(n.getId())}var s=this._processNode(n,i);var d=this._getNodeChildren(n),g=e.extend({},i,{iSearchDepth:this._updateSearchDepth(o,n)});if(s){var u=!!s.oTitleInfo,l=!!s.oBackButton,p=!!s.oStyledPage;g=e.extend(g,{bMoveTitle:i.bMoveTitle&&!u,bHideBackButton:i.bHideBackButton&&!l,bStylePage:i.bStylePage&&!p})}d.forEach(function(e){if(e){t.push({oNode:e,oAdaptOptions:g})}});this._doBFS(t)};g._processNode=function(e,t){this._attachDefferedAdaptationListeners(e,t);if(d._isAdaptableHeader(e)){return this._adaptHeader(e,t)}if(e.getParent()&&f(e.getParent(),"sap/m/NavContainer")){return this._getCachedViewInfoToMerge(e.getId())}};g._attachDefferedAdaptationListeners=function(e,t){this._attachAdaptableContentChange(e,t);this._attachNavigablePageChange(e,t);if(f(e,"sap/m/Page")){this._attachModifyAggregation(e,"content",t)}if(t.bLateAdaptation===true&&f(e,"sap/m/Bar")){this._attachModifyAggregation(e,"contentLeft",t,e);this._attachModifyAggregation(e,"contentMiddle",t,e);this._attachModifyAggregation(e,"contentRight",t,e)}if(f(e,"sap/ui/core/ComponentContainer")){var a=e.getComponentInstance();if(!a&&e.getName()&&!e.getDomRef()){var n=this;var i={onBeforeRendering:function(){e.removeEventDelegate(i);n._doBFS([{oNode:e.getComponentInstance(),oAdaptOptions:t}]);if(n._getCurrentlyAdaptedTopViewId()){n._fireViewChange(n._getCurrentlyAdaptedTopViewId(),t)}}};e.addEventDelegate(i,this)}}};g._checkHasListener=function(e){return r.aChangeListeners[e]};g._setHasListener=function(e,t){r.aChangeListeners[e]=t};g._attachAdaptableContentChange=function(t,a){if(!t._getAdaptableContent||!e.isFunction(t._getAdaptableContent)){return}var n=t.getId()+"_adaptableContentChange";if(this._checkHasListener(n)){return}var i=this._getCurrentlyAdaptedTopViewId();var o=function(e){var t=e.getParameter("adaptableContent");this._setAsCurrentlyAdaptedTopViewId(i);this._doBFS([{oNode:t,oAdaptOptions:a}]);if(this._getCurrentlyAdaptedTopViewId()){this._fireViewChange(this._getCurrentlyAdaptedTopViewId(),a)}}.bind(this);t.attachEvent("_adaptableContentChange",o);this._setHasListener(n,o)};g._attachNavigablePageChange=function(e,t){if(!f(e,"sap/m/NavContainer")){return}var a=e.getId()+"navigate";if(this._checkHasListener(a)){return}var n=function(e){var a=e.getParameter("to");t=this._applyRules(t,a);this._doBFS([{oNode:a,oAdaptOptions:t}]);if(this._getCurrentlyAdaptedTopViewId()){this._fireViewChange(this._getCurrentlyAdaptedTopViewId(),t)}}.bind(this);e.attachNavigate(n);this._setHasListener(a,n)};g._attachModifyAggregation=function(e,t,a,i){var o=e.getId()+t;if(this._checkHasListener(o)){return}var r=this._getCurrentlyAdaptedTopViewId(),s=function(e){var t=e.mutation,n=e.object;if(t==="add"||t==="insert"){this._setAsCurrentlyAdaptedTopViewId(r);this._doBFS([{oNode:i?i:n,oAdaptOptions:a}]);if(this._getCurrentlyAdaptedTopViewId()){this._fireViewChange(this._getCurrentlyAdaptedTopViewId(),a)}}}.bind(this),d=new n(s);d.observe(e,{aggregations:[t]});this._setHasListener(o,d)};g._getNodeChildren=function(t){if(t._getAdaptableContent&&e.isFunction(t._getAdaptableContent)){var a=[t._getAdaptableContent()];if(f(t,"sap/m/Page")){a=a.concat(t.getContent())}return a}if(f(t,"sap/m/SplitContainer")){return[].concat(t.getAggregation("_navMaster"),t.getAggregation("_navDetail"))}if(f(t,"sap/uxap/ObjectPageLayout")){return[t.getHeaderTitle()]}if(f(t,"sap/ui/core/ComponentContainer")){return[t.getComponentInstance()]}if(f(t,"sap/ui/core/UIComponent")){return[t.getAggregation("rootControl")]}return t.findAggregatedObjects(false,h)};g._updateSearchDepth=function(e,t){if(f(t,"sap/ui/core/mvc/View")||f(t,"sap/ui/core/Component")||f(t,"sap/ui/core/ComponentContainer")){return e}return e-1};g._getTotalCachedInfoToMerge=function(e){var t=sap.ui.getCore().byId(e),a=this._getCachedViewInfoToMerge(e),n,o,r,s,d,g,u;if(!i.system.phone&&this._isTopSplitContainerSubView(t)){g=t.getParent();d=g&&g.getParent();if(d){n=d._oMasterNav&&d._oMasterNav.getId()===g.getId();o=d._oDetailNav&&d._oDetailNav.getId()===g.getId()}}if(n){r=d.getCurrentDetailPage();s=r&&r.getId();u=this._getCachedViewInfoToMerge(s);a=this._mergeSplitViewInfos(a,u)}if(o){r=d.getCurrentMasterPage();s=r&&r.getId();u=this._getCachedViewInfoToMerge(s);a=this._mergeSplitViewInfos(u,a)}a.sViewId=n||o?d.getId():e;return a};g._isTopSplitContainerSubView=function(e){var t=e&&e.getParent();return this._isTopmostNavContainer(t)&&f(t.getParent(),"sap/m/SplitContainer")};g._mergeSplitViewInfos=function(t,a){e.each(t,function(e,n){t[e]=n||a[e]});return t};g._getCachedViewInfoToMerge=function(e){var t=r.aViewBackButtons[e]?r.aViewBackButtons[e].oControl:undefined;return{oTitleInfo:r.aViewTitles[e],oSubTitleInfo:r.aViewSubTitles[e],oBackButton:t}};g._applyRules=function(t,a){var n=a.getParent();if(f(n,"sap/m/SplitContainer")){var o=i.system.phone,r=t.bMoveTitle,s=t.bHideBackButton;if(r){r=o}if(s&&!i.system.phone){s="initialPage"}return e.extend({},t,{bMoveTitle:r,bHideBackButton:s})}if(f(n,"sap/m/NavContainer")){if(t.bHideBackButton==="initialPage"){var d=n._getActualInitialPage()&&n._getActualInitialPage().getId()===a.getId();return e.extend({},t,{bHideBackButton:d})}}if(t.bMoveTitle===false||t.bHideBackButton===false){return e.extend({},t,{bCollapseHeader:false})}return t};g._getCurrentlyAdaptedTopViewId=function(){return s};g._setAsCurrentlyAdaptedTopViewId=function(e){s=e};g._isTopNavigableView=function(e){var t=e.getParent();return t&&this._isTopmostNavContainer(t)};g._isTopmostNavContainer=function(e){var t,a=e;while(a){if(f(a,"sap/m/NavContainer")){t=a}a=a.getParent()}return t&&t.getId()===e.getId()};g._adaptHeader=function(e,t){if(!e||!t){return}var a=new d(e,t),n=a.adapt();var i=this._getCurrentlyAdaptedTopViewId();if(n.oTitleInfo){r.aViewTitles[i]=n.oTitleInfo;this._registerTextChangeListener(r.aViewTitles,i,t)}if(n.oSubTitleInfo){r.aViewSubTitles[i]=n.oSubTitleInfo;this._registerTextChangeListener(r.aViewSubTitles,i,t)}if(n.oBackButtonInfo){if(n.oBackButtonInfo.oControl.getVisible()){r.aViewBackButtons[i]=n.oBackButtonInfo}this._registerVisibilityChangeListener(n.oBackButtonInfo,r.aViewBackButtons,i,t)}return n};g._registerTextChangeListener=function(e,t,a){var n=e[t];if(n&&n.oControl&&n.sChangeEventId&&!r.aChangeListeners[n.id]){var i=function(n){var i=e[t];if(n.getParameter("name")!==i.sPropertyName){return}i.text=n.getParameter("newValue");this._fireViewChange(t,a)}.bind(this);n.oControl.attachEvent(n.sChangeEventId,i);r.aChangeListeners[n.id]=i}};g._registerVisibilityChangeListener=function(t,a,n,i){var o;if(t&&t.oControl&&t.sChangeEventId&&!r.aChangeListeners[t.id]){var s=function(r){if(r.getParameter("name")!==t.sPropertyName){return}o=r.getParameter("newValue");if(!o){e.each(a,function(e,n){if(n.oControl.getId()===t.oControl.getId()){delete a[e]}})}var s=t.oControl.getParent();if(d._isAdaptableHeader(s)){g._adaptHeader(s,i);this._fireViewChange(n,i)}}.bind(this);t.oControl.attachEvent(t.sChangeEventId,s);r.aChangeListeners[t.id]=s}};g._fireViewChange=function(e,t){var a=this._getTotalCachedInfoToMerge(e);a.oAdaptOptions=t;o.fireEvent("adaptedViewChange",a)};g._isAdaptationRequired=function(e,t){if(!e||this._isNonAdaptableControl(e)){return false}for(var a in t){if(t.hasOwnProperty(a)&&(t[a]===true||t[a]==="initialPage")){return true}}return false};g._isNonAdaptableControl=function(e){return l(e)};function u(e){return p(e,["sap/m/Label","sap/m/Text","sap/m/Title"])}function l(e){return p(e,["sap/m/List","sap/m/Table","sap/ui/table/Table","sap/ui/table/TreeTable"])}function p(e,t){if(!e||!t){return}return t.some(function(t){return f(e,t)})}function f(e,t){var a=sap.ui.require(t);return a&&e instanceof a}function h(e){return e&&e.sParentAggregationName!=="dependents"}function c(e){return e&&typeof e.getVisible==="function"&&e.getVisible()===false}return g});