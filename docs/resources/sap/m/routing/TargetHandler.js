/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/m/InstanceManager","sap/m/NavContainer","sap/m/SplitContainer","sap/ui/base/Object","sap/ui/core/routing/History","sap/ui/Device"],function(e,t,i,a,s,o,r){"use strict";var n=s.extend("sap.m.routing.TargetHandler",{constructor:function(e){this._aQueue=[];this._oNavigationOrderPromise=Promise.resolve();if(e===undefined){this._bCloseDialogs=true}else{this._bCloseDialogs=!!e}}});n.prototype.setCloseDialogs=function(e){this._bCloseDialogs=!!e;return this};n.prototype.getCloseDialogs=function(){return this._bCloseDialogs};n.prototype.addNavigation=function(e){this._aQueue.push(e)};n.prototype.navigate=function(e){var t=this._createResultingNavigations(e.navigationIdentifier),i=false,a=this._getDirection(e),s;while(t.length){s=this._applyNavigationResult(t.shift().oParams,a);i=i||s}if(i){this._closeDialogs()}};n.prototype._chainNavigation=function(e){this._oNavigationOrderPromise=this._oNavigationOrderPromise.then(e);return this._oNavigationOrderPromise};n.prototype._getDirection=function(e){var t=e.viewLevel,i=o.getInstance(),a=false;if(e.direction==="Backwards"){a=true}else if(isNaN(t)||isNaN(this._iCurrentViewLevel)||t===this._iCurrentViewLevel){if(e.askHistory){a=i.getDirection()==="Backwards"}}else{a=t<this._iCurrentViewLevel}this._iCurrentViewLevel=t;return a};n.prototype._createResultingNavigations=function(e){var t,s,o,n,g,l=[],u,p,f,c,h;while(this._aQueue.length){s=false;o=this._aQueue.shift();n=o.targetControl;p=n instanceof a;f=n instanceof i;u=o.view;g={oContainer:n,oParams:o,bIsMasterPage:p&&!!n.getMasterPage(u.getId())};c=p&&o.preservePageInSplitContainer&&n.getCurrentPage(g.bIsMasterPage)&&e!==o.navigationIdentifier;if(!(f||p)||!u){continue}for(t=0;t<l.length;t++){h=l[t];if(h.oContainer!==n){continue}if(f||r.system.phone){l.splice(t,1);l.push(g);s=true;break}if(h.bIsMasterPage===g.bIsMasterPage){if(c){break}l.splice(t,1);l.push(g);s=true;break}}if(n instanceof a&&!r.system.phone){g.bIsMasterPage=!!n.getMasterPage(u.getId())}if(!s){if(!!n.getCurrentPage(g.bIsMasterPage)&&c){continue}l.push(g)}}return l};n.prototype._applyNavigationResult=function(t,i){var s=t.targetControl,o,r=t.eventData,n=t.transition||"",g=t.transitionParameters,l=t.view.getId(),u=s instanceof a&&!!s.getMasterPage(l);if(s.getDomRef()&&s.getCurrentPage(u).getId()===l){e.sap.log.info("navigation to view with id: "+l+" is skipped since it already is displayed by its targetControl","sap.m.routing.TargetHandler");return false}e.sap.log.info("navigation to view with id: "+l+" the targetControl is "+s.getId()+" backwards is "+i);if(i){o=s.getPreviousPage(u);if(!o||o.getId()!==l){s.insertPreviousPage(l,n,r)}s.backToPage(l,r,g)}else{s.to(l,n,r,g)}return true};n.prototype._closeDialogs=function(){if(!this._bCloseDialogs){return}if(t.hasOpenPopover()){t.closeAllPopovers()}if(t.hasOpenDialog()){t.closeAllDialogs()}if(t.hasOpenLightBox()){t.closeAllLightBoxes()}};return n});