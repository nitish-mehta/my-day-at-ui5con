/*!
* UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
*/
sap.ui.define(["jquery.sap.global","./library","./SliderUtilities","sap/ui/core/Control","sap/ui/core/Popup","./SliderTooltipContainerRenderer"],function(t,e,o,i,r,s){"use strict";var n=i.extend("sap.m.SliderTooltipContainer",{metadata:{library:"sap.m",properties:{enabled:{type:"boolean",group:"Behavior",defaultValue:true},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"0px"}},associations:{associatedTooltips:{type:"sap.m.SliderTooltipBase",multiple:true}}}});n.prototype.init=function(){this.oPopup=new r;this.oPopup.setShadow(false);this.oPopup.setAutoClose(false);this._scrollListener=this._getScrollListener();this._bClosedFromOverflow=false;this._bRtl=sap.ui.getCore().getConfiguration().getRTL()};n.prototype._handleTabNavigation=function(t){var e=this._oParentSlider instanceof sap.m.RangeSlider;t.preventDefault();this[e?"_handleRangeSliderF2":"_handleSliderF2"].apply(this,arguments)};n.prototype._handleSliderF2=function(){this._oParentSlider.focus()};n.prototype._handleRangeSliderF2=function(e){var o=this._oParentSlider._getHandleForTooltip(e.srcControl);t(o).focus()};n.prototype.onsaptabnext=n.prototype._handleTabNavigation;n.prototype.onsaptabprevious=n.prototype._handleTabNavigation;n.prototype.onkeydown=function(t){if(t.keyCode===o.CONSTANTS.F2_KEYCODE){this._handleTabNavigation(t)}};n.prototype.show=function(t){this.oPopup.setContent(this);this._$ParentSlider=t.$();this._oParentSlider=t;this.oPopup.open(0,r.Dock.BeginTop,r.Dock.BeginTop,this._$ParentSlider,"0 -24","flip");document.addEventListener("scroll",this._scrollListener,true)};n.prototype._getScrollListener=function(){return function(){t.sap.clearDelayedCall(this._scrollDebounce);this._scrollDebounce=t.sap.delayedCall(0,this,this.repositionTooltips)}.bind(this)};n.prototype.hide=function(){this.oPopup.close();document.removeEventListener("scroll",this._scrollListener,true)};n.prototype.repositionTooltips=function(){var t=this._oParentSlider instanceof sap.m.RangeSlider,e=this._oParentSlider.getUsedTooltips(),o=this.getAssociatedTooltipsAsControls()[0].$().outerHeight(true);if(this.getDomRef()){this[t?"_positionRangeTooltips":"_positionTooltip"].call(this,e,arguments[0],arguments[1]);this.getDomRef().style["top"]=this._$ParentSlider.offset().top-o+"px";this._handleOverflow()}};n.prototype._positionTooltip=function(t,e,o){var i=this._getTooltipPosition(t[0].getValue(),e,o),r=this._bRtl?"right":"left";if(i){this.getDomRef().children[0].style[r]=i}};n.prototype._handleOverflow=function(){var t=this.getDomRef(),e,i;if(t){e=o.getElementScrollableParent(this._$ParentSlider[0].parentNode);i=o.isScrolledIntoView(this._$ParentSlider[0],e);if(!i){this._bClosedFromOverflow=true;this.hide()}}};n.prototype._positionRangeTooltips=function(t,e,i){var r=this._bRtl,s=r?"right":"left",n=r?"left":"right",l=this._oParentSlider.getRange(),a=o.getPercentOfValue(l[0]>l[1]?l[1]:l[0],e,i),p=o.getPercentOfValue(l[0]>l[1]?l[0]:l[1],e,i),h=this.getAssociatedTooltipsAsControls()[0].$().outerWidth(),d=o.getPercentOfValue(+t[0].getValue(),e,i),c=o.getPercentOfValue(+t[1].getValue(),e,i),u=this._oParentSlider.$("progress"),f=this.$("container"),_=this._$ParentSlider.width(),S=false,T=h-o.CONSTANTS.TOOLTIP_SIDE_PADDING,g=(T+o.CONSTANTS.CHARACTER_WIDTH_PX)/2/_*100,A=a-g-(g*2-(p-a))/2,P={"min-width":2*h+o.CONSTANTS.TOOLTIP_BORDER*2+"px"},D;P[s]="calc("+d+"%"+" - "+(h/2-o.CONSTANTS.HANDLE_HALF_WIDTH)+"px)";P[n]="calc("+(100-c)+"% "+"- "+(h-(h/2-o.CONSTANTS.HANDLE_HALF_WIDTH-o.CONSTANTS.TOOLTIP_BORDER))+"px)";if(u.outerWidth()<=h/2+(h-o.CONSTANTS.HANDLE_HALF_WIDTH)){P[s]="calc("+A+"%"+" + "+o.CONSTANTS.HANDLE_HALF_WIDTH+"px)";S=true}f.css(P);D=this._$ParentSlider.offset();if(f.offset().left+f.outerWidth()>D.left+this._$ParentSlider.outerWidth()){P=this[r?"_getStickedToStart":"_getStickedToEnd"].call(this,P,s,n,S)}if(f.offset().left<=D.left){P=this[r?"_getStickedToEnd":"_getStickedToStart"].call(this,P,s,n,S)}f.css(P)};n.prototype._getStickedToStart=function(t,e){t[e]="0";return t};n.prototype._getStickedToEnd=function(t,e,i,r){var s=this.getAssociatedTooltipsAsControls()[0].$().outerWidth();t[i]="calc(0% - "+2*o.CONSTANTS.HANDLE_HALF_WIDTH+"px)";if(r){t[e]="calc(100% - "+(s+(s-2*o.CONSTANTS.HANDLE_HALF_WIDTH))+"px)"}return t};n.prototype._getTooltipPosition=function(t,e,i){var r=o.getPercentOfValue(+t,e,i),s=this.getAssociatedTooltipsAsControls()[0].$().outerWidth(),n=this._$ParentSlider.outerWidth(),l=100*o.CONSTANTS.SLIDER_SIDE_PADDING/n,a=100*s/n;if(r+l<a/2){return"0"}else if(r-l>100-a/2){return"calc(100% - "+(s-o.CONSTANTS.HANDLE_HALF_WIDTH*2)+"px)"}else{return"calc("+r+"% - "+(s/2-o.CONSTANTS.HANDLE_HALF_WIDTH)+"px)"}};n.prototype.setWidth=function(t){if(this.getDomRef()){this.$().width(t)}return this.setProperty("width",t,true)};n.prototype.getAssociatedTooltipsAsControls=function(){var t=this.getAssociation("associatedTooltips")||[];return t.map(function(t){return sap.ui.getCore().byId(t)})};n.prototype.onmouseout=function(e){var o=t.contains(this._oParentSlider.getDomRef(),document.activeElement),i=t.contains(this.getDomRef(),document.activeElement),r=t.contains(this._oParentSlider.getDomRef(),e.toElement),s=t.contains(this.getDomRef(),e.toElement);if(o||i||r||s){return}this.hide()};n.prototype.onfocusout=function(e){if(t.contains(this._$ParentSlider[0],e.relatedTarget)||t.contains(this.getDomRef(),e.relatedTarget)){return}if(this._bClosedFromOverflow){this._oParentSlider.focus();this._bClosedFromOverflow=false}this.hide()};n.prototype.onBeforeRendering=function(){this._bRtl=sap.ui.getCore().getConfiguration().getRTL()};n.prototype.exit=function(){this._oParentSlider=null;this._$ParentSlider=null;document.removeEventListener("scroll",this._scrollListener,true)};return n});