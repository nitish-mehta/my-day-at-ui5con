/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/core/EnabledPropagator","sap/ui/core/IconPool","./delegate/ValueStateMessage","sap/ui/core/message/MessageMixin","sap/ui/core/library","sap/ui/Device","./InputBaseRenderer","jquery.sap.keycodes"],function(e,t,i,s,a,n,r,o,u,l){"use strict";var p=o.TextDirection;var h=o.TextAlign;var g=o.ValueState;var c=i.extend("sap.m.InputBase",{metadata:{interfaces:["sap.ui.core.IFormContent"],library:"sap.m",properties:{value:{type:"string",group:"Data",defaultValue:null,bindable:"bindable"},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},enabled:{type:"boolean",group:"Behavior",defaultValue:true},valueState:{type:"sap.ui.core.ValueState",group:"Appearance",defaultValue:g.None},name:{type:"string",group:"Misc",defaultValue:null},placeholder:{type:"string",group:"Misc",defaultValue:null},editable:{type:"boolean",group:"Behavior",defaultValue:true},valueStateText:{type:"string",group:"Misc",defaultValue:null},showValueStateMessage:{type:"boolean",group:"Misc",defaultValue:true},textAlign:{type:"sap.ui.core.TextAlign",group:"Appearance",defaultValue:h.Initial},textDirection:{type:"sap.ui.core.TextDirection",group:"Appearance",defaultValue:p.Inherit},required:{type:"boolean",group:"Misc",defaultValue:false}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{change:{parameters:{value:{type:"string"}}}},designtime:"sap/m/designtime/InputBase.designtime"}});s.call(c.prototype);a.insertFontFaceStyle();r.call(c.prototype);c.prototype.bShowLabelAsPlaceholder=!u.support.input.placeholder;c.prototype._getPlaceholder=function(){return this.getPlaceholder()};c.prototype._setLabelVisibility=function(){if(!this.bShowLabelAsPlaceholder){return}var e=this.$("inner").val();this.$("placeholder").css("display",e?"none":"inline")};c.prototype._getInputValue=function(e){e=e===undefined?this.$("inner").val()||"":e.toString();if(this.getMaxLength&&this.getMaxLength()>0){e=e.substring(0,this.getMaxLength())}return e};c.prototype._getInputElementTagName=function(){if(!this._sInputTagElementName){this._sInputTagElementName=this._$input&&this._$input.get(0)&&this._$input.get(0).tagName}return this._sInputTagElementName};c.prototype.init=function(){this._lastValue="";this.bRenderingPhase=false;this.bFocusoutDueRendering=false;this._bIgnoreNextInputEventNonASCII=false;this.bAfterRenderingWasCalled=false;this._oValueStateMessage=new n(this)};c.prototype.onBeforeRendering=function(){if(this._bCheckDomValue&&!this.bRenderingPhase){this._sDomValue=this._getInputValue()}this.bRenderingPhase=true};c.prototype.onAfterRendering=function(){if(this._bCheckDomValue&&this._sDomValue!==this._getInputValue()){this.$("inner").val(this._sDomValue)}this._bCheckDomValue=false;this._setLabelVisibility();this.bRenderingPhase=false;this.bAfterRenderingWasCalled=true};c.prototype.exit=function(){if(this._oValueStateMessage){this._oValueStateMessage.destroy()}this._oValueStateMessage=null};c.prototype.ontouchstart=function(e){e.setMarked()};c.prototype.onfocusin=function(e){this._bIgnoreNextInput=!this.bShowLabelAsPlaceholder&&u.browser.msie&&u.browser.version>9&&!!this.getPlaceholder()&&!this._getInputValue()&&this._getInputElementTagName()==="INPUT";this.$().toggleClass("sapMFocus",true);if(this.shouldValueStateMessageBeOpened()){this.openValueStateMessage()}};c.prototype.onfocusout=function(e){this.bFocusoutDueRendering=this.bRenderingPhase;this.$().toggleClass("sapMFocus",false);if(this.bRenderingPhase){return}this.closeValueStateMessage()};c.prototype.onsapfocusleave=function(e){if(!this.preventChangeOnFocusLeave(e)){this.onChange(e)}};c.prototype.preventChangeOnFocusLeave=function(e){return this.bFocusoutDueRendering};c.prototype.getChangeEventParams=function(){return{}};c.prototype.ontap=function(e){if(this.getEnabled()&&this.getEditable()&&this.bShowLabelAsPlaceholder&&e.target.id===this.getId()+"-placeholder"){this.focus()}};c.prototype.onChange=function(e,t,i){t=t||this.getChangeEventParams();if(!this.getEditable()||!this.getEnabled()){return}var s=this._getInputValue(i);if(s!==this._lastValue){this.setValue(s);if(e){this._bIgnoreNextInputEventNonASCII=false}s=this.getValue();this._lastValue=s;this.fireChangeEvent(s,t);return true}else{this._bCheckDomValue=false}};c.prototype.fireChangeEvent=function(t,i){var s=e.extend({value:t,newValue:t},i);this.fireChange(s)};c.prototype.onValueRevertedByEscape=function(e,t){this.fireEvent("liveChange",{value:e,escPressed:true,previousValue:t,newValue:e})};c.prototype.onsapenter=function(e){this.onChange(e)};c.prototype.onsapescape=function(e){var t=this._getInputValue();if(t!==this._lastValue){e.setMarked();e.preventDefault();this.updateDomValue(this._lastValue);this.onValueRevertedByEscape(this._lastValue,t)}};c.prototype.oninput=function(e){if(this._bIgnoreNextInput&&this.bAfterRenderingWasCalled){this._bIgnoreNextInput=false;this.bAfterRenderingWasCalled=false;e.setMarked("invalid");return}this.bAfterRenderingWasCalled=false;if(!this.getEditable()){e.setMarked("invalid");return}if(this._bIgnoreNextInputEventNonASCII&&this.getValue()===this._lastValue){this._bIgnoreNextInputEventNonASCII=false;e.setMarked("invalid");return}if(document.activeElement!==e.target&&u.browser.msie&&this.getValue()===this._lastValue){e.setMarked("invalid");return}this._bCheckDomValue=true;this._setLabelVisibility()};c.prototype.onkeydown=function(t){if(this.getDomRef("inner").getAttribute("readonly")&&t.keyCode==e.sap.KeyCodes.BACKSPACE){t.preventDefault()}};c.prototype.oncut=function(e){};c.prototype.selectText=function(e,t){this.$("inner").selectText(e,t);return this};c.prototype.getSelectedText=function(){return this.$("inner").getSelectedText()};c.prototype.setProperty=function(e,t,s){if(e=="value"){this._bCheckDomValue=false}return i.prototype.setProperty.apply(this,arguments)};c.prototype.getFocusInfo=function(){var t=i.prototype.getFocusInfo.call(this),s=this.getFocusDomRef();e.extend(t,{cursorPos:0,selectionStart:0,selectionEnd:0});if(s){t.cursorPos=e(s).cursorPos();try{t.selectionStart=s.selectionStart;t.selectionEnd=s.selectionEnd}catch(e){}}return t};c.prototype.applyFocusInfo=function(e){i.prototype.applyFocusInfo.call(this,e);this.$("inner").cursorPos(e.cursorPos);this.selectText(e.selectionStart,e.selectionEnd);return this};c.prototype.bindToInputEvent=function(e){if(this._oInputEventDelegate){this.removeEventDelegate(this._oInputEventDelegate)}this._oInputEventDelegate={oninput:e};return this.addEventDelegate(this._oInputEventDelegate)};c.prototype.updateDomValue=function(e){if(!this.isActive()){return this}e=this._getInputValue(e);if(u.browser.msie&&u.browser.version>9&&!/^[\x00-\x7F]*$/.test(e)){this._bIgnoreNextInput=true}if(this._getInputValue()!==e){this.$("inner").val(e);this._bCheckDomValue=true}this._setLabelVisibility();return this};c.prototype.closeValueStateMessage=function(){if(this._oValueStateMessage){this._oValueStateMessage.close()}};c.prototype.getDomRefForValueStateMessage=function(){return this.getFocusDomRef()};c.prototype.iOpenMessagePopupDuration=0;c.prototype.getValueStateMessageId=function(){return this.getId()+"-message"};c.prototype.getLabels=function(){var e=this.getAriaLabelledBy().map(function(e){return sap.ui.getCore().byId(e)});var t=sap.ui.require("sap/ui/core/LabelEnablement");if(t){e=e.concat(t.getReferencingLabels(this).map(function(e){return sap.ui.getCore().byId(e)}))}return e};c.prototype.openValueStateMessage=function(){if(this._oValueStateMessage){this._oValueStateMessage.open()}};c.prototype.updateValueStateClasses=function(e,t){var i=this.$(),s=this.$("inner"),a=g;if(t!==a.None){i.removeClass("sapMInputBaseState sapMInputBase"+t);s.removeClass("sapMInputBaseStateInner sapMInputBase"+t+"Inner")}if(e!==a.None){i.addClass("sapMInputBaseState sapMInputBase"+e);s.addClass("sapMInputBaseStateInner sapMInputBase"+e+"Inner")}};c.prototype.shouldValueStateMessageBeOpened=function(){return this.getValueState()!==g.None&&this.getEditable()&&this.getEnabled()&&this.getShowValueStateMessage()};c.prototype.setValueState=function(e){var t=this.getValueState();this.setProperty("valueState",e,true);e=this.getValueState();if(e===t){return this}var i=this.getDomRef();if(!i){return this}var s=this.$("inner"),a=g;if(e===a.Error){s.attr("aria-invalid","true")}else{s.removeAttr("aria-invalid")}this.updateValueStateClasses(e,t);if(s[0]===document.activeElement){if(e===a.None){this.closeValueStateMessage()}else if(this.shouldValueStateMessageBeOpened()){this.openValueStateMessage()}}return this};c.prototype.setValueStateText=function(e){this.setProperty("valueStateText",e,true);this.$("message").text(this.getValueStateText());return this};c.prototype.setValue=function(e){e=this.validateProperty("value",e);e=this._getInputValue(e);this.updateDomValue(e);if(u.browser.msie&&u.browser.version>9&&!/^[\x00-\x7F]*$/.test(e)){this._bIgnoreNextInputEventNonASCII=true}if(e!==this.getProperty("value")){this._lastValue=e}this.setProperty("value",e,true);return this};c.prototype.getFocusDomRef=function(){return this.getDomRef("inner")};c.prototype.getIdForLabel=function(){return this.getId()+"-inner"};c.prototype.setTooltip=function(e){var t=this.getDomRef();this._refreshTooltipBaseDelegate(e);this.setAggregation("tooltip",e,true);if(!t){return this}var i=this.getTooltip_AsString();if(i){t.setAttribute("title",i)}else{t.removeAttribute("title")}if(sap.ui.getCore().getConfiguration().getAccessibility()){var s=this.getDomRef("describedby"),a=this.getRenderer().getDescribedByAnnouncement(this),n=this.getId()+"-describedby",r="aria-describedby",o=this.getFocusDomRef(),u=o.getAttribute(r);if(!s&&a){s=document.createElement("span");s.id=n;s.setAttribute("aria-hidden","true");s.className="sapUiInvisibleText";if(this.getAriaDescribedBy){o.setAttribute(r,(this.getAriaDescribedBy().join(" ")+" "+n).trim())}else{o.setAttribute(r,n)}t.appendChild(s)}else if(s&&!a){t.removeChild(s);var l=s.id;if(u&&l){o.setAttribute(r,u.replace(l,"").trim())}}if(s){s.textContent=a}}return this};c.prototype.getAccessibilityInfo=function(){var e=this.getRequired()?"Required":"",t=this.getRenderer();return{role:t.getAriaRole(this),type:sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_INPUT"),description:[this.getValue()||"",t.getLabelledByAnnouncement(this),t.getDescribedByAnnouncement(this),e].join(" ").trim(),focusable:this.getEnabled(),enabled:this.getEnabled(),editable:this.getEnabled()&&this.getEditable()}};Object.defineProperty(c.prototype,"_$input",{get:function(){return this.$("inner")}});return c});