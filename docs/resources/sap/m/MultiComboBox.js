/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./InputBase","./ComboBoxTextField","./ComboBoxBase","./Input","./ToggleButton","./List","./Popover","./library","sap/ui/core/EnabledPropagator","sap/ui/core/IconPool","sap/ui/core/library","sap/ui/Device","sap/ui/core/Item","./MultiComboBoxRenderer","jquery.sap.xml","jquery.sap.keycodes"],function(e,t,i,s,n,o,r,a,l,h,u,p,g,c,f){"use strict";var d=l.ListType;var m=l.ListMode;var I=p.ValueState;var y=p.OpenState;var v=s.extend("sap.m.MultiComboBox",{metadata:{library:"sap.m",designtime:"sap/m/designtime/MultiComboBox.designtime",properties:{selectedKeys:{type:"string[]",group:"Data",defaultValue:[]}},associations:{selectedItems:{type:"sap.ui.core.Item",multiple:true,singularName:"selectedItem"}},events:{selectionChange:{parameters:{changedItem:{type:"sap.ui.core.Item"},selected:{type:"boolean"}}},selectionFinish:{parameters:{selectedItems:{type:"sap.ui.core.Item[]"}}}}}});u.insertFontFaceStyle();h.apply(v.prototype,[true]);v.prototype.onsapend=function(e){sap.m.Tokenizer.prototype.onsapend.apply(this._oTokenizer,arguments)};v.prototype.onsaphome=function(e){sap.m.Tokenizer.prototype.onsaphome.apply(this._oTokenizer,arguments)};v.prototype.onsapdown=function(e){if(!this.getEnabled()||!this.getEditable()){return}e.setMarked();e.preventDefault();var t=this.getSelectableItems();var i=t[0];if(i&&this.isOpen()){this.getListItem(i).focus();return}if(this._oTokenizer.getSelectedTokens().length){return}this._oTraversalItem=this._getNextTraversalItem();if(this._oTraversalItem){this.updateDomValue(this._oTraversalItem.getText());this.selectText(0,this.getValue().length)}};v.prototype.onsapup=function(e){if(!this.getEnabled()||!this.getEditable()){return}e.setMarked();e.preventDefault();if(this._oTokenizer.getSelectedTokens().length){return}this._oTraversalItem=this._getPreviousTraversalItem();if(this._oTraversalItem){this.updateDomValue(this._oTraversalItem.getText());this.selectText(0,this.getValue().length)}};v.prototype.onsapshow=function(t){var i=this.getList(),n=this.getPicker(),o=this.getSelectableItems(),r=this.getSelectedItems(),a,l=i.getItemNavigation(),h,u;u=e(document.activeElement).control()[0];if(u instanceof sap.m.Token){a=this._getItemByToken(u)}else{a=r.length?this._getItemByListItem(this.getList().getSelectedItems()[0]):o[0]}h=this.getItems().indexOf(a);if(l){l.setSelectedIndex(h)}else{this._bListItemNavigationInvalidated=true;this._iInitialItemFocus=h}n.setInitialFocus(i);s.prototype.onsapshow.apply(this,arguments)};v.prototype.onsaphide=v.prototype.onsapshow;v.prototype._selectItemByKey=function(t){var i,s,n,o,r,a=this.isOpen();if(!this.getEnabled()||!this.getEditable()){return}if(t){t.setMarked()}i=this._getUnselectedItems(a?"":this.getValue());for(o=0;o<i.length;o++){if(i[o].getText().toUpperCase()===this.getValue().toUpperCase()){n=i[o];r=true;break}}if(r){s={item:n,id:n.getId(),key:n.getKey(),fireChangeEvent:true,fireFinishEvent:true,suppressInvalidate:true,listItemUpdated:false};this._bPreventValueRemove=false;if(this.getValue()===""||e.sap.startsWithIgnoreCase(n.getText(),this.getValue())){if(this.getListItem(n).isSelected()){this.setValue("")}else{this.setSelection(s)}}}else{this._bPreventValueRemove=true;this._showWrongValueVisualEffect()}if(t){this.close()}};v.prototype.onsapenter=function(e){t.prototype.onsapenter.apply(this,arguments);if(this.getValue()){this._selectItemByKey(e)}};v.prototype.onsaptabnext=function(e){var t=this.getValue();if(t){var i=this._getUnselectedItemsStartingText(t);if(i.length===1){this._selectItemByKey(e)}else{this._showWrongValueVisualEffect()}}};v.prototype.onsapfocusleave=function(t){var i=this.getAggregation("picker"),s=this.isPlatformTablet(),n=sap.ui.getCore().byId(t.relatedControlId),o=n&&n.getFocusDomRef(),r=this.getValue();if(!i||!i.getFocusDomRef()||!o||!e.contains(i.getFocusDomRef(),o)){this.setValue(null);if(r){this.fireChangeEvent("",{value:r})}if(!(n instanceof sap.m.Token)){this._oTokenizer.scrollToEnd()}}if(i&&o){if(e.sap.equal(i.getFocusDomRef(),o)&&!s&&!this.isPickerDialog()){this.focus()}}};v.prototype.onfocusin=function(e){var t=this.getPickerType()==="Dropdown";if(e.target===this.getFocusDomRef()){this.getEditable()&&this.addStyleClass("sapMMultiComboBoxFocus")}if(e.target===this.getOpenArea()&&t&&!this.isPlatformTablet()){this.focus()}if(!this.isOpen()&&this.shouldValueStateMessageBeOpened()){this.openValueStateMessage()}};v.prototype._handleItemTap=function(e){if(e.target.childElementCount===0||e.target.childElementCount===2){this._bCheckBoxClicked=false;if(this.isOpen()&&!this._isListInSuggestMode()){this.close()}}};v.prototype._handleItemPress=function(e){if(this.isOpen()&&this._isListInSuggestMode()&&this.getPicker().oPopup.getOpenState()!==y.CLOSING){this.clearFilter();var t=this._getLastSelectedItem();if(t){this.getListItem(t).focus()}}};v.prototype._handleSelectionLiveChange=function(t){var i=t.getParameter("listItem");var s=t.getParameter("selected");var n=this._getItemByListItem(i);if(i.getType()==="Inactive"){return}e.sap.assert(n,"The corresponding mapped item was not found on "+this);if(!n){return}var o={item:n,id:n.getId(),key:n.getKey(),fireChangeEvent:true,suppressInvalidate:true,listItemUpdated:true};if(s){this.fireChangeEvent(n.getText());this.setSelection(o)}else{this.fireChangeEvent(n.getText());this.removeSelection(o)}if(this._bCheckBoxClicked){this.setValue(this._sOldValue);if(this.isOpen()&&this.getPicker().oPopup.getOpenState()!==y.CLOSING){i.focus()}}else{this._bCheckBoxClicked=true;this.setValue("");this.close()}};v.prototype.onkeydown=function(t){s.prototype.onkeydown.apply(this,arguments);if(!this.getEnabled()||!this.getEditable()){return}this._bIsPasteEvent=(t.ctrlKey||t.metaKey)&&t.which===e.sap.KeyCodes.V;if(this.getValue().length===0&&(t.ctrlKey||t.metaKey)&&t.which===e.sap.KeyCodes.A&&this._hasTokens()){this._oTokenizer.focus();this._oTokenizer.selectAllTokens(true);t.preventDefault()}if(this.isPickerDialog()){this._sOldValue=this.getPickerTextField().getValue();this._iOldCursorPos=e(this.getFocusDomRef()).cursorPos()}};v.prototype.oninput=function(e){s.prototype.oninput.apply(this,arguments);var t=e.srcControl;if(!this.getEnabled()||!this.getEditable()){return}if(this._bIsPasteEvent){t.updateDomValue(this._sOldValue||"");return}if(!this._bCompositionStart&&!this._bCompositionEnd){this._handleInputValidation(e,false)}};v.prototype.filterItems=function(t,i){t.forEach(function(t){var s=e.sap.startsWithIgnoreCase(t.getText(),i);if(i===""){s=true;if(!this.bOpenedByKeyboardOrButton){return}}var n=this.getListItem(t);if(n){n.setVisible(s)}},this)};v.prototype.onkeyup=function(t){if(!this.getEnabled()||!this.getEditable()){return}this._sOldValue=this.getValue();this._iOldCursorPos=e(this.getFocusDomRef()).cursorPos()};v.prototype._showWrongValueVisualEffect=function(){var t=this.getValueState();if(t===I.Error){return}if(this.isPickerDialog()){this.getPickerTextField().setValueState(I.Error);e.sap.delayedCall(1e3,this.getPickerTextField(),"setValueState",[t])}else{this.setValueState(I.Error);e.sap.delayedCall(1e3,this,"setValueState",[t])}};v.prototype.createPicker=function(e){var t=this.getAggregation("picker");if(t){return t}t=this["create"+e]();this.setAggregation("picker",t,true);var i=this.getRenderer(),s=i.CSS_CLASS_MULTICOMBOBOX;t.setHorizontalScrolling(false).addStyleClass(i.CSS_CLASS_COMBOBOXBASE+"Picker").addStyleClass(s+"Picker").addStyleClass(s+"Picker-CTX").attachBeforeOpen(this.onBeforeOpen,this).attachAfterOpen(this.onAfterOpen,this).attachBeforeClose(this.onBeforeClose,this).attachAfterClose(this.onAfterClose,this).addEventDelegate({onBeforeRendering:this.onBeforeRenderingPicker,onAfterRendering:this.onAfterRenderingPicker},this).addContent(this.getList());return t};v.prototype.createPickerTextField=function(){return new n};v.prototype.onBeforeRendering=function(){s.prototype.onBeforeRendering.apply(this,arguments);var e=this.getItems();var t=this.getList();if(t){this._synchronizeSelectedItemAndKey(e);t.destroyItems();this._clearTokenizer();this._fillList(e);if(t.getItemNavigation()){this._iFocusedIndex=t.getItemNavigation().getFocusedIndex()}this.setEditable(this.getEditable())}};v.prototype.onBeforeRenderingPicker=function(){var e=this["_onBeforeRendering"+this.getPickerType()];if(e){e.call(this)}};v.prototype.onAfterRenderingPicker=function(){var e=this["_onAfterRendering"+this.getPickerType()];if(e){e.call(this)}};v.prototype.onBeforeOpen=function(){var e=this["_onBeforeOpen"+this.getPickerType()];this.addStyleClass(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Pressed");this._resetCurrentItem();this.addContent();this._aInitiallySelectedItems=this.getSelectedItems();if(e){e.call(this)}};v.prototype.onAfterOpen=function(){if(!this.isPlatformTablet()){this.getPicker().setInitialFocus(this)}this.closeValueStateMessage()};v.prototype.onBeforeClose=function(){s.prototype.onBeforeClose.apply(this,arguments)};v.prototype.onAfterClose=function(){this.removeStyleClass(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Pressed");this.clearFilter();!this._bPreventValueRemove&&this.setValue("");this._sOldValue="";if(this.isPickerDialog()){this.getPickerTextField().setValue("");this._getFilterSelectedButton().setPressed(false)}this.fireSelectionFinish({selectedItems:this.getSelectedItems()})};v.prototype._onBeforeOpenDialog=function(){};v.prototype._onBeforeOpenDropdown=function(){var e=this.getPicker(),t=this.getDomRef(),i;if(t&&e){i=t.offsetWidth/parseFloat(l.BaseFontSize)+"rem";e.setContentMinWidth(i)}};v.prototype._decoratePopover=function(e){var t=this;e.open=function(){return this.openBy(t)}};v.prototype.createDropdown=function(){var e=new a(this.getDropdownSettings());e.setInitialFocus(this);this._decoratePopover(e);return e};v.prototype.createDialog=function(){var e=s.prototype.createDialog.apply(this,arguments),t=this._createFilterSelectedButton();e.getSubHeader().addContent(t);return e};v.prototype._createFilterSelectedButton=function(){var e=u.getIconURI("multiselect-all"),t=this.getRenderer(),i=this;return new o({icon:e,press:i._filterSelectedItems.bind(this)}).addStyleClass(t.CSS_CLASS_MULTICOMBOBOX+"ToggleButton")};v.prototype._getFilterSelectedButton=function(){return this.getPicker().getSubHeader().getContent()[1]};v.prototype._filterSelectedItems=function(e){var t=e.oSource,i,s,n=this.getPickerTextField().getValue(),o=t.getPressed(),r=this.getVisibleItems(),a=this.getItems(),l=this.getSelectedItems();if(o){r.forEach(function(e){s=l.indexOf(e)>-1?true:false;i=this.getListItem(e);if(i){i.setVisible(s)}},this)}else{this.filterItems(a,n)}};v.prototype.revertSelection=function(){this.setSelectedItems(this._aInitiallySelectedItems)};v.prototype.createList=function(){var e=this.getRenderer();this._oList=new r({width:"100%",mode:m.MultiSelect,includeItemInSelection:true,rememberSelections:false}).addStyleClass(e.CSS_CLASS_COMBOBOXBASE+"List").addStyleClass(e.CSS_CLASS_MULTICOMBOBOX+"List").attachBrowserEvent("tap",this._handleItemTap,this).attachSelectionChange(this._handleSelectionLiveChange,this).attachItemPress(this._handleItemPress,this);this._oList.addEventDelegate({onAfterRendering:this.onAfterRenderingList,onfocusin:this.onFocusinList},this)};v.prototype.setSelection=function(e){if(e.item&&this.isItemSelected(e.item)){return}if(!e.item){return}if(!e.listItemUpdated&&this.getListItem(e.item)){this.getList().setSelectedItem(this.getListItem(e.item),true)}var t=new sap.m.Token({key:e.key});t.setText(e.item.getText());t.setTooltip(e.item.getText());e.item.data(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Token",t);this._oTokenizer.addToken(t);this.$().toggleClass("sapMMultiComboBoxHasToken",this._hasTokens());this.setValue("");this.addAssociation("selectedItems",e.item,e.suppressInvalidate);var i=this.getKeys(this.getSelectedItems());this.setProperty("selectedKeys",i,e.suppressInvalidate);if(e.fireChangeEvent){this.fireSelectionChange({changedItem:e.item,selected:true})}if(e.fireFinishEvent){if(!this.isOpen()){this.fireSelectionFinish({selectedItems:this.getSelectedItems()})}}};v.prototype.removeSelection=function(e){if(e.item&&!this.isItemSelected(e.item)){return}if(!e.item){return}this.removeAssociation("selectedItems",e.item,e.suppressInvalidate);var t=this.getKeys(this.getSelectedItems());this.setProperty("selectedKeys",t,e.suppressInvalidate);if(!e.listItemUpdated&&this.getListItem(e.item)){this.getList().setSelectedItem(this.getListItem(e.item),false)}if(!e.tokenUpdated){var i=this._getTokenByItem(e.item);e.item.data(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Token",null);this._oTokenizer.removeToken(i)}this.$().toggleClass("sapMMultiComboBoxHasToken",this._hasTokens());if(e.fireChangeEvent){this.fireSelectionChange({changedItem:e.item,selected:false})}if(e.fireFinishEvent){if(!this.isOpen()){this.fireSelectionFinish({selectedItems:this.getSelectedItems()})}}};v.prototype._synchronizeSelectedItemAndKey=function(t){if(!t.length){e.sap.log.info("Info: _synchronizeSelectedItemAndKey() the MultiComboBox control does not contain any item on ",this);return}var i=this.getSelectedKeys()||this._aCustomerKeys;var s=this.getKeys(this.getSelectedItems());if(i.length){for(var n=0,o=null,r=null,a=null,l=i.length;n<l;n++){o=i[n];if(s.indexOf(o)>-1){if(this._aCustomerKeys.length&&(a=this._aCustomerKeys.indexOf(o))>-1){this._aCustomerKeys.splice(a,1)}continue}r=this.getItemByKey(""+o);if(r){if(this._aCustomerKeys.length&&(a=this._aCustomerKeys.indexOf(o))>-1){this._aCustomerKeys.splice(a,1)}this.setSelection({item:r,id:r.getId(),key:r.getKey(),fireChangeEvent:false,suppressInvalidate:true,listItemUpdated:false})}}return}};v.prototype._getTokenByItem=function(e){return e?e.data(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Token"):null};v.prototype.updateItems=function(e){var t,i,n=this.getSelectedKeys();var o=s.prototype.updateItems.apply(this,arguments);i=this.getSelectedItems();t=i.length===n.length&&i.every(function(e){return e&&e.getKey&&n.indexOf(e.getKey())>-1});if(!t){i=n.map(this.getItemByKey,this);this.setSelectedItems(i)}return o};v.prototype._getSelectedItemsOf=function(e){for(var t=0,i=e.length,s=[];t<i;t++){if(this.getListItem(e[t]).isSelected()){s.push(e[t])}}return s};v.prototype._getLastSelectedItem=function(){var e=this._oTokenizer.getTokens();var t=e.length?e[e.length-1]:null;if(!t){return null}return this._getItemByToken(t)};v.prototype._getOrderedSelectedItems=function(){var e=[];for(var t=0,i=this._oTokenizer.getTokens(),s=i.length;t<s;t++){e[t]=this._getItemByToken(i[t])}return e};v.prototype._getFocusedListItem=function(){if(!document.activeElement){return null}var t=sap.ui.getCore().byId(document.activeElement.id);if(this.getList()&&e.sap.containsOrEquals(this.getList().getFocusDomRef(),t.getFocusDomRef())){return t}return null};v.prototype._getFocusedItem=function(){var e=this._getFocusedListItem();return this._getItemByListItem(e)};v.prototype._isRangeSelectionSet=function(e){var t=e.getDomRef();return t.indexOf(this.getRenderer().CSS_CLASS_MULTICOMBOBOX+"ItemRangeSelection")>-1?true:false};v.prototype._hasTokens=function(){return this._oTokenizer.getTokens().length>0};v.prototype._getCurrentItem=function(){if(!this._oCurrentItem){return this._getFocusedItem()}return this._oCurrentItem};v.prototype._setCurrentItem=function(e){this._oCurrentItem=e};v.prototype._resetCurrentItem=function(){this._oCurrentItem=null};v.prototype._decorateListItem=function(t){t.addDelegate({onkeyup:function(t){var i=null;if(t.which==e.sap.KeyCodes.SPACE&&this.isOpen()&&this._isListInSuggestMode()){this.open();i=this._getLastSelectedItem();if(i){this.getListItem(i).focus()}return}},onkeydown:function(t){var i=null,s=null;if(t.shiftKey&&t.which==e.sap.KeyCodes.ARROW_DOWN){s=this._getCurrentItem();i=this._getNextVisibleItemOf(s)}if(t.shiftKey&&t.which==e.sap.KeyCodes.ARROW_UP){s=this._getCurrentItem();i=this._getPreviousVisibleItemOf(s)}if(t.shiftKey&&t.which===e.sap.KeyCodes.SPACE){s=this._getCurrentItem();this._selectPreviousItemsOf(s)}if(i&&i!==s){if(this.getListItem(s).isSelected()){this.setSelection({item:i,id:i.getId(),key:i.getKey(),fireChangeEvent:true,suppressInvalidate:true});this._setCurrentItem(i)}else{this.removeSelection({item:i,id:i.getId(),key:i.getKey(),fireChangeEvent:true,suppressInvalidate:true});this._setCurrentItem(i)}return}this._resetCurrentItem();if((t.ctrlKey||t.metaKey)&&t.which==e.sap.KeyCodes.A){t.setMarked();t.preventDefault();var n=this.getSelectableItems();var o=this._getSelectedItemsOf(n);if(o.length!==n.length){n.forEach(function(e){this.setSelection({item:e,id:e.getId(),key:e.getKey(),fireChangeEvent:true,suppressInvalidate:true,listItemUpdated:false})},this)}else{n.forEach(function(e){this.removeSelection({item:e,id:e.getId(),key:e.getKey(),fireChangeEvent:true,suppressInvalidate:true,listItemUpdated:false})},this)}}}},true,this);t.addEventDelegate({onsapbackspace:function(e){e.preventDefault()},onsapshow:function(t){t.setMarked();if(t.keyCode===e.sap.KeyCodes.F4){t.preventDefault()}if(this.isOpen()){this.close();return}if(this.hasContent()){this.open()}},onsaphide:function(e){this.onsapshow(e)},onsapenter:function(e){e.setMarked();this.close()},onsaphome:function(e){e.setMarked();e.preventDefault();var t=this.getSelectableItems();var i=t[0];this.getListItem(i).focus()},onsapend:function(e){e.setMarked();e.preventDefault();var t=this.getSelectableItems();var i=t[t.length-1];this.getListItem(i).focus()},onsapup:function(t){t.setMarked();t.preventDefault();var i=this.getSelectableItems();var s=i[0];var n=e(document.activeElement).control()[0];if(n===this.getListItem(s)){this.focus();t.stopPropagation(true)}},onfocusin:function(e){this.addStyleClass(this.getRenderer().CSS_CLASS_MULTICOMBOBOX+"Focused")},onfocusout:function(e){this.removeStyleClass(this.getRenderer().CSS_CLASS_MULTICOMBOBOX+"Focused")},onsapfocusleave:function(t){var i=this.getAggregation("picker");var s=sap.ui.getCore().byId(t.relatedControlId);if(i&&s&&e.sap.equal(i.getFocusDomRef(),s.getFocusDomRef())){if(t.srcControl){t.srcControl.focus()}}}},this);if(g.support.touch){t.addEventDelegate({ontouchstart:function(e){e.setMark("cancelAutoClose")}})}};v.prototype._createTokenizer=function(){var e=new sap.m.Tokenizer({tokens:[]}).attachTokenChange(this._handleTokenChange,this);e.setParent(this);e.addEventDelegate({onAfterRendering:this._onAfterRenderingTokenizer},this);return e};v.prototype._onAfterRenderingTokenizer=function(){this._oTokenizer.scrollToEnd()};v.prototype._handleTokenChange=function(e){var t=e.getParameter("type");var i=e.getParameter("token");var s=null;if(t!==sap.m.Tokenizer.TokenChangeType.Removed&&t!==sap.m.Tokenizer.TokenChangeType.Added){return}if(t===sap.m.Tokenizer.TokenChangeType.Removed){s=i&&this._getItemByToken(i);if(s&&this.isItemSelected(s)){this.removeSelection({item:s,id:s.getId(),key:s.getKey(),tokenUpdated:true,fireChangeEvent:true,fireFinishEvent:true,suppressInvalidate:true});!this.isPickerDialog()&&this.focus();this.fireChangeEvent("")}}};v.prototype.onAfterRenderingList=function(){var e=this.getList();if(this._iFocusedIndex!=null&&e.getItems().length>this._iFocusedIndex){e.getItems()[this._iFocusedIndex].focus();this._iFocusedIndex=null}};v.prototype.onFocusinList=function(){if(this._bListItemNavigationInvalidated){this.getList().getItemNavigation().setSelectedIndex(this._iInitialItemFocus);this._bListItemNavigationInvalidated=false}};v.prototype.onAfterRendering=function(){s.prototype.onAfterRendering.apply(this,arguments);var t=this.getPicker();var i=e(this.getDomRef());var n=i.find(this.getRenderer().DOT_CSS_CLASS_MULTICOMBOBOX+"Border");t._oOpenBy=n[0]};v.prototype.onfocusout=function(e){this.removeStyleClass("sapMMultiComboBoxFocus");s.prototype.onfocusout.apply(this,arguments)};v.prototype.onpaste=function(t){var i;if(window.clipboardData){i=window.clipboardData.getData("Text")}else{i=t.originalEvent.clipboardData.getData("text/plain")}var s=this._oTokenizer._parseString(i);if(s&&s.length>0){this.getSelectableItems().forEach(function(t){if(e.inArray(t.getText(),s)>-1){this.setSelection({item:t,id:t.getId(),key:t.getKey(),fireChangeEvent:true,fireFinishEvent:true,suppressInvalidate:true,listItemUpdated:false})}},this)}};v.prototype.onsapbackspace=function(e){if(!this.getEnabled()||!this.getEditable()){e.preventDefault();return}if(this.getCursorPosition()>0||this.getValue().length>0){return}sap.m.Tokenizer.prototype.onsapbackspace.apply(this._oTokenizer,arguments);e.preventDefault()};v.prototype.onsapdelete=function(e){if(!this.getEnabled()||!this.getEditable()){return}if(this.getValue()&&!this._isCompleteTextSelected()){return}sap.m.Tokenizer.prototype.onsapdelete.apply(this._oTokenizer,arguments)};v.prototype.onsapnext=function(t){if(t.isMarked()){return}var i=e(document.activeElement).control()[0];if(!i){return}if(i===this._oTokenizer||this._oTokenizer.$().find(i.$()).length>0&&this.getEditable()){this.focus()}};v.prototype.onsapprevious=function(e){if(this.getCursorPosition()===0&&!this._isCompleteTextSelected()){if(e.srcControl===this){sap.m.Tokenizer.prototype.onsapprevious.apply(this._oTokenizer,arguments)}}};v.prototype.getOpenArea=function(){if(this.isPickerDialog()){return this.getDomRef()}else{return s.prototype.getOpenArea.apply(this,arguments)}};v.prototype._getItemsStartingText=function(t,i){var s=[],n=i?this.getEnabledItems():this.getSelectableItems();n.forEach(function(i){if(e.sap.startsWithIgnoreCase(i.getText(),t)){s.push(i)}},this);return s};v.prototype._getUnselectedItemsStartingText=function(t){var i=[];this._getUnselectedItems().forEach(function(s){if(e.sap.startsWithIgnoreCase(s.getText(),t)){i.push(s)}},this);return i};v.prototype.getCursorPosition=function(){return this._$input.cursorPos()};v.prototype._isCompleteTextSelected=function(){if(!this.getValue().length){return false}var e=this._$input[0];if(e.selectionStart!==0||e.selectionEnd!==this.getValue().length){return false}return true};v.prototype._selectPreviousItemsOf=function(e){var t;do{t=true;var i=this._getPreviousVisibleItemOf(e);if(i){var s=this.getListItem(i);if(s){t=this.getListItem(i).getSelected()}}this.setSelection({item:e,id:e.getId(),key:e.getKey(),fireChangeEvent:true,suppressInvalidate:true});e=i}while(!t)};v.prototype._getNextVisibleItemOf=function(e){var t=this.getSelectableItems();var i=t.indexOf(e)+1;if(i<=0||i>t.length-1){return null}return t[i]};v.prototype._getPreviousVisibleItemOf=function(e){var t=this.getSelectableItems();var i=t.indexOf(e)-1;if(i<0){return null}return t[i]};v.prototype._getNextUnselectedItemOf=function(e){var t=this._getUnselectedItems();var i=t.indexOf(e)+1;if(i<=0||i>t.length-1){return null}return t[i]};v.prototype._getPreviousUnselectedItemOf=function(e){var t=this._getUnselectedItems();var i=t.indexOf(e)-1;if(i<0){return null}return t[i]};v.prototype._getNextTraversalItem=function(){var e=this._getItemsStartingText(this.getValue());var t=this._getUnselectedItems();if(e.indexOf(this._oTraversalItem)>-1&&this._oTraversalItem.getText()===this.getValue()){return this._getNextUnselectedItemOf(this._oTraversalItem)}if(e.length&&e[0].getText()===this.getValue()){return this._getNextUnselectedItemOf(e[0])}return e.length?e[0]:t[0]};v.prototype._getPreviousTraversalItem=function(){var e=this._getItemsStartingText(this.getValue());if(e.indexOf(this._oTraversalItem)>-1&&this._oTraversalItem.getText()===this.getValue()){return this._getPreviousUnselectedItemOf(this._oTraversalItem)}if(e.length&&e[e.length-1].getText()===this.getValue()){return this._getPreviousUnselectedItemOf(e[e.length-1])}if(e.length){return e[e.length-1]}else{var t=this._getUnselectedItems();if(t.length>0){return t[t.length-1]}else{return null}}};v.prototype.findFirstEnabledItem=function(e){e=e||this.getItems();for(var t=0;t<e.length;t++){if(e[t].getEnabled()){return e[t]}}return null};v.prototype.getVisibleItems=function(){for(var e=0,t,i=this.getItems(),s=[];e<i.length;e++){t=this.getListItem(i[e]);if(t&&t.getVisible()){s.push(i[e])}}return s};v.prototype.findLastEnabledItem=function(e){e=e||this.getItems();return this.findFirstEnabledItem(e.reverse())};v.prototype.setSelectedItems=function(t){this.removeAllSelectedItems();if(!t||!t.length){return this}if(!e.isArray(t)){e.sap.log.warning("Warning: setSelectedItems() has to be an array of sap.ui.core.Item instances or of valid sap.ui.core.Item IDs",this);return this}t.forEach(function(t){if(!(t instanceof c)&&typeof t!=="string"){e.sap.log.warning("Warning: setSelectedItems() has to be an array of sap.ui.core.Item instances or of valid sap.ui.core.Item IDs",this);return}if(typeof t==="string"){t=sap.ui.getCore().byId(t)}this.setSelection({item:t?t:null,id:t?t.getId():"",key:t?t.getKey():"",suppressInvalidate:true})},this);return this};v.prototype.addSelectedItem=function(e){if(!e){return this}if(typeof e==="string"){e=sap.ui.getCore().byId(e)}this.setSelection({item:e?e:null,id:e?e.getId():"",key:e?e.getKey():"",fireChangeEvent:false,suppressInvalidate:true});return this};v.prototype.removeSelectedItem=function(e){if(!e){return null}if(typeof e==="string"){e=sap.ui.getCore().byId(e)}if(!this.isItemSelected(e)){return null}this.removeSelection({item:e,id:e.getId(),key:e.getKey(),fireChangeEvent:false,suppressInvalidate:true});return e};v.prototype.removeAllSelectedItems=function(){var e=[];var t=this.getAssociation("selectedItems",[]);t.forEach(function(t){var i=this.removeSelectedItem(t);if(i){e.push(i.getId())}},this);return e};v.prototype.removeSelectedKeys=function(t){var i=[],s;if(!t||!t.length||!e.isArray(t)){return i}var n;t.forEach(function(e){n=this.getItemByKey(e);if(n){this.removeSelection({item:n?n:null,id:n?n.getId():"",key:n?n.getKey():"",fireChangeEvent:false,suppressInvalidate:true});i.push(n)}if(this._aCustomerKeys.length&&(s=this._aCustomerKeys.indexOf(e))>-1){this._aCustomerKeys.splice(s,1)}},this);return i};v.prototype.setSelectedKeys=function(e){this.removeAllSelectedItems();this._aCustomerKeys=[];this.addSelectedKeys(e);return this};v.prototype.addSelectedKeys=function(e){e=this.validateProperty("selectedKeys",e);e.forEach(function(e){var t=this.getItemByKey(e);if(t){this.addSelectedItem(t)}else if(e!=null){this._aCustomerKeys.push(e)}},this);return this};v.prototype.getSelectedKeys=function(){var e=this.getSelectedItems()||[],t=[];e.forEach(function(e){t.push(e.getKey())},this);if(this._aCustomerKeys.length){t=t.concat(this._aCustomerKeys)}return t};v.prototype._getUnselectedItems=function(){return e(this.getSelectableItems()).not(this.getSelectedItems()).get()};v.prototype.getSelectedItems=function(){var e=[],t=this.getAssociation("selectedItems")||[];t.forEach(function(t){var i=sap.ui.getCore().byId(t);if(i){e.push(i)}},this);return e};v.prototype.getSelectableItems=function(){return this.getEnabledItems(this.getVisibleItems())};v.prototype.getWidth=function(){return this.getProperty("width")||"100%"};v.prototype.setEditable=function(e){s.prototype.setEditable.apply(this,arguments);this._oTokenizer.setEditable(e);return this};v.prototype.clearFilter=function(){this.getItems().forEach(function(e){this.getListItem(e).setVisible(e.getEnabled()&&this.getSelectable(e))},this)};v.prototype._isListInSuggestMode=function(){return this.getList().getItems().some(function(e){return!e.getVisible()&&this._getItemByListItem(e).getEnabled()},this)};v.prototype._mapItemToListItem=function(e){if(!e){return null}var t=this.getRenderer().CSS_CLASS_MULTICOMBOBOX+"Item";var i=this.isItemSelected(e)?t+"Selected":"";var s=new sap.m.StandardListItem({type:d.Active,visible:e.getEnabled()}).addStyleClass(t+" "+i);s.setTooltip(e.getTooltip());e.data(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"ListItem",s);s.setTitle(e.getText());if(i){var n=new sap.m.Token({key:e.getKey()});n.setText(e.getText());n.setTooltip(e.getText());e.data(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Token",n);this._oTokenizer.addToken(n)}this.setSelectable(e,e.getEnabled());this._decorateListItem(s);return s};v.prototype._findMappedItem=function(e,t){for(var i=0,t=t||this.getItems(),s=t.length;i<s;i++){if(this.getListItem(t[i])===e){return t[i]}}return null};v.prototype.setSelectable=function(e,t){if(this.indexOfItem(e)<0){return}e._bSelectable=t;var i=this.getListItem(e);if(i){i.setVisible(t)}var s=this._getTokenByItem(e);if(s){s.setVisible(t)}};v.prototype.getSelectable=function(e){return e._bSelectable};v.prototype._fillList=function(e){if(!e){return null}if(!this._oListItemEnterEventDelegate){this._oListItemEnterEventDelegate={onsapenter:function(e){if(e.srcControl.isSelected()){e.setMarked()}}}}for(var t=0,i,s=e.length;t<s;t++){i=this._mapItemToListItem(e[t]);i.removeEventDelegate(this._oListItemEnterEventDelegate);i.addDelegate(this._oListItemEnterEventDelegate,true,this,true);this.getList().addAggregation("items",i,true);if(this.isItemSelected(e[t])){this.getList().setSelectedItem(i,true)}}};v.prototype._handleInputValidation=function(t,i){var s=t.target.value,n,o,r,a,l,h;var u=i?e(t.target).control(0):t.srcControl;n=this._getItemsStartingText(s,true);o=!!n.length;if(!o&&s!==""){l=i?this._sComposition:this._sOldValue||"";u.updateDomValue(l);if(this._iOldCursorPos){e(u.getFocusDomRef()).cursorPos(this._iOldCursorPos)}this._showWrongValueVisualEffect();return}r=this.getEnabledItems();a=this._sOldInput&&this._sOldInput.length>s.length;if(this.isPickerDialog()){h=this._getFilterSelectedButton();if(h!=null&&h.getPressed()){h.setPressed(false)}}if(a){r=this.getItems()}this.filterItems(r,s);if((!this.getValue()||!o)&&!this.bOpenedByKeyboardOrButton&&!this.isPickerDialog()){this.close()}else{this.open()}this._sOldInput=s};v.prototype.init=function(){i.prototype.init.apply(this,arguments);this.createList();this.bItemsUpdated=false;this._bListItemNavigationInvalidated=false;this._iInitialItemFocus=-1;this._bCheckBoxClicked=true;this._bPreventValueRemove=false;this.setPickerType(g.system.phone?"Dialog":"Dropdown");this._oTokenizer=this._createTokenizer();this._aCustomerKeys=[];this._aInitiallySelectedItems=[];this._bCompositionStart=false;this._bCompositionEnd=false;this._sComposition="";this.attachBrowserEvent("compositionstart",function(){this._bCompositionStart=true;this._bCompositionEnd=false},this);this.attachBrowserEvent("compositionend",function(e){this._bCompositionStart=false;this._bCompositionEnd=true;this._handleInputValidation(e,true);this._bCompositionEnd=false;this._sComposition=e.target.value},this)};v.prototype.clearSelection=function(){this.removeAllSelectedItems()};v.prototype.addItem=function(e){this.addAggregation("items",e);if(e){e.attachEvent("_change",this.onItemChange,this)}if(this.getList()){this.getList().addItem(this._mapItemToListItem(e))}return this};v.prototype.insertItem=function(e,t){this.insertAggregation("items",e,t,true);if(e){e.attachEvent("_change",this.onItemChange,this)}if(this.getList()){this.getList().insertItem(this._mapItemToListItem(e),t)}return this};v.prototype.getEnabledItems=function(e){e=e||this.getItems();return e.filter(function(e){return e.getEnabled()})};v.prototype.getItemByKey=function(e){return this.findItem("key",e)};v.prototype.removeItem=function(e){e=this.removeAggregation("items",e);if(this.getList()){this.getList().removeItem(e&&this.getListItem(e))}this.removeSelection({item:e,id:e?e.getId():"",key:e?e.getKey():"",fireChangeEvent:false,suppressInvalidate:true,listItemUpdated:true});return e};v.prototype.isItemSelected=function(e){return this.getSelectedItems().indexOf(e)>-1};v.prototype.findItem=function(e,t){var i="get"+e.charAt(0).toUpperCase()+e.slice(1);for(var s=0,n=this.getItems();s<n.length;s++){if(n[s][i]()===t){return n[s]}}return null};v.prototype._clearTokenizer=function(){this._oTokenizer.destroyAggregation("tokens",true)};v.prototype.getList=function(){return this._oList};v.prototype.exit=function(){s.prototype.exit.apply(this,arguments);if(this.getList()){this.getList().destroy();this._oList=null}if(this._oTokenizer){this._oTokenizer.destroy();this._oTokenizer=null}};v.prototype.destroyItems=function(){this.destroyAggregation("items");if(this.getList()){this.getList().destroyItems()}this._oTokenizer.destroyTokens();return this};v.prototype.removeAllItems=function(){var e=this.removeAllAggregation("items");this.removeAllSelectedItems();if(this.getList()){this.getList().removeAllItems()}return e};v.prototype._getItemByListItem=function(e){return this._getItemBy(e,"ListItem")};v.prototype._getItemByToken=function(e){return this._getItemBy(e,"Token")};v.prototype._getItemBy=function(e,t){t=this.getRenderer().CSS_CLASS_COMBOBOXBASE+t;for(var i=0,s=this.getItems(),n=s.length;i<n;i++){if(s[i].data(t)===e){return s[i]}}return null};v.prototype.getListItem=function(e){return e?e.data(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"ListItem"):null};v.prototype.getAccessibilityInfo=function(){var e=this.getSelectedItems().map(function(e){return e.getText()}).join(" ");var t=s.prototype.getAccessibilityInfo.apply(this,arguments);t.type=sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_MULTICOMBO");t.description=((t.description||"")+" "+e).trim();return t};return v});