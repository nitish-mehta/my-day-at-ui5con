/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/Device","./DatePicker","./library","sap/ui/core/LocaleData","sap/ui/core/format/DateFormat","./DateRangeSelectionRenderer"],function(t,e,i,a,s,n,r){"use strict";var o=i.extend("sap.m.DateRangeSelection",{metadata:{library:"sap.m",properties:{delimiter:{type:"string",group:"Misc",defaultValue:"-"},secondDateValue:{type:"object",group:"Data",defaultValue:null},from:{type:"object",group:"Misc",defaultValue:null,deprecated:true},to:{type:"object",group:"Misc",defaultValue:null,deprecated:true}},designtime:"sap/m/designtime/DateRangeSelection.designtime"}});o.prototype.init=function(){i.prototype.init.apply(this,arguments);this._bIntervalSelection=true};o.prototype.onkeypress=function(t){if(!t.charCode||t.metaKey||t.ctrlKey){return}var e=f.call(this);var i=g.call(this);var a=e.sAllowedCharacters+i+" ";var s=String.fromCharCode(t.charCode);if(s&&e.sAllowedCharacters&&a.indexOf(s)<0){t.preventDefault()}};o.prototype._getPlaceholder=function(){var t=this.getPlaceholder(),e,i,a,n;if(!t){e=this.getBinding("value");a=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();n=s.getInstance(a);if(e&&e.getType()instanceof sap.ui.model.type.DateInterval){i=e.getType();if(i.oFormatOptions&&i.oFormatOptions.format){t=n.getCustomDateTimePattern(i.oFormatOptions.format)}else{t=n.getDatePattern("medium")}}else{t=this.getDisplayFormat();if(!t){t="medium"}if(this._checkStyle(t)){t=n.getDatePattern(t)}}var r=g.call(this);if(r&&r!==""){t=t+" "+r+" "+t}}return t};o.prototype.setValue=function(e){if(e!==this.getValue()){this._lastValue=e}else{return this}this.setProperty("value",e);this._bValid=true;var i=[undefined,undefined];if(e){i=this._parseValue(e);if(!p.call(this,i[0],i[1])[0]){this._bValid=false;t.sap.log.warning("Value can not be converted to a valid dates",this)}}this.setProperty("dateValue",l(i[0]));this.setProperty("secondDateValue",l(i[1]));if(this.getDomRef()){var a=this._formatValue(i[0],i[1]);if(this._$input.val()!==a){this._$input.val(a);this._setLabelVisibility();this._curpos=this._$input.cursorPos()}}return this};function l(t){return typeof t==="number"?new Date(t):t}function u(t){return t&&t.getTime?t.getTime():t}o.prototype.setValueFormat=function(e){this.setProperty("valueFormat",e,true);t.sap.log.warning("Property valueFormat is not supported in sap.m.DateRangeSelection control.",this);return this};o.prototype.setDisplayFormat=function(t){this.setProperty("displayFormat",t,true);var e=this._formatValue(this.getDateValue(),this.getSecondDateValue());this.setProperty("value",e,true);if(this.getDomRef()&&this._$input.val()!==e){this._$input.val(e);this._curpos=this._$input.cursorPos()}return this};o.prototype.setFrom=function(t){this.setDateValue(t);return this};o.prototype.getFrom=function(){return this.getDateValue()};o.prototype.setTo=function(t){this.setSecondDateValue(t);return this};o.prototype.getTo=function(){return this.getSecondDateValue()};o.prototype.setDateValue=function(e){if(this._isValidDate(e)){throw new Error("Date must be a JavaScript date object; "+this)}if(t.sap.equal(this.getDateValue(),e)){return this}i.prototype._dateValidation.call(this,e);this._syncDateObjectsToValue(e,this.getSecondDateValue());return this};o.prototype.setSecondDateValue=function(e){if(this._isValidDate(e)){throw new Error("Date must be a JavaScript date object; "+this)}if(t.sap.equal(this.getSecondDateValue(),e)){return this}this._bValid=true;if(e&&(e.getTime()<this._oMinDate.getTime()||e.getTime()>this._oMaxDate.getTime())){this._bValid=false;t.sap.assert(this._bValid,"Date must be in valid range")}this.setProperty("secondDateValue",e);this._syncDateObjectsToValue(this.getDateValue(),e);return this};o.prototype.setMinDate=function(e){i.prototype.setMinDate.apply(this,arguments);if(e){var a=this.getSecondDateValue();if(a&&a.getTime()<this._oMinDate.getTime()){t.sap.log.warning("SecondDateValue not in valid date range",this)}}return this};o.prototype.setMaxDate=function(e){i.prototype.setMaxDate.apply(this,arguments);if(e){var a=this.getSecondDateValue();if(a&&a.getTime()>this._oMaxDate.getTime()){t.sap.log.warning("SecondDateValue not in valid date range",this)}}return this};o.prototype._checkMinMaxDate=function(){i.prototype._checkMinMaxDate.apply(this,arguments);var e=this.getSecondDateValue();if(e&&(e.getTime()<this._oMinDate.getTime()||e.getTime()>this._oMaxDate.getTime())){t.sap.log.error("secondDateValue "+e.toString()+"(value="+this.getValue()+") does not match "+"min/max date range("+this._oMinDate.toString()+" - "+this._oMaxDate.toString()+"). App. "+"developers should take care to maintain secondDateValue/value accordingly.",this)}};o.prototype._parseValue=function(t){var e;var i=[];var a,s;var n=this.getBinding("value");if(n&&n.getType()instanceof sap.ui.model.type.DateInterval){i=n.getType().parseValue(t,"string");if(n.getType().oFormatOptions&&n.getType().oFormatOptions.UTC){i=i.map(function(t){return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds())})}return i}var r=g.call(this);t=t.trim();if(r&&t){t=D(t,[r," "]);i=t.split(r);if(i.length===2){if(i[0].slice(i[0].length-1,i[0].length)==" "){i[0]=i[0].slice(0,i[0].length-1)}if(i[1].slice(0,1)==" "){i[1]=i[1].slice(1)}}else{i=t.split(" "+r+" ")}if(t.indexOf(r)===-1){var o=t.split(" ");if(o.length===2){i=o}}}if(t&&i.length<=2){e=f.call(this);if(!r||r===""||i.length===1){a=e.parse(t)}else if(i.length===2){a=e.parse(i[0]);s=e.parse(i[1]);if(!a||!s){a=undefined;s=undefined}}}return[a,s]};o.prototype._formatValue=function(t,e){var i="",a=g.call(this),s,n,r,o;r=t;o=e;if(r){n=this.getBinding("value");if(n&&n.getType()instanceof sap.ui.model.type.DateInterval){if(n.getType().oFormatOptions&&n.getType().oFormatOptions.source&&n.getType().oFormatOptions.source.pattern==="timestamp"){i=n.getType().formatValue([u(t),u(e)],"string")}else{if(n.getType().oFormatOptions&&n.getType().oFormatOptions.UTC){r=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()));if(e){o=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds()))}}i=n.getType().formatValue([r,o],"string")}}else{s=f.call(this);if(a&&a!==""&&o){i=s.format(r)+" "+a+" "+s.format(o)}else{i=s.format(r)}}}return i};o.prototype.onChange=function(){if(!this.getEditable()||!this.getEnabled()){return}var t=this._$input.val();var e=[undefined,undefined];this._bValid=true;if(t!=""){e=this._parseValue(t);e=p.call(this,e[0],e[1]);if(e[0]){t=this._formatValue(e[0],e[1])}else{this._bValid=false}}if(t!==this._lastValue){if(this.getDomRef()&&this._$input.val()!==t){this._$input.val(t);this._curpos=this._$input.cursorPos()}this._lastValue=t;this.setProperty("value",t,true);if(this._bValid){this.setProperty("dateValue",l(e[0]),true);this.setProperty("secondDateValue",l(e[1]),true)}this._setLabelVisibility();if(this._oPopup&&this._oPopup.isOpen()){var i=this.getDateValue();if(i){if(!this._oDateRange.getStartDate()||this._oDateRange.getStartDate().getTime()!==i.getTime()){this._oDateRange.setStartDate(new Date(i.getTime()));this._oCalendar.focusDate(i)}}else{if(this._oDateRange.getStartDate()){this._oDateRange.setStartDate(undefined)}}var a=this.getSecondDateValue();if(a){if(!this._oDateRange.getEndDate()||this._oDateRange.getEndDate().getTime()!==a.getTime()){this._oDateRange.setEndDate(new Date(a.getTime()));this._oCalendar.focusDate(a)}}else{if(this._oDateRange.getEndDate()){this._oDateRange.setEndDate(undefined)}}}h.call(this,this._bValid)}};o.prototype._getInputValue=function(t){t=typeof t=="undefined"?this._$input.val():t.toString();var e=this._parseValue(t);t=this._formatValue(e[0],e[1]);return t};o.prototype.updateDomValue=function(t){this._bCheckDomValue=true;t=typeof t=="undefined"?this._$input.val():t.toString();this._curpos=this._$input.cursorPos();var e=this._parseValue(t);t=this._formatValue(e[0],e[1]);if(this.isActive()&&this._$input.val()!==t){this._$input.val(t);this._$input.cursorPos(this._curpos)}this._setLabelVisibility();return this};o.prototype.onsappageup=function(){};o.prototype.onsappageupmodifiers=function(){};o.prototype.onsappagedown=function(){};o.prototype.onsappagedownmodifiers=function(){};o.prototype._fillDateRange=function(){i.prototype._fillDateRange.apply(this,arguments);var t=this.getSecondDateValue();if(t&&t.getTime()>=this._oMinDate.getTime()&&t.getTime()<=this._oMaxDate.getTime()){if(!this._oDateRange.getEndDate()||this._oDateRange.getEndDate().getTime()!==t.getTime()){this._oDateRange.setEndDate(new Date(t.getTime()))}}else{if(this._oDateRange.getEndDate()){this._oDateRange.setEndDate(undefined)}}};o.prototype._selectDate=function(i){var a=this._oCalendar.getSelectedDates();if(a.length>0){var s=a[0].getStartDate();var n=a[0].getEndDate();if(s&&n){var r=this.getDateValue();var o=this.getSecondDateValue();var l;if(!t.sap.equal(s,r)||!t.sap.equal(n,o)){if(t.sap.equal(n,o)){this.setDateValue(s)}else{this.setProperty("dateValue",s,true);this.setSecondDateValue(n)}l=this.getValue();h.call(this,true);if((e.system.desktop||!e.support.touch)&&!t.sap.simulateMobileOnDesktop){this._curpos=l.length;this._$input.cursorPos(this._curpos)}}else if(!this._bValid){l=this._formatValue(s,n);if(l!=this._$input.val()){this._bValid=true;if(this.getDomRef()){this._$input.val(l)}h.call(this,true)}}this._oPopup.close()}}};o.prototype.getAccessibilityInfo=function(){var t=this.getRenderer();var e=i.prototype.getAccessibilityInfo.apply(this,arguments);var a=this.getValue()||"";if(this._bValid){var s=this.getDateValue();if(s){a=this._formatValue(s,this.getSecondDateValue())}}e.description=[a,t.getLabelledByAnnouncement(this),t.getDescribedByAnnouncement(this)].join(" ").trim();return e};o.prototype._syncDateObjectsToValue=function(t,e){var i=this._formatValue(t,e);if(i!==this.getValue()){this._lastValue=i}this.setProperty("value",i);if(this.getDomRef()){var a=this._formatValue(t,e);if(this._$input.val()!==a){this._$input.val(a);this._setLabelVisibility();this._curpos=this._$input.cursorPos()}}};function h(t){this.fireChangeEvent(this.getValue(),{from:this.getDateValue(),to:this.getSecondDateValue(),valid:t})}function p(t,e){var i,a;if(t&&t.getTime){i=t.getTime()}else if(typeof t==="number"){i=t}if(e&&e.getTime){a=e.getTime()}else if(typeof e==="number"){a=e}if(t&&e&&i>a){var s=t;t=e;e=s}if(t&&(i<this._oMinDate.getTime()||i>this._oMaxDate.getTime())||e&&(a<this._oMinDate.getTime()||a>this._oMaxDate.getTime())){return[undefined,undefined]}else{return[t,e]}}function g(){var t=this.getDelimiter();if(!t){if(!this._sLocaleDelimiter){var e=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var i=s.getInstance(e);var a=i.getIntervalPattern();var n=a.indexOf("{0}")+3;var r=a.indexOf("{1}");t=a.slice(n,r);if(t.length>1){if(t.slice(0,1)==" "){t=t.slice(1)}if(t.slice(t.length-1,t.length)==" "){t=t.slice(0,t.length-1)}}this._sLocaleDelimiter=t}else{t=this._sLocaleDelimiter}}return t}function f(){var t=this.getDisplayFormat()||"medium";var e;var i=this.getDisplayFormatType();if(t==this._sUsedDisplayPattern&&i==this._sUsedDisplayCalendarType){e=this._oDisplayFormat}else{if(this._checkStyle(t)){e=n.getInstance({style:t,strictParsing:true,calendarType:i})}else{e=n.getInstance({pattern:t,strictParsing:true,calendarType:i})}this._sUsedDisplayPattern=t;this._sUsedDisplayCalendarType=i;this._oDisplayFormat=e}return e}function c(t,e){return t&&e&&t.lastIndexOf(e)===t.length-e.length}function d(t,e){return t&&e&&t.indexOf(e)===0}function D(t,e){var i=0,a=e;if(!a){a=[" "]}while(i<a.length){if(c(t,a[i])){t=t.substring(0,t.length-a[i].length);i=0;continue}i++}i=0;while(i<a.length){if(d(t,a[i])){t=t.substring(a[i].length);i=0;continue}i++}return t}return o});