/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/core/delegate/ScrollEnablement","./WizardProgressNavigator","sap/ui/Device","./WizardRenderer"],function(t,e,r,i,s,n,o){"use strict";var a=r.extend("sap.m.Wizard",{metadata:{library:"sap.m",designtime:"sap/m/designtime/Wizard.designtime",properties:{width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"auto"},height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"100%"},showNextButton:{type:"boolean",group:"Behavior",defaultValue:true},finishButtonText:{type:"string",group:"Appearance",defaultValue:"Review"},enableBranching:{type:"boolean",group:"Behavior",defaultValue:false}},defaultAggregation:"steps",aggregations:{steps:{type:"sap.m.WizardStep",multiple:true,singularName:"step"},_progressNavigator:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_nextButton:{type:"sap.m.Button",multiple:false,visibility:"hidden"}},associations:{
/**
					 * This association controls the current activated step of the wizard (meaning the last step)
					 * For example if we have A->B->C->D steps, we are on step A and we setCurrentStep(C) A,B and C are going to be activated. D will still remain unvisited.
					 * The parameter needs to be a Wizard step that is part of the current Wizard
					 * @since 1.50
					 */
currentStep:{type:"sap.m.WizardStep",multiple:false}},events:{stepActivate:{parameters:{index:{type:"int"}}},complete:{parameters:{}}}}});a.CONSTANTS={MINIMUM_STEPS:3,MAXIMUM_STEPS:8,ANIMATION_TIME:300,SCROLL_OFFSET:16};a.prototype.init=function(){this._stepCount=0;this._stepPath=[];this._scrollLocked=false;this._scroller=this._initScrollEnablement();this._resourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._initProgressNavigator()};a.prototype.onBeforeRendering=function(){if(!this._isMinStepCountReached()||this._isMaxStepCountExceeded()){t.sap.log.error("The Wizard is supposed to handle from 3 to 8 steps.")}this._saveInitialValidatedState();var e=this._getStartingStep();if(e&&this._stepPath.indexOf(e)<0){this._activateStep(e);this._updateProgressNavigator()}};a.prototype.onAfterRendering=function(){if(!this.getCurrentStep()){this.setAssociation("currentStep",this.getSteps()[0],true)}var t=sap.ui.getCore().byId(this.getCurrentStep());this._activateAllPreceedingSteps(t);this._attachScrollHandler()};a.prototype.exit=function(){var t=this.getDomRef("step-container");if(t){t.onscroll=null}this._scroller.destroy();this._scroller=null;this._stepPath=null;this._stepCount=null;this._scrollLocked=null;this._resourceBundle=null};a.prototype.validateStep=function(e){if(!this._containsStep(e)){t.sap.log.error("The wizard does not contain this step");return this}e.setProperty("validated",true,true);this._updateNextButtonState();return this};a.prototype.invalidateStep=function(e){if(!this._containsStep(e)){t.sap.log.error("The wizard does not contain this step");return this}e.setProperty("validated",false,true);this._updateNextButtonState();return this};a.prototype.nextStep=function(){var t=this._getProgressNavigator().getProgress()-1;var e=this._stepPath[t];this.validateStep(e);this._handleNextButtonPress();return this};a.prototype.previousStep=function(){var t=this._getProgressNavigator().getProgress()-2;if(t>=0){this.discardProgress(this._stepPath[t])}return this};a.prototype.getProgress=function(){return this._getProgressNavigator().getProgress()};a.prototype.getProgressStep=function(){return this._stepPath[this.getProgress()-1]};a.prototype.goToStep=function(e,r){if(!this.getVisible()||this._stepPath.indexOf(e)<0){return this}var i=this,s={scrollTop:this._getStepScrollOffset(e)},n={queue:false,duration:a.CONSTANTS.ANIMATION_TIME,start:function(){i._scrollLocked=true},complete:function(){i._scrollLocked=false;var t=i._getProgressNavigator();if(!t){return}t._updateCurrentStep(i._stepPath.indexOf(e)+1,undefined,true);if(r||r===undefined){i._focusFirstStepElement(e)}}};t(this.getDomRef("step-container")).animate(s,n);return this};a.prototype.discardProgress=function(e){var r=this.getProgress(),i=this._stepPath,s=this._stepPath.indexOf(e),n=s+1;if(n>r||n<=0){t.sap.log.warning("The given step is either not yet reached, or is not present in the wizard control.");return this}this._getProgressNavigator().discardProgress(n,true);this._updateNextButtonState();this._restoreInitialValidatedState(n);this._stepPath[s]._markAsLast();for(var o=0;o<n-1;o++){var a=i[o].getAggregation("_nextButton");a.setEnabled(false);a.removeStyleClass("sapMWizardNextButtonVisible")}for(var p=n;p<i.length;p++){i[p]._deactivate();if(i[p].getSubsequentSteps().length>1){i[p].setNextStep(null)}}if(e.getSubsequentSteps().length>1){e.setNextStep(null)}i.splice(n);this._updateProgressNavigator();this.setAssociation("currentStep",e);return this};a.prototype.setCurrentStep=function(t){this.setAssociation("currentStep",t,true);var e=typeof t==="string"?sap.ui.getCore().byId(t):t;if(e&&this._isStepReachable(e)){this._activateAllPreceedingSteps(e)}return this};a.prototype.setShowNextButton=function(t){this.setProperty("showNextButton",t,true);this.getSteps().forEach(function(e){e.getAggregation("_nextButton").setVisible(t)});return this};a.prototype.setFinishButtonText=function(t){this.setProperty("finishButtonText",t,true);this._updateNextButtonState();return this};a.prototype.getFinishButtonText=function(){if(this.getProperty("finishButtonText")==="Review"){return this._resourceBundle.getText("WIZARD_FINISH")}else{return this.getProperty("finishButtonText")}};a.prototype.addStep=function(e){if(this._isMaxStepCountExceeded()){t.sap.log.error("The Wizard is supposed to handle up to 8 steps.");return this}e._oNextButton.attachPress(this._handleNextButtonPress.bind(this));this._incrementStepCount();return this.addAggregation("steps",e)};a.prototype.insertStep=function(t,e){throw new Error("Dynamic step insertion is not yet supported.")};a.prototype.removeStep=function(t){throw new Error("Dynamic step removal is not yet supported.")};a.prototype.removeAllSteps=function(){this._resetStepCount();return this.removeAllAggregation("steps")};a.prototype.destroySteps=function(){this._resetStepCount();this._getProgressNavigator().setStepCount(this._getStepCount());return this.destroyAggregation("steps")};a.prototype._activateAllPreceedingSteps=function(t){if(this._stepPath.indexOf(t)>=0){this.discardProgress(t);return}while(this.getProgressStep()!==t){this.nextStep()}};a.prototype._isNextStepDetermined=function(){if(!this.getEnableBranching()){return true}var t=sap.ui.getCore().byId(this.getCurrentStep());return t._getNextStepReference()!==null};a.prototype._isStepReachable=function(t){if(this.getEnableBranching()){var e=this._getStartingStep();while(e!==t){e=e._getNextStepReference();if(e==null){return false}}return true}else{return this.getSteps().indexOf(t)>=0}};a.prototype._initScrollEnablement=function(){return new i(this,null,{scrollContainerId:this.getId()+"-step-container",horizontal:false,vertical:true})};a.prototype._initProgressNavigator=function(){var e=this,r=new s(this.getId()+"-progressNavigator",{stepChanged:this._handleStepChanged.bind(this)});r._setOnEnter(function(r,i){var s=e._stepPath[i];t.sap.delayedCall(a.CONSTANTS.ANIMATION_TIME,e,function(){this._focusFirstStepElement(s)})});this.setAggregation("_progressNavigator",r)};a.prototype._handleNextButtonPress=function(){var t=this._getProgressNavigator(),e=this._stepPath[this._stepPath.length-1],r=t.getProgress(),i=t.getStepCount(),s=this.getEnableBranching()?e._isLeaf():r===i;if(s){this.fireComplete()}else{var n=this.getProgressStep();this._getNextButton().setVisible(false);n._complete();if(!this._isNextStepDetermined()){throw new Error("The wizard is in branching mode, and the nextStep association is not set.")}if(r===i){t.setStepCount(i+1);t.rerender()}t.incrementProgress();this._handleStepActivated(t.getProgress());this._handleStepChanged(t.getProgress());this.setAssociation("currentStep",this._stepPath[this._stepPath.length-1],true)}this._updateNextButtonState()};a.prototype._getStepScrollOffset=function(e){var r=e.$().position().top,i=this._scroller.getScrollTop(),s=this._stepPath[this.getProgress()-1],o=0;if(!n.system.phone&&!t.sap.containsOrEquals(s.getDomRef(),this._getNextButton().getDomRef())){o=this._getNextButton().$().outerHeight()}return i+r-(a.CONSTANTS.SCROLL_OFFSET+o)};a.prototype._focusFirstStepElement=function(t){var e=t.$();if(e.firstFocusableDomRef()){e.firstFocusableDomRef().focus()}};a.prototype._handleStepChanged=function(t){var e=(typeof t==="number"?t:t.getParameter("current"))-2;var r=this._stepPath[e];var i=this._getNextStep(r,e);var s=n.system.desktop?true:false;this.goToStep(i,s)};a.prototype._handleStepActivated=function(t){var e=t-2,r=this._stepPath[e];var i=this._getNextStep(r,e);this._activateStep(i);this._updateProgressNavigator();this.fireStepActivate({index:t})};a.prototype._isMaxStepCountExceeded=function(){if(this.getEnableBranching()){return false}var t=this._getStepCount();return t>=a.CONSTANTS.MAXIMUM_STEPS};a.prototype._isMinStepCountReached=function(){var t=this._getStepCount();return t>=a.CONSTANTS.MINIMUM_STEPS};a.prototype._getStepCount=function(){return this._stepCount};a.prototype._incrementStepCount=function(){this._stepCount+=1;this._getProgressNavigator().setStepCount(this._getStepCount())};a.prototype._decrementStepCount=function(){this._stepCount-=1;this._getProgressNavigator().setStepCount(this._getStepCount())};a.prototype._resetStepCount=function(){this._stepCount=0;this._getProgressNavigator().setStepCount(this._getStepCount())};a.prototype._getProgressNavigator=function(){return this.getAggregation("_progressNavigator")};a.prototype._saveInitialValidatedState=function(){if(this._initialValidatedState){return}this._initialValidatedState=this.getSteps().map(function(t){return t.getValidated()})};a.prototype._restoreInitialValidatedState=function(t){var e=this._stepPath,r=this.getSteps();for(var i=t;i<e.length;i++){var s=e[i];var n=r.indexOf(s);var o=this._initialValidatedState[n];s.setValidated(o)}};a.prototype._getNextStep=function(t,e){if(!this.getEnableBranching()){return this.getSteps()[e+1]}if(e<0){return this._getStartingStep()}var r=t._getNextStepReference();if(r===null){throw new Error("The wizard is in branching mode, and no next step is defined for "+"the current step, please set one.")}if(!this._containsStep(r)){throw new Error("The next step that you have defined is not part of the wizard steps aggregation."+"Please add it to the wizard control.")}var i=t.getSubsequentSteps();if(i.length>0&&!t._containsSubsequentStep(r.getId())){throw new Error("The next step that you have defined is not contained inside the subsequentSteps"+" association of the current step.")}return r};a.prototype._updateNextButtonState=function(){if(!this._getNextButton()){return}var t,e=this._getStepCount(),r=this._getNextButton(),i=this.getProgress(),s=this._stepPath[i-1].getValidated();if(this.getEnableBranching()){t=this._stepPath[i-1]._isLeaf()}else{t=i===e}r.setEnabled(s);if(t){r.setText(this.getFinishButtonText())}else{r.setText(this._resourceBundle.getText("WIZARD_STEP")+" "+(i+1))}};a.prototype._getNextButton=function(){var t=this._stepPath[this._stepPath.length-1];if(t){return t.getAggregation("_nextButton")}else{return null}};a.prototype._updateProgressNavigator=function(){var t=this._getProgressNavigator(),e=this._getStartingStep(),r=this.getSteps(),i=[e.getTitle()],s=[e.getIcon()],n=[],o=1;if(this.getEnableBranching()){while(!e._isLeaf()&&e._getNextStepReference()!==null){o++;e=e._getNextStepReference();i.push(e.getTitle());n.push(e.getOptional());s.push(e.getIcon())}t.setVaryingStepCount(e._isBranched());t.setStepCount(o)}else{i=r.map(function(t){return t.getTitle()});n=r.map(function(t){return t.getOptional()});s=r.map(function(t){return t.getIcon()})}t.setStepTitles(i);t._stepOptionalIndication=n;t.setStepIcons(s)};a.prototype._getStartingStep=function(){return this.getSteps()[0]};a.prototype._attachScrollHandler=function(){var t=this.getDomRef("step-container");t.onscroll=this._scrollHandler.bind(this)};a.prototype._scrollHandler=function(t){if(this._scrollLocked){return}var e=t.target.scrollTop,r=this._getProgressNavigator(),i=this._stepPath[r.getCurrentStep()-1].getDomRef();if(!i){return}var s=i.clientHeight,n=i.offsetTop,o=100;if(e+o>=n+s&&r._isActiveStep(r._currentStep+1)){r.nextStep()}if(e+o<=n){r.previousStep()}};a.prototype._containsStep=function(t){return this.getSteps().some(function(e){return e===t})};a.prototype._checkCircularReference=function(t){if(this._stepPath.indexOf(t)>=0){throw new Error("The step that you are trying to activate has already been visited. You are creating "+"a loop inside the wizard.")}};a.prototype._activateStep=function(t){this._checkCircularReference(t);this._stepPath.push(t);t._activate()};return a});