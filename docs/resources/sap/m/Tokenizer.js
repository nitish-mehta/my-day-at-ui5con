/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/core/delegate/ScrollEnablement","sap/ui/Device","sap/ui/core/InvisibleText","sap/ui/core/ResizeHandler","./TokenizerRenderer","jquery.sap.keycodes"],function(e,t,o,n,i,s,r,a){"use strict";var l=o.extend("sap.m.Tokenizer",{metadata:{library:"sap.m",properties:{editable:{type:"boolean",group:"Misc",defaultValue:true},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null}},defaultAggregation:"tokens",aggregations:{tokens:{type:"sap.m.Token",multiple:true,singularName:"token"},_tokensInfo:{type:"sap.ui.core.InvisibleText",multiple:false,visibility:"hidden"}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{tokenChange:{parameters:{type:{type:"string"},token:{type:"sap.m.Token"},tokens:{type:"sap.m.Token[]"},addedTokens:{type:"sap.m.Token[]"},removedTokens:{type:"sap.m.Token[]"}}},tokenUpdate:{allowPreventDefault:true,parameters:{type:{type:"string"},addedTokens:{type:"sap.m.Token[]"},removedTokens:{type:"sap.m.Token[]"}}}}}});var d=sap.ui.getCore().getLibraryResourceBundle("sap.m");l.prototype.init=function(){this.bAllowTextSelection=false;this._aTokenValidators=[];this._oScroller=new n(this,this.getId()+"-scrollContainer",{horizontal:true,vertical:false,nonTouchScrolling:true});if(sap.ui.getCore().getConfiguration().getAccessibility()){var e=new s({text:d.getText("TOKENIZER_ARIA_CONTAIN_TOKEN")});this.setAggregation("_tokensInfo",e)}};l.prototype.getScrollDelegate=function(){return this._oScroller};l.prototype.scrollToEnd=function(){var e=this.getDomRef(),t;if(!e){return}if(!this._sResizeHandlerId){t=this;this._sResizeHandlerId=r.register(e,function(){t.scrollToEnd()})}var o=this.$().find(".sapMTokenizerScrollContainer")[0];e.scrollLeft=o.scrollWidth};l.prototype.setWidth=function(e){this.setProperty("width",e,true);this.$().css("width",this.getWidth());return this};l.prototype.setPixelWidth=function(t){if(typeof t!=="number"){e.sap.log.warning("Tokenizer.setPixelWidth called with invalid parameter. Expected parameter of type number.");return}this.setWidth(t+"px");if(this._oScroller){this._oScroller.refresh()}};l.prototype.scrollToStart=function(){var e=this.getDomRef();if(!e){return}this._deactivateScrollToEnd();e.scrollLeft=0};l.prototype._deactivateScrollToEnd=function(){this._deregisterResizeHandler()};l.prototype.getScrollWidth=function(){if(!this.getDomRef()){return 0}return this.$().children(".sapMTokenizerScrollContainer")[0].scrollWidth};l.prototype.onBeforeRendering=function(){this._setTokensAria();this._deregisterResizeHandler()};l.prototype.onAfterRendering=function(){if(!this._sResizeHandlerId){var e=this;this._sResizeHandlerId=r.register(this.getDomRef(),function(){e.scrollToEnd()})}};l.prototype.invalidate=function(e){var t=this.getParent();if(t instanceof sap.m.MultiInput){t.invalidate(e)}else{o.prototype.invalidate.call(this,e)}};l.prototype.onsapfocusleave=function(e){if(document.activeElement==this.getDomRef()||!this._checkFocus()){this._changeAllTokensSelection(false);this._oSelectionOrigin=null}};l.prototype.isAllTokenSelected=function(){if(this.getTokens().length===this.getSelectedTokens().length){return true}return false};l.prototype.onkeydown=function(t){if(t.which===e.sap.KeyCodes.TAB){this._changeAllTokensSelection(false)}if((t.ctrlKey||t.metaKey)&&t.which===e.sap.KeyCodes.A){this._iSelectedToken=this.getSelectedTokens().length;if(this.getTokens().length>0){this.focus();this._changeAllTokensSelection(true);t.preventDefault()}}if((t.ctrlKey||t.metaKey)&&(t.which===e.sap.KeyCodes.C||t.which===e.sap.KeyCodes.INSERT)){this._copy()}if((t.ctrlKey||t.metaKey)&&t.which===e.sap.KeyCodes.X||t.shiftKey&&t.which===e.sap.KeyCodes.DELETE){if(this.getEditable()){this._cut()}else{this._copy()}}};l.prototype._copy=function(){var e=this.getSelectedTokens(),t="",o,n=function(e){if(e.clipboardData){e.clipboardData.setData("text/plain",t)}else{e.originalEvent.clipboardData.setData("text/plain",t)}e.preventDefault()};for(var s=0;s<e.length;s++){o=e[s];t+=(s>0?"\r\n":"")+o.getText()}if(!t){return}if(i.browser.msie&&window.clipboardData){window.clipboardData.setData("text",t)}else{document.addEventListener("copy",n);document.execCommand("copy");document.removeEventListener("copy",n)}};l.prototype._cut=function(){var e=this,t=e.getSelectedTokens(),o="",n=[],s,r,a=function(e){if(e.clipboardData){e.clipboardData.setData("text/plain",o)}else{e.originalEvent.clipboardData.setData("text/plain",o)}e.preventDefault()};s=e.fireTokenUpdate({addedTokens:[],removedTokens:n,type:l.TokenUpdateType.Removed});for(var d=0;d<t.length;d++){r=t[d];o+=(d>0?"\r\n":"")+r.getText();if(s&&r.getEditable()){e.removeToken(r);n.push(r);r.destroy()}}if(!o){return}if(i.browser.msie&&window.clipboardData){window.clipboardData.setData("text",o)}else{document.addEventListener("cut",a);document.execCommand("cut");document.removeEventListener("cut",a)}};l.prototype.onsapbackspace=function(e){if(this.getSelectedTokens().length===0){this.onsapprevious(e)}else if(this.getEditable()){this._removeSelectedTokens()}e.preventDefault();e.stopPropagation()};l.prototype.onsapdelete=function(e){if(this.getEditable()){this._removeSelectedTokens()}};l.prototype._ensureTokenVisible=function(e){if(!e||!e.getDomRef()||!this.getDomRef()){return}var t=this.$().offset().left,o=this.$().width(),n=e.$().offset().left,i=e.$().width();if(this.getTokens().indexOf(e)==0){this.$().scrollLeft(0);return}if(n<t){this.$().scrollLeft(this.$().scrollLeft()-t+n)}if(n-t+i>o){this.$().scrollLeft(this.$().scrollLeft()+(n-t+i-o))}};l.prototype.onsapprevious=function(t){if(t.which===e.sap.KeyCodes.ARROW_UP){return}var o=this.getTokens().length;if(o===0){return}var n=e(document.activeElement).control()[0];var i=n?this.getTokens().indexOf(n):-1;if(i==0){return}var s;if(i>0){s=this.getTokens()[i-1];this._changeAllTokensSelection(false,s);s._changeSelection(true);s.focus()}else{s=this.getTokens()[this.getTokens().length-1];s._changeSelection(true);s.focus()}this._deactivateScrollToEnd();this._ensureTokenVisible(s);t.setMarked()};l.prototype.onsapnext=function(t){if(t.which===e.sap.KeyCodes.ARROW_DOWN){return}var o=this.getTokens().length;if(o===0){return}var n=e(document.activeElement).control()[0];var i=n?this.getTokens().indexOf(n):-1;if(i<o-1){var s=this.getTokens()[i+1];this._changeAllTokensSelection(false,s);s._changeSelection(true);s.focus();this._ensureTokenVisible(s)}else{return}this._deactivateScrollToEnd();t.setMarked()};l.prototype.addValidator=function(e){if(typeof e==="function"){this._aTokenValidators.push(e)}};l.prototype.removeValidator=function(e){var t=this._aTokenValidators.indexOf(e);if(t!==-1){this._aTokenValidators.splice(t,1)}};l.prototype.removeAllValidators=function(){this._aTokenValidators=[]};l.prototype._validateToken=function(e,t){var o=e.token;var n;if(o&&o.getText()){n=o.getText()}else{n=e.text}var i=e.validationCallback;var s=e.suggestionObject;var r,a,d;if(!t){t=this._aTokenValidators}d=t.length;if(d===0){if(!o&&i){i(false)}return o}for(r=0;r<d;r++){a=t[r];o=a({text:n,suggestedToken:o,suggestionObject:s,asyncCallback:this._getAsyncValidationCallback(t,r,n,s,i)});if(!o){if(i){i(false)}return null}if(o===l.WaitForAsyncValidation){return null}}return o};l.prototype._getAsyncValidationCallback=function(e,t,o,n,i){var s=this,r;return function(a){if(a){e=e.slice(t+1);a=s._validateToken({text:o,token:a,suggestionObject:n,validationCallback:i},e);r=s._addUniqueToken(a,i);if(r){s.fireTokenUpdate({addedTokens:[a],removedTokens:[],type:l.TokenUpdateType.Added})}}else{if(i){i(false)}}}};l.prototype.addValidateToken=function(e){var t=this._validateToken(e);this._addUniqueToken(t,e.validationCallback)};l.prototype._addValidateToken=function(e){var t=this._validateToken(e),o=this._addUniqueToken(t,e.validationCallback);if(o){this.fireTokenUpdate({addedTokens:[t],removedTokens:[],type:l.TokenUpdateType.Added})}};l.prototype._addUniqueToken=function(e,t){if(!e){return false}var o=this._tokenExists(e);if(o){var n=this.getParent();if(n instanceof sap.m.MultiInput&&t){t(false)}return false}this.addToken(e);if(t){t(true)}this.fireTokenChange({addedTokens:[e],removedTokens:[],type:l.TokenChangeType.TokensChanged});return true};l.prototype._parseString=function(e){return e.split(/\r\n|\r|\n/g)};l.prototype._checkFocus=function(){return this.getDomRef()&&e.sap.containsOrEquals(this.getDomRef(),document.activeElement)};l.prototype._tokenExists=function(e){var t=this.getTokens();if(!(t&&t.length)){return false}var o=e.getKey();if(!o){return false}var n=t.length;for(var i=0;i<n;i++){var s=t[i];var r=s.getKey();if(r===o){return true}}return false};l.prototype.addToken=function(e,t){var o=this.getParent();if(o instanceof sap.m.MultiInput){if(o.getMaxTokens()!==undefined&&o.getTokens().length>=o.getMaxTokens()){return this}}this.addAggregation("tokens",e,t);this.fireTokenChange({token:e,type:l.TokenChangeType.Added});return this};l.prototype.removeToken=function(e){e=this.removeAggregation("tokens",e);this._bScrollToEndIsActive=true;this.fireTokenChange({token:e,type:l.TokenChangeType.Removed});return e};l.prototype.setTokens=function(e){var t=this.getTokens();this.removeAllTokens(false);var o;for(o=0;o<e.length;o++){this.addToken(e[o],true)}this.invalidate();this.fireTokenChange({addedTokens:e,removedTokens:t,type:l.TokenChangeType.TokensChanged})};l.prototype.removeAllTokens=function(e){var t=this.getTokens();var o=this.removeAllAggregation("tokens");if(typeof e==="boolean"&&!e){return}this.fireTokenChange({addedTokens:[],removedTokens:t,type:l.TokenChangeType.TokensChanged});this.fireTokenChange({tokens:t,type:l.TokenChangeType.RemovedAll});return o};l.prototype.updateTokens=function(){this.destroyTokens();this.updateAggregation("tokens")};l.prototype._removeSelectedTokens=function(){var e=this.getSelectedTokens();var t,o,n,i;n=e.length;if(n===0){return this}i=this.fireTokenUpdate({addedTokens:[],removedTokens:e,type:l.TokenUpdateType.Removed});if(!i){return}for(o=0;o<n;o++){t=e[o];if(t.getEditable()){t.destroy()}}this.scrollToEnd();this.fireTokenChange({addedTokens:[],removedTokens:e,type:l.TokenChangeType.TokensChanged});var s=this.getParent(),r=s&&s instanceof sap.m.MultiInput;if(r){if(!s._bUseDialog){s.$("inner").focus()}}else{this.focus()}this._doSelect();return this};l.prototype.selectAllTokens=function(e){if(e===undefined){e=true}var t=this.getTokens(),o=t.length,n;for(n=0;n<o;n++){t[n].setSelected(e)}this._doSelect();return this};l.prototype._changeAllTokensSelection=function(e,t){var o=this.getTokens(),n=o.length,i,s;for(s=0;s<n;s++){i=o[s];if(i!==t){i._changeSelection(e)}}this._doSelect();return this};l.prototype.getSelectedTokens=function(){var e=[],t=this.getTokens(),o,n,i=t.length;for(o=0;o<i;o++){n=t[o];if(n.getSelected()){e.push(n)}}return e};l.prototype._onTokenDelete=function(e){if(e&&this.getEditable()){var t=this.fireTokenUpdate({addedTokens:[],removedTokens:[e],type:l.TokenUpdateType.Removed});if(!t){return}e.destroy();this.fireTokenChange({addedTokens:[],removedTokens:[e],type:l.TokenChangeType.TokensChanged})}};l.prototype._onTokenSelect=function(e,t,o){var n=this.getTokens(),i,s;if(o){var r=this._getFocusedToken();if(!r){this._oSelectionOrigin=null;return}if(this._oSelectionOrigin){r=this._oSelectionOrigin}else{this._oSelectionOrigin=r}var a=this.indexOfToken(r),l=this.indexOfToken(e),d=Math.min(a,l),c=Math.max(a,l);for(s=0;s<n.length;s++){i=n[s];if(s>=d&&s<=c){i._changeSelection(true)}else if(!t){i._changeSelection(false)}}return}this._oSelectionOrigin=null;if(t){return}this._oSelectionOrigin=e;for(s=0;s<n.length;s++){i=n[s];if(i!==e){i._changeSelection(false)}}};l.prototype._getFocusedToken=function(){var e=sap.ui.getCore().byId(document.activeElement.id);if(!e||!(e instanceof sap.m.Token)||this.indexOfToken(e)==-1){return null}return e};l.prototype.setEditable=function(e){this.$().toggleClass("sapMTokenizerReadonly",!e);return this.setProperty("editable",e,true)};l.prototype.onsaphome=function(e){this.scrollToStart()};l.prototype.onsapend=function(e){this.scrollToEnd()};l.prototype.ontouchstart=function(e){e.setMarked();if(i.browser.chrome&&window.getSelection()){window.getSelection().removeAllRanges()}};l.prototype.exit=function(){this._deregisterResizeHandler()};l.prototype._deregisterResizeHandler=function(){if(this._sResizeHandlerId){r.deregister(this._sResizeHandlerId);delete this._sResizeHandlerId}};l.prototype._setTokensAria=function(){var e=this.getTokens().length,t,o="";if(sap.ui.getCore().getConfiguration().getAccessibility()){t=this.getAggregation("_tokensInfo");switch(e){case 0:o=d.getText("TOKENIZER_ARIA_CONTAIN_TOKEN");break;case 1:o=d.getText("TOKENIZER_ARIA_CONTAIN_ONE_TOKEN");break;default:o=d.getText("TOKENIZER_ARIA_CONTAIN_SEVERAL_TOKENS",e);break}t.setText(o)}};l.prototype._doSelect=function(){if(this._checkFocus()&&this._bCopyToClipboardSupport){var t=document.activeElement;var o=window.getSelection();o.removeAllRanges();if(this.getSelectedTokens().length){var n=document.createRange();n.selectNodeContents(this.getDomRef("clip"));o.addRange(n)}if(window.clipboardData&&document.activeElement.id==this.getId()+"-clip"){e.sap.focus(t.id==this.getId()+"-clip"?this.getDomRef():t)}}};l.prototype.getReverseTokens=function(){return!!this._reverseTokens};l.prototype.setReverseTokens=function(e){this._reverseTokens=e};l.prototype.getTokensInfoId=function(){return this.getAggregation("_tokensInfo").getId()};l.TokenChangeType={Added:"added",Removed:"removed",RemovedAll:"removedAll",TokensChanged:"tokensChanged"};l.TokenUpdateType={Added:"added",Removed:"removed"};l.WaitForAsyncValidation="sap.m.Tokenizer.WaitForAsyncValidation";return l});