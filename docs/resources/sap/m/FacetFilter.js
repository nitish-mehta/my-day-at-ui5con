/*!
* UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
*/
sap.ui.define(["jquery.sap.global","./NavContainer","./library","sap/ui/core/Control","sap/ui/core/IconPool","sap/ui/core/delegate/ItemNavigation","sap/ui/core/InvisibleText","sap/ui/Device","sap/ui/base/ManagedObject","sap/ui/core/Icon","sap/ui/model/Filter","./FacetFilterRenderer","jquery.sap.keycodes"],function(e,t,i,a,s,r,o,n,l,g,p,h){"use strict";var u=i.ToolbarDesign;var d=i.ListType;var c=i.ListMode;var f=i.FacetFilterListDataType;var v=i.ButtonType;var _=i.PlacementType;var m=i.FacetFilterType;var y=a.extend("sap.m.FacetFilter",{metadata:{interfaces:["sap.ui.core.IShrinkable"],library:"sap.m",properties:{showPersonalization:{type:"boolean",group:"Appearance",defaultValue:false},type:{type:"sap.m.FacetFilterType",group:"Appearance",defaultValue:m.Simple},liveSearch:{type:"boolean",group:"Behavior",defaultValue:true},showSummaryBar:{type:"boolean",group:"Behavior",defaultValue:false},showReset:{type:"boolean",group:"Behavior",defaultValue:true},showPopoverOKButton:{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"lists",aggregations:{lists:{type:"sap.m.FacetFilterList",multiple:true,singularName:"list"},buttons:{type:"sap.m.Button",multiple:true,singularName:"button",visibility:"hidden"},removeFacetIcons:{type:"sap.ui.core.Icon",multiple:true,singularName:"removeFacetIcon",visibility:"hidden"},popover:{type:"sap.m.Popover",multiple:false,visibility:"hidden"},addFacetButton:{type:"sap.m.Button",multiple:false,visibility:"hidden"},dialog:{type:"sap.m.Dialog",multiple:false,visibility:"hidden"},summaryBar:{type:"sap.m.Toolbar",multiple:false,visibility:"hidden"},resetButton:{type:"sap.m.Button",multiple:false,visibility:"hidden"},arrowLeft:{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"},arrowRight:{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"}},events:{reset:{},confirm:{}}}});y.SCROLL_STEP=264;y.prototype.setType=function(e){var t=this.getAggregation("summaryBar");if(n.system.phone){this.setProperty("type",m.Light);t.setActive(true)}else{this.setProperty("type",e);t.setActive(e===m.Light)}if(e===m.Light){if(this.getShowReset()){this._addResetToSummary(t)}else{this._removeResetFromSummary(t)}}return this};y.prototype.setShowReset=function(e){this.setProperty("showReset",e);var t=this.getAggregation("summaryBar");if(e){if(this.getShowSummaryBar()||this.getType()===m.Light){this._addResetToSummary(t)}}else{if(this.getShowSummaryBar()||this.getType()===m.Light){this._removeResetFromSummary(t)}}return this};y.prototype.setShowSummaryBar=function(e){this.setProperty("showSummaryBar",e);if(e){var t=this.getAggregation("summaryBar");if(this.getShowReset()){this._addResetToSummary(t)}else{this._removeResetFromSummary(t)}t.setActive(this.getType()===m.Light)}return this};y.prototype.setLiveSearch=function(e){this.setProperty("liveSearch",e);if(this._displayedList){var t=this._displayedList;var i=sap.ui.getCore().byId(t.getAssociation("search"));i.detachLiveChange(t._handleSearchEvent,t);if(e){i.attachLiveChange(t._handleSearchEvent,t)}}return this};y.prototype.getLists=function(){var e=this.getAggregation("lists");if(!e){e=[]}if(this._displayedList){e.splice(this._listAggrIndex,0,this._displayedList)}return e};y.prototype.removeList=function(e){var t=l.prototype.removeAggregation.call(this,"lists",e);this._removeList(t);return t};y.prototype.removeAggregation=function(){var e=l.prototype.removeAggregation.apply(this,arguments);if(arguments[0]==="lists"){this._removeList(e)}return e};y.prototype.openFilterDialog=function(){var e=this._getFacetDialog();var t=this._getFacetDialogNavContainer();e.addContent(t);e.setInitialFocus(t.getPages()[0].getContent()[0].getItems()[0]);e.open();return this};y.prototype.init=function(){this._pageSize=5;this._addDelegateFlag=false;this._invalidateFlag=false;this._lastCategoryFocusIndex=0;this._aDomRefs=null;this._previousTarget=null;this._addTarget=null;this._aRows=null;this._bundle=sap.ui.getCore().getLibraryResourceBundle("sap.m");this.data("sap-ui-fastnavgroup","true",true);this._buttons={};this._aOwnedLabels=[];this._removeFacetIcons={};this._listAggrIndex=-1;this._displayedList=null;this._lastScrolling=false;this._bPreviousScrollForward=false;this._bPreviousScrollBack=false;this._getAddFacetButton();this._getSummaryBar();this.setAggregation("resetButton",this._createResetButton());if(e.sap.touchEventMode==="ON"&&!n.system.phone){this._enableTouchSupport()}if(n.system.phone){this.setType(m.Light)}};y.prototype.exit=function(){var e;sap.ui.getCore().detachIntervalTimer(this._checkOverflow,this);if(this.oItemNavigation){this.removeDelegate(this.oItemNavigation);this.oItemNavigation.destroy()}if(this._aOwnedLabels){this._aOwnedLabels.forEach(function(t){e=sap.ui.getCore().byId(t);if(e){e.destroy()}});this._aOwnedLabels=null}};y.prototype.onBeforeRendering=function(){if(this.getShowSummaryBar()||this.getType()===m.Light){var e=this.getAggregation("summaryBar");var t=e.getContent()[0];t.setText(this._getSummaryText());t.setTooltip(this._getSummaryText())}sap.ui.getCore().detachIntervalTimer(this._checkOverflow,this)};y.prototype.onAfterRendering=function(){if(this.getType()!==m.Light&&!n.system.phone){sap.ui.getCore().attachIntervalTimer(this._checkOverflow,this)}if(this.getType()!==m.Light){this._startItemNavigation()}};y.prototype._startItemNavigation=function(){var e=this.getDomRef(),t=e.getElementsByClassName("sapMFFHead"),i=[];if(t.length>0){for(var a=0;a<t[0].childNodes.length;a++){if(t[0].childNodes[a].id.indexOf("ff")<0&&t[0].childNodes[a].id.indexOf("icon")<0&&t[0].childNodes[a].id.indexOf("add")<0){i.push(t[0].childNodes[a])}if(t[0].childNodes[a].id.indexOf("add")>=0){i.push(t[0].childNodes[a])}}}if(i!=""){this._aDomRefs=i}if(!this.oItemNavigation||this._addDelegateFlag==true){this.oItemNavigation=new r;this.addDelegate(this.oItemNavigation);this._addDelegateFlag=false}this._aRows=t;for(var a=0;a<this.$().find(":sapTabbable").length;a++){if(this.$().find(":sapTabbable")[a].id.indexOf("add")>=0){this._addTarget=this.$().find(":sapTabbable")[a];break}}this.oItemNavigation.setRootDomRef(e);this.oItemNavigation.setItemDomRefs(i);this.oItemNavigation.setCycling(false);this.oItemNavigation.setPageSize(this._pageSize)};y.prototype.onsapdelete=function(t){var i,a;if(this.getType()===m.Light){return}if(!this.getShowPersonalization()){return}i=sap.ui.getCore().byId(t.target.id);if(!i){return}a=sap.ui.getCore().byId(i.getAssociation("list"));if(!a){return}if(!a.getShowRemoveFacetIcon()){return}a.removeSelections(true);a.setSelectedKeys();a.setProperty("active",false,true);this.invalidate();var s=this.$().find(":sapTabbable");e(s[s.length-1]).focus();var r=this.oItemNavigation.getFocusedIndex();e(t.target).blur();this.oItemNavigation.setFocusedIndex(r+1);this.focus();if(this.oItemNavigation.getFocusedIndex()==0){for(var o=0;o<this.$().find(":sapTabbable").length-1;o++){if(s[o].id.indexOf("add")>=0){e(s[o]).focus()}}}};y.prototype.onsaptabnext=function(t){if(this.getType()===m.Light){return}this._previousTarget=t.target;if(t.target.parentNode.className=="sapMFFHead"){for(var i=0;i<this.$().find(":sapTabbable").length;i++){if(this.$().find(":sapTabbable")[i].parentNode.className=="sapMFFResetDiv"){e(this.$().find(":sapTabbable")[i]).focus();t.preventDefault();t.setMarked();return}}}this._lastCategoryFocusIndex=this.oItemNavigation.getFocusedIndex();if(this._invalidateFlag==true){this.oItemNavigation.setFocusedIndex(-1);this.focus();this._invalidateFlag=false}};y.prototype.onsaptabprevious=function(t){if(this.getType()===m.Light){return}if(t.target.parentNode.className=="sapMFFResetDiv"&&this._previousTarget==null){e(this.$().find(":sapTabbable")[0]).focus();t.preventDefault();t.setMarked();return}if(t.target.parentNode.className=="sapMFFResetDiv"&&this._previousTarget!=null&&this._previousTarget.id!=t.target.id){e(this._previousTarget).focus();t.preventDefault();t.setMarked();return}if(t.target.id.indexOf("add")>=0||t.target.parentNode.className=="sapMFFHead"){this._previousTarget=t.target;e(this.$().find(":sapTabbable")[0]).focus()}};y.prototype.onsapend=function(t){if(this.getType()===m.Light){return}if(this._addTarget!=null){e(this._addTarget).focus();t.preventDefault();t.setMarked()}else{e(this._aRows[this._aRows.length-1]).focus();t.preventDefault();t.setMarked()}this._previousTarget=t.target};y.prototype.onsaphome=function(t){if(this.getType()===m.Light){return}e(this._aRows[0]).focus();t.preventDefault();t.setMarked();this._previousTarget=t.target};y.prototype.onsappageup=function(e){this._previousTarget=e.target};y.prototype.onsappagedown=function(e){this._previousTarget=e.target};y.prototype.onsapincreasemodifiers=function(t){if(this.getType()===m.Light){return}if(t.which==e.sap.KeyCodes.ARROW_RIGHT){this._previousTarget=t.target;var i=this.oItemNavigation.getFocusedIndex()-1;var a=i+this._pageSize;e(t.target).blur();this.oItemNavigation.setFocusedIndex(a);this.focus()}};y.prototype.onsapdecreasemodifiers=function(t){if(this.getType()===m.Light){return}var i=0;if(t.which==e.sap.KeyCodes.ARROW_LEFT){this._previousTarget=t.target;i=this.oItemNavigation.getFocusedIndex()+1;var a=i-this._pageSize;e(t.target).blur();this.oItemNavigation.setFocusedIndex(a);this.focus()}};y.prototype.onsapdownmodifiers=function(t){if(this.getType()===m.Light){return}this._previousTarget=t.target;var i=0;i=this.oItemNavigation.getFocusedIndex()-1;var a=i+this._pageSize;e(t.target).blur();this.oItemNavigation.setFocusedIndex(a);this.focus()};y.prototype.onsapupmodifiers=function(t){if(this.getType()===m.Light){return}this._previousTarget=t.target;var i=0;i=this.oItemNavigation.getFocusedIndex();if(i!=0){i=i+1}var a=i-this._pageSize;e(t.target).blur();this.oItemNavigation.setFocusedIndex(a);this.focus()};y.prototype.onsapexpand=function(t){if(this.getType()===m.Light){return}this._previousTarget=t.target;var i=this.oItemNavigation.getFocusedIndex()+1;e(t.target).blur();this.oItemNavigation.setFocusedIndex(i);this.focus()};y.prototype.onsapcollapse=function(t){if(this.getType()===m.Light){return}this._previousTarget=t.target;var i=this.oItemNavigation.getFocusedIndex()-1;e(t.target).blur();this.oItemNavigation.setFocusedIndex(i);this.focus()};y.prototype.onsapdown=function(t){if(this.getType()===m.Light){return}this._previousTarget=t.target;if(t.target.parentNode.className=="sapMFFResetDiv"){e(t.target).focus();t.preventDefault();t.setMarked();return}};y.prototype.onsapup=function(t){if(this.getType()===m.Light){return}this._previousTarget=t.target;if(t.target.parentNode.className=="sapMFFResetDiv"){e(t.target).focus();t.preventDefault();t.setMarked()}};y.prototype.onsapleft=function(t){if(this.getType()===m.Light){return}this._previousTarget=t.target;if(t.target.parentNode.className=="sapMFFResetDiv"){e(t.target).focus();t.preventDefault();t.setMarked()}};y.prototype.onsapright=function(t){if(this.getType()===m.Light){return}this._previousTarget=t.target;if(t.target.parentNode.className=="sapMFFResetDiv"){e(t.target).focus();t.preventDefault();t.setMarked()}};y.prototype.onsapescape=function(t){if(this.getType()===m.Light){return}if(t.target.parentNode.className=="sapMFFResetDiv"){return}var i=this._lastCategoryFocusIndex;e(t.target).blur();this.oItemNavigation.setFocusedIndex(i);this.focus()};y.prototype._getPopover=function(){var t=this.getAggregation("popover");if(!t){var i=this;t=new sap.m.Popover({placement:_.Bottom,beforeOpen:function(e){if(i._displayedList){i._displayedList._setSearchValue("")}this.setCustomHeader(i._createFilterItemsSearchFieldBar(i._displayedList));var t=this.getSubHeader();if(!t){this.setSubHeader(i._createSelectAllCheckboxBar(i._displayedList))}a(i._displayedList)},afterClose:function(t){i._addDelegateFlag=true;if(n.browser.internet_explorer&&n.browser.version<10){e.sap.delayedCall(100,i,i._handlePopoverAfterClose)}else{i._handlePopoverAfterClose()}},horizontalScrolling:false});this.setAggregation("popover",t,true);t.setContentWidth("30%");if(n.browser.internet_explorer&&n.browser.version<10){t.setContentWidth("30%")}t.addStyleClass("sapMFFPop");var a=function(e){if(!e){return}var t=i._getFacetRemoveIcon(e);if(t){t._bTouchStarted=false}}}if(this.getShowPopoverOKButton()){this._addOKButtonToPopover(t)}else{t.destroyAggregation("footer")}return t};y.prototype._handlePopoverAfterClose=function(){var t=this.getAggregation("popover"),i=this._displayedList;if(!t){return}var a=this._getFacetRemoveIcon(i);if(a&&a._bTouchStarted){return}this._restoreListFromDisplayContainer(t);this._displayRemoveIcon(false,i);i._fireListCloseEvent();this._fireConfirmEvent();this.destroyAggregation("popover");if(this._oOpenPopoverDeferred){e.sap.delayedCall(0,this,function(){this._oOpenPopoverDeferred.resolve();this._oOpenPopoverDeferred=undefined})}};y.prototype._fireConfirmEvent=function(){this.fireEvent("confirm")};y.prototype._openPopover=function(t,i){if(!t.isOpen()){var a=sap.ui.getCore().byId(i.getAssociation("list"));e.sap.assert(a,"The facet filter button should be associated with a list.");a.fireListOpen({});this._moveListToDisplayContainer(a,t);t.openBy(i);if(a.getShowRemoveFacetIcon()){this._displayRemoveIcon(true,a)}if(a.getWordWrap()){t.setContentWidth("30%")}a._applySearch()}return this};y.prototype._getAddFacetButton=function(){var e=this.getAggregation("addFacetButton");if(!e){var t=this;var e=new sap.m.Button(this.getId()+"-add",{icon:s.getIconURI("add-filter"),type:v.Transparent,tooltip:this._bundle.getText("FACETFILTER_ADDFACET"),press:function(e){t.openFilterDialog()}});this.setAggregation("addFacetButton",e,true)}return e};y.prototype._getButtonForList=function(t){if(this._buttons[t.getId()]){this._setButtonText(t);return this._buttons[t.getId()]}var i=this;var a=new sap.m.Button({type:v.Transparent,press:function(t){var a=this;var s=function(){var e=i._getPopover();i._openPopover(e,a)};if(n.browser.internet_explorer&&n.browser.version<10){e.sap.delayedCall(100,this,s)}else{var r=i._getPopover();if(r.isOpen()){e.sap.delayedCall(100,this,function(){if(r.isOpen()){return}i._oOpenPopoverDeferred=e.Deferred();i._oOpenPopoverDeferred.promise().done(s)})}else{e.sap.delayedCall(100,this,s)}}}});this._buttons[t.getId()]=a;this.addAggregation("buttons",a);a.setAssociation("list",t.getId(),true);this._setButtonText(t);return a};y.prototype._setButtonText=function(e){var t=this._buttons[e.getId()];if(e._iAllItemsCount===undefined&&e.getMaxItemsCount()){e._iAllItemsCount=e.getMaxItemsCount()}if(t){var i="";var a=Object.getOwnPropertyNames(e._oSelectedKeys);var s=a.length;if(s===1){var r=e._oSelectedKeys[a[0]];i=this._bundle.getText("FACETFILTER_ITEM_SELECTION",[e.getTitle(),r])}else if(s>0&&s===(e._iAllItemsCount?e._iAllItemsCount:0)){i=this._bundle.getText("FACETFILTER_ALL_SELECTED",[e.getTitle()])}else if(s>0){i=this._bundle.getText("FACETFILTER_ITEM_SELECTION",[e.getTitle(),s])}else{i=e.getTitle()}t.setText(i)}};y.prototype._getFacetRemoveIcon=function(t){var i=this,a=this._removeFacetIcons[t.getId()];if(!a){a=new g({src:s.getIconURI("sys-cancel"),tooltip:this._bundle.getText("FACETFILTER_REMOVE"),press:function(){a._bPressed=true}});a.addDelegate({ontouchstart:function(){a._bTouchStarted=true;a._bPressed=false},ontouchend:function(){i._displayRemoveIcon(false,t);a._bTouchStarted=false;e.sap.delayedCall(100,this,r)}},true);var r=function(){if(a._bPressed){t.removeSelections(true);t.setSelectedKeys();t.setProperty("active",false,true)}i._handlePopoverAfterClose()};a.setAssociation("list",t.getId(),true);a.addStyleClass("sapMFFLRemoveIcon");this._removeFacetIcons[t.getId()]=a;this.addAggregation("removeFacetIcons",a);this._displayRemoveIcon(false,t)}return a};y.prototype._displayRemoveIcon=function(e,t){if(this.getShowPersonalization()){var i=this._removeFacetIcons[t.getId()];if(e){i.removeStyleClass("sapMFFLHiddenRemoveIcon");i.addStyleClass("sapMFFLVisibleRemoveIcon")}else{i.removeStyleClass("sapMFFLVisibleRemoveIcon");i.addStyleClass("sapMFFLHiddenRemoveIcon")}}};y.prototype._getFacetDialogNavContainer=function(){var i=new t({autoFocus:false});var a=this._createFacetPage();i.addPage(a);i.setInitialPage(a);var s=this;i.attachAfterNavigate(function(t){var i=t.getParameters()["to"];var r=t.getParameters()["from"];if(r===a){var o=s._displayedList.getMode()===c.MultiSelect?i.getContent(0)[1].getItems()[0]:i.getContent(0)[0].getItems()[0];if(o){o.focus()}}if(i===a){r.destroySubHeader();e.sap.assert(s._displayedList===null,"Filter items list should have been placed back in the FacetFilter aggregation before page content is destroyed.");r.destroyContent();s._selectedFacetItem.invalidate();i.invalidate();e.sap.focus(s._selectedFacetItem);s._selectedFacetItem=null}});return i};y.prototype._createFacetPage=function(){var e=this._createFacetList();var t=new sap.m.SearchField({width:"100%",tooltip:this._bundle.getText("FACETFILTER_SEARCH"),liveChange:function(t){var i=e.getBinding("items");if(i){var a=new p("text",sap.ui.model.FilterOperator.Contains,t.getParameters()["newValue"]);i.filter([a])}}});var i=new sap.m.Page({enableScrolling:true,title:this._bundle.getText("FACETFILTER_TITLE"),subHeader:new sap.m.Bar({contentMiddle:t}),content:[e]});return i};y.prototype._createFilterItemsPage=function(){var e=this;var t=new sap.m.Page({showNavButton:true,enableScrolling:true,navButtonPress:function(t){var i=t.getSource().getParent();e._navFromFilterItemsPage(i)}});return t};y.prototype._getFilterItemsPage=function(e){var t=e.getPages()[1];if(t){e.removePage(t);t.destroy()}var i=this._createFilterItemsPage();e.addPage(i);return i};y.prototype._createFilterItemsSearchFieldBar=function(e){var t=this;var i=true;if(e.getDataType()!=f.String){i=false}var a=new sap.m.SearchField({value:e._getSearchValue(),width:"100%",enabled:i,tooltip:this._bundle.getText("FACETFILTER_SEARCH"),search:function(e){t._displayedList._handleSearchEvent(e)}});if(this.getLiveSearch()){a.attachLiveChange(e._handleSearchEvent,e)}var s=new sap.m.Bar({contentMiddle:a});e.setAssociation("search",a);return s};y.prototype._getFacetDialog=function(){var e=this.getAggregation("dialog");if(!e){var t=this;e=new sap.m.Dialog({showHeader:false,stretch:n.system.phone?true:false,afterClose:function(){t._addDelegateFlag=true;t._invalidateFlag=true;var e=this.getContent()[0];var i=e.getPages()[1];if(e.getCurrentPage()===i){var a=t._restoreListFromDisplayContainer(i);a._fireListCloseEvent();a._search("")}this.destroyAggregation("content",true);t.invalidate()},beginButton:new sap.m.Button({text:this._bundle.getText("FACETFILTER_ACCEPT"),tooltip:this._bundle.getText("FACETFILTER_ACCEPT"),press:function(){t._closeDialog()}}),contentHeight:"500px"});e.addStyleClass("sapMFFDialog");e.onsapentermodifiers=function(e){if(e.shiftKey&&!e.ctrlKey&&!e.altKey){var i=this.getContent()[0];t._navFromFilterItemsPage(i)}};this.setAggregation("dialog",e,true)}return e};y.prototype._closeDialog=function(){var e=this.getAggregation("dialog");if(e&&e.isOpen()){e.close();this._fireConfirmEvent()}};y.prototype._closePopover=function(){var e=this.getAggregation("popover");if(e&&e.isOpen()){e.close()}};y.prototype._createFacetList=function(){var e=new sap.m.List({mode:c.None,items:{path:"/items",template:new sap.m.StandardListItem({title:"{text}",counter:"{count}",type:d.Navigation,customData:[new sap.ui.core.CustomData({key:"index",value:"{index}"})]})}});var t=[];for(var i=0;i<this.getLists().length;i++){var a=this.getLists()[i];t.push({text:a.getTitle(),count:a.getAllCount(),index:i})}var s=new sap.ui.model.json.JSONModel({items:t});if(t.length>100){s.setSizeLimit(t.length)}var r=this;e.attachUpdateFinished(function(){for(var t=0;t<e.getItems().length;t++){var i=this.getItems()[t];i.detachPress(r._handleFacetListItemPress,r);i.attachPress(r._handleFacetListItemPress,r)}});e.setModel(s);return e};y.prototype._createSelectAllCheckboxBar=function(e){if(!e.getMultiSelect()){return null}var t=e.getActive()&&e.getItems().length>0&&Object.getOwnPropertyNames(e._oSelectedKeys).length===e.getItems().length;var i=new sap.m.CheckBox(e.getId()+"-selectAll",{text:this._bundle.getText("FACETFILTER_CHECKBOX_ALL"),tooltip:this._bundle.getText("FACETFILTER_CHECKBOX_ALL"),selected:t,select:function(t){i.setSelected(t.getParameter("selected"));e._handleSelectAllClick(t.getParameter("selected"))}});e.setAssociation("allcheckbox",i);var a=new sap.m.Bar;a.addEventDelegate({ontap:function(t){if(t.srcControl===this){e._handleSelectAllClick(i.getSelected())}}},a);a.addContentLeft(i);a.addStyleClass("sapMFFCheckbar");return a};y.prototype._handleFacetListItemPress=function(e){this._navToFilterItemsPage(e.getSource())};y.prototype._navToFilterItemsPage=function(t){this._selectedFacetItem=t;var i=this.getAggregation("dialog").getContent()[0];var a=t.getCustomData();e.sap.assert(a.length===1,"There should be exactly one custom data for the original facet list item index");var s=a[0].getValue();var r=this.getLists()[s];this._listIndexAgg=this.indexOfAggregation("lists",r);if(this._listIndexAgg==s){var o=this._getFilterItemsPage(i);r.fireListOpen({});this._moveListToDisplayContainer(r,o);o.setSubHeader(this._createFilterItemsSearchFieldBar(r));var n=this._createSelectAllCheckboxBar(r);if(n){o.insertContent(n,0)}o.setTitle(r.getTitle());i.to(o)}};y.prototype._navFromFilterItemsPage=function(e){var t=e.getPages()[1];var i=this._restoreListFromDisplayContainer(t);i._fireListCloseEvent();i._search("");this._selectedFacetItem.setCounter(i.getAllCount());e.backToTop()};y.prototype._moveListToDisplayContainer=function(t,i){this._listAggrIndex=this.indexOfAggregation("lists",t);e.sap.assert(this._listAggrIndex>-1,"The lists index should be valid.");l.prototype.removeAggregation.call(this,"lists",t,true);i.addAggregation("content",t,false);t.setAssociation("facetFilter",this,true);this._displayedList=t};y.prototype._restoreListFromDisplayContainer=function(e){var t=e.removeAggregation("content",this._displayedList,true);this.insertAggregation("lists",t,this._listAggrIndex,t.getActive());this._listAggrIndex=-1;this._displayedList=null;return t};y.prototype._getSequencedLists=function(){var e=-1;var t=[];var i=this.getLists();if(i.length>0){for(var a=0;a<i.length;a++){if(i[a].getActive()){if(i[a].getSequence()<-1){i[a].setSequence(-1)}else if(i[a].getSequence()>e){e=i[a].getSequence()}t.push(i[a])}else if(!i[a].getRetainListSequence()){i[a].setSequence(-1)}}for(var s=0;s<t.length;s++){if(t[s].getSequence()<=-1){e+=1;t[s].setSequence(e)}}if(t.length>1){t.sort(function(e,t){return e.getSequence()-t.getSequence()})}}return t};y.prototype._getSummaryBar=function(){var e=this.getAggregation("summaryBar");if(!e){var t=new sap.m.Text({maxLines:1});var i=this;e=new sap.m.Toolbar({content:[t],active:this.getType()===m.Light?true:false,design:u.Info,press:function(e){i.openFilterDialog()}});e._setRootAccessibilityRole("button");this.setAggregation("summaryBar",e)}return e};y.prototype._createResetButton=function(){var t=this;var i=new sap.m.Button({type:v.Transparent,icon:s.getIconURI("undo"),tooltip:this._bundle.getText("FACETFILTER_RESET"),press:function(i){t._addDelegateFlag=true;t._invalidateFlag=true;t.fireReset();var a=t.getLists();for(var s=0;s<a.length;s++){a[s]._searchValue="";a[s]._applySearch();e.sap.focus(a[s].getItems()[0])}t.invalidate()}});return i};y.prototype._addOKButtonToPopover=function(e){var t=e.getFooter();if(!t){var i=this;var t=new sap.m.Button({text:this._bundle.getText("FACETFILTER_ACCEPT"),tooltip:this._bundle.getText("FACETFILTER_ACCEPT"),width:"100%",press:function(){i._closePopover()}});e.setFooter(t)}return t};y.prototype._getSummaryText=function(){var e=", ";var t=" ";var i="";var a=true;var s=this.getLists();if(s.length>0){for(var r=0;r<s.length;r++){var o=s[r];if(o.getActive()){var n=this._getSelectedItemsText(o);var l="";for(var g=0;g<n.length;g++){l=l+n[g]+e}if(l){l=l.substring(0,l.lastIndexOf(e)).trim();if(a){i=this._bundle.getText("FACETFILTER_INFOBAR_FILTERED_BY",[o.getTitle(),l]);a=false}else{i=i+t+this._bundle.getText("FACETFILTER_INFOBAR_AND")+t+this._bundle.getText("FACETFILTER_INFOBAR_AFTER_AND",[o.getTitle(),l])}}}}}if(!i){i=this._bundle.getText("FACETFILTER_INFOBAR_NO_FILTERS")}return i};y.prototype._getSelectedItemsText=function(e){var t=e.getSelectedItems().map(function(e){return e.getText()});e._oSelectedKeys&&Object.getOwnPropertyNames(e._oSelectedKeys).forEach(function(i){t.indexOf(e._oSelectedKeys[i])===-1&&t.push(e._oSelectedKeys[i])});return t};y.prototype._addResetToSummary=function(e){if(e.getContent().length===1){e.addContent(new sap.m.ToolbarSpacer({width:""}));var t=this._createResetButton();e.addContent(t);t.addStyleClass("sapUiSizeCompact");t.addStyleClass("sapMFFRefresh");t.addStyleClass("sapMFFBtnHoverable")}};y.prototype._removeResetFromSummary=function(e){if(e.getContent().length===3){var t=e.removeAggregation("content",1);t.destroy();var i=e.removeAggregation("content",1);i.destroy()}};y.prototype._removeList=function(e){if(e){var t=this._buttons[e.getId()];if(t){this.removeAggregation("buttons",t);t.destroy()}var i=this._removeFacetIcons[e.getId()];if(i){this.removeAggregation("removeIcons",i);i.destroy()}delete this._buttons[e.getId()];delete this._removeFacetIcons[e.getId()]}};y.prototype._getScrollingArrow=function(t){var i=null;var a={src:"sap-icon://navigation-"+t+"-arrow"};if(t==="left"){i=this.getAggregation("arrowLeft");if(!i){a.id=this.getId()+"-arrowScrollLeft";i=s.createControlByURI(a);var r=["sapMPointer","sapMFFArrowScroll","sapMFFArrowScrollLeft"];for(var o=0;o<r.length;o++){i.addStyleClass(r[o]);i.setTooltip(this._bundle.getText("FACETFILTER_PREVIOUS"))}this.setAggregation("arrowLeft",i)}}else if(t==="right"){i=this.getAggregation("arrowRight");if(!i){a.id=this.getId()+"-arrowScrollRight";i=s.createControlByURI(a);var n=["sapMPointer","sapMFFArrowScroll","sapMFFArrowScrollRight"];for(var o=0;o<n.length;o++){i.addStyleClass(n[o]);i.setTooltip(this._bundle.getText("FACETFILTER_NEXT"))}this.setAggregation("arrowRight",i)}}else{e.sap.log.error("Scrolling arrow name "+t+" is not valid")}return i};y.prototype._checkOverflow=function(){var t=this.getDomRef("head"),i=e(t),a=this.$(),s=false,r=false,o=false,n=null,l=null,g=null;if(t){n=t.scrollLeft;l=t.scrollWidth;g=t.clientWidth;if(l>g){if(l-g==1){l=g}else{o=true}}a.toggleClass("sapMFFScrolling",o);a.toggleClass("sapMFFNoScrolling",!o);this._lastScrolling=o;if(!this._bRtl){s=n>0;r=l>g&&l>n+g}else{r=i.scrollLeftRTL()>0;s=i.scrollRightRTL()>0}if(r!=this._bPreviousScrollForward||s!=this._bPreviousScrollBack){a.toggleClass("sapMFFNoScrollBack",!s);a.toggleClass("sapMFFNoScrollForward",!r)}}};y.prototype.onclick=function(e){var t=e.target.id;if(t){var i=this.getId(),a=e.target;e.preventDefault();if(t==i+"-arrowScrollLeft"){a.tabIndex=-1;a.focus();this._scroll(-y.SCROLL_STEP,500)}else if(t==i+"-arrowScrollRight"){a.tabIndex=-1;a.focus();this._scroll(y.SCROLL_STEP,500)}}};y.prototype._scroll=function(t,i){var a=this.getDomRef("head");var s=a.scrollLeft;if(!n.browser.internet_explorer&&this._bRtl){t=-t}var r=s+t;e(a).stop(true,true).animate({scrollLeft:r},i)};y.prototype._enableTouchSupport=function(){var e=this;var t=function(t){var i=e.getType();if(i===m.Light){return}t.preventDefault();if(e._iInertiaIntervalId){window.clearInterval(e._iInertiaIntervalId)}e.startScrollX=e.getDomRef("head").scrollLeft;e.startTouchX=t.touches[0].pageX;e._bTouchNotMoved=true;e._lastMoveTime=(new Date).getTime()};var i=function(t){var i=e.getType();if(i===m.Light){return}var a=t.touches[0].pageX-e.startTouchX;var s=e.getDomRef("head");var r=s.scrollLeft;var o=e.startScrollX-a;s.scrollLeft=o;e._bTouchNotMoved=false;var n=(new Date).getTime()-e._lastMoveTime;e._lastMoveTime=(new Date).getTime();if(n>0){e._velocity=(o-r)/n}t.preventDefault()};var a=function(t){var i=e.getType();if(i===m.Light){return}if(e._bTouchNotMoved===false){t.preventDefault();var a=e.getDomRef("head");var s=50;var r=Math.abs(e._velocity/10);e._iInertiaIntervalId=window.setInterval(function(){e._velocity=e._velocity*.8;var t=e._velocity*s;a.scrollLeft=a.scrollLeft+t;if(Math.abs(e._velocity)<r){window.clearInterval(e._iInertiaIntervalId);e._iInertiaIntervalId=undefined}},s)}else if(e._bTouchNotMoved===true){e.onclick(t);t.preventDefault()}e._bTouchNotMoved=undefined;e._lastMoveTime=undefined};this.addEventDelegate({ontouchstart:t},this);this.addEventDelegate({ontouchend:a},this);this.addEventDelegate({ontouchmove:i},this)};return y});