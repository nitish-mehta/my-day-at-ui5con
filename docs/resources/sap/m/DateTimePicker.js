/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./DatePicker","sap/ui/model/type/Date","sap/ui/unified/DateRange","./library","sap/ui/core/Control","sap/ui/Device","sap/ui/core/format/DateFormat","sap/ui/core/LocaleData","./DateTimePickerRenderer","jquery.sap.keycodes"],function(e,t,i,s,a,o,r,n,p,l){"use strict";var u=a.PlacementType;var h=t.extend("sap.m.DateTimePicker",{metadata:{library:"sap.m",properties:{minutesStep:{type:"int",group:"Misc",defaultValue:1},secondsStep:{type:"int",group:"Misc",defaultValue:1}},aggregations:{_popup:{type:"sap.m.ResponsivePopover",multiple:false,visibility:"hidden"}},designtime:"sap/m/designtime/DateTimePicker.designtime"}});var d=o.extend("DateTimePickerPopup",{metadata:{aggregations:{_switcher:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},calendar:{type:"sap.ui.core.Control",multiple:false},timeSliders:{type:"sap.ui.core.Control",multiple:false}}},renderer:function(e,t){e.write("<div");e.writeControlData(t);e.addClass("sapMDateTimePopupCont");e.addClass("sapMTimePickerDropDown");e.writeClasses();e.write(">");var i=t.getAggregation("_switcher");if(i&&i.getVisible()){e.write("<div");e.addClass("sapMTimePickerSwitch");e.writeClasses();e.write(">");e.renderControl(i);e.write("</div>")}var s=t.getCalendar();if(s){e.renderControl(s)}e.write("<div");e.addClass("sapMTimePickerSep");e.writeClasses();e.write(">");e.write("</div>");var a=t.getTimeSliders();if(a){e.renderControl(a)}e.write("</div>")},init:function(){},onBeforeRendering:function(){var t=this.getAggregation("_switcher");if(r.system.phone||e("html").hasClass("sapUiMedia-Std-Phone")){if(!t){var i=sap.ui.getCore().getLibraryResourceBundle("sap.m");var s=i.getText("DATETIMEPICKER_DATE");var a=i.getText("DATETIMEPICKER_TIME");t=new sap.m.SegmentedButton(this.getId()+"-Switch",{selectedKey:"Cal",items:[new sap.m.SegmentedButtonItem(this.getId()+"-Switch-Cal",{key:"Cal",text:s}),new sap.m.SegmentedButtonItem(this.getId()+"-Switch-Sli",{key:"Sli",text:a})]});t.attachSelect(this._handleSelect,this);this.setAggregation("_switcher",t,true)}else{t.setVisible(true);t.setSelectedKey("Cal")}}else if(t){t.setVisible(false)}},onAfterRendering:function(){if(r.system.phone||e("html").hasClass("sapUiMedia-Std-Phone")){var t=this.getAggregation("_switcher");var i=t.getSelectedKey();this._switchVisibility(i)}},_handleSelect:function(e){this._switchVisibility(e.getParameter("key"))},_switchVisibility:function(e){var t=this.getCalendar();var i=this.getTimeSliders();if(!t||!i){return}if(e=="Cal"){t.$().css("display","");i.$().css("display","none")}else{t.$().css("display","none");i.$().css("display","");i._updateSlidersValues();i._onOrientationChanged();i.openFirstSlider()}},switchToTime:function(){var e=this.getAggregation("_switcher");if(e&&e.getVisible()){e.setSelectedKey("Sli");this._switchVisibility("Sli")}},getSpecialDates:function(){return this._oDateTimePicker.getSpecialDates()}});h.prototype.init=function(){t.prototype.init.apply(this,arguments);this._bOnlyCalendar=false};h.prototype.exit=function(){t.prototype.exit.apply(this,arguments);if(this._oSliders){this._oSliders.destroy();delete this._oSliders}this._oPopupContent=undefined};h.prototype.setDisplayFormat=function(e){t.prototype.setDisplayFormat.apply(this,arguments);if(this._oSliders){this._oSliders.setDisplayFormat(y.call(this))}return this};h.prototype.setMinutesStep=function(e){this.setProperty("minutesStep",e,true);if(this._oSliders){this._oSliders.setMinutesStep(e)}return this};h.prototype.setMinDate=function(e){t.prototype.setMinDate.call(this,e);if(e){this._oMinDate.setHours(e.getHours(),e.getMinutes(),e.getSeconds())}return this};h.prototype.setMaxDate=function(e){t.prototype.setMaxDate.call(this,e);if(e){this._oMaxDate.setHours(e.getHours(),e.getMinutes(),e.getSeconds())}return this};h.prototype.setSecondsStep=function(e){this.setProperty("secondsStep",e,true);if(this._oSliders){this._oSliders.setSecondsStep(e)}return this};h.prototype._getFormatInstance=function(t,i){var s=e.extend({},t);var a=-1;if(s.style){a=s.style.indexOf("/")}if(i){var o=e.extend({},s);if(a>0){o.style=o.style.substr(0,a)}this._oDisplayFormatDate=n.getInstance(o)}return n.getDateTimeInstance(s)};h.prototype._checkStyle=function(e){if(t.prototype._checkStyle.apply(this,arguments)){return true}else if(e.indexOf("/")>0){var i=["short","medium","long","full"];var s=false;for(var a=0;a<i.length;a++){var o=i[a];for(var r=0;r<i.length;r++){var n=i[r];if(e==o+"/"+n){s=true;break}}if(s){break}}return s}return false};h.prototype._parseValue=function(e,i){var s=t.prototype._parseValue.apply(this,arguments);if(i&&!s){s=this._oDisplayFormatDate.parse(e);if(s){var a=this.getDateValue();if(!a){a=new Date}s.setHours(a.getHours());s.setMinutes(a.getMinutes());s.setSeconds(a.getSeconds());s.setMilliseconds(a.getMilliseconds())}}return s};h.prototype._getLocaleBasedPattern=function(e){var t=p.getInstance(sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale()),i=e.indexOf("/");if(i>0){return t.getCombinedDateTimePattern(e.substr(0,i),e.substr(i+1))}else{return t.getCombinedDateTimePattern(e,e)}};h.prototype._createPopup=function(){if(!this._oPopup){var t=sap.ui.getCore().getLibraryResourceBundle("sap.m");var i=t.getText("TIMEPICKER_SET");var s=t.getText("TIMEPICKER_CANCEL");this._oPopupContent=new d(this.getId()+"-PC");this._oPopupContent._oDateTimePicker=this;this._oPopup=new sap.m.ResponsivePopover(this.getId()+"-RP",{showCloseButton:false,showHeader:false,placement:u.VerticalPreferedBottom,beginButton:new sap.m.Button(this.getId()+"-OK",{text:i,press:e.proxy(c,this)}),endButton:new sap.m.Button(this.getId()+"-Cancel",{text:s,press:e.proxy(g,this)}),content:this._oPopupContent});this._oPopup.addStyleClass("sapMDateTimePopup");var a=this._oPopup.getAggregation("_popup");if(a.setShowArrow){a.setShowArrow(false)}this._oPopup.attachAfterOpen(f,this);this._oPopup.attachAfterClose(_,this);if(r.system.desktop){this._oPopoverKeydownEventDelegate={onkeydown:function(t){var i=e.sap.KeyCodes,s=t.which||t.keyCode,a=t.altKey;if(a&&(s===i.ARROW_UP||s===i.ARROW_DOWN)||s===i.F4){c.call(this,t);this.focus();t.preventDefault()}}};this._oPopup.addEventDelegate(this._oPopoverKeydownEventDelegate,this)}this.setAggregation("_popup",this._oPopup,true)}};h.prototype._openPopup=function(){if(!this._oPopup){return}this._storeInputSelection(this._$input.get(0));var t=this._oPopup.getAggregation("_popup");t.oPopup.setAutoCloseAreas([this.getDomRef()]);this._oPopup.openBy(this);var i=this._oPopup.getContent()[0]&&this._oPopup.getContent()[0].getTimeSliders();if(i){e.sap.delayedCall(0,i,i._updateSlidersValues)}};h.prototype._createPopupContent=function(){var i=!this._oCalendar;t.prototype._createPopupContent.apply(this,arguments);if(i){this._oPopupContent.setCalendar(this._oCalendar);this._oCalendar.attachSelect(m,this);var a=this,o=this._oCalendar._hideMonthPicker,r=this._oCalendar._hideYearPicker;this._oCalendar._hideMonthPicker=function(e){o.apply(this,arguments);if(!e){a._selectFocusedDateValue((new s).setStartDate(this._getFocusedDate().toLocalJSDate()))}};this._oCalendar._hideYearPicker=function(e){r.apply(this,arguments);if(!e){a._selectFocusedDateValue((new s).setStartDate(this._getFocusedDate().toLocalJSDate()))}}}if(!this._oSliders){e.sap.require("sap.m.TimePickerSliders");this._oSliders=new sap.m.TimePickerSliders(this.getId()+"-Sliders",{minutesStep:this.getMinutesStep(),secondsStep:this.getSecondsStep(),displayFormat:y.call(this),localeId:this.getLocaleId()})._setShouldOpenSliderAfterRendering(true);this._oPopupContent.setTimeSliders(this._oSliders)}};h.prototype._selectFocusedDateValue=function(e){var t=this._oCalendar;t.removeAllSelectedDates();t.addSelectedDate(e);return this};h.prototype._fillDateRange=function(){var e=this.getDateValue();if(e){e=new Date(e.getTime())}else{e=this._getInitialFocusedDateValue();var t=this._oMaxDate.getTime()+864e5;if(e.getTime()<this._oMinDate.getTime()||e.getTime()>t){e=this._oMinDate}}this._oCalendar.focusDate(e);if(!this._oDateRange.getStartDate()||this._oDateRange.getStartDate().getTime()!=e.getTime()){this._oDateRange.setStartDate(e)}this._oSliders._setTimeValues(e)};h.prototype._getSelectedDate=function(){var e=t.prototype._getSelectedDate.apply(this,arguments);if(e){var i=this._oSliders.getTimeValues();var s=this._oSliders._getDisplayFormatPattern();if(s.search("h")>=0||s.search("H")>=0){e.setHours(i.getHours())}if(s.search("m")>=0){e.setMinutes(i.getMinutes())}if(s.search("s")>=0){e.setSeconds(i.getSeconds())}if(e.getTime()<this._oMinDate.getTime()){e=new Date(this._oMinDate.getTime())}else if(e.getTime()>this._oMaxDate.getTime()){e=new Date(this._oMaxDate.getTime())}}return e};h.prototype._getInitialFocusedDateValue=function(){return this.getInitialFocusedDateValue()||new Date};h.prototype.getLocaleId=function(){return sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString()};h.prototype.getAccessibilityInfo=function(){var e=t.prototype.getAccessibilityInfo.apply(this,arguments);e.type=sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_DATETIMEINPUT");return e};function c(e){this._selectDate()}function g(e){this.onsaphide(e);this._oCalendar.removeAllSelectedDates();this._oCalendar.addSelectedDate((new s).setStartDate(this._getInitialFocusedDateValue()))}function f(e){this.$("inner").attr("aria-expanded",true);this._oCalendar.focus();this._oSliders._onOrientationChanged()}function _(){this.$("inner").attr("aria-expanded",false);this._restoreInputSelection(this._$input.get(0))}function y(){var e=this.getDisplayFormat();var t;var s=this.getBinding("value");if(s&&s.oType&&s.oType instanceof i){e=s.oType.getOutputPattern()}else if(s&&s.oType&&s.oType.oFormat){e=s.oType.oFormat.oFormatOptions.pattern}else{e=this.getDisplayFormat()}if(!e){e="medium"}var a=e.indexOf("/");if(a>0&&this._checkStyle(e)){e=e.substr(a+1)}if(e=="short"||e=="medium"||e=="long"||e=="full"){var o=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var r=p.getInstance(o);t=r.getTimePattern(e)}else{t=e}return t}function m(e){this._oPopupContent.switchToTime()}return h});