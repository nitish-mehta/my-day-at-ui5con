/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/m/Text","sap/ui/core/HTML","sap/ui/core/Icon","sap/ui/core/IconPool","sap/m/Button","sap/m/GenericTileRenderer","sap/m/GenericTileLineModeRenderer","sap/ui/Device","sap/ui/core/ResizeHandler","jquery.sap.events"],function(e,t,i,o,s,a,n,r,l,h,d,p){"use strict";var u=t.GenericTileScope,g=t.LoadState,c=t.FrameType,f=t.Size,_=t.GenericTileMode,T=t.TileSizeBehavior;var m="GenericTileDeviceSet";var y=i.extend("sap.m.GenericTile",{metadata:{library:"sap.m",properties:{mode:{type:"sap.m.GenericTileMode",group:"Appearance",defaultValue:_.ContentMode},header:{type:"string",group:"Appearance",defaultValue:null},subheader:{type:"string",group:"Appearance",defaultValue:null},failedText:{type:"string",group:"Appearance",defaultValue:null},size:{type:"sap.m.Size",group:"Misc",defaultValue:f.Auto},frameType:{type:"sap.m.FrameType",group:"Misc",defaultValue:c.OneByOne},backgroundImage:{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},headerImage:{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},state:{type:"sap.m.LoadState",group:"Misc",defaultValue:g.Loaded},imageDescription:{type:"string",group:"Accessibility",defaultValue:null},scope:{type:"sap.m.GenericTileScope",group:"Misc",defaultValue:u.Display},sizeBehavior:{type:"sap.m.TileSizeBehavior",defaultValue:T.Responsive},ariaLabel:{type:"string",group:"Accessibility",defaultValue:null}},defaultAggregation:"tileContent",aggregations:{tileContent:{type:"sap.m.TileContent",multiple:true,bindable:"bindable"},icon:{type:"sap.ui.core.Control",multiple:false},_titleText:{type:"sap.m.Text",multiple:false,visibility:"hidden"},_failedMessageText:{type:"sap.m.Text",multiple:false,visibility:"hidden"}},events:{press:{parameters:{scope:{type:"sap.m.GenericTileScope"},action:{type:"string"},domRef:{type:"any"}}}}},renderer:function(e,i){if(i.getMode()===t.GenericTileMode.LineMode){h.render(e,i)}else{l.render(e,i)}}});y._Action={Press:"Press",Remove:"Remove"};y.LINEMODE_SIBLING_PROPERTIES=["state","subheader","header","scope"];y.prototype.init=function(){this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.m");if(!d.media.hasRangeSet(m)){d.media.initRangeSet(m,[450],"px",["small","large"])}this._oTitle=new o(this.getId()+"-title");this._oTitle.addStyleClass("sapMGTTitle");this._oTitle.cacheLineHeight=false;this.setAggregation("_titleText",this._oTitle,true);this._sFailedToLoad=this._oRb.getText("INFOTILE_CANNOT_LOAD_TILE");this._sLoading=this._oRb.getText("INFOTILE_LOADING");this._oFailedText=new o(this.getId()+"-failed-txt",{maxLines:2});this._oFailedText.cacheLineHeight=false;this._oFailedText.addStyleClass("sapMGTFailed");this.setAggregation("_failedMessageText",this._oFailedText,true);this._oWarningIcon=new a(this.getId()+"-warn-icon",{src:"sap-icon://notification",size:"1.375rem"});this._oWarningIcon.addStyleClass("sapMGTFtrFldIcnMrk");this._oBusy=new s(this.getId()+"-overlay");this._oBusy.setBusyIndicatorDelay(0);this._bTilePress=true;this._bThemeApplied=true;if(!sap.ui.getCore().isInitialized()){this._bThemeApplied=false;sap.ui.getCore().attachInit(this._handleCoreInitialized.bind(this))}else{this._handleCoreInitialized()}};y.prototype._handleCoreInitialized=function(){this._bThemeApplied=sap.ui.getCore().isThemeApplied();if(!this._bThemeApplied){sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this)}};y.prototype._handleThemeApplied=function(){this._bThemeApplied=true;this._oTitle.clampHeight();sap.ui.getCore().detachThemeChanged(this._handleThemeApplied,this)};y.prototype._initScopeContent=function(e){switch(this.getScope()){case t.GenericTileScope.Actions:if(this.getState&&this.getState()===t.LoadState.Disabled){break}this._oMoreIcon=this._oMoreIcon||n.createControlByURI({id:this.getId()+"-action-more",size:"1rem",useIconTooltip:false,src:"sap-icon://overflow"}).addStyleClass("sapMPointer").addStyleClass(e+"MoreIcon");this._oRemoveButton=this._oRemoveButton||new r({id:this.getId()+"-action-remove",icon:"sap-icon://decline",tooltip:this._oRb.getText("GENERICTILE_REMOVEBUTTON_TEXT")}).addStyleClass("sapUiSizeCompact").addStyleClass(e+"RemoveButton");this._oRemoveButton._bExcludeFromTabChain=true;break;default:}};y.prototype.exit=function(){if(this._sParentResizeListenerId){p.deregister(this._sResizeListenerId);this._sParentResizeListenerId=null}d.media.detachHandler(this._handleMediaChange,this,m);if(this._$RootNode){this._$RootNode.off(this._getAnimationEvents());this._$RootNode=null}this._clearAnimationUpdateQueue();this._oWarningIcon.destroy();if(this._oImage){this._oImage.destroy()}this._oBusy.destroy();if(this._oMoreIcon){this._oMoreIcon.destroy()}if(this._oRemoveButton){this._oRemoveButton.destroy()}};y.prototype.onBeforeRendering=function(){var e=!!this.getSubheader();if(this.getMode()===t.GenericTileMode.HeaderMode){this._applyHeaderMode(e)}else{this._applyContentMode(e)}var i=this.getTileContent().length;for(var o=0;o<i;o++){this.getTileContent()[o].setDisabled(this.getState()===t.LoadState.Disabled)}this._initScopeContent("sapMGT");this._generateFailedText();this.$().unbind("mouseenter",this._updateAriaAndTitle);this.$().unbind("mouseleave",this._removeTooltipFromControl);if(this._sParentResizeListenerId){p.deregister(this._sResizeListenerId);this._sParentResizeListenerId=null}d.media.detachHandler(this._handleMediaChange,this,m);if(this._$RootNode){this._$RootNode.off(this._getAnimationEvents())}if(this.getFrameType()===t.FrameType.Auto){this.setProperty("frameType",t.FrameType.OneByOne,true)}};y.prototype.onAfterRendering=function(){this._setupResizeClassHandler();this.$().bind("mouseenter",this._updateAriaAndTitle.bind(this));this.$().bind("mouseleave",this._removeTooltipFromControl.bind(this));var e=this.getMode();if(e===t.GenericTileMode.LineMode&&this._isScreenLarge()){this.$().parent().addClass("sapMGTLineModeContainer");this._updateHoverStyle(true);if(this.getParent()instanceof i){this._sParentResizeListenerId=p.register(this.getParent(),this._handleResize.bind(this))}else{this._sParentResizeListenerId=p.register(this.$().parent(),this._handleResize.bind(this))}}if(e===t.GenericTileMode.LineMode&&this._bUpdateLineTileSiblings){this._updateLineTileSiblings();this._bUpdateLineTileSiblings=false}if(e===t.GenericTileMode.LineMode){d.media.attachHandler(this._handleMediaChange,this,m)}};y.prototype._handleResize=function(){if(this.getMode()===t.GenericTileMode.LineMode&&this._isScreenLarge()&&this.getParent()){this._queueAnimationEnd()}};y.prototype._setupResizeClassHandler=function(){var t=function(){if(this.getSizeBehavior()===T.Small||window.matchMedia("(max-width: 374px)").matches){this.$().addClass("sapMTileSmallPhone")}else{this.$().removeClass("sapMTileSmallPhone")}}.bind(this);e(window).resize(t);t()};y.prototype._isCompact=function(){return e("body").hasClass("sapUiSizeCompact")||this.$().is(".sapUiSizeCompact")||this.$().closest(".sapUiSizeCompact").length>0};y.prototype._calculateStyleData=function(){this.$("lineBreak").remove();if(!this._isScreenLarge()||!this.getDomRef()||this.$().is(":hidden")){return null}var t=this.$(),i=this.$("endMarker"),o=this.$("startMarker");if(i.length===0||o.length===0){return null}var s=this._getLineCount(),a,n,r=Math.ceil(h._getCSSPixelValue(this,"margin-top")),l,p=this.$().parent().innerWidth(),u=Math.ceil(h._getCSSPixelValue(this,"min-height")),g=h._getCSSPixelValue(this,"line-height"),c=this.$().is(":not(:first-child)")&&s>1,f=e("<span><br /></span>"),_=0,T=sap.ui.getCore().getConfiguration().getRTL(),m=i.position();if(c){f.attr("id",this.getId()+"-lineBreak");t.prepend(f);s=this._getLineCount();m=i.position()}var y={rtl:T,lineBreak:c,startOffset:o.offset(),endOffset:i.offset(),availableWidth:p,lines:[]};var v;if(d.browser.msie||d.browser.edge){v=f.find("br").position()}else{v=f.position()}var S=v;if(!(d.browser.mozilla||d.browser.msie||d.browser.edge)&&v.left<m.left){S=m}y.positionLeft=c?v.left:t.position().left;y.positionRight=c?t.width()-S.left:y.availableWidth-t.position().left;if(!c&&s>1){y.positionRight=o.parent().innerWidth()-(o.position().left+o.width())}for(_;_<s;_++){if(c&&_===0){continue}if(s===1){a=T?y.availableWidth-y.positionLeft:y.positionLeft;l=t.width()}else if(_===s-1){a=0;l=T?t.width()-m.left:m.left}else if(c&&_===1){a=0;l=p}else{a=0;l=p}n=_*g+r;y.lines.push({offset:{x:a,y:n},width:l,height:u})}return y};y.prototype._getStyleData=function(){var t=this._calculateStyleData();if(!e.sap.equal(this._oStyleData,t)){delete this._oStyleData;this._oStyleData=t;return true}return false};y.prototype._getAnimationEvents=function(){return"transitionend.sapMGT$id animationend.sapMGT$id".replace(/\$id/g,e.sap.camelCase(this.getId()))};y.prototype._updateHoverStyle=function(t){if(!this._getStyleData()&&!t){return}this._clearAnimationUpdateQueue();this._cHoverStyleUpdates=-1;this._oAnimationEndCallIds={};if(this._oStyleData&&this._oStyleData.lineBreak&&this.getUIArea()){this._$RootNode=e(this.getUIArea().getRootNode());this._$RootNode.on(this._getAnimationEvents(),this._queueAnimationEnd.bind(this))}this._queueAnimationEnd()};y.prototype._queueAnimationEnd=function(t){if(t){var i=e(t.target);if(i.is(".sapMGT, .sapMGT *")){return false}}if(typeof this._cHoverStyleUpdates!=="number"){this._cHoverStyleUpdates=-1}if(!this._oAnimationEndCallIds){this._oAnimationEndCallIds={}}this._cHoverStyleUpdates++;this._oAnimationEndCallIds[this._cHoverStyleUpdates]=e.sap.delayedCall(10,this,this._handleAnimationEnd,[this._cHoverStyleUpdates])};y.prototype._handleAnimationEnd=function(e){delete this._oAnimationEndCallIds[e];if(this._cHoverStyleUpdates===e){this._getStyleData();h._updateHoverStyle.call(this)}};y.prototype._clearAnimationUpdateQueue=function(){for(var t in this._oAnimationEndCallIds){e.sap.clearDelayedCall(this._oAnimationEndCallIds[t]);delete this._oAnimationEndCallIds[t]}};y.prototype._getLineCount=function(){var e=this.getDomRef().getBoundingClientRect(),t=h._getCSSPixelValue(this,"line-height");return Math.round(e.height/t)};y.prototype.getBoundingRects=function(){var i=this.$().offset();if(this.getMode()===t.GenericTileMode.LineMode&&this._isScreenLarge()){this._getStyleData();var o=[],s,a;this.$().find(".sapMGTLineStyleHelper").each(function(){s=e(this);a=s.offset();o.push({offset:{x:a.left,y:a.top},width:s.width(),height:s.height()})});return o}else{return[{offset:{x:i.left,y:i.top},width:this.$().width(),height:this.$().height()}]}};y.prototype._updateLineTileSiblings=function(){var e=this.getParent();if(this.getMode()===t.GenericTileMode.LineMode&&this._isScreenLarge()&&e){var i=e.indexOfAggregation(this.sParentAggregationName,this);var o=e.getAggregation(this.sParentAggregationName).splice(i+1);for(i=0;i<o.length;i++){var s=o[i];if(s instanceof t.GenericTile&&s.getMode()===t.GenericTileMode.LineMode){s._updateHoverStyle()}}}};y.prototype.ontouchstart=function(){if(this.$("hover-overlay").length>0){this.$("hover-overlay").addClass("sapMGTPressActive")}if(this.getMode()===t.GenericTileMode.LineMode){this.addStyleClass("sapMGTLineModePress")}if(d.browser.internet_explorer&&this.getState()!==t.LoadState.Disabled){this.$().focus()}};y.prototype.ontouchcancel=function(){if(this.$("hover-overlay").length>0){this.$("hover-overlay").removeClass("sapMGTPressActive")}};y.prototype.ontouchend=function(){if(this.$("hover-overlay").length>0){this.$("hover-overlay").removeClass("sapMGTPressActive")}if(this.getMode()===t.GenericTileMode.LineMode){this.removeStyleClass("sapMGTLineModePress")}if(d.browser.internet_explorer&&this.getState()!==t.LoadState.Disabled){this.$().focus()}};y.prototype.ontap=function(e){var i;if(this._bTilePress&&this.getState()!==t.LoadState.Disabled){this.$().focus();i=this._getEventParams(e);this.firePress(i);e.preventDefault()}};y.prototype.onkeydown=function(i){if(e.sap.PseudoEvents.sapselect.fnCheck(i)&&this.getState()!==t.LoadState.Disabled){if(this.$("hover-overlay").length>0){this.$("hover-overlay").addClass("sapMGTPressActive")}i.preventDefault()}};y.prototype._updateAriaLabel=function(){var e=this._getAriaText(),t=this.$(),i=false;if(t.attr("aria-label")!==e){t.attr("aria-label",e);i=true}return i};y.prototype.onkeyup=function(i){var o,s=false,a=this.getScope(),n=a===t.GenericTileScope.Actions;if(n&&(e.sap.PseudoEvents.sapdelete.fnCheck(i)||e.sap.PseudoEvents.sapbackspace.fnCheck(i))){o={scope:a,action:y._Action.Remove,domRef:this._oRemoveButton.getPopupAnchorDomRef()};s=true}if(e.sap.PseudoEvents.sapselect.fnCheck(i)&&this.getState()!==t.LoadState.Disabled){if(this.$("hover-overlay").length>0){this.$("hover-overlay").removeClass("sapMGTPressActive")}o=this._getEventParams(i);s=true}if(s){this.firePress(o);i.preventDefault()}this._updateAriaLabel()};y.prototype.setProperty=function(e){i.prototype.setProperty.apply(this,arguments);if(this.getMode()===t.GenericTileMode.LineMode&&y.LINEMODE_SIBLING_PROPERTIES.indexOf(e)!==-1){this._bUpdateLineTileSiblings=true}return this};y.prototype.getHeader=function(){return this._oTitle.getText()};y.prototype.setHeader=function(e){this._oTitle.setText(e);return this};y.prototype.setHeaderImage=function(i){var o=!e.sap.equal(this.getHeaderImage(),i);if(o){if(this._oImage){this._oImage.destroy();this._oImage=undefined}if(i){this._oImage=n.createControlByURI({id:this.getId()+"-icon-image",src:i},t.Image);this._oImage.addStyleClass("sapMGTHdrIconImage")}}return this.setProperty("headerImage",i)};y.prototype._applyHeaderMode=function(e){if(e){this._oTitle.setMaxLines(4)}else{this._oTitle.setMaxLines(5)}this._changeTileContentContentVisibility(false)};y.prototype._applyContentMode=function(e){if(e){this._oTitle.setMaxLines(2)}else{this._oTitle.setMaxLines(3)}this._changeTileContentContentVisibility(true)};y.prototype._changeTileContentContentVisibility=function(e){var t;t=this.getTileContent();for(var i=0;i<t.length;i++){t[i].setRenderContent(e)}};y.prototype._getHeaderAriaAndTooltipText=function(){var e="";var t=true;if(this.getHeader()){e+=this.getHeader();t=false}if(this.getSubheader()){e+=(t?"":"\n")+this.getSubheader();t=false}if(this.getImageDescription()){e+=(t?"":"\n")+this.getImageDescription()}return e};y.prototype._getContentAriaAndTooltipText=function(){var t="";var i=true;var o=this.getTileContent();for(var s=0;s<o.length;s++){if(e.isFunction(o[s]._getAriaAndTooltipText)){t+=(i?"":"\n")+o[s]._getAriaAndTooltipText()}else if(o[s].getTooltip_AsString()){t+=(i?"":"\n")+o[s].getTooltip_AsString()}i=false}return t};y.prototype._getAriaAndTooltipText=function(){var i=this.getTooltip_AsString()&&!this._isTooltipSuppressed()?this.getTooltip_AsString():this._getHeaderAriaAndTooltipText()+"\n"+this._getContentAriaAndTooltipText();switch(this.getState()){case t.LoadState.Disabled:return"";case t.LoadState.Loading:return i+"\n"+this._sLoading;case t.LoadState.Failed:return i+"\n"+this._oFailedText.getText();default:if(e.trim(i).length===0){return""}else{return i}}};y.prototype._getAriaText=function(){var e=this.getTooltip_Text();var i=this.getAriaLabel();if(!e||this._isTooltipSuppressed()){e=this._getAriaAndTooltipText()}if(this.getScope()===t.GenericTileScope.Actions){e=this._oRb.getText("GENERICTILE_ACTIONS_ARIA_TEXT")+" "+e}if(i){e=i+" "+e}return e};y.prototype._getTooltipText=function(){var e=this.getTooltip_Text();if(this._isTooltipSuppressed()===true){e=null}return e};y.prototype._checkFooter=function(e,i){var o=i.getState();var s=this.getScope()===t.GenericTileScope.Actions||this._bShowActionsView===true;if(o===t.LoadState.Failed||s&&o!==t.LoadState.Disabled){e.setRenderFooter(false)}else{e.setRenderFooter(true)}};y.prototype._generateFailedText=function(){var e=this.getFailedText();var t=e?e:this._sFailedToLoad;this._oFailedText.setText(t);this._oFailedText.setTooltip(t)};y.prototype._isTooltipSuppressed=function(){var t=this.getTooltip_Text();if(t&&t.length>0&&e.trim(t).length===0){return true}else{return false}};y.prototype._isHeaderTextTruncated=function(){var e,i,o,s;if(this.getMode()===t.GenericTileMode.LineMode){o=this.$("hdr-text");if(o.length>0){s=Math.ceil(o[0].getBoundingClientRect().width);return o[0]&&s<o[0].scrollWidth}else{return false}}else{e=this.getAggregation("_titleText").getDomRef("inner");i=this.getAggregation("_titleText").getClampHeight(e);return i<e.scrollHeight}};y.prototype._isSubheaderTextTruncated=function(){var e=this.$("subHdr-text"),t;if(e.length>0){t=Math.ceil(e[0].getBoundingClientRect().width);return e[0]&&t<e[0].scrollWidth}else{return false}};y.prototype._setTooltipFromControl=function(){var e,i="";var o=true;var s=this.getTileContent();if(this._isHeaderTextTruncated()){i=this._oTitle.getText();o=false}if(this._isSubheaderTextTruncated()){i+=(o?"":"\n")+this.getSubheader();o=false}if(this.getScope()!==t.GenericTileScope.Actions){for(var a=0;a<s.length;a++){e=s[a].getContent();if(e&&e.getMetadata().getLibraryName()==="sap.suite.ui.microchart"){i+=(o?"":"\n")+e.getTooltip_AsString()}o=false}}if(i&&!this._getTooltipText()&&!this._isTooltipSuppressed()){this.$().attr("title",i);this._bTooltipFromControl=true}};y.prototype._updateAriaAndTitle=function(){var e=this._getAriaAndTooltipText();var i=this._getAriaText();var o=this.$();if(o.attr("title")!==e){o.attr("aria-label",i)}if(this.getScope()===t.GenericTileScope.Actions){o.find("*:not(.sapMGTRemoveButton)").removeAttr("aria-label").removeAttr("title").unbind("mouseenter")}else{o.find("*").removeAttr("aria-label").removeAttr("title").unbind("mouseenter")}this._setTooltipFromControl()};y.prototype._removeTooltipFromControl=function(){if(this._bTooltipFromControl){this.$().removeAttr("title");this._bTooltipFromControl=false}};y.prototype._isScreenLarge=function(){return this._getCurrentMediaContainerRange(m).name==="large"};y.prototype._getEventParams=function(e){var i,o=y._Action.Press,s=this.getScope(),a=this.getDomRef();if(s===t.GenericTileScope.Actions&&e.target.id.indexOf("-action-remove")>-1){o=y._Action.Remove;a=this._oRemoveButton.getPopupAnchorDomRef()}else if(s===t.GenericTileScope.Actions){a=this._oMoreIcon.getDomRef()}i={scope:s,action:o,domRef:a};return i};y.prototype._handleMediaChange=function(){this._bUpdateLineTileSiblings=true;this.invalidate()};y.prototype.setPressEnabled=function(e){this._bTilePress=e};y.prototype.showActionsView=function(e){if(this._bShowActionsView!==e){this._bShowActionsView=e;this.invalidate()}};return y});