/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./InputBase","./Text","sap/ui/core/ResizeHandler","./library","sap/ui/core/library","sap/ui/Device","./TextAreaRenderer"],function(e,t,i,o,s,r,a,n){"use strict";var h=r.Wrapping;var g=t.extend("sap.m.TextArea",{metadata:{library:"sap.m",designtime:"sap/m/designtime/TextArea.designtime",properties:{rows:{type:"int",group:"Appearance",defaultValue:2},cols:{type:"int",group:"Appearance",defaultValue:20},height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:null},maxLength:{type:"int",group:"Behavior",defaultValue:0},showExceededText:{type:"boolean",group:"Behavior",defaultValue:false},wrapping:{type:"sap.ui.core.Wrapping",group:"Behavior",defaultValue:h.None},valueLiveUpdate:{type:"boolean",group:"Behavior",defaultValue:false},growing:{type:"boolean",group:"Behavior",defaultValue:false},growingMaxLines:{type:"int",group:"Behavior",defaultValue:0}},aggregations:{_counter:{type:"sap.m.Text",multiple:false,visibility:"hidden"}},events:{liveChange:{parameters:{value:{type:"string"}}}}}});g.prototype.init=function(){var e;t.prototype.init.call(this);this.sResizeListenerId=null;this._bPasteIsTriggered=false;e=new i(this.getId()+"-counter",{}).addStyleClass("sapMTextAreaCounter").setVisible(false);this.setAggregation("_counter",e)};g.prototype.setShowExceededText=function(e){var t=this.getAggregation("_counter"),i;if(e){if(this.getAriaLabelledBy().indexOf(t.getId())<0){this.addAriaLabelledBy(t.getId())}}else{t=this.getAggregation("_counter");t&&this.removeAriaLabelledBy(t.getId());i=this.getValue();if(this.getMaxLength()){i=i.substring(0,this.getMaxLength());this.setValue(i)}}t.setVisible(e);this.setProperty("showExceededText",e);this._updateMaxLengthAttribute();return this};g.prototype.exit=function(){t.prototype.exit.call(this);e(window).off("resize.sapMTextAreaGrowing");this._detachResizeHandler()};g.prototype.onBeforeRendering=function(){t.prototype.onBeforeRendering.call(this);var e=this.getAggregation("_counter");if((this.getMaxLength()<=0||!this.getShowExceededText())&&e.getVisible()){e.setVisible(false)}this._detachResizeHandler()};g.prototype.onAfterRendering=function(){t.prototype.onAfterRendering.call(this);var i=this.getFocusDomRef(),s,r;if(this.getGrowing()){this._sResizeListenerId=o.register(this,this._resizeHandler.bind(this));if(this.getGrowingMaxLines()>0){r=window.getComputedStyle(i);s=parseFloat(r.lineHeight)*this.getGrowingMaxLines()+parseFloat(r.paddingTop)+parseFloat(r.borderTopWidth)+parseFloat(r.borderBottomWidth);if(a.browser.firefox){s+=parseFloat(r.paddingBottom)}i.style.maxHeight=s+"px"}this._adjustHeight()}this._updateMaxLengthAttribute();if(!a.support.touch){return}var n=this.$("inner");if(this._behaviour.INSIDE_SCROLLABLE_WITHOUT_FOCUS){n.on("touchstart",e.proxy(this._onTouchStart,this));n.on("touchmove",e.proxy(this._onTouchMove,this))}else if(this._behaviour.PAGE_NON_SCROLLABLE_AFTER_FOCUS){n.on("touchmove",function(e){if(n.is(":focus")){e.stopPropagation()}})}};g.prototype._resizeHandler=function(e){this.getFocusDomRef().style.height="auto";this._adjustHeight()};g.prototype._detachResizeHandler=function(){if(this._sResizeListenerId){o.deregister(this._sResizeListenerId);this._sResizeListenerId=null}};g.prototype.onsapenter=function(e){e.setMarked()};g.prototype.onValueRevertedByEscape=function(e){if(this.getValueLiveUpdate()){this.setProperty("value",e,true);e=this.getValue()}this.fireLiveChange({value:e,newValue:e})};g.prototype.getValue=function(){var e=this.getFocusDomRef();return e?e.value:this.getProperty("value")};g.prototype.setValue=function(e){t.prototype.setValue.call(this,e);this._handleShowExceededText();if(this.getGrowing()){this._adjustHeight()}return this};g.prototype.onsapnext=function(e){e.setMarked()};g.prototype.onsapprevious=function(e){e.setMarked()};g.prototype.oninput=function(e){t.prototype.oninput.call(this,e);if(this._bPasteIsTriggered){this._bPasteIsTriggered=false;this._selectExceededText()}if(e.isMarked("invalid")){return}var i=this.getFocusDomRef(),o=i.value,s=this.getMaxLength();if(this.getShowExceededText()===false&&this._getInputValue().length<this.getMaxLength()){if(s>0&&o.length>s){o=o.substring(0,s);i.value=o}}if(this.getValueLiveUpdate()){this.setProperty("value",o,true);o=this.getValue()}this._handleShowExceededText();if(this.getGrowing()){this._adjustHeight()}this.fireLiveChange({value:o,newValue:o})};g.prototype.onpaste=function(e){if(this.getShowExceededText()){this._bPasteIsTriggered=true}};g.prototype.setGrowing=function(t){this.setProperty("growing",t);if(this.getGrowing()){e(window).on("resize.sapMTextAreaGrowing",this._updateOverflow.bind(this))}else{e(window).off("resize.sapMTextAreaGrowing")}return this};g.prototype._adjustHeight=function(){var e=this.getFocusDomRef(),t;if(!e){return}e.style.height="auto";t=e.scrollHeight+e.offsetHeight-e.clientHeight;if(this.getValue()&&t!==0){e.style.height=t+"px";this._updateOverflow()}};g.prototype._updateOverflow=function(){var e=this.getFocusDomRef(),t;if(e){t=parseFloat(window.getComputedStyle(e)["max-height"]);e.style.overflowY=e.scrollHeight>t?"auto":""}};g.prototype._getInputValue=function(e){e=e===undefined?this.$("inner").val()||"":e.toString();if(this.getMaxLength()>0&&!this.getShowExceededText()){e=e.substring(0,this.getMaxLength())}return e.replace(/\r\n/g,"\n")};g.prototype._selectExceededText=function(){var e=this.getValue().length;if(e>this.getMaxLength()){this.selectText(this.getMaxLength(),e)}};g.prototype._updateMaxLengthAttribute=function(){var e=this.getFocusDomRef();if(!e){return}if(this.getShowExceededText()){e.removeAttribute("maxlength");this._handleShowExceededText()}else{this.getMaxLength()&&e.setAttribute("maxlength",this.getMaxLength())}};g.prototype._handleShowExceededText=function(){var e=this.getAggregation("_counter"),t=this.getMaxLength(),i;if(!this.getDomRef()||!this.getShowExceededText()||!t){return}i=this._getCounterValue();e.setText(i)};g.prototype._maxLengthIsExceeded=function(e){var t=false;if(this.getMaxLength()>0&&this.getShowExceededText()&&this.getValue().length>this.getMaxLength()){t=true}return t};g.prototype._getCounterValue=function(){var e=sap.ui.getCore().getLibraryResourceBundle("sap.m"),t=this.getMaxLength()-this.getValue().length,i=t<0?true:false,o="TEXTAREA_CHARACTER"+(Math.abs(t)===1?"":"S")+"_"+(i?"EXCEEDED":"LEFT");return e.getText(o,[Math.abs(t)])};g.prototype._behaviour=function(e){return{INSIDE_SCROLLABLE_WITHOUT_FOCUS:e.os.ios||e.os.blackberry||e.browser.chrome,PAGE_NON_SCROLLABLE_AFTER_FOCUS:e.os.android&&e.os.version>=4.1}}(a);g.prototype._onTouchStart=function(e){var t=e.touches[0];this._iStartY=t.pageY;this._iStartX=t.pageX;this._bHorizontalScroll=undefined;e.setMarked("swipestartHandled")};g.prototype._onTouchMove=function(e){var t=this.getFocusDomRef(),i=e.touches[0].pageY,o=t.scrollTop,s=o<=0,r=o+t.clientHeight>=t.scrollHeight,a=this._iStartY>i,n=this._iStartY<i,h=s&&n||r&&a;if(this._bHorizontalScroll===undefined){this._bHorizontalScroll=Math.abs(this._iStartY-i)<Math.abs(this._iStartX-e.touches[0].pageX)}if(this._bHorizontalScroll||!h){e.setMarked()}};var u=a.os.windows_phone&&/MSAppHost/i.test(navigator.appVersion);g.prototype.onfocusin=function(i){var o,s=this.$();t.prototype.onfocusin.apply(this,arguments);function r(){e(window).scrollTop(0);o.scrollTop(s.offset().top-o.offset().top+o.scrollTop())}if(u&&s.height()+s.offset().top>260){for(o=s.parent();o[0];o=o.parent()){if(o.css("overflow-y")=="auto"){o.children().last().css("padding-bottom",e(window).height()+"px");window.setTimeout(r,100);return}}}};return g});