/*
 * ! UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./ColumnListItem","./P13nPanel","./SearchField","./Table","./library","sap/ui/core/library","sap/ui/model/ChangeReason","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode","sap/ui/core/ResizeHandler","sap/m/ScrollContainer","./P13nSelectionItem"],function(e,t,i,n,r,o,s,l,a,d,h,c){"use strict";var p=o.ToolbarDesign;var u=o.ListType;var g=o.ListMode;var m=o.P13nPanelType;var f=i.extend("sap.m.P13nSelectionPanel",{metadata:{library:"sap.m",aggregations:{selectionItems:{type:"sap.m.P13nSelectionItem",multiple:true,singularName:"selectionItem",bindable:"bindable"},content:{type:"sap.ui.core.Control",multiple:true,singularName:"content",visibility:"hidden"}},events:{changeSelectionItems:{parameters:{items:{type:"object[]"}}}}},renderer:function(e,t){e.write("<div");e.writeControlData(t);e.addClass("sapMP13nColumnsPanel");e.writeClasses();e.write(">");var i=t.getAggregation("content");if(i){i.forEach(function(t){e.renderControl(t)})}e.write("</div>")}});f.prototype.init=function(){this._iLiveChangeTimer=0;this._iSearchTimer=0;this._bIgnoreUpdateInternalModel=false;this._bUpdateInternalModel=true;this._bOnAfterRenderingFirstTimeExecuted=false;var e=new a({linkPressMap:{},items:[],countOfSelectedItems:0,countOfItems:0});e.setDefaultBindingMode(d.TwoWay);e.setSizeLimit(1e3);this.setModel(e,"$sapmP13nSelectionPanel");this.setType(m.selection);this._createTable();this._createToolbar();this.setVerticalScrolling(false);var t=new c({horizontal:false,vertical:true,content:[this._oTable],width:"100%",height:"100%"});this.addAggregation("content",t);var i=this;this._fnHandleResize=function(){var e=false,n,r;if(i.getParent){var o=null,s,l;var a=i.getParent();var d=i._getToolbar();if(a&&a.$){o=a.$("cont");if(o.children().length>0&&d.$().length>0){n=t.$()[0].clientHeight;s=o.children()[0].clientHeight;l=d?d.$()[0].clientHeight:0;r=s-l;if(n!==r){t.setHeight(r+"px");e=true}}}}return e};this._sContainerResizeListener=h.register(t,this._fnHandleResize)};f.prototype.onBeforeRendering=function(){this._updateInternalModel()};f.prototype.onAfterRendering=function(){var e=this;if(!this._bOnAfterRenderingFirstTimeExecuted){this._bOnAfterRenderingFirstTimeExecuted=true;window.clearTimeout(this._iLiveChangeTimer);this._iLiveChangeTimer=window.setTimeout(function(){e._fnHandleResize()},0)}};f.prototype.getOkPayload=function(){this._updateInternalModel();var e=this._getInternalModel().getProperty("/items");return{selectionItems:e.map(function(e){return{columnKey:e.columnKey,selected:e.persistentSelected}})}};f.prototype.exit=function(){h.deregister(this._sContainerResizeListener);this._sContainerResizeListener=null;this._getToolbar().destroy();this._oTable.destroy();this._oTable=null;if(this._getInternalModel()){this._getInternalModel().destroy()}window.clearTimeout(this._iLiveChangeTimer);window.clearTimeout(this._iSearchTimer)};f.prototype.addItem=function(e){if(!this._bIgnoreUpdateInternalModel){this._bUpdateInternalModel=true}this.addAggregation("items",e);return this};f.prototype.insertItem=function(e,t){if(!this._bIgnoreUpdateInternalModel){this._bUpdateInternalModel=true}this.insertAggregation("items",e,t);return this};f.prototype.removeItem=function(e){if(!this._bIgnoreUpdateInternalModel){this._bUpdateInternalModel=true}e=this.removeAggregation("items",e);return e};f.prototype.removeAllItems=function(){if(!this._bIgnoreUpdateInternalModel){this._bUpdateInternalModel=true}return this.removeAllAggregation("items")};f.prototype.destroyItems=function(){if(!this._bIgnoreUpdateInternalModel){this._bUpdateInternalModel=true}this.destroyAggregation("items");return this};f.prototype.addSelectionItem=function(e){if(!this._bIgnoreUpdateInternalModel){this._bUpdateInternalModel=true}this.addAggregation("selectionItems",e);return this};f.prototype.insertSelectionItem=function(e,t){if(!this._bIgnoreUpdateInternalModel){this._bUpdateInternalModel=true}this.insertAggregation("selectionItems",e,t);return this};f.prototype.updateSelectionItems=function(e){this.updateAggregation("selectionItems");if(e===l.Change&&!this._bIgnoreUpdateInternalModel){this._bUpdateInternalModel=true}};f.prototype.removeSelectionItem=function(e){if(!this._bIgnoreUpdateInternalModel){this._bUpdateInternalModel=true}return this.removeAggregation("selectionItems",e)};f.prototype.removeAllSelectionItems=function(){if(!this._bIgnoreUpdateInternalModel){this._bUpdateInternalModel=true}return this.removeAllAggregation("selectionItems")};f.prototype.destroySelectionItems=function(){if(!this._bIgnoreUpdateInternalModel){this._bUpdateInternalModel=true}this.destroyAggregation("selectionItems");return this};f.prototype.onBeforeNavigationFrom=function(){return true};f.prototype._notifyChange=function(){var e=this.getChangeNotifier();if(e){e(this)}};f.prototype._getInternalModel=function(){return this.getModel("$sapmP13nSelectionPanel")};f.prototype._createTable=function(){var i=this;this._oTable=new r({mode:g.MultiSelect,rememberSelections:false,selectionChange:e.proxy(this._onSelectionChange,this),columns:[new sap.m.Column({vAlign:s.VerticalAlign.Middle,header:new sap.m.Text({text:{parts:[{path:"/countOfSelectedItems"},{path:"/countOfItems"}],formatter:function(e,t){return sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("COLUMNSPANEL_SELECT_ALL_WITH_COUNTER",[e,t])}}})})],items:{path:"/items",templateShareable:false,template:new t({cells:new sap.m.VBox({items:[new sap.m.Link({href:"{href}",text:"{text}",target:"{target}",enabled:{path:"href",formatter:function(e){if(!e){this.addStyleClass("sapUiCompSmartLink")}return!!e}},press:function(e){var t=i._getInternalModel().getProperty("/linkPressMap")[this.getText()+"---"+this.getHref()];if(t){t(e)}}}),new sap.m.Text({visible:{path:"description",formatter:function(e){return!!e}},text:"{description}"})]}),visible:"{visible}",selected:"{persistentSelected}",tooltip:"{tooltip}",type:u.Active})}});this._oTable.setModel(this._getInternalModel())};f.prototype._createToolbar=function(){var t=this;var i=new sap.m.OverflowToolbar(this.getId()+"-toolbar",{design:p.Auto,content:[new sap.m.ToolbarSpacer,new n(this.getId()+"-searchField",{liveChange:function(e){var i=e.getSource().getValue(),n=i?300:0;window.clearTimeout(t._iSearchTimer);if(n){t._iSearchTimer=window.setTimeout(function(){t._onExecuteSearch()},n)}else{t._onExecuteSearch()}},search:e.proxy(this._onExecuteSearch,this),layoutData:new sap.m.OverflowToolbarLayoutData({minWidth:"12.5rem",maxWidth:"23.077rem",shrinkable:true,moveToOverflow:false,stayInOverflow:false})})]});i.setModel(this._getInternalModel());this.addAggregation("content",i)};f.prototype._onExecuteSearch=function(){this._switchVisibilityOfUnselectedModelItems();this._filterModelItemsBySearchText();this._updateControlLogic()};f.prototype._switchVisibilityOfUnselectedModelItems=function(){var e=this._isFilteredByShowSelected();var t=this._getInternalModel().getProperty("/items");t.forEach(function(t){if(t.persistentSelected){t.visible=true;return}t.visible=!e});this._getInternalModel().setProperty("/items",t)};f.prototype._getVisibleModelItems=function(){return this._getInternalModel().getProperty("/items").filter(function(e){return!!e.visible})};f.prototype._getModelItemByColumnKey=function(e){var t=this._getInternalModel().getProperty("/items").filter(function(t){return t.columnKey===e});return t[0]};f.prototype._updateCounts=function(e){var t=0;var i=0;e.forEach(function(e){t++;if(e.persistentSelected){i++}});this._getInternalModel().setProperty("/countOfItems",t);this._getInternalModel().setProperty("/countOfSelectedItems",i)};f.prototype._getToolbar=function(){return sap.ui.getCore().byId(this.getId()+"-toolbar")||null};f.prototype._getSearchField=function(){return sap.ui.getCore().byId(this.getId()+"-searchField")||null};f.prototype._getSearchText=function(){var e=this._getSearchField();return e?e.getValue():""};f.prototype._isFilteredBySearchText=function(){return!!this._getSearchText().length};f.prototype._isFilteredByShowSelected=function(){return false};f.prototype._updateControlLogic=function(){var e=this._isFilteredBySearchText();var t=this._isFilteredByShowSelected();var i=sap.ui.getCore().byId(this._oTable.getId()+"-sa");if(i){i.setEnabled(!e&&!t)}};f.prototype._fireChangeSelectionItems=function(){this._bIgnoreUpdateInternalModel=true;var e=this._getInternalModel().getProperty("/items");this.fireChangeSelectionItems({items:e.map(function(e){return{columnKey:e.columnKey,selected:e.persistentSelected}})});this._bIgnoreUpdateInternalModel=false};f.prototype._onSelectionChange=function(){this._selectTableItem()};f.prototype._selectTableItem=function(){var e=this._getInternalModel().getProperty("/items");this._updateCounts(e);this._getInternalModel().setProperty("/items",e);this._fireChangeSelectionItems();this._notifyChange()};f.prototype._filterModelItemsBySearchText=function(){var e=this._getSearchText();e=e.replace(/(^\s+)|(\s+$)/g,"");e=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");var t=new RegExp(e,"igm");this._getVisibleModelItems().forEach(function(e){e.visible=false;if(e.text&&e.text.match(t)){e.visible=true}if(e.tooltip&&e.tooltip.match(t)){e.visible=true}});this._getInternalModel().refresh()};f.prototype._updateInternalModel=function(){if(!this._bUpdateInternalModel){return}this._bUpdateInternalModel=false;this._getInternalModel().setProperty("/items",this.getItems().map(function(e){return{columnKey:e.getColumnKey(),visible:true,text:e.getText(),tooltip:e.getTooltip(),href:e.getHref(),target:e.getTarget(),persistentSelected:e.getVisible(),description:e.getDescription()}},this));this.getSelectionItems().forEach(function(e){var t=this._getModelItemByColumnKey(e.getColumnKey());if(!t){return}if(e.getSelected()!==undefined){t.persistentSelected=e.getSelected()}},this);this._switchVisibilityOfUnselectedModelItems();this._filterModelItemsBySearchText();var e=this._getInternalModel().getProperty("/items");this._updateCounts(e);this._getInternalModel().setProperty("/items",e)};return f});