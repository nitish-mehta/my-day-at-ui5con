/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/Device","./library","./ListBase","./ListItemBase","./CheckBox","./TableRenderer"],function(e,t,i,o,s,r,n){"use strict";var a=i.ListKeyboardMode;var l=i.ListGrowingDirection;var p=i.BackgroundDesign;var u=i.PopinLayout;var h=i.Sticky;var c=o.extend("sap.m.Table",{metadata:{library:"sap.m",properties:{backgroundDesign:{type:"sap.m.BackgroundDesign",group:"Appearance",defaultValue:p.Translucent},fixedLayout:{type:"boolean",group:"Behavior",defaultValue:true},showOverlay:{type:"boolean",group:"Appearance",defaultValue:false},alternateRowColors:{type:"boolean",group:"Appearance",defaultValue:false},popinLayout:{type:"sap.m.PopinLayout",group:"Appearance",defaultValue:u.Block},sticky:{type:"sap.m.Sticky[]",group:"Appearance"}},aggregations:{columns:{type:"sap.m.Column",multiple:true,singularName:"column",dnd:{draggable:true,droppable:true,layout:"Horizontal"}}},events:{beforeOpenContextMenu:{allowPreventDefault:true,parameters:{listItem:{type:"sap.m.ColumnListItem"},column:{type:"sap.m.Column"}}}},designtime:"sap/m/designtime/Table.designtime"}});c.prototype.sNavItemClass="sapMListTblRow";c.prototype.init=function(){this._iItemNeedsColumn=0;o.prototype.init.call(this)};c.prototype.onBeforeRendering=function(){o.prototype.onBeforeRendering.call(this);this._ensureColumnsMedia();this._notifyColumns("ItemsRemoved")};c.prototype._ensureColumnsMedia=function(){this.getColumns().forEach(function(e){if(e._bShouldAddMedia){e._addMedia()}})};c.prototype.onAfterRendering=function(){o.prototype.onAfterRendering.call(this);this.updateSelectAllCheckbox();this._renderOverlay()};c.prototype._renderOverlay=function(){var t=this.$(),i=t.find(".sapMTableOverlay"),o=this.getShowOverlay();if(o&&i.length===0){i=e("<div>").addClass("sapUiOverlay sapMTableOverlay").css("z-index","1");t.append(i)}else if(!o){i.remove()}};c.prototype.setShowOverlay=function(e){this.setProperty("showOverlay",e,true);this._renderOverlay();return this};c.prototype.exit=function(){o.prototype.exit.call(this);if(this._selectAllCheckBox){this._selectAllCheckBox.destroy();this._selectAllCheckBox=null}};c.prototype.destroyItems=function(){this._notifyColumns("ItemsRemoved");return o.prototype.destroyItems.apply(this,arguments)};c.prototype.removeAllItems=function(){this._notifyColumns("ItemsRemoved");return o.prototype.removeAllItems.apply(this,arguments)};c.prototype.removeSelections=function(){o.prototype.removeSelections.apply(this,arguments);this.updateSelectAllCheckbox();return this};c.prototype.selectAll=function(){o.prototype.selectAll.apply(this,arguments);this.updateSelectAllCheckbox();return this};c.prototype.getColumns=function(e){var t=this.getAggregation("columns",[]);if(e){t.sort(function(e,t){return e.getOrder()-t.getOrder()})}return t};c.prototype.onAfterPageLoaded=function(){this.updateSelectAllCheckbox();if(this.getAlternateRowColors()){var e=this.$("tblBody").removeClass();e.addClass(this._getAlternateRowColorsClass())}o.prototype.onAfterPageLoaded.apply(this,arguments)};c.prototype.shouldRenderItems=function(){var t=this.getColumns().some(function(e){return e.getVisible()});if(!t){e.sap.log.warning("No visible columns found in "+this)}return t};c.prototype.onItemTypeColumnChange=function(e,t){this._iItemNeedsColumn+=t?1:-1;if(this._iItemNeedsColumn==1&&t){this._setTypeColumnVisibility(true)}else if(this._iItemNeedsColumn==0){this._setTypeColumnVisibility(false)}};c.prototype.onItemSelectedChange=function(t,i){o.prototype.onItemSelectedChange.apply(this,arguments);e.sap.delayedCall(0,this,function(){this.updateSelectAllCheckbox()})};c.prototype.getTableDomRef=function(){return this.getDomRef("listUl")};c.prototype.getItemsContainerDomRef=function(){return this.getDomRef("tblBody")};c.prototype.setNavigationItems=function(e){var t=this.$("tblHeader");var i=this.$("tblFooter");var o=this.$("tblBody").children(".sapMLIB");var s=t.add(o).add(i).get();e.setItemDomRefs(s);if(e.getFocusedIndex()==-1){if(this.getGrowing()&&this.getGrowingDirection()==l.Upwards){e.setFocusedIndex(s.length-1)}else{e.setFocusedIndex(t[0]?1:0)}}};c.prototype.checkGrowingFromScratch=function(){if(this.hasPopin()){return false}return this.getColumns().some(function(e){return e.getVisible()&&e.getMergeDuplicates()})};c.prototype.onColumnResize=function(t){if(!this.hasPopin()&&!this._mutex){var i=this.getColumns().some(function(e){return e.isPopin()});if(!i){t.setDisplayViaMedia(this.getTableDomRef());return}}this._dirty=this._getMediaContainerWidth()||window.innerWidth;if(!this._mutex){var o=this._getMediaContainerWidth()||window.innerWidth;this._mutex=true;this.rerender();e.sap.delayedCall(200,this,function(){if(this._dirty!=o){this._dirty=0;this.rerender()}this._mutex=false})}};c.prototype.setTableHeaderVisibility=function(e){if(!this.getDomRef()){return}var t=this.$("tblHeader"),i=!t.hasClass("sapMListTblHeaderNone"),o=t.find(".sapMListTblCell:visible"),s=o.eq(0);if(o.length==1){s.width("")}else{o.each(function(){this.style.width=this.getAttribute("data-sap-width")||""})}this._colCount=o.length+2+!!sap.m.ListBaseRenderer.ModeOrder[this.getMode()];this.$("tblBody").find(".sapMGHLICell").attr("colspan",this.getColSpan());this.$("nodata-text").attr("colspan",this.getColCount());if(this.getFixedLayout()){this._forceStyleChange()}if(!e&&i){t[0].className="sapMListTblRow sapMListTblHeader";this._headerHidden=false}else if(e&&!i&&!o.length){t[0].className="sapMListTblHeaderNone";this._headerHidden=true}};c.prototype._forceStyleChange=function(){if(t.browser.msie){var e=this.getTableDomRef().style;e.listStyleType="circle";window.setTimeout(function(){e.listStyleType="none"},0)}};c.prototype._setTypeColumnVisibility=function(t){e(this.getTableDomRef()).toggleClass("sapMListTblHasNav",t)};c.prototype._notifyColumns=function(e,t,i){this.getColumns().forEach(function(o){o["on"+e](t,i)})};c.prototype._getSelectAllCheckbox=function(){return this._selectAllCheckBox||(this._selectAllCheckBox=new r({id:this.getId("sa"),activeHandling:false}).addStyleClass("sapMLIBSelectM").setParent(this,null,true).attachSelect(function(){if(this._selectAllCheckBox.getSelected()){this.selectAll(true)}else{this.removeSelections(false,true)}},this).setTabIndex(-1))};c.prototype.updateSelectAllCheckbox=function(){if(this._selectAllCheckBox&&this.getMode()==="MultiSelect"){var e=this.getItems(),t=this.getSelectedItems().length,i=e.filter(function(e){return e.isSelectable()}).length;this._selectAllCheckBox.setSelected(e.length>0&&t==i)}};c.prototype.enhanceAccessibilityState=function(e,t){if(e==this._selectAllCheckBox){var i=sap.ui.getCore().getLibraryResourceBundle("sap.m");t.label=i.getText("TABLE_CHECKBOX_SELECT_ALL")}};c.prototype.getColSpan=function(){return(this._colCount||1)-1};c.prototype.getColCount=function(){return this._colCount||0};c.prototype.hasPopin=function(){return!!this._hasPopin};c.prototype.isHeaderRowEvent=function(t){var i=this.$("tblHeader");return!!e(t.target).closest(i,this.getTableDomRef()).length};c.prototype.isFooterRowEvent=function(t){var i=this.$("tblFooter");return!!e(t.target).closest(i,this.getTableDomRef()).length};c.prototype.getAccessibilityType=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_TABLE")};c.prototype.getAccessibilityDescription=function(){return o.prototype.getAccessibilityDescription.call(this)+" "+this.getFooterText()};c.prototype._setHeaderAnnouncement=function(){var e=sap.ui.getCore().getLibraryResourceBundle("sap.m"),t=e.getText("ACC_CTR_TYPE_HEADER_ROW")+" ";if(this.isAllSelectableSelected()){t+=e.getText("LIST_ALL_SELECTED")}this.getColumns(true).forEach(function(e,i){if(!e.getVisible()){return}var o=e.getHeader();if(o&&o.getVisible()){t+=s.getAccessibilityText(o)+" "}});this.updateInvisibleText(t)};c.prototype._setFooterAnnouncement=function(){var e=sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_FOOTER_ROW")+" ";this.getColumns(true).forEach(function(t,i){if(!t.getVisible()){return}var o=t.getFooter();if(o&&o.getVisible()){var r=t.getHeader();if(r&&r.getVisible()){e+=s.getAccessibilityText(r)+" "}e+=s.getAccessibilityText(o)+" "}});this.updateInvisibleText(e)};c.prototype.onsapspace=function(e){if(e.isMarked()){return}if(this._selectAllCheckBox&&e.target===this.getDomRef("tblHeader")){this._selectAllCheckBox.setSelected(!this._selectAllCheckBox.getSelected()).fireSelect();e.preventDefault();e.setMarked()}};c.prototype.onsaptabnext=function(t){if(t.isMarked()||this.getKeyboardMode()==a.Edit){return}var i=e();if(t.target.id==this.getId("nodata")){i=this.$("nodata")}else if(this.isHeaderRowEvent(t)){i=this.$("tblHeader")}else if(this.isFooterRowEvent(t)){i=this.$("tblFooter")}var o=i.find(":sapTabbable").get(-1)||i[0];if(t.target===o){this.forwardTab(true);t.setMarked()}};c.prototype.onsaptabprevious=function(e){if(e.isMarked()||this.getKeyboardMode()==a.Edit){return}var t=e.target.id;if(t==this.getId("nodata")||t==this.getId("tblHeader")||t==this.getId("tblFooter")){this.forwardTab(false)}else if(t==this.getId("trigger")){this.focusPrevious();e.preventDefault()}};c.getStickyBrowserSupport=function(){var e=t.browser;return e.safari||e.chrome||e.firefox&&e.version>=59||e.edge&&e.version>=16};c.prototype.getStickyStyleValue=function(){var e=this.getSticky();if(!e||!e.length||!c.getStickyBrowserSupport()){return this._iStickyValue=0}var t=0,i=this.getHeaderText(),o=this.getHeaderToolbar(),s=i||o&&o.getVisible(),r=this.getInfoToolbar(),n=r&&r.getVisible(),a=this.getColumns().some(function(e){return e.getVisible()&&e.getHeader()});e.forEach(function(e){if(e===h.HeaderToolbar&&s){t+=1}else if(e===h.InfoToolbar&&n){t+=2}else if(e===h.ColumnHeaders&&a){t+=4}});return this._iStickyValue=t};c.prototype.setHeaderToolbar=function(e){return this._setToolbar("headerToolbar",e)};c.prototype.setInfoToolbar=function(e){return this._setToolbar("infoToolbar",e)};c.prototype._setToolbar=function(e,t){var i=this.getAggregation(e);if(i){i.detachEvent("_change",this._onToolbarPropertyChanged,this)}this.setAggregation(e,t);if(t){t.attachEvent("_change",this._onToolbarPropertyChanged,this)}return this};c.prototype._onToolbarPropertyChanged=function(e){if(e.getParameter("name")!=="visible"){return}var t=this._iStickyValue,i=this.getStickyStyleValue();if(t!==i){var o=this.getDomRef();if(o){var s=o.classList;s.toggle("sapMSticky",!!i);s.remove("sapMSticky"+t);s.toggle("sapMSticky"+i,!!i)}}};c.prototype.onfocusin=function(e){var t=e.target;if(t.id===this.getId("tblHeader")){this._setHeaderAnnouncement()}else if(t.id===this.getId("tblFooter")){this._setFooterAnnouncement()}if(this._bThemeChanged){this._bThemeChanged=false;this._forceStyleChange()}o.prototype.onfocusin.call(this,e)};c.prototype._handleStickyItemFocus=function(e){if(!this._iStickyValue||this._sLastFocusedStickyItemId===e.id){return}var t=i.getScrollDelegate(this,true);if(!t){return}var o=0,s=0,r=0,n=0,a=0,l=0;if(this._iStickyValue&4){var p=this.getDomRef("tblHeader").firstChild;var u=p.getBoundingClientRect();s=parseInt(u.bottom,10);o=parseInt(u.height,10)}if(this._iStickyValue&2){var h=this.getInfoToolbar().$().parent()[0];var c=h.getBoundingClientRect();n=parseInt(c.bottom,10);r=parseInt(c.height,10)}if(this._iStickyValue&1){var d=this.getDomRef().querySelector(".sapMListHdr");var g=d.getBoundingClientRect();l=parseInt(g.bottom,10);a=parseInt(g.height,10)}var f=e.getBoundingClientRect().top;if(s>f||n>f||l>f){window.requestAnimationFrame(function(){t.scrollToElement(e,0,[0,-o-r-a])})}this._sLastFocusedStickyItemId=e.id};c.prototype.onItemFocusIn=function(e){this._handleStickyItemFocus(e.getDomRef());o.prototype.onItemFocusIn.apply(this,arguments)};c.prototype.onThemeChanged=function(){o.prototype.onThemeChanged.call(this);this._bThemeChanged=true};c.prototype._getAlternateRowColorsClass=function(){if(this.isGrouped()){return"sapMListTblAlternateRowColorsGrouped"}if(this.hasPopin()){return"sapMListTblAlternateRowColorsPopin"}return"sapMListTblAlternateRowColors"};return c});