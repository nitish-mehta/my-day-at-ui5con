/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./Input","./Tokenizer","./Token","./library","sap/ui/core/EnabledPropagator","sap/ui/base/ManagedObjectMetadata","sap/ui/Device","./MultiInputRenderer","jquery.sap.keycodes"],function(e,t,i,o,n,s,r,a,l){"use strict";var p=t.extend("sap.m.MultiInput",{metadata:{library:"sap.m",designtime:"sap/m/designtime/MultiInput.designtime",properties:{enableMultiLineMode:{type:"boolean",group:"Behavior",defaultValue:false},maxTokens:{type:"int",group:"Behavior"}},aggregations:{tokens:{type:"sap.m.Token",multiple:true,singularName:"token"},tokenizer:{type:"sap.m.Tokenizer",multiple:false,visibility:"hidden"}},events:{tokenChange:{parameters:{type:{type:"string"},token:{type:"sap.m.Token"},tokens:{type:"sap.m.Token[]"},addedTokens:{type:"sap.m.Token[]"},removedTokens:{type:"sap.m.Token[]"}}},tokenUpdate:{allowPreventDefault:true,parameters:{type:{type:"string"},addedTokens:{type:"sap.m.Token[]"},removedTokens:{type:"sap.m.Token[]"}}}}}});s.apply(p.prototype,[true]);var h=sap.ui.getCore().getLibraryResourceBundle("sap.m");p.prototype.init=function(){t.prototype.init.call(this);this._bIsValidating=false;this._tokenizer=new i;this.setAggregation("tokenizer",this._tokenizer);this._tokenizer.attachTokenChange(this._onTokenChange,this);this._tokenizer.attachTokenUpdate(this._onTokenUpdate,this);this.setShowValueHelp(true);this.setShowSuggestion(true);this.attachSuggestionItemSelected(this._onSuggestionItemSelected,this);this.attachLiveChange(this._onLiveChange,this);this.attachValueHelpRequest(function(){this._bValueHelpOpen=true},this)};p.prototype._onTokenChange=function(t){var i=this.getTokens(),o=i.length;this.fireTokenChange(t.getParameters());this.invalidate();if(this._bUseDialog&&this._tokenizer.getParent()instanceof sap.m.Dialog){this._showAllTokens();return}var n=e.sap.containsOrEquals(this.getDomRef(),document.activeElement);if(t.getParameter("type")==="tokensChanged"&&t.getParameter("removedTokens").length>0&&n){this.focus()}if(t.getParameter("type")==="added"&&o>1&&this.getEditable()&&this._isMultiLineMode&&!this.$("border").hasClass("sapMMultiInputMultiModeBorder")){this._showIndicator()}if(t.getParameter("type")==="removed"&&this._isMultiLineMode){if(o<2){this._removeIndicator()}}};p.prototype._onTokenUpdate=function(e){var t=this.fireTokenUpdate(e.getParameters());if(!t){e.preventDefault()}else{this.invalidate()}};p.prototype._onSuggestionItemSelected=function(e){var t=null,i=null,n=this,s=this._tokenizer.getTokens().length;if(this.getMaxTokens()&&s>=this.getMaxTokens()||this._bValueHelpOpen){return}if(this._hasTabularSuggestions()){t=e.getParameter("selectedRow")}else{t=e.getParameter("selectedItem");if(t){i=new o({text:t.getText(),key:t.getKey()})}}if(t){var r=this.getValue();this._tokenizer._addValidateToken({text:r,token:i,suggestionObject:t,validationCallback:function(e){if(e){n.setValue("")}}})}if(this._bUseDialog&&this._tokenizer.getParent()instanceof sap.m.Dialog){var a=this._tokenizer.getTokens().length;if(s<a){this.setValue("")}if(this._tokenizer.getVisible()===false){this._tokenizer.setVisible(true)}if(this._oList instanceof sap.m.Table){this._oList.addStyleClass("sapMInputSuggestionTableHidden")}else{this._oList.destroyItems()}var l=this._oSuggestionPopup.getScrollDelegate();if(l){l.scrollTo(0,0,0)}this._oPopupInput.focus()}};p.prototype._onLiveChange=function(e){this._tokenizer._removeSelectedTokens();if(this._bUseDialog&&this._isMultiLineMode){var t=e.getParameter("newValue");if(this._oSuggestionPopup&&this._oSuggestionPopup.getContent().length>1&&t.length>0){this._tokenizer.setVisible(false)}else{this._tokenizer.setVisible(true)}}};p.prototype._showIndicator=function(){var e=this.getTokens(),t=e.length;this._tokenizer.setVisible(true);if(t>1){if(this.$().find(".sapMMultiInputIndicator").length!==0){this._removeIndicator()}var i='<span class="sapMMultiInputIndicator">'+h.getText("MULTIINPUT_SHOW_MORE_TOKENS",t-1)+"</span>";this.$().find(".sapMMultiInputInputContainer").prepend(i);this._setValueInvisible();this._bShowIndicator=true}};p.prototype._setValueInvisible=function(){this.$("inner").css("opacity","0")};p.prototype._setValueVisible=function(){this.$("inner").css("opacity","1")};p.prototype._showAllTokens=function(){this._tokenizer.setVisible(true);this._removeIndicator()};p.prototype._removeIndicator=function(){this.$().find(".sapMMultiInputIndicator").remove();this._bShowIndicator=false};p.prototype.setEnableMultiLineMode=function(e){this.setProperty("enableMultiLineMode",e,true);if(e){this.$().addClass("sapMMultiInputMultiLine")}else{this.$().removeClass("sapMMultiInputMultiLine")}this.closeMultiLine();var t=this;if(this._bUseDialog){e=true}if(e){if(this.getEditable()){this._showIndicator()}this._isMultiLineMode=true;if(this.getDomRef()){setTimeout(function(){t._tokenizer.scrollToEnd()},0)}}else{this._isMultiLineMode=false;this._showAllTokens();this._setValueVisible();if(this.getDomRef()){setTimeout(function(){t._tokenizer.scrollToEnd()},0)}}return this};p.prototype._openMultiLineOnPhone=function(){var e=this;if(!this.getEditable()){return}this._oSuggestionPopup.open();this._oSuggestionPopup.insertContent(this._tokenizer,0);this._tokenizer.setReverseTokens(true);var t=this._oPopupInput.getValue();if(this._oSuggestionPopup&&this._oSuggestionPopup.getContent().length>1&&t.length>0){this._tokenizer.setVisible(false)}else{this._tokenizer.setVisible(true)}this._tokenizer._oScroller.setHorizontal(false);this._tokenizer.addStyleClass("sapMTokenizerMultiLine");if(this._oSuggestionTable.getItems().length===0){this._oPopupInput.onsapenter=function(t){e._validateCurrentText();e._setValueInvisible()}}};p.prototype.onmousedown=function(e){if(e.target==this.getDomRef("border")){e.preventDefault();e.stopPropagation()}};p.prototype._openMultiLineOnDesktop=function(){var e=this;this._setValueVisible();this.$("border").addClass("sapMMultiInputMultiModeBorder");if(this._$input){this._$input.parents(".sapMMultiInputBorder").addClass("sapMMultiInputMultiModeInputContainer")}this.$().find(".sapMInputValHelp").attr("tabindex","-1");var t=this.getParent();this._originalOverflow=null;if(t&&t.$&&t.$().css("overflow")==="hidden"){this._originalOverflow=t.$().css("overflow");t.$().css("overflow","visible")}var i;if(this.$().closest(".sapUiVlt").length!==0){i=this.$().closest(".sapUiVlt")}else if(this.$().parent('[class*="sapUiRespGridSpan"]').length!==0){i=this.$().parent('[class*="sapUiRespGridSpan"]')}else if(this.$().parents(".sapUiRFLContainer").length!==0){i=this.$().parents(".sapUiRFLContainer")}if(i&&i.length>0&&i.css("overflow")==="hidden"){i.css("overflow","visible")}e._showAllTokens();e._tokenizer.scrollToStart()};p.prototype.openMultiLine=function(){var e=this.getTokens();if(!this.getEditable()){return}if(this.getEnableMultiLineMode()&&e.length>0&&!a.system.phone){this._openMultiLineOnDesktop()}};p.prototype.closeMultiLine=function(){if(!this.getEditable()){return}if(this._bUseDialog){this._oSuggestionPopup.close();this._tokenizer.setVisible(true)}else{this.$("border").removeClass("sapMMultiInputMultiModeBorder");if(this._$input){this._$input.parents(".sapMMultiInputBorder").removeClass("sapMMultiInputMultiModeInputContainer")}this.$().find(".sapMInputValHelp").removeAttr("tabindex");if(this._originalOverflow){var e=this.getParent();e.$().css("overflow",this._originalOverflow)}}if(this.getTokens().length>1&&this._isMultiLineMode){this._showIndicator()}};p.prototype.getScrollDelegate=function(){return this._tokenizer._oScroller};p.prototype.onBeforeRendering=function(){var e=this.getAggregation("tokenizer");if(e){e.toggleStyleClass("sapMTokenizerEmpty",e.getTokens().length===0)}t.prototype.onBeforeRendering.apply(this,arguments)};p.prototype.onAfterRendering=function(){this._tokenizer.scrollToEnd();t.prototype.onAfterRendering.apply(this,arguments)};p.prototype.addValidator=function(e){this._tokenizer.addValidator(e)};p.prototype.removeValidator=function(e){this._tokenizer.removeValidator(e)};p.prototype.removeAllValidators=function(){this._tokenizer.removeAllValidators()};p.prototype.onsapnext=function(t){if(t.isMarked()){return}var i=e(document.activeElement).control()[0];if(!i){return}if(this._tokenizer===i||this._tokenizer.$().find(i.$()).length>0){this._scrollAndFocus()}};p.prototype.onsapbackspace=function(e){if(this.getCursorPosition()>0||!this.getEditable()||this.getValue().length>0){return}i.prototype.onsapbackspace.apply(this._tokenizer,arguments);e.preventDefault();e.stopPropagation()};p.prototype.onsapdelete=function(e){if(!this.getEditable()){return}if(this.getValue()&&!this._completeTextIsSelected()){return}i.prototype.onsapdelete.apply(this._tokenizer,arguments)};p.prototype.onkeydown=function(t){if(t.which===e.sap.KeyCodes.TAB){this._tokenizer._changeAllTokensSelection(false)}if((t.ctrlKey||t.metaKey)&&t.which===e.sap.KeyCodes.A){if(this._tokenizer.getTokens().length>0){this._tokenizer.focus();this._tokenizer._changeAllTokensSelection(true);t.preventDefault()}}if((t.ctrlKey||t.metaKey)&&(t.which===e.sap.KeyCodes.C||t.which===e.sap.KeyCodes.INSERT)){this._tokenizer._copy()}if((t.ctrlKey||t.metaKey)&&t.which===e.sap.KeyCodes.X||t.shiftKey&&t.which===e.sap.KeyCodes.DELETE){if(this.getEditable()){this._tokenizer._cut()}else{this._tokenizer._copy()}}};p.prototype.onpaste=function(e){var t,o,n=[],s=[];if(this.getValueHelpOnly()){return}if(window.clipboardData){t=window.clipboardData.getData("Text")}else{t=e.originalEvent.clipboardData.getData("text/plain")}var r=this._tokenizer._parseString(t);if(r.length<=1){return}setTimeout(function(){if(r){if(this.fireEvent("_validateOnPaste",{texts:r},true)){var e="";for(o=0;o<r.length;o++){if(r[o]){var t=this._convertTextToToken(r[o],true);if(t){n.push(t)}else{e=r[o]}}}this.updateDomValue(e);for(o=0;o<n.length;o++){if(this._tokenizer._addUniqueToken(n[o])){s.push(n[o])}}if(s.length>0){this.fireTokenUpdate({addedTokens:s,removedTokens:[],type:i.TokenUpdateType.Added})}}if(s.length){this.cancelPendingSuggest()}}}.bind(this),0)};p.prototype._convertTextToToken=function(e,t){var i=null,n=null,s=null,r=this._tokenizer.getTokens().length;if(!this.getEditable()){return null}e=e.trim();if(!e){return null}if(this._getIsSuggestionPopupOpen()||t){if(this._hasTabularSuggestions()){n=this._oSuggestionTable._oSelectedItem}else{n=this._getSuggestionItem(e)}}if(n&&n.getText&&n.getKey){s=new o({text:n.getText(),key:n.getKey()})}var a=this;i=this._tokenizer._validateToken({text:e,token:s,suggestionObject:n,validationCallback:function(e){a._bIsValidating=false;if(e){a.setValue("");if(a._bUseDialog&&a._isMultiLineMode&&a._oSuggestionTable.getItems().length===0){var t=a._tokenizer.getTokens().length;if(r<t){a._oPopupInput.setValue("")}if(a._tokenizer.getVisible()===false){a._tokenizer.setVisible(true)}a._setAllTokenVisible()}}}});return i};p.prototype.onsapprevious=function(e){if(this._getIsSuggestionPopupOpen()){return}if(this.getCursorPosition()===0){if(e.srcControl===this){i.prototype.onsapprevious.apply(this._tokenizer,arguments);e.preventDefault()}}};p.prototype._scrollAndFocus=function(){this._tokenizer.scrollToEnd();this.$().find("input").focus()};p.prototype.onsaphome=function(e){if(this._tokenizer._checkFocus()){i.prototype.onsaphome.apply(this._tokenizer,arguments)}};p.prototype.onsapend=function(e){if(this._tokenizer._checkFocus()){i.prototype.onsapend.apply(this._tokenizer,arguments);e.preventDefault()}};p.prototype.onsapenter=function(e){if(t.prototype.onsapenter){t.prototype.onsapenter.apply(this,arguments)}var i=true;if(this._oSuggestionPopup&&this._oSuggestionPopup.isOpen()){if(this._hasTabularSuggestions()){i=!this._oSuggestionTable.getSelectedItem()}else{i=!this._oList.getSelectedItem()}}if(i){this._validateCurrentText()}this.focus()};p.prototype._checkFocus=function(){return this.getDomRef()&&e.sap.containsOrEquals(this.getDomRef(),document.activeElement)};p.prototype.onsapfocusleave=function(o){var n=this._oSuggestionPopup,s=false,r=false,a=this._checkFocus(),l;if(n instanceof sap.m.Popover){if(o.relatedControlId){l=sap.ui.getCore().byId(o.relatedControlId).getFocusDomRef();s=e.sap.containsOrEquals(n.getFocusDomRef(),l);r=e.sap.containsOrEquals(this._tokenizer.getFocusDomRef(),l)}}if(!r&&!s&&!this._isMultiLineMode){this._tokenizer.scrollToEnd()}t.prototype.onsapfocusleave.apply(this,arguments);if(this._bIsValidating||this._bValueHelpOpen){return}if(!this._bUseDialog&&!s&&o.relatedControlId!==this.getId()&&o.relatedControlId!==this._tokenizer.getId()&&!r&&!(this._isMultiLineMode&&this._bShowIndicator)){this._validateCurrentText(true)}if(!this._bUseDialog&&this._isMultiLineMode&&this.getDomRef("inner").style.opacity=="1"&&this.getEditable()){if(a||s){return}this.closeMultiLine();this._showIndicator()}i.prototype.onsapfocusleave.apply(this._tokenizer,arguments);if(!this._bUseDialog&&this._isMultiLineMode&&this._bShowIndicator){var p=this.$().find(".sapMMultiInputBorder");p.scrollTop(0)}};p.prototype._onDialogClose=function(){this._validateCurrentText();this._tokenizer._oScroller.setHorizontal(true);this._tokenizer.removeStyleClass("sapMTokenizerMultiLine");this.setAggregation("tokenizer",this._tokenizer);this._tokenizer.setReverseTokens(false);this._tokenizer.invalidate()};p.prototype.ontap=function(e){if(document.activeElement===this._$input[0]||document.activeElement===this._tokenizer.getDomRef()){this._tokenizer.selectAllTokens(false)}if(e&&e.isMarked("tokenDeletePress")){return}t.prototype.ontap.apply(this,arguments)};p.prototype._onclick=function(e){if(this._bUseDialog){this._openMultiLineOnPhone()}};p.prototype.onfocusin=function(e){this._bValueHelpOpen=false;if(this.getEditable()&&this.getEnableMultiLineMode()&&(!e.target.classList.contains("sapMInputValHelp")&&!e.target.classList.contains("sapMInputValHelpInner"))){this.openMultiLine()}if(e.target===this.getFocusDomRef()){t.prototype.onfocusin.apply(this,arguments)}};p.prototype.onsapescape=function(e){this._tokenizer.selectAllTokens(false);this.selectText(0,0);t.prototype.onsapescape.apply(this,arguments)};p.prototype._validateCurrentText=function(e){var t=this._tokenizer.getTokens().length;var i=this.getValue();if(!i||!this.getEditable()){return}i=i.trim();if(!i){return}var n=null;if(e||this._getIsSuggestionPopupOpen()){if(this._hasTabularSuggestions()){n=this._oSuggestionTable._oSelectedItem}else{n=this._getSuggestionItem(i,e)}}var s=null;if(n&&n.getText&&n.getKey){s=new o({text:n.getText(),key:n.getKey()})}var r=this;if(!this.getMaxTokens()||this.getTokens().length<this.getMaxTokens()){this._bIsValidating=true;this._tokenizer._addValidateToken({text:i,token:s,suggestionObject:n,validationCallback:function(e){r._bIsValidating=false;if(e){r.setValue("");if(r._bUseDialog&&r._isMultiLineMode&&r._oSuggestionTable.getItems().length===0){var i=r._tokenizer.getTokens().length;if(t<i){r._oPopupInput.setValue("")}if(r._tokenizer.getVisible()===false){r._tokenizer.setVisible(true)}}}}})}};p.prototype.getCursorPosition=function(){return this._$input.cursorPos()};p.prototype._completeTextIsSelected=function(){var e=this._$input[0];if(e.selectionStart!==0){return false}if(e.selectionEnd!==this.getValue().length){return false}return true};p.prototype._getIsSuggestionPopupOpen=function(){return this._oSuggestionPopup&&this._oSuggestionPopup.isOpen()};p.prototype.setEditable=function(e){e=this.validateProperty("editable",e);if(e===this.getEditable()){return this}if(e&&(this.getEnableMultiLineMode()||this._bUseDialog)&&this.getTokens().length>1){this._bShowIndicator=true}else{this._bShowIndicator=false}if(t.prototype.setEditable){t.prototype.setEditable.apply(this,arguments)}this._tokenizer.setEditable(e);return this};p.prototype._findItem=function(e,t,i,o){if(!e){return}if(!(t&&t.length)){return}e=e.toLowerCase();var n=t.length;for(var s=0;s<n;s++){var r=t[s];var a=o(r);if(!a){continue}a=a.toLowerCase();if(a===e){return r}if(!i&&a.indexOf(e)===0){return r}}};p.prototype._getSuggestionItem=function(e,t){var i=null;var o=null;if(this._hasTabularSuggestions()){i=this.getSuggestionRows();o=this._findItem(e,i,t,function(e){var t=e.getCells();var i=null;if(t){var o;for(o=0;o<t.length;o++){if(t[o].getText){i=t[o].getText();break}}}return i})}else{i=this.getSuggestionItems();o=this._findItem(e,i,t,function(e){return e.getText()})}return o};p.getMetadata().forwardAggregation("tokens",{getter:function(){return this._tokenizer},aggregation:"tokens",forwardBinding:true});p.prototype.clone=function(){var e,i;this.detachSuggestionItemSelected(this._onSuggestionItemSelected,this);this.detachLiveChange(this._onLiveChange,this);this._tokenizer.detachTokenChange(this._onTokenChange,this);this._tokenizer.detachTokenUpdate(this._onTokenUpdate,this);e=t.prototype.clone.apply(this,arguments);e.destroyAggregation("tokenizer");e._tokenizer=null;i=this._tokenizer.clone();e._tokenizer=i;e.setAggregation("tokenizer",i,true);this._tokenizer.attachTokenChange(this._onTokenChange,this);this._tokenizer.attachTokenUpdate(this._onTokenUpdate,this);e._tokenizer.attachTokenChange(e._onTokenChange,e);e._tokenizer.attachTokenUpdate(e._onTokenUpdate,e);this.attachSuggestionItemSelected(this._onSuggestionItemSelected,this);this.attachLiveChange(this._onLiveChange,this);return e};p.prototype.getPopupAnchorDomRef=function(){return this.getDomRef("border")};p.prototype.setTokens=function(e){var t,i=[],o;if(Array.isArray(e)){for(o=0;o<e.length;o++){t=this.validateAggregation("tokens",e[o],true);r.addAPIParentInfo(e[o],this,"tokens");i.push(t)}this._tokenizer.setTokens(i)}else{throw new Error('"'+e+'" is of type '+typeof e+", expected array for aggregation tokens of "+this)}return this};p.TokenChangeType={Added:"added",Removed:"removed",RemovedAll:"removedAll",TokensChanged:"tokensChanged"};p.WaitForAsyncValidation="sap.m.Tokenizer.WaitForAsyncValidation";p.prototype.getDomRefForValueStateMessage=p.prototype.getPopupAnchorDomRef;p.prototype.updateInputField=function(e){t.prototype.updateInputField.call(this,e);this.setDOMValue("")};p.prototype.getAccessibilityInfo=function(){var e=this.getTokens().map(function(e){return e.getText()}).join(" ");var i=t.prototype.getAccessibilityInfo.apply(this,arguments);i.type=h.getText("ACC_CTR_TYPE_MULTIINPUT");i.description=((i.description||"")+" "+e).trim();return i};return p});