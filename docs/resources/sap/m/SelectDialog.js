/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./Button","./Dialog","./List","./SearchField","./library","sap/ui/core/Control","sap/ui/Device","sap/ui/base/ManagedObject","sap/m/Toolbar","sap/m/Label","sap/m/BusyIndicator","sap/m/Bar","sap/ui/core/theming/Parameters","./SelectDialogRenderer"],function(t,e,i,s,o,n,a,l,r,h,u,d,g,c){"use strict";var p=o.ListMode;var _=n.extend("sap.m.SelectDialog",{metadata:{library:"sap.m",properties:{title:{type:"string",group:"Appearance",defaultValue:null},noDataText:{type:"string",group:"Appearance",defaultValue:null},multiSelect:{type:"boolean",group:"Dimension",defaultValue:false},growingThreshold:{type:"int",group:"Misc",defaultValue:null},growing:{type:"boolean",group:"Behavior",defaultValue:true},contentWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},rememberSelections:{type:"boolean",group:"Behavior",defaultValue:false},contentHeight:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null}},defaultAggregation:"items",aggregations:{items:{type:"sap.m.ListItemBase",multiple:true,singularName:"item",forwarding:{idSuffix:"-list",aggregation:"items",forwardBinding:true}},_dialog:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},events:{confirm:{parameters:{selectedItem:{type:"sap.m.StandardListItem"},selectedItems:{type:"sap.m.StandardListItem[]"},selectedContexts:{type:"string"}}},search:{parameters:{value:{type:"string"},itemsBinding:{type:"any"}}},liveChange:{parameters:{value:{type:"string"},itemsBinding:{type:"any"}}},cancel:{}}}});_.prototype.init=function(){var t=this,o=0,n=null,l=null;n=function(){t._oSelectedItem=t._oList.getSelectedItem();t._aSelectedItems=t._oList.getSelectedItems();t._oDialog.detachAfterClose(n);t._fireConfirmAndUpdateSelection()};this._bAppendedToUIArea=false;this._bInitBusy=false;this._bFirstRender=true;this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._oList=new i(this.getId()+"-list",{growing:t.getGrowing(),growingScrollToLoad:t.getGrowing(),mode:p.SingleSelectMaster,infoToolbar:new r({visible:false,active:false,content:[new h({text:this._oRb.getText("TABLESELECTDIALOG_SELECTEDITEMS",[0])})]}),selectionChange:function(e){if(t._oDialog){if(!t.getMultiSelect()){t._oDialog.attachAfterClose(n);t._oDialog.close()}else{t._updateSelectionIndicator()}}}});this._oList.getInfoToolbar().addEventDelegate({onAfterRendering:function(){t._oList.getInfoToolbar().$().attr("aria-live","polite")}});this._list=this._oList;this._oList.attachUpdateStarted(this._updateStarted,this);this._oList.attachUpdateFinished(this._updateFinished,this);this._oBusyIndicator=new u(this.getId()+"-busyIndicator").addStyleClass("sapMSelectDialogBusyIndicator",true);this._oSearchField=new s(this.getId()+"-searchField",{width:"100%",liveChange:function(e){var i=e.getSource().getValue(),s=i?300:0;clearTimeout(o);if(s){o=setTimeout(function(){t._executeSearch(i,"liveChange")},s)}else{t._executeSearch(i,"liveChange")}},search:function(e){t._executeSearch(e.getSource().getValue(),"search")}});this._searchField=this._oSearchField;this._oSubHeader=new d(this.getId()+"-subHeader",{contentMiddle:[this._oSearchField]});this._oDialog=new e(this.getId()+"-dialog",{title:this.getTitle(),stretch:a.system.phone,contentHeight:"2000px",subHeader:this._oSubHeader,content:[this._oBusyIndicator,this._oList],leftButton:this._getCancelButton(),initialFocus:a.system.desktop?this._oSearchField:null}).addStyleClass("sapMSelectDialog",true);this._dialog=this._oDialog;this.setAggregation("_dialog",this._oDialog);l=this._oDialog.onsapescape;this._oDialog.onsapescape=function(e){if(l){l.call(t._oDialog,e)}t._onCancel()};this._oDialog._iVMargin=8*(parseInt(g.get("sapUiFontSize"),10)||16);this._sSearchFieldValue="";this._bFirstRequest=true;this._bLiveChange=false;this._iListUpdateRequested=0};_.prototype.setGrowing=function(t){this._oList.setGrowing(t);this._oList.setGrowingScrollToLoad(t);this.setProperty("growing",t,true);return this};_.prototype.setBusy=function(){this._oDialog.setBusy.apply(this._oDialog,arguments);return this};_.prototype.getBusy=function(){return this._oDialog.getBusy.apply(this._oDialog,arguments)};_.prototype.exit=function(){this._oList=null;this._oSearchField=null;this._oSubHeader=null;this._oBusyIndicator=null;this._sSearchFieldValue=null;this._iListUpdateRequested=0;this._bFirstRequest=false;this._bInitBusy=false;this._bFirstRender=false;this._bFirstRequest=false;if(this._bAppendedToUIArea){var t=sap.ui.getCore().getStaticAreaRef();t=sap.ui.getCore().getUIArea(t);t.removeContent(this,true)}if(this._oDialog){this._oDialog.destroy();this._oDialog=null}if(this._oOkButton){this._oOkButton.destroy();this._oOkButton=null}this._oSelectedItem=null;this._aSelectedItems=null;this._list=null;this._searchField=null;this._dialog=null};_.prototype.onAfterRendering=function(){if(this._bInitBusy&&this._bFirstRender){this._setBusy(true);this._bInitBusy=false}return this};_.prototype.invalidate=function(){if(this._oDialog&&(!arguments[0]||arguments[0]&&arguments[0].getId()!==this.getId()+"-dialog")){this._oDialog.invalidate(arguments)}else{n.prototype.invalidate.apply(this,arguments)}return this};_.prototype.open=function(t){if((!this.getParent()||!this.getUIArea())&&!this._bAppendedToUIArea){var e=sap.ui.getCore().getStaticAreaRef();e=sap.ui.getCore().getUIArea(e);e.addContent(this,true);this._bAppendedToUIArea=true}this._bFirstRequest=true;this._oSearchField.setValue(t);this._oDialog.open();if(this._bInitBusy){this._setBusy(true)}this._updateSelectionIndicator();this._aInitiallySelectedContextPaths=this._oList.getSelectedContextPaths();return this};_.prototype.setGrowingThreshold=function(t){this._oList.setGrowingThreshold(t);this.setProperty("growingThreshold",t,true);return this};_.prototype.setMultiSelect=function(t){this.setProperty("multiSelect",t,true);if(t){this._oList.setMode(p.MultiSelect);this._oList.setIncludeItemInSelection(true);this._oDialog.setEndButton(this._getCancelButton());this._oDialog.setBeginButton(this._getOkButton())}else{this._oList.setMode(p.SingleSelectMaster);this._oDialog.setBeginButton(this._getCancelButton())}return this};_.prototype.setTitle=function(t){this._oDialog.setTitle(t);this.setProperty("title",t,true);return this};_.prototype.setNoDataText=function(t){this._oList.setNoDataText(t);return this};_.prototype.getNoDataText=function(){return this._oList.getNoDataText()};_.prototype.getContentWidth=function(){return this._oDialog.getContentWidth()};_.prototype.setContentWidth=function(t){this._oDialog.setContentWidth(t);return this};_.prototype.getContentHeight=function(){return this._oDialog.getContentHeight()};_.prototype.setContentHeight=function(t){this._oDialog.setContentHeight(t);return this};_.prototype.addStyleClass=function(){this._oDialog.addStyleClass.apply(this._oDialog,arguments);return this};_.prototype.removeStyleClass=function(){this._oDialog.removeStyleClass.apply(this._oDialog,arguments);return this};_.prototype.toggleStyleClass=function(){this._oDialog.toggleStyleClass.apply(this._oDialog,arguments);return this};_.prototype.hasStyleClass=function(){return this._oDialog.hasStyleClass.apply(this._oDialog,arguments)};_.prototype.getDomRef=function(){if(this._oDialog){return this._oDialog.getDomRef.apply(this._oDialog,arguments)}else{return null}};_.prototype._setModel=_.prototype.setModel;_.prototype.setModel=function(t,e){var i=Array.prototype.slice.call(arguments);this._setBusy(false);this._bInitBusy=false;this._iListUpdateRequested+=1;this._oList.setModel(t,e);_.prototype._setModel.apply(this,i);this._updateSelectionIndicator();return this};_.prototype._setBindingContext=_.prototype.setBindingContext;_.prototype.setBindingContext=function(t,e){var i=Array.prototype.slice.call(arguments);this._oList.setBindingContext(t,e);_.prototype._setBindingContext.apply(this,i);return this};_.prototype._executeSearch=function(t,e){var i=this._oList,s=i?i.getBinding("items"):undefined,o=this._sSearchFieldValue!==t;if(e==="liveChange"){this._bLiveChange=true}if(this._oDialog.isOpen()&&(o&&e==="liveChange"||e==="search")){this._sSearchFieldValue=t;if(s){this._iListUpdateRequested+=1;if(e==="search"){this.fireSearch({value:t,itemsBinding:s})}else if(e==="liveChange"){this.fireLiveChange({value:t,itemsBinding:s})}}else{if(e==="search"){this.fireSearch({value:t})}else if(e==="liveChange"){this.fireLiveChange({value:t})}}}return this};_.prototype._setBusy=function(t){if(this._iListUpdateRequested){if(t){this._oList.addStyleClass("sapMSelectDialogListHide");this._oBusyIndicator.$().css("display","inline-block")}else{this._oList.removeStyleClass("sapMSelectDialogListHide");this._oBusyIndicator.$().css("display","none")}}};_.prototype._updateStarted=function(t){if(this.getModel()&&this.getModel()instanceof sap.ui.model.odata.ODataModel){if(this._oDialog.isOpen()&&this._iListUpdateRequested){this._setBusy(true)}else{this._bInitBusy=true}}};_.prototype._updateFinished=function(t){this._updateSelectionIndicator();if(this.getModel()&&this.getModel()instanceof sap.ui.model.odata.ODataModel){this._setBusy(false);this._bInitBusy=false}if(a.system.desktop){if(this._oList.getItems()[0]){this._oDialog.setInitialFocus(this._oList.getItems()[0])}else{this._oDialog.setInitialFocus(this._oSearchField)}if(this._bFirstRequest&&!this._bLiveChange){var e=this._oList.getItems()[0];if(!e){e=this._oSearchField}if(e.getFocusDomRef()){e.getFocusDomRef().focus()}}}this._bFirstRequest=false;this._iListUpdateRequested=0};_.prototype._getOkButton=function(){var e=this,i=null;i=function(){e._oSelectedItem=e._oList.getSelectedItem();e._aSelectedItems=e._oList.getSelectedItems();e._oDialog.detachAfterClose(i);e._fireConfirmAndUpdateSelection()};if(!this._oOkButton){this._oOkButton=new t(this.getId()+"-ok",{text:this._oRb.getText("MSGBOX_OK"),press:function(){e._oDialog.attachAfterClose(i);e._oDialog.close()}})}return this._oOkButton};_.prototype._getCancelButton=function(){var e=this;if(!this._oCancelButton){this._oCancelButton=new t(this.getId()+"-cancel",{text:this._oRb.getText("MSGBOX_CANCEL"),press:function(t){e._onCancel()}})}return this._oCancelButton};_.prototype._onCancel=function(t){var e=this,i=null;i=function(){e._oSelectedItem=null;e._aSelectedItems=[];e._sSearchFieldValue=null;e._oDialog.detachAfterClose(i);e._resetSelection();e.fireCancel()};this._oDialog.attachAfterClose(i);this._oDialog.close()};_.prototype._updateSelectionIndicator=function(){var t=this._oList.getSelectedContextPaths(true).length,e=this._oList.getInfoToolbar();e.setVisible(!!t&&this.getMultiSelect());e.getContent()[0].setText(this._oRb.getText("TABLESELECTDIALOG_SELECTEDITEMS",[t]))};_.prototype._fireConfirmAndUpdateSelection=function(){var t={selectedItem:this._oSelectedItem,selectedItems:this._aSelectedItems};Object.defineProperty(t,"selectedContexts",{get:this._oList.getSelectedContexts.bind(this._oList,true)});this.fireConfirm(t);this._updateSelection()};_.prototype._updateSelection=function(){if(!this.getRememberSelections()&&!this.bIsDestroyed){this._oList.removeSelections(true);delete this._oSelectedItem;delete this._aSelectedItems}};_.prototype._resetSelection=function(){if(!this.bIsDestroyed){this._oList.removeSelections(true);this._oList.setSelectedContextPaths(this._aInitiallySelectedContextPaths);this._oList.getItems().forEach(function(t){var e=t.getBindingContextPath();if(e&&this._aInitiallySelectedContextPaths.indexOf(e)>-1){t.setSelected(true)}},this)}};return _});