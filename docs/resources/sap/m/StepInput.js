/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Icon","./Input","./InputRenderer","sap/ui/core/Control","sap/ui/core/IconPool","sap/ui/Device","sap/ui/core/library","sap/ui/core/Renderer","sap/m/library","./StepInputRenderer","jquery.sap.keycodes"],function(t,e,i,a,n,s,r,u,o,l,p){"use strict";var h=l.InputType;var g=u.TextAlign;var c=u.ValueState;var d=l.StepInputValidationMode;var f=l.StepInputStepModeType;var _=n.extend("sap.m.StepInput",{metadata:{interfaces:["sap.ui.core.IFormContent"],library:"sap.m",designtime:"sap/m/designtime/StepInput.designtime",properties:{min:{type:"float",group:"Data"},max:{type:"float",group:"Data"},step:{type:"float",group:"Data",defaultValue:1},stepMode:{type:"sap.m.StepInputStepModeType",group:"Data",defaultValue:f.AdditionAndSubtraction},largerStep:{type:"float",group:"Data",defaultValue:2},value:{type:"float",group:"Data",defaultValue:0},name:{type:"string",group:"Misc",defaultValue:null},placeholder:{type:"string",group:"Misc",defaultValue:null},required:{type:"boolean",group:"Misc",defaultValue:false},width:{type:"sap.ui.core.CSSSize",group:"Dimension"},valueState:{type:"sap.ui.core.ValueState",group:"Data",defaultValue:c.None},valueStateText:{type:"string",group:"Misc",defaultValue:null},editable:{type:"boolean",group:"Behavior",defaultValue:true},enabled:{type:"boolean",group:"Behavior",defaultValue:true},displayValuePrecision:{type:"int",group:"Data",defaultValue:0},description:{type:"string",group:"Misc",defaultValue:null},fieldWidth:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"50%"},textAlign:{type:"sap.ui.core.TextAlign",group:"Appearance",defaultValue:g.End},validationMode:{type:"sap.m.StepInputValidationMode",group:"Misc",defaultValue:d.FocusOut}},aggregations:{_incrementButton:{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"},_decrementButton:{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"},_input:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"}},events:{change:{parameters:{value:{type:"string"}}}}},constructor:function(t,e){n.prototype.constructor.apply(this,arguments);if(this.getEditable()){this._getOrCreateDecrementButton();this._getOrCreateIncrementButton()}if(typeof t!=="string"){e=t}if(e&&e.value===undefined){this.setValue(this._getDefaultValue(undefined,e.max,e.min))}}});var y=sap.ui.getCore().getLibraryResourceBundle("sap.m");_.STEP_INPUT_INCREASE_BTN_TOOLTIP=y.getText("STEP_INPUT_INCREASE_BTN");_.STEP_INPUT_DECREASE_BTN_TOOLTIP=y.getText("STEP_INPUT_DECREASE_BTN");_.INITIAL_WAIT_TIMEOUT=500;_.ACCELLERATION=.8;_.MIN_WAIT_TIMEOUT=50;_.INITIAL_SPEED=120;_._TOLERANCE=10;var m={min:"aria-valuemin",max:"aria-valuemax",value:"aria-valuenow"};var V=["enabled","editable","name","placeholder","required","valueStateText","description","fieldWidth","textAlign"];var I=o.extend(a);I.openInputTag=function(t,e){var i=e.getParent(),n=i._getDecrementButton(),s=i.getEditable();if(s&&n){this.renderButton(t,e,n,["sapMStepInputBtnDecrease"])}a.openInputTag.apply(this,arguments)};I.closeInputTag=function(t,e){var i=e.getParent(),n=i._getIncrementButton(),s=i.getEditable();a.closeInputTag.apply(this,arguments);if(s&&n){this.renderButton(t,e,n,["sapMStepInputBtnIncrease"])}};I.renderButton=function(t,e,i,a){var n=e.getParent()._getIsDisabledButton(a[0]);i.addStyleClass("sapMStepInputBtn");a.forEach(function(t){i.addStyleClass(t)});n?i.addStyleClass("sapMStepInputIconDisabled"):i.removeStyleClass("sapMStepInputIconDisabled");t.renderControl(i)};I.writeInnerAttributes=function(t,e){t.writeAttribute("type",e.getType().toLowerCase());if(sap.ui.getCore().getConfiguration().getRTL()){t.writeAttribute("dir","ltr")}};I.getAccessibilityState=function(t){var e=a.getAccessibilityState(t),i=t.getParent(),n=i.getMin(),s=i.getMax(),r=i.getValue(),u=i.getAriaLabelledBy().join(" "),o=i.getAriaDescribedBy().join(" ");e["role"]="spinbutton";e["valuenow"]=r;if(typeof n==="number"){e["valuemin"]=n}if(typeof s==="number"){e["valuemax"]=s}if(o){e["describedby"]=o}if(u){e["labelledby"]=u}return e};I.writeInnerId=function(t,e){t.writeAttribute("id",e.getId()+"-"+I.getInnerSuffix(e))};I.getInnerSuffix=function(){return"inner"};I._getDescriptionSuffix=function(){return"-Descr"};var v=i.extend("sap.m.internal.NumericInput",{constructor:function(t,e){return i.apply(this,arguments)},renderer:I});_.prototype.init=function(){this._iRealPrecision=0;this._attachChange();this._bPaste=false};_.prototype.onBeforeRendering=function(){var t=this.getMin(),e=this.getMax(),i=this.getValue();this._iRealPrecision=this._getRealValuePrecision();this._getInput().setValue(this._getFormatedValue(i));if(this._isNumericLike(t)&&t>i){this.setValue(t)}if(this._isNumericLike(e)&&e<i){this.setValue(e)}this._disableButtons(i,e,t)};_.prototype.setProperty=function(t,e,i){this._writeAccessibilityState(t,e);n.prototype.setProperty.call(this,t,e,i);if(V.indexOf(t)>-1){this._getInput().setProperty(t,this.getProperty(t),i)}return this};_.prototype.setValidationMode=function(t){if(this.getValidationMode()!==t){switch(t){case sap.m.StepInputValidationMode.FocusOut:this._detachLiveChange();break;case sap.m.StepInputValidationMode.LiveChange:this._attachLiveChange();break}this.setProperty("validationMode",t)}return this};_.prototype.setMin=function(t){var e,i=this.getValue(),a=i!==0&&!i;if(t===undefined){return this.setProperty("min",t,true)}if(!this._validateOptionalNumberProperty("min",t)){return this}e=this.setProperty("min",t,a);this._disableButtons(i,this.getMax(),t);this._verifyValue();return e};_.prototype.setMax=function(t){var e,i=this.getValue(),a=i!==0&&!i;if(t===undefined){return this.setProperty("max",t,true)}if(!this._validateOptionalNumberProperty("max",t)){return this}e=this.setProperty("max",t,a);this._disableButtons(this.getValue(),t,this.getMin());this._verifyValue();return e};_.prototype._validateOptionalNumberProperty=function(e,i){if(this._isNumericLike(i)){return true}t.sap.log.error("The value of property '"+e+"' must be a number");return false};_.prototype.setDisplayValuePrecision=function(e){var i,a=this.getValue(),n=a!==0&&!a;if(b(e)){i=parseInt(e,10)}else{i=0;t.sap.log.warning(this+": ValuePrecision ("+e+") is not correct. It should be a number between 0 and 20! Setting the default ValuePrecision:0.")}return this.setProperty("displayValuePrecision",i,n)};_.prototype.setTooltip=function(t){this._getInput().setTooltip(t)};_.prototype._getIncrementButton=function(){return this.getAggregation("_incrementButton")};_.prototype._getDecrementButton=function(){return this.getAggregation("_decrementButton")};_.prototype._createIncrementButton=function(){var t,i=this,a=new e({src:s.getIconURI("add"),id:this.getId()+"-incrementBtn",noTabStop:true,press:this._handleButtonPress.bind(this,true),tooltip:_.STEP_INPUT_INCREASE_BTN_TOOLTIP});this.setAggregation("_incrementButton",a);t=this.getAggregation("_incrementButton");t.addEventDelegate({onAfterRendering:function(){t.$().attr("tabindex","-1");i._attachEvents(a,true)}});return t};_.prototype._createDecrementButton=function(){var t,i=this,a=new e({src:s.getIconURI("less"),id:this.getId()+"-decrementBtn",noTabStop:true,press:this._handleButtonPress.bind(this,false),tooltip:_.STEP_INPUT_DECREASE_BTN_TOOLTIP});this.setAggregation("_decrementButton",a);t=this.getAggregation("_decrementButton");t.addEventDelegate({onAfterRendering:function(){t.$().attr("tabindex","-1");i._attachEvents(a,false)}});return t};_.prototype._getIsDisabledButton=function(t){var e=this.getEnabled(),i=this.getMin(),a=this.getMax(),n=this.getValue(),s=false;switch(t){case"sapMStepInputBtnIncrease":s=!e||n>=a;break;case"sapMStepInputBtnDecrease":s=!e||n<=i;break}return s};_.prototype._getInput=function(){if(!this.getAggregation("_input")){var t=new v({id:this.getId()+"-input",textAlign:this.getTextAlign(),type:h.Number,editable:this.getEditable(),enabled:this.getEnabled(),description:this.getDescription(),fieldWidth:this.getFieldWidth(),liveChange:this._inputLiveChangeHandler});this.setAggregation("_input",t)}return this.getAggregation("_input")};_.prototype._handleButtonPress=function(t){var e=this._calculateNewValue(1,t),i=this.getMin(),a=this.getMax();this._btndown=undefined;this._disableButtons(e.displayValue,a,i);this.setValue(e.value);this._verifyValue();if(this._sOldValue!==this.getValue()){this.fireChange({value:this.getValue()})}this.$().focus();return this};_.prototype._disableButtons=function(t,e,i){if(!this.getDomRef()||!this._isNumericLike(t)){return}var a=this._isNumericLike(e),n=this._isNumericLike(i);if(this._getDecrementButton()){if(n&&i<t&&this.getEnabled()){this._getDecrementButton().$().removeClass("sapMStepInputIconDisabled")}if(n&&t<=i){this._getDecrementButton().$().addClass("sapMStepInputIconDisabled")}}if(this._getIncrementButton()){if(a&&t<e&&this.getEnabled()){this._getIncrementButton().$().removeClass("sapMStepInputIconDisabled")}if(a&&t>=e){this._getIncrementButton().$().addClass("sapMStepInputIconDisabled")}}return this};_.prototype.onfocusout=function(){this._verifyValue()};_.prototype._verifyValue=function(){var t=this.getMin(),e=this.getMax(),i=parseFloat(this._getInput().getValue());if(!this._isNumericLike(i)){return}if(this._isNumericLike(e)&&i>e||this._isNumericLike(t)&&i<t||this._areFoldChangeRequirementsFulfilled()&&i%this.getStep()!==0){this.setValueState(c.Error)}else{this.setValueState(c.None)}};_.prototype.setValue=function(t){var e;if(t==undefined){t=0}this._sOldValue=this.getValue();if(!this._validateOptionalNumberProperty("value",t)){return this}this._getInput().setValue(this._getFormatedValue(t));this._disableButtons(t,this.getMax(),this.getMin());e=this.setProperty("value",parseFloat(t),true);this._iRealPrecision=this._getRealValuePrecision();return e};_.prototype._getFormatedValue=function(t){var e=this.getDisplayValuePrecision(),i,a;if(t==undefined){t=this.getValue()}if(e<=0){return parseFloat(t).toFixed(0)}a=t.toString().split(".");if(a.length===2){i=a[1].length;if(i>e){return parseFloat(t).toFixed(e)}return a[0]+"."+this._padZeroesRight(a[1],e)}else{return t.toString()+"."+this._padZeroesRight("0",e)}};_.prototype._padZeroesRight=function(t,e){var i="",a=t.length;for(var n=a;n<e;n++){i=i+"0"}i=t+i;return i};_.prototype.onsappageup=function(t){this._applyValue(this._calculateNewValue(this.getLargerStep(),true).displayValue);this._verifyValue();t.preventDefault()};_.prototype.onsappagedown=function(t){this._applyValue(this._calculateNewValue(this.getLargerStep(),false).displayValue);this._verifyValue();t.preventDefault()};_.prototype.onsappageupmodifiers=function(t){if(this._isNumericLike(this.getMax())&&!(t.ctrlKey||t.metaKey||t.altKey)&&t.shiftKey){this._applyValue(this.getMax())}};_.prototype.onsappagedownmodifiers=function(t){if(this._isNumericLike(this.getMin())&&!(t.ctrlKey||t.metaKey||t.altKey)&&t.shiftKey){this._applyValue(this.getMin())}};_.prototype.onsapup=function(t){t.preventDefault();this._applyValue(this._calculateNewValue(1,true).displayValue);this._verifyValue()};_.prototype.onsapdown=function(t){t.preventDefault();this._applyValue(this._calculateNewValue(1,false).displayValue);this._verifyValue()};_.prototype.onkeydown=function(e){var i=false;this._bPaste=(e.ctrlKey||e.metaKey)&&e.which===t.sap.KeyCodes.V;if(e.which===t.sap.KeyCodes.ARROW_UP&&!e.altKey&&e.shiftKey&&(e.ctrlKey||e.metaKey)){this._applyValue(this.getMax());i=true}if(e.which===t.sap.KeyCodes.ARROW_DOWN&&!e.altKey&&e.shiftKey&&(e.ctrlKey||e.metaKey)){this._applyValue(this.getMin());i=true}if(e.which===t.sap.KeyCodes.ARROW_UP&&!(e.ctrlKey||e.metaKey||e.altKey)&&e.shiftKey){e.preventDefault();this._applyValue(this._calculateNewValue(this.getLargerStep(),true).displayValue);i=true}if(e.which===t.sap.KeyCodes.ARROW_DOWN&&!(e.ctrlKey||e.metaKey||e.altKey)&&e.shiftKey){e.preventDefault();this._applyValue(this._calculateNewValue(this.getLargerStep(),false).displayValue);i=true}if(i){this._verifyValue()}};_.prototype.onsapescape=function(t){this._getInput().onsapescape(t)};_.prototype._attachLiveChange=function(){this._getInput().attachLiveChange(this._liveChange,this)};_.prototype._detachLiveChange=function(){this._getInput().detachLiveChange(this._liveChange,this)};_.prototype._attachChange=function(){this._getInput().attachChange(this._change,this)};_.prototype._liveChange=function(){this._verifyValue();this._disableButtons(this._getInput().getValue(),this.getMax(),this.getMin())};_.prototype._change=function(t){this._sOldValue=this.getValue();this._verifyValue();this.setValue(this._getDefaultValue(this._getInput().getValue(),this.getMax(),this.getMin()));if(this._sOldValue!==this.getValue()&&!this._isButtonFocused()){this.fireChange({value:this.getValue()})}};_.prototype._applyValue=function(t){if(!this.getEditable()||!this.getEnabled()){return}this.getAggregation("_input")._$input.val(this._getFormatedValue(t))};_.prototype._calculateNewValue=function(t,e){var i=this.getStep(),a=this.getMax(),n=this.getMin(),s=this.getValue(),r=parseFloat(this._getDefaultValue(this._getInput().getValue(),a,n)),u=e?1:-1,o=Math.abs(i)*Math.abs(t),l=r+u*o,p,h,g=this.getDisplayValuePrecision();if(g>0){p=this._sumValues(r,o,u,g)}else{p=l}if(this._areFoldChangeRequirementsFulfilled()){l=p=h=this._calculateClosestFoldValue(r,o,u)}else{h=this._sumValues(s,o,u,this._iRealPrecision)}if(this._isNumericLike(a)&&l>=a){h=a;p=a}if(this._isNumericLike(n)&&l<=n){h=n;p=n}return{value:h,displayValue:p}};_.prototype._getRealValuePrecision=function(){var t=this.getValue().toString().split("."),e=this.getStep().toString().split("."),i,a;i=!t[1]?0:t[1].length;a=!e[1]?0:e[1].length;return i>a?i:a};_.prototype.setValueState=function(e){var i=false,a=false;switch(e){case c.Error:i=true;break;case c.Warning:a=true;break;case c.Success:case c.None:break;default:return this}this._getInput().setValueState(e);t.sap.delayedCall(0,this,function(){this.$().toggleClass("sapMStepInputError",i).toggleClass("sapMStepInputWarning",a)});this.setProperty("valueState",e,true);return this};_.prototype.setEditable=function(t){var e=_.prototype.setProperty.call(this,"editable",t);t=this.getEditable();if(this.getEditable()){this._getOrCreateDecrementButton().setVisible(true);this._getOrCreateIncrementButton().setVisible(true)}else{this._getDecrementButton()&&this._getDecrementButton().setVisible(false);this._getIncrementButton()&&this._getIncrementButton().setVisible(false)}return e};_.prototype._getOrCreateDecrementButton=function(){return this.getAggregation("_decrementButton")?this._getDecrementButton():this._createDecrementButton()};_.prototype._getOrCreateIncrementButton=function(){return this.getAggregation("_incrementButton")?this._getIncrementButton():this._createIncrementButton()};_.prototype._inputLiveChangeHandler=function(t){var e=this.getParent()._restrictCharsWhenDecimal(t);this.setProperty("value",e?e:t.getParameter("newValue"),true)};_.prototype._restrictCharsWhenDecimal=function(t){var e=t.getParameter("value").indexOf("."),i=this.getDisplayValuePrecision(),a;if(e>0&&i>0){var n=t.getParameter("value"),s=n.split(".")[1],r=s?s.length:0,u=t.getSource().getProperty("value"),o=n.split(".")[0],l=u.substring(u.indexOf(".")+1,u.length);if(!this._bPaste){if(r>i){a=o+"."+l;this._showWrongValueVisualEffect()}}else{if(n.indexOf(".")){a=n.split(".")[0]+"."+s.substring(0,i)}this._bPaste=false}}this._getInput().updateDomValue(a);return a};_.prototype._showWrongValueVisualEffect=function(){var e=this.getValueState();if(e===c.Error){return}this.setValueState(c.Error);t.sap.delayedCall(1e3,this,"setValueState",[e])};_.prototype._getDefaultValue=function(t,e,i){if(t!==""&&t!==undefined){return this._getInput().getValue()}if(this._isNumericLike(i)&&i>0){return i}else if(this._isNumericLike(e)&&e<0){return e}else{return 0}};_.prototype._isNumericLike=function(t){return!isNaN(t)&&t!==null&&t!==""};_.prototype._isInteger=function(t){return t===parseInt(t,10)};_.prototype._writeAccessibilityState=function(t,e){var i=this._getInput().getDomRef(I.getInnerSuffix());if(!i){return}if(t&&m[t]){i.setAttribute(m[t],e)}};_.prototype._isButtonFocused=function(){return document.activeElement===this.getAggregation("_incrementButton").getDomRef()||document.activeElement===this.getAggregation("_decrementButton").getDomRef()};_.prototype._sumValues=function(t,e,i,a){var n=Math.pow(10,a);return(parseInt(t*n,10)+i*parseInt(e*n,10))/n};_.prototype._areFoldChangeRequirementsFulfilled=function(){return this.getStepMode()===f.Multiple&&this.getDisplayValuePrecision()===0&&this._isInteger(this.getStep())&&this._isInteger(this.getLargerStep())};_.prototype._calculateClosestFoldValue=function(e,i,a){var n=Math.floor(e),s=i;do{n+=a;s--}while(n%i!==0&&s);if(n%i!==0){t.sap.log.error("Wrong next/previous value "+n+" for "+e+", step: "+i+" and sign: "+a,this)}return n};function b(t){return typeof t==="number"&&!isNaN(t)&&t>=0&&t<=20}_.prototype._calcWaitTimeout=function(){this._speed*=_.ACCELLERATION;this._waitTimeout=this._waitTimeout-this._speed<_.MIN_WAIT_TIMEOUT?_.MIN_WAIT_TIMEOUT:this._waitTimeout-this._speed;return this._waitTimeout};_.prototype._spinValues=function(t){var e=this;if(this._btndown){this._spinTimeoutId=setTimeout(function(){if(e._btndown){var i=e._calculateNewValue(1,t);e.setValue(i.value);if(e._getIsDisabledButton("sapMStepInputBtnIncrease")||e._getIsDisabledButton("sapMStepInputBtnDecrease")){S.call(e);e.fireChange({value:e.getValue()})}e._spinValues(t)}},e._calcWaitTimeout())}};_.prototype._attachEvents=function(t,e){var i=this;var a={onmousedown:function(t){if(t.button===0&&!i._btndown){i._waitTimeout=_.INITIAL_WAIT_TIMEOUT;i._speed=_.INITIAL_SPEED;i._btndown=true;i._spinValues(e)}},onmouseup:function(t){if(i._btndown){S.call(i)}},onmouseout:function(t){if(i._btndown){S.call(i);i.fireChange({value:i.getValue()})}},oncontextmenu:function(t){t.stopImmediatePropagation(true);t.preventDefault();t.stopPropagation()}};t.addDelegate(a,true)};function S(){if(this._btndown){this._btndown=undefined;clearTimeout(this._spinTimeoutId);this._waitTimeout=500;this._speed=120}}return _});