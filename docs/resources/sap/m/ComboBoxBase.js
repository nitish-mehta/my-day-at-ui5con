/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./Dialog","./ComboBoxTextField","./Toolbar","./Button","./Bar","./Text","./Title","sap/ui/core/InvisibleText","sap/ui/core/IconPool","sap/ui/core/ValueStateSupport","./library","sap/ui/Device","sap/ui/core/library","./ComboBoxBaseRenderer","jquery.sap.keycodes"],function(t,e,i,s,o,n,r,a,l,u,p,h,c,d,g){"use strict";var y=h.PlacementType;var f=d.ValueState;var m=i.extend("sap.m.ComboBoxBase",{metadata:{library:"sap.m",abstract:true,defaultAggregation:"items",aggregations:{items:{type:"sap.ui.core.Item",multiple:true,singularName:"item",bindable:"bindable"},picker:{type:"sap.ui.core.PopupInterface",multiple:false,visibility:"hidden"}},events:{loadItems:{}}}});m.prototype.updateItems=function(t){this.bItemsUpdated=false;this.destroyItems();this.updateAggregation("items");this.bItemsUpdated=true;if(this.hasLoadItemsEventListeners()){this.onItemsLoaded()}};m.prototype.refreshItems=function(){this.bItemsUpdated=false;this.refreshAggregation("items")};m.prototype.loadItems=function(e,i){var s=typeof e==="function";if(this.hasLoadItemsEventListeners()&&this.getItems().length===0){this._bOnItemsLoadedScheduled=false;if(s){i=t.extend({action:e,busyIndicator:true,busyIndicatorDelay:300},i);this.aMessageQueue.push(i);if(this.iLoadItemsEventInitialProcessingTimeoutID===-1&&i.busyIndicator){this.iLoadItemsEventInitialProcessingTimeoutID=setTimeout(function t(){this.setInternalBusyIndicatorDelay(0);this.setInternalBusyIndicator(true)}.bind(this),i.busyIndicatorDelay)}}if(!this.bProcessingLoadItemsEvent){this.bProcessingLoadItemsEvent=true;this.fireLoadItems()}}else if(s){e.call(this)}};m.prototype.onItemsLoaded=function(){this.bProcessingLoadItemsEvent=false;clearTimeout(this.iLoadItemsEventInitialProcessingTimeoutID);if(this.bInitialBusyIndicatorState!==this.getBusy()){this.setInternalBusyIndicator(this.bInitialBusyIndicatorState)}if(this.iInitialBusyIndicatorDelay!==this.getBusyIndicatorDelay()){this.setInternalBusyIndicatorDelay(this.iInitialBusyIndicatorDelay)}for(var t=0,e,i,s;t<this.aMessageQueue.length;t++){e=this.aMessageQueue.shift();t--;s=t+1===this.aMessageQueue.length;i=s?null:this.aMessageQueue[t+1];if(typeof e.action==="function"){if(e.name==="input"&&!s&&i.name==="input"){continue}e.action.call(this)}}};m.prototype.hasLoadItemsEventListeners=function(){return this.hasListeners("loadItems")};m.prototype._scheduleOnItemsLoadedOnce=function(){if(!this._bOnItemsLoadedScheduled&&!this.isBound("items")&&this.hasLoadItemsEventListeners()&&this.bProcessingLoadItemsEvent){this._bOnItemsLoadedScheduled=true;setTimeout(this.onItemsLoaded.bind(this),0)}};m.prototype.getPickerInvisibleTextId=function(){return l.getStaticId("sap.m","COMBOBOX_AVAILABLE_OPTIONS")};m.prototype.init=function(){i.prototype.init.apply(this,arguments);this.setPickerType(c.system.phone?"Dialog":"Dropdown");if(c.system.phone){this.attachEvent("_change",this.onPropertyChange,this)}this.createPicker(this.getPickerType());this.bItemsUpdated=false;this.bOpenedByKeyboardOrButton=false;this._oPickerValueStateText=null;this.bProcessingLoadItemsEvent=false;this.iLoadItemsEventInitialProcessingTimeoutID=-1;this.aMessageQueue=[];this.bInitialBusyIndicatorState=this.getBusy();this.iInitialBusyIndicatorDelay=this.getBusyIndicatorDelay();this._bOnItemsLoadedScheduled=false;this._bDoTypeAhead=true};m.prototype.onBeforeRendering=function(){var t=this.getValueState()===f.None;i.prototype.onBeforeRendering.apply(this,arguments);if(!this.isPickerDialog()&&t){this._showValueStateText(false)}};m.prototype.exit=function(){i.prototype.exit.apply(this,arguments);if(this.getList()){this.getList().destroy();this._oList=null}if(this._oPickerValueStateText){this._oPickerValueStateText.destroy()}clearTimeout(this.iLoadItemsEventInitialProcessingTimeoutID);this.aMessageQueue=null};m.prototype.ontouchstart=function(t){if(!this.getEnabled()||!this.getEditable()){return}t.setMarked();if(this.isOpenArea(t.target)){this.addStyleClass(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Pressed")}};m.prototype.ontouchend=function(t){if(!this.getEnabled()||!this.getEditable()){return}t.setMarked();if(!this.isOpen()&&this.isOpenArea(t.target)){this.removeStyleClass(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Pressed")}};m.prototype.ontap=function(t){i.prototype.ontap.apply(this,arguments);var e=this.getRenderer().CSS_CLASS_COMBOBOXBASE,s=t.srcControl,o;if(!this.getEnabled()||!this.getEditable()){return}t.setMarked();if(s.isOpenArea&&s.isOpenArea(t.target)){if(this.isOpen()){this.close();this.removeStyleClass(e+"Pressed");return}this.loadItems();this.bOpenedByKeyboardOrButton=true;if(this.isPlatformTablet()){o=this.getPicker();o.setInitialFocus(o)}this.open()}if(this.isOpen()){this.addStyleClass(e+"Pressed")}};m.prototype.onsapshow=function(e){if(!this.getEnabled()||!this.getEditable()){return}e.setMarked();if(e.keyCode===t.sap.KeyCodes.F4){this.onF4(e)}if(this.isOpen()){this.close();return}this.selectText(0,this.getValue().length);this.loadItems();this.bOpenedByKeyboardOrButton=true;this.open()};m.prototype.onF4=function(t){t.preventDefault()};m.prototype.onsapescape=function(t){if(this.getEnabled()&&this.getEditable()&&this.isOpen()){t.setMarked();t.preventDefault();this.close()}else{i.prototype.onsapescape.apply(this,arguments)}};m.prototype.onsaphide=m.prototype.onsapshow;m.prototype.onsapfocusleave=function(e){if(!e.relatedControlId){i.prototype.onsapfocusleave.apply(this,arguments);return}var s=sap.ui.getCore().byId(e.relatedControlId);if(s===this){return}var o=this.getAggregation("picker"),n=s&&s.getFocusDomRef();if(o&&t.sap.containsOrEquals(o.getFocusDomRef(),n)){return}i.prototype.onsapfocusleave.apply(this,arguments)};m.prototype.getPopupAnchorDomRef=function(){return this.getDomRef()};m.prototype.addContent=function(t){};m.prototype.getList=function(){if(this.bIsDestroyed){return null}return this._oList};m.prototype.setPickerType=function(t){this._sPickerType=t};m.prototype.getPickerType=function(){return this._sPickerType};m.prototype.setValueState=function(t){var e,s=this.getValueStateText(),o=t===f.None?false:this.getShowValueStateMessage();this._sOldValueState=this.getValueState();i.prototype.setValueState.apply(this,arguments);this._showValueStateText(o);if(s){this._setValueStateText(s)}else{e=p.getAdditionalText(this);this._setValueStateText(e)}this._alignValueStateStyles();return this};m.prototype.setValueStateText=function(t){i.prototype.setValueStateText.apply(this,arguments);this._setValueStateText(this.getValueStateText());return this};m.prototype.setShowValueStateMessage=function(t){i.prototype.setShowValueStateMessage.apply(this,arguments);this._showValueStateText(this.getShowValueStateMessage());return this};m.prototype._showValueStateText=function(t){var e;if(this.isPickerDialog()){if(this._oPickerValueStateText){this._oPickerValueStateText.setVisible(t)}}else{e=this._getPickerCustomHeader();if(e){e.setVisible(t)}}};m.prototype._setValueStateText=function(t){var e;if(this.isPickerDialog()){this._oPickerValueStateText=this.getPickerValueStateText();this._oPickerValueStateText.setText(t)}else{e=this._getPickerCustomHeader();if(e){e.getContentLeft()[0].setText(t)}}};m.prototype._getPickerCustomHeader=function(){var t,e,i=this.getPicker(),s=this.getRenderer().CSS_CLASS_COMBOBOXBASE+"PickerTitle";if(!i){return null}if(i.getCustomHeader()){return i.getCustomHeader()}t=new a({textAlign:"Left"}).addStyleClass(s);e=new n({visible:false,contentLeft:t});i.setCustomHeader(e);return e};m.prototype._alignValueStateStyles=function(){var t=this._sOldValueState,e=this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Picker",i=e+"ValueState",s=e+t+"State",o=e+this.getValueState()+"State",n;if(this.isPickerDialog()&&this._oPickerValueStateText){this._oPickerValueStateText.addStyleClass(i);this._oPickerValueStateText.removeStyleClass(s);this._oPickerValueStateText.addStyleClass(o)}else{n=this._getPickerCustomHeader();if(n){n.addStyleClass(i);n.removeStyleClass(s);n.addStyleClass(o)}}};m.prototype.shouldValueStateMessageBeOpened=function(){var t=i.prototype.shouldValueStateMessageBeOpened.apply(this,arguments);return t&&!this.isOpen()};m.prototype.onPropertyChange=function(t,e){var i=t.getParameter("newValue"),s=t.getParameter("name"),o="set"+s.charAt(0).toUpperCase()+s.slice(1),n=e&&e.srcControl||this.getPickerTextField();if(/\bvalue\b|\benabled\b|\bname\b|\bplaceholder\b|\beditable\b|\btextAlign\b|\btextDirection\b|\bvalueState\b/.test(s)&&n&&typeof n[o]==="function"){n[o](i)}};m.prototype.isPickerDialog=function(){return this.getPickerType()==="Dialog"};m.prototype.isPlatformTablet=function(){var t=!c.system.combi,e=c.system.tablet&&t;return e};m.prototype.getDropdownSettings=function(){return{showArrow:false,placement:y.VerticalPreferredBottom,offsetX:0,offsetY:0,bounce:false,ariaLabelledBy:this.getPickerInvisibleTextId()||undefined}};m.prototype.getPickerValueStateText=function(){var t=this.getPicker();if(!this._oPickerValueStateText){this._oPickerValueStateText=new r({width:"100%"});t.insertContent(this._oPickerValueStateText,0)}return this._oPickerValueStateText};m.prototype.createPicker=function(t){};m.prototype.onBeforeClose=function(){this.bOpenedByKeyboardOrButton=false};m.prototype.getPicker=function(){if(this.bIsDestroyed){return null}return this.createPicker(this.getPickerType())};m.prototype.getPickerTextField=function(){var t=this.getPicker(),e=t.getSubHeader();return e&&e.getContent()[0]||null};m.prototype.getPickerTitle=function(){var t=this.getPicker(),e=t&&t.getCustomHeader();if(this.isPickerDialog()&&e){return e.getContentMiddle()[0]}return null};m.prototype.createDialog=function(){var t=this,i=this.createPickerTextField(),o=i._handleEvent;i._handleEvent=function(e){o.apply(this,arguments);if(/keydown|sapdown|sapup|saphome|sapend|sappagedown|sappageup|input/.test(e.type)){t._handleEvent(e)}};return new e({stretch:true,customHeader:t.createPickerHeader(),buttons:this.createPickerCloseButton(),subHeader:new s({content:i}),beforeOpen:function(){t.updatePickerHeaderTitle()},ariaLabelledBy:t.getPickerInvisibleTextId()||undefined})};m.prototype.createPickerHeader=function(){var t=this,e=u.getIconURI("decline");return new n({contentMiddle:new a,contentRight:new o({icon:e,press:function(){t.close();t.revertSelection()}})})};m.prototype.revertSelection=function(){};m.prototype.updatePickerHeaderTitle=function(){var t=this.getPicker(),e=sap.ui.getCore().getLibraryResourceBundle("sap.m"),i,s;if(!t){return}s=this.getLabels();if(s.length){i=s[0];if(i&&typeof i.getText==="function"){this.getPickerTitle().setText(i.getText())}}else{this.getPickerTitle().setText(e.getText("COMBOBOX_PICKER_TITLE"))}};m.prototype.createPickerCloseButton=function(){var t=this,e,i=sap.ui.getCore().getLibraryResourceBundle("sap.m");return new o({text:i.getText("COMBOBOX_CLOSE_BUTTON"),press:function(){e=t.getPickerTextField();t.updateDomValue(e.getValue());t.onChange();t.close()}})};m.prototype.hasContent=function(){return this.getItems().length>0};m.prototype.findFirstEnabledItem=function(t){var e=this.getList();return e?e.findFirstEnabledItem(t):null};m.prototype.findLastEnabledItem=function(t){var e=this.getList();return e?e.findLastEnabledItem(t):null};m.prototype.open=function(){var t=this.getPicker();if(t){t.open()}return this};m.prototype.getVisibleItems=function(){var t=this.getList();return t?t.getVisibleItems():[]};m.prototype.isItemSelected=function(){};m.prototype.getKeys=function(t){t=t||this.getItems();for(var e=0,i=[];e<t.length;e++){i[e]=t[e].getKey()}return i};m.prototype.getSelectableItems=function(){var t=this.getList();return t?t.getSelectableItems():[]};m.prototype.findItem=function(t,e){var i=this.getList();return i?i.findItem(t,e):null};m.prototype.getItemByText=function(t){return this.findItem("text",t)};m.prototype.scrollToItem=function(t){var e=this.getPicker(),i=e.getDomRef("cont"),s=t&&t.getDomRef();if(!e||!i||!s){return}var o=i.scrollTop,n=s.offsetTop,r=i.clientHeight,a=s.offsetHeight;if(o>n){i.scrollTop=n}else if(n+a>o+r){i.scrollTop=Math.ceil(n+a-r)}};m.prototype.clearFilter=function(){for(var t=0,e=this.getItems();t<e.length;t++){e[t].bVisible=true}};m.prototype.onItemChange=function(t){};m.prototype.clearSelection=function(){};m.prototype.setInternalBusyIndicator=function(t){this.bInitialBusyIndicatorState=this.getBusy();return this.setBusy.apply(this,arguments)};m.prototype.setInternalBusyIndicatorDelay=function(t){this.iInitialBusyIndicatorDelay=this.getBusyIndicatorDelay();return this.setBusyIndicatorDelay.apply(this,arguments)};m.prototype.addItem=function(t){this.addAggregation("items",t);if(t){t.attachEvent("_change",this.onItemChange,this)}this._scheduleOnItemsLoadedOnce();return this};m.prototype.insertItem=function(t,e){this.insertAggregation("items",t,e,true);if(t){t.attachEvent("_change",this.onItemChange,this)}this._scheduleOnItemsLoadedOnce();return this};m.prototype.getItemAt=function(t){return this.getItems()[+t]||null};m.prototype.getFirstItem=function(){return this.getItems()[0]||null};m.prototype.getLastItem=function(){var t=this.getItems();return t[t.length-1]||null};m.prototype.getEnabledItems=function(t){var e=this.getList();return e?e.getEnabledItems(t):[]};m.prototype.getItemByKey=function(t){var e=this.getList();return e?e.getItemByKey(t):null};m.prototype.isOpen=function(){var t=this.getAggregation("picker");return!!(t&&t.isOpen())};m.prototype.close=function(){var t=this.getAggregation("picker");if(t){t.close()}return this};m.prototype.removeItem=function(t){var e=this.getList();t=e?e.removeItem(t):null;if(t){t.detachEvent("_change",this.onItemChange,this)}return t};m.prototype.removeAllItems=function(){var t=this.getList(),e=t?t.removeAllItems():[];this.clearSelection();for(var i=0;i<e.length;i++){e[i].detachEvent("_change",this.onItemChange,this)}return e};m.prototype.destroyItems=function(){var t=this.getList();if(t){t.destroyItems()}return this};return m});