/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./Bar","./Button","./InstanceManager","./library","sap/ui/core/Control","sap/ui/core/Popup","sap/ui/core/delegate/ScrollEnablement","sap/ui/core/theming/Parameters","sap/ui/Device","sap/ui/base/ManagedObject","sap/ui/core/library","sap/ui/core/Element","sap/ui/core/ResizeHandler","./PopoverRenderer","jquery.sap.keycodes"],function(t,e,o,i,r,s,n,a,l,h,f,p,g,c,u){"use strict";var _=r.PopupHelper;var d=p.OpenState;var m=r.PlacementType;var v=s.extend("sap.m.Popover",{metadata:{interfaces:["sap.ui.core.PopupInterface"],library:"sap.m",properties:{placement:{type:"sap.m.PlacementType",group:"Behavior",defaultValue:m.Right},showHeader:{type:"boolean",group:"Appearance",defaultValue:true},title:{type:"string",group:"Appearance",defaultValue:null},modal:{type:"boolean",group:"Behavior",defaultValue:false},offsetX:{type:"int",group:"Appearance",defaultValue:0},offsetY:{type:"int",group:"Appearance",defaultValue:0},showArrow:{type:"boolean",group:"Appearance",defaultValue:true},contentWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},contentMinWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:""},contentHeight:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},enableScrolling:{type:"boolean",group:"Misc",defaultValue:true,deprecated:true},verticalScrolling:{type:"boolean",group:"Misc",defaultValue:true},horizontalScrolling:{type:"boolean",group:"Misc",defaultValue:true},bounce:{type:"boolean",group:"Behavior",defaultValue:null},resizable:{type:"boolean",group:"Dimension",defaultValue:false}},defaultAggregation:"content",aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"},customHeader:{type:"sap.ui.core.Control",multiple:false},subHeader:{type:"sap.ui.core.Control",multiple:false},footer:{type:"sap.ui.core.Control",multiple:false},_internalHeader:{type:"sap.m.Bar",multiple:false,visibility:"hidden"},beginButton:{type:"sap.ui.core.Control",multiple:false},endButton:{type:"sap.ui.core.Control",multiple:false}},associations:{leftButton:{type:"sap.m.Button",multiple:false,deprecated:true},rightButton:{type:"sap.m.Button",multiple:false,deprecated:true},initialFocus:{type:"sap.ui.core.Control",multiple:false},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"}},events:{afterOpen:{parameters:{openBy:{type:"sap.ui.core.Control"}}},afterClose:{parameters:{openBy:{type:"sap.ui.core.Control"}}},beforeOpen:{parameters:{openBy:{type:"sap.ui.core.Control"}}},beforeClose:{parameters:{openBy:{type:"sap.ui.core.Control"}}}},designtime:"sap/m/designtime/Popover.designtime"}});v._bIE9=h.browser.internet_explorer&&h.browser.version<10;v._bIOS7=h.os.ios&&h.os.version>=7&&h.os.version<8&&h.browser.name==="sf";v.prototype.init=function(){this._arrowOffsetThreshold=4;this._marginTopInit=false;this._marginTop=48;this._marginLeft=10;this._marginRight=10;this._marginBottom=10;this._$window=t(window);this._initialWindowDimensions={};this.oPopup=new n;this.oPopup.setShadow(true);this.oPopup.setAutoClose(true);this.oPopup.setAnimations(t.proxy(this._openAnimation,this),t.proxy(this._closeAnimation,this));this._placements=[m.Top,m.Right,m.Bottom,m.Left,m.Vertical,m.Horizontal,m.Auto,m.VerticalPreferedTop,m.VerticalPreferedBottom,m.HorizontalPreferedLeft,m.HorizontalPreferedRight,m.VerticalPreferredTop,m.VerticalPreferredBottom,m.HorizontalPreferredLeft,m.HorizontalPreferredRight,m.PreferredRightOrFlip,m.PreferredLeftOrFlip,m.PreferredTopOrFlip,m.PreferredBottomOrFlip];this._myPositions=["center bottom","begin center","center top","end center"];this._atPositions=["center top","end center","center bottom","begin center"];this._offsets=["0 -18","18 0","0 18","-18 0"];this._arrowOffset=18;this._followOfTolerance=32;this._scrollContentList=[sap.m.NavContainer,sap.m.Page,sap.m.ScrollContainer];this._fnAdjustPositionAndArrow=t.proxy(this._adjustPositionAndArrow,this);this._fnOrientationChange=t.proxy(this._onOrientationChange,this);this._fnFollowOf=t.proxy(function(t){var e=t.lastOfRect,o=t.currentOfRect;if(!h.system.desktop||Math.abs(e.top-o.top)<=this._followOfTolerance&&Math.abs(e.left-o.left)<=this._followOfTolerance||Math.abs(e.top+e.height-o.top-o.height)<=this._followOfTolerance&&Math.abs(e.left+e.width-o.left-o.width)<=this._followOfTolerance){this.oPopup._applyPosition(this.oPopup._oLastPosition,true)}else{this.close()}},this);this.setFollowOf(true);this._oRestoreFocusDelegate={onBeforeRendering:function(){var e=t(document.activeElement),o=e.control(0);this._sFocusControlId=o&&o.getId()},onAfterRendering:function(){if(this._sFocusControlId&&!t.sap.containsOrEquals(this.getDomRef(),document.activeElement)){sap.ui.getCore().byId(this._sFocusControlId).focus()}}};var e=this;this.oPopup._applyPosition=function(o,i){var r=this.getOpenState(),s;if(r===d.CLOSING||r===d.CLOSED){return}if(i){e._storeScrollPosition()}e._clearCSSStyles();var a=t.inArray(e.getPlacement(),e._placements);if(a>3&&!e._bPosCalced){e._calcPlacement();return}e._bPosCalced=false;if(e._oOpenBy instanceof g){o.of=e._getOpenByDomRef()}if(!o.of){t.sap.log.warning("sap.m.Popover: in function applyPosition, the openBy element doesn't have any DOM output. "+e);return}if(!t.sap.containsOrEquals(document.documentElement,o.of)&&o.of.id){s=t.sap.byId(o.of.id);if(s){o.of=s}else{t.sap.log.warning("sap.m.Popover: in function applyPosition, the openBy element's DOM is already detached from DOM tree and can't be found again by the same id. "+e);return}}var l=t(o.of).rect();if(i&&e._$window.height()==e._initialWindowDimensions.height&&(l.top+l.height<=0||l.top>=e._$window.height()||l.left+l.width<=0||l.left>=e._$window.width())){e.close();return}var f=e.getDomRef("scroll");if(!h.system.desktop){t(window).scrollLeft(0)}e._deregisterContentResizeHandler();n.prototype._applyPosition.call(this,o);e._fnAdjustPositionAndArrow();e._restoreScrollPosition();e._registerContentResizeHandler(f)};this.oPopup.close=function(t){var o=typeof t==="boolean";var i=e.oPopup.getOpenState();if(t!==true&&(this.touchEnabled||!this._isFocusInsidePopup())&&this.isOpen()&&!(i===d.CLOSED||i===d.CLOSING)){e.fireBeforeClose({openBy:e._oOpenBy})}e._deregisterContentResizeHandler();n.prototype.close.apply(this,o?[]:arguments);e.removeDelegate(e._oRestoreFocusDelegate)}};v.prototype.onBeforeRendering=function(){var e,o;if(!this._initialWindowDimensions.width||!this._initialWindowDimensions.height){this._initialWindowDimensions={width:this._$window.width(),height:this._$window.height()}}if(!this.getHorizontalScrolling()&&!this.getVerticalScrolling()){this._forceDisableScrolling=true}else if(!this._bVScrollingEnabled&&!this._bHScrollingEnabled&&this._hasSingleScrollableContent()){this._forceDisableScrolling=true;t.sap.log.info("VerticalScrolling and horizontalScrolling in sap.m.Popover with ID "+this.getId()+" has been disabled because there's scrollable content inside")}else{this._forceDisableScrolling=false}if(!this._forceDisableScrolling){if(!this._oScroller){this._oScroller=new a(this,this.getId()+"-scroll",{horizontal:this.getHorizontalScrolling(),vertical:this.getVerticalScrolling()})}}if(this._bContentChanged){this._bContentChanged=false;e=this._getSingleNavContent();o=this._getSinglePageContent();if(e&&!this.getModal()&&!h.support.touch&&!t.sap.simulateMobileOnDesktop){e.attachEvent("afterNavigate",function(e){t.sap.focus(this.getDomRef())},this)}if(e||o){o=o||e.getCurrentPage();if(o&&o._getAnyHeader){this.addStyleClass("sapMPopoverWithHeaderCont")}if(e){e.attachEvent("navigate",function(t){var e=t.getParameter("to");if(e instanceof sap.m.Page){this.$().toggleClass("sapMPopoverWithHeaderCont",!!e._getAnyHeader())}},this)}}}};v.prototype.onAfterRendering=function(){var e,o,i;if(!this._marginTopInit&&this.getShowArrow()){this._marginTop=2;if(this._oOpenBy){e=t(this._getOpenByDomRef());if(!(e.closest("header.sapMIBar").length>0)){o=e.closest(".sapMPage");if(o.length>0){i=o.children("header.sapMIBar");if(i.length>0){this._marginTop+=i.outerHeight()}}}this._marginTopInit=true}}};v.prototype.exit=function(){this._deregisterContentResizeHandler();h.resize.detachHandler(this._fnOrientationChange);i.removePopoverInstance(this);this.removeDelegate(this._oRestoreFocusDelegate);this._oRestoreFocusDelegate=null;if(this.oPopup){this.oPopup.detachClosed(this._handleClosed,this);this.oPopup.destroy();this.oPopup=null}if(this._oScroller){this._oScroller.destroy();this._oScroller=null}if(this._internalHeader){this._internalHeader.destroy();this._internalHeader=null}if(this._headerTitle){this._headerTitle.destroy();this._headerTitle=null}};v.prototype.openBy=function(e,o){var s=this.oPopup,a=this.oPopup.getOpenState(),f=this._getInitialFocusId(),p,g,c,u;p=e.getDomRef&&e.getDomRef()||e;u=t(p).closest(".sapUiSizeCompact");c=l.get("_sap_m_Popover_ForceCompactArrowOffset")==="true";this._bSizeCompact=r._bSizeCompact||!!u.length||this.hasStyleClass("sapUiSizeCompact");this._bUseCompactArrow=this._bSizeCompact||c;this._adaptPositionParams();if(a===d.OPEN||a===d.OPENING){if(this._oOpenBy===e){return this}else{var _=function(){s.detachClosed(_,this);this.openBy(e)};s.attachClosed(_,this);this.close();return this}}if(!e){return this}if(h.support.touch){h.resize.attachHandler(this._fnOrientationChange)}if(!this._oOpenBy||e!==this._oOpenBy){this._oOpenBy=e}this.fireBeforeOpen({openBy:this._oOpenBy});s.attachOpened(this._handleOpened,this);s.attachClosed(this._handleClosed,this);s.setInitialFocusId(f);g=t.inArray(this.getPlacement(),this._placements);if(g>-1){p=this._getOpenByDomRef();if(!p){t.sap.log.error("sap.m.Popover id = "+this.getId()+": is opened by a control which isn't rendered yet.");return this}s.setAutoCloseAreas([e]);s.setContent(this);if(g<=3){s.setPosition(this._myPositions[g],this._atPositions[g],p,this._calcOffset(this._offsets[g]),"fit")}else{s._oPosition.of=p}var m=this;var v=function(){if(s.getOpenState()===d.CLOSING){if(m._sOpenTimeout){clearTimeout(m._sOpenTimeout);m._sOpenTimeout=null}m._sOpenTimeout=setTimeout(v,150)}else{m._oPreviousFocus=n.getCurrentFocusInfo();s.open();m.addDelegate(m._oRestoreFocusDelegate,m);if(!o){i.addPopoverInstance(m)}}};v()}else{t.sap.log.error(this.getPlacement()+"is not a valid value! It can only be top, right, bottom or left")}return this};v.prototype.close=function(){var t=this.oPopup.getOpenState(),e,o;if(t===d.CLOSED||t===d.CLOSING){return this}this.fireBeforeClose({openBy:this._oOpenBy});this.oPopup.close(true);if(this._oPreviousFocus){o=document.activeElement||{};e=this._oPreviousFocus.sFocusId===sap.ui.getCore().getCurrentFocusedControlId()||this._oPreviousFocus.sFocusId===o.id;if(!e){n.applyFocusInfo(this._oPreviousFocus);this._oPreviousFocus=null}}return this};v.prototype.isOpen=function(){return this.oPopup&&this.oPopup.isOpen()};v.prototype.setFollowOf=function(t){if(t){this.oPopup.setFollowOf(this._fnFollowOf)}else{this.oPopup.setFollowOf(false)}return this};v.prototype._clearCSSStyles=function(){var t=this.getDomRef().style,e=this.$("cont"),o=e.children(".sapMPopoverScroll"),i=e[0].style,r=o[0].style,s=this.getContentWidth(),n=this.getContentHeight(),a=this.$("arrow"),l,h;if(s.indexOf("%")>0){l=this._$window.width();s=_.calcPercentageSize(s,l)}if(n.indexOf("%")>0){h=this._$window.height();n=_.calcPercentageSize(n,h)}i.width=s||"";i.height=n||"";i.maxWidth="";i.maxHeight="";t.left="";t.right="";t.top="";t.bottom="";t.width="";t.height="";r.width="";r.display="";a.removeClass("sapMPopoverArrRight sapMPopoverArrLeft sapMPopoverArrDown sapMPopoverArrUp sapMPopoverCrossArr sapMPopoverFooterAlignArr sapMPopoverHeaderAlignArr sapContrast sapContrastPlus");a.css({left:"",top:""})};v.prototype._onOrientationChange=function(){var t=this.oPopup.getOpenState();if(!(t===d.OPEN||t===d.OPENING)){return}this.oPopup._applyPosition(this.oPopup._oLastPosition,true)};v.prototype._handleOpened=function(){var e=this;this.oPopup.detachOpened(this._handleOpened,this);if(!h.support.touch){setTimeout(function(){!e.bIsDestroyed&&h.resize.attachHandler(e._fnOrientationChange)},0)}var o=this._getInitialFocusId(),i=sap.ui.getCore().byId(o);t.sap.focus(i?i.getFocusDomRef():t.sap.domById(o));this.fireAfterOpen({openBy:this._oOpenBy})};v.prototype._handleClosed=function(){this.oPopup.detachClosed(this._handleClosed,this);h.resize.detachHandler(this._fnOrientationChange);i.removePopoverInstance(this);if(!this.oPopup._bModal&&!h.system.desktop&&document.activeElement&&!t(document.activeElement).is(":visible")){document.activeElement.blur()}this.fireAfterClose({openBy:this._oOpenBy})};v.prototype.onfocusin=function(e){var o=e.target,i=this.$();if(o.id===this.getId()+"-firstfe"){var r=i.lastFocusableDomRef();t.sap.focus(r)}else if(o.id===this.getId()+"-lastfe"){var s=i.firstFocusableDomRef();t.sap.focus(s)}};v.prototype.onkeydown=function(e){var o=t.sap.KeyCodes,i=e.which||e.keyCode,r=e.altKey;if(i===o.ESCAPE||r&&i===o.F4){if(e.originalEvent&&e.originalEvent._sapui_handledByControl){return}this.close();e.stopPropagation();e.preventDefault()}};v.prototype.onmousedown=function(e){var o={width:400,height:128};var i=sap.ui.getCore().getConfiguration().getRTL();if(!e.target.classList.contains("sapMPopoverResizeHandle")){return}var r=t(document);var s=this.$();var n=this;s.addClass("sapMPopoverResizing");e.preventDefault();e.stopPropagation();var a={x:e.pageX,y:e.pageY,width:s.width(),height:s.height()};r.on("mousemove.sapMPopover",function(t){var e,r;if(i){e=a.width+a.x-t.pageX;r=a.height+(a.y-t.pageY)}else{e=a.width+t.pageX-a.x;r=a.height+(a.y-t.pageY)}n.setContentWidth(Math.max(e,o.width)+"px");n.setContentHeight(Math.max(r,o.height)+"px")});r.on("mouseup.sapMPopover",function(){s.removeClass("sapMPopoverResizing");r.off("mouseup.sapMPopover, mousemove.sapMPopover")})};v.prototype._hasSingleNavContent=function(){return!!this._getSingleNavContent()};v.prototype._getSingleNavContent=function(){var t=this._getAllContent();while(t.length===1&&t[0]instanceof sap.ui.core.mvc.View){t=t[0].getContent()}if(t.length===1&&t[0]instanceof sap.m.NavContainer){return t[0]}else{return null}};v.prototype._getSinglePageContent=function(){var t=this._getAllContent();while(t.length===1&&t[0]instanceof sap.ui.core.mvc.View){t=t[0].getContent()}if(t.length===1&&t[0]instanceof sap.m.Page){return t[0]}else{return null}};v.prototype._hasSinglePageContent=function(){var t=this._getAllContent();while(t.length===1&&t[0]instanceof sap.ui.core.mvc.View){t=t[0].getContent()}if(t.length===1&&t[0]instanceof sap.m.Page){return true}else{return false}};v.prototype._hasSingleScrollableContent=function(){var t=this._getAllContent(),e;while(t.length===1&&t[0]instanceof sap.ui.core.mvc.View){t=t[0].getContent()}if(t.length===1){for(e=0;e<this._scrollContentList.length;e++){if(t[0]instanceof this._scrollContentList[e]){return true}}return false}else{return false}};v.prototype._getOffsetX=function(){var t=this.getPlacement(),e=0;if(this._bHorizontalFlip){var o=this._getOpenByDomRef();var i=o!==undefined;var r=i?o.getBoundingClientRect().width:0;e=t===m.PreferredRightOrFlip?Math.abs(r):-Math.abs(r)}var s=sap.ui.getCore().getConfiguration().getRTL();var n=e*(s?-1:1)+this.getOffsetX()*(s?-1:1);return n};v.prototype._getOffsetY=function(){var t=this.getPlacement(),e=0;if(this._bVerticalFlip){var o=this._getOpenByDomRef();var i=o!==undefined;var r=i?o.getBoundingClientRect().height:0;e=t==="PreferredTopOrFlip"?-Math.abs(r):Math.abs(r)}return e+this.getOffsetY()};v.prototype._calcOffset=function(t){var e=this._getOffsetX(),o=this._getOffsetY();var i=t.split(" ");var t=parseInt(i[0],10)+e+" "+(parseInt(i[1],10)+o);return t};v.prototype._calcPlacement=function(){var e=this.getPlacement();var o=this._getOpenByDomRef();switch(e){case m.Auto:this._calcAuto();break;case m.Vertical:case m.VerticalPreferedTop:case m.VerticalPreferredTop:case m.VerticalPreferedBottom:case m.VerticalPreferredBottom:case m.PreferredTopOrFlip:case m.PreferredBottomOrFlip:this._calcVertical();break;case m.Horizontal:case m.HorizontalPreferedLeft:case m.HorizontalPreferredLeft:case m.HorizontalPreferedRight:case m.HorizontalPreferredRight:case m.PreferredRightOrFlip:case m.PreferredLeftOrFlip:this._calcHorizontal();break}this._bPosCalced=true;var i=t.inArray(this._oCalcedPos,this._placements);this.oPopup.setPosition(this._myPositions[i],this._atPositions[i],o,this._calcOffset(this._offsets[i]),"fit")};v.prototype._getDocHeight=function(){var t=document.body,e=document.documentElement;return Math.max(t.scrollHeight,t.offsetHeight,e.clientHeight,e.offsetHeight)};v.prototype._calcVertical=function(){var e=t(this._getOpenByDomRef());var o=e[0]!==undefined;var i=this.getPlacement()===m.VerticalPreferedTop||this.getPlacement()===m.VerticalPreferredTop;var r=this.getPlacement()===m.VerticalPreferedBottom||this.getPlacement()===m.VerticalPreferredBottom;var s=this.getPlacement()===m.PreferredTopOrFlip;var n=this.getPlacement()===m.PreferredBottomOrFlip;var a=o?e[0].getBoundingClientRect().top:0;var l=o?e[0].getBoundingClientRect().height:0;var h=this._getOffsetY();var f=a-this._marginTop+h;var p=this.$().outerHeight();var g=this._getDocHeight()-(e.offset().top+l+this._marginBottom+h);if(i&&f>p+this._arrowOffset){this._bVerticalFlip=false;this._oCalcedPos=m.Top}else if(s){if(f>p+this._arrowOffset){this._bVerticalFlip=false;this._oCalcedPos=m.Top}else{this._bVerticalFlip=true;this._oCalcedPos=m.Bottom}}else if(r&&g>p+this._arrowOffset){this._oCalcedPos=m.Bottom;this._bVerticalFlip=false}else if(n){if(g>p+this._arrowOffset){this._bVerticalFlip=false;this._oCalcedPos=m.Bottom}else{this._bVerticalFlip=true;this._oCalcedPos=m.Top}}else if(f>g){this._oCalcedPos=m.Top}else{this._oCalcedPos=m.Bottom}};v.prototype._calcHorizontal=function(){var e=t(this._getOpenByDomRef());var o=e[0]!==undefined;var i=this.getPlacement()===m.HorizontalPreferedLeft||this.getPlacement()===m.HorizontalPreferredLeft;var r=this.getPlacement()===m.HorizontalPreferedRight||this.getPlacement()===m.HorizontalPreferredRight;var s=o?e[0].getBoundingClientRect().left:0;var n=o?e[0].getBoundingClientRect().width:0;var a=this._getOffsetX();var l=s-this._marginLeft+a;var h=s+n;var f=this._$window.width()-h-this._marginRight-a;var p=this.$().outerWidth();var g=this.getPlacement()===m.PreferredLeftOrFlip;var c=this.getPlacement()===m.PreferredRightOrFlip;var u=sap.ui.getCore().getConfiguration().getRTL();if(i&&l>p+this._arrowOffset){this._bHorizontalFlip=false;this._oCalcedPos=u?m.Right:m.Left}else if(g){if(l>p+this._arrowOffset){this._bHorizontalFlip=false;this._oCalcedPos=u?m.Right:m.Left}else{this._bHorizontalFlip=true;this._oCalcedPos=u?m.Left:m.Right}}else if(r&&f>p+this._arrowOffset){this._bHorizontalFlip=false;this._oCalcedPos=u?m.Left:m.Right}else if(c){if(f>p+this._arrowOffset){this._bHorizontalFlip=false;this._oCalcedPos=u?m.Left:m.Right}else{this._bHorizontalFlip=true;this._oCalcedPos=u?m.Right:m.Left}}else if(l>f){this._oCalcedPos=u?m.Right:m.Left}else{this._oCalcedPos=u?m.Left:m.Right}};v.prototype._calcAuto=function(){if(this._$window.width()>this._$window.height()){if(this._checkHorizontal()){this._calcHorizontal()}else if(this._checkVertical()){this._calcVertical()}else{this._calcBestPos()}}else{if(this._checkVertical()){this._calcVertical()}else if(this._checkHorizontal()){this._calcHorizontal()}else{this._calcBestPos()}}};v.prototype._checkHorizontal=function(){var e=t(this._getOpenByDomRef());var o=e[0]!==undefined;var i=o?e[0].getBoundingClientRect().left:0;var r=o?e[0].getBoundingClientRect().width:0;var s=this._getOffsetX();var n=i-this._marginLeft+s;var a=i+r;var l=this._$window.width()-a-this._marginRight-s;var h=this.$();var f=h.outerWidth()+this._arrowOffset;if(f<=n||f<=l){return true}};v.prototype._checkVertical=function(){var e=t(this._getOpenByDomRef());var o=e[0]!==undefined;var i=o?e[0].getBoundingClientRect().top:0;var r=o?e[0].getBoundingClientRect().height:0;var s=this._getOffsetY();var n=i-this._marginTop+s;var a=this._getDocHeight()-e.offset().top-r-this._marginBottom-s;var l=this.$();var h=l.outerHeight()+this._arrowOffset;if(h<=n||h<=a){return true}};v.prototype._calcBestPos=function(){var e=this.$();var o=e.outerHeight();var i=e.outerWidth();var r=sap.ui.getCore().getConfiguration().getRTL();var s=t(this._getOpenByDomRef());var n=s[0]!==undefined;var a=n?s[0].getBoundingClientRect().left:0;var l=n?s[0].getBoundingClientRect().top:0;var h=n?s[0].getBoundingClientRect().width:0;var f=n?s[0].getBoundingClientRect().height:0;var p=this._getOffsetX();var g=this._getOffsetY();var c=l-this._marginTop+g;var u=this._getDocHeight()-s.offset().top-f-this._marginBottom-g;var _=a-this._marginLeft+p;var d=a+h;var v=this._$window.width()-d-this._marginRight-p;var P=o*i;var y;var C;if(this._$window.height()-this._marginTop-this._marginBottom>=o){y=o}else{y=this._$window.height()-this._marginTop-this._marginBottom}if(this._$window.width()-this._marginLeft-this._marginRight>=i){C=i}else{C=this._$window.width()-this._marginLeft-this._marginRight}var w=y*_/P;var O=y*v/P;var H=C*c/P;var b=C*u/P;var B=Math.max(w,O);var R=Math.max(H,b);if(B>R){if(B===w){this._oCalcedPos=r?m.Right:m.Left}else if(B===O){this._oCalcedPos=r?m.Left:m.Right}}else if(R>B){if(R===H){this._oCalcedPos=m.Top}else if(R===b){this._oCalcedPos=m.Bottom}}else if(R===B){if(this._$window.height()>this._$window.width()){if(R===H){this._oCalcedPos=m.Top}else if(R===b){this._oCalcedPos=m.Bottom}}else{if(B===w){this._oCalcedPos=r?m.Right:m.Left}else if(B===O){this._oCalcedPos=r?m.Left:m.Right}}}};v.outerWidth=function(e,o){if(typeof window.SVGElement!=="undefined"&&e instanceof window.SVGElement){return e.getBoundingClientRect().width}return t(e).outerWidth(!!o)};v.outerHeight=function(e,o){if(typeof window.SVGElement!=="undefined"&&e instanceof window.SVGElement){return e.getBoundingClientRect().height}return t(e).outerHeight(!!o)};v.prototype._getPositionParams=function(e,o,i,r){var s=window.getComputedStyle(e[0]),n=window.getComputedStyle(i[0]),a=this.getDomRef().clientHeight!=this.getDomRef().scrollHeight?t.sap.scrollbarSize().width:0,l={};l._$popover=e;l._$parent=t(this._getOpenByDomRef());l._$arrow=o;l._$content=i;l._$scrollArea=r;l._$header=e.children(".sapMPopoverHeader");l._$subHeader=e.children(".sapMPopoverSubHeader");l._$footer=e.children(".sapMPopoverFooter");l._fWindowTop=this._$window.scrollTop();l._fWindowRight=this._$window.width();l._fWindowBottom=v._bIOS7&&h.orientation.landscape&&window.innerHeight?window.innerHeight:this._$window.height();l._fWindowLeft=this._$window.scrollLeft();l._fDocumentWidth=l._fWindowLeft+l._fWindowRight;l._fDocumentHeight=l._fWindowTop+l._fWindowBottom;l._fArrowHeight=o.outerHeight(true);l._fWidth=v.outerWidth(e[0]);l._fWidthInner=l._$scrollArea?l._$scrollArea.width()+a:0;l._fHeight=v.outerHeight(e[0]);l._fHeaderHeight=l._$header.length>0?l._$header.outerHeight(true):0;l._fSubHeaderHeight=l._$subHeader.length>0?l._$subHeader.outerHeight(true):0;l._fFooterHeight=l._$footer.length>0?l._$footer.outerHeight(true):0;l._fOffset=e.offset();l._fOffsetX=this._getOffsetX();l._fOffsetY=this._getOffsetY();l._fMarginTop=l._fWindowTop+this._marginTop;l._fMarginRight=this._marginRight;l._fMarginBottom=this._marginBottom;l._fMarginLeft=l._fWindowLeft+this._marginLeft;l._fPopoverBorderTop=parseFloat(s.borderTopWidth);l._fPopoverBorderRight=parseFloat(s.borderRightWidth);l._fPopoverBorderBottom=parseFloat(s.borderBottomWidth);l._fPopoverBorderLeft=parseFloat(s.borderLeftWidth);l._fContentMarginTop=parseFloat(n.marginTop);l._fContentMarginBottom=parseFloat(n.marginBottom);return l};v.prototype._recalculateMargins=function(t,e){var o=sap.ui.getCore().getConfiguration().getRTL();switch(t){case m.Left:if(o){e._fMarginLeft=e._$parent.offset().left+v.outerWidth(e._$parent[0],false)+this._arrowOffset-e._fOffsetX}else{e._fMarginRight=e._fDocumentWidth-e._$parent.offset().left+this._arrowOffset-e._fOffsetX}break;case m.Right:if(o){e._fMarginRight=e._fDocumentWidth-v.outerWidth(e._$parent[0],false)-e._$parent.offset().left+this._arrowOffset}else{e._fMarginLeft=e._$parent.offset().left+v.outerWidth(e._$parent[0],false)+this._arrowOffset+e._fOffsetX}break;case m.Top:e._fMarginBottom=e._fDocumentHeight-e._$parent.offset().top+this._arrowOffset-e._fOffsetY;break;case m.Bottom:e._fMarginTop=e._$parent.offset().top+v.outerHeight(e._$parent[0],false)+this._arrowOffset+e._fOffsetY;break}};v.prototype._getPopoverPositionCss=function(e){var o,i,r,s,n=e._fDocumentWidth-e._fOffset.left-e._fWidth,a=e._fDocumentHeight-e._fOffset.top-e._fHeight,l=e._fDocumentWidth-e._fMarginRight-e._fMarginLeft<e._fWidth,h=e._fDocumentHeight-e._fMarginTop-e._fMarginBottom<e._fHeight,f=e._fOffset.left<e._fMarginLeft,p=this.getVerticalScrolling()&&e._fWidth!==e._fWidthInner?t.sap.scrollbarSize().width:0,g=n<e._fMarginRight+p,c=e._fOffset.top<e._fMarginTop,u=a<e._fMarginBottom,_=sap.ui.getCore().getConfiguration().getRTL();if(l){o=e._fMarginLeft;i=e._fMarginRight}else{if(f){o=e._fMarginLeft;if(_){i=""}}else if(g){i=e._fMarginRight;o=""}}if(h){r=e._fMarginTop;s=e._fMarginBottom}else{if(c){r=e._fMarginTop}else if(u){s=e._fMarginBottom;r=""}}var d={top:r,bottom:s-e._fWindowTop,left:o,right:typeof i==="number"?i-e._fWindowLeft:i};return d};v.prototype._getContentDimensionsCss=function(t){var e={},o=t._$content.height(),i=this._getMaxContentWidth(t),r=this._getMaxContentHeight(t);r=Math.max(r,0);e["max-width"]=i+"px";if(this.getContentHeight()||o>r){e["height"]=Math.min(r,o)+"px"}else{e["height"]="";e["max-height"]=r+"px"}return e};v.prototype._getMaxContentWidth=function(t){return t._fDocumentWidth-t._fMarginLeft-t._fMarginRight-t._fPopoverBorderLeft-t._fPopoverBorderRight};v.prototype._getMaxContentHeight=function(t){return t._fDocumentHeight-t._fMarginTop-t._fMarginBottom-t._fHeaderHeight-t._fSubHeaderHeight-t._fFooterHeight-t._fContentMarginTop-t._fContentMarginBottom-t._fPopoverBorderTop-t._fPopoverBorderBottom};v.prototype._isHorizontalScrollbarNeeded=function(t){return this.getHorizontalScrolling()&&t._$scrollArea.outerWidth(true)<=t._$content.width()};v.prototype._getArrowOffsetCss=function(t,e){var o,i=sap.ui.getCore().getConfiguration().getRTL();e._fWidth=e._$popover.outerWidth();e._fHeight=e._$popover.outerHeight();if(t===m.Left||t===m.Right){o=e._$parent.offset().top-e._$popover.offset().top-e._fPopoverBorderTop+e._fOffsetY+.5*(v.outerHeight(e._$parent[0],false)-e._$arrow.outerHeight(false));o=Math.max(o,this._arrowOffsetThreshold);o=Math.min(o,e._fHeight-this._arrowOffsetThreshold-e._$arrow.outerHeight());return{top:o}}else if(t===m.Top||t===m.Bottom){if(i){o=e._$popover.offset().left+v.outerWidth(e._$popover[0],false)-(e._$parent.offset().left+v.outerWidth(e._$parent[0],false))+e._fPopoverBorderRight+e._fOffsetX+.5*(v.outerWidth(e._$parent[0],false)-e._$arrow.outerWidth(false));o=Math.max(o,this._arrowOffsetThreshold);o=Math.min(o,e._fWidth-this._arrowOffsetThreshold-e._$arrow.outerWidth(false));return{right:o}}else{o=e._$parent.offset().left-e._$popover.offset().left-e._fPopoverBorderLeft+e._fOffsetX+.5*(v.outerWidth(e._$parent[0],false)-e._$arrow.outerWidth(false));o=Math.max(o,this._arrowOffsetThreshold);o=Math.min(o,e._fWidth-this._arrowOffsetThreshold-e._$arrow.outerWidth(false));return{left:o}}}};v.prototype._getArrowPositionCssClass=function(t){switch(t){case m.Left:return"sapMPopoverArrRight";case m.Right:return"sapMPopoverArrLeft";case m.Top:return"sapMPopoverArrDown";case m.Bottom:return"sapMPopoverArrUp"}};v.prototype._getArrowStyleCssClass=function(t){var e=t._$arrow.position(),o=t._$footer.position(),i=this._getSingleNavContent(),r=this._getSinglePageContent(),s=0;if(i||r){r=r||i.getCurrentPage();if(r){s=r._getAnyHeader().$().outerHeight()}}if(e.top+t._fArrowHeight<t._fHeaderHeight+t._fSubHeaderHeight||e.top+t._fArrowHeight<s){return"sapMPopoverHeaderAlignArr"}else if(e.top<t._fHeaderHeight+t._fSubHeaderHeight||e.top<s||t._$footer.length&&e.top+t._fArrowHeight>o.top&&e.top<o.top){return"sapMPopoverCrossArr"}else if(t._$footer.length&&e.top>o.top){return"sapMPopoverFooterAlignArr"}};v.prototype._getCalculatedPlacement=function(){return this._oCalcedPos||this.getPlacement()};v.prototype._adjustPositionAndArrow=function(){var t=this.oPopup.getOpenState();if(!(t===d.OPEN||t===d.OPENING)){return}var e=this.$(),o=this.$("arrow"),i=this.$("cont"),r=this.$("scroll"),s=this._getCalculatedPlacement(),n=this._getPositionParams(e,o,i,r);this._recalculateMargins(s,n);var a=this._getPopoverPositionCss(n),l=this._getContentDimensionsCss(n),h=this._isHorizontalScrollbarNeeded(n);e.css(a);i.css(l);if(h){r.css("display","block")}if(this.getShowArrow()){var f=this._getArrowOffsetCss(s,n),p=this._getArrowPositionCssClass(s),g,c;o.removeAttr("style");o.css(f);o.addClass(p);if(s===m.Top&&n._$footer&&n._$footer.size()){c=true}if(s===m.Left||s===m.Right){g=this._getArrowStyleCssClass(n);if(g){o.addClass(g);if(g==="sapMPopoverFooterAlignArr"){c=true}}}if(c){o.addClass("sapContrast sapContrastPlus")}e.css("overflow","visible")}this._afterAdjustPositionAndArrowHook()};v.prototype._adaptPositionParams=function(){if(this.getShowArrow()){this._marginLeft=10;this._marginRight=10;this._marginBottom=10;this._arrowOffset=18;this._offsets=["0 -18","18 0","0 18","-18 0"];if(this._bUseCompactArrow){this._arrowOffset=9;this._offsets=["0 -9","9 0","0 9","-9 0"]}this._myPositions=["center bottom","begin center","center top","end center"];this._atPositions=["center top","end center","center bottom","begin center"]}else{this._marginTop=0;this._marginLeft=0;this._marginRight=0;this._marginBottom=0;this._arrowOffset=0;this._offsets=["0 0","0 0","0 0","0 0"];this._myPositions=["begin bottom","begin center","begin top","end center"];this._atPositions=["begin top","end center","begin bottom","begin center"]}};v.prototype._afterAdjustPositionAndArrowHook=function(){};v.prototype._isPopupElement=function(e){var o=this._getOpenByDomRef();return!!t(e).closest(sap.ui.getCore().getStaticAreaRef()).length||!!t(e).closest(o).length};v.prototype._getAnyHeader=function(){if(this.getCustomHeader()){return this.getCustomHeader()}else{if(this.getShowHeader()){this._createInternalHeader();return this._internalHeader}}};v.prototype._createInternalHeader=function(){if(!this._internalHeader){var t=this;this._internalHeader=new e(this.getId()+"-intHeader");this.setAggregation("_internalHeader",this._internalHeader);this._internalHeader.addEventDelegate({onAfterRendering:function(){t._restoreFocus()}});return true}else{return false}};v.prototype._animation=function(t,e){var o=null;var i=function(){e.off("webkitTransitionEnd transitionend");clearTimeout(o);setTimeout(function(){t()})};e.on("webkitTransitionEnd transitionend",i);o=setTimeout(i,this._getAnimationDuration())};v.prototype._getAnimationDuration=function(){return 300};v.prototype._openAnimation=function(t,e,o){var i=this;setTimeout(function(){t.css("display","block");i._animation(function(){if(!i.oPopup||i.oPopup.getOpenState()!==d.OPENING){return}o()},t)},h.browser.firefox?50:0)};v.prototype._closeAnimation=function(t,e,o){t.addClass("sapMPopoverTransparent");this._animation(function(){o();t.removeClass("sapMPopoverTransparent")},t)};v.prototype._getInitialFocusId=function(){return this.getInitialFocus()||this._getFirstVisibleButtonId()||this._getFirstFocusableContentElementId()||this.getId()};v.prototype._getFirstVisibleButtonId=function(){var t=this.getBeginButton(),e=this.getEndButton(),o="";if(t&&t.getVisible()){o=t.getId()}else if(e&&e.getVisible()){o=e.getId()}return o};v.prototype._getFirstFocusableContentElementId=function(){var t="";var e=this.$("cont");var o=e.firstFocusableDomRef();if(o){t=o.id}return t};v.prototype._restoreFocus=function(){if(this.isOpen()){var e=this._getInitialFocusId(),o=sap.ui.getCore().byId(e);t.sap.focus(o?o.getFocusDomRef():t.sap.domById(e))}};v.prototype._registerContentResizeHandler=function(t){if(!this._sResizeListenerId){this._sResizeListenerId=c.register(t||this.getDomRef("scroll"),this._fnOrientationChange)}};v.prototype._deregisterContentResizeHandler=function(){if(this._sResizeListenerId){c.deregister(this._sResizeListenerId);this._sResizeListenerId=null}};v.prototype._storeScrollPosition=function(){var t=this.$("cont");if(t.length>0){this._oScrollPosDesktop={x:t.scrollLeft(),y:t.scrollTop()}}};v.prototype._restoreScrollPosition=function(){if(!this._oScrollPosDesktop){return}var t=this.$("cont");if(t.length>0){t.scrollLeft(this._oScrollPosDesktop.x).scrollTop(this._oScrollPosDesktop.y);this._oScrollPosDesktop=null}};v.prototype._repositionOffset=function(){var e=this.oPopup.getOpenState(),o,i;if(!(e===d.OPEN)){return this}o=this.oPopup._oLastPosition;i=t.inArray(this.getPlacement(),this._placements);if(i===-1){return this}if(i<4){o.offset=this._calcOffset(this._offsets[i]);this.oPopup._applyPosition(o)}else{this._calcPlacement()}return this};v.prototype._getOpenByDomRef=function(){if(!this._oOpenBy){return null}if(this._oOpenBy instanceof g){return this._oOpenBy.getPopupAnchorDomRef&&this._oOpenBy.getPopupAnchorDomRef()||this._oOpenBy.getFocusDomRef()}else{return this._oOpenBy}};v.prototype._getAccessibilityOptions=function(){var t,e={};e.role="dialog";if(this.getShowHeader()&&this._getAnyHeader()){t=Array.prototype.concat(this._getAnyHeader().getId(),this.getAssociation("ariaLabelledBy",[]));e.labelledby=t.join(" ")}return e};v.prototype.setPlacement=function(e){this.setProperty("placement",e,true);this._bVerticalFlip=false;this._bHorizontalFlip=false;var o=t.inArray(e,this._placements);if(o<=3){this._oCalcedPos=e}return this};v.prototype.setTitle=function(t){this.setProperty("title",t,true);if(this._headerTitle){this._headerTitle.setText(t)}else{this._headerTitle=new sap.m.Title(this.getId()+"-title",{text:this.getTitle(),level:"H2"});this._createInternalHeader();this._internalHeader.addContentMiddle(this._headerTitle)}return this};v.prototype.setBeginButton=function(t){var e=this.getBeginButton();if(e===t){return this}this._createInternalHeader();this._beginButton=t;if(t){if(e){this._internalHeader.removeAggregation("contentLeft",e,true)}this._internalHeader.addAggregation("contentLeft",t)}else{this._internalHeader.removeContentLeft(e)}return this};v.prototype.setEndButton=function(t){var e=this.getEndButton();if(e===t){return this}this._createInternalHeader();this._endButton=t;if(t){if(e){this._internalHeader.removeAggregation("contentRight",e,true)}this._internalHeader.insertAggregation("contentRight",t,1,true);this._internalHeader.invalidate()}else{this._internalHeader.removeContentRight(e)}return this};v.prototype.setLeftButton=function(t){if(!(t instanceof o)){t=sap.ui.getCore().byId(t)}this.setBeginButton(t);return this.setAssociation("leftButton",t)};v.prototype.setRightButton=function(t){if(!(t instanceof o)){t=sap.ui.getCore().byId(t)}this.setEndButton(t);return this.setAssociation("rightButton",t)};v.prototype.setShowHeader=function(t){if(t===this.getShowHeader()||this.getCustomHeader()){return this}if(t){if(this._internalHeader){this._internalHeader.$().show()}}else{if(this._internalHeader){this._internalHeader.$().hide()}}this.setProperty("showHeader",t,true);return this};v.prototype.setModal=function(e,o){if(e===this.getModal()){return this}this.oPopup.setModal(e,t.trim("sapMPopoverBLayer "+o||""));this.setProperty("modal",e,true);return this};v.prototype.setOffsetX=function(t){this.setProperty("offsetX",t,true);return this._repositionOffset()};v.prototype.setOffsetY=function(t){this.setProperty("offsetY",t,true);return this._repositionOffset()};v.prototype.setEnableScrolling=function(t){this.setHorizontalScrolling(t);this.setVerticalScrolling(t);var e=this.getEnableScrolling();if(e===t){return this}this.setProperty("enableScrolling",t,true);return this};v.prototype.setVerticalScrolling=function(t){this._bVScrollingEnabled=t;var e=this.getVerticalScrolling();if(e===t){return this}this.$().toggleClass("sapMPopoverVerScrollDisabled",!t);this.setProperty("verticalScrolling",t,true);if(this._oScroller){this._oScroller.setVertical(t)}return this};v.prototype.setHorizontalScrolling=function(t){this._bHScrollingEnabled=t;var e=this.getHorizontalScrolling();if(e===t){return this}this.$().toggleClass("sapMPopoverHorScrollDisabled",!t);this.setProperty("horizontalScrolling",t,true);if(this._oScroller){this._oScroller.setHorizontal(t)}return this};v.prototype.setResizable=function(t){if(!h.system.desktop){t=false}return this.setProperty("resizable",t,true)};v.prototype.getScrollDelegate=function(){return this._oScroller};v.prototype.setAggregation=function(t,e,o){if(t==="beginButton"||t==="endButton"){var i="set"+t.charAt(0).toUpperCase()+t.slice(1);return this[i](e)}else{return s.prototype.setAggregation.apply(this,arguments)}};v.prototype.getAggregation=function(t,e){if(t==="beginButton"||t==="endButton"){var o=this["_"+t];return o||e||null}else{return s.prototype.getAggregation.apply(this,arguments)}};v.prototype.destroyAggregation=function(e,o){var i=t(document.activeElement).control(0);if(e==="beginButton"||e==="endButton"){var r=this["_"+e];if(r){r.destroy();this["_"+e]=null}}else{s.prototype.destroyAggregation.apply(this,arguments)}i&&i.getDomRef()?i.focus():this.focus();return this};v.prototype.invalidate=function(t){if(this.isOpen()){s.prototype.invalidate.apply(this,arguments)}return this};v.prototype.addAggregation=function(t,e,o){if(t==="content"){this._bContentChanged=true}s.prototype.addAggregation.apply(this,arguments)};v.prototype._getAllContent=function(){return this.getContent()};v.prototype._applyContextualSettings=function(){f.prototype._applyContextualSettings.call(this,f._defaultContextualSettings)};return v});