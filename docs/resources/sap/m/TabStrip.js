/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Control","sap/ui/core/IconPool","sap/ui/core/delegate/ItemNavigation","sap/ui/base/ManagedObject","sap/ui/core/delegate/ScrollEnablement","./AccButton","./TabStripItem","sap/m/Select","sap/m/SelectList","sap/ui/Device","sap/ui/core/Renderer","sap/ui/core/ResizeHandler","sap/m/library","sap/ui/core/Icon","sap/m/SelectRenderer","sap/m/SelectListRenderer","./TabStripRenderer"],function(t,e,i,o,r,s,n,a,l,c,g,h,f,p,m,u,d,I){"use strict";var S=p.SelectType;var _=p.ButtonType;var y=e.extend("sap.m.TabStrip",{metadata:{library:"sap.m",properties:{hasSelect:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{items:{type:"sap.m.TabStripItem",multiple:true,singularName:"item"},addButton:{type:"sap.m.Button",multiple:false,singularName:"addButton"},_select:{type:"sap.m.Select",multiple:false,visibility:"hidden"},_rightArrowButton:{type:"sap.m.AccButton",multiple:false,visibility:"hidden"},_leftArrowButton:{type:"sap.m.AccButton",multiple:false,visibility:"hidden"}},associations:{selectedItem:{type:"sap.m.TabStripItem",group:"Misc"}},events:{itemClose:{allowPreventDefault:true,parameters:{item:{type:"sap.m.TabStripItem"}}},itemPress:{parameters:{item:{type:"sap.m.TabStripItem"}}},itemSelect:{allowPreventDefault:true,parameters:{item:{type:"sap.m.TabContainerItem"}}}}},constructor:function(t,e){var i=false;if(!e&&typeof t==="object"){e=t}if(e){i=e["hasSelect"];delete e["hasSelect"]}r.prototype.constructor.apply(this,arguments);this.setProperty("hasSelect",i,true)}});var v=sap.ui.getCore().getLibraryResourceBundle("sap.m");y.ICON_BUTTONS={LeftArrowButton:"slim-arrow-left",RightArrowButton:"slim-arrow-right",DownArrowButton:"slim-arrow-down",AddButton:"add"};y.SELECT_ITEMS_ID_SUFFIX="-SelectItem";y.SCROLL_SIZE=320;y.MIN_DRAG_OFFSET=g.support.touch?15:5;y.SCROLL_ANIMATION_DURATION=sap.ui.getCore().getConfiguration().getAnimation()?500:0;y.prototype.init=function(){this._bDoScroll=!g.system.phone;this._bRtl=sap.ui.getCore().getConfiguration().getRTL();this._iCurrentScrollLeft=0;this._iMaxOffsetLeft=null;this._scrollable=null;this._oTouchStartX=null;if(!g.system.phone){this._oScroller=new s(this,this.getId()+"-tabs",{horizontal:true,vertical:false,nonTouchScrolling:true})}};y.prototype.exit=function(){this._bRtl=null;this._iCurrentScrollLeft=null;this._iMaxOffsetLeft=null;this._scrollable=null;this._oTouchStartX=null;if(this._oScroller){this._oScroller.destroy();this._oScroller=null}if(this._sResizeListenerId){f.deregister(this._sResizeListenerId);this._sResizeListenerId=null}this._removeItemNavigation()};y.prototype.onBeforeRendering=function(){if(this._sResizeListenerId){f.deregister(this._sResizeListenerId);this._sResizeListenerId=null}};y.prototype.onAfterRendering=function(){if(this._oScroller){this._oScroller.setIconTabBar(this,t.proxy(this._handleOverflowButtons,this),null)}this._addItemNavigation();if(!g.system.phone){this._adjustScrolling();this._sResizeListenerId=f.register(this.getDomRef(),t.proxy(this._adjustScrolling,this))}};y.prototype.getFocusDomRef=function(){var t=sap.ui.getCore().byId(this.getSelectedItem());if(!t){return null}return t.getDomRef()};y.prototype.applyFocusInfo=function(e){if(e.focusDomRef){t(e.focusDomRef).focus()}};y.prototype._addItemNavigation=function(){var e=this.getDomRef("tabsContainer"),i=this.getItems(),r=[];i.forEach(function(e){var i=e.getDomRef();t(i).attr("tabindex","-1");r.push(i)});if(!this._oItemNavigation){this._oItemNavigation=new o}this._oItemNavigation.setRootDomRef(e);this._oItemNavigation.setItemDomRefs(r);this._oItemNavigation.setCycling(false);this._oItemNavigation.setPageSize(5);this._oItemNavigation.setDisabledModifiers({sapnext:["alt"],sapprevious:["alt"]});this.addDelegate(this._oItemNavigation)};y.prototype._checkScrolling=function(){var t=this.getDomRef("tabs"),e=t&&t.scrollWidth>this.getDomRef("tabsContainer").offsetWidth;this.$().toggleClass("sapMTSScrollable",e);return e};y.prototype._handleOverflowButtons=function(){var e=this.getDomRef("tabs"),i=this.getDomRef("tabsContainer"),o,r,s,n=false,a=false,l=this._checkScrolling();if(l&&!this.getAggregation("_rightArrowButton")&&!this.getAggregation("_leftArrowButton")){this._getLeftArrowButton();this._getRightArrowButton();var c=sap.ui.getCore().createRenderManager();this.getRenderer().renderRightOverflowButtons(c,this,true);this.getRenderer().renderLeftOverflowButtons(c,this,true);c.destroy()}if(l&&e&&i){if(this._bRtl){o=t(i).scrollLeftRTL()}else{o=i.scrollLeft}r=e.scrollWidth;s=i.clientWidth;if(Math.abs(r-s)===1){r=s}if(o>0){if(this._bRtl){a=true}else{n=true}}if(r>s&&o+s<r){if(this._bRtl){n=true}else{a=true}}this.$().toggleClass("sapMTSScrollBack",n).toggleClass("sapMTSScrollForward",a)}else{this.$().toggleClass("sapMTSScrollBack",false).toggleClass("sapMTSScrollForward",false)}};y.prototype._adjustScrolling=function(){this._iMaxOffsetLeft=Math.abs(this.$("tabsContainer").width()-this.$("tabs").width());this._handleOverflowButtons()};y.prototype._getLeftArrowButton=function(){return this._getArrowButton("_leftArrowButton",v.getText("TABSTRIP_SCROLL_BACK"),y.ICON_BUTTONS.LeftArrowButton,-y.SCROLL_SIZE)};y.prototype._getRightArrowButton=function(){return this._getArrowButton("_rightArrowButton",v.getText("TABSTRIP_SCROLL_FORWARD"),y.ICON_BUTTONS.RightArrowButton,y.SCROLL_SIZE)};y.prototype._getArrowButton=function(t,e,o,r){var s=this.getAggregation(t),a=this;if(!s){s=new n({type:_.Transparent,icon:i.getIconURI(o),tooltip:e,tabIndex:"-1",ariaHidden:"true",press:function(t){a._scroll(r,y.SCROLL_ANIMATION_DURATION)}});this.setAggregation(t,s,true)}return s};y.prototype._removeItemNavigation=function(){if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();delete this._oItemNavigation}};y.prototype._scroll=function(t,e){var i=this.getDomRef("tabsContainer").scrollLeft,o=g.browser.internet_explorer||g.browser.edge,r;if(this._bRtl&&!o){r=i-t;if(g.browser.firefox){if(r<-this._iMaxOffsetLeft){r=-this._iMaxOffsetLeft}if(r>0){r=0}}}else{r=i+t;if(r<0){r=0}if(r>this._iMaxOffsetLeft){r=this._iMaxOffsetLeft}}this._oScroller.scrollTo(r,0,e);this._iCurrentScrollLeft=r};y.prototype._scrollIntoView=function(t,e){var i=this.$("tabs"),o=t.$(),r=i.innerWidth()-i.width(),s=o.outerWidth(true),n=o.position().left-r/2,a=this.getDomRef("tabsContainer"),l=a.scrollLeft,c=this.$("tabsContainer").width(),h=l;if(n<0||n>c-s){if(this._bRtl&&g.browser.firefox){if(n<0){h+=n+s-c}else{h+=n}}else{if(n<0){h+=n}else{h+=n+s-c}}this._iCurrentScrollLeft=h;this._oScroller.scrollTo(h,0,e)}};y.prototype._createSelect=function(t){var e,o,r,s={type:g.system.phone?S.Default:S.IconOnly,autoAdjustWidth:true,maxWidth:g.system.phone?"100%":"2.5rem",icon:i.getIconURI(y.ICON_BUTTONS.DownArrowButton),tooltip:v.getText("TABSTRIP_OPENED_TABS"),change:function(t){o=t.getParameters()["selectedItem"];r=this._findTabStripItemFromSelectItem(o);this._activateItem(r,t)}.bind(this)};e=new T(s).addStyleClass("sapMTSOverflowSelect");this._addItemsToSelect(e,t);return e};y.prototype.onsapselect=function(t){t.setMarked();t.preventDefault();this._activateItem(t.srcControl,t)};y.prototype.onsapdelete=function(e){var i=t("#"+e.target.id).control(0),o=i.getId()===this.getSelectedItem(),r=function(){this._moveToNextItem(o)};this._removeItem(i,r)};y.prototype._moveToNextItem=function(e){if(!this._oItemNavigation){return}var i=this.getItems().length,o=this._oItemNavigation.getFocusedIndex(),r=i===o?--o:o,s=this.getItems()[r],n=function(){if(this._oItemNavigation){this._oItemNavigation.focusItem(r)}};if(e){this.setSelectedItem(s);this.fireItemPress({item:s})}t.sap.delayedCall(0,this,n)};y.prototype._activateItem=function(t,e){if(this.fireItemSelect({item:t})){if(t&&t instanceof a){if(!this.getSelectedItem()||this.getSelectedItem()!==t.getId()){this.setSelectedItem(t)}this.fireItemPress({item:t})}}else if(e&&!e.isDefaultPrevented()){e.preventDefault()}};y.prototype.addAggregation=function(t,i,o){if(t==="items"){this._handleItemsAggregation(["addAggregation",i,o],true)}return e.prototype.addAggregation.call(this,t,i,o)};y.prototype.insertAggregation=function(t,i,o,r){if(t==="items"){this._handleItemsAggregation(["insertAggregation",i,o,r],true)}return e.prototype.insertAggregation.call(this,t,i,o,r)};y.prototype.removeAggregation=function(t,i,o){if(t==="items"){this._handleItemsAggregation(["removeAggregation",i,o])}return e.prototype.removeAggregation.call(this,t,i,o)};y.prototype.removeAllAggregation=function(t,i){if(t==="items"){this._handleItemsAggregation(["removeAllAggregation",null,i])}return e.prototype.removeAllAggregation.call(this,t,i)};y.prototype.destroyAggregation=function(t,i){if(t==="items"){this._handleItemsAggregation(["destroyAggregation",i])}return e.prototype.destroyAggregation.call(this,t,i)};y.prototype.setSelectedItem=function(t){if(!t){return}if(t.$().length>0){this._scrollIntoView(t,500)}this._updateAriaSelectedAttributes(this.getItems(),t);this._updateSelectedItemClasses(t.getId());if(this.getHasSelect()){var e=this._findSelectItemFromTabStripItem(t);this.getAggregation("_select").setSelectedItem(e)}return y.prototype.setAssociation.call(this,"selectedItem",t,true)};y.prototype.setProperty=function(t,i,o){var r;r=e.prototype.setProperty.call(this,t,i,o);if(t==="hasSelect"){if(i){if(!this.getAggregation("_select")){r=this.setAggregation("_select",this._createSelect(this.getItems()))}}else{r=this.destroyAggregation("_select")}}return r};y.prototype._attachItemEventListeners=function(t){if(t instanceof a){var e=["itemClosePressed","itemPropertyChanged"];e.forEach(function(e){e=e.charAt(0).toUpperCase()+e.slice(1);t["detach"+e](this["_handle"+e]);t["attach"+e](this["_handle"+e].bind(this))},this)}};y.prototype._detachItemEventListeners=function(t){if(!t||typeof t!=="object"||!(t instanceof a)){var e=this.getItems();e.forEach(function(t){if(typeof t!=="object"||!(t instanceof a)){return}return this._detachItemEventListeners(t)}.bind(this))}};y.prototype._handleItemPropertyChanged=function(t){var e=this._findSelectItemFromTabStripItem(t.getSource());e.setProperty(t["mParameters"].propertyKey,t["mParameters"].propertyValue)};y.prototype._handleItemClosePressed=function(t){this._removeItem(t.getSource())};y.prototype._removeItem=function(e,i){var o;if(!(e instanceof a)){t.sap.log.error("Expecting instance of a TabStripSelectItem, given: ",e)}if(e.getId().indexOf(y.SELECT_ITEMS_ID_SUFFIX)!==-1){o=this._findTabStripItemFromSelectItem(e)}else{o=e}if(this.fireItemClose({item:o})){this.removeAggregation("items",o);this._moveToNextItem(e.getId()===this.getSelectedItem());if(i){i.call(this)}}};y.prototype._handleItemsAggregation=function(t,e){var i="items",o=t[0],r=t[1],s=[i];t.forEach(function(t,e){if(e>0){s.push(t)}});if(e){this._attachItemEventListeners(r)}else{this._detachItemEventListeners(r)}if(i!=="items"){return this}if(this.getHasSelect()){this._handleSelectItemsAggregation(s,e,o,r)}return this};y.prototype._handleSelectItemsAggregation=function(t,e,i,o){var r=this.getAggregation("_select"),s;if(i==="destroyAggregation"&&!r){return}if(o===null||typeof o!=="object"){return r[i]["apply"](r,t)}if(e){s=this._createSelectItemFromTabStripItem(o)}else{s=this._findSelectItemFromTabStripItem(o)}t.forEach(function(e,i){if(typeof e==="object"){t[i]=s}});return r[i]["apply"](r,t)};y.prototype._addItemsToSelect=function(t,e){e.forEach(function(e){var i=this._createSelectItemFromTabStripItem(e);t.addAggregation("items",i);if(e.getId()===this.getSelectedItem()){t.setSelectedItem(i)}},this)};y.prototype._createSelectItemFromTabStripItem=function(e){var i;if(!e&&!(e instanceof sap.m.TabContainerItem)){t.sap.log.error('Expecting instance of "sap.m.TabContainerItem": instead of '+e+" given.");return}i=new a({id:e.getId()+y.SELECT_ITEMS_ID_SUFFIX,text:e.getText(),modified:e.getModified(),itemClosePressed:function(t){this._handleItemClosePressed(t)}.bind(this)});i.addEventDelegate({ontap:function(t){var e=t.srcControl;if(e instanceof n||e instanceof m){this.fireItemClosePressed({item:this})}}},i);return i};y.prototype._findTabStripItemFromSelectItem=function(t){var e,i=t.getId().replace(y.SELECT_ITEMS_ID_SUFFIX,""),o=this.getItems();for(e=0;e<o.length;e++){if(o[e].getId()===i){return o[e]}}};y.prototype._findSelectItemFromTabStripItem=function(t){var e,i,o=t.getId()+y.SELECT_ITEMS_ID_SUFFIX;if(this.getHasSelect()){i=this.getAggregation("_select").getItems();for(e=0;e<i.length;e++){if(i[e].getId()===o){return i[e]}}}};y.prototype._updateAriaSelectedAttributes=function(t,e){var i="false";t.forEach(function(t){if(t.$()){if(e&&e.getId()===t.getId()){i="true"}t.$().attr("aria-selected",i)}})};y.prototype._updateSelectedItemClasses=function(e){if(this.$("tabs")){this.$("tabs").children(".sapMTabStripItemSelected").removeClass("sapMTabStripItemSelected");t("#"+e).addClass("sapMTabStripItemSelected")}};y.prototype.changeItemState=function(e,i){var o;var r=this.getItems();r.forEach(function(r){if(e===r.getId()){o=t(r.$());if(i===true&&!o.hasClass(a.CSS_CLASS_MODIFIED)){o.addClass(a.CSS_CLASS_MODIFIED)}else{o.removeClass(a.CSS_CLASS_MODIFIED)}}})};y.prototype.ontouchstart=function(e){var i=t(e.target).control(0);if(i instanceof a||i instanceof n||i instanceof m||i instanceof T){this._oTouchStartX=e.changedTouches[0].pageX}};y.prototype.ontouchend=function(e){var i,o;if(!this._oTouchStartX){return}i=t(e.target).control(0);o=Math.abs(e.changedTouches[0].pageX-this._oTouchStartX);if(o<y.MIN_DRAG_OFFSET){if(i instanceof a){this._activateItem(i,e)}else if(i instanceof n){if(i&&i.getParent&&i.getParent()instanceof a){i=i.getParent();this._removeItem(i)}}else if(i instanceof m){if(i&&i.getParent&&i.getParent().getParent&&i.getParent().getParent()instanceof a){i=i.getParent().getParent();this._removeItem(i)}}this._oTouchStartX=null}};y.prototype.destroyItems=function(){this.setAssociation("selectedItem",null);return this.destroyAggregation("items")};var A=h.extend(u);var T=l.extend("sap.m.internal.TabStripSelect",{renderer:A});T.prototype.onAfterRendering=function(){l.prototype.onAfterRendering.apply(this,arguments);this.$().attr("tabindex","-1")};T.prototype.onAfterRenderingPicker=function(){var t=this.getPicker();l.prototype.onAfterRenderingPicker.call(this);if(g.system.phone){return}t.setOffsetX(Math.round(sap.ui.getCore().getConfiguration().getRTL()?this.getPicker().$().width()-this.$().width():this.$().width()-this.getPicker().$().width()));t.setOffsetY(this.$().parents().hasClass("sapUiSizeCompact")?2:3);t._calcPlacement()};T.prototype.createList=function(){this._oList=new b({width:"100%"}).attachSelectionChange(this.onSelectionChange,this).addEventDelegate({ontap:function(t){this.close()}},this);return this._oList};T.prototype.setValue=function(t){l.prototype.setValue.apply(this,arguments);this.$("label").toggleClass("sapMTSOverflowSelectLabelModified",this.getSelectedItem()&&this.getSelectedItem().getProperty("modified"));return this};var C=h.extend(d);C.renderItem=function(t,e,i,o){t.write("<li");t.writeElementData(i);t.addClass(d.CSS_CLASS+"ItemBase");t.addClass(d.CSS_CLASS+"Item");t.addClass("sapMTSOverflowSelectListItem");if(i.getProperty("modified")){t.addClass("sapMTSOverflowSelectListItemModified")}if(g.system.desktop){t.addClass(d.CSS_CLASS+"ItemBaseHoverable")}if(i===e.getSelectedItem()){t.addClass(d.CSS_CLASS+"ItemBaseSelected")}t.writeClasses();this.writeItemAccessibilityState.apply(this,arguments);t.write(">");t.write('<p class="sapMSelectListItemText">');t.writeEscaped(i.getText().slice(0,g.system.phone?i.getText().length:a.DISPLAY_TEXT_MAX_LENGTH));if(!g.system.phone&&i.getText().length>a.DISPLAY_TEXT_MAX_LENGTH){t.write("...")}t.write("</p>");t.renderControl(i.getAggregation("_closeButton"));t.write("</li>")};var b=c.extend("sap.m.internal.TabStripSelectList",{renderer:C});return y});