/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/Device","sap/m/PDFViewerRenderManager","sap/m/MessageBox","sap/m/PDFViewerRenderer"],function(e,t,o,r,i,n,s){"use strict";var a=o.extend("sap.m.PDFViewer",{metadata:{library:"sap.m",properties:{height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},source:{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},errorMessage:{type:"string",group:"Misc",defaultValue:null,deprecated:true},errorPlaceholderMessage:{type:"string",group:"Misc",defaultValue:null},popupHeaderTitle:{type:"string",group:"Misc",defaultValue:null,deprecated:true},title:{type:"string",group:"Misc",defaultValue:null},showDownloadButton:{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{errorPlaceholder:{type:"sap.ui.core.Control",multiple:false},popupButtons:{type:"sap.m.Button",multiple:true,singularName:"popupButton"}},events:{loaded:{},error:{},sourceValidationFailed:{}}}});a.prototype.init=function(){this._objectsRegister={};this._bIsPopupOpen=false;this._initPopupControl();this._initPopupDownloadButtonControl();this._initPlaceholderMessagePageControl();this._initToolbarDownloadButtonControl();this._initOverflowToolbarControl();this._initControlState()};a.prototype._initControlState=function(){this._bRenderPdfContent=true;this._bOnBeforeUnloadFired=false};a.prototype.setWidth=function(e){this.setProperty("width",e,true);var t=this.$();if(t===null){return this}t.css("width",this._getRenderWidth());return this};a.prototype.setHeight=function(e){this.setProperty("height",e,true);var t=this.$();if(t===null){return this}t.css("height",this._getRenderHeight());return this};a.prototype.onBeforeRendering=function(){this._bOnBeforeUnloadFired=false};a.prototype.onAfterRendering=function(){var t=function(){var t=this._getIframeDOMElement();var o=e(t.get(0).contentWindow);if(r.browser.internet_explorer){o.on("beforeunload",this._onBeforeUnloadListener.bind(this));o.on("readystatechange",this._onReadyStateChangeListener.bind(this));t.on("load",this._onLoadIEListener.bind(this))}else{t.on("load",this._onLoadListener.bind(this))}t.on("error",this._onErrorListener.bind(this));var i=this.getSource();var n=this.getSource().indexOf("#");if(n>-1){i=i.substr(0,n)}i+="#view=FitH";if(!e.sap.validateUrl(i)){i=encodeURI(i)}if(e.sap.validateUrl(i)){t.attr("src",i)}else{this._fireErrorEvent()}}.bind(this);try{this.setBusy(true);t()}catch(e){this.setBusy(false)}};a.prototype._fireErrorEvent=function(){this._renderErrorState();this.fireEvent("error",{},true)};a.prototype._renderErrorState=function(){var e=this._objectsRegister.getToolbarDownloadButtonControl();e.setEnabled(false);var e=this._objectsRegister.getPopupDownloadButtonControl();e.setEnabled(false);this.setBusy(false);this._bRenderPdfContent=false;o.prototype.invalidate.call(this)};a.prototype._fireLoadedEvent=function(){this._bRenderPdfContent=true;this.setBusy(false);try{this._getIframeDOMElement().removeClass("sapMPDFViewerLoading")}catch(t){e.log.fatal("Iframe not founded in loaded event");e.log.fatal(t)}this.fireEvent("loaded")};a.prototype._onLoadListener=function(t){try{var o=e(t.target),i=true;var n="application/pdf";try{var a=o[0].contentWindow.document.embeds;i=!!a&&a.length===1;if(i){n=a[0].attributes.getNamedItem("type").value}}catch(e){if(!r.browser.firefox&&this.fireEvent("sourceValidationFailed",{},true)){this._showMessageBox();return}}if(i&&s._isSupportedMimeType(n)){this._fireLoadedEvent()}else{this._fireErrorEvent()}}catch(t){e.sap.log.fatal(false,"Fatal error during the handling of load event happened.");e.sap.log.fatal(false,t.message)}};a.prototype._onErrorListener=function(){this._fireErrorEvent()};a.prototype._onReadyStateChangeListener=function(e){var t="interactive";var o="complete";switch(e.target.readyState){case t:case o:this._fireLoadedEvent();break}};a.prototype._onBeforeUnloadListener=function(){if(this._bOnBeforeUnloadFired){this._fireErrorEvent();return}this._bOnBeforeUnloadFired=true};a.prototype._onLoadIEListener=function(e){try{var t=e.currentTarget.contentWindow.document.mimeType}catch(e){return}if(!s._isSupportedMimeType(t)){this._fireErrorEvent()}};a.prototype.downloadPDF=function(){var e=window.open(this.getSource());e.focus()};a.prototype._onSourceValidationErrorMessageBoxCloseListener=function(e){if(e===n.Action.CANCEL){this._renderErrorState()}else{this._fireLoadedEvent()}};a.prototype._onAfterPopupClose=function(e){var t=this._objectsRegister.getPopup();t.removeAllContent();this._bIsPopupOpen=false};a.prototype._shouldRenderPdfContent=function(){return s._isPdfPluginEnabled()&&this._bRenderPdfContent&&this.getSource()!==null};a.prototype._isSourceValidToDisplay=function(){var e=this.getSource();return e!==null&&e!==""&&typeof e!=="undefined"};a.prototype.invalidate=function(e){this._initControlState();o.prototype.invalidate.call(this,e)};a.prototype.open=function(){if(!this._isSourceValidToDisplay()){e.sap.assert(false,"The PDF file cannot be opened with the given source. Given source: "+this.getSource());return}if(this._isEmbeddedModeAllowed()){this._openOnDesktop()}else{this._openOnMobile()}};a.prototype._openOnDesktop=function(){var e=this._objectsRegister.getPopup();if(this._bIsPopupOpen){return}this._initControlState();this._preparePopup(e);e.addContent(this);this._bIsPopupOpen=true;e.open()};a.prototype._openOnMobile=function(){var e=window.open(this.getSource());e.focus()};a.prototype._getIframeDOMElement=function(){var t=this.$().find("iframe");if(t.length===0){throw Error("Underlying iframe was not found in DOM.")}if(t.length>1){e.sap.log.fatal("Initialization of iframe fails. Reason: the control somehow renders multiple iframes")}return t};a.prototype._isEmbeddedModeAllowed=function(){return r.system.desktop};a.prototype._getLibraryResourceBundle=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.m")};a.prototype._getMessagePageErrorMessage=function(){return this.getErrorPlaceholderMessage()?this.getErrorPlaceholderMessage():this._getLibraryResourceBundle().getText("PDF_VIEWER_PLACEHOLDER_ERROR_TEXT")};a.prototype._getRenderWidth=function(){return this._bIsPopupOpen?"100%":this.getWidth()};a.prototype._getRenderHeight=function(){if(this._bIsPopupOpen){return"100%"}if(!this._isEmbeddedModeAllowed()){return"auto"}return this.getHeight()};a.prototype._showMessageBox=function(){n.show(this._getLibraryResourceBundle().getText("PDF_VIEWER_SOURCE_VALIDATION_MESSAGE_TEXT"),{icon:n.Icon.WARNING,title:this._getLibraryResourceBundle().getText("PDF_VIEWER_SOURCE_VALIDATION_MESSAGE_HEADER"),actions:[n.Action.OK,n.Action.CANCEL],defaultAction:n.Action.CANCEL,id:this.getId()+"-validationErrorSourceMessageBox",styleClass:"sapUiSizeCompact",contentWidth:"100px",onClose:this._onSourceValidationErrorMessageBoxCloseListener.bind(this)})};a.prototype.exit=function(){e.each(this._objectsRegister,function(e,t){var o=t(true);if(o){o.destroy()}})};i.extendPdfViewer(a);return a});