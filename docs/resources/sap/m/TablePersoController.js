/*
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./TablePersoDialog","sap/ui/base/ManagedObject"],function(e,t,i){"use strict";var o=i.extend("sap.m.TablePersoController",{constructor:function(e,t){i.apply(this,arguments)},metadata:{properties:{contentWidth:{type:"sap.ui.core.CSSSize"},contentHeight:{type:"sap.ui.core.CSSSize",defaultValue:"20rem",since:"1.22"},componentName:{type:"string",since:"1.20.2"},hasGrouping:{type:"boolean",defaultValue:false,since:"1.22"},showSelectAll:{type:"boolean",defaultValue:true,since:"1.22"},showResetAll:{type:"boolean",defaultValue:true,since:"1.22"}},aggregations:{_tablePersoDialog:{type:"sap.m.TablePersoDialog",multiple:false,visibility:"hidden"},persoService:{type:"Object",multiple:false}},associations:{table:{type:"sap.m.Table",multiple:false},tables:{type:"sap.m.Table",multiple:true}},events:{personalizationsDone:{}},library:"sap.m"}});o.prototype.init=function(){this._schemaProperty="_persoSchemaVersion";this._schemaVersion="1.0";this._oPersonalizations=null;this._mDelegateMap={};this._mTablePersMap={};this._mInitialTableStateMap={};this._triggersPersDoneEvent=true};o.prototype.exit=function(){this._callFunctionForAllTables(e.proxy(function(e){e.removeDelegate(this._mDelegateMap[e])},this));delete this._mDelegateMap;delete this._mTablePersMap;delete this._mInitialTableStateMap};o.prototype.activate=function(){this._callFunctionForAllTables(this._rememberInitialTableStates);this._callFunctionForAllTables(this._createAndAddDelegateForTable);return this};o.prototype.getTablePersoDialog=function(){return this.getAggregation("_tablePersoDialog")};o.prototype.applyPersonalizations=function(t){var i=this.getPersoService().getPersData();var o=this;i.done(function(e){if(e){o._adjustTable(e,t)}});i.fail(function(){e.sap.log.error("Problem reading persisted personalization data.")})};o.prototype._createAndAddDelegateForTable=function(e){if(!this._mDelegateMap[e]){var t={onBeforeRendering:function(){this.applyPersonalizations(e);if(!this.getAggregation("_tablePersoDialog")){this._createTablePersoDialog(e)}}.bind(this)};e.addDelegate(t);t.onBeforeRendering();this._mDelegateMap[e]=t}};o.prototype._createTablePersoDialog=function(i){var o=new t(i.getId()+"-PersoDialog",{persoDialogFor:i,persoMap:this._getPersoColumnMap(i),columnInfoCallback:this._tableColumnInfo.bind(this),initialColumnState:this._mInitialTableStateMap[i],contentWidth:this.getContentWidth(),contentHeight:this.getContentHeight(),hasGrouping:this.getHasGrouping(),showSelectAll:this.getShowSelectAll(),showResetAll:this.getShowResetAll()});this.setAggregation("_tablePersoDialog",o);o.attachConfirm(e.proxy(function(){this._oPersonalizations=o.retrievePersonalizations();this._callFunctionForAllTables(this._personalizeTable);this.savePersonalizations();this.firePersonalizationsDone()},this))};o.prototype._adjustTable=function(e,t){if(e&&e.hasOwnProperty(this._schemaProperty)&&e[this._schemaProperty]===this._schemaVersion){this._oPersonalizations=e;if(t){this._personalizeTable(t)}else{this._callFunctionForAllTables(this._personalizeTable)}}};o.prototype._personalizeTable=function(t){var i=this._getPersoColumnMap(t);if(!!i&&!!this._oPersonalizations){var o=false;for(var a=0,s=this._oPersonalizations.aColumns.length;a<s;a++){var r=this._oPersonalizations.aColumns[a];var n=i[r.id];if(!n){n=sap.ui.getCore().byId(r.id);if(n){e.sap.log.info("Migrating personalization persistence id of column "+r.id);r.id=i[n];o=true}}if(n){n.setVisible(r.visible);n.setOrder(r.order)}else{e.sap.log.warning("Personalization could not be applied to column "+r.id+" - not found!")}}if(o){this.savePersonalizations()}t.invalidate()}};o.prototype.savePersonalizations=function(){var t=this._oPersonalizations;t[this._schemaProperty]=this._schemaVersion;var i=this.getPersoService().setPersData(t);i.done(function(){});i.fail(function(){e.sap.log.error("Problem persisting personalization data.")})};o.prototype.refresh=function(){var e=function(e){this._mTablePersMap={};e.invalidate()};this._callFunctionForAllTables(e);var t=this.getAggregation("_tablePersoDialog");if(t){t.setPersoMap(this._getPersoColumnMap(sap.ui.getCore().byId(t.getPersoDialogFor())))}};o.prototype.openDialog=function(){var t=this.getAggregation("_tablePersoDialog");if(t){e.sap.syncStyleClass("sapUiSizeCompact",t.getPersoDialogFor(),t._oDialog);t.open()}else{e.sap.log.warning("sap.m.TablePersoController: trying to open TablePersoDialog before TablePersoService has been activated.")}};o.prototype.setContentWidth=function(e){this.setProperty("contentWidth",e,true);var t=this.getAggregation("_tablePersoDialog");if(t){t.setContentWidth(e)}return this};o.prototype.setContentHeight=function(e){this.setProperty("contentHeight",e,true);var t=this.getAggregation("_tablePersoDialog");if(t){t.setContentHeight(e)}return this};o.prototype.setHasGrouping=function(e){this.setProperty("hasGrouping",e,true);var t=this.getAggregation("_tablePersoDialog");if(t){t.setHasGrouping(e)}return this};o.prototype.setShowSelectAll=function(e){this.setProperty("showSelectAll",e,true);var t=this.getAggregation("_tablePersoDialog");if(t){t.setShowSelectAll(e)}return this};o.prototype.setShowResetAll=function(e){this.setProperty("showResetAll",e,true);var t=this.getAggregation("_tablePersoDialog");if(t){t.setShowResetAll(e)}return this};o.prototype.setComponentName=function(e){this.setProperty("componentName",e,true);return this};o.prototype._getMyComponentName=function(e){if(this.getComponentName()){return this.getComponentName()}if(e===null){return"empty_component"}var t=e.getMetadata();if(e.getMetadata().getStereotype()==="component"){return t._sComponentName}return this._getMyComponentName(e.getParent())};o.prototype._callFunctionForAllTables=function(e){var t=sap.ui.getCore().byId(this.getAssociation("table"));if(t){e.call(this,t)}var i=this.getAssociation("tables");if(i){for(var o=0,a=this.getAssociation("tables").length;o<a;o++){t=sap.ui.getCore().byId(this.getAssociation("tables")[o]);e.call(this,t)}}};o.prototype._isStatic=function(e){var t=sap.ui.getCore().getConfiguration().getUIDPrefix();var i=new RegExp("^"+t);return!i.test(e)};o.prototype._getPersoColumnMap=function(t){var i=this._mTablePersMap[t];if(!i){i={};var o=function(e){var t=e.lastIndexOf("-");return e.substring(t+1)};var a=o.call(this,t.getId());if(!this._isStatic(a)){e.sap.log.error("Table "+t.getId()+" must have a static id suffix. Otherwise personalization can not be persisted.");i=null;return null}var s;var r=this._getMyComponentName(t);var n=this;t.getColumns().forEach(function(t){if(i){var l=t.getId();var p=o.call(n,l);if(!n._isStatic(p)){e.sap.log.error("Suffix "+p+" of table column "+l+" must be static. Otherwise personalization can not be persisted for its table.");i=null;return null}s=r+"-"+a+"-"+p;i[t]=s;i[s]=t}});this._mTablePersMap[t]=i}return i};o.prototype._rememberInitialTableStates=function(e){this._mInitialTableStateMap[e]=this._tableColumnInfo(e,this._getPersoColumnMap(e))};o.prototype._tableColumnInfo=function(t,i){if(i){var o=t.getColumns(),a=[],s=this.getPersoService();o.forEach(function(t){var o=null;if(s.getCaption){o=s.getCaption(t)}var r=null;if(s.getGroup){r=s.getGroup(t)}if(!o){var n=t.getHeader();if(n.getText&&n.getText()){o=n.getText()}else if(n.getTitle&&n.getTitle()){o=n.getTitle()}if(!o){o=t.getId();e.sap.log.warning("Please 'getCaption' callback implentation in your TablePersoProvider for column "+t+". Table personalization uses column id as fallback value.")}}a.push({text:o,order:t.getOrder(),visible:t.getVisible(),id:i[t],group:r})});a.sort(function(e,t){return e.order-t.order});return a}return null};return o});