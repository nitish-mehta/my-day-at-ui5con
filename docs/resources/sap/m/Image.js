/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","./ImageRenderer","jquery.sap.keycodes"],function(t,e,i,r){"use strict";var s=e.ImageMode;var o=i.extend("sap.m.Image",{metadata:{interfaces:["sap.ui.core.IFormContent"],library:"sap.m",designtime:"sap/m/designtime/Image.designtime",properties:{src:{type:"sap.ui.core.URI",group:"Data",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:null},height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:null},decorative:{type:"boolean",group:"Accessibility",defaultValue:true},alt:{type:"string",group:"Accessibility",defaultValue:null},useMap:{type:"string",group:"Misc",defaultValue:null},densityAware:{type:"boolean",group:"Misc",defaultValue:true},activeSrc:{type:"sap.ui.core.URI",group:"Data",defaultValue:""},mode:{type:"sap.m.ImageMode",group:"Misc",defaultValue:"Image"},backgroundSize:{type:"string",group:"Appearance",defaultValue:"cover"},backgroundPosition:{type:"string",group:"Appearance",defaultValue:"initial"},backgroundRepeat:{type:"string",group:"Appearance",defaultValue:"no-repeat"}},aggregations:{detailBox:{type:"sap.m.LightBox",multiple:false,bindable:"bindable"}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{tap:{},press:{},load:{},error:{}}}});o._currentDevicePixelRatio=function(){var t=window.devicePixelRatio===undefined?1:window.devicePixelRatio;if(t<=1){t=1}else{t*=2;t=Math.round(t);t/=2}if(t>2){t=2}return t}();o.prototype.onload=function(t){var e,i;if(!this._defaultEventTriggered){this._defaultEventTriggered=true}this._bVersion2Tried=false;var r=this.$(),o=r[0];if(this.getMode()===s.Background){r.css("background-image",'url("'+this._oImage.src+'")')}if(!this._isWidthOrHeightSet()){if(this._iLoadImageDensity>1){e=Math.round(o.getBoundingClientRect().width);i=Math.round(o.getBoundingClientRect().height);if(e===o.naturalWidth&&i===o.naturalHeight){r.width(e/this._iLoadImageDensity)}}}r.removeClass("sapMNoImg");this.fireLoad()};o.prototype.onerror=function(e){if(!this._defaultEventTriggered){this._defaultEventTriggered=true}var i=this.$(),r=this.getMode(),a=r===s.Image?this._getDomImg().attr("src"):this._oImage.src,n=o._currentDevicePixelRatio,h=this._isActiveState?this.getActiveSrc():this.getSrc();i.addClass("sapMNoImg");if(!a||this._iLoadImageDensity===1){i.removeClass("sapMNoImg");this.fireError();return}if(n===2||n<1){this._iLoadImageDensity=1;this._updateDomSrc(this._generateSrcByDensity(h,1))}else if(n===1.5){if(this._bVersion2Tried){setTimeout(t.proxy(function(){this._iLoadImageDensity=1;this._updateDomSrc(this._generateSrcByDensity(h,1))},this),0)}else{setTimeout(t.proxy(function(){this._iLoadImageDensity=2;this._updateDomSrc(this._generateSrcByDensity(h,2));this._bVersion2Tried=true},this),0)}}};o.prototype.setDetailBox=function(t){var e=this.getDetailBox();if(t){if(t===e){return this}if(e){this.detachPress(this._fnLightBoxOpen,e)}this._fnLightBoxOpen=t.open;this.attachPress(this._fnLightBoxOpen,t)}else if(this._fnLightBoxOpen){this.detachPress(this._fnLightBoxOpen,e);this._fnLightBoxOpen=null}return this.setAggregation("detailBox",t)};o.prototype.clone=function(){var t=i.prototype.clone.apply(this,arguments),e=t.getDetailBox();if(e){t.detachPress(this._fnLightBoxOpen,this.getDetailBox());t._fnLightBoxOpen=e.open;t.attachPress(t._fnLightBoxOpen,e)}return t};o.prototype.onBeforeRendering=function(){this._defaultEventTriggered=false};o.prototype.onAfterRendering=function(){var e=this.$(),i=this.getMode(),r;if(i===s.Image){e.on("load",t.proxy(this.onload,this));e.on("error",t.proxy(this.onerror,this));r=e[0]}if(i===s.Background){r=this._oImage}if(r&&r.complete&&!this._defaultEventTriggered){if(r.naturalWidth>0){this.onload({})}else{this.onerror({})}}};o.prototype.exit=function(){if(this._oImage){t(this._oImage).off("load",this.onload).off("error",this.onerror);this._oImage=null}else{this.$().off("load",this.onload).off("error",this.onerror)}if(this._fnLightBoxOpen){this._fnLightBoxOpen=null}};o.prototype.ontouchstart=function(t){if(t.srcControl.mEventRegistry["press"]||t.srcControl.mEventRegistry["tap"]){t.setMarked()}if(t.targetTouches.length===1&&this.getActiveSrc()){this._updateDomSrc(this._getDensityAwareActiveSrc());this._isActiveState=true}};o.prototype.ontouchend=function(t){if(t.targetTouches.length===0&&this.getActiveSrc()){this._isActiveState=false;this._updateDomSrc(this._getDensityAwareSrc());this.$().removeClass("sapMNoImg")}};o.prototype.setSrc=function(t){if(t===this.getSrc()){return this}this.setProperty("src",t,true);var e=this.getDomRef();if(e){this._updateDomSrc(this._getDensityAwareSrc())}return this};o.prototype.setActiveSrc=function(t){if(!t){t=""}return this.setProperty("activeSrc",t,true)};o.prototype.attachPress=function(){Array.prototype.unshift.apply(arguments,["press"]);i.prototype.attachEvent.apply(this,arguments);if(this.hasListeners("press")){this.$().attr("tabindex","0");this.$().attr("role","button")}return this};o.prototype.detachPress=function(){Array.prototype.unshift.apply(arguments,["press"]);i.prototype.detachEvent.apply(this,arguments);if(!this.hasListeners("press")){this.$().removeAttr("tabindex");if(this.getDecorative()){this.$().attr("role","presentation")}else{this.$().removeAttr("role")}}return this};o.prototype.ontap=function(t){this.fireTap({});this.firePress({})};o.prototype.onkeyup=function(e){if(e.which===t.sap.KeyCodes.SPACE||e.which===t.sap.KeyCodes.ENTER){this.firePress({});e.stopPropagation()}};o.prototype._updateDomSrc=function(e){var i=this.$(),r=this.getMode();if(i.length){if(r===s.Image){this._getDomImg().attr("src",e)}else{i.addClass("sapMNoImg");t(this._oImage).attr("src",e)}}};o.prototype._getDomImg=function(){var t=this.$();return this.getDetailBox()?t.children("img"):t};o.prototype._preLoadImage=function(e){if(this.getMode()!==s.Background){return}var i=t(this._oImage);if(!this._oImage){this._oImage=new window.Image;i=t(this._oImage);i.on("load",t.proxy(this.onload,this)).on("error",t.proxy(this.onerror,this))}this._oImage.src=e};o.prototype._isWidthOrHeightSet=function(){return this.getWidth()&&this.getWidth()!==""||this.getHeight()&&this.getHeight()!==""};o.prototype._getDensityAwareSrc=function(){var t=this.getSrc(),e=this.getDensityAware(),i=e?o._currentDevicePixelRatio:1;this._iLoadImageDensity=i;if(i===1){return t}return this._generateSrcByDensity(t,i)};o.prototype._getDensityAwareActiveSrc=function(){var t=this.getActiveSrc(),e=this.getDensityAware(),i=e?o._currentDevicePixelRatio:1;this._iLoadImageDensity=i;if(i===1){return t}return this._generateSrcByDensity(t,i)};o.prototype._generateSrcByDensity=function(t,e){if(!t){return""}if(this._isDataUri(t)){this._iLoadImageDensity=1;return t}if(e===1){return t}var i=t.lastIndexOf("."),r=t.lastIndexOf("/"),s=t.substring(0,i),o=t.substring(i);if(i===-1||r>i){return t+"@"+e}s=s+"@"+e;return s+o};o.prototype._isDataUri=function(t){return t?t.indexOf("data:")===0:false};o.prototype.getAccessibilityInfo=function(){var t=this.hasListeners("press");if(this.getDecorative()&&!this.getUseMap()&&!t){return null}return{role:t?"button":"img",type:sap.ui.getCore().getLibraryResourceBundle("sap.m").getText(t?"ACC_CTR_TYPE_BUTTON":"ACC_CTR_TYPE_IMAGE"),description:this.getAlt()||this.getTooltip_AsString()||"",focusable:t}};o.prototype.getFormDoNotAdjustWidth=function(){return true};return o});