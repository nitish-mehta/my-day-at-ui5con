/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/Device","sap/ui/core/ResizeHandler","sap/ui/core/library","./CarouselRenderer","sap/ui/thirdparty/mobify-carousel","sap/ui/core/IconPool","jquery.sap.keycodes"],function(e,t,i,o,s,a,r){"use strict";var n=a.BusyIndicatorSize;var p=t.ImageHelper;var u=t.CarouselArrowsPlacement;var l=t.PlacementType;var h=i.extend("sap.m.Carousel",{metadata:{library:"sap.m",designtime:"sap/m/designtime/Carousel.designtime",properties:{height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},loop:{type:"boolean",group:"Misc",defaultValue:false},showPageIndicator:{type:"boolean",group:"Appearance",defaultValue:true},pageIndicatorPlacement:{type:"sap.m.PlacementType",group:"Appearance",defaultValue:l.Bottom},showBusyIndicator:{type:"boolean",group:"Appearance",defaultValue:true,deprecated:true},arrowsPlacement:{type:"sap.m.CarouselArrowsPlacement",group:"Appearance",defaultValue:u.Content}},defaultAggregation:"pages",aggregations:{pages:{type:"sap.ui.core.Control",multiple:true,singularName:"page"}},associations:{activePage:{type:"sap.ui.core.Control",multiple:false}},events:{loadPage:{deprecated:true,parameters:{pageId:{type:"string"}}},unloadPage:{deprecated:true,parameters:{pageId:{type:"string"}}},pageChanged:{parameters:{oldActivePageId:{type:"string"},newActivePageId:{type:"string"}}}}}});h._INNER_SELECTOR=".sapMCrslInner";h._PAGE_INDICATOR_SELECTOR=".sapMCrslBulleted";h._PAGE_INDICATOR_ARROWS_SELECTOR=".sapMCrslIndicatorArrow";h._CONTROLS=".sapMCrslControls";h._ITEM_SELECTOR=".sapMCrslItem";h._LEFTMOST_CLASS="sapMCrslLeftmost";h._RIGHTMOST_CLASS="sapMCrslRightmost";h._LATERAL_CLASSES="sapMCrslLeftmost sapMCrslRightmost";h._MODIFIERNUMBERFORKEYBOARDHANDLING=10;h._BULLETS_TO_NUMBERS_THRESHOLD=9;h._PREVIOUS_CLASS_ARROW="sapMCrslPrev";h._NEXT_CLASS_ARROW="sapMCrslNext";h.prototype.init=function(){this._aScrollContainers=[];this._fnAdjustAfterResize=e.proxy(function(){var e=this.$().find(h._INNER_SELECTOR);this._oMobifyCarousel.resize(e)},this);this.data("sap-ui-fastnavgroup","true",true)};h.prototype.exit=function(){if(this._oMobifyCarousel){this._oMobifyCarousel.destroy();delete this._oMobifyCarousel}if(this._oArrowLeft){this._oArrowLeft.destroy();delete this._oArrowLeft}if(this._oArrowRight){this._oArrowRight.destroy();delete this._oArrowRight}if(this._sResizeListenerId){s.deregister(this._sResizeListenerId);this._sResizeListenerId=null}this.$().off("afterSlide");this._cleanUpScrollContainer();this._fnAdjustAfterResize=null;this._aScrollContainers=null;this._$InnerDiv=null};h.prototype._cleanUpScrollContainer=function(){var e;while(this._aScrollContainers&&this._aScrollContainers.length>0){e=this._aScrollContainers.pop();e.removeAllContent();if(e&&typeof e.destroy==="function"){e.destroy()}}};h.prototype.ontouchstart=function(e){if(this._oMobifyCarousel){this._oMobifyCarousel.touchstart(e)}};h.prototype.ontouchmove=function(e){if(this._oMobifyCarousel){this._oMobifyCarousel.touchmove(e)}};h.prototype.ontouchend=function(e){if(this._oMobifyCarousel){this._oMobifyCarousel.touchend(e)}};h.prototype.onBeforeRendering=function(){var e=this.getActivePage();if(!e&&this.getPages().length>0){this.setAssociation("activePage",this.getPages()[0].getId(),true)}if(this._sResizeListenerId){s.deregister(this._sResizeListenerId);this._sResizeListenerId=null}return this};h.prototype.onAfterRendering=function(){if(this._oMobifyCarousel){this._oMobifyCarousel.unbind()}this.$().carousel();this._oMobifyCarousel=this.getDomRef()._carousel;this._oMobifyCarousel.setLoop(this.getLoop());this._oMobifyCarousel.setRTL(sap.ui.getCore().getConfiguration().getRTL());var t=this.getActivePage();if(t){var i=this._getPageNumber(t);if(isNaN(i)||i==0){if(this.getPages().length>0){this.setAssociation("activePage",this.getPages()[0].getId(),true);this._adjustHUDVisibility(1)}}else{var o=sap.ui.getCore();if(o.isThemeApplied()){this._moveToPage(i+1)}else{o.attachThemeChanged(this._handleThemeLoad,this)}if(sap.zen&&sap.zen.commons&&this.getParent()instanceof sap.zen.commons.layout.PositionContainer){if(this._isCarouselUsedWithCommonsLayout===undefined){e.sap.delayedCall(0,this,"invalidate");this._isCarouselUsedWithCommonsLayout=true}}}}this.$().on("afterSlide",e.proxy(function(e,t,i){if(e.target!==this.getDomRef()){return}if(i>0){this._changePage(i)}},this));this._$InnerDiv=this.$().find(h._INNER_SELECTOR)[0];this._sResizeListenerId=s.register(this._$InnerDiv,this._fnAdjustAfterResize);this.$().find(".sapMCrslItemTableCell").focus(function(t){t.preventDefault();e(t.target).parents(".sapMCrsl").focus();return false});var a="sap.m.IconTabBar";var r=this.getParent();while(r){if(r.getMetadata().getName()==a){var n=this;r.attachExpand(function(e){var t=e.getParameter("expand");if(t&&i>0){n._moveToPage(i+1)}});break}r=r.getParent()}};h.prototype._handleThemeLoad=function(){var e,t=this.getActivePage();if(t){var i=this._getPageNumber(t);if(i>0){this._moveToPage(i+1)}}e=sap.ui.getCore();e.detachThemeChanged(this._handleThemeLoad,this)};h.prototype._moveToPage=function(e){this._oMobifyCarousel.changeAnimation("sapMCrslNoTransition");this._oMobifyCarousel.move(e);this._changePage(e)};h.prototype._changePage=function(t){this._adjustHUDVisibility(t);var i=this.getActivePage();var s=this.getPages()[t-1].getId();this.setAssociation("activePage",s,true);var a=sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("CAROUSEL_PAGE_INDICATOR_TEXT",[t,this.getPages().length]);e.sap.log.debug("sap.m.Carousel: firing pageChanged event: old page: "+i+", new page: "+s);if(!o.system.desktop){e(document.activeElement).blur()}this.firePageChanged({oldActivePageId:i,newActivePageId:s});this.$("slide-number").text(a)};h.prototype._adjustHUDVisibility=function(e){if(o.system.desktop&&!this.getLoop()&&this.getPages().length>1){var t=this.$("hud");t.removeClass(h._LATERAL_CLASSES);if(e===1){t.addClass(h._LEFTMOST_CLASS);this._focusCarouselContainer(t,h._PREVIOUS_CLASS_ARROW)}else if(e===this.getPages().length){t.addClass(h._RIGHTMOST_CLASS);this._focusCarouselContainer(t,h._NEXT_CLASS_ARROW)}}};h.prototype._focusCarouselContainer=function(e,t){if(e.find("."+t)[0]===document.activeElement){this.focus()}};h.prototype.setActivePage=function(e){var t=null;if(typeof e=="string"){t=e}else if(e instanceof i){t=e.getId()}if(t){if(t===this.getActivePage()){return this}var o=this._getPageNumber(t);if(!isNaN(o)){if(this._oMobifyCarousel){this._oMobifyCarousel.move(o+1)}}}this.setAssociation("activePage",t,true);return this};h.prototype.setHeight=function(e){this.setProperty("height",e,true);this.$().css("height",e);return this};h.prototype.setWidth=function(e){this.setProperty("width",e,true);this.$().css("width",e);return this};h.prototype.setLoop=function(e){this.setProperty("loop",e,true);if(this._oMobifyCarousel){this._oMobifyCarousel.setLoop(e)}return this};h.prototype._getNavigationArrow=function(e){var t={src:"sap-icon://slim-arrow-"+e,useIconTooltip:false};if(e==="left"){if(!this._oArrowLeft){this._oArrowLeft=p.getImageControl(this.getId()+"-arrowScrollLeft",this._oArrowLeft,this,t)}return this._oArrowLeft}else if(e==="right"){if(!this._oArrowRight){this._oArrowRight=p.getImageControl(this.getId()+"-arrowScrollRight",this._oArrowRight,this,t)}return this._oArrowRight}};h.prototype._createScrollContainer=function(e){var t;var i=o.system.desktop&&this.getArrowsPlacement()===u.PageIndicator;if(i){t="sapMCrslImg"}else{t="sapMCrslImgNoArrows"}var s=e instanceof sap.m.Image?"sapMCrslItemTableCell "+t:"sapMCrslItemTableCell",a=new sap.ui.core.HTML({content:"<div class='sapMCrslItemTable'>"+"<div class='"+s+"'></div>"+"</div>",afterRendering:function(t){var i=sap.ui.getCore().createRenderManager();i.render(e,this.getDomRef().firstChild);i.destroy();e=null}});var r=new sap.m.ScrollContainer({horizontal:false,vertical:false,content:[a],width:"100%",height:"100%"});r.setParent(this,null,true);this._aScrollContainers.push(r);return r};h.prototype.previous=function(){if(this._oMobifyCarousel){this._oMobifyCarousel.prev()}else{e.sap.log.warning("Unable to execute sap.m.Carousel.previous: carousel must be rendered first.")}return this};h.prototype.next=function(){if(this._oMobifyCarousel){this._oMobifyCarousel.next()}else{e.sap.log.warning("Unable to execute sap.m.Carousel.next: carousel must be rendered first.")}return this};h.prototype._getPageNumber=function(e){var t,i;for(t=0;t<this.getPages().length;t++){if(this.getPages()[t].getId()==e){i=t;break}}return i};h.prototype.onsaptabprevious=function(e){this._bDirection=false;this._fnOnTabPress(e)};h.prototype.onsaptabnext=function(e){this._bDirection=true;this._fnOnTabPress(e)};h.prototype.onfocusin=function(e){this.saveLastFocusReference(e);this._bDirection=undefined};h.prototype.onsapskipforward=function(e){e.preventDefault();this._handleGroupNavigation(e,false)};h.prototype.onsapskipback=function(e){e.preventDefault();this._handleGroupNavigation(e,true)};h.prototype.onkeydown=function(t){if(t.keyCode==e.sap.KeyCodes.F7){this._handleF7Key(t);return}if(t.target!=this.getDomRef()){return}switch(t.keyCode){case 189:case e.sap.KeyCodes.NUMPAD_MINUS:this._fnSkipToIndex(t,-1);break;case e.sap.KeyCodes.PLUS:case e.sap.KeyCodes.NUMPAD_PLUS:this._fnSkipToIndex(t,1);break}};h.prototype.onsapescape=function(e){var t;if(e.target===this.$()[0]&&this._lastActivePageNumber){t=this._lastActivePageNumber+1;this._oMobifyCarousel.move(t);this._changePage(t)}};h.prototype.onsapright=function(e){this._fnSkipToIndex(e,1)};h.prototype.onsapup=function(e){this._fnSkipToIndex(e,-1)};h.prototype.onsapleft=function(e){this._fnSkipToIndex(e,-1)};h.prototype.onsapdown=function(e){this._fnSkipToIndex(e,1)};h.prototype.onsaphome=function(e){this._fnSkipToIndex(e,0)};h.prototype.onsapend=function(e){this._fnSkipToIndex(e,this.getPages().length)};h.prototype.onsaprightmodifiers=function(e){if(e.ctrlKey){this._fnSkipToIndex(e,h._MODIFIERNUMBERFORKEYBOARDHANDLING)}};h.prototype.onsapupmodifiers=function(e){if(e.ctrlKey){this._fnSkipToIndex(e,h._MODIFIERNUMBERFORKEYBOARDHANDLING)}};h.prototype.onsappageup=function(e){this._fnSkipToIndex(e,h._MODIFIERNUMBERFORKEYBOARDHANDLING)};h.prototype.onsapleftmodifiers=function(e){if(e.ctrlKey){this._fnSkipToIndex(e,-h._MODIFIERNUMBERFORKEYBOARDHANDLING)}};h.prototype.onsapdownmodifiers=function(e){if(e.ctrlKey){this._fnSkipToIndex(e,-h._MODIFIERNUMBERFORKEYBOARDHANDLING)}};h.prototype.onsappagedown=function(e){this._fnSkipToIndex(e,-h._MODIFIERNUMBERFORKEYBOARDHANDLING)};h.prototype._fnOnTabPress=function(e){if(e.target===this.$()[0]){this._lastActivePageNumber=this._getPageNumber(this.getActivePage())}};h.prototype._handleGroupNavigation=function(t,i){var o=e.Event("keydown");t.preventDefault();this.$().focus();o.target=t.target;o.keyCode=e.sap.KeyCodes.F6;o.shiftKey=i;e.sap.handleF6GroupNavigation(o)};h.prototype.saveLastFocusReference=function(e){if(this._bDirection===undefined){return}if(this._lastFocusablePageElement===undefined){this._lastFocusablePageElement={}}this._lastFocusablePageElement[this.getActivePage()]=e.target};h.prototype._getActivePageLastFocusedElement=function(){if(this._lastFocusablePageElement){return this._lastFocusablePageElement[this.getActivePage()]}};h.prototype._fnSkipToIndex=function(e,t){var i=t;if(e.target!==this.getDomRef()){return}e.preventDefault();if(t!==0){i=this._getPageNumber(this.getActivePage())+1+t}this._oMobifyCarousel.move(i)};h.prototype._handleF7Key=function(e){var t;e.preventDefault();t=this._getActivePageLastFocusedElement();if(e.target===this.$()[0]&&t){t.focus()}else{this.$().focus()}};h.prototype.setShowBusyIndicator=function(){e.sap.log.warning("sap.m.Carousel: Deprecated function 'setShowBusyIndicator' called. Does nothing.");return this};h.prototype.getShowBusyIndicator=function(){e.sap.log.warning("sap.m.Carousel: Deprecated function 'getShowBusyIndicator' called. Does nothing.");return false};h.prototype.setBusyIndicatorSize=function(e){if(!(e in n)){e=n.Medium}return i.prototype.setBusyIndicatorSize.call(this,e)};return h});